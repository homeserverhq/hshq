#!/bin/bash
HSHQ_LIB_SCRIPT_VERSION=176
LOG_LEVEL=info

# Copyright (C) 2023 HomeServerHQ <drdoug@homeserverhq.com>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.

set -e

function init()
{
  # Version 74 Update
  # Changing to the home directory fixes issues with docker compose (v2)
  # since the command 'stat .' (inside of docker compose) results in a
  # permission denied error when running script from root as another user,
  # i.e. 'sudo -u <USER> bash hshq.sh'
  # Basically, docker compose is dependent on which directory it is
  # executed from, regardless if a specified file is in a readable directory.
  cd ~
  IS_STACK_DEBUG=false
  USERNAME=$(id -u -n)
  PRIOR_HSHQ_VERSION=0
  LAST_RELAYSERVER_VERSION_UPDATE=171
  IS_DESKTOP_ENV=false
  if [ -d $HOME/Desktop ]; then
    IS_DESKTOP_ENV=true
  fi
  IS_CONSOLE_ENV=false
  # Leave this set to true for a bit, to allow for users to update.
  # Eventually, we'll turn it back off and only restart as needed.
  IS_RESTART_SCRIPTSERVER=true
  LOCK_UTILS_FILENAME=lockUtils.sh
  LOCKHOLDER_FILENAME=lastCaller
  ALL_LOCKS="hshqopen networkchecks"
  CONFIG_FILE_DEFAULT_FILENAME=config.cnf
  ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME=config.enc
  ENCRYPTED_CONFIG_FILE_BACKUP_FILENAME=config-enc.bak
  ENC_PW_FILE=/tmp/encpw.enc
  TMP_PW_CHECKDIR=/tmp/pwcheckdir
  IS_CONFIG_FILE_UNENCRYPTED=false
  RS_INSTALL_SETUP_SCRIPT_NAME=setupRS.sh
  RS_INSTALL_FRESH_SCRIPT_NAME=installRS.sh
  RS_INSTALL_TRANSFER_SCRIPT_NAME=transferRS.sh
  RS_INSTALL_VALIDATION_SCRIPT_NAME=validateRS.sh
  RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME=validateLib.sh
  NUKE_SCRIPT_NAME=nuke.sh
  RELAYSERVER_HSHQ_FULL_LOG_NAME=hshqRSInstall.log
  RELAYSERVER_HSHQ_TIMESTAMP_LOG_NAME=hshqRSInstallTS.log
  RELAYSERVER_NOT_READY_FILE=notready
  RELAYSERVER_INSTALL_COMPLETE_FILE=installed
  RELAYSERVER_INSTALL_FAILED_FILE=failed
  RELAYSERVER_SWAP_SIZE=2G
  HSHQ_LOG_FILE=/var/log/hshq.log
  HSHQ_INSTALL_NOTES_FILENAME='HomeServer_Install_Notes.txt'
  SCRIPTSERVER_FULL_STACKLIST_FILENAME=fullStackList.txt
  SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME=optionalStackList.txt
  SCRIPTSERVER_UPDATE_STACKLIST_FILENAME=updateStackList.txt
  SCRIPTSERVER_REDIS_STACKLIST_FILENAME=redisStackList.txt
  MINDSDB_IMPORT_FILENAME=DBCImport.txt
  DNS_ZONE_FILENAME_BASE=DNSZoneInfo
  DOCKER_VERSION_UBUNTU_2204=5:25.0.5-1~ubuntu.22.04~jammy
  DOCKER_VERSION_UBUNTU_2404=5:27.4.0-1~ubuntu.24.04~noble
  DOCKER_VERSION_DEBIAN_12=5:27.4.0-1~debian.12~bookworm
  NET_EXTERNAL_BRIDGE_NAME=brdockext
  NET_EXTERNAL_SUBNET=172.16.1.0/24
  NET_EXTERNAL_SUBNET_PREFIX=172.16.1
  NET_WEBPROXY_BRIDGE_NAME=brdockproxy
  NET_WEBPROXY_SUBNET=172.16.2.0/24
  NET_WEBPROXY_SUBNET_PREFIX=172.16.2
  NET_PRIVATEIP_BRIDGE_NAME=brdockpriv
  NET_PRIVATEIP_SUBNET=172.16.3.0/24
  NET_PRIVATEIP_SUBNET_PREFIX=172.16.3
  NET_INTERNALMAIL_BRIDGE_NAME=brdockmail
  NET_INTERNALMAIL_SUBNET=172.16.4.0/24
  NET_INTERNALMAIL_SUBNET_PREFIX=172.16.4
  NET_DBS_BRIDGE_NAME=brdockdbs
  NET_DBS_SUBNET=172.16.5.0/24
  NET_DBS_SUBNET_PREFIX=172.16.5
  NET_LDAP_BRIDGE_NAME=brdockldap
  NET_LDAP_SUBNET=172.16.6.0/24
  NET_LDAP_SUBNET_PREFIX=172.16.6
  NET_MAILU_EXT_BRIDGE_NAME=brmailuext
  NET_MAILU_EXT_SUBNET=172.16.7.0/24
  NET_MAILU_EXT_SUBNET_PREFIX=172.16.7
  NET_MAILU_INT_BRIDGE_NAME=brmailuint
  NET_MAILU_INT_SUBNET=172.16.8.0/24
  NET_MAILU_INT_SUBNET_PREFIX=172.16.8
  ADGUARD_DNS_PORT=53
  CADDY_HTTP_PORT=80
  CADDY_HTTPS_PORT=443
  COTURN_PRIMARY_PORT=3478
  COTURN_SECONDARY_PORT=5349
  COTURN_COMMS_MIN_PORT=14100
  COTURN_COMMS_MAX_PORT=14200
  JELLYFIN_PORT=7359
  JITSI_COLIBRI_PORT=8020
  JITSI_JVB_PORT=4443
  JITSI_MEET_PORT=10000
  MAILU_PORT_1=25
  MAILU_PORT_2=110
  MAILU_PORT_3=143
  MAILU_PORT_4=465
  MAILU_PORT_5=587
  MAILU_PORT_6=993
  MAILU_PORT_7=995
  PEERTUBE_RDP_PORT=1935
  QBITTORRENT_PORT=6881
  SYNCTHING_DISC_PORT=21027
  SYNCTHING_SYNC_PORT=22000
  SYNCTHING_LOCAL_WEB_PORT=8384
  UPNP_PORT=1900
  VNC_SERVER_PORT=5901
  WAZUH_PORT_1=1514
  WAZUH_PORT_2=1515
  WAZUH_PORT_3=514
  WAZUH_PORT_4=55000
  WAZUH_PORT_5=9200
  WAZUH_AGENT_VERSION=4.11.2-1
  DEFAULT_UNFOUND_IP_ADDRESS=169.254.84.48
  DEFAULT_UNFOUND_IP_SUBNET=169.254.0.0/16
  MAX_DOCKER_PULL_TRIES=10
  MENU_WIDTH=69
  MENU_HEIGHT=24
  MENU_INT_HEIGHT=10
  ENABLE_STACK_DELETE=false
  SUDO_NORMAL_TIMEOUT=15
  SUDO_LONG_TIMEOUT=1440
  SUDO_LONG_TIMEOUT_FILENAME=sudohshqinstall
  SUDO_MAX_RETRIES=20
  MAILX_TIMEOUT=15
  NETPLAN_ORIGIN_HINT=88-hshq
  NETPLAN_APPLY_WAIT=5
  MIN_NETWORKCHECK_INTERVAL=5
  STACK_VERSION_PREFIX=#HSHQManaged
  HSHQ_ADMIN_NAME="HSHQ Admin"
  IS_HSHQ_DEV_FILENAME=hshq.dev
  IS_HSHQ_TEST_FILENAME=hshq.test
  IS_HSHQ_DEV_TEST=false
  if [ -f $HOME/hshq/$IS_HSHQ_DEV_FILENAME ] || [ -f $HOME/hshq/$IS_HSHQ_TEST_FILENAME ]; then
    IS_HSHQ_DEV_TEST=true
  fi
  HSHQ_WRAP_URL=https://homeserverhq.com/hshq.sh
  HSHQ_WRAP_VER_URL=https://homeserverhq.com/ver/getwrapversion
  HSHQ_WRAP_DEV_URL=https://homeserverhq.com/hshq-dev.sh
  HSHQ_WRAP_DEV_VER_URL=https://homeserverhq.com/ver/getwrapversion-dev
  HSHQ_WRAP_TEST_URL=https://homeserverhq.com/hshq-test.sh
  HSHQ_WRAP_TEST_VER_URL=https://homeserverhq.com/ver/getwrapversion-test
  HSHQ_LIB_URL=https://homeserverhq.com/hshqlib.sh
  HSHQ_LIB_VER_URL=https://homeserverhq.com/ver/getversion
  HSHQ_LIB_DEV_URL=https://homeserverhq.com/hshqlib-dev.sh
  HSHQ_LIB_DEV_VER_URL=https://homeserverhq.com/ver/getversion-dev
  HSHQ_LIB_TEST_URL=https://homeserverhq.com/hshqlib-test.sh
  HSHQ_LIB_TEST_VER_URL=https://homeserverhq.com/ver/getversion-test
  HSHQ_RELEASES_URL=https://homeserverhq.com/releases
  HSHQ_SIG_BASE_URL=https://homeserverhq.com/signatures/
  HSHQ_GPG_FINGERPRINT=5B9C33067C71ABCFCE1ACF8A7F46128ABB7C1E42
  HSHQ_GPG_FINGERPRINT_SHORT=7F46128ABB7C1E42
  HSHQ_LIB_TMP=$HOME/hshqlib.tmp
  HSHQ_WRAP_TMP=$HOME/hshqwrap.tmp
  HSHQ_LIB_FILENAME=hshqlib.sh
  HSHQ_NEW_LIB_FILENAME=hshqlib.new
  HSHQ_WRAP_FILENAME=hshq.sh
  APPLICATION_FIRST_LINE="###################### Application Begin #######################"
  APPLICATION_LAST_LINE="####################### Application End ########################"
  INVITATION_FIRST_LINE="####################### Invitation Begin #######################"
  INVITATION_LAST_LINE="######################## Invitation End ########################"
  initServiceDefaults
  loadPinnedDockerImages
  loadDirectoryStructure
  loadVersionVars
  CONFIG_FILE_DEFAULT_LOCATION=$HSHQ_CONFIG_DIR
  HSHQ_DB=$HSHQ_CONFIG_DIR/hshq.db
  HSHQ_INSTALL_CFG=$HSHQ_BASE_DIR/installConfig.txt
  HSHQ_CUSTOM_PRE_IPTABLES_SCRIPT=$HSHQ_SCRIPTS_DIR/root/userCustomPreIPTables.sh
  HSHQ_CUSTOM_POST_IPTABLES_SCRIPT=$HSHQ_SCRIPTS_DIR/root/userCustomPostIPTables.sh
  HSHQ_PLAINTEXT_ROOT_CONFIG=$HSHQ_CONFIG_DIR/ptRootConfig.conf
  HSHQ_PLAINTEXT_USER_CONFIG=$HSHQ_CONFIG_DIR/ptUserConfig.conf
  SYSTEM_STATE_FILENAME=$HSHQ_CONFIG_DIR/systemstate
  SS_INIT=init
  SS_INSTALLING=installing
  SS_RESTORING=restoring
  SS_BOOTING=booting
  SS_TRANSFERRING=transferring
  SS_UPDATING=updating
  SS_REMOVING=removing
  SS_RUNNING=running
  UTILS_LIST="wget|wget whiptail|whiptail awk|gawk screen|screen pwgen|pwgen argon2|argon2 dig|dnsutils htpasswd|apache2-utils ssh|ssh sshd|openssh-server sshpass|sshpass wg|wireguard-tools qrencode|qrencode openssl|openssl faketime|faketime bc|bc sipcalc|sipcalc jq|jq git|git http|httpie sqlite3|sqlite3 curl|curl sha1sum|coreutils lsb_release|lsb-release nano|nano cron|cron ping|iputils-ping route|net-tools grepcidr|grepcidr networkd-dispatcher|networkd-dispatcher certutil|libnss3-tools update-ca-certificates|ca-certificates gpg|gnupg python3|python3 pip3|python3-pip unzip|unzip hwinfo|hwinfo netplan|netplan.io netplan|openvswitch-switch uuidgen|uuid-runtime aa-enforce|apparmor-utils logrotate|logrotate yq|yq iwlist|wireless-tools sudo|sudo gcc|build-essential gio|libglib2.0-bin"
  DESKTOP_APT_LIST=""
  APT_REMOVE_LIST="vim vim-tiny vim-common xxd needrestart bsd-mailx"
  RELAYSERVER_UTILS_LIST="curl|curl awk|gawk whiptail|whiptail nano|nano screen|screen htpasswd|apache2-utils pwgen|pwgen git|git http|httpie jq|jq sqlite3|sqlite3 wg|wireguard-tools qrencode|qrencode route|net-tools sipcalc|sipcalc mailx|mailutils ipset|ipset uuidgen|uuid-runtime grepcidr|grepcidr networkd-dispatcher|networkd-dispatcher aa-enforce|apparmor-utils logrotate|logrotate"
  hshqlogo=$(cat << EOFLG
#===============================================================#
# ▀█  █  ▄▄  ▄▄ ▄▄ ▄▄▄ █▀▀▀█ ▄▄▄ ▄▄▄  ▄   ▄ ▄▄▄ ▄▄▄  █  █ █▀▀█  #
#  █▀▀█ █  █ █ █ █ ▄▄  ▀▀▀▄▄ ▄▄  ▄▄▄▀ ▀▄ ▄▀ ▄▄  ▄▄▄▀ █▀▀█ █  █  #
#  █  █ ▀▄▄▀ █   █ ▄▄▄ █▄▄▄█ ▄▄▄ ▄▄▄▄  ▀█▀  ▄▄▄ ▄▄▄▄ █  █ █▄▄█▄ #
#===============================================================#

EOFLG
  )
  hshqwarninglogo=$(cat << EOFLG
#===============================================================#
# ▀█  █  ▄▄  ▄▄ ▄▄ ▄▄▄ █▀▀▀█ ▄▄▄ ▄▄▄  ▄   ▄ ▄▄▄ ▄▄▄  █  █ █▀▀█  #
#  █▀▀█ █  █ █ █ █ ▄▄  ▀▀▀▄▄ ▄▄  ▄▄▄▀ ▀▄ ▄▀ ▄▄  ▄▄▄▀ █▀▀█ █  █  #
#  █  █ ▀▄▄▀ █   █ ▄▄▄ █▄▄▄█ ▄▄▄ ▄▄▄▄  ▀█▀  ▄▄▄ ▄▄▄▄ █  █ █▄▄█▄ #
#===============================================================#
        ***** WARNING - Config File is UNENCRYPTED! *****        
EOFLG
  )
}

function main()
{
  init
  checkWrapperVersion
  IS_CONSOLE_ENV=true
  IS_PERFORM_INSTALL=false
  IS_NEW_LIB=false
  CONNECTING_IP=""
  IS_PERFORM_RESTORE=false
  IS_PERFORM_UPDATE=false
  case "$1" in
    "install")
      IS_PERFORM_INSTALL=true
      CONNECTING_IP=$2
      ;;
    "-a")
      CONNECTING_IP=$2
      ;;
    "run")
      IS_NEW_LIB=$2
      CONNECTING_IP=$3
      ;;
    "restore")
      CONNECTING_IP=$2
      IS_PERFORM_RESTORE=true
      ;;
    "update")
      IS_PERFORM_UPDATE=true
      ;;
    *)
      ;;
  esac
  if [ -z "$CONNECTING_IP" ]; then
    CONNECTING_IP=$(getConnectingIPAddress)
  fi
  if [ -z "$CONNECTING_IP" ] && [ -f ~/hshq/cip.txt ]; then
    CONNECTING_IP=$(cat ~/hshq/cip.txt)
  fi
  if [ "$IS_PERFORM_UPDATE" = "true" ]; then
    setSystemState $SS_UPDATING
    checkUpdateVersion
    moveScriptServerPerformUpdate
    if [ "$IS_RESTART_SCRIPTSERVER" = "true" ]; then
      sudo systemctl daemon-reload
      sudo systemctl restart runScriptServer.service
    fi
    setSystemState $SS_RUNNING
    return
  fi
  if ! [ -z "$USER_SUDO_PW" ]; then
    echo "$USER_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      USER_SUDO_PW=""
    fi
  fi
  if [ "$IS_PERFORM_INSTALL" = "true" ]; then
    mkdir -p $TMP_PW_CHECKDIR
    read -r -s -p "" sudoPWKey
    USER_SUDO_PW="$(openssl enc -d -aes256 -pbkdf2 -in $ENC_PW_FILE -pass pass:$sudoPWKey)"
    rm -f $ENC_PW_FILE
    refreshSudo
    rm -fr $TMP_PW_CHECKDIR
    clear
    stty echo
    if [ "$USERNAME" = "root" ]; then
      strErr="main - Cannot install as root user, exiting..."
      logHSHQEvent error "$strErr"
      echo "$strErr"
      exit 1
    fi
    performBaseInstallation
    exit 0
  fi
  if [ "$IS_PERFORM_RESTORE" = "true" ]; then
    mkdir -p $TMP_PW_CHECKDIR
    read -r -s -p "" sudoPWKey
    USER_SUDO_PW="$(openssl enc -d -aes256 -pbkdf2 -in $ENC_PW_FILE -pass pass:$sudoPWKey)"
    rm -f $ENC_PW_FILE
    refreshSudo
    rm -fr $TMP_PW_CHECKDIR
    clear
    stty echo
    if [ "$USERNAME" = "root" ]; then
      echo "Cannot install as root user, exiting..."
      exit 1
    fi
    performFullRestore
    exit 0
  fi
  set +e
  # Mitigate any race conditions after an update
  sleep 2
  tgLock="$(tryGetLock hshqopen User-Console)"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg hshqopen)"
    showNoYesMessageBox "Script Running" "It appears that this script is already running in another session ($checkRes). This situation could occur if another scheduled process is currently running or the script exited prematurely with an error. Unknown and damaging consequences can occur if running two different instances at the same time. Are you certain that you wish to continue?"
    mbres=$?
    if [ $mbres -eq 0 ]; then
      exit
    fi
    sudo -k
    USER_SUDO_PW=""
    refreshSudo
    if [ $? -ne 0 ]; then
      exit 3
    fi
    forceGetLock hshqopen "User-Console"
  fi
  set -e
  checkConfigAvailable
  is_hshq_installed=false
  if ! [ -z "$CONFIG_FILE" ] && [ -f $CONFIG_FILE ]; then
    isInstalled=$(getConfigVarFromFile IS_INSTALLED $CONFIG_FILE)
    if [ "$isInstalled" = "true" ]; then
      is_hshq_installed=true
      IS_CONFIG_FILE_UNENCRYPTED=true
      set +e
      fixConfigV130
      set -e
      source $CONFIG_FILE
    else
      is_hshq_installed=false
    fi
  elif ! [ -z "$ENC_CONFIG_FILE" ] && [ -f $ENC_CONFIG_FILE ]; then
    # Encrypted file found, assume installed.
    is_hshq_installed=true
  fi
  set +e
  mainMenuResult=1
  while  [[ $mainMenuResult -ne 0 ]]
  do
    if [ "$is_hshq_installed" = "true" ]; then
      if [ "$IS_NEW_LIB" = "true" ]; then
        checkLoadConfig
      fi
      showInstalledMenu
    else
      showNotInstalledMenu
    fi
    mainMenuResult=$?
  done
  performExitFunctions true
}

function showNotInstalledMenu()
{
  set +e
  checkSupportedHostOS
  refreshSudo
  setSudoTimeoutInstall
  if [[ "$(isProgramInstalled sshd)" = "false" ]]; then
    sudo DEBIAN_FRONTEND=noninteractive apt update
    echo "Installing openssh-server, please wait..."
    performAptInstall openssh-server > /dev/null 2>&1
  fi
  notinstalledmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$notinstalledmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Perform Base Installation" \
  "2" "Edit Configuration" \
  "3" "Install Dependencies" \
  "4" "Update APT Mirror" \
  "5" "Uninstall and Remove Everything" \
  "6" "Restore From Backup" \
  "7" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  set -e
  case $menures in
    0)
      return 0 ;;
    1)
      checkWorkingInternet
      checkUpdateAptSources false
      clear
      checkDockerPre
      set -e
      clear
      echo "Please wait..."
      checkLoadConfig
      initConfig
      initCertificateAuthority
      if [ "$IS_DESKTOP_ENV" = "true" ]; then
        PRIMARY_VPN_SETUP_TYPE=none
        updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
      else
        setupVPNConnection
        if [ $? -ne 0 ]; then
          exit
        fi
      fi
      if [ "$IS_INSTALLED" = "true" ] || [ "$IS_INSTALLING" = "true" ]; then
        showMessageBox "Error" "Already installed or existing installation is in progress."
        set +e
        exit
      fi
      initInstallation ;;
    2)
      checkWorkingInternet
      checkUpdateAptSources false
      set -e
      checkLoadConfig
      initConfig
      nano $CONFIG_FILE
      loadConfigVars true
      set +e
      return 1 ;;
    3)
      checkWorkingInternet
      checkUpdateAptSources false
      set -e
      installDependencies
      pullBaseServicesDockerImages
      sudo reboot ;;
    4)
      set +e
      checkWorkingInternet
      refreshSudo
      checkUpdateAptSources true
      return 1 ;;
    5)
      nukeHSHQ
      set +e
      return 1 ;;
    6)
      checkWorkingInternet
      checkUpdateAptSources false
      showRestoreMenu
      set +e
      return 1 ;;
    7)
      return 0 ;;
  esac
}

function checkDockerPre()
{
  set +e
  sudo docker ps > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    if [ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]; then
      # Docker must be installed and system rebooted
      showMessageBox "It appears that docker is not installed, and the OS Linux version is Debian 12. Due to recent changes, docker must be installed beforehand and the system rebooted in order to continue. After the system has rebooted, please log back in with this same user ($USERNAME) and restart the installation. Press okay to proceed."
      sudo DEBIAN_FRONTEND=noninteractive apt update
      sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
      sudo DEBIAN_FRONTEND=noninteractive apt dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
      installDocker
      sudo reboot
    fi
  fi
}

function checkWorkingInternet()
{
  set +e
  timeout 10 ping -c 1 1.1.1.1 > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "You do not appear to have a working internet connection. Please check your network settings and try again."
    exit 2
  fi
}

function verifyAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    if test -f /etc/apt/sources.list; then
      echo "true"
      return
    fi
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    if test -f /etc/apt/sources.list.d/ubuntu.sources; then
      echo "true"
      return
    fi
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    if test -f /etc/apt/sources.list.d/official-package-repositories.list; then
      echo "true"
      return
    fi
  fi
  echo "false"
}

function backupOrigAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    if ! test -f /etc/apt/sources.list.orig; then
      sudo cp /etc/apt/sources.list /etc/apt/sources.list.orig
    fi
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    if ! test -f /etc/apt/sources.list.d/ubuntu.sources.orig; then
      sudo cp /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.orig
    fi
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    if ! test -f /etc/apt/sources.list.d/official-package-repositories.list.orig; then
      sudo cp /etc/apt/sources.list.d/official-package-repositories.list /etc/apt/sources.list.d/official-package-repositories.list.orig
    fi
  fi
}

function checkIfOrigAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    if test -f /etc/apt/sources.list.orig; then
      echo "true"
    else
      echo "false"
    fi
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    if test -f /etc/apt/sources.list.d/ubuntu.sources.orig; then
      echo "true"
    else
      echo "false"
    fi
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    if test -f /etc/apt/sources.list.d/official-package-repositories.list.orig; then
      echo "true"
    else
      echo "false"
    fi
  fi
}

function getDefaultAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    grep "^deb" /etc/apt/sources.list.orig | head -n 1 | cut -d" " -f2
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    grep "^URIs" /etc/apt/sources.list.d/ubuntu.sources.orig | head -n 1 | cut -d" " -f2
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    grep "^URIs" /etc/apt/sources.list.d/official-package-repositories.list.orig | head -n 1 | cut -d" " -f2
  fi
}

function backupAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    sudo cp -f /etc/apt/sources.list /etc/apt/sources.list.backup
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    sudo cp -f /etc/apt/sources.list.d/ubuntu.sources /etc/apt/sources.list.d/ubuntu.sources.backup
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo cp -f /etc/apt/sources.list.d/official-package-repositories.list /etc/apt/sources.list.d/official-package-repositories.list.backup
  fi
}

function removeBackupAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    sudo rm -f /etc/apt/sources.list.backup
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    sudo rm -f /etc/apt/sources.list.d/ubuntu.sources.backup
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo rm -f /etc/apt/sources.list.d/official-package-repositories.list.backup
  fi
}

function restoreBackupAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    sudo cp -f /etc/apt/sources.list.backup /etc/apt/sources.list
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    sudo cp -f /etc/apt/sources.list.d/ubuntu.sources.backup /etc/apt/sources.list.d/ubuntu.sources
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo cp -f /etc/apt/sources.list.d/official-package-repositories.list.backup /etc/apt/sources.list.d/official-package-repositories.list
  fi
}

function restoreOrigAptSource()
{
  if ([ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]) || ([ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]); then
    sudo cp -f /etc/apt/sources.list.orig /etc/apt/sources.list
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    sudo cp -f /etc/apt/sources.list.d/ubuntu.sources.orig /etc/apt/sources.list.d/ubuntu.sources
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo cp -f /etc/apt/sources.list.d/official-package-repositories.list.orig /etc/apt/sources.list.d/official-package-repositories.list
  fi
}

function replaceAptMirror()
{
  aptUrl="$1"
  if [ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]; then
    sudo sed -i "/security/! s|deb [a-z]*://[^ ]* |deb ${aptUrl} |g" /etc/apt/sources.list
    sudo sed -i "/security/! s|deb-src [a-z]*://[^ ]* |deb-src ${aptUrl} |g" /etc/apt/sources.list
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo sed -i "s|deb [a-z]*://[^ ]* |deb ${aptUrl} |g" /etc/apt/sources.list
    sudo sed -i "s|deb-src [a-z]*://[^ ]* |deb-src ${aptUrl} |g" /etc/apt/sources.list
  elif [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24. ]]; then
    sudo sed -i "s|^URIs.*|URIs: ${aptUrl} |g" /etc/apt/sources.list.d/ubuntu.sources
  elif [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    sudo sed -i "/linuxmint/! s|deb [a-z]*://[^ ]* |deb ${aptUrl} |g" /etc/apt/sources.list.d/official-package-repositories.list
  fi
}

function checkUpdateAptSources()
{
  isForceCheck="$1"
  set +e
  if ! [ "$(verifyAptSource)" = "true" ]; then
    showMessageBox "ERROR" "There was a problem with your apt sources list. Proceeding with current settings..."
    return
  fi
  if [ "$(checkIfOrigAptSource)" = "true" ] && ! [ "$isForceCheck" = "true" ]; then
    performAptUpdate false
    return
  fi
  if ! [ "$isForceCheck" = "true" ]; then
    showYesNoMessageBox "Find Mirrors" "Would you like to check for nearby apt mirrors? This process will take around 1-2 minutes to complete, but it will likely save a lot more time in the future when performing Linux host updates."
    if [ $? -ne 0 ]; then
      backupOrigAptSource
      performAptUpdate false
      return
    fi
  fi
  backupOrigAptSource
  default_apt_src="$(getDefaultAptSource)"
  backupAptSource
  echo "========================================================================"
  echo "  Calculating the closest apt mirrors."
  echo "  This could take a minute or two, please wait..."
  echo "========================================================================"
  mirrorResults="$(getFastestMirrors)"
  if [ -z "$mirrorResults" ]; then
    showMessageBox "ERROR" "There was a problem obtaining mirror info, continuing with current settings..."
    removeBackupAptSource
    performAptUpdate false
    return
  fi
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  mirrorResultsArr=($(echo "$mirrorResults"))
  IFS=$OLDIFS
  aptupdatemenu=$(cat << EOF

$(getLogo)

Select your desired apt sources mirror from the list below.
To keep the current settings, select Cancel.
EOF
)
  uas_menu_items=( --title "Select Mirror" --radiolist "$aptupdatemenu" $(($MENU_HEIGHT+2)) $MENU_WIDTH $MENU_INT_HEIGHT )
  curNum=1
  for curMirror in "${mirrorResultsArr[@]}"
  do
    uas_menu_items+=( "$(echo $curMirror | xargs)" )
    uas_menu_items+=( "|" )
    if [ $curNum -eq 1 ]; then
      uas_menu_items+=( "on" )
    else
      uas_menu_items+=( "off" )
    fi
    ((curNum++))
  done
  while true
    do
    selItem=$(whiptail "${uas_menu_items[@]}" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
      restoreBackupAptSource
      removeBackupAptSource
      performAptUpdate false
      return
    fi
    selAptSource=$(echo "$selItem" | xargs | rev | cut -d" " -f1 | rev)
    replaceAptMirror "$selAptSource"
    tmpOutput=/tmp/aptOut.txt
    rm -f $tmpOutput
    performAptUpdate false 2>&1 | tee $tmpOutput
    grep -e "^Err:" -e "Failed" $tmpOutput > /dev/null 2>&1
    chkRes=$?
    rm -f $tmpOutput
    if [ $chkRes -eq 0 ]; then
      errmenu=$(cat << EOF

$(getLogo)

There were some errors found with the selected mirror.
Select Retry to select a different mirror, or select
Revert to restore the original default.
EOF
      )
      restoreOrigAptSource
      if (whiptail --title "Error" --yesno "$errmenu" $MENU_HEIGHT $MENU_WIDTH --yes-button "Retry" --no-button "Revert" ); then
        continue
      else
        performAptUpdate false
        break
      fi
    else
      echo -e "========================================================================\n"
      echo -e "The selected mirror appears to be in good working order. (See above)\n"
      isBreakMainLoop=false
      while true
      do
        echo "Enter 'confirm': To proceed with this option"
        echo "        'retry': To select a different mirror from the list"
        echo "       'revert': To restore the prior settings and continue"
        echo "         'orig': To restore the original default and continue"
        echo "         'exit': To restore the prior settings and exit the HSHQ utility"
        echo
        read -r -p "Your selection: " selMirrorOption
        if [ "$selMirrorOption" = "confirm" ]; then
          isBreakMainLoop=true
          break
        elif [ "$selMirrorOption" = "retry" ]; then
          restoreBackupAptSource
          isBreakMainLoop=false
          break
        elif [ "$selMirrorOption" = "revert" ]; then
          restoreBackupAptSource
          isBreakMainLoop=true
          performAptUpdate false
          break
        elif [ "$selMirrorOption" = "orig" ]; then
          restoreOrigAptSource
          isBreakMainLoop=true
          performAptUpdate false
          break
        elif [ "$selMirrorOption" = "exit" ]; then
          restoreBackupAptSource
          removeBackupAptSource
          performExitFunctions true
          exit
        else
          echo "Unknown response, please retry."
        fi
      done
      if [ "$isBreakMainLoop" = "true" ]; then
        break
      fi
    fi
  done
  removeBackupAptSource
}

function performAptUpdate()
{
  clear
  isQuietUpdate="$1"
  if [ "$isQuietUpdate" = "true" ]; then
    echo "Performing apt update, please wait..."
    sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null
  else
    sudo DEBIAN_FRONTEND=noninteractive apt update
  fi
}

function getFastestMirrors()
{
  # Some of the concepts of this function were adopted from
  # https://github.com/vegardit/fast-apt-mirror.sh/blob/v1/fast-apt-mirror.sh
  set +e
  distID=""
  last_modified_path=""
  if [ "$DISTRO_ID" = "debian" ]; then
    distID="debian"
  elif [ "$DISTRO_ID" = "ubuntu" ] || [ "$DISTRO_ID" = "linuxmint" ]; then
    distID="ubuntu"
  else
    # Fatal
    exit 1
  fi
  cd ~
  backupOrigAptSource
  default_mirror="$(getDefaultAptSource)"
  which netselect > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    netselect_version='0.3.ds1-30.1'
    wget http://ftp.debian.org/debian/pool/main/n/netselect/netselect_${netselect_version}_${DISTRO_ARCH}.deb > /dev/null 2>&1
    sudo apt install ./netselect_${netselect_version}_${DISTRO_ARCH}.deb > /dev/null 2>&1
    rm -f ./netselect_${netselect_version}_${DISTRO_ARCH}.deb
  fi
  rm -f /tmp/mirrors.txt
  outputMirrorsList
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  fastestMirrorsArr=($(sudo netselect -s50 -t4 $(grep "^$distID" /tmp/mirrors.txt | cut -d" " -f2) 2>/dev/null))
  IFS=$OLDIFS
  rm -f /tmp/mirrors.txt
  mirrorsDomainList=$(echo "$default_mirror" | tr -s "/" | cut -d"/" -f2)
  mirrorsURLsList="$default_mirror"
  maxMirrors=15
  curMirrorCount=1
  curDTSeconds=$(date +%s)
  last_modified_path="ls-lR.gz"
  for curMirror in "${fastestMirrorsArr[@]}"
  do
    curURL=$(echo "$curMirror" | xargs | cut -d" " -f2)
    curDomain=$(echo "$curURL" | tr -s "/" | cut -d"/" -f2)
    echo "$mirrorsDomainList" | grep "$curDomain" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      mirrorsDomainList="$mirrorsDomainList $curDomain"
      # Check last modified date
      lastModified=$(curl --max-time 3 -sSfL --head "$curURL${last_modified_path}" 2>/dev/null | grep -i "last-modified" | cut -d" " -f2- | LANG=C date -f- -u +%s)
      if ! [ -z "$lastModified" ] && [ "$(checkValidNumber $lastModified)" = "true" ] && [ $lastModified -gt 0 ]; then
        secsDiff=$(($curDTSeconds-$lastModified))
        # 2592000 is equivalent to last 30 days
        if [ $secsDiff -ge 2592000 ]; then
          continue
        fi
      else
        continue
      fi
      mirrorsURLsList="$mirrorsURLsList\n$curURL"
      ((curMirrorCount++))
      if [ $curMirrorCount -ge $maxMirrors ]; then
        break
      fi
    fi
  done
  echo -e "$mirrorsURLsList" | xargs -P 5 -i bash -c "curl -r 0-5120000 --max-time 5 -sf -w '%{speed_download} {}\n' -o /dev/null {}ls-lR.gz 2>/dev/null" | awk '$1 > 0' | awk '{printf "%.2f MB/s %s\n",$1/1048576,$2}' | sort -rg | head -n 7
}

function outputMirrorsList()
{
  # We'll just manage the list right here
  # to reduce the potential points of failure
  cat <<EOFML > /tmp/mirrors.txt
debian http://ftp.am.debian.org/debian/
debian http://ftp.au.debian.org/debian/
debian http://ftp.at.debian.org/debian/
debian http://ftp.by.debian.org/debian/
debian http://ftp.be.debian.org/debian/
debian http://ftp.br.debian.org/debian/
debian http://ftp.bg.debian.org/debian/
debian http://ftp.ca.debian.org/debian/
debian http://ftp.cl.debian.org/debian/
debian http://ftp.cn.debian.org/debian/
debian http://ftp.hr.debian.org/debian/
debian http://ftp.cz.debian.org/debian/
debian http://ftp.dk.debian.org/debian/
debian http://ftp.fi.debian.org/debian/
debian http://ftp.fr.debian.org/debian/
debian http://ftp2.de.debian.org/debian/
debian http://ftp.de.debian.org/debian/
debian http://ftp.hk.debian.org/debian/
debian http://ftp.is.debian.org/debian/
debian http://ftp.it.debian.org/debian/
debian http://ftp.jp.debian.org/debian/
debian http://ftp.kr.debian.org/debian/
debian http://ftp.lt.debian.org/debian/
debian http://ftp.md.debian.org/debian/
debian http://ftp.nl.debian.org/debian/
debian http://ftp.nc.debian.org/debian/
debian http://ftp.nz.debian.org/debian/
debian http://ftp.no.debian.org/debian/
debian http://ftp.pl.debian.org/debian/
debian http://ftp.pt.debian.org/debian/
debian http://ftp.sk.debian.org/debian/
debian http://ftp.si.debian.org/debian/
debian http://ftp.es.debian.org/debian/
debian http://ftp.se.debian.org/debian/
debian http://ftp.ch.debian.org/debian/
debian http://ftp.tw.debian.org/debian/
debian http://ftp.tr.debian.org/debian/
debian http://ftp.uk.debian.org/debian/
debian http://ftp.us.debian.org/debian/
debian http://mirror.abmanagement.al/debian/
debian http://debian.unnoba.edu.ar/debian/
debian http://mirror.sitsa.com.ar/debian/
debian http://mirrors.asnet.am/debian/
debian http://debian.mirror.digitalpacific.com.au/debian/
debian http://debian.mirror.serversaustralia.com.au/debian/
debian http://mirror.aarnet.edu.au/debian/
debian http://mirror.amaze.com.au/debian/
debian http://mirror.gsl.icu/debian/
debian http://mirror.linux.org.au/debian/
debian http://mirror.overthewire.com.au/debian/
debian http://mirror.realcompute.io/debian/
debian http://mirrors.xtom.au/debian/
debian http://debian.anexia.at/debian/
debian http://debian.lagis.at/debian/
debian http://debian.mur.at/debian/
debian http://debian.sil.at/debian/
debian http://ftp.tu-graz.ac.at/mirror/debian/
debian http://mirror.alwyzon.net/debian/
debian http://mirror.ourhost.az/debian/
debian http://mirror.limda.net/debian/
debian http://mirror.xeonbd.com/debian/
debian http://ftp.byfly.by/debian/
debian http://mirror.datacenter.by/debian/
debian http://debian-mirror.behostings.net/debian/
debian http://ftp.belnet.be/debian/
debian http://mirror.as35701.net/debian/
debian http://mirror.unix-solutions.be/debian/
debian http://debian.c3sl.ufpr.br/debian/
debian http://debian.pop-sc.rnp.br/debian/
debian http://mirror.blue3.com.br/debian/
debian http://mirrors.ic.unicamp.br/debian/
debian http://mirror.uepg.br/debian/
debian http://mirror.ufscar.br/debian/
debian http://debian.a1.bg/debian/
debian http://debian.ipacct.com/debian/
debian http://debian.ludost.net/debian/
debian http://debian.mnet.bg/debian/
debian http://debian.telecoms.bg/debian/
debian http://ftp.uni-sofia.bg/debian/
debian http://mirrors.netix.net/debian/
debian http://mirror.telepoint.bg/debian/
debian http://mirror.sabay.com.kh/debian/
debian http://debian.linux.n0c.ca/debian/
debian http://debian.mirror.rafal.ca/debian/
debian http://mirror.csclub.uwaterloo.ca/debian/
debian http://mirror.dst.ca/debian/
debian http://mirror.estone.ca/debian/
debian http://mirror.it.ubc.ca/debian/
debian http://debian-mirror.puq.apoapsis.cl/debian/
debian http://debian.redlibre.cl/debian/
debian http://mirror.hnd.cl/debian/
debian http://mirror.insacom.cl/debian/
debian http://mirror.ufro.cl/debian/
debian http://mirror.lzu.edu.cn/debian/
debian http://mirror.nju.edu.cn/debian/
debian http://mirror.nyist.edu.cn/debian/
debian http://mirrors.163.com/debian/
debian http://mirrors.bfsu.edu.cn/debian/
debian http://mirrors.hit.edu.cn/debian/
debian http://mirrors.jlu.edu.cn/debian/
debian http://mirrors.neusoft.edu.cn/debian/
debian http://mirrors.tuna.tsinghua.edu.cn/debian/
debian http://mirrors.ustc.edu.cn/debian/
debian http://mirrors.zju.edu.cn/debian/
debian http://mirrors.ucr.ac.cr/debian/
debian http://debian.carnet.hr/debian/
debian http://debian.iskon.hr/debian/
debian http://debian.superhosting.cz/debian/
debian http://ftp.cvut.cz/debian/
debian http://ftp.debian.cz/debian/
debian http://ftp.sh.cvut.cz/debian/
debian http://ftp.zcu.cz/debian/
debian http://merlin.fit.vutbr.cz/debian/
debian http://mirror.dkm.cz/debian/
debian http://mirror.it4i.cz/debian/
debian http://mirrors.nic.cz/debian/
debian http://mirror.one.com/debian/
debian http://mirrors.dotsrc.org/debian/
debian http://mirrors.rackhosting.com/debian/
debian http://mirrors.xtom.ee/debian/
debian http://debian.web.trex.fi/debian/
debian http://www.nic.funet.fi/debian/
debian http://apt.tetaneutral.net/debian/
debian http://debian.apt-mirror.de/debian/
debian http://debian.mirrors.ovh.net/debian/
debian http://debian.obspm.fr/debian/
debian http://debian.polytech-lille.fr/debian/
debian http://debian.proxad.net/debian/
debian http://debian.univ-tlse2.fr/debian/
debian http://deb-mir1.naitways.net/debian/
debian http://deb.syxpi.fr/debian/
debian http://ftp.ec-m.fr/debian/
debian http://ftp.lip6.fr/pub/linux/distributions/debian/
debian http://ftp.rezopole.net/debian/
debian http://ftp.univ-pau.fr/linux/mirrors/debian/
debian http://ftp.u-picardie.fr/debian/
debian http://ftp.u-strasbg.fr/debian/
debian http://miroir.univ-lorraine.fr/debian/
debian http://mirror.debian.ikoula.com/debian/
debian http://mirror.gitoyen.net/debian/
debian http://mirror.ibcp.fr/debian/
debian http://mirror.johnnybegood.fr/debian/
debian http://mirror.plusserver.com/debian/debian/
debian http://mirrors.ircam.fr/pub/debian/
debian http://debian.grena.ge/debian/
debian http://debian.charite.de/debian/
debian http://debian.inf.tu-dresden.de/debian/
debian http://debian.intergenia.de/debian/
debian http://debian.mirror.iphh.net/debian/
debian http://debian.mirror.lrz.de/debian/
debian http://debian.netcologne.de/debian/
debian http://debian.tu-bs.de/debian/
debian http://de.mirrors.clouvider.net/debian/
debian http://drmirror.physi.uni-heidelberg.de/debian/
debian http://ftp.fau.de/debian/
debian http://ftp.gwdg.de/debian/
debian http://ftp.halifax.rwth-aachen.de/debian/
debian http://ftp.hosteurope.de/mirror/ftp.debian.org/debian/
debian http://ftp-stud.hs-esslingen.de/debian/
debian http://ftp.stw-bonn.de/debian/
debian http://ftp.tu-chemnitz.de/debian/
debian http://ftp.tu-clausthal.de/debian/
debian http://ftp.uni-bayreuth.de/debian/
debian http://ftp.uni-hannover.de/debian/debian/
debian http://ftp.uni-kl.de/debian/
debian http://ftp.uni-mainz.de/debian/
debian http://ftp.uni-stuttgart.de/debian/
debian http://ftp.wrz.de/debian/
debian http://mirror.23m.com/debian/
debian http://mirror.creoline.net/debian/
debian http://mirror.de.leaseweb.net/debian/
debian http://mirror.dogado.de/debian/
debian http://mirror.eu.oneandone.net/debian/
debian http://mirror.informatik.tu-freiberg.de/debian/
debian http://mirror.ipb.de/debian/
debian http://mirror.netzwerge.de/debian/
debian http://mirror.plusline.net/debian/
debian http://mirrors.xtom.de/debian/
debian http://mirror.united-gameserver.de/debian/
debian http://mirror.wtnet.de/debian/
debian http://packages.hs-regensburg.de/debian/
debian http://pubmirror.plutex.de/debian/
debian http://debian.otenet.gr/debian/
debian http://mirror.xtom.com.hk/debian/
debian http://ftp.bme.hu/debian/
debian http://repo.jztkft.hu/debian/
debian http://is.mirror.flokinet.net/debian/
debian http://mirror.cse.iitk.ac.in/debian/
debian http://mirror.nitc.ac.in/debian/
debian http://mirrors.iitd.ac.in/debian/
debian http://kartolo.sby.datautama.net.id/debian/
debian http://kebo.pens.ac.id/debian/
debian http://mirror.poliwangi.ac.id/debian/
debian http://mirror.unair.ac.id/debian/
debian http://mr.heru.id/debian/
debian http://mirror.aminidc.com/debian/
debian http://mirrors.pardisco.co/debian/
debian http://debian.interhost.co.il/debian/
debian http://debian.connesi.it/debian/
debian http://debian.dynamica.it/debian/
debian http://debian.mirror.garr.it/debian/
debian http://ftp.linux.it/debian/
debian http://giano.com.dist.unige.it/debian/
debian http://mirror.units.it/debian/
debian http://debian-mirror.sakura.ne.jp/debian/
debian http://ftp.jaist.ac.jp/debian/
debian http://ftp.kddilabs.jp/pub/debian/
debian http://ftp.nara.wide.ad.jp/debian/
debian http://ftp.riken.jp/Linux/debian/debian/
debian http://ftp.yz.yamagata-u.ac.jp/debian/
debian http://mirrors.xtom.jp/debian/
debian http://repo.jing.rocks/debian/
debian http://mirror.hoster.kz/debian/
debian http://mirror.ps.kz/debian/
debian http://debian.mirror.ac.ke/debian/
debian http://debian.mirror.liquidtelecom.com/debian/
debian http://ftp.kaist.ac.kr/debian/
debian http://ftp.lanet.kr/debian/
debian http://mirror.siwoo.org/debian/
debian http://debian.koyanet.lv/debian/
debian http://mirror.cloudhosting.lv/debian/
debian http://mirror.veesp.com/debian/
debian http://debian.mirror.vu.lt/debian/
debian http://mirror.litnet.lt/debian/
debian http://mirror.vpsnet.com/debian/
debian http://debian.mirror.root.lu/debian/
debian http://mirror.a1.mk/debian/
debian http://mirror-mk.interspace.com/debian/
debian http://lidsol.fi-b.unam.mx/debian/
debian http://mirror.as43289.net/debian/
debian http://mirror.marwan.ma/debian/
debian http://debian.snt.utwente.nl/debian/
debian http://mirror.ams.macarne.com/debian/
debian http://mirror.bgp.rodeo/debian/
debian http://mirror.duocast.net/debian/
debian http://mirror.i3d.net/debian/
debian http://mirror.nforce.com/debian/
debian http://mirror.nl.cdn-perfprod.com/debian/
debian http://mirror.nl.datapacket.com/debian/
debian http://mirror.nl.leaseweb.net/debian/
debian http://mirror.nl.mirhosting.net/debian/
debian http://mirrors.hostiserver.com/debian/
debian http://mirrors.xtom.nl/debian/
debian http://mirror.tngnet.com/debian/
debian http://mirror.vpgrp.io/debian/
debian http://nl.mirror.flokinet.net/debian/
debian http://nl.mirrors.clouvider.net/debian/
debian http://debian.nautile.nc/debian/
debian http://mirror.lagoon.nc/debian/
debian http://linux.purple-cat.net/debian/
debian http://mirror.fsmg.org.nz/debian/
debian http://ftp.uio.no/debian/
debian http://ftp.agh.edu.pl/debian/
debian http://ftp.psnc.pl/debian/
debian http://ftp.task.gda.pl/debian/
debian http://debian.uevora.pt/debian/
debian http://ftp.eq.uc.pt/software/Linux/debian/
debian http://ftp.rnl.tecnico.ulisboa.pt/pub/debian/
debian http://mirror.leitecastro.com/debian/
debian http://mirrors.upr.edu/debian/
debian http://debian.mithril.re/debian/
debian http://mirror.flo.c-f.ro/debian/
debian http://mirror.linux.ro/debian/
debian http://mirror.ro.cdn-perfprod.com/debian/
debian http://mirrors.hosterion.ro/debian/
debian http://mirrors.hostico.ro/debian/
debian http://mirrors.nav.ro/debian/
debian http://mirrors.nxthost.com/debian/
debian http://mirrors.pidginhost.com/debian/
debian http://ro.mirror.flokinet.net/debian/
debian http://ftp.psn.ru/debian/
debian http://mirror.corbina.net/debian/
debian http://mirror.docker.ru/debian/
debian http://mirror.hyperdedic.ru/debian/
debian http://mirror.kpfu.ru/debian/
debian http://mirrors.powernet.com.ru/debian/
debian http://mirror.truenetwork.ru/debian/
debian http://repository.su/debian/
debian http://mirror.pmf.kg.ac.rs/debian/
debian http://mirror.coganng.com/debian/
debian http://mirror.djvg.sg/debian/
debian http://mirror.sg.gs/debian/
debian http://ossmirror.mycloud.services/debian/
debian http://deb.bbxnet.sk/debian/
debian http://ftp.antik.sk/debian/
debian http://ftp.debian.sk/debian/
debian http://debian.mirror.ac.za/debian/
debian http://ftp.is.co.za/debian/
debian http://debian.grn.cat/debian/
debian http://debian.redimadrid.es/debian/
debian http://debian.redparra.com/debian/
debian http://debian.uvigo.es/debian/
debian http://ftp.caliu.cat/debian/
debian http://ftp.cica.es/debian/
debian http://ftp.udc.es/debian/
debian http://mirror.raiolanetworks.com/debian/
debian http://repo.ifca.es/debian/
debian http://softlibre.unizar.es/debian/
debian http://ulises.hostalia.com/debian/
debian http://debian.lth.se/debian/
debian http://debian.mirror.su.se/debian/
debian http://ftp.acc.umu.se/debian/
debian http://ftpmirror1.infania.net/debian/
debian http://mirror.braindrainlan.nu/debian/
debian http://mirrors.glesys.net/debian/
debian http://debian.ethz.ch/debian/
debian http://linuxsoft.cern.ch/debian/
debian http://mirror1.infomaniak.com/debian/
debian http://mirror2.infomaniak.com/debian/
debian http://mirror.init7.net/debian/
debian http://mirror.iway.ch/debian/
debian http://mirror.sinavps.ch/debian/
debian http://pkg.adfinis-on-exoscale.ch/debian/
debian http://debian.ccns.ncku.edu.tw/debian/
debian http://debian.csie.ntu.edu.tw/debian/
debian http://debian.cs.nycu.edu.tw/debian/
debian http://ftp.tku.edu.tw/debian/
debian http://mirror.twds.com.tw/debian/
debian http://opensource.nchc.org.tw/debian/
debian http://tw1.mirror.blendbyte.net/debian/
debian http://ftp.debianclub.org/debian/
debian http://mirror.applebred.net/debian/
debian http://mirror.kku.ac.th/debian/
debian http://mirrors.cloudforest.co.th/debian/
debian http://ftp.linux.org.tr/debian/
debian http://debian.netforce.hosting/debian/
debian http://debian.volia.net/debian/
debian http://distrohub.kyiv.ua/debian/
debian http://mirror.mirohost.net/debian/
debian http://mirror.ukrnames.com/debian/
debian http://debian.mirrors.uk2.net/debian/
debian http://debian.mirror.uk.sargasso.net/debian/
debian http://free.hands.com/debian/
debian http://ftp.ticklers.org/debian/
debian http://mirror.cov.ukservers.com/debian/
debian http://mirror.lchost.net/debian/
debian http://mirror.mythic-beasts.com/debian/
debian http://mirror.ox.ac.uk/debian/
debian http://mirror.positive-internet.com/debian/
debian http://mirrors.coreix.net/debian/
debian http://mirrorservice.org/sites/ftp.debian.org/debian/
debian http://mirror.vinehost.net/debian/
debian http://uk.mirrors.clouvider.net/debian/
debian http://atl.mirrors.clouvider.net/debian/
debian http://debian-archive.trafficmanager.net/debian/
debian http://debian.cc.lehigh.edu/debian/
debian http://debian.csail.mit.edu/debian/
debian http://debian.cs.binghamton.edu/debian/
debian http://debian.mirror.constant.com/debian/
debian http://debian.osuosl.org/debian/
debian http://debian.uchicago.edu/debian/
debian http://la.mirrors.clouvider.net/debian/
debian http://lethe.chinstrap.org/debian/
debian http://mirror.0x626b.com/debian/
debian http://mirror.cogentco.com/debian/
debian http://mirror.dal.nexril.net/debian/
debian http://mirror.keystealth.org/debian/
debian http://mirror.rustytel.net/debian/
debian http://mirrors.accretive-networks.net/debian/
debian http://mirrors.bloomu.edu/debian/
debian http://mirrors.bmcc.edu/debian/
debian http://mirrors.iu13.net/debian/
debian http://mirrors.lug.mtu.edu/debian/
debian http://mirrors.mwcampbell.us/debian/
debian http://mirrors.namecheap.com/debian/
debian http://mirrors.ocf.berkeley.edu/debian/
debian http://mirror.steadfast.net/debian/
debian http://mirrors.vcea.wsu.edu/debian/
debian http://mirrors.wikimedia.org/debian/
debian http://mirrors.xtom.com/debian/
debian http://mirror.timkevin.us/debian/
debian http://mirror.us.leaseweb.net/debian/
debian http://mirror.us.mirhosting.net/debian/
debian http://mirror.us.oneandone.net/debian/
debian http://nyc.mirrors.clouvider.net/debian/
debian http://plug-mirror.rcac.purdue.edu/debian/
debian http://repo.ialab.dsu.edu/debian/
debian http://us.mirror.ahrefs.org/debian/
debian http://debian.repo.cure.edu.uy/debian/
debian http://debian.xtdv.net/debian/
debian http://mirror.bizflycloud.vn/debian/
ubuntu http://mirror.sitsa.com.ar/ubuntu/
ubuntu http://ubuntu.zero.com.ar/ubuntu/
ubuntu http://ubuntu.unc.edu.ar/ubuntu/
ubuntu http://mirrors.asnet.am/ubuntu/
ubuntu http://ubuntu.mirror.gnc.am/ubuntu/
ubuntu http://mirrors.teamcloud.am/mirrors/ubuntu/
ubuntu http://mirror.aarnet.edu.au/pub/ubuntu/archive/
ubuntu http://mirror.internet.asn.au/pub/ubuntu/archive/
ubuntu http://mirror.datamossa.io/ubuntu/archive/
ubuntu http://mirror.realcompute.io/ubuntu/
ubuntu http://ubuntu.mirror.serversaustralia.com.au/ubuntu/
ubuntu http://ftp.iinet.net.au/pub/ubuntu/
ubuntu ftp://ftp.iinet.net.au/pub/ubuntu
ubuntu http://mirror.as24220.net/pub/ubuntu-archive/
ubuntu ftp://mirror.as24220.net/pub/ubuntu-archive/
ubuntu http://mirror.as24220.net/pub/ubuntu/
ubuntu ftp://mirror.as24220.net/pub/ubuntu/
ubuntu http://mirror.internode.on.net/pub/ubuntu/ubuntu/
ubuntu ftp://mirror.internode.on.net/pub/ubuntu/ubuntu/
ubuntu http://mirror.netspace.net.au/pub/ubuntu/
ubuntu ftp://mirror.netspace.net.au/pub/ubuntu/
ubuntu http://mirror.overthewire.com.au/ubuntu/
ubuntu ftp://mirror.overthewire.com.au/ubuntu/
ubuntu http://mirror.alwyzon.net/ubuntu/
ubuntu http://mirror.easyname.at/ubuntu-archive/
ubuntu ftp://mirror.easyname.at/ubuntu-archive/
ubuntu http://ubuntu.anexia.at/ubuntu/
ubuntu http://mirror.kumi.systems/ubuntu/
ubuntu ftp://mirror.kumi.systems/ubuntu/
ubuntu http://mirror.kumi.systems/ubuntu-ports/
ubuntu ftp://mirror.kumi.systems/ubuntu-ports/
ubuntu http://ubuntu.lagis.at/ubuntu/
ubuntu ftp://ubuntu.lagis.at/ubuntu/
ubuntu http://mirror.datacenter.az/ubuntu/
ubuntu http://mirror.ourhost.az/ubuntu/
ubuntu http://aze.archive.ubuntu.com/ubuntu/
ubuntu ftp://aze.archive.ubuntu.com/ubuntu/
ubuntu http://mirror.yer.az/ubuntu/archive/
ubuntu http://mirror.gotmyhost.com/ubuntu-archive/
ubuntu http://mirror.limda.net/ubuntu-archive/
ubuntu http://mirror.xeonbd.com/ubuntu-archive/
ubuntu http://ftp.byfly.by/ubuntu/
ubuntu ftp://ftp.byfly.by/ubuntu/
ubuntu http://mirror.datacenter.by/ubuntu/
ubuntu ftp://mirror.datacenter.by/ubuntu/
ubuntu http://ftp.belnet.be/ubuntu/
ubuntu ftp://ftp.belnet.be/ubuntu/
ubuntu http://mirror.unix-solutions.be/ubuntu/
ubuntu http://mirrors-ubuntu.behostings.com/ubuntu/
ubuntu http://archive.ubuntu.mirror.ba/ubuntu/
ubuntu http://ubuntu-mirror.bhtelecom.ba/ubuntu/
ubuntu http://mirror.uepg.br/ubuntu/
ubuntu http://ubuntu.c3sl.ufpr.br/ubuntu/
ubuntu ftp://ubuntu.c3sl.ufpr.br/ubuntu/
ubuntu http://ubuntu.mirror.letscloud.io/
ubuntu http://mirror.ufam.edu.br/ubuntu/
ubuntu http://mirror.ufscar.br/ubuntu/
ubuntu http://mirror.unesp.br/ubuntu/
ubuntu http://sft.if.usp.br/ubuntu/
ubuntu ftp://sft.if.usp.br/ubuntu/
ubuntu http://ubuntu-archive.locaweb.com.br/ubuntu/
ubuntu http://ubuntu.letscloud.io/ubuntu/
ubuntu http://ubuntu.mti.mt.gov.br/
ubuntu http://mirror.telepoint.bg/ubuntu/
ubuntu ftp://mirror.telepoint.bg/ubuntu/
ubuntu http://mirrors.neterra.net/ubuntu/archive/
ubuntu ftp://mirrors.neterra.net/ubuntu/archive/
ubuntu http://mirrors.netix.net/ubuntu/archive/
ubuntu ftp://mirrors.netix.net/ubuntu/archive/
ubuntu http://ubuntu.ipacct.com/ubuntu/
ubuntu ftp://ubuntu.ipacct.com/ubuntu/
ubuntu http://mirrors.storpool.com/ubuntu/archive/
ubuntu http://ubuntu.linux-bg.org/ubuntu/
ubuntu ftp://ubuntu.linux-bg.org/ubuntu/
ubuntu http://mirror.bg.host.ag/ubuntu/
ubuntu ftp://mirror.bg.host.ag/ubuntu/
ubuntu http://mirror.sabay.com.kh/ubuntu/
ubuntu http://mirrors.layeronline.com/ubuntu/
ubuntu http://ubuntu.linux.n0c.ca/ubuntuarchive/
ubuntu http://mirror.csclub.uwaterloo.ca/ubuntu/
ubuntu ftp://mirror.csclub.uwaterloo.ca/ubuntu/
ubuntu http://mirror.it.ubc.ca/ubuntu/
ubuntu http://mirror.reenigne.net/ubuntu/
ubuntu http://muug.ca/mirror/ubuntu/
ubuntu ftp://ftp.muug.ca/mirror/ubuntu/
ubuntu http://mirror.0xem.ma/ubuntu/
ubuntu http://mirror.hep.gg/ubuntu/
ubuntu http://archive.ubuntu.mirror.rafal.ca/ubuntu/
ubuntu ftp://archive.ubuntu.mirror.rafal.ca/ubuntu/
ubuntu http://gpl.savoirfairelinux.net/pub/mirrors/ubuntu/
ubuntu http://mirror.ca-tr.kamatera.com/ubuntu/
ubuntu http://mirror.rcg.sfu.ca/mirror/ubuntu/
ubuntu http://ubuntu.mirror.globo.tech/
ubuntu ftp://ubuntu.mirror.globo.tech/
ubuntu http://mirror.its.dal.ca/ubuntu/
ubuntu ftp://mirror.its.dal.ca/ubuntu/
ubuntu http://ubuntu.mirror.rafal.ca/ubuntu/
ubuntu http://mirror.hnd.cl/ubuntu/
ubuntu http://ubuntu-mirror.puq.apoapsis.cl/ubuntu/
ubuntu http://mirror.uchile.cl/ubuntu/
ubuntu http://elmirror.cl/ubuntu/
ubuntu http://mirror.ufro.cl/ubuntu/
ubuntu http://mirror1.grupocg.cl/ubuntu/
ubuntu http://mirrors.tuna.tsinghua.edu.cn/ubuntu/
ubuntu http://mirrors.tuna.tsinghua.edu.cn/ubuntu-ports/
ubuntu http://mirror.nju.edu.cn/ubuntu/
ubuntu http://mirror.nyist.edu.cn/ubuntu/
ubuntu http://mirror.nyist.edu.cn/ubuntu-ports/
ubuntu http://mirrors.ustc.edu.cn/ubuntu/
ubuntu http://mirrors.sdu.edu.cn/ubuntu/
ubuntu http://repo.huaweicloud.com/ubuntu/
ubuntu http://ftp.sjtu.edu.cn/ubuntu/
ubuntu ftp://ftp.sjtu.edu.cn/ubuntu/
ubuntu http://mirror.bjtu.edu.cn/ubuntu/
ubuntu http://mirrors.cn99.com/ubuntu/
ubuntu http://mirrors.huaweicloud.com/repository/ubuntu/
ubuntu http://mirrors.hust.edu.cn/ubuntu/
ubuntu http://mirrors.jcut.edu.cn/ubuntu/
ubuntu http://mirrors.jlu.edu.cn/ubuntu/
ubuntu http://mirrors.jxust.edu.cn/ubuntu/
ubuntu http://mirrors.njupt.edu.cn/ubuntu/
ubuntu http://mirrors.sjtug.sjtu.edu.cn/ubuntu/
ubuntu http://mirrors.sohu.com/ubuntu/
ubuntu ftp://mirrors.sohu.com/ubuntu/
ubuntu http://mirrors.xjtu.edu.cn/ubuntu/
ubuntu http://mirrors.yun-idc.com/ubuntu/
ubuntu ftp://mirrors.yun-idc.com/ubuntu/
ubuntu http://mirrors.zju.edu.cn/ubuntu/
ubuntu http://mirrors.cqu.edu.cn/ubuntu/
ubuntu http://edgeuno-bog2.mm.fcix.net/ubuntu/
ubuntu http://mirror.unimagdalena.edu.co/ubuntu/
ubuntu http://mirrors.atlas.net.co/ubuntu/
ubuntu http://mirrors.united.cd/ubuntu/
ubuntu http://ubuntu.ucr.ac.cr/ubuntu/
ubuntu ftp://ubuntu.ucr.ac.cr/ubuntu/
ubuntu http://ubuntu.grad.hr/ubuntu/
ubuntu ftp://ubuntu.grad.hr/ubuntu/
ubuntu http://mirror.library.ucy.ac.cy/linux/ubuntu/archive/
ubuntu http://cz.archive.ubuntu.com/ubuntu/
ubuntu http://ftp.linux.cz/pub/linux/ubuntu/
ubuntu ftp://ftp.linux.cz/pub/linux/ubuntu/
ubuntu http://ftp.sh.cvut.cz/ubuntu/
ubuntu ftp://ftp.sh.cvut.cz/ubuntu/
ubuntu http://mirror.it4i.cz/ubuntu/
ubuntu http://ftp.cvut.cz/ubuntu/
ubuntu ftp://ftp.cvut.cz/ubuntu/
ubuntu http://ucho.ignum.cz/ubuntu/
ubuntu ftp://ucho.ignum.cz/ubuntu/
ubuntu http://mirrors.dotsrc.org/ubuntu/
ubuntu ftp://mirrors.dotsrc.org/ubuntu/
ubuntu http://mirrors.fibianet.dk/ubuntu/
ubuntu http://mirror.group.one/ubuntu/
ubuntu http://mirror.one.com/ubuntu/
ubuntu ftp://mirror.one.com/ubuntu/
ubuntu http://ftp.klid.dk/ftp/ubuntu/
ubuntu ftp://ftp.klid.dk/ubuntu/
ubuntu http://mirror.cedia.org.ec/ubuntu/
ubuntu ftp://mirror.cedia.org.ec/ubuntu/
ubuntu http://mirrors.xtom.ee/ubuntu/
ubuntu http://mirror.5i.fi/ubuntu/
ubuntu http://ubuntu.web.trex.fi/ubuntu/
ubuntu ftp://mirror.clientvps.com/ubuntu/
ubuntu http://mirror.fi.ossplanet.net/ubuntu/
ubuntu http://mirror.ubuntu.ikoula.com/
ubuntu http://ubuntu.lafibre.info/ubuntu/
ubuntu http://ubuntu.univ-reims.fr/ubuntu/
ubuntu ftp://ubuntu.univ-reims.fr/ubuntu/
ubuntu http://ubuntu.mirrors.ovh.net/ubuntu/
ubuntu http://mirror.plusserver.com/ubuntu/ubuntu/
ubuntu http://miroir.univ-lorraine.fr/ubuntu/
ubuntu http://mirror.its-tps.fr/ubuntu/
ubuntu http://mirror.johnnybegood.fr/ubuntu/
ubuntu http://mirrors.ircam.fr/pub/ubuntu/archive/
ubuntu ftp://mirrors.ircam.fr/pub/ubuntu/archive/
ubuntu http://ubuntu.syxpi.fr/ubuntu/
ubuntu http://ubuntu.univ-nantes.fr/ubuntu/
ubuntu ftp://ubuntu.univ-nantes.fr/ubuntu/
ubuntu http://ftp.u-picardie.fr/mirror/ubuntu/ubuntu/
ubuntu http://distrib-coffee.ipsl.jussieu.fr/pub/linux/ubuntu/
ubuntu ftp://distrib-coffee.ipsl.jussieu.fr/pub/linux/ubuntu/
ubuntu http://ubuntu.grena.ge/ubuntu/
ubuntu http://ftp.uni-stuttgart.de/ubuntu/
ubuntu http://ftp.halifax.rwth-aachen.de/ubuntu/
ubuntu ftp://ftp.halifax.rwth-aachen.de/ubuntu/
ubuntu http://mirror.dogado.de/ubuntu/
ubuntu http://mirror.netcologne.de/ubuntu/
ubuntu ftp://mirror.netcologne.de/ubuntu/
ubuntu http://ubuntu.mirror.lrz.de/ubuntu/
ubuntu http://de.mirrors.clouvider.net/ubuntu/
ubuntu http://debian.charite.de/ubuntu/
ubuntu http://ftp.stw-bonn.de/ubuntu/
ubuntu ftp://ftp.stw-bonn.de/ubuntu/
ubuntu http://mirror.creoline.net/ubuntu/
ubuntu http://mirror.de.leaseweb.net/ubuntu/
ubuntu ftp://mirror.de.leaseweb.net/ubuntu/
ubuntu http://mirror.ipb.de/ubuntu/
ubuntu http://mirror.wtnet.de/ubuntu/
ubuntu http://mirrors.xtom.de/ubuntu/
ubuntu http://ubuntu.mirror.tudos.de/ubuntu/
ubuntu http://ftp.fau.de/ubuntu/
ubuntu ftp://ftp.fau.de/ubuntu/
ubuntu http://drmirror.physi.uni-heidelberg.de/ubuntu/
ubuntu http://ftp-stud.hs-esslingen.de/ubuntu/
ubuntu ftp://ftp-stud.hs-esslingen.de/ubuntu/
ubuntu http://mirror.netzwerge.de/ubuntu/
ubuntu http://mirror.serverloft.eu/ubuntu/ubuntu/
ubuntu http://artfiles.org/ubuntu.com/
ubuntu ftp://artfiles.org/ubuntu.com/
ubuntu ftp://ftp.fu-berlin.de/linux/ubuntu/
ubuntu http://ftp.rz.tu-bs.de/pub/mirror/ubuntu-packages/
ubuntu ftp://ftp.rz.tu-bs.de/pub/mirror/ubuntu-packages/
ubuntu http://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/
ubuntu ftp://ftp.tu-chemnitz.de/pub/linux/ubuntu-ports/
ubuntu http://ftp.tu-ilmenau.de/mirror/ubuntu/
ubuntu ftp://ftp.tu-ilmenau.de/mirror/ubuntu/
ubuntu http://ftp.uni-bayreuth.de/linux/ubuntu/ubuntu/
ubuntu ftp://ftp.uni-bayreuth.de/pub/linux/ubuntu/ubuntu/
ubuntu http://ftp.uni-mainz.de/ubuntu/
ubuntu ftp://ftp.uni-mainz.de/ubuntu/
ubuntu http://ftp5.gwdg.de/pub/linux/debian/ubuntu/
ubuntu ftp://ftp5.gwdg.de/pub/linux/debian/ubuntu/
ubuntu http://mirror.23m.com/ubuntu/
ubuntu http://mirror.daniel-jost.net/ubuntu/
ubuntu ftp://mirror.daniel-jost.net/ubuntu/
ubuntu http://mirror.eu-fr.kamatera.com/ubuntu/
ubuntu http://mirror.informatik.tu-freiberg.de/ubuntu/
ubuntu http://mirror.kamp.de/ubuntu/
ubuntu http://mirror.kkg.berlin/ubuntu/
ubuntu http://mirror.liquidrp.de/ubuntu/
ubuntu http://mirror.scaleuptech.com/ubuntu/
ubuntu ftp://mirror.scaleuptech.com/ubuntu/
ubuntu http://mirror.thunderhosting.cloud/ubuntu/
ubuntu http://mirror.united-gameserver.de/ubuntu/
ubuntu http://packages.oth-regensburg.de/ubuntu/
ubuntu http://suse.uni-leipzig.de/pub/releases.ubuntu.com/ubuntu/
ubuntu ftp://suse.uni-leipzig.de/pub/releases.ubuntu.com/ubuntu/
ubuntu http://ftp.hosteurope.de/mirror/archive.ubuntu.com/
ubuntu ftp://ftp.hosteurope.de/mirror/archive.ubuntu.com/
ubuntu http://ftp.tu-chemnitz.de/pub/linux/ubuntu/
ubuntu http://ftp.cc.uoc.gr/mirrors/linux/ubuntu/packages/
ubuntu ftp://ftp.cc.uoc.gr/mirrors/linux/ubuntu/packages/
ubuntu http://ftp.ntua.gr/ubuntu/
ubuntu ftp://ftp.ntua.gr/ubuntu/
ubuntu http://ubuntu.otenet.gr/
ubuntu ftp://ftp.otenet.gr/ubuntu/
ubuntu http://mirror.greennet.gl/ubuntu/
ubuntu http://hk.mirrors.thegigabit.com/ubuntu/
ubuntu http://mirror-hk.koddos.net/ubuntu/
ubuntu http://mirror.01link.hk/ubuntu/
ubuntu http://mirror.as.kamatera.com/ubuntu/
ubuntu http://repo.jztkft.hu/ubuntu/
ubuntu http://mirror.niif.hu/ubuntu/
ubuntu http://quantum-mirror.hu/mirrors/pub/ubuntu/
ubuntu http://mirrors.sth.sze.hu/ubuntu/
ubuntu http://ubuntu.hysing.is/ubuntu/
ubuntu http://is.mirror.flokinet.net/ubuntu/
ubuntu http://mirrors.opensource.is/ubuntu/
ubuntu http://repos.del.extreme-ix.org/ubuntu/
ubuntu http://in.mirror.coganng.com/ubuntu/
ubuntu ftp://in.mirror.coganng.com/ubuntu/
ubuntu http://in.mirror.coganng.com/ubuntu-ports/
ubuntu ftp://in.mirror.coganng.com/ubuntu-ports/
ubuntu http://mirror.bharatdatacenter.com/ubuntu/
ubuntu ftp://mirror.bharatdatacenter.com/ubuntu/
ubuntu http://mirror.cse.iitk.ac.in/ubuntu/
ubuntu ftp://mirror.cse.iitk.ac.in/ubuntu/
ubuntu http://mirror.ietlucknow.ac.in/ubuntu/
ubuntu http://mirror.nitc.ac.in/ubuntu/
ubuntu http://mirrors.nxtgen.com/ubuntu-mirror/ubuntu/
ubuntu http://repo.extreme-ix.org/ubuntu/
ubuntu http://ftp.iitm.ac.in/ubuntu/
ubuntu ftp://ftp.iitm.ac.in/ubuntu
ubuntu http://cdn.repo.cloudeka.id/ubuntu/
ubuntu http://cdn.ubuntu.repo.cloudeka.id/ubuntu/
ubuntu http://linux.domainesia.com/ubuntu/ubuntu-archive/
ubuntu http://mirror.faizuladib.com/ubuntu/
ubuntu http://mirror.repository.id/ubuntu/
ubuntu http://mr.heru.id/ubuntu/
ubuntu http://mirror.deace.id/ubuntu/
ubuntu http://mirror-gw.elastis.id/ubuntu/
ubuntu http://mirror.biznetgio.com/ubuntu/
ubuntu http://mirror.cepatcloud.id/ubuntu/
ubuntu http://mirror.citrahost.com/ubuntu/
ubuntu http://mirror.dewabiz.com/ubuntu/
ubuntu http://mirror.gi.co.id/ubuntu/
ubuntu http://mirror.papua.go.id/ubuntu/
ubuntu http://mirror.poliwangi.ac.id/ubuntu/
ubuntu http://mirror.unair.ac.id/ubuntu/
ubuntu http://repo.ugm.ac.id/ubuntu/
ubuntu http://repo.usk.ac.id/ubuntu/
ubuntu http://suro.ubaya.ac.id/ubuntu/
ubuntu ftp://suro.ubaya.ac.id/mirror/ubuntu/
ubuntu http://archive.ubuntu.mirrors.zagrio.net/
ubuntu ftp://mirrors.zagrio.net/ubuntu/archive/
ubuntu http://mirror.iranserver.com/ubuntu/
ubuntu http://ir.archive.ubuntu.com/ubuntu/
ubuntu ftp://ir.archive.ubuntu.com/ubuntu/
ubuntu http://ubuntu.mobinhost.com/ubuntu/
ubuntu ftp://ubuntu.mobinhost.com/ubuntu/
ubuntu http://ubuntu.pishgaman.net/ubuntu/
ubuntu http://mirror.aminidc.com/ubuntu/
ubuntu ftp://mirror.aminidc.com/ubuntu/
ubuntu http://mirrors.pardisco.co/ubuntu/
ubuntu http://archive.ubuntu.petiak.ir/ubuntu/
ubuntu ftp://archive.ubuntu.petiak.ir/ubuntu/
ubuntu http://ubuntu.pars.host/
ubuntu http://ubuntu.parsvds.com/ubuntu/
ubuntu http://mirror.faraso.org/ubuntu/
ubuntu http://mirrors.ubuntu.dimit.cloud/
ubuntu http://repo.iut.ac.ir/repo/Ubuntu/
ubuntu http://mirror.webworld.ie/ubuntu/
ubuntu http://mirror.il-ha.kamatera.com/ubuntu/
ubuntu http://ubuntu-archive.interhost.co.il/ubuntu/
ubuntu http://mirror.il-pt.kamatera.com/ubuntu/
ubuntu http://mirror.il-rh.kamatera.com/ubuntu/
ubuntu http://mirror.il-ta.kamatera.com/ubuntu/
ubuntu http://mirror.il.kamatera.com/ubuntu/
ubuntu http://rep-ubuntu-il.upress.io/ubuntu/
ubuntu http://mirror.isoc.org.il/pub/ubuntu/
ubuntu ftp://mirror.isoc.org.il/ubuntu/
ubuntu http://it1.mirror.vhosting-it.com/ubuntu/
ubuntu http://it2.mirror.vhosting-it.com/ubuntu/
ubuntu http://giano.com.dist.unige.it/ubuntu/
ubuntu http://ftp.udx.icscoe.jp/Linux/ubuntu/
ubuntu http://mirror.hashy0917.net/ubuntu/
ubuntu http://mirror.hashy0917.net/ubuntu-ports/
ubuntu http://archive.g4t1.pro/ubuntu/
ubuntu http://ftp.tsukuba.wide.ad.jp/Linux/ubuntu/
ubuntu http://linux.yz.yamagata-u.ac.jp/ubuntu/
ubuntu http://mirror.nishi.network/ubuntu/
ubuntu http://mirror.nishi.network/ubuntu-ports/
ubuntu http://repo.jing.rocks/ubuntu/
ubuntu http://repo.jing.rocks/ubuntu-ports/
ubuntu http://ftp.jaist.ac.jp/pub/Linux/ubuntu/
ubuntu ftp://ftp.jaist.ac.jp/pub/Linux/ubuntu/
ubuntu http://ftp.riken.jp/Linux/ubuntu/
ubuntu ftp://ftp.riken.jp/Linux/ubuntu/
ubuntu http://ubuntutym.u-toyama.ac.jp/ubuntu/
ubuntu http://ftp.sakura.ad.jp/ubuntu/
ubuntu http://jp.mirror.coganng.com/ubuntu/
ubuntu ftp://jp.mirror.coganng.com/ubuntu/
ubuntu http://jp.mirror.coganng.com/ubuntu-ports/
ubuntu ftp://jp.mirror.coganng.com/ubuntu-ports/
ubuntu http://mirror.hoster.kz/ubuntu/
ubuntu ftp://mirror.hoster.kz/ubuntu/
ubuntu http://mirror.ps.kz/ubuntu/
ubuntu ftp://mirror.ps.kz/ubuntu/
ubuntu http://mirror.amuksa.com/ubuntu/
ubuntu http://mirror.kakao.com/ubuntu/
ubuntu http://mirror.krfoss.org/ubuntu/
ubuntu http://mirror.siwoo.org/ubuntu/
ubuntu http://ftp.daum.net/ubuntu/
ubuntu ftp://ftp.daum.net/ubuntu/
ubuntu http://ftp.lanet.kr/ubuntu/
ubuntu ftp://ftp.lanet.kr/ubuntu/
ubuntu http://ftp.lanet.kr/ubuntu-ports/
ubuntu ftp://ftp.lanet.kr/ubuntu-ports/
ubuntu http://mirror.jeonnam.school/ubuntu/
ubuntu http://mirror.zzunipark.com/ubuntu/
ubuntu http://mirror.zzunipark.com/ubuntu-ports/
ubuntu http://mirror.yuki.net.uk/ubuntu-ports/
ubuntu http://mir.linux.kg/ubuntu/
ubuntu http://mirror.cloudhosting.lv/ubuntu/
ubuntu http://ubuntu-arch.linux.edu.lv/ubuntu/
ubuntu ftp://ubuntu-arch.linux.edu.lv/lv.archive.ubuntu.com/ubuntu/
ubuntu http://ubuntu.koyanet.lv/ubuntu/
ubuntu http://mirror.bacloud.com/ubuntu-mirror/archive/
ubuntu http://mirror.vpsnet.com/ubuntu/
ubuntu http://ubuntu.mirror.vu.lt/ubuntu/
ubuntu ftp://ubuntu.mirror.vu.lt/ubuntu/
ubuntu http://ftp.litnet.lt/ubuntu/
ubuntu ftp://ftp.litnet.lt/ubuntu/
ubuntu http://ubuntu.mirror.root.lu/ubuntu/
ubuntu ftp://mirror.root.lu/ubuntu/ubuntu/
ubuntu http://mirror.a1.mk/ubuntu/
ubuntu http://mirror.t-home.mk/ubuntu/
ubuntu http://ubuntu.dts.mg/ubuntu/
ubuntu http://mirrors.gbnetwork.com/ubuntu/
ubuntu http://mirrors.ipserverone.com/ubuntu/
ubuntu http://ubuntu.mirror.thegigabit.com/
ubuntu http://ubuntu.tuxuri.com/ubuntu/
ubuntu http://ubuntu-mirror.cloud.mu/ubuntu/
ubuntu http://ubuntu-mirror.cloud.mu/ubuntu-ports/
ubuntu http://mirror.as43289.net/ubuntu/
ubuntu ftp://mirror.as43289.net/ubuntu/
ubuntu http://mirror.ihost.md/ubuntu/
ubuntu http://mirrors.mivocloud.com/ubuntu/
ubuntu ftp://mirrors.mivocloud.com/ubuntu/
ubuntu http://mirror.hosthink.net/ubuntu/
ubuntu http://mirror.datacenter.mn/ubuntu/
ubuntu http://mirror.marwan.ma/ubuntu/
ubuntu http://mirrors.ygn.mmix.net.mm/ubuntu/
ubuntu http://download.nust.na/pub/ubuntu/ubuntu/
ubuntu http://ubuntu.ntc.net.np/ubuntu/
ubuntu http://mirror.ams.macarne.com/ubuntu/
ubuntu http://mirror.i3d.net/pub/ubuntu/
ubuntu http://mirror.nl.datapacket.com/ubuntu/
ubuntu http://nl.archive.ubuntu.com/ubuntu/
ubuntu http://ftp.nluug.nl/os/Linux/distr/ubuntu/
ubuntu ftp://ftp.nluug.nl/pub/os/Linux/distr/ubuntu/
ubuntu http://ftp.snt.utwente.nl/pub/os/linux/ubuntu/
ubuntu ftp://ftp.snt.utwente.nl/pub/os/linux/ubuntu/
ubuntu http://mirror.lyrahosting.com/ubuntuarchive/
ubuntu ftp://mirror.lyrahosting.com/ubuntuarchive/
ubuntu http://mirror.nforce.com/pub/linux/ubuntu/
ubuntu ftp://mirror.nforce.com/pub/linux/ubuntu/
ubuntu http://mirror.nl.altushost.com/ubuntu/
ubuntu http://mirror.nl.leaseweb.net/ubuntu/
ubuntu ftp://mirror.nl.leaseweb.net/ubuntu/
ubuntu http://mirror.serverion.com/ubuntu/
ubuntu ftp://mirror.serverion.com/ubuntu/
ubuntu http://mirror.vpgrp.io/ubuntu/
ubuntu http://mirrors.xtom.nl/ubuntu/
ubuntu http://nl.mirrors.clouvider.net/ubuntu/
ubuntu http://ubuntu.mirror.intermax.nl/
ubuntu http://ubuntu.mirror.true.nl/ubuntu/
ubuntu http://ubuntu.mirror.wearetriple.com/archive/
ubuntu http://mirror.transip.net/ubuntu/ubuntu/
ubuntu ftp://mirror.transip.net/ubuntu/ubuntu/
ubuntu http://mirrors.as215248.net/ubuntu/
ubuntu http://nl3.archive.ubuntu.com/ubuntu/
ubuntu http://ftp.tudelft.nl/archive.ubuntu.com/
ubuntu ftp://ftp.tudelft.nl/pub/Linux/archive.ubuntu.com/
ubuntu http://mirror.eu.kamatera.com/ubuntu/
ubuntu http://mirror.hostnet.nl/ubuntu/archive/
ubuntu http://mirror.nl.as215296.net/ubuntu/
ubuntu http://mirror.previder.nl/ubuntu/
ubuntu http://mirrors.evoluso.com/ubuntu/
ubuntu http://nl.mirror.flokinet.net/ubuntu/
ubuntu http://osmirror.rug.nl/ubuntu/
ubuntu ftp://osmirror.rug.nl/ubuntu/
ubuntu ftp://ftpserv.tudelft.nl/pub/Linux/archive.ubuntu.com/
ubuntu http://ubuntu.lagoon.nc/ubuntu/
ubuntu ftp://ubuntu.lagoon.nc/ubuntu/
ubuntu http://archive.ubuntu.nautile.nc/ubuntu/
ubuntu http://mirror.fsmg.org.nz/ubuntu/
ubuntu http://ubuntu.btit.nz/ubuntu/
ubuntu ftp://ubuntu.btit.nz/ubuntu/
ubuntu http://no.mirrors.blix.com/ubuntu/
ubuntu http://no.archive.ubuntu.com/ubuntu/
ubuntu http://ubuntu.hi.no/archive/
ubuntu http://ftp.uninett.no/ubuntu/
ubuntu ftp://ftp.uninett.no/ubuntu/
ubuntu http://ubuntu.uib.no/archive/
ubuntu ftp://ubuntu.uib.no/pub/Linux/Distributions/ubuntu/archive/
ubuntu http://mirror.virtury.com/ubuntu/
ubuntu http://mirror.rise.ph/ubuntu/
ubuntu ftp://mirror.rise.ph/ubuntu/
ubuntu http://ftp.icm.edu.pl/pub/Linux/ubuntu/
ubuntu ftp://ftp.icm.edu.pl/pub/Linux/ubuntu/
ubuntu http://ftp.psnc.pl/linux/ubuntu/
ubuntu http://ubuntu.task.gda.pl/ubuntu/
ubuntu ftp://ubuntu.task.gda.pl/ubuntu/
ubuntu http://ftp.agh.edu.pl/ubuntu/
ubuntu ftp://ftp.agh.edu.pl/ubuntu/
ubuntu http://mirror.chmuri.net/ubuntu/
ubuntu http://ubuntu.man.lodz.pl/ubuntu/
ubuntu ftp://ubuntu.man.lodz.pl/ubuntu/
ubuntu http://mirror.leitecastro.com/ubuntu/
ubuntu http://mirrors.ptisp.pt/ubuntu/
ubuntu http://mirrors.up.pt/ubuntu/
ubuntu ftp://mirrors.up.pt/pub/ubuntu/
ubuntu http://cesium.di.uminho.pt/pub/ubuntu-archive/
ubuntu ftp://cesium.di.uminho.pt/pub/ubuntu-archive/
ubuntu http://archive.ubuntumirror.dei.uc.pt/ubuntu/
ubuntu ftp://archive.ubuntumirror.dei.uc.pt/ubuntu/
ubuntu http://ftp.rnl.tecnico.ulisboa.pt/pub/ubuntu/archive/
ubuntu ftp://ftp.rnl.tecnico.ulisboa.pt/pub/ubuntu/archive/
ubuntu http://glua.ua.pt/pub/ubuntu/
ubuntu ftp://glua.ua.pt/pub/ubuntu/
ubuntu http://mirrors.webhs.pt/ubuntu/
ubuntu http://mirrors.hosterion.ro/ubuntu/
ubuntu http://mirror.efect.ro/ubuntu/archive/
ubuntu http://mirrors.nav.ro/ubuntu/
ubuntu ftp://mirrors.nav.ro/ubuntu/
ubuntu http://mirror.flo.c-f.ro/ubuntu/
ubuntu http://mirror.flokinet.net/ubuntu/
ubuntu http://mirrors.chroot.ro/ubuntu/
ubuntu ftp://mirrors.chroot.ro/ubuntu/
ubuntu http://mirrors.hostico.ro/ubuntu/archive/
ubuntu http://mirrors.pidginhost.com/ubuntu/
ubuntu ftp://mirrors.pidginhost.com/ubuntu/
ubuntu http://ubuntu.mirrors.linux.ro/archive/
ubuntu ftp://ftp.linux.ro/ubuntu/archive/
ubuntu http://mirror.linux-ia64.org/ubuntu/
ubuntu http://mirror.neftm.ru/ubuntu/
ubuntu http://mirror.timeweb.ru/ubuntu/
ubuntu http://mirror.truenetwork.ru/ubuntu/
ubuntu ftp://mirror.truenetwork.ru/ubuntu/
ubuntu http://mirror.docker.ru/ubuntu/
ubuntu http://mirror.corbina.net/ubuntu/
ubuntu ftp://mirror.corbina.net/ubuntu/
ubuntu http://mirror.hyperdedic.ru/ubuntu/
ubuntu http://mirror.yandex.ru/ubuntu/
ubuntu ftp://mirror.yandex.ru/ubuntu/
ubuntu http://mirrors.powernet.com.ru/ubuntu/
ubuntu ftp://mirrors.powernet.com.ru/pub/ubuntu/archive/
ubuntu http://mirror.logol.ru/ubuntu/
ubuntu ftp://mirror.logol.ru/ubuntu/
ubuntu http://mirror.maeen.sa/apt-mirror/
ubuntu http://mirror1.sox.rs/ubuntu/ubuntu/
ubuntu http://ossmirror.mycloud.services/os/linux/ubuntu/
ubuntu http://mirror.sg.gs/ubuntu/
ubuntu http://kambing.uu.sg/ubuntu/
ubuntu http://mirror.0x.sg/ubuntu/
ubuntu ftp://mirror.0x.sg/ubuntu/
ubuntu http://mirror.soonkeat.sg/ubuntu/
ubuntu http://mirror.aktkn.sg/ubuntu/
ubuntu http://mirror.coganng.com/ubuntu/
ubuntu ftp://mirror.coganng.com/ubuntu/
ubuntu http://mirror.coganng.com/ubuntu-ports/
ubuntu ftp://mirror.coganng.com/ubuntu-ports/
ubuntu http://sg-mirrors.vhost.vn/ubuntu/
ubuntu http://mirror.vnet.sk/ubuntu/
ubuntu http://ftp.energotel.sk/pub/linux/ubuntu/
ubuntu ftp://ftp.energotel.sk/pub/linux/ubuntu/
ubuntu http://tux.rainside.sk/ubuntu/
ubuntu ftp://tux.rainside.sk/ubuntu/
ubuntu http://ftp.arnes.si/pub/mirrors/ubuntu/
ubuntu ftp://ftp.arnes.si/mirrors/ubuntu/
ubuntu http://ubuntu.mirror.ac.za/ubuntu/
ubuntu ftp://ubuntu.mirror.ac.za/ubuntu/
ubuntu http://mirror.hostafrica.co.za/ubuntu/
ubuntu http://ubuntu.mirror.rain.co.za/ubuntu/
ubuntu http://mirror.raiolanetworks.com/ubuntu/
ubuntu http://ftp.udc.es/ubuntu/
ubuntu ftp://ftp.udc.es/ubuntu/
ubuntu http://ubuntu.cica.es/ubuntu/
ubuntu ftp://ubuntu.cica.es/ubuntu/
ubuntu http://ftp.caliu.cat/pub/distribucions/ubuntu/archive/
ubuntu http://ftp.csuc.cat/ubuntu/archive/
ubuntu ftp://ftp.csuc.cat/ubuntu/archive/
ubuntu http://ubuntu.uvigo.es/
ubuntu ftp://ftp.uvigo.es/ubuntu/
ubuntu http://dafi.inf.um.es/ubuntu/
ubuntu ftp://dafi.inf.um.es/ubuntu/
ubuntu http://ubuntu.grn.cat/ubuntu/
ubuntu ftp://ubuntu.grn.cat/ubuntu/
ubuntu http://ftp.acc.umu.se/ubuntu/
ubuntu ftp://ftp.acc.umu.se/ubuntu/
ubuntu http://ftp.ludd.ltu.se/mirrors/ubuntu/
ubuntu http://mirror.bahnhof.net/ubuntu/
ubuntu ftp://mirror.bahnhof.net/ubuntu/
ubuntu http://mirror.zetup.net/ubuntu/
ubuntu http://ftp.lysator.liu.se/ubuntu/
ubuntu ftp://ftp.lysator.liu.se/ubuntu/
ubuntu http://ftpmirror1.infania.net/ubuntu/
ubuntu ftp://ftpmirror1.infania.net/ubuntu/
ubuntu http://mirror.siati.ch/ubuntu-archive/
ubuntu http://mirror.infomaniak.ch/ubuntu/
ubuntu ftp://mirror.infomaniak.ch/ubuntu/
ubuntu http://mirror.init7.net/ubuntu/
ubuntu http://mirror.solnet.ch/ubuntu/
ubuntu http://pkg.adfinis-on-exoscale.ch/ubuntu/
ubuntu http://ubuntu.ethz.ch/ubuntu/
ubuntu ftp://ubuntu.ethz.ch/ubuntu/
ubuntu http://mirror.gofoss.xyz/ubuntu/
ubuntu http://mirror.gofoss.xyz/ubuntu-ports/
ubuntu http://pkg.adfinis.com/ubuntu/
ubuntu http://mirror.twds.com.tw/ubuntu/
ubuntu http://mirror.twds.com.tw/ubuntu-ports/
ubuntu http://free.nchc.org.tw/ubuntu/
ubuntu ftp://free.nchc.org.tw/ubuntu
ubuntu http://ftp.tw.debian.org/ubuntu/
ubuntu ftp://ftp.tw.debian.org/ubuntu/
ubuntu http://ubuntu.ccns.ncku.edu.tw/ubuntu/
ubuntu http://ftp.ubuntu-tw.net/ubuntu/
ubuntu ftp://ftp.ubuntu-tw.net/ubuntu/
ubuntu http://mirror.ossplanet.net/ubuntu/
ubuntu ftp://mirror.ossplanet.net/ubuntu/
ubuntu http://ftp.tku.edu.tw/ubuntu/
ubuntu ftp://ftp.tku.edu.tw/ubuntu/
ubuntu http://tw1.mirror.blendbyte.net/ubuntu/
ubuntu http://ubuntu.cs.nctu.edu.tw/ubuntu/
ubuntu ftp://ubuntu.cs.nctu.edu.tw/ubuntu/
ubuntu http://ftp.mirror.tw/pub/ubuntu/ubuntu/
ubuntu ftp://ftp.mirror.tw/pub/ubuntu/ubuntu/
ubuntu http://mirror.aptus.co.tz/pub/ubuntuarchive/
ubuntu http://deb-mirror.habari.co.tz/ubuntu/
ubuntu http://mirror.kku.ac.th/ubuntu/
ubuntu ftp://mirror.kku.ac.th/ubuntu/
ubuntu http://mirrors.cloudforest.co.th/ubuntu/
ubuntu http://mirror1.totbb.net/ubuntu/
ubuntu http://mirrors.bangmod.cloud/ubuntu/
ubuntu http://mirror1.ku.ac.th/ubuntu/
ubuntu http://mirror.ati.tn/ubuntu/
ubuntu http://mirror.ekiphost.com/ubuntu/
ubuntu http://mirror.sh.com.tr/ubuntu/
ubuntu http://mirror.domainhizmetleri.com/ubuntu/
ubuntu http://mirror.verinomi.com/ubuntu/ubuntu-archive/
ubuntu http://mirror.kapteyan.com.tr/ubuntu/
ubuntu http://mirror.rabisu.com/ubuntu/ubuntu-archive/
ubuntu http://mirror.renu.ac.ug/ubuntu/
ubuntu http://ubuntu.ip-connect.vn.ua/
ubuntu ftp://ubuntu.ip-connect.vn.ua/mirror/ubuntu/
ubuntu http://ubuntu.mirrors.omnilance.com/ubuntu/
ubuntu http://distrohub.kyiv.ua/ubuntu/
ubuntu http://mirror.mirohost.net/ubuntu/
ubuntu ftp://mirror.mirohost.net/ubuntu/
ubuntu http://ubuntu.netforce.hosting/ubuntu/
ubuntu ftp://ubuntu.netforce.hosting/ubuntu/
ubuntu http://ubuntu.org.ua/ubuntu/
ubuntu ftp://ubuntu.org.ua/ubuntu/
ubuntu http://mirror.cov.ukservers.com/ubuntu/
ubuntu ftp://mirror.cov.ukservers.com/ubuntu/
ubuntu http://mirror.katapult.io/ubuntu/
ubuntu http://mirror.server.net/ubuntu/
ubuntu http://mirror.vorboss.net/ubuntu-archive/
ubuntu http://mirrors.ukfast.co.uk/sites/archive.ubuntu.com/
ubuntu ftp://mirrors.ukfast.co.uk/archive.ubuntu.com/
ubuntu http://www.mirrorservice.org/sites/archive.ubuntu.com/ubuntu/
ubuntu ftp://ftp.mirrorservice.org/sites/archive.ubuntu.com/ubuntu/
ubuntu http://uk.mirrors.clouvider.net/ubuntu/
ubuntu http://archive.ubuntu.moon127.net/
ubuntu http://mirror.as29550.net/archive.ubuntu.com/
ubuntu ftp://mirror.as29550.net/archive.ubuntu.com/
ubuntu http://mirror.bytemark.co.uk/ubuntu/
ubuntu ftp://mirror.bytemark.co.uk/ubuntu/
ubuntu http://mirror.eu-lo.kamatera.com/ubuntu/
ubuntu http://mirror.freethought-internet.co.uk/ubuntu/
ubuntu ftp://mirror.freethought-internet.co.uk/ubuntu/
ubuntu http://mirror.ox.ac.uk/sites/archive.ubuntu.com/ubuntu/
ubuntu ftp://mirror.ox.ac.uk/sites/archive.ubuntu.com/ubuntu/
ubuntu http://mirror.vinehost.net/ubuntu/
ubuntu ftp://mirror.vinehost.net/ubuntu/
ubuntu http://mirrors.coreix.net/ubuntu/
ubuntu http://mirrors.gethosted.online/ubuntu/
ubuntu ftp://mirrors.gethosted.online/ubuntu/
ubuntu http://mirrors.melbourne.co.uk/ubuntu/
ubuntu ftp://mirrors.melbourne.co.uk/ubuntu/
ubuntu http://ports.ubuntu.moon127.net/
ubuntu http://ubuntu.mirrors.uk2.net/ubuntu/
ubuntu ftp://ubuntu.mirrors.uk2.net/ubuntu/
ubuntu http://archive.ubuntu.com/ubuntu/
ubuntu ftp://archive.ubuntu.com/ubuntu/
ubuntu http://mirror.enzu.com/ubuntu/
ubuntu ftp://mirror.enzu.com/ubuntu/
ubuntu http://mirror.pilotfiber.com/ubuntu/
ubuntu http://dal.mirrors.serverside.com/ubuntu/
ubuntu http://mirror.math.princeton.edu/pub/ubuntu/
ubuntu http://mirror.pit.teraswitch.com/ubuntu/
ubuntu http://mirror.us.mirhosting.net/ubuntu/
ubuntu ftp://mirror.us.mirhosting.net/ubuntu/
ubuntu http://mirrors.iu13.net/ubuntu/
ubuntu http://atl.mirrors.clouvider.net/ubuntu/
ubuntu http://dal.mirrors.clouvider.net/ubuntu/
ubuntu http://la.mirrors.clouvider.net/ubuntu/
ubuntu http://mirror.arizona.edu/ubuntu/
ubuntu http://mirror.brightridge.com/ubuntuarchive/
ubuntu http://mirror.hoobly.com/ubuntu/
ubuntu http://mirror.its.umich.edu/ubuntu/
ubuntu http://mirror.linux.ncsu.edu/ubuntu/
ubuntu http://mirror.lstn.net/ubuntu/
ubuntu http://mirror.nodesdirect.com/ubuntu/
ubuntu ftp://mirror.nodesdirect.com/ubuntu/
ubuntu http://mirror.servaxnet.com/ubuntu/
ubuntu http://mirror.timkevin.us/ubuntu/
ubuntu http://mirror.ubuntu.serverforge.org/
ubuntu http://mirror.umd.edu/ubuntu/
ubuntu http://mirror.us.leaseweb.net/ubuntu/
ubuntu ftp://mirror.us.leaseweb.net/ubuntu/
ubuntu http://mirrors.bloomu.edu/ubuntu/
ubuntu ftp://mirrors.bloomu.edu/ubuntu/
ubuntu http://mirrors.egr.msu.edu/ubuntu/
ubuntu http://mirrors.rit.edu/ubuntu/
ubuntu ftp://mirrors.rit.edu/ubuntu/
ubuntu http://mirrors.usinternet.com/ubuntu/archive/
ubuntu http://mirrors.xtom.com/ubuntu/
ubuntu http://nyc.mirrors.clouvider.net/ubuntu/
ubuntu http://plug-mirror.rcac.purdue.edu/ubuntu/
ubuntu ftp://plug-mirror.rcac.purdue.edu/ubuntu/
ubuntu http://ubuntu.cs.utah.edu/ubuntu/
ubuntu ftp://ubuntu.cs.utah.edu/ubuntu/ubuntu/
ubuntu http://ubuntu.mirror.constant.com/
ubuntu http://ubuntu.mirror.shastacoe.net/ubuntu/
ubuntu http://mirrors.wikimedia.org/ubuntu/
ubuntu http://mirrors.gigenet.com/ubuntu/
ubuntu http://mirror.rustytel.net/ubuntu/
ubuntu http://mirror.siena.edu/ubuntu/
ubuntu http://mirrors.cmich.edu/ubuntu/
ubuntu http://mirrors.us.kernel.org/ubuntu/
ubuntu ftp://mirrors.us.kernel.org/ubuntu/
ubuntu http://repo.ialab.dsu.edu/ubuntu/
ubuntu http://ubuntu.osuosl.org/ubuntu/
ubuntu ftp://ubuntu.osuosl.org/pub/ubuntu/
ubuntu http://ftp.usf.edu/pub/ubuntu/
ubuntu ftp://ftp.usf.edu/pub/ubuntu/
ubuntu http://mirror.cc.vt.edu/pub2/ubuntu/
ubuntu ftp://mirror.cc.vt.edu/pub2/ubuntu/
ubuntu http://mirror.clarkson.edu/ubuntu/
ubuntu http://mirror.cogentco.com/pub/linux/ubuntu/
ubuntu http://mirror.cs.jmu.edu/pub/ubuntu/
ubuntu http://mirror.dal.nexril.net/ubuntu/
ubuntu http://mirror.math.ucdavis.edu/ubuntu/
ubuntu http://mirror.metrocast.net/ubuntu/
ubuntu http://mirror.mia.velocihost.net/ubuntu/
ubuntu http://mirror.mrjester.net/ubuntu/archive/
ubuntu http://mirror.nerdmilio.com/ubuntu/
ubuntu http://mirror.steadfastnet.com/ubuntu/
ubuntu http://mirror.team-cymru.com/ubuntu/
ubuntu ftp://mirror.team-cymru.com/ubuntu/
ubuntu http://mirror.team-cymru.org/ubuntu/
ubuntu ftp://mirror.team-cymru.org/ubuntu/
ubuntu http://mirror.uoregon.edu/ubuntu/
ubuntu ftp://mirror.uoregon.edu/ubuntu/
ubuntu http://mirror.us-midwest-1.nexcess.net/ubuntu/
ubuntu http://mirror.us-ny2.kamatera.com/ubuntu/
ubuntu http://mirror.us-sc.kamatera.com/ubuntu/
ubuntu http://mirror.us-tx.kamatera.com/ubuntu/
ubuntu http://mirrors.accretive-networks.net/ubuntu/
ubuntu http://mirrors.arpnetworks.com/Ubuntu/
ubuntu http://mirrors.cat.pdx.edu/ubuntu/
ubuntu http://mirrors.liquidweb.com/ubuntu/
ubuntu http://mirrors.lug.mtu.edu/ubuntu/
ubuntu ftp://mirrors.lug.mtu.edu/ubuntu/
ubuntu http://mirrors.maine.edu/ubuntu/
ubuntu http://mirrors.mit.edu/ubuntu/
ubuntu http://mirrors.namecheap.com/ubuntu/
ubuntu ftp://mirrors.namecheap.com/ubuntu/
ubuntu http://mirrors.ocf.berkeley.edu/ubuntu/
ubuntu ftp://mirrors.ocf.berkeley.edu/ubuntu/
ubuntu http://mirrors.ocf.berkeley.edu/ubuntu-ports/
ubuntu http://mirrors.sarak.as/ubuntu/
ubuntu ftp://mirrors.sarak.as/ubuntu/
ubuntu http://mirrors.sonic.net/ubuntu/
ubuntu ftp://mirrors.sonic.net/ubuntu/
ubuntu http://mirrors.xmission.com/ubuntu/
ubuntu ftp://mirrors.xmission.com/ubuntu/
ubuntu http://pubmirrors.dal.corespace.com/ubuntu/
ubuntu ftp://pubmirrors.dal.corespace.com/ubuntu/
ubuntu http://ubuntu.mirror.frontiernet.net/ubuntu/
ubuntu ftp://ubuntu.mirror.frontiernet.net/ubuntu/
ubuntu http://ubuntu.mirrors.pair.com/archive/
ubuntu ftp://ubuntu.mirrors.pair.com/archive/
ubuntu http://ubuntu.phoenixnap.com/ubuntu/
ubuntu http://www.gtlib.gatech.edu/pub/ubuntu/
ubuntu ftp://ftp.gtlib.gatech.edu/pub/ubuntu
ubuntu http://mirror.d.umn.edu/ubuntu/
ubuntu http://mirrors.vcea.wsu.edu/ubuntu/
ubuntu http://ubuntu.securedservers.com/
ubuntu http://ftp.ussg.iu.edu/linux/ubuntu/
ubuntu http://mirror.vcu.edu/pub/gnu+linux/ubuntu/
ubuntu ftp://mirror.vcu.edu/pub/gnu+linux/ubuntu/
ubuntu http://ubuntu.repo.cure.edu.uy/ubuntu/
ubuntu http://repos.interior.edu.uy/ubuntu/
ubuntu http://mirror.dc.uz/ubuntu/
ubuntu ftp://mirror.dc.uz/ubuntu/
ubuntu http://mirror.azvps.vn/ubuntu/
ubuntu http://ubuntu.vpsttt.com/ubuntu/
ubuntu http://opensource.xtdv.net/ubuntu/
ubuntu http://mirror.bizflycloud.vn/ubuntu/
ubuntu http://mirror.clearsky.vn/ubuntu/
ubuntu http://mirror.vietnix.vn/ubuntu/
ubuntu http://mirror.viettelcloud.vn/ubuntu/
ubuntu http://mirrors.tino.org/ubuntu/
ubuntu http://vn-mirrors.techhost.vn/ubuntu/
ubuntu http://vn-mirrors.vhost.vn/ubuntu/
ubuntu http://mirrors.nhanhoa.com/ubuntu/
EOFML
}

function getLogo()
{
  if [ "$IS_INSTALLED" = "true" ] && [ "$IS_CONFIG_FILE_UNENCRYPTED" = "true" ]; then
    echo "$hshqwarninglogo"
  else
    echo "$hshqlogo"
  fi
}

function showInstalledMenu()
{
  installedmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$installedmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Services" \
  "2" "System Utils" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    0)
	  return 0 ;;
    1)
      checkLoadConfig
      showStacksMenu
      set +e
      return 1 ;;
    2)
      set +e
      showAllUtilsMenu
      set +e
      return 1 ;;
#    2)
#      checkLoadConfig
#      if ! [ "$IS_INSTALLED" = "true" ]; then
#        showMessageBox "System Not Installed" "You must perform a system installation first before using this utility."
#        exit
#      fi
#      set +e
#      showNetworkMenu
#      set +e
#      return 1 ;;
#    2)
#      showHSHQUtilsMenu
#      set +e
#       return 1 ;;
#    3)
#      showSysUtilsMenu
#      set +e
#       return 1 ;;
#    4)
#       return 0 ;;
  esac
}

function showRestoreMenu()
{
  precheckRestoreResult="$(performRestorePrecheck)" 
  if ! [ -z "$precheckRestoreResult" ]; then
    showMessageBox "ERROR" "$precheckRestoreResult"
    return
  fi
  checkPerformSystemPrep
  if [ $? -ne 0 ]; then
    return
  fi
  restoremenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$restoremenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Restore From Encrypted Duplicati Backup" \
  "2" "Restore From Unencrypted Backup" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    0)
      return 0 ;;
    1)
      showRestoreEncryptedMenu ;;
    2)
      showRestoreUnencryptedMenu ;;
    3)
      return 0 ;;
  esac
}

function showRestoreEncryptedMenu()
{
  restoremenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$restoremenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Mount Drive" \
  "2" "Select Directory" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    0)
      return 0 ;;
    1)
      showRestoreMountDriveMenu ;;
    2)
      showRestoreSelectEncryptedDirectoryMenu ;;
    3)
      return 0 ;;
  esac
}

function showRestoreUnencryptedMenu()
{
  set +e
  performRestorePostcheck
  if [ $? -ne 0 ]; then
    return
  fi
  confirmRestore=$(promptUserInputMenu "" "Confirm" "The main restore process is ready to start. This will take awhile to complete, as all of the docker images must be re-downloaded. You will be prompted shortly for your config decrypt password. Enter the word 'restore' below to continue:")
  if [ $? -ne 0 ] || [ -z "$confirmRestore" ] || ! [ "$confirmRestore" = "restore" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi

  cp $HSHQ_LIB_SCRIPT $HOME/$HSHQ_LIB_FILENAME
  rm -fr $HSHQ_DATA_DIR/*
  mv $HSHQ_RESTORE_DIR/* $HSHQ_DATA_DIR/
  rm -fr $HSHQ_RESTORE_DIR
  # Only restore hshqlib script if version is less than 85
  hshqlib_orig_version=$(sed -n 2p $HSHQ_LIB_SCRIPT | cut -d"=" -f2)
  if [ $hshqlib_orig_version -lt 85 ]; then
    mv $HOME/$HSHQ_LIB_FILENAME $HSHQ_LIB_SCRIPT
  else
    rm -f $HOME/$HSHQ_LIB_FILENAME
  fi
  scName=hshqRestore
  initScreen $scName "bash $HSHQ_LIB_SCRIPT restore $CONNECTING_IP"
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There was a problem starting the restore process, exiting..."
    exit 1
  fi
  screen -r $scName
  exit 0
}

function performFullRestore()
{
  refreshSudo
  createHSHQLog
  checkLoadConfig
  forceGetLock networkchecks performFullRestore
  setSystemState $SS_RESTORING
  IS_INSTALLED=false
  IS_INSTALLING=true
  set +e
  origUsername=$(echo $HSHQ_BASE_DIR | cut -d"/" -f3)
  curUID=$(id -u)
  curGID=$(id -g)
  if ! [ "$USERNAME" = "$origUsername" ] || ! [ "$curUID" = "$USERID" ] || ! [ "$curGID" = "$GROUPID" ]; then
    msgmenu=$(cat << EOF

$(getLogo)
 The current username(UID:GID) does not match the original.

   Current: $USERNAME ($curUID:$curGID)
   Original: $origUsername ($USERID:$GROUPID)

 The restore cannot be performed.
 Please ensure to have the exact same username
 and UID:GID as the Original.

EOF
    )
    whiptail --title "ERROR" --msgbox "$msgmenu" $MENU_HEIGHT $MENU_WIDTH
    return
  fi
  setSudoTimeoutInstall
  checkCreateNonbackupDirs
  # Set hostname
  new_hostname="HomeServer-$(echo $HOMESERVER_DOMAIN | sed 's/\./-/g')"
  if [ -z "$(cat /etc/hosts | grep $new_hostname)" ]; then
    echo "127.0.1.1 $new_hostname" | sudo tee -a /etc/hosts
  fi
  sudo hostnamectl set-hostname $new_hostname
  rm -f $HOME/dead.letter
  installDependencies
  echo "Pulling docker images..."
  restorePullDockerImages
  rm -f $HOME/script-server.zip

  # Set timezone
  sudo timedatectl set-timezone "$TZ"
  set +e
  # Setup primary network interface
  prevPrimaryIface=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ConnectionType = 'primary' and NetworkType = 'home_network';")
  isFound=false
  availInterfacesArr=($(echo "$(getAllNetworkInterfacesCSV)" | tr "," "\n"))
  for curInterface in "${availInterfacesArr[@]}"
  do
    if [ "$prevPrimaryIface" = "$curInterface" ]; then
      isFound=true
      break
    fi
  done
  if [ "$isFound" = "false" ]; then
    default_iface=$(getDefaultIface)
    checkDB=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where InterfaceName = '$default_iface';")
    if [ -z "$checkDB" ]; then
      addHSInterface $default_iface true
    else
      sudo sqlite3 $HSHQ_DB "update connections set ConnectionType = 'secondary' where NetworkType = 'home_network';"
      sudo sqlite3 $HSHQ_DB "update connections set ConnectionType = 'primary' where InterfaceName = '$default_iface';"
    fi
  fi
  set -e
  # This should cover all possibilities
  curPrimaryIfaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ConnectionType = 'primary' and NetworkType = 'home_network';")
  curPrimaryIfaceIP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ConnectionType = 'primary' and NetworkType = 'home_network';")
  HOMESERVER_HOST_PRIMARY_INTERFACE_NAME=$curPrimaryIfaceName
  updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_NAME $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME
  HOMESERVER_HOST_PRIMARY_INTERFACE_IP=$curPrimaryIfaceIP
  updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_IP $HOMESERVER_HOST_PRIMARY_INTERFACE_IP

  find $HSHQ_SSL_DIR -name "*-ca.crt" -print0 | xargs -0 -I {} sudo cp {} /usr/local/share/ca-certificates/
  sudo update-ca-certificates
  CURRENT_SSH_PORT=$(sudo grep "^Port\|^#Port" /etc/ssh/sshd_config | cut -d" " -f2)
  if [ -z "$CURRENT_SSH_PORT" ]; then
    CURRENT_SSH_PORT=22
  fi
  # Change SSH port on host
  sudo sed -i "s|^#*Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
  sudo sed -i "s|^Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
  updateMOTD
  performSuggestedSecUpdates
  installMailUtils
  performClearIPTables true
  checkUpdateAllIPTables performFullRestore
  outputScripts
  sudo cp $HSHQ_WIREGUARD_DIR/vpn/*.conf /etc/wireguard/
  performAptInstall python3-tornado > /dev/null 2>&1
  sudo rm -f /etc/systemd/system/runScriptServer.service
  sudo ln -s $HSHQ_SCRIPTS_DIR/root/runScriptServer.service /etc/systemd/system/runScriptServer.service
  sudo systemctl daemon-reload
  sudo systemctl enable runScriptServer
  sudo systemctl start runScriptServer
  set -e
  if [ -d $HSHQ_STACKS_DIR/wazuh ]; then
    installWazuhAgent
  fi
  set +e
  sudo docker ps -q | xargs sudo docker stop
  sudo docker container prune -f
  createDockerNetworks
  enableAllWGVPNInterfaces
  createWGDockerNetworks
  outputEnvPortainer
  startPortainer
  docker volume create --driver local -o device=$HSHQ_STACKS_DIR/caddy-common/primary-certs -o o=bind -o type=none caddy-primary-certs
  createClientDNSNetworksOnRestore
  prepAdguardInstallation
  restartAllStacks "duplicati,syncthing" true
  sudo docker container prune -f
  addDomainAndWildcardAdguardHS $HOMESERVER_DOMAIN $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
  # Add RelayServer fingerprint
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    loadSSHKey
    ssh -p $RELAYSERVER_SSH_PORT -o 'StrictHostKeyChecking accept-new' $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN 'echo Successfully connected to RelayServer!'
    unloadSSHKey
  fi
  removeSudoTimeoutInstall
  wgDockInternetUpAll
  initCronJobs
  setSystemState $SS_RUNNING
  performExitFunctions
  releaseLock networkchecks performFullRestore false
  clear
  echo -e "\n\n\n\n##########################################\n"
  echo -e "HomeServer Restore Process Complete!\n"
  echo -e "The duplicati and syncthing stacks have"
  echo -e "been intentionally skipped from the stack"
  echo -e "restart process, as you may still need"
  echo -e "to re-configure your backup drives, etc.\n"
  echo -e "You may also have to manually restart some"
  echo -e "stacks due to some bugs in the docker"
  echo -e "startup process.\n"
  echo -e "Log in to Portainer via the following URL: \n"
  echo -e "  https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT"
  echo -e "\n##########################################\n\n"
  read -r -p "Press enter to continue."
}

function restorePullDockerImages()
{
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  imgList=($(sudo find $HSHQ_STACKS_DIR/portainer/compose -name docker-compose.yml -print0 | xargs -0 sudo grep -hr "^[[:blank:]]*image:"))
  imgOnlyList=()
  for curImgItem in "${imgList[@]}"
  do
    imgOnlyList+=($(echo "$curImgItem" | xargs | cut -d" " -f2))
  done
  IFS=$OLDIFS
  uniqs_arr=($(for tmpImg in "${imgOnlyList[@]}"; do echo "${tmpImg}"; done | sort -u))
  for curImg in "${uniqs_arr[@]}"
  do
    pullImage $curImg
  done
  buildCustomImages
}

function buildCustomImages()
{
  buildFileDropImage
}

function showRestoreMountDriveMenu()
{
  findmnt | grep $HSHQ_BACKUP_DIR > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a filesystem mounted to $HSHQ_BACKUP_DIR. Please unmount this filesystem first, returning..."
    return
  fi
  dbackmenu=$(cat << EOF

$(getLogo)
EOF
)
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  diskarr=($(sudo hwinfo --disk --short | tail +2))
  curListNum=1
  scsbm_menu_items=( --title "Select Disk/Partition" --radiolist "$dbackmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT )
  for curDisk in "${diskarr[@]}"
  do
    curDiskID=$(echo "$curDisk" | xargs | cut -d" " -f1)
    curDiskName=$(echo "$curDisk" | xargs | cut -d" " -f2-)
    findmnt | grep $curDiskID > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      continue
    fi
    curDiskPartitions=($(lsblk --noheadings --raw -o NAME,SIZE,TYPE $curDiskID))
    for curDiskPart in "${curDiskPartitions[@]}"
    do
      curDiskPartName=$(echo $curDiskPart | cut -d" " -f1)
      curDiskPartSize=$(echo $curDiskPart | cut -d" " -f2)
      curDiskPartType=$(echo $curDiskPart | cut -d" " -f3)
      if [ "$curDiskPartType" = "part" ]; then
        scsbm_menu_items+=( "$curDiskPartName  $curDiskPartSize  ($curDiskName)" )
        scsbm_menu_items+=( "|" )
        scsbm_menu_items+=( "off" )
        ((curListNum++))
      fi
    done
  done
  IFS=$OLDIFS
  if [ $curListNum -le 1 ]; then
    showMessageBox "ERROR" "There are no available disks for this operation, returning..."
    return
  fi
  while true
  do
    selDiskItem=$(whiptail "${scsbm_menu_items[@]}" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
      return
    fi
    if [ -z "$selDiskItem" ]; then
      showMessageBox "ERROR" "You did not make a selection, please try again."
    else
      break
    fi
  done
  selDisk=$(echo "$selDiskItem" | cut -d" " -f1)
  if [ -z "$selDisk" ]; then
    showMessageBox "ERROR" "No partition was selected, returning..."
    return
  fi
  mountDir=$(promptUserInputMenu "$HSHQ_BACKUP_DIR" "Select Directory" "Enter the directory where you would like to mount this partition:")
  if [ "$mountDir" = "$HSHQ_BACKUP_DIR" ]; then
    mkdir -p $HSHQ_BACKUP_DIR
  fi
  if [ $(checkValidDirectory "$mountDir") = "false" ]; then
    showMessageBox "ERROR" "Invalid directory name, returning..."
    return
  fi
  findmnt | grep "$mountDir" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a disk mounted to this directory, returning..."
    return
  fi
  if [ -d "$mountDir" ]; then
    if ! [ -z "$(ls -A $mountDir)" ]; then
      showMessageBox "ERROR" "The selected directory is not empty, returning..."
      return
    fi
  fi
  if ! [ -d "$mountDir" ]; then
    showYesNoMessageBox "ERROR" "This directory does not exist, would you like to create it now?"
    if [ $? -ne 0 ]; then
      return
    fi
    mkdir -p $mountDir
    if [ $? -ne 0 ]; then
      showMessageBox "ERROR" "There was an error creating this directory, likely a permission error, returning..."
      return
    fi
  fi
  sudo mount /dev/$selDisk $mountDir
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There was an error mounting this partition, returning..."
    return
  fi
  showRestoreDuplicatiRestoreMenu "$mountDir" "/dev/$selDisk"
}

function showRestoreSelectEncryptedDirectoryMenu()
{
  backupDir=$(promptUserInputMenu "$HSHQ_BACKUP_DIR" "Select Directory" "Enter the top-level directory of the encrypted data:")
  showRestoreDuplicatiRestoreMenu "$backupDir"
}

function showRestoreDuplicatiRestoreMenu()
{
  backupDirTL="$1"
  umountDisk="$2"
  curListNum=0
  dbackupmenu=$(cat << EOF

$(getLogo)
EOF
)
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  dupback_menu_items=( --title "Select Directory" --radiolist "$dbackupmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT )
  dirarr=($(sudo ls $backupDirTL))
  cd ~
  for curDir in "${dirarr[@]}"
  do
    if [ "$curDir" = "lost+found" ]; then
      continue
    fi
    if sudo test -d "$backupDirTL/$curDir"; then
      dupback_menu_items+=( "$curDir" )
      dupback_menu_items+=( "|" )
      dupback_menu_items+=( "off" )
      ((curListNum++))
    fi
  done
  IFS=$OLDIFS
  if [ $curListNum -lt 1 ]; then
    showMessageBox "ERROR" "There are no subdirectories for this operation, returning..."
    return
  fi
  selBackupDir=$(whiptail "${dupback_menu_items[@]}" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    return
  fi
  if [ -z "$selBackupDir" ]; then
    showMessageBox "ERROR" "No directory was selected, returning..."
    return
  fi
  if [ -d "$HSHQ_RESTORE_DIR" ]; then
    if ! [ -z "$(ls -A $HSHQ_RESTORE_DIR)" ]; then
      showMessageBox "ERROR" "The restore directory ($HSHQ_RESTORE_DIR) is not empty, returning..."
      return
    fi
  else
    mkdir -p $HSHQ_RESTORE_DIR
  fi
  dup_pw=$(promptPasswordMenu "Enter Passphrase" "Enter the passphrase that you used to encrypt your Duplicati backup data: ")
  confirmRestore=$(promptUserInputMenu "" "Confirm" "The decryption process is ready to start. It could take anywhere from 15 minutes to many hours to decrypt the data from the encrypted state, depending on how much data. After this step, you will be prompted for additional information. So check back in an hour or so to complete the full server restore process. Enter the word 'decrypt' below to continue:")
  if [ $? -ne 0 ] || [ -z "$confirmRestore" ] || ! [ "$confirmRestore" = "decrypt" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  sudo rm -fr /tmp/dupconfig
  mkdir /tmp/dupconfig
  docker container stop duplicati-restore > /dev/null 2>&1
  docker container rm duplicati-restore > /dev/null 2>&1
  docker run -d --name=duplicati-restore -v /tmp/dupconfig:/config -v $backupDirTL/$selBackupDir:/backup -v $HSHQ_RESTORE_DIR:/restore $(getScriptImageByContainerName duplicati) > /dev/null 2>&1
  echo "Recreating duplicati database..."
  #docker exec -it duplicati-restore bash -c "mono /app/duplicati/Duplicati.CommandLine.exe repair /backup --dbpath=/config/hshqrestore.sqlite --passphrase=$dup_pw"
  docker exec -it duplicati-restore bash -c "/app/duplicati/duplicati-cli repair /backup --dbpath=/config/hshqrestore.sqlite --passphrase=$dup_pw"
  echo "Database recreated, restoring files..."
  #docker exec -it duplicati-restore bash -c "mono /app/duplicati/Duplicati.CommandLine.exe restore /backup --dbpath=/config/hshqrestore.sqlite --restore-path=/restore --overwrite=true --restore-permissions --passphrase=$dup_pw"
  docker exec -it duplicati-restore bash -c "/app/duplicati/duplicati-cli restore /backup --dbpath=/config/hshqrestore.sqlite --restore-path=/restore --overwrite=true --restore-permissions --passphrase=$dup_pw"
  docker container stop duplicati-restore > /dev/null 2>&1
  docker container rm duplicati-restore > /dev/null 2>&1
  sudo rm -fr /tmp/dupconfig
  echo "Data Successfully Restored!"
  if ! [ -z "$umountDisk" ]; then
    echo "Unmounting disk ($umountDisk)..."
    sudo umount $umountDisk
  fi
  showRestoreUnencryptedMenu
}

function performRestorePrecheck()
{
  if [ -d $HSHQ_ASSETS_DIR ]; then
    echo "The HSHQ assets directory ($HSHQ_ASSETS_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_CONFIG_DIR ]; then
    echo "The HSHQ config directory ($HSHQ_CONFIG_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_RELAYSERVER_DIR ]; then
    echo "The HSHQ relayserver directory ($HSHQ_RELAYSERVER_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_SCRIPTS_DIR ]; then
    echo "The HSHQ scripts directory ($HSHQ_SCRIPTS_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_SECRETS_DIR ]; then
    echo "The HSHQ secrets directory ($HSHQ_SECRETS_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_SSL_DIR ]; then
    echo "The HSHQ ssl directory ($HSHQ_SSL_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_STACKS_DIR ]; then
    echo "The HSHQ stacks directory ($HSHQ_STACKS_DIR) already exists. Cannot perform restore."
  fi
  if [ -d $HSHQ_WIREGUARD_DIR ]; then
    echo "The HSHQ wireguard directory ($HSHQ_WIREGUARD_DIR) already exists. Cannot perform restore."
  fi
}

function performRestorePostcheck()
{
  if ! [ -d "$HSHQ_RESTORE_DIR" ]; then
    showMessageBox "ERROR" "The restore directory ($HSHQ_RESTORE_DIR) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/assets" ]; then
    showMessageBox "ERROR" "The restore (assets) directory ($HSHQ_RESTORE_DIR/assets) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/config" ]; then
    showMessageBox "ERROR" "The restore (config) directory ($HSHQ_RESTORE_DIR/config) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/lib" ]; then
    showMessageBox "ERROR" "The restore (lib) directory ($HSHQ_RESTORE_DIR/lib) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/scripts" ]; then
    showMessageBox "ERROR" "The restore (scripts) directory ($HSHQ_RESTORE_DIR/scripts) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/secrets" ]; then
    showMessageBox "ERROR" "The restore (secrets) directory ($HSHQ_RESTORE_DIR/secrets) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/ssl" ]; then
    showMessageBox "ERROR" "The restore (ssl) directory ($HSHQ_RESTORE_DIR/ssl) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/stacks" ]; then
    showMessageBox "ERROR" "The restore (stacks) directory ($HSHQ_RESTORE_DIR/stacks) does not exist, returning..."
    return 1
  fi
  if ! [ -d "$HSHQ_RESTORE_DIR/wireguard" ]; then
    showMessageBox "ERROR" "The restore (wireguard) directory ($HSHQ_RESTORE_DIR/wireguard) does not exist, returning..."
    return 1
  fi
}

function createClientDNSNetworksOnRestore()
{
  echo "Creating ClientDNS networks..."
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  rsi_numTries=1
  rsi_totalTries=5
  rsi_retVal=1
  rstackIDsQry=""
  while [ $rsi_numTries -le $rsi_totalTries ]
  do
    rstackIDsQry=$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1)
    rsi_retVal=$?
    if [ $rsi_retVal -eq 0 ]; then
      break
    fi
    ((rsi_numTries++))
  done
  if [ $rsi_retVal -ne 0 ]; then
    echo "ERROR: Could not get list of stack IDs in Portainer..." 1>&2
    return
  fi
  rstackIDs=($(echo $rstackIDsQry | jq -r '.[] | select(.Status == 1) | .Id'))
  rstackNames=($(echo $rstackIDsQry | jq -r '.[] | select(.Status == 1) | .Name'))
  numItems=$((${#rstackIDs[@]} - 1))
  for curID in $(seq 0 $numItems);
  do
    echo ${rstackNames[$curID]} | grep "^clientdns-" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      echo "Found ClientDNS stack: (${rstackIDs[$curID]}) ${rstackNames[$curID]}"
      cdns_stack_name=$(echo echo ${rstackNames[$curID]} | cut -d"-" -f2)
      clientdns_subnet=$(getConfigVarFromFile CLIENTDNS_SUBNET_PREFIX $HSHQ_STACKS_DIR/portainer/compose/${rstackIDs[$curID]}/stack.env root).0/24
      docker network create -o com.docker.network.bridge.name=brcd-${cdns_stack_name} --driver=bridge --subnet $clientdns_subnet cdns-${cdns_stack_name} > /dev/null
    fi
  done
}

function showAllUtilsMenu()
{
  set +e
  utilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$utilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Edit Encrypted Config File" \
  "2" "Edit Plaintext Root Config File" \
  "3" "Edit Plaintext User Config File" \
  "4" "Update APT Mirror" \
  "5" "Release All Locks" \
  "6" "Update IP and Refresh Firewall" \
  "7" "Configure Simple Backup" \
  "8" "Uninstall and Remove Everything" \
  "9" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  set -e
  case $menures in
    0)
      set +e
	  return 1 ;;
    1)
      set +e
      showYesNoMessageBox "WARNING" "Be VERY careful editing this file. You could very easily break things. The configuration file will be opened with the nano utility, so ensure you know how to use this before proceeding.\n\nDo you wish to continue?"
      if [ $? -ne 0 ]; then
        return 1
      fi
      checkLoadConfig
      nano $CONFIG_FILE
      loadConfigVars true
      set +e
      return 1 ;;
    2)
      set +e
      showYesNoMessageBox "WARNING" "Be VERY careful editing this file. You could very easily break things. The configuration file will be opened with the nano utility, so ensure you know how to use this before proceeding.\n\nDo you wish to continue?"
      if [ $? -ne 0 ]; then
        return 1
      fi
      checkLoadConfig
      sudo nano $HSHQ_PLAINTEXT_ROOT_CONFIG
      loadConfigVars true
      set +e
      return 1 ;;
    3)
      set +e
      showYesNoMessageBox "WARNING" "Be VERY careful editing this file. You could very easily break things. The configuration file will be opened with the nano utility, so ensure you know how to use this before proceeding.\n\nDo you wish to continue?"
      if [ $? -ne 0 ]; then
        return 1
      fi
      checkLoadConfig
      nano $HSHQ_PLAINTEXT_USER_CONFIG
      loadConfigVars true
      set +e
      return 1 ;;
    4)
      set +e
      refreshSudo
      checkUpdateAptSources true
      return 1 ;;
    5)
      set +e
      sudo -k
      USER_SUDO_PW=""
      refreshSudo
      releaseAllLocks
      return 1 ;;
    6)
      checkLoadConfig
      checkHostAllInterfaceIPChanges true false User-Console
      checkUpdateAllIPTables User-Console
      set +e
      return 1 ;;
    7)
      checkLoadConfig
      showSimpleBackupMenu
      set +e
      return 1 ;;
    8)
      nukeHSHQ ;;
    9)
	  return 0 ;;
  esac
}

function showHSHQUtilsMenu()
{
  set +e
  utilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$utilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Edit Encrypted Config File" \
  "2" "Edit Plaintext Root Config File" \
  "3" "Edit Plaintext User Config File" \
  "5" "Reset Caddy Data" \
  "6" "Restart All Stacks" \
  "7" "Email Vaultwarden Credentials" \
  "8" "Email Root CA" \
  "9" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  set -e
  case $menures in
    0)
      set +e
	  return 1 ;;
    1)
      checkLoadConfig
      nano $CONFIG_FILE
      loadConfigVars true
      set +e
      return 1 ;;
    2)
      checkLoadConfig
      sudo nano $HSHQ_PLAINTEXT_ROOT_CONFIG
      loadConfigVars true
      set +e
      return 1 ;;
    3)
      checkLoadConfig
      nano $HSHQ_PLAINTEXT_USER_CONFIG
      loadConfigVars true
      set +e
      return 1 ;;
    4)
      checkLoadConfig
      if ! [ "$IS_INSTALLED" = "true" ]; then
        showMessageBox "System Not Installed" "You must perform a system installation first before using this utility."
        exit
      fi
      generateCertDialog
      set +e
      return 1 ;;
    5)
      checkLoadConfig
      if ! [ "$IS_INSTALLED" = "true" ]; then
        showMessageBox "System Not Installed" "You must perform a system installation first before using this utility."
        exit
      fi
      showResetCaddyMenu
      set +e
      return 1 ;;
    6)
      checkLoadConfig
      restartAllStacksDialog ;;
    7)
      checkLoadConfig
      emailVaultwardenCredentials false ;;
    8)
      checkLoadConfig
      sendRootCAEmail ;;
    9)
	  return 0 ;;
  esac
}

function showSysUtilsMenu()
{
  set +e
  utilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$utilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Update Linux OS and Reboot" \
  "2" "Download All Docker Images" \
  "3" "Release All Locks" \
  "4" "Check For IP Address Changes" \
  "5" "Refresh Firewall" \
  "6" "Configure Simple Backup" \
  "7" "Uninstall and Remove Everything" \
  "8" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  set -e
  case $menures in
    0)
      set +e
	  return 1 ;;
    1)
      performExitFunctions true
      set +e
      sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y && sudo reboot ;;
    2)
      pullDockerImages
      set +e
      return 1 ;;
    3)
      sudo -k
      set +e
      USER_SUDO_PW=""
      refreshSudo
      releaseAllLocks
      return 1 ;;
    4)
      checkLoadConfig
      checkHostAllInterfaceIPChanges true false User-Console
      set +e
      return 1 ;;
    5)
      checkLoadConfig
      checkUpdateAllIPTables User-Console
      set +e
      return 1 ;;
    6)
      checkLoadConfig
      showSimpleBackupMenu
      set +e
      return 1 ;;
    7)
      nukeHSHQ ;;
    8)
	  return 0 ;;
  esac
}

function showResetCaddyMenu()
{
  set +e
  caddymenu=$(cat << EOF

$(getLogo)
Select the Caddy instances that you wish to reset:

EOF
  )
  caddy_arr=($(docker ps -a --filter name=caddy- --format "{{.Names}}"))
  menu_items=""
  for curcaddy in "${caddy_arr[@]}"
  do
    menu_items=${menu_items}"$curcaddy | OFF "
  done
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    menu_items=${menu_items}"RelayServer | OFF "
  fi
  sel_caddy=($(whiptail --title "Select Instances" --checklist "$caddymenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  showYesNoMessageBox "Confirm Reset" "Perform this action on the selected Caddy server(s), Continue?"
  if [ $? -ne 0 ]; then
    set -e
    return 0
  fi
  set -e
  for curcaddy in "${sel_caddy[@]}"
  do
    curcaddy=$(echo $curcaddy | tr -d \")
    if [ "$curcaddy" = "RelayServer" ]; then
      resetCaddyDataRelayServer true
    else
      sudo $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh $curcaddy
    fi
  done
}

function checkPerformSystemPrep()
{
  isPrepped=true
  for util in $UTILS_LIST; do
    if [[ "$(isProgramInstalled $util)" = "false" ]]; then
      isPrepped=false
      break
    fi
  done
  if [ "$isPrepped" = "false" ]; then
    showYesNoMessageBox "Prep System" "The system must be prepped with updates and required utilities. The system will automatically reboot upon completion and you will need to re-run this utility. Do you wish to continue?"
    if [ $? -ne 0 ]; then
      return 1
    fi
    sudo apt update && sudo apt upgrade -y && sudo apt autoremove -y
    installDependencies
    pullBaseServicesDockerImages
    sudo reboot
  fi
}

function checkWrapperVersion()
{
  set +e
  curWrapV=$(sed -n 2p $HSHQ_WRAP_SCRIPT | cut -d"=" -f2)
  if ! [ -z "$curWrapV" ]; then
    if [ $curWrapV -lt 5 ]; then
      showMessageBox "Update Wrapper" "It appears you are using a deprecated version of the wrapper script. Please run the command: 'wget -q4N https://homeserverhq.com/hshq.sh' to obtain the latest version as soon as possible."
    fi
  fi
  set -e
}

function loadVersionVars()
{
  DISTRO_ID=$(cat /etc/*-release 2> /dev/null | grep "^ID=" | cut -d"=" -f2 | xargs | tr '[:upper:]' '[:lower:]')
  DISTRO_NAME=$(cat /etc/*-release 2> /dev/null | grep "^NAME=" | cut -d"=" -f2 | xargs)
  DISTRO_VERSION=$(cat /etc/*-release 2> /dev/null | grep "^VERSION=" | cut -d"=" -f2 | xargs)
  DISTRO_CODENAME=$(cat /etc/*-release 2> /dev/null | grep "^VERSION_CODENAME=" | cut -d"=" -f2 | xargs)
  DISTRO_ARCH=$(dpkg --print-architecture)
}

function checkSupportedHostOS()
{
  IS_DISTRO_EXP=false
  if [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^22\.04. ]]; then
    return
  fi
  if [ "$DISTRO_ID" = "ubuntu" ] && [[ "$DISTRO_VERSION" =~ ^24\.04. ]]; then
    return
  fi
  if [ "$DISTRO_ID" = "debian" ] && [[ "$DISTRO_VERSION" =~ ^12. ]]; then
    return
  fi
  if [ "$DISTRO_ID" = "linuxmint" ] && [[ "$DISTRO_VERSION" =~ ^22. ]]; then
    return
  fi
  if [ "$IS_DISTRO_EXP" = "true" ]; then
    showYesNoMessageBox "Confirm Experimental" "This distribution of Linux is on the experimental list. It has not yet been thoroughly tested. Do you wish to continue?"
    if [ $? -eq 0 ]; then
      touch $HOME/hshq/$IS_HSHQ_TEST_FILENAME
      IS_HSHQ_DEV_TEST=true
      return
    fi
  else
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
    echo "@                   Unsupported Host Operating System                  @"
    echo "@                                                                      @"
    echo "@ This installation only supports the following Linux distribution(s): @"
    echo "@                                                                      @"
    echo "@  - Ubuntu 22.04 (Jammy Jellyfish)                                    @"
    echo "@  - Ubuntu 24.04 (Noble Numbat)                                       @"
    echo "@  - Debian 12 (Bookworm)                                              @"
    echo "@  - Mint 22 (Wilma)                                                   @"
    echo "@                                                                      @"
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  fi
  releaseLock hshqopen "checkSupportedHostOS" false
  exit 2
}

function updateSysctl()
{
  isPerfUpdate=$1
  set +e
  sudo rm -f /etc/sysctl.d/88-hshq.conf
  sudo tee /etc/sysctl.d/88-hshq.conf >/dev/null <<EOFSC
kernel.panic = 10
fs.file-max = 10000000
fs.nr_open = 10000000
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
vm.swappiness = 10
net.core.somaxconn = 65536
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_loose = 0
net.netfilter.nf_conntrack_tcp_timeout_established = 1800
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 10
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 20
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 20
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 10
net.ipv4.route.flush = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_timestamps = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.ip_forward = 1
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

# Reserve for Coturn and any other ports above 10000
net.ipv4.ip_local_reserved_ports = $JITSI_MEET_PORT,$COTURN_COMMS_MIN_PORT-$COTURN_COMMS_MAX_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT,$WAZUH_PORT_4

# See https://community.home-assistant.io/t/zeroconf-error/153883

# Bigger buffers (to make 40Gb more practical). These are maximums, but the default is unaffected.
net.core.wmem_max=268435456
net.core.rmem_max=268435456
net.core.netdev_max_backlog=10000

# Force IGMP v2 (required by CBF switch)
net.ipv4.conf.all.force_igmp_version=2
net.ipv4.conf.default.force_igmp_version=2

# Increase the ARP cache table
net.ipv4.neigh.default.gc_thresh3=4096
net.ipv4.neigh.default.gc_thresh2=2048
net.ipv4.neigh.default.gc_thresh1=1024

# Increase number of multicast groups permitted
net.ipv4.igmp_max_memberships=1024

# See https://documentation.wazuh.com/current/deployment-options/docker/docker-installation.html
vm.max_map_count = 262144

EOFSC
  if ! [ "$isPerfUpdate" = "false" ]; then
    sudo sysctl --system > /dev/null 2>&1
  fi
}

function updateLogrotateConfig()
{
  ulrc_curE=${-//[^e]/}
  set +e
  # Set max size of syslog to 5G
  grep maxsize /etc/logrotate.d/rsyslog > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo sed -i "/weekly$/a\        maxsize 5G" /etc/logrotate.d/rsyslog
  fi
  # Move logrotate into hourly
  if [ -f /etc/cron.daily/logrotate ]; then
    sudo mv /etc/cron.daily/logrotate /etc/cron.hourly
  fi
  # Set conditions for docker container logs
  sudo tee /etc/logrotate.d/docker >/dev/null <<EOFLR
/var/log/docker/*.log {
    weekly
    maxsize 100M
    rotate 4
    missingok
    notifempty
}
EOFLR
  
  sudo systemctl restart logrotate
  if ! [ -z "$ulrc_curE" ]; then
    set -e
  fi
}

function updateMOTD()
{
  cat <<EOFMD > $HOME/88-hshq
#!/bin/bash

echo
echo "  #===============================================================#"
echo "  # ▀█  █  ▄▄  ▄▄ ▄▄ ▄▄▄ █▀▀▀█ ▄▄▄ ▄▄▄  ▄   ▄ ▄▄▄ ▄▄▄  █  █ █▀▀█  #"
echo "  #  █▀▀█ █  █ █ █ █ ▄▄  ▀▀▀▄▄ ▄▄  ▄▄▄▀ ▀▄ ▄▀ ▄▄  ▄▄▄▀ █▀▀█ █  █  #"
echo "  #  █  █ ▀▄▄▀ █   █ ▄▄▄ █▄▄▄█ ▄▄▄ ▄▄▄▄  ▀█▀  ▄▄▄ ▄▄▄▄ █  █ █▄▄█▄ #"
echo "  #===============================================================#"
echo

echo "      Linux OS:  \$(lsb_release -d | cut -d":" -f2 | cut -d"(" -f1 | xargs)"
if [ -f $HSHQ_LIB_SCRIPT ]; then
  echo "  HSHQ Version:  \$(sed -n 2p $HSHQ_LIB_SCRIPT | cut -d'=' -f2)"
fi
printf "  Memory Usage:  %.1f%% of \$(free -h | awk  '/Mem:/{print \$2}')\n" \$((10000 - \$((10**4 * \$(grep "MemAvailable" /proc/meminfo | xargs | cut -d" " -f2) / \$(grep "MemTotal" /proc/meminfo | xargs | cut -d" " -f2)))))e-2
totSwap=\$(grep "SwapTotal" /proc/meminfo | xargs | cut -d" " -f2)
if [ \$totSwap -gt 0 ]; then
  printf "    Swap Usage:  %.1f%% of \$(free -h | awk  '/Swap:/{print \$2}')\n" \$((10000 - \$((10**4 * \$(grep "SwapFree" /proc/meminfo | xargs | cut -d" " -f2) / \$totSwap))))e-2
fi

echo
echo "  Disks: "
echo "  -----------------------------------------------------------------"
echo "  Filesystem            Size    Used    Avail   Use%    Mounted on"
echo "  -----------------------------------------------------------------"
df -hP | grep "^/dev" | awk '{printf "  %-21s %-7s %-7s %-7s %-7s %-8s\n", \$1, \$2, \$3, \$4, \$5, \$6}'
echo

# Let's only show zombie count if greater than 10
zombie_count=\$(ps aux | grep "defunct" | wc -l)
if [ \$zombie_count -gt 10 ]; then
  echo "  => There are \$zombie_count zombie processes."
  echo
fi

echo "  Enter 'bash $HSHQ_WRAP_FILENAME' to run the HomeServerHQ script."
echo
EOFMD
  chmod 755 $HOME/88-hshq
  sudo chown root:root $HOME/88-hshq
  sudo chmod -x /etc/update-motd.d/*
  sudo mv $HOME/88-hshq /etc/update-motd.d/
  if [ -f /etc/motd ]; then
    sudo mv /etc/motd /etc/motd.old
  fi
}

function performSuggestedSecUpdates()
{
  disa_curE=${-//[^e]/}
  set +e
  # This function continues the process of reducing the failed checks in the Wazuh SCA scan
  # It's mostly low hanging fruit, but reducing the list of exceptions will help to focus
  # on the more important ones.
  grep "enabled=1" /etc/default/apport > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    sudo sed -i "s/enabled=1/enabled=0/" /etc/default/apport
    sudo systemctl stop apport
    sudo systemctl --now disable apport
    sudo systemctl daemon-reload
    #sudo systemctl mask apport
  fi
  echo "Authorized uses only." | sudo tee /etc/issue > /dev/null 2>&1
  echo "Authorized uses only." | sudo tee /etc/issue.net > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y telnet > /dev/null 2>&1
  # Assume the caller will restart sshd - don't want to risk breaking the installation process
  sudo sed -i "s/^#MaxAuthTries.*/MaxAuthTries 4/" /etc/ssh/sshd_config
  sudo sed -i "s/^#Banner none.*/Banner \/etc\/issue.net/" /etc/ssh/sshd_config
  sudo sed -i "s/^#MaxStartups.*/MaxStartups 10:30:60/" /etc/ssh/sshd_config
  sudo sed -i "s/^#LoginGraceTime.*/LoginGraceTime 60/" /etc/ssh/sshd_config
  sudo sed -i "s/^#AllowTcpForwarding yes.*/AllowTcpForwarding no/" /etc/ssh/sshd_config
  sudo chown root:root /etc/crontab
  sudo chmod og-rwx /etc/crontab
  sudo chown root:root /etc/cron.hourly/
  sudo chmod og-rwx /etc/cron.hourly/
  sudo chown root:root /etc/cron.daily/
  sudo chmod og-rwx /etc/cron.daily/
  sudo chown root:root /etc/cron.weekly/
  sudo chmod og-rwx /etc/cron.weekly/
  sudo chown root:root /etc/cron.monthly/
  sudo chmod og-rwx /etc/cron.monthly/
  sudo chown root:root /etc/cron.d/
  sudo chmod og-rwx /etc/cron.d/
  if ! [ -z "$disa_curE" ]; then
    set -e
  fi
}

function performAptInstall()
{
  if [ "$1" = "yq" ]; then
    installYQ
    return
  fi
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' $1
}

function installYQ()
{
  sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
  sudo chmod a+x /usr/local/bin/yq
}

function installDependencies()
{
  set +e
  createHSHQLog
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y needrestart > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y needrestart > /dev/null 2>&1
  # Install utils
  installHostNTPServer

  for util in $UTILS_LIST; do
    if [[ "$(isProgramInstalled $util)" = "false" ]]; then
      lib_name=$(echo $util | cut -d"|" -f2)
      echo "Installing $lib_name, please wait..."
      performAptInstall $lib_name
    fi
  done

  if ! [ -f /etc/rsyslog.d/docker-logs.conf ]; then
    # Install Rsyslog
    sudo systemctl status rsyslog > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      echo "Installing rsyslog, please wait..."
      performAptInstall rsyslog
      sudo systemctl enable rsyslog
      sudo systemctl start rsyslog
    fi
  fi

  # Some host tuning
  updateSysctl true
  updateLogrotateConfig
  sudo sed -i "s|^ClientAliveInterval .*$|ClientAliveInterval 15|g" /etc/ssh/sshd_config
  sudo sed -i "s|^ClientAliveCountMax .*$|ClientAliveCountMax 3|g" /etc/ssh/sshd_config
  sudo sed -i "s|^PermitEmptyPasswords .*$|PermitEmptyPasswords no|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*ClientAliveInterval .*$|ClientAliveInterval 15|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*ClientAliveCountMax .*$|ClientAliveCountMax 3|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*PermitEmptyPasswords .*$|PermitEmptyPasswords no|g" /etc/ssh/sshd_config
  sudo sed -i "s/^#DefaultLimitNOFILE.*/DefaultLimitNOFILE=65536:524288/g" /etc/systemd/system.conf
  sudo sed -i "s/^#DefaultLimitNOFILE.*/DefaultLimitNOFILE=65536:524288/g" /etc/systemd/user.conf
  sudo sed -i "s/^DefaultLimitNOFILE.*/DefaultLimitNOFILE=65536:524288/g" /etc/systemd/system.conf
  sudo sed -i "s/^DefaultLimitNOFILE.*/DefaultLimitNOFILE=65536:524288/g" /etc/systemd/user.conf
  sudo grep "* - nofile" /etc/security/limits.conf >/dev/null
  if [ $? -ne 0 ]; then
    echo "* - nofile 65536" | sudo tee -a /etc/security/limits.conf >/dev/null
  fi
  sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target > /dev/null 2>&1

  if [ "$IS_DESKTOP_ENV" = "true" ]; then
    for util in $DESKTOP_APT_LIST; do
      if [[ "$(isProgramInstalled $util)" = "false" ]]; then
        lib_name=$(echo $util | cut -d"|" -f2)
        echo "Installing $lib_name, please wait..."
        performAptInstall $lib_name
      fi
    done
  fi
  installDocker
  for rem_util in $APT_REMOVE_LIST; do
    sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y $rem_util
  done
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y
  set -e
}

function removeBSDMailx()
{
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y bsd-mailx
  sudo tee /etc/apt/preferences.d/bsd-mailx >/dev/null <<EOFSM
Package: bsd-mailx
Pin: release *
Pin-Priority: -1
EOFSM
  sudo apt update > /dev/null 2>&1
}

function installMailUtils()
{
  set +e
  echo "Removing bsd-mailx, please wait..."
  removeBSDMailx
  echo "Installing ssmtp, please wait..."
  performAptInstall ssmtp
  echo "Installing mailx, please wait..."
  performAptInstall mailutils
  sudo tee /etc/ssmtp/ssmtp.conf >/dev/null <<EOFSM
root=$EMAIL_ADMIN_EMAIL_ADDRESS
mailhub=${SUB_POSTFIX}.${HOMESERVER_DOMAIN}:$MAILU_PORT_5
hostname=$(cat /etc/hostname)
TLS_CA_FILE=/etc/ssl/certs/ca-certificates.crt
UseSTARTTLS=yes
FromLineOverride=no
AuthUser=$EMAIL_SMTP_EMAIL_ADDRESS
AuthPass=$EMAIL_SMTP_PASSWORD
EOFSM

  sudo tee /etc/ssmtp/revaliases >/dev/null <<EOFSM
root:$EMAIL_SMTP_EMAIL_ADDRESS
$USERNAME:$EMAIL_SMTP_EMAIL_ADDRESS
EOFSM

  getent group mailsenders >/dev/null || sudo groupadd mailsenders 
  sudo usermod -aG mailsenders $USERNAME
  sudo chown root:mailsenders /usr/bin/mail.mailutils
  sudo update-alternatives --set mailx /usr/bin/mail.mailutils
}

function checkLoadConfig()
{
  set -e
  if ! [ -z "$ENC_CONFIG_FILE" ] && ! [ -f "$ENC_CONFIG_FILE" ]; then
    ENC_CONFIG_FILE=""
  fi
  if [ -z "$CONFIG_FILE" ] || ! [ -f "$CONFIG_FILE" ]; then
    DEF_CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
    if [ -f $DEF_CONFIG_FILE ]; then
      CONFIG_FILE=$DEF_CONFIG_FILE
      ENC_CONFIG_FILE=""
    else
      CONFIG_FILE=""
    fi
  fi
  if [ -z "$ENC_CONFIG_FILE" ] && [ -z "$CONFIG_FILE" ]; then
    if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME ]; then
      ENC_CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
    fi
  fi
  set +e
  if ! [ -z "$ENC_CONFIG_FILE" ]; then
    showYesNoMessageBox "Encrypted Config Found" "Encrypted configuration file found. Do you wish to decrypt it?"
    if [ $? -ne 0 ]; then
      releaseLock hshqopen "checkLoadConfig" false
      exit 1
    fi
    # Prompt for config password, test it.
    # Check if sudo, if not, get it and test it.
    # If either fails, exit.
    confirmUnlockCreds
    if [ $? -ne 0 ]; then
      releaseLock hshqopen "checkLoadConfig" false
      exit 1
    fi
    decryptConfigFile "$ENC_CONFIG_FILE"
    ENC_CONFIG_FILE=""
  fi
  confirmUnlockCreds
  if [ $? -ne 0 ]; then
    releaseLock hshqopen "checkLoadConfig" false
    exit 1
  fi
  set -e
  if ! [ -z "$CONFIG_FILE" ] && [ -f $CONFIG_FILE ]; then
    loadConfigVars true
  fi
}

function confirmUnlockCreds()
{
  set +e
  refreshSudo
  if [ $? -ne 0 ]; then
    return 3
  fi
  if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
    IS_CONFIG_FILE_UNENCRYPTED=true
    return
  fi
  if ! [ -f $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME ]; then
    # Assume this is pre-install, so just return
    return
  fi
  promptTestDecryptConfigFile
  if [ $? -ne 0 ]; then
    return 3
  fi
}

function refreshSudo()
{
  rsu_curE=${-//[^e]/}
  set +e
  if ! [ -z "$USER_SUDO_PW" ]; then
    echo "$USER_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      USER_SUDO_PW=""
    fi
  fi
  while [ -z "$USER_SUDO_PW" ]
  do
    if [ "$IS_CONSOLE_ENV" = "true" ]; then
      USER_SUDO_PW=$(promptPasswordMenu "Enter Password" "Enter the sudo password for $USERNAME: ")
      retVal=$?
      if [ $retVal -ne 0 ]; then
        exit 3
      fi
      echo "$USER_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        showMessageBox "Incorrect Password" "The password is incorrect, please re-enter it."
        USER_SUDO_PW=""
      fi
    else
      echo
      read -r -s -p "Enter the sudo password for $USERNAME: " USER_SUDO_PW
      echo
      echo "$USER_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "The password is incorrect, please re-enter it."
        USER_SUDO_PW=""
      fi
    fi
  done
  if ! [ -z "$rsu_curE" ]; then
    set -e
  fi
}

function checkConfigAvailable()
{
  if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
    IS_CONFIG_FILE_UNENCRYPTED=true
    return
  fi
  if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME ]; then
    ENC_CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
    IS_CONFIG_FILE_UNENCRYPTED=false
    return
  fi
}

function addToDisabledServices()
{
  atds_curE=${-//[^e]/}
  set +e
  dis_svc=$1
  if [ "$DISABLED_SERVICES" = "none" ]; then
    return
  fi
  echo $DISABLED_SERVICES | grep $dis_svc > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    if [ -z "$DISABLED_SERVICES" ]; then
      DISABLED_SERVICES="$dis_svc"
    else
      DISABLED_SERVICES="${DISABLED_SERVICES},$dis_svc"
    fi
    updatePlaintextRootConfigVar DISABLED_SERVICES $DISABLED_SERVICES
  fi
  set +e
  if ! [ -z "$atds_curE" ]; then
    set -e
  fi
}

function initConfig()
{
  if [ "$IS_INSTALLING" = "true" ]; then
    showMessageBox "Active Installation" "There is an active installation in progress, exiting..."
    exit 1
  fi
  if [ "$IS_INSTALLED" = "true" ]; then
    return 0
  fi
  if [[ "$(isProgramInstalled sqlite3)" = "false" ]]; then
    echo "Installing sqlite3, please wait..."
    performAptInstall sqlite3 > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled sipcalc)" = "false" ]]; then
    echo "Installing sipcalc, please wait..."
    performAptInstall sipcalc > /dev/null 2>&1
  fi
  if [ -z "$CONFIG_FILE" ]; then
    # Create new directories and config file
    createInitialEnv
    loadConfigVars true
  fi
  set +e
  if [ -z "$IS_ACCEPT_DEFAULTS" ]; then
    showYesNoMessageBox "Accept Defaults?" "Do you wish to use defaults where applicable?"
    mbres=$?
    if [ $mbres -eq 0 ]; then
      IS_ACCEPT_DEFAULTS=yes
    else
      IS_ACCEPT_DEFAULTS=no
    fi
  fi
  total_ram=$(free --giga | grep "Mem:" | xargs | cut -d" " -f2)
  if [ $total_ram -lt 4 ]; then
    showMessageBox "Insufficient Memory" "Total memory is $total_ram GB. You must have at least 4 GB to perform the installation, exiting..."
    exit 1
  elif [ $total_ram -lt 8 ]; then
    showYesNoMessageBox "Insufficient Memory" "Total memory is $total_ram GB. You should have at least 8 GB to perform the installation. The process could fail or your server could crash. Are you sure you want to continue?"
    mbres=$?
    if [ $mbres -ne 0 ]; then
      exit 1
    fi
  fi
  # Need to allow for docker images already downloaded, so look at total disk space.
  # Obviously 120 != 150, but this allows a little leeway.
  # The partitioning structure could be different than expected, so user can bypass this warning.
  total_disk_space=$(($(df / | tail -1 | xargs | cut -d" " -f2) / 1048576))
  if [ $total_disk_space -lt 11 ]; then
    showMessageBox "Insufficient Disk Space" "You must have at least 16GB of disk space to perform the base installation, exiting..."
    exit 1
  elif [ $total_disk_space -lt 120 ]; then
    showYesNoMessageBox "Insufficient Disk Space" "Total size of disk is $total_disk_space GB. You should have at least 150 GB of available space to perform the installation. The process could fail or your server could crash. Are you sure you want to continue?"
    mbres=$?
    if [ $mbres -ne 0 ]; then
      exit 1
    fi
  fi
  if [[ "$(isProgramInstalled grepcidr)" = "false" ]]; then
    echo "Installing grepcidr, please wait..."
    performAptInstall grepcidr > /dev/null 2>&1
  fi

  is_add_error=false
  default_iface=$(getDefaultIface)
  add_interface=""
  while [ -z "$add_interface" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ] && [ "$is_add_error" = "false" ]; then
      add_interface=$default_iface
    else
      add_interface=$(promptUserInputMenu "$default_iface" "Enter Primary Interface" "Enter the primary network interface. The interface for the default route has been entered for you.")
      if [ $? -ne 0 ]; then
        exit 5
      fi
      if [ -z "$add_interface" ]; then
        showMessageBox "Interface Error" "The interface cannot be empty."
        add_interface=""
        continue
      elif [ $(checkValidStringUpperLowerNumbers "$add_interface" "-") = "false" ]; then
        showMessageBox "Interface Error" "The interface contains invalid characters. It must consist of a-z (upper or lowercase), 0-9, and/or -"
        add_interface=""
        continue
      elif [ $(getStringLength "$add_interface") -gt 15 ]; then
        showMessageBox "Interface Error" "The interface name is too long, it must be 15 characters or less."
        add_interface=""
        continue
      fi
    fi
    set +e
    addHSInterface $add_interface true
    retVal=$?
    if [ $retVal -ne 0 ] && [ $retVal -ne 1 ]; then
      ip_addr=$(getIPAddressOfInterface $add_interface)
      is_private=$(checkIsIPPrivate "$ip_addr")
      chk_subnet=$(getSubnetOfInterface "$add_interface" "$ip_addr" "$is_private")
      if ! [ -z "$chk_subnet" ] && [ "$(checkNetworkIntersect $chk_subnet 10.0.0.0/8)" = "true" ] && [ $(echo "$chk_subnet" | cut -d"/" -f2) -eq 8 ]; then
        showMessageBox "Default Interface Error" "You are using the ENTIRE 10.0.0.0/8 network for your home network - a terribly poor design choice. You will not be able to host a VPN or network with anyone. If you want to bypass these safeguards and proceed, then change your settings in /etc/netplan to a static IP and a smaller network and restart the installation."
        exit 6
      else
        showMessageBox "Default Interface Error" "There was an error with the default interface"
      fi
      add_interface=""
      is_add_error=true
    fi
    set -e
  done

  if [ "$(checkIsIPPrivate $HOMESERVER_HOST_PRIMARY_INTERFACE_IP)" = "false" ]; then
    if [ -z "$CONNECTING_IP" ]; then
      showMessageBox "Error with Connecting IP" "Could not determine connecting IP, exiting..."
      exit 1
    else
      addHomeNetIP ${CONNECTING_IP}/32 false
    fi
  fi

  if [ -z "$USERID" ]; then
    USERID=$(id -u)
    updatePlaintextRootConfigVar USERID $USERID
  fi
  if [ -z "$GROUPID" ]; then
    GROUPID=$(id -g)
    updatePlaintextRootConfigVar GROUPID $GROUPID
  fi
  if [ -z "$XDG_RUNTIME_DIR" ]; then
    XDG_RUNTIME_DIR="/run/user/$USERID"
    updateConfigVar XDG_RUNTIME_DIR $XDG_RUNTIME_DIR
  fi
  if [ -z "$DISABLED_SERVICES" ]; then
    if [ $total_ram -lt 8 ]; then
      DISABLED_SERVICES=$DS_MEM_LOW
    elif [ $total_ram -lt 12 ]; then
      DISABLED_SERVICES=$DS_MEM_12
    elif [ $total_ram -lt 16 ]; then
      DISABLED_SERVICES=$DS_MEM_16
    elif [ $total_ram -lt 22 ]; then
      DISABLED_SERVICES=$DS_MEM_22
    elif [ $total_ram -lt 28 ]; then
      DISABLED_SERVICES=$DS_MEM_28
    else
      DISABLED_SERVICES=$DS_MEM_HIGH
    fi
    updatePlaintextRootConfigVar DISABLED_SERVICES $DISABLED_SERVICES
  fi

  while [ -z "$HOMESERVER_DOMAIN" ]
  do
	HOMESERVER_DOMAIN=$(promptUserInputMenu "" "Enter HomeServer Domain" "Enter your HomeServer domain name, i.e. example.com. You must own this domain to route external emails and/or post services on the public internet: ")
	if [ -z "$HOMESERVER_DOMAIN" ]; then
	  showMessageBox "Domain Empty" "The domain cannot be empty"
    elif [ $(checkValidString "$HOMESERVER_DOMAIN" ".-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The domain contains invalid character(s). It must consist of a-z (lowercase), 0-9, and/or -."
      HOMESERVER_DOMAIN=""
    elif [ $(checkValidBaseDomain "$HOMESERVER_DOMAIN") = "false" ]; then
      showMessageBox "Invalid Domain Name" "Invalid domain name. The base domain must be of the format 'example.com'. It cannot start or end with a period."
      HOMESERVER_DOMAIN=""
    elif [ $(getDomainTLD "$HOMESERVER_DOMAIN") = "test" ]; then
      showMessageBox "Invalid Domain" "The specific TLD .test actually causes some issues. Change it to .tester or something else."
      HOMESERVER_DOMAIN=""
	else
	  updatePlaintextRootConfigVar HOMESERVER_DOMAIN $HOMESERVER_DOMAIN
	fi
  done

  new_hostname="HomeServer-$(echo $HOMESERVER_DOMAIN | sed 's/\./-/g')"
  if [ -z "$(cat /etc/hosts | grep $new_hostname)" ]; then
    echo "127.0.1.1 $new_hostname" | sudo tee -a /etc/hosts
  fi
  sudo hostnamectl set-hostname $new_hostname
  rm -f $HOME/dead.letter

  EXT_DOMAIN_PREFIX=""
  while [ -z "$EXT_DOMAIN_PREFIX" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      EXT_DOMAIN_PREFIX="external"
    else
      EXT_DOMAIN_PREFIX=$(promptUserInputMenu "external" "External Domain Prefix" "Enter the prefix for your domain to be reached externally:")
    fi
	if [ -z "$EXT_DOMAIN_PREFIX" ]; then
	  showMessageBox "Prefix Empty" "The Prefix cannot be empty"
    elif [ $(checkValidString "$EXT_DOMAIN_PREFIX" "-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The prefix contains invalid character(s). It must consist of a-z (lowercase), 0-9, and/or -"
      EXT_DOMAIN_PREFIX=""
	else
	  updatePlaintextRootConfigVar EXT_DOMAIN_PREFIX $EXT_DOMAIN_PREFIX
	fi
  done

  INT_DOMAIN_PREFIX=""
  while [ -z "$INT_DOMAIN_PREFIX" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      INT_DOMAIN_PREFIX="internal"
    else
      INT_DOMAIN_PREFIX=$(promptUserInputMenu "internal" "Internal Domain Prefix" "Enter the prefix for your RelayServer to be reached internally (if applicable):")
    fi
	if [ -z "$INT_DOMAIN_PREFIX" ]; then
	  showMessageBox "Prefix Empty" "The Prefix cannot be empty"
    elif [ $(checkValidString "$INT_DOMAIN_PREFIX" "-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The prefix contains invalid character(s). It must consist of a-z (lowercase), 0-9, and/or -"
      INT_DOMAIN_PREFIX=""
	else
	  updatePlaintextRootConfigVar INT_DOMAIN_PREFIX $INT_DOMAIN_PREFIX
	fi
  done

  while [ -z "$HOMESERVER_NAME" ]
  do
	HOMESERVER_NAME=$(promptUserInputMenu "" "Enter HomeServer Name" "Enter your HomeServer name with desired formatting, i.e. capitalization, spaces, etc. No special characters except for commas, hyphens, or periods. This will appear in window titles, certificates, among other things: ")
	if [ -z "$HOMESERVER_NAME" ]; then
	  showMessageBox "HomeServer Name Empty" "The name cannot be empty"
    elif [ $(checkValidStringUpperLowerNumbers "$HOMESERVER_NAME" "[:space:],.-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The HomeServer name contains invalid character(s)."
      HOMESERVER_NAME=""
	else
	  updatePlaintextRootConfigVar HOMESERVER_NAME "$HOMESERVER_NAME"
	fi
  done
  while [ -z "$HOMESERVER_ABBREV" ]
  do
    HOMESERVER_ABBREV=$(promptUserInputMenu "" "Enter HomeServer Abbrev" "Enter an abbreviation for your HomeServer, 3 to 10 lowercase alpha-numeric characters. This will be used as a default prefix for admin usernames as well as some other uses: ")
    if [ -z "$HOMESERVER_ABBREV" ]; then
      showMessageBox "HomeServer Abbrev Empty" "The abbreviation cannot be empty."
    elif [ $(checkValidString "$HOMESERVER_ABBREV") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The abbreviation contains invalid character(s). It must consist of a-z (lowercase) and/or 0-9"
      HOMESERVER_ABBREV=""
    elif [ ${#HOMESERVER_ABBREV} -lt 3 ] || [ ${#HOMESERVER_ABBREV} -gt 10 ]; then
      showMessageBox "Invalid Length" "The abbreviation must be 3 to 10 characters"
      HOMESERVER_ABBREV=""
    else
      updatePlaintextRootConfigVar HOMESERVER_ABBREV $HOMESERVER_ABBREV
    fi
  done
  priorTZ=$(cat /etc/timezone)
  while [ -z "$TZ" ]
  do
    TZ=$(promptUserInputMenu "$priorTZ" "Enter Time Zone" "Enter your time zone. For a list of all time zones, visit https://en.wikipedia.org/wiki/List_of_tz_database_time_zones and enter the value in the [TZ database name] column: ")
    if [ $? -ne 0 ]; then
      exit 2
    fi
    if [ -z "$TZ" ]; then
      showMessageBox "Time Zone Empty" "The time zone cannot be empty"
    elif [ $(checkValidStringUpperLowerNumbers "$TZ" "/_+-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The timezone contains invalid character(s)."
      TZ=""
    else
      set +e
      sudo timedatectl set-timezone "$TZ" > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        showMessageBox "Invalid Time Zone" "The time zone is invalid. Please enter a valid time zone."
        TZ=""
        sudo timedatectl set-timezone "$priorTZ" > /dev/null 2>&1
      else
        echo "$TZ" | sudo tee /etc/timezone > /dev/null 2>&1
        updatePlaintextRootConfigVar TZ $TZ
      fi
      set -e
    fi
  done

  set +e
  CURRENT_SSH_PORT=$(grep "^Port" /etc/ssh/sshd_config)
  if [ $? -eq 0 ]; then
    CURRENT_SSH_PORT=$(echo $CURRENT_SSH_PORT | cut -d " " -f2)
    if ! [ "$CURRENT_SSH_PORT" = "22" ]; then
      SSH_PORT=$CURRENT_SSH_PORT
      updatePlaintextRootConfigVar SSH_PORT $SSH_PORT
    fi
  else
    CURRENT_SSH_PORT=22
    SSH_PORT=""
  fi
  updatePlaintextRootConfigVar CURRENT_SSH_PORT $CURRENT_SSH_PORT
  while [ -z "$SSH_PORT" ]
  do
    SSH_PORT=$(promptUserInputMenu $((9000 + $RANDOM % 999)) "Enter HomeServer SSH Port" "It is highly advised to change your default SSH port (22), since bots will constantly probe port 22. A random port between 9000-9999 has been generated for you. Ensure you remember this port in order to log back in.")
    if [ -z "$SSH_PORT" ]; then
      showMessageBox "SSH Port Empty" "The SSH port cannot be empty"
    elif [ "$(checkValidNumber $SSH_PORT)" = "false" ]; then
      showMessageBox "Invalid Character(s)" "The port contains invalid character(s). It must be a number."
      SSH_PORT=""
    elif [ $SSH_PORT -eq 22 ]; then
      # No change, we'll allow it
      showMessageBox "Huh" "Okay, whatever...you do you."
      SSH_PORT="22"
      updatePlaintextRootConfigVar SSH_PORT $SSH_PORT
      # Change SSH port on host
      sudo sed -i "s|^#*Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
      sudo sed -i "s|^Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
    elif [ $SSH_PORT -lt 1024 ] || [ $SSH_PORT -gt 65536 ]; then
      showMessageBox "Invalid Character(s)" "The port number is invalid, it must be between 1024-65536."
      SSH_PORT=""
    else
      checkAvailableHomeServerPort $SSH_PORT
      if [ $? -ne 0 ]; then
        showMessageBox "Invalid Port" "The port is invalid. It either conflicts with an existing used port or is less than 1024."
        SSH_PORT=""
      else
        updatePlaintextRootConfigVar SSH_PORT $SSH_PORT
        # Change SSH port on host
        sudo sed -i "s|^#*Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
        sudo sed -i "s|^Port .*$|Port ${SSH_PORT}|g" /etc/ssh/sshd_config
      fi
    fi
  done
  while [ -z "$PORTAINER_LOCAL_HTTPS_PORT" ] || [ "$PORTAINER_LOCAL_HTTPS_PORT" = "$SSH_PORT" ]
  do
    tmp_port=$((9000 + $RANDOM % 999))
    while [ "$tmp_port" = "$SSH_PORT" ]
    do
      tmp_port=$((9000 + $RANDOM % 999))
    done
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      PORTAINER_LOCAL_HTTPS_PORT=$tmp_port
    else
      PORTAINER_LOCAL_HTTPS_PORT=$(promptUserInputMenu $tmp_port "Enter Local Portainer Port" "Enter a local port to use for portainer. A random port between 9000-9999 has been generated for you.")
      if [ -z "$PORTAINER_LOCAL_HTTPS_PORT" ] || [ "$PORTAINER_LOCAL_HTTPS_PORT" = "$SSH_PORT" ]; then
        showMessageBox "Portainer Port Error" "The port cannot be empty or the same as the SSH port"
      elif [ "$(checkValidNumber $PORTAINER_LOCAL_HTTPS_PORT)" = "false" ]; then
        showMessageBox "Invalid Character(s)" "The port contains invalid character(s). It must be a number."
        PORTAINER_LOCAL_HTTPS_PORT=""
      elif [ $PORTAINER_LOCAL_HTTPS_PORT -lt 1024 ] || [ $PORTAINER_LOCAL_HTTPS_PORT -gt 65536 ]; then
        showMessageBox "Invalid Character(s)" "The port number is invalid, it must be between 1024-65536."
        PORTAINER_LOCAL_HTTPS_PORT=""
      fi
      if ! [ -z "$PORTAINER_LOCAL_HTTPS_PORT" ]; then
        checkAvailableHomeServerPort $PORTAINER_LOCAL_HTTPS_PORT
        if [ $? -ne 0 ]; then
          showMessageBox "Invalid Port" "The port is invalid. It either conflicts with an existing used port or is less than 1024."
          PORTAINER_LOCAL_HTTPS_PORT=""
        fi
      fi
    fi
    updatePlaintextRootConfigVar PORTAINER_LOCAL_HTTPS_PORT $PORTAINER_LOCAL_HTTPS_PORT
    DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT=$DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT,$PORTAINER_LOCAL_HTTPS_PORT
    updatePlaintextUserConfigVar DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT $DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT
  done
  set -e
  # Do the boring things that must be done
  while [ -z "$LDAP_PRIMARY_USER_USERNAME" ]
  do
    LDAP_PRIMARY_USER_USERNAME=$(promptUserInputMenu $USERNAME "Enter First User" "Enter the username for your first HomeServer user account: ")
    if [ -z "$LDAP_PRIMARY_USER_USERNAME" ]; then
      showMessageBox "Username Empty" "The username cannot be empty"
    elif [ $(checkValidString "$LDAP_PRIMARY_USER_USERNAME") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The username contains invalid character(s). It must consist of a-z (lowercase) and/or 0-9"
      LDAP_PRIMARY_USER_USERNAME=""
    else
      updateConfigVar LDAP_PRIMARY_USER_USERNAME $LDAP_PRIMARY_USER_USERNAME
      LDAP_PRIMARY_USER_EMAIL_ADDRESS=$LDAP_PRIMARY_USER_USERNAME@$HOMESERVER_DOMAIN
      updateConfigVar LDAP_PRIMARY_USER_EMAIL_ADDRESS $LDAP_PRIMARY_USER_EMAIL_ADDRESS
    fi
  done
  curFullName="$(echo $(getent passwd $USERNAME) | cut -d":" -f5 | cut -d"," -f1)"
  if [ -z "$curFullName" ]; then
    curFullName="${LDAP_PRIMARY_USER_USERNAME^}"
  fi
  while [ -z "$LDAP_PRIMARY_USER_FULLNAME" ]
  do
    LDAP_PRIMARY_USER_FULLNAME=$(promptUserInputMenu "$curFullName" "Enter Full Name" "Enter the full name for your first HomeServer user account: ")
    if [ -z "$LDAP_PRIMARY_USER_FULLNAME" ]; then
      showMessageBox "Name Empty" "The name cannot be empty"
    elif [ $(checkValidStringUpperLowerNumbers "$LDAP_PRIMARY_USER_FULLNAME" "[:space:].,-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The name contains invalid character(s). It must consist of a-z, A-Z, 0-9, spaces, periods, commas, and/or hyphens."
      LDAP_PRIMARY_USER_FULLNAME=""
    else
      updateConfigVar LDAP_PRIMARY_USER_FULLNAME "$LDAP_PRIMARY_USER_FULLNAME"
    fi
  done

  if [ -z "$LDAP_PRIMARY_USER_PASSWORD_HASH" ]; then
    tmp_pw1=""
    tmp_pw2=""
    set +e
    while [ -z "$tmp_pw1" ] || ! [ "$tmp_pw1" = "$tmp_pw2" ]
    do
      tmp_pw1=$(promptPasswordMenu "Create Password" "Create a password for your HomeServer user ($LDAP_PRIMARY_USER_USERNAME) account: ")
      if [ $? -ne 0 ]; then exit; fi
      if [ -z "$tmp_pw1" ]; then
        showMessageBox "Password Empty" "The password cannot be empty, please try again."
        tmp_pw1=abc
        tmp_pw2=def
        continue
      fi
      if [ $(checkValidPassword "$tmp_pw1" 8) = "false" ]; then
        showMessageBox "Password Invalid" "The password is too short or contains invalid characters. It must contain at least 8 characters and consist of uppercase letters, lowercase letters, and numbers. It can only contain the following symbols: ~!@#%^&*()-_+=<>?.,"
        tmp_pw1=abc
        tmp_pw2=def
        continue
      fi
      tmp_pw2=$(promptPasswordMenu "Confirm Password" "Enter the password again to confirm: ")
      if [ $? -ne 0 ]; then exit; fi
      if ! [ "$tmp_pw1" = "$tmp_pw2" ]; then
        showMessageBox "Password Mismatch" "The passwords do not match, please try again."
      fi
    done
    LDAP_PRIMARY_USER_PASSWORD_HASH=$(openssl passwd -6 $tmp_pw1)
    updateConfigVar LDAP_PRIMARY_USER_PASSWORD_HASH $LDAP_PRIMARY_USER_PASSWORD_HASH
    tmp_pw1=""
    tmp_pw2=""
    set -e
  fi

  while [ -z "$ADMIN_USERNAME_BASE" ] || [ "$ADMIN_USERNAME_BASE" = "admin" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      ADMIN_USERNAME_BASE=$HOMESERVER_ABBREV"admin"
    else
      ADMIN_USERNAME_BASE=$(promptUserInputMenu $HOMESERVER_ABBREV"admin" "Enter Admin Base" "Enter the base admin username (it cannot be \"admin\"): ")
    fi
    if [ $(checkValidString "$ADMIN_USERNAME_BASE") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The username contains invalid character(s). It must consist of a-z (lowercase) and/or 0-9"
      ADMIN_USERNAME_BASE=""
    fi
    updatePlaintextRootConfigVar ADMIN_USERNAME_BASE $ADMIN_USERNAME_BASE
  done

  if [[ "$(isProgramInstalled pwgen)" = "false" ]]; then
    echo "Installing pwgen, please wait..."
    performAptInstall pwgen > /dev/null 2>&1
  fi

  while [ -z "$EMAIL_ADMIN_USERNAME" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      EMAIL_ADMIN_USERNAME="mailmanager"
    else
      EMAIL_ADMIN_USERNAME=$(promptUserInputMenu "mailmanager" "Enter Admin Email" "Enter the admin email username: ")
    fi
    if [ $(checkValidString "$EMAIL_ADMIN_USERNAME") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The username contains invalid character(s). It must consist of a-z (lowercase) and/or 0-9"
      EMAIL_ADMIN_USERNAME=""
    fi
    updateConfigVar EMAIL_ADMIN_USERNAME $EMAIL_ADMIN_USERNAME
  done
  initServicesCredentials
}

function initInstallation()
{
  if [[ "$(isProgramInstalled screen)" = "false" ]]; then
    echo "Installing screen, please wait..."
    performAptInstall screen > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled nano)" = "false" ]]; then
    echo "Installing nano, please wait..."
    performAptInstall nano > /dev/null 2>&1
  fi
  # Show info to user and prompt for confirmation
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    rs_wg_user_conf=$(sudo cat $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf)
  fi
  clear
  strInstallConfig=""
  strInstallConfig="${strInstallConfig}################################################################\n"
  strInstallConfig="${strInstallConfig}========================= General Info =========================\n"
  strInstallConfig="${strInstallConfig}- Root CA URL: http://$SUB_FILES.$HOMESERVER_DOMAIN/ca.crt\n"
  strInstallConfig="${strInstallConfig}- Home Page: https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN\n"
  strInstallConfig="${strInstallConfig}- Email Admin Username: $EMAIL_ADMIN_EMAIL_ADDRESS\n"
  strInstallConfig="${strInstallConfig}- Email Admin Password: $EMAIL_ADMIN_PASSWORD\n"
  strInstallConfig="${strInstallConfig}- HomeServer Current SSH Port: $CURRENT_SSH_PORT\n"
  strInstallConfig="${strInstallConfig}- HomeServer New SSH Port: $SSH_PORT\n"
  strInstallConfig="${strInstallConfig}- Portainer IP URL: https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT\n"
  strInstallConfig="${strInstallConfig}- Portainer Username: $PORTAINER_ADMIN_USERNAME\n"
  strInstallConfig="${strInstallConfig}- Portainer Password: $PORTAINER_ADMIN_PASSWORD\n"
  strInstallConfig="${strInstallConfig}- Script-server IP URL: https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT\n"
  strInstallConfig="${strInstallConfig}- Script-server Username: $SCRIPTSERVER_ADMIN_USERNAME\n"
  strInstallConfig="${strInstallConfig}- Script-server Password: $SCRIPTSERVER_ADMIN_PASSWORD\n"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    strInstallConfig="${strInstallConfig}- RelayServer IP Address: $RELAYSERVER_SERVER_IP\n"
    strInstallConfig="${strInstallConfig}- RelayServer Current SSH Port: $RELAYSERVER_CURRENT_SSH_PORT\n"
    strInstallConfig="${strInstallConfig}- RelayServer New SSH Port: $RELAYSERVER_SSH_PORT\n"
    strInstallConfig="${strInstallConfig}- RelayServer Linux Username: $RELAYSERVER_REMOTE_USERNAME\n"
  fi
  strInstallConfig="${strInstallConfig}================================================================\n\n"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    strInstallConfig="${strInstallConfig}$(getDNSRecordsInfo $HOMESERVER_DOMAIN)\n\n"
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    strInstallConfig="${strInstallConfig}================= User WireGuard Configuration =================\n"
    strInstallConfig="${strInstallConfig}""""$rs_wg_user_conf""""\n"
    strInstallConfig="${strInstallConfig}================================================================\n\n"
  fi
  #strInstallConfig="${strInstallConfig}=========================== Root CA ============================\n"
  #strInstallConfig="${strInstallConfig}""""$(cat "$HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt")""""\n"
  #strInstallConfig="${strInstallConfig}================================================================\n"
  strInstallConfig="${strInstallConfig}                      INSTRUCTIONS                     \n"
  strInstallConfig="${strInstallConfig}The system is prepped for installation. It will take around\n"
  strInstallConfig="${strInstallConfig}10-15 minutes to perform the base installation, depending on\n"
  strInstallConfig="${strInstallConfig}hardware specs and download speeds. Copy all of this info\n"
  strInstallConfig="${strInstallConfig}before proceeding. Ensure to scroll to the top and retain\n"
  strInstallConfig="${strInstallConfig}everything between the ##### borders. Simply select the\n"
  strInstallConfig="${strInstallConfig}information with your mouse, and it will automatically be\n"
  strInstallConfig="${strInstallConfig}copied to the clipboard.\n\n"
  strInstallConfig="${strInstallConfig}The process will run continuously uninterrupted in a 'screen'\n"
  strInstallConfig="${strInstallConfig}If you lose connection, then enter 'screen -r hshqInstall' to\n"
  strInstallConfig="${strInstallConfig}resume the screen if you want to continue to view the process.\n"
  strInstallConfig="${strInstallConfig}To exit the screen, press CTRL-a, then release both keys,\n"
  strInstallConfig="${strInstallConfig}then press d to detach.\n\n"
  strInstallConfig="${strInstallConfig}The system will automatically reboot upon completion.\n\n"
  strInstallConfig="${strInstallConfig}If you want to completely remove everything, run the utility\n"
  strInstallConfig="${strInstallConfig}inside this script (System Utils -> Uninstall and Remove\n"
  strInstallConfig="${strInstallConfig}Everything) and follow the prompts. To do the same on the\n"
  strInstallConfig="${strInstallConfig}RelayServer, enter the command 'bash nuke.sh', and follow\n"
  strInstallConfig="${strInstallConfig}the prompts.\n\n"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    strInstallConfig="${strInstallConfig}The installation on the RelayServer will also automatically\n"
    strInstallConfig="${strInstallConfig}be initiated as well. Ensure to log in to the RelayServer\n"
    strInstallConfig="${strInstallConfig}as user ($RELAYSERVER_REMOTE_USERNAME) to monitor the progress of the installation,\n"
    strInstallConfig="${strInstallConfig}by entering the command 'screen -r hshqInstall'.\n\n"
  fi
  strInstallConfig="${strInstallConfig}################################################################\n\n"
  echo -e "${strInstallConfig}"
  while true;
  do
    echo -e "________________________________________________________________________\n"
    if [ "$IS_DESKTOP_ENV" = "true" ]; then
      hdir=/home/$USERNAME/Desktop
      is_keep_config=y
      echo -e "The above information has been saved to your Desktop,"
      echo -e "i.e. $hdir/$HSHQ_INSTALL_NOTES_FILENAME."
    else
      hdir=/home/$USERNAME
      echo -e "Do you want to retain the above information in a file in the home directory,"
      echo -e "i.e. ($hdir/$HSHQ_INSTALL_NOTES_FILENAME)? Note that this"
      echo -e "information is very sensitive and you should delete the file as soon"
      read -r -p "as you are finished with it. Enter 'y' or 'n': " is_keep_config
    fi
    if [ "$is_keep_config" = "y" ]; then
      final_prompt="After reading the above section, enter 'install' or 'exit': "
      rm -f "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "\n" > "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@" >> "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "@@@@@@@@     You should permanently delete this file    @@@@@@@@" >> "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "@@@@@@@@       as soon as you are finished with it      @@@@@@@@" >> "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n\n" >> "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      echo -e "${strInstallConfig}" >> "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      chmod 0400 "$hdir/$HSHQ_INSTALL_NOTES_FILENAME"
      break
    elif [ "$is_keep_config" = "n" ]; then
      final_prompt="After reading/copying the above section, enter 'install' or 'exit': "
      break
    else
      echo "Unknown response, please try again."
    fi
  done
  while true;
  do
    echo -e "\n________________________________________________________________________\n"
    read -r -p "$final_prompt" is_install
    if [ "$is_install" = "install" ]; then
      break
    elif [ "$is_install" = "exit" ]; then
      echo "Exiting..."
      releaseLock hshqopen "initConfig" false
      exit 1
    else
      echo "Unknown response, please try again."
    fi
  done
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "Starting installation on RelayServer..."
    sleep 1
    loadSSHKey
    isRSReady=false
    set +e
    countRSPreRetries=0
    maxRSPreRetries=30
    while true;
    do
      ssh -o 'StrictHostKeyChecking accept-new' -p $RELAYSERVER_CURRENT_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP "sleep 1;if [ -f ~/$RELAYSERVER_NOT_READY_FILE ]; then exit 1; fi"
      if [ $? -eq 0 ]; then
        break
      fi
      if [ $countRSPreRetries -ge $maxRSPreRetries ]; then
        echo "Max retries reached. Something has likely gone wrong with the RelayServer pre-installation script, exiting..."
        exit 2
      fi
      ((countRSPreRetries++))
      echo "($countRSPreRetries of $maxRSPreRetries) RelayServer not ready for installation, sleeping 30 seconds then will retry..."
      sleep 30
    done
    sleep 1
    ssh -p $RELAYSERVER_CURRENT_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP "bash $RS_INSTALL_FRESH_SCRIPT_NAME -s" <<< "$USER_RELAY_SUDO_PW"
    unloadSSHKey
  fi
  set -e
  refreshSudo
  echo "Starting installation on HomeServer..."
  sleep 1
  releaseLock hshqopen "preInstallation" false
  truncate -s 0 $HSHQ_LOG_FILE
  scName=hshqInstall
  initScreen $scName "bash $HSHQ_LIB_SCRIPT install $CONNECTING_IP"
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There was a problem starting the installation, exiting..."
    exit 1
  fi
  screen -r $scName
  exit 0
}

function setSudoTimeoutInstall()
{
  sudo tee $HOME/$SUDO_LONG_TIMEOUT_FILENAME >/dev/null <<EOFSU
Defaults timestamp_timeout=$SUDO_LONG_TIMEOUT
EOFSU
  sudo chmod 0600 $HOME/$SUDO_LONG_TIMEOUT_FILENAME
  sudo mv $HOME/$SUDO_LONG_TIMEOUT_FILENAME /etc/sudoers.d/
}

function removeSudoTimeoutInstall()
{
  sudo rm -f /etc/sudoers.d/$SUDO_LONG_TIMEOUT_FILENAME
}

function performBaseInstallation()
{
  checkRes="$(acquireAllLocks)"
  if ! [ -z "$checkRes" ]; then
    strErr="performBaseInstallation - The HSHQ script is already open or running in a different instance ($checkRes). If you are certain that it is not, then please remove the directories: /tmp/hshqopen and /tmp/networkchecks, then restart the installation."
    logHSHQEvent error "$strErr"
    echo "$strErr"
    exit 7
  fi
  set +e
  checkLoadConfig
  setSudoTimeoutInstall
  if [ "$IS_INSTALLED" = "true" ] || [ "$IS_INSTALLING" = "true" ]; then
    strErr="performBaseInstallation - Already installed or existing installation is in progress, exiting..."
    logHSHQEvent error "$strErr"
    echo "$strErr"
    exit 1
  fi
  IS_INSTALLING=true
  setSystemState $SS_INSTALLING
  updateConfigVar IS_INSTALLING $IS_INSTALLING
  set +e
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y
  set -e
  outputScripts
  echo "Setting MOTD..."
  updateMOTD
  performSuggestedSecUpdates
  logHSHQEvent info "performBaseInstallation - Install Dependencies"
  installMailUtils
  installDependencies
  clear
  echo -e "\n\n##########################################"
  echo -e "     Starting Base HSHQ Installation"
  echo -e "##########################################\n\n"
  enable_trapping
  setup_scroll_area
  is_draw_pb=true
  draw_progress_bar 0
  set +e
  performClearIPTables true
  checkUpdateAllIPTables performBaseInstallation-Early
  set -e
  draw_progress_bar 5
  pullBaseServicesDockerImages
  draw_progress_bar 50
  logHSHQEvent info "performBaseInstallation - Init DH Params"
  initDHParams
  draw_progress_bar 53
  getUpdateAssets
  draw_progress_bar 55
  logHSHQEvent info "performBaseInstallation - Starting Stack Installs"
  installBaseStacks
  draw_progress_bar 80
  set +e
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
      logHSHQEvent info "performBaseInstallation - Configure Docker WireGuard Network"
      connectPrimaryInternet
    elif [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
      dns_file=$HOME/dns.tmp
      if [ -f $dns_file ]; then
        docker container stop heimdall >/dev/null
        updateHomeServerDNS $dns_file
        rm -f $dns_file
        docker container start heimdall >/dev/null
      fi
    fi
    draw_progress_bar 81
    logHSHQEvent info "performBaseInstallation - Connect Services To VPN"
    connectPrimaryVPN true
    draw_progress_bar 83
    echo "Waiting 30s for services to initialize..."
    sleep 30
  fi
  draw_progress_bar 85
  clearQueryLogAndStatsAdguardHS
  set +e
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    curl https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      clearQueryLogAndStatsAdguardRS
    fi
  fi
  set -e
  logHSHQEvent info "performBaseInstallation - Post Installation"
  draw_progress_bar 86
  checkUpdateAllIPTables performBaseInstallation-Late
  set -e
  draw_progress_bar 88
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y avahi-daemon > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y avahi-autoipd > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove --purge -y
  draw_progress_bar 90
  postInstallation
}

function trustDesktopIcon()
{
  set +e
  dtIcon=$1
  which gio > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    gio set $HOME/Desktop/$dtIcon metadata::trusted true > /dev/null 2>&1
    gio set -t string $HOME/Desktop/$dtIcon metadata::xfce-exe-checksum "$(sha256sum $HOME/Desktop/$dtIcon | awk '{print $1}')" > /dev/null 2>&1
    dbus-launch --exit-with-session gio set $HOME/Desktop/$dtIcon metadata::trusted true > /dev/null 2>&1
    dbus-launch --exit-with-session gio set -t string $HOME/Desktop/$dtIcon metadata::xfce-exe-checksum "$(sha256sum $HOME/Desktop/$dtIcon | awk '{print $1}')" > /dev/null 2>&1
    nautilus -q > /dev/null 2>&1
  fi
}

function postInstallation()
{
  refreshSudo
  echo "Performing post-installation tasks..."
  echo "Emailing Root CA..."
  sendRootCAEmail true
  draw_progress_bar 91
  emailFormattedCredentials
  draw_progress_bar 93
  # Need to wait until emails have been sent before changing permissions.
  sudo chmod 750 /usr/bin/mail.mailutils
  draw_progress_bar 95
  sudo rm -f /etc/skel/hshq.sh
  IS_INSTALLED=true
  updateConfigVar IS_INSTALLED $IS_INSTALLED
  IS_INSTALLING=false
  updateConfigVar IS_INSTALLING $IS_INSTALLING
  if [ "$IS_DESKTOP_ENV" = "true" ]; then
    echo "Configuring Desktop environment..."
    set +e
    rm -f ~/Desktop/InstallHSHQ.desktop
    sudo rm -f /usr/share/applications/InstallHSHQ.desktop
    if ! [ -f /usr/share/icons/HSHQ/Homepage.png ]; then
      sudo cp /usr/share/icons/HSHQ/HomepageHSHQ.png /usr/share/icons/HSHQ/Homepage.png
    fi
    rm -f ~/Desktop/HomePage.desktop
    cat <<EOFHP > ~/Desktop/HomePage.desktop
[Desktop Entry]
Name=$HOMESERVER_NAME
Exec=firefox $SUB_HSHQHOME.$HOMESERVER_DOMAIN
Comment=Opens your HomeServer home page
Terminal=false
Icon=/usr/share/icons/HSHQ/Homepage.png
Type=Application
Categories=HomeServerHQ
EOFHP
    chmod 755 ~/Desktop/HomePage.desktop
    rm -f ~/Desktop/HSHQConsole.desktop
    which terminator > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      # Specify terminator as console if possible
      cat <<EOFHP > ~/Desktop/HSHQConsole.desktop
[Desktop Entry]
Name=HSHQ Console Util
Exec=/usr/bin/terminator -x bash -ic "~/hshq.sh"
Comment=Runs the HSHQ console-based management utility
Icon=/usr/share/icons/HSHQ/ConsoleHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    else
      cat <<EOFHP > ~/Desktop/HSHQConsole.desktop
[Desktop Entry]
Name=HSHQ Console Util
Exec=bash -ic "~/hshq.sh"
Terminal=true
Comment=Runs the HSHQ console-based management utility
Icon=/usr/share/icons/HSHQ/ConsoleHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    fi
    chmod 755 ~/Desktop/HSHQConsole.desktop
    rm -f ~/Desktop/HSHQScriptServer.desktop
    cat <<EOFHP > ~/Desktop/HSHQScriptServer.desktop
[Desktop Entry]
Name=HSHQ Web Util
Exec=firefox https://127.0.0.1:$SCRIPTSERVER_LOCALHOST_PORT
Comment=Runs the HSHQ web-based management utility
Terminal=false
Icon=/usr/share/icons/HSHQ/ScriptServerHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    chmod 755 ~/Desktop/HSHQScriptServer.desktop
    rm -f ~/Desktop/HSHQHelp.desktop
    cat <<EOFHP > ~/Desktop/HSHQHelp.desktop
[Desktop Entry]
Name=Help!
Exec=firefox forum.homeserverhq.com
Comment=Ask for help on the HomeServerHQ Forum
Terminal=false
Icon=/usr/share/icons/HSHQ/HelpHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    chmod 755 ~/Desktop/HSHQHelp.desktop
    trustDesktopIcon "HomePage.desktop"
    trustDesktopIcon "HSHQConsole.desktop"
    trustDesktopIcon "HSHQScriptServer.desktop"
    trustDesktopIcon "HSHQHelp.desktop"
    sudo mkdir -p /usr/share/applications
    sudo cp -f ~/Desktop/HomePage.desktop /usr/share/applications/
    sudo cp -f ~/Desktop/HSHQConsole.desktop /usr/share/applications/
    sudo cp -f ~/Desktop/HSHQScriptServer.desktop /usr/share/applications/
    sudo cp -f ~/Desktop/HSHQHelp.desktop /usr/share/applications/
    draw_progress_bar 96
    which gsettings > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      # Spell check doesn't belong in a basic text editor,
      # especially if it's insanely intrusive.
      gsettings set org.gnome.TextEditor spellcheck false > /dev/null 2>&1
      # Just because
      gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark' > /dev/null 2>&1
    fi
    draw_progress_bar 97
    addRootCertificateToApps
    draw_progress_bar 98
    configureFirefox
    set -e
  fi
  draw_progress_bar 99
  initCronJobs
  encryptConfigFile
  draw_progress_bar 100
  destroy_scroll_area
  releaseLock hshqopen "postInstallation" false
  removeSudoTimeoutInstall
  rm -f ~/dead.letter
  rm -f $HSHQ_BASE_DIR/cip.txt
  sanitizeHSHQLog
  setSystemState $SS_RUNNING
  echo -e "\n\n\n\n################################################################\n"
  echo "               HomeServer Installation Complete!"
  echo "     The system will automatically reboot in 60 seconds..."
  echo -e "\n################################################################\n\n"
  sleep 60
  logHSHQEvent info "postInstallation - Rebooting"
  sudo reboot
}

function sanitizeHSHQLog()
{
  sudo sed -i 's/\x1b//g' $HSHQ_LOG_FILE
  sudo sed -i 's/\^//g' $HSHQ_LOG_FILE
  sudo sed -i 's/\x1b//g' $HSHQ_LOG_FILE
  sudo sed -i "s|$USERNAME|hshquser|g" $HSHQ_LOG_FILE
  sudo sed -i "s|$LDAP_PRIMARY_USER_USERNAME|hshquser|g" $HSHQ_LOG_FILE
  sudo sed -i "s|$LDAP_ADMIN_USER_USERNAME|hshqadmin|g" $HSHQ_LOG_FILE
  sudo sed -i "s|$HOMESERVER_DOMAIN|hshqexample.com|g" $HSHQ_LOG_FILE
}

function showSimpleBackupMenu()
{
  set +e
  utilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$utilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Configure Backup" \
  "2" "Mount Existing Backup Disk" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    0)
	  return 1 ;;
    1)
      showConfigureSimpleBackupMenu
      return 1 ;;
    2)
      showMountBackupDriveMenu
      return 1 ;;
    3)
	  return 0 ;;
  esac
}

function showConfigureSimpleBackupMenu()
{
  set +e
  showYesNoMessageBox "Continue?" "This is a very basic utility to set up your local encrypted backup. It will search for any unmounted disks and prompt you with a list. After making your selection and confirming, it will wipe all data and partitions on that disk, create a single partition, automount the filesystem on boot, then configure your backup in Duplicati for this disk. There are infinite ways you can configure your backup, and infinite tools to accomplish it. This utility is merely one simple way. If you decide to manually set up your own backup process, the directory you need to focus on is $HSHQ_DATA_DIR. The full system can be restored from the contents of this directory. Do you wish to continue?"
  if [ $? -ne 0 ]; then
    return
  fi
  sudo cat /etc/fstab | grep $HSHQ_BACKUP_DIR > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a filesystem mounted to $HSHQ_BACKUP_DIR in /etc/fstab. Please unmount this filesystem and remove it from /etc/fstab, returning..."
    return
  fi
  sudo findmnt | grep $HSHQ_BACKUP_DIR > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a filesystem mounted to $HSHQ_BACKUP_DIR. Please unmount this filesystem first, returning..."
    return
  fi
  chkfstab=$(sudo findmnt --verify 2> /dev/null)
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There is an error with /etc/fstab: ${chkfstab}\nPlease fix this issue and retry."
    return
  fi
  if ! [ -f $HSHQ_STACKS_DIR/duplicati/config/Duplicati-server.sqlite ]; then
    showMessageBox "ERROR" "Could not find the Duplicati database, returning..."
    return
  fi
  sudo sqlite3 $HSHQ_STACKS_DIR/duplicati/config/Duplicati-server.sqlite "select TargetURL from Backup;" | grep /backups/ > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a backup in Duplicati that uses the /backups directory, returning..."
    return
  fi
  dtok="$(getDuplicatiToken)"
  if [ -z "$dtok" ]; then
    showMessageBox "ERROR" "The Duplicati auth token is empty, returning..."
    return
  fi
  dbackmenu=$(cat << EOF

$(getLogo)
EOF
)
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  diskarr=($(sudo hwinfo --disk --short | tail +2))
  curListNum=1
  scsbm_menu_items=( --title "Select Disk" --radiolist "$dbackmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT )
  for curDisk in "${diskarr[@]}"
  do
    curDiskID=$(echo "$curDisk" | xargs | cut -d" " -f1)
    curDiskName=$(echo "$curDisk" | xargs | cut -d" " -f2-)
    findmnt | grep $curDiskID > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      continue
    fi
    curDiskSize=$(lsblk -o SIZE --noheadings --raw -d $curDiskID)
    curDiskParts=$(sudo partx -g $curDiskID 2> /dev/null | wc -l)
    scsbm_menu_items+=( "$curDiskID  $curDiskSize  ($curDiskParts Partitions)  $curDiskName" )
    scsbm_menu_items+=( "|" )
    scsbm_menu_items+=( "off" )
    ((curListNum++))
  done
  IFS=$OLDIFS
  if [ $curListNum -le 1 ]; then
    showMessageBox "ERROR" "There are no available disks for this operation, returning..."
    return
  fi
  while true
  do
    selDiskItem=$(whiptail "${scsbm_menu_items[@]}" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
      return
    fi
    if [ -z "$selDiskItem" ]; then
      showMessageBox "ERROR" "You did not make a selection, press spacebar on your desired option. Please try again."
    else
      break
    fi
  done
  selDisk=$(echo "$selDiskItem" | cut -d" " -f1)
  if [ -z "$selDisk" ]; then
    showMessageBox "ERROR" "No disk was selected, returning..."
    return
  fi
  confirmFormat=$(promptUserInputMenu "" "Confirm Format" "WARNING - This operation will entirely ERASE the contents of the selected drive. To confirm, enter the word 'format' below:")
  if [ $? -ne 0 ]; then
    return
  fi
  if [ $? -ne 0 ] || [ -z "$confirmFormat" ] || ! [ "$confirmFormat" = "format" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  while true;
  do
    backupHour=$(promptUserInputMenu "" "Daily Backup Time" "Enter the hour of the day(0-23) that you wish to perform the daily backup. This can be modified later in Duplicati:")
    if [ $? -ne 0 ]; then
      return
    fi
    if [[ $backupHour =~ ^[0-9]+$ ]] && [ $backupHour -ge 0 ] && [ $backupHour -le 23 ]; then
      break
    else
      showMessageBox "Invalid Number" "The value is not a valid number."
    fi
  done

  tmp_pw1=""
  tmp_pw2=""
  while [ -z "$tmp_pw1" ] || ! [ "$tmp_pw1" = "$tmp_pw2" ]
  do
    tmp_pw1=$(promptPasswordMenu "Create Password" "Create a password to encrypt/decrypt your backup files. ENSURE you remember this or you will be IRREVERSIBLY locked out of your backup files (unless you have a quantum super-computer) and you will NOT be able to recover your data: ")
    if [ $? -ne 0 ]; then
      return
    fi
    if [ -z "$tmp_pw1" ]; then
      showMessageBox "Password Empty" "The password cannot be empty, please try again."
      continue
    fi
    if [ $(checkValidPassword "$tmp_pw1" 16) = "false" ]; then
      showMessageBox "Weak Password" "The password is invalid or is too weak. It must contain at least 16 characters and consist of uppercase letters, lowercase letters, and numbers. It can only contain the following symbols: ~!@#%^&*()-_+=<>?.,"
      tmp_pw1=""
      tmp_pw2=""
      continue
    fi
    tmp_pw2=$(promptPasswordMenu "Confirm Password" "Enter the password again to confirm: ")
    if [ $? -ne 0 ]; then
      return
    fi
    if ! [ "$tmp_pw1" = "$tmp_pw2" ]; then
      showMessageBox "Password Mismatch" "The passwords do not match, please try again."
    fi
  done
  backupPW="$tmp_pw1"
  tmp_pw1=""
  tmp_pw2=""
  confirmFinal=$(promptUserInputMenu "" "Confirm" "The backup configuration is ready. To perform all actions, including erasing and formatting the selected disk, enter the word 'confirm' below:")
  if [ $? -ne 0 ] || [ -z "$confirmFinal" ] || ! [ "$confirmFinal" = "confirm" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  docker container stop duplicati > /dev/null 2>&1
  docker container stop syncthing > /dev/null 2>&1
  sudo sfdisk --delete $selDisk > /dev/null
  retV=$?
  if [ $retV -ne 0 ] && [ $retV -ne 1 ]; then
    docker container start duplicati > /dev/null 2>&1
    docker container start syncthing > /dev/null 2>&1
    showMessageBox "ERROR" "Encountered an error attempting to delete the partitions from the disk, exiting..."
    return
  fi
  # A little sleep never hurts
  sleep 1
  echo ';' | sudo sfdisk $selDisk > /dev/null
  if [ $? -ne 0 ]; then
    docker container start duplicati > /dev/null 2>&1
    docker container start syncthing > /dev/null 2>&1
    showMessageBox "ERROR" "Encountered an error attempting to create the new partition, exiting..."
    return
  fi
  sleep 1
  newPart=$(sudo fdisk -l $selDisk | grep '^/dev' | cut -d' ' -f1)
  sleep 1
  sudo mkfs -F -t ext4 $newPart > /dev/null
  if [ $? -ne 0 ]; then
    docker container start duplicati > /dev/null 2>&1
    docker container start syncthing > /dev/null 2>&1
    showMessageBox "ERROR" "Encountered an error attempting to create the new filesystem, exiting..."
    return
  fi
  sleep 1
  sudo mount $newPart $HSHQ_BACKUP_DIR > /dev/null
  if [ $? -ne 0 ]; then
    docker container start duplicati > /dev/null 2>&1
    docker container start syncthing > /dev/null 2>&1
    showMessageBox "ERROR" "Encountered an error attempting to mount the filesystem, exiting..."
    return
  fi
  sleep 1
  sudo mkdir $HSHQ_BACKUP_DIR/$HOMESERVER_DOMAIN
  docker container start duplicati > /dev/null 2>&1
  docker container start syncthing > /dev/null 2>&1
  newPartID=$(sudo blkid -s UUID -o value $newPart)
  sudo cp /etc/fstab /etc/fstab.old
  echo "# Backup Drive" | sudo tee -a /etc/fstab > /dev/null 2>&1
  if [ -z "$newPartID" ]; then
    echo "$newPart $HSHQ_BACKUP_DIR ext4 defaults 0 0" | sudo tee -a /etc/fstab > /dev/null 2>&1
  else
    echo "UUID=$newPartID $HSHQ_BACKUP_DIR ext4 defaults 0 0" | sudo tee -a /etc/fstab > /dev/null 2>&1
  fi
  sudo systemctl daemon-reload > /dev/null 2>&1
  sudo findmnt --verify | grep "Success, no errors or warnings detected" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There was a problem adding the requisite entry to /etc/fstab. Your backup disk will not be auto-mounted after a reboot."
    sudo mv /etc/fstab.old /etc/fstab
  else
    sudo rm -f /etc/fstab.old
  fi
  mydate=$(date --date="$(date +%Y-%m-%d) $backupHour:00")
  dtnow=$(date)
  if [ $(($(date -d "$dtnow" +%s) - $(date -d "$mydate" +%s))) -gt 0 ]; then
    mydate=$(date -d "$mydate + 1 day")
  fi
  utcdate=$(TZ="UTC" date --date="$mydate")
  cat <<EOFBU > $HOME/hshq-backup.json
{
  "CreatedByVersion": "2.0.7.1",
  "Schedule": {
    "Time": "$(TZ="UTC" date --date="$utcdate" +%FT%TZ)",
    "Repeat": "1D",
    "LastRun": "0001-01-01T05:51:00Z",
    "Rule": "AllowedWeekDays=Monday,Tuesday,Wednesday,Thursday,Friday,Saturday,Sunday",
    "AllowedDays": [
      "mon",
      "tue",
      "wed",
      "thu",
      "fri",
      "sat",
      "sun"
    ]
  },
  "Backup": {
    "Name": "HSHQ Backup",
    "Description": "",
    "Tags": [],
    "TargetURL": "file:///backups/$HOMESERVER_DOMAIN",
    "Sources": [
      "/source/"
    ],
    "Settings": [
      {
        "Filter": "",
        "Name": "encryption-module",
        "Value": "aes",
        "Argument": null
      },
      {
        "Filter": "",
        "Name": "compression-module",
        "Value": "zip",
        "Argument": null
      },
      {
        "Filter": "",
        "Name": "dblock-size",
        "Value": "50mb",
        "Argument": null
      },
      {
        "Filter": "",
        "Name": "passphrase",
        "Value": "$backupPW",
        "Argument": null
      },
      {
        "Filter": "",
        "Name": "retention-policy",
        "Value": "1W:1D,4W:1W,12M:1M",
        "Argument": null
      },
      {
        "Filter": "",
        "Name": "--ignore-advisory-locking",
        "Value": "true",
        "Argument": null
      }
    ],
    "Filters": [],
    "Metadata": {},
    "IsTemporary": false
  },
  "DisplayNames": {
    "/source/": "source"
  }
}
EOFBU
  sleep 3
  echo "Getting Duplicati auth token..."
  dtok="$(getDuplicatiToken)"
  if [ -z "$dtok" ]; then
    showMessageBox "ERROR" "ERROR: The Duplicati auth token is empty, returning..."
  else
    echo "Got token, importing backup configuration..."
  fi
  http --check-status --ignore-stdin POST https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN/api/v1/backups "Authorization: Bearer $dtok" @$HOME/hshq-backup.json > /dev/null 2>&1
  #docker exec duplicati bash -c "mono /app/duplicati/Duplicati.CommandLine.ConfigurationImporter.exe /config/hshq-backup.json --import-metadata=false --server-datafolder=/config"
  uplRetval=$?
  sudo rm -f $HOME/hshq-backup.json
  if [ $uplRetval -ne 0 ]; then
    showMessageBox "ERROR" "ERROR: The backup job was not uploaded to Duplicati. Please report this error on Github or the Forum."
  else
    showMessageBox "SUCCESS" "Your backup is configured. It will run automatically starting at $mydate, or you can trigger it manually. You will recieve a daily email in your admin email account ($EMAIL_ADMIN_EMAIL_ADDRESS) after each backup. You can view/edit the configuration in https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN ."
  fi
}

function getDuplicatiToken()
{
  maxDupTries=10
  curDupTries=0
  isSuccess=false
  dupToken=""
  while [ $curDupTries -lt $maxDupTries ]
  do
    dupToken=$(http --check-status --ignore-stdin --timeout=300 https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN/api/v1/auth/login password=$DUPLICATI_ADMIN_PASSWORD | jq -r .AccessToken)
    if [ $? -eq 0 ] && ! [ -z "$dupToken" ]; then
      isSuccess=true
      break
    fi
    ((curDupTries++))
    sleep 3
  done
  if [ "$isSuccess" = "true" ]; then
    echo "$dupToken"
  fi
}

function showMountBackupDriveMenu()
{
  findmnt | grep $HSHQ_BACKUP_DIR > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a filesystem mounted to $HSHQ_BACKUP_DIR. Please unmount this filesystem first, returning..."
    return
  fi
  sudo cat /etc/fstab | grep $HSHQ_BACKUP_DIR > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    showMessageBox "ERROR" "There is already a filesystem mounted to $HSHQ_BACKUP_DIR in /etc/fstab. Please unmount this filesystem and remove it from /etc/fstab, returning..."
    return
  fi
  mkdir -p $HSHQ_BACKUP_DIR
  if ! [ -z "$(ls -A $HSHQ_BACKUP_DIR)" ]; then
    showMessageBox "ERROR" "The backup directory ($HSHQ_BACKUP_DIR) is not empty, returning..."
    return
  fi

  dbackmenu=$(cat << EOF

$(getLogo)
EOF
)
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  diskarr=($(sudo hwinfo --disk --short | tail +2))
  curListNum=1
  scsbm_menu_items=( --title "Select Disk/Partition" --radiolist "$dbackmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT )
  for curDisk in "${diskarr[@]}"
  do
    curDiskID=$(echo "$curDisk" | xargs | cut -d" " -f1)
    curDiskName=$(echo "$curDisk" | xargs | cut -d" " -f2-)
    findmnt | grep $curDiskID > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      continue
    fi
    curDiskPartitions=($(lsblk --noheadings --raw -o NAME,SIZE,TYPE $curDiskID))
    for curDiskPart in "${curDiskPartitions[@]}"
    do
      curDiskPartName=$(echo $curDiskPart | cut -d" " -f1)
      curDiskPartSize=$(echo $curDiskPart | cut -d" " -f2)
      curDiskPartType=$(echo $curDiskPart | cut -d" " -f3)
      if [ "$curDiskPartType" = "part" ]; then
        scsbm_menu_items+=( "$curDiskPartName  $curDiskPartSize  ($curDiskName)" )
        scsbm_menu_items+=( "|" )
        scsbm_menu_items+=( "off" )
        ((curListNum++))
      fi
    done
  done
  IFS=$OLDIFS

  if [ $curListNum -le 1 ]; then
    showMessageBox "ERROR" "There are no available disks for this operation, returning..."
    return
  fi
  while true
  do
    selDiskItem=$(whiptail "${scsbm_menu_items[@]}" 3>&1 1>&2 2>&3)
    if [ $? -ne 0 ]; then
      return
    fi
    if [ -z "$selDiskItem" ]; then
      showMessageBox "ERROR" "You did not make a selection, please try again."
    else
      break
    fi
  done
  selDisk=$(echo "$selDiskItem" | cut -d" " -f1)
  if [ -z "$selDisk" ]; then
    showMessageBox "ERROR" "No partition was selected, returning..."
    return
  fi
  sudo mount /dev/$selDisk $HSHQ_BACKUP_DIR
  if [ $? -ne 0 ]; then
    showMessageBox "ERROR" "There was an error mounting this partition, returning..."
    return
  fi
  newPart=/dev/$selDisk
  newPartID=$(sudo blkid -s UUID -o value $newPart)
  sudo cp /etc/fstab /etc/fstab.old
  echo "# Backup Drive" | sudo tee -a /etc/fstab > /dev/null 2>&1
  if [ -z "$newPartID" ]; then
    echo "$newPart $HSHQ_BACKUP_DIR ext4 defaults 0 0" | sudo tee -a /etc/fstab > /dev/null 2>&1
  else
    echo "UUID=$newPartID $HSHQ_BACKUP_DIR ext4 defaults 0 0" | sudo tee -a /etc/fstab > /dev/null 2>&1
  fi
  sudo findmnt --verify | grep "Success, no errors or warnings detected" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo mv /etc/fstab.old /etc/fstab
    showMessageBox "ERROR" "There was a problem adding the requisite entry to /etc/fstab. Your backup disk will not be auto-mounted after a reboot."
  else
    sudo rm -f /etc/fstab.old
  fi
}

function initScreen()
{
  # This function may appear to be overly complex and
  # contrived, but the main purpose is to inject the
  # super-user (sudo) password into the running screen
  # with as minimal of a security footprint as possible.
  # There's also some race conditions to overcome, hence
  # the added complexity. This method avoids anything
  # (long-running) from showing up in the process list
  # (ps auxwwe).
  screenName="$1"
  screenCmd="$2"
  set +e
  dirtest1=/tmp/sctest1
  isScreenSuccess=false
  curScreenAttempt=0
  maxScreenAttempt=5
  screen -XS $screenName quit > /dev/null 2>&1
  # The screen utility has a problem with stuffing
  # special characters in strings, specifically
  # in this case when trying to inject the sudo
  # password. Thus, the easiest way to handle this 
  # is to create a temporary "safe" key, output
  # the encrypted password to file using the key
  # and transmit the key to the screen session.
  sudoPWKey=$(pwgen -c -n 32 1)
  echo -n "$USER_SUDO_PW" | openssl enc -e -aes256 -pbkdf2 -pass pass:$sudoPWKey > $ENC_PW_FILE
  while [ $curScreenAttempt -lt $maxScreenAttempt ]
  do
    ((curScreenAttempt++))
    rm -fr $dirtest1
    screen -L -Logfile $HSHQ_LOG_FILE -dmS $screenName
    screen -S $screenName -X stuff "stty -echo;mkdir $dirtest1\n"
    curCheckCount=0
    while ! [ -d $dirtest1 ] && [ $curCheckCount -lt 5 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    if ! [ -d $dirtest1 ]; then
      screen -XS $screenName quit > /dev/null 2>&1
      continue
    fi
    screen -S $screenName -X stuff "$screenCmd\n"
    curCheckCount=0
    while ! [ -d $TMP_PW_CHECKDIR ] && [ $curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    screen -S $screenName -X stuff "$sudoPWKey\n"
    curCheckCount=0
    while [ -d $TMP_PW_CHECKDIR ] && [ $curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    rm -fr $dirtest1
    if [ -d $TMP_PW_CHECKDIR ]; then
      rm -fr $TMP_PW_CHECKDIR
      echo "The sudo password was not correctly transmitted to the screen session, exiting..."
      exit 5
    fi
    rm -fr $TMP_PW_CHECKDIR
    isScreenSuccess=true
    break
  done
  if ! [ "$isScreenSuccess" = "true" ]; then
    return 1
  fi
}

# Stacks Functions
function showStacksMenu()
{
  set +e
  if ! [ "$IS_INSTALLED" = "true" ]; then
    showMessageBox "System Not Installed" "You must perform a system installation first before using this utility."
    exit
  fi
  svcsmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$svcsmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Install Service(s) From List" \
  "2" "Install All Available Services" \
  "3" "Update Service(s) From List" \
  "4" "Update All Available Services" \
  "5" "Remove Service(s) From List" \
  "6" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    0)
	  return 0 ;;
    1)
      installStacksFromList
      set +e
      return 1 ;;
    2)
      installAllAvailableStacks true
      set +e
      return 1 ;;
    3)
      performStackUpdatesFromList
      set +e
      return 1 ;;
    4)
      performAllAvailableStackUpdates true
      set +e
      return 1 ;;
    5)
      deleteStacksFromList
      set +e
      return 1 ;;
    6)
	  return 0 ;;
  esac
}

function installStacksFromList()
{
  set +e
  setSystemState $SS_INSTALLING
  sortedStackList=$(sortCSVList $HSHQ_OPTIONAL_STACKS)
  stackListArr=($(echo $sortedStackList | tr "," "\n"))
  menu_items=""
  for curStack in "${stackListArr[@]}"
  do
    if ! [ -d $HSHQ_STACKS_DIR/$curStack ]; then
      menu_items=${menu_items}"$curStack | OFF "
    fi
  done
  if [ -z "$menu_items" ]; then
    showMessageBox "No Available Services" "There are no available services to install."
    return
  fi
  selsvcsmenu=$(cat << EOF

$(getLogo)
Select the services that you wish to install:

EOF
  )
  sel_svcs=($(whiptail --title "Select Services" --checklist "$selsvcsmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  if [ -z "$sel_svcs" ]; then
    showMessageBox "Empty Selection" "You have not selected anything, returning to main menu..."
    return 0
  fi
  #showYesNoMessageBox "Perform Integration?" "Do you want to automatically integrate these services, i.e. within Caddy, Heimdall, UptimeKuma, etc.?"
  is_integrate=true
  #if [ $? -eq 0 ]; then
  #  is_integrate=true
  #else
  #  is_integrate=false
  #fi
  showYesNoMessageBox "Confirm Installation" "This selected service(s) will be installed, Continue?"
  if [ $? -ne 0 ]; then
    return
  fi
  setSudoTimeoutInstall
  getUpdateAssets
  for cur_svc in "${sel_svcs[@]}"
  do
    installStackByName ${cur_svc//\"} $is_integrate
  done
  removeSudoTimeoutInstall
  outputStackListsScriptServer
  setSystemState $SS_RUNNING
}

function installListOfServices()
{
  echo "Installing list of services, Start time: $(date '+%Y-%m-%d %H:%M:%S')"
  setSystemState $SS_INSTALLING
  stackListArr=($(echo "$1" | tr "," "\n"))
  setSudoTimeoutInstall
  getUpdateAssets
  for curStack in "${stackListArr[@]}"
  do
    installStackByName $curStack true
  done
  sudo systemctl daemon-reload
  sudo systemctl restart ntp
  docker container restart authelia > /dev/null 2>&1
  removeSudoTimeoutInstall
  outputStackListsScriptServer
  setSystemState $SS_RUNNING
  echo "Installing list of services, End time: $(date '+%Y-%m-%d %H:%M:%S')"
}

function installAllAvailableStacks()
{
  is_msgbox_prompt="$1"
  set +e
  echo "Installing all services, Start time: $(date '+%Y-%m-%d %H:%M:%S')"
  setSystemState $SS_INSTALLING
  echo "Pulling common images..."
  pullCommonImages
  stackListArr=($(echo $HSHQ_OPTIONAL_STACKS | tr "," "\n"))
  sel_svcs=()
  is_list_emtpy=true
  for curStack in "${stackListArr[@]}"
  do
    if ! [ -d $HSHQ_STACKS_DIR/$curStack ] && ! [ "$(isServiceDisabled $curStack)" = "true" ]; then
      sel_svcs+=($curStack)
      is_list_emtpy=false
    fi
  done
  if [ "$is_list_emtpy" = "true" ]; then
    if [ "$is_msgbox_prompt" = "true" ]; then
      showMessageBox "No Available Services" "There are no available services to install."
    fi
    return
  fi
  is_integrate=true
  if [ "$is_msgbox_prompt" = "true" ]; then
    #showYesNoMessageBox "Perform Integration?" "Do you want to automatically integrate these services, i.e. within Caddy, Heimdall, UptimeKuma, etc.?"
    #if [ $? -eq 0 ]; then
    #  is_integrate=true
    #else
    #  is_integrate=false
    #fi
    showYesNoMessageBox "Confirm Installation" "All available service(s) will be installed, Continue?"
    if [ $? -ne 0 ]; then
      return
    fi
  fi
  set -e
  setSudoTimeoutInstall
  getUpdateAssets
  for cur_svc in "${sel_svcs[@]}"
  do
    installStackByName $cur_svc $is_integrate
  done
  sudo systemctl restart ntp
  docker container restart authelia > /dev/null 2>&1
  removeSudoTimeoutInstall
  outputStackListsScriptServer
  setSystemState $SS_RUNNING
  echo "Installing all services, End time: $(date '+%Y-%m-%d %H:%M:%S')"
}

function getStacksToUpdate()
{
  set +e
  stacks_to_update_list=""
  # Special case for portainer compose
  check_stack_firstline=$(sudo sed -n 1p $HSHQ_STACKS_DIR/portainer/docker-compose.yml)
  if [ "$(checkStackHSHQManaged $check_stack_firstline)" = "true" ]; then
    check_stack_name=$(getStackNameFromComposeLine "$check_stack_firstline")
    if [ $? -eq 0 ]; then
      check_stack_version=$(getVersionFromComposeLine "$check_stack_firstline")
      if [ $? -eq 0 ]; then
        hshq_stack_ver=$(getScriptStackVersionNumber $(getScriptStackVersion $check_stack_name))
        if [ $? -eq 0 ]; then
          if [ $check_stack_version -lt $hshq_stack_ver ]; then
            stacks_to_update_list=${stacks_to_update_list}"${check_stack_name},"
          fi
        fi
      fi
    fi
  fi
  dirList=($(sudo ls $HSHQ_STACKS_DIR/portainer/compose/))
  for curDir in "${dirList[@]}"
  do
    check_stack_firstline=$(sudo sed -n 1p $HSHQ_STACKS_DIR/portainer/compose/$curDir/docker-compose.yml)
    if ! [ "$(checkStackHSHQManaged $check_stack_firstline)" = "true" ]; then
      continue
    fi
    check_stack_name=$(getStackNameFromComposeLine "$check_stack_firstline")
    if [ $? -ne 0 ]; then continue; fi
    check_stack_version=$(getVersionFromComposeLine "$check_stack_firstline")
    if [ $? -ne 0 ] || [ -z "$check_stack_version" ]; then continue; fi
    hshq_stack_ver=$(getScriptStackVersionNumber $(getScriptStackVersion $check_stack_name))
    if [ $? -ne 0 ] || [ -z "$hshq_stack_ver" ]; then continue; fi
    if [ $check_stack_version -lt $hshq_stack_ver ]; then
      stacks_to_update_list=${stacks_to_update_list}"${check_stack_name},"
    fi
    if [ $? -ne 0 ]; then continue; fi
  done
  if ! [ -z "$stacks_to_update_list" ]; then
    stacks_to_update_list=${stacks_to_update_list%?}
  fi
  sortCSVList "$stacks_to_update_list"
}

function performStackUpdatesFromList()
{
  set +e
  this_stack_list=$(getStacksToUpdate)
  stackListArr=($(echo $this_stack_list | tr "," "\n"))
  menu_items=""
  for curStack in "${stackListArr[@]}"
  do
    if [ -z "$curStack" ]; then
      continue
    fi
    menu_items=${menu_items}"$curStack | OFF "
  done
  if [ -z "$menu_items" ]; then
    showMessageBox "No Available Updates" "All services are updated."
    return
  fi
  selsvcsmenu=$(cat << EOF

$(getLogo)
Select the services that you wish to update:

EOF
  )
  sel_svcs=($(whiptail --title "Select Services" --checklist "$selsvcsmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  if [ -z "$sel_svcs" ]; then
    showMessageBox "Empty Selection" "You have not selected anything, returning to main menu..."
    return 0
  fi
  showYesNoMessageBox "Confirm Updates" "This selected service(s) will be updated, Continue?"
  if [ $? -ne 0 ]; then
    return
  fi
  update_list=""
  for cur_svc in "${sel_svcs[@]}"
  do
    update_list="${update_list}${cur_svc//\"},"
  done
  updateListOfStacks "$update_list"
}

function performAllAvailableStackUpdates()
{
  is_msgbox_prompt="$1"
  stacksToUpdate="$(getStacksToUpdate)"
  if [ -z "$stacksToUpdate" ]; then
    if [ "$is_msgbox_prompt" = "true" ]; then
      showMessageBox "No Available Updates" "All services are updated."
    else
      echo "All services are updated."
    fi
    return
  fi
  if [ "$is_msgbox_prompt" = "true" ]; then
    showYesNoMessageBox "Confirm Updates" "All available stacks will be updated, Continue?"
    if [ $? -ne 0 ]; then
      return
    fi
  fi
  updateListOfStacks "$stacksToUpdate"
}

function updateListOfStacks()
{
  echo "Updating list of services, Start time: $(date '+%Y-%m-%d %H:%M:%S')"
  stackListArr=($(echo "$1" | tr "," "\n"))
  stacks_need_update_list="$(getStacksToUpdate)"
  setSudoTimeoutInstall
  getUpdateAssets
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  report_start_time=$(date)
  full_update_report=""
  full_update_report="${full_update_report}                    Successful                    \n"
  full_update_report="${full_update_report}--------------------------------------------------"
  upgrade_error_report="\n\n"
  upgrade_error_report="${upgrade_error_report}                      Errors                      \n"
  upgrade_error_report="${upgrade_error_report}--------------------------------------------------"
  set +e
  for cur_svc in "${stackListArr[@]}"
  do
    if [ -z "$cur_svc" ]; then continue; fi
    unset is_upgrade_error
    is_upgrade_error=""
    echo -e "\n\nUpdating ${cur_svc}..."
    if ! [ "$(isItemInCSVList $cur_svc $stacks_need_update_list)" = "true" ]; then
      continue
    fi
    performUpdateStackByName "$cur_svc" "$portainerToken"
    if [ "$is_upgrade_error" = "true" ]; then
      upgrade_error_report="${upgrade_error_report}\n$perform_update_report\n"
    else
      full_update_report="${full_update_report}\n$perform_update_report"
    fi
  done
  full_update_report="${full_update_report}\n${upgrade_error_report}"
  removeSudoTimeoutInstall
  report_end_time=$(date)
  full_update_report_header=""
  full_update_report_header="${full_update_report_header}==================================================\n"
  full_update_report_header="${full_update_report_header}             Services Upgrade Report              \n"
  full_update_report_header="${full_update_report_header}==================================================\n"
  full_update_report_header="${full_update_report_header}Start Time: $report_start_time\n"
  full_update_report_header="${full_update_report_header}  End Time: $report_end_time\n\n"
  sendEmail -s "Services Upgrade Report" -b "${full_update_report_header}$full_update_report" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -t $EMAIL_ADMIN_EMAIL_ADDRESS
  echo "Sending update results to email manager ($EMAIL_ADMIN_EMAIL_ADDRESS). Refer to this for further details."
  outputStackListsScriptServer
  echo "Updating list of services, End time: $(date '+%Y-%m-%d %H:%M:%S')"
}

function deleteStacksFromList()
{
  sortedStackList=$(sortCSVList $HSHQ_OPTIONAL_STACKS)
  stackListArr=($(echo $sortedStackList | tr "," "\n"))
  menu_items=""
  for curStack in "${stackListArr[@]}"
  do
    if [ -d $HSHQ_STACKS_DIR/$curStack ]; then
      menu_items=${menu_items}"$curStack | OFF "
    fi
  done
  if [ -z "$menu_items" ]; then
    showMessageBox "No Available Services" "There are no available services to remove."
    return
  fi
  selsvcsmenu=$(cat << EOF

$(getLogo)
Select the services that you wish to remove:

EOF
  )
  sel_svcs=($(whiptail --title "Select Services" --checklist "$selsvcsmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  if [ -z "$sel_svcs" ]; then
    showMessageBox "Empty Selection" "You have not selected anything, returning to main menu..."
    return 0
  fi
  showYesNoMessageBox "Confirm Installation" "This selected service(s) will be removed, Continue?"
  if [ $? -ne 0 ]; then
    return
  fi
  del_stack_list=""
  for svc in "${sel_svcs[@]}"
  do
    del_stack_list="${del_stack_list}${svc//\"},"
    cur_svc=${svc//\"}
  done
  ENABLE_STACK_DELETE=true
  deleteListOfStacks false "$del_stack_list"
  ENABLE_STACK_DELETE=false
}

function deleteListOfStacks()
{
  is_force_delete_stack="$1"
  stackListArr=($(echo "$2" | tr "," "\n"))
  setSudoTimeoutInstall
  docker container stop uptimekuma >/dev/null
  docker container stop heimdall >/dev/null
  for cur_stack in "${stackListArr[@]}"
  do
    checkDeleteStackAndDirectory $cur_stack $cur_stack true "$is_force_delete_stack"
    for curSVC in "${SVCS_ARR[@]}"
    do
      cur_stack_name=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f1)
      if [ "${cur_stack_name//\"}" = "$cur_stack" ]; then
        user_type=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f4)
        subdom=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f6)
        deleteSvcAll "${user_type//\"}" "https://${subdom//\"}.$HOMESERVER_DOMAIN" false
      fi
    done
  done
  docker container start uptimekuma >/dev/null
  docker container start heimdall >/dev/null
  removeSudoTimeoutInstall
  restartAllCaddyContainers
  outputStackListsScriptServer
}

function clearRedisTempDataByStackName()
{
  stackName="$1"
  if ! [ -d $HSHQ_NONBACKUP_DIR/$stackName/redis ]; then
    echo "ERROR: Could not find corresponding redis directory"
    return
  fi
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  stackStatus=$(getStackStatusByName "$stackName" "$portainerToken")
  if ! [ "$stackStatus" = "1" ]; then
    echo "ERROR: This stack is not currently running"
    return
  fi
  echo "Stopping $stackName..."
  startStopStack "$stackName" stop "$portainerToken"
  echo "Clearing redis data..."
  sudo rm -fr $HSHQ_NONBACKUP_DIR/$stackName/redis/*
  echo "Starting $stackName..."
  startStopStack "$stackName" start "$portainerToken"
  echo "Complete!"
}

# VPN Setup
function setupVPNConnection()
{
  if [[ "$(isProgramInstalled wg)" = "false" ]]; then
    echo "Installing WireGuard utils, please wait..."
    performAptInstall wireguard-tools > /dev/null 2>&1
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "none" ]; then
    vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
    menures=$(whiptail --title "Select an option for your PRIMARY VPN connection" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
    "1" "Host a VPN" \
    "2" "Setup Later" 3>&1 1>&2 2>&3)

    case $menures in
      1)
        PRIMARY_VPN_SETUP_TYPE=host
        setupHostedVPN
        if [ $? -ne 0 ]; then
          return 1
        fi
        ;;
      2)
        PRIMARY_VPN_SETUP_TYPE=none
        updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
        # Determine if this is a private IP, and if so, let the user know about networking.
        showMsg="Since you will set up a RelayServer later, you will need to manually change the DNS server on any client devices to the IP address of this HomeServer ($HOMESERVER_HOST_PRIMARY_INTERFACE_IP), in order to access your services. "
        if [ "$(checkIsIPPrivate $HOMESERVER_HOST_PRIMARY_INTERFACE_IP)" = "true" ]; then
          showMsg=$showMsg"The client devices must be on the same local network (connected to the same router) as well."
        fi
        showMessageBox "DNS Server" "$showMsg"
        ;;
    esac
  fi
}

function setupJoinPrimaryVPN()
{
  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
    "1" "Generate Join Application" \
    "2" "Submit Join Configuration" \
    "3" "Exit" 3>&1 1>&2 2>&3)

  case $menures in
    1)
      applyHomeServerPrimaryVPNConfig
      releaseLock hshqopen "setupJoinPrimaryVPN" false
      return 1 ;;
    2)
      createNetworkJoin false
      if [ $? -ne 0 ]; then
        return 1
      fi
      PRIMARY_VPN_SETUP_TYPE=join
      updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE ;;
    3)
      return 1 ;;
  esac
}

function webSetupHostedVPN()
{
  set +e
  # These variables should already be set by Script-server
  # rs_name
  # rs_cur_username
  # rs_cur_password
  # rs_cur_ssh_port
  # rs_external_ip
  # rs_ledomains
  # rs_new_username
  # rs_new_password
  # rs_new_ssh_port
  # rs_primary_vpn_subnet

  case "$PRIMARY_VPN_SETUP_TYPE" in
    "host")
      echo "ERROR: You are already hosting a VPN, please remove the existing one first, returning..."
      return
    ;;
    "join")
      echo "ERROR: You have already joined an existing primary VPN. You must remove this first, returning..."
      return
    ;;
    "none"|"manual")
      PRIMARY_VPN_SETUP_TYPE=none
      updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE "$PRIMARY_VPN_SETUP_TYPE"
    ;;
    *)
      echo "ERROR: Unknown VPN option, returning..."
      return
    ;;
  esac
  pullImage $IMG_WIREGUARD
  if [ $? -ne 0 ]; then
    echo "ERROR: There was a problem pulling the WireGuard docker image..."
    return
  fi
  pullImage $IMG_DNSMASQ
  if [ $? -ne 0 ]; then
    echo "ERROR: There was a problem pulling the DNSMasq docker image..."
    return
  fi
  RELAYSERVER_WG_VPN_NETNAME="vpn-"${HOMESERVER_ABBREV:0:6}
  curNum=1
  while [ "$(checkInterfaceNameExists $RELAYSERVER_WG_VPN_NETNAME)" = "true" ] && [ $curNum -lt 100 ]
  do
    RELAYSERVER_WG_VPN_NETNAME="vpn-${HOMESERVER_ABBREV:0:5}${curNum}"
    ((curNum++))
  done
  if [ "$(checkInterfaceNameExists $RELAYSERVER_WG_VPN_NETNAME)" = "true" ]; then
    echo "ERROR: You have 99 other connections that start with ${HOMESERVER_ABBREV:0:5}?!? Returning..."
    return
  fi
  RELAYSERVER_WG_INTERNET_NETNAME="ext-${HOMESERVER_ABBREV:0:6}"
  curNum=1
  while [ "$(checkInterfaceNameExists $RELAYSERVER_WG_INTERNET_NETNAME)" = "true" ] && [ $curNum -lt 100 ]
  do
    RELAYSERVER_WG_INTERNET_NETNAME="ext-${HOMESERVER_ABBREV:0:5}${curNum}"
    ((curNum++))
  done
  if [ "$(checkInterfaceNameExists $RELAYSERVER_WG_INTERNET_NETNAME)" = "true" ]; then
    echo "ERROR: You have 99 other connections that start with ${HOMESERVER_ABBREV:0:5}?!? Returning..."
    return
  fi
  RELAYSERVER_EXT_EMAIL_HOSTNAME=$SUB_POSTFIX.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN
  if [ $(checkValidStringUpperLowerNumbers "$rs_name" "[:space:],.-") = "false" ]; then
    echo "ERROR: The selected RelayServer name contains invalid characters, returning..."
    return
  fi
  RELAYSERVER_NAME="$rs_name"
  if ! [ -z "$rs_ledomains" ] && [ $(checkValidString "$rs_ledomains" ",.-") = "false" ]; then
    echo "ERROR: The selected LetsEncrypt subdomains list contains invalid characters, returning..."
    return
  fi
  if [ "$rs_cur_username" = "root" ]; then
    if [ "$(checkValidUsername $rs_new_username)" = "false" ]; then
      echo "ERROR: The selected username is invalid. It must consists of a-z and/or 0-9. No special characters, the length must be between 4-32 characters, and it must begin with a letter, returning..."
      return
    fi
    if [ "$(checkValidPassword "$rs_new_password" 16)" = "false" ]; then
      echo "ERROR: The password is invalid or is too weak($rs_new_password). It must contain at least 16 characters and consist of uppercase letters, lowercase letters, and numbers. It can only contain the following symbols: ~!@#%^&*()-_+=<>?.,"
      return
    fi
    USER_RELAY_SUDO_PW="$rs_new_password"
  else
    rs_new_username="$rs_cur_username"
    USER_RELAY_SUDO_PW="$rs_cur_password"
  fi
  RELAYSERVER_LE_CERT_DOMAINS="$rs_ledomains"
  RELAYSERVER_REMOTE_USERNAME="$rs_new_username"
  RELAYSERVER_SERVER_IP="$rs_external_ip"
  RELAYSERVER_CURRENT_SSH_PORT="$rs_cur_ssh_port"
  if [ "$(checkValidIPAddress $rs_primary_vpn_subnet)" = "false" ]; then
    echo "ERROR: Invalid RelayServer IP address, returning..."
    return
  fi
  if ! [ "$(echo "$rs_primary_vpn_subnet" | cut -d"." -f1)" = "10" ]; then
    echo "ERROR: VPN subnet must be in the 10.0.0.0/8 range, returning..."
    return
  fi
  is_intersect="$(isNetworkIntersectOurNetworks ${rs_primary_vpn_subnet}/24 false true)"
  if ! [ -z "$is_intersect" ]; then
    echo "ERROR: VPN subnet collision - $is_intersect, returning..."
    return
  fi
  PRIMARY_VPN_SUBNET="${rs_primary_vpn_subnet}/24"
  PRIMARY_VPN_SETUP_TYPE=host
  setupPortForwardingDB
  chkSSHPort="$(checkPortForwardingIntersect tcp $rs_new_ssh_port $rs_new_ssh_port)"
  if ! [ -z "$chkSSHPort" ]; then
    sudo sqlite3 $HSHQ_DB "drop table portforwarding;"
    echo "ERROR: $chkSSHPort, returning..."
    return
  fi
  RELAYSERVER_SSH_PORT="$rs_new_ssh_port"
  RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=""
  tmp_port=$PORTAINER_LOCAL_HTTPS_PORT
  while [ -z "$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT" ]
  do
    chkSSHPort="$(checkPortForwardingIntersect tcp $tmp_port $tmp_port)"
    if ! [ -z "$chkSSHPort" ]; then
      tmp_port=$((9000 + $RANDOM % 999))
    else
      RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=$tmp_port
      break
    fi
  done
  # Clear out any old hosts
  ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN]:$RELAYSERVER_SSH_PORT" > /dev/null 2>&1
  ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[$RELAYSERVER_SERVER_IP]:$RELAYSERVER_SSH_PORT" > /dev/null 2>&1
  if [ -z "$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME" ]; then
    echo "Generating keys, please wait..."
    RELAYSERVER_SSH_PRIVATE_KEY_FILENAME=$HOMESERVER_ABBREV".key"
    updateConfigVar RELAYSERVER_SSH_PRIVATE_KEY_FILENAME $RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    rm -f $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    rm -f $HSHQ_CONFIG_DIR/${RELAYSERVER_SSH_PRIVATE_KEY_FILENAME}.pub
    RELAYSERVER_SSH_PRIVATE_KEY_PHRASE=$(pwgen -c -n 64 1)
    updateConfigVar RELAYSERVER_SSH_PRIVATE_KEY_PHRASE $RELAYSERVER_SSH_PRIVATE_KEY_PHRASE
    ssh-keygen -f $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME -N $RELAYSERVER_SSH_PRIVATE_KEY_PHRASE
    chmod 0400 $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    chmod 0400 $HSHQ_CONFIG_DIR/${RELAYSERVER_SSH_PRIVATE_KEY_FILENAME}.pub
  fi
  # Login, upload check script, log back in and run check script
  # 1. Login
  echo "Logging into RelayServer..."
  SSHPASS="$rs_cur_password" sshpass -e ssh -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 -p $RELAYSERVER_CURRENT_SSH_PORT $rs_cur_username@$RELAYSERVER_SERVER_IP "echo hello >/dev/null"
  if [ $? -ne 0 ]; then
    echo "ERROR: There was a problem logging in to the RelayServer, returning..."
    return
  fi
  # 2. Upload check script
  echo "Uploading validation script..."
  outputRelayServerValidationScript
  outputRelayServerInstallSetupScript
  sshpass -p "$rs_cur_password" scp -P $RELAYSERVER_CURRENT_SSH_PORT $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME $rs_cur_username@$RELAYSERVER_SERVER_IP:~/
  is_err=$?
  rm -f $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME
  if [ $is_err -ne 0 ]; then
    echo "ERROR: There was an problem uploading the validation script to the RelayServer, returning..."
    return
  fi
  sshpass -p "$rs_cur_password" scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME $rs_cur_username@$RELAYSERVER_SERVER_IP:~/$RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME
  is_err=$?
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME
  if [ $is_err -ne 0 ]; then
    echo "ERROR: There was an problem uploading the setup script to the RelayServer, returning..."
    return
  fi
  rm -f $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME
  # 3. Log back in and run check script
  if ! [ "$rs_cur_username" = "root" ]; then
    rs_new_password="$rs_cur_password"
  fi
  echo "Performing pre-installation checks, please wait..."
  SSHPASS="$rs_cur_password" sshpass -e ssh -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 -p $RELAYSERVER_CURRENT_SSH_PORT $rs_cur_username@$RELAYSERVER_SERVER_IP "bash ~/$RS_INSTALL_VALIDATION_SCRIPT_NAME -s" <<< "$rs_new_password"
  if [ $? -ne 0 ]; then
    echo "ERROR: There was a problem with the RelayServer, see above."
    return
  fi
  echo "All is good, assigning values..."
  RELAYSERVER_HSHQ_BASE_DIR=/home/$RELAYSERVER_REMOTE_USERNAME/hshq
  RELAYSERVER_HSHQ_DATA_DIR=$RELAYSERVER_HSHQ_BASE_DIR/data
  RELAYSERVER_HSHQ_NONBACKUP_DIR=$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
  RELAYSERVER_HSHQ_SCRIPTS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/scripts
  RELAYSERVER_HSHQ_SECRETS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/secrets
  RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/stacks
  RELAYSERVER_HSHQ_SSL_DIR=$RELAYSERVER_HSHQ_DATA_DIR/ssl
  resetRelayServerData
  updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE "$PRIMARY_VPN_SETUP_TYPE"
  updateConfigVar RELAYSERVER_SSH_PORT $RELAYSERVER_SSH_PORT
  # SSH (do both protocols, even though only need TCP)
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-SSH', $RELAYSERVER_SSH_PORT, $RELAYSERVER_SSH_PORT, 0, 0, 'both','','','$curdt');"
  updateConfigVar RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT
  # Portainer (do both protocols, even though only need TCP)
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-Portainer', $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT, $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT, 0, 0, 'both','','','$curdt');"
  updateConfigVar RELAYSERVER_WG_VPN_NETNAME "$RELAYSERVER_WG_VPN_NETNAME"
  updateConfigVar RELAYSERVER_WG_INTERNET_NETNAME "$RELAYSERVER_WG_INTERNET_NETNAME"
  updateConfigVar RELAYSERVER_EXT_EMAIL_HOSTNAME $RELAYSERVER_EXT_EMAIL_HOSTNAME
  updateConfigVar RELAYSERVER_NAME "$RELAYSERVER_NAME"
  updateConfigVar RELAYSERVER_LE_CERT_DOMAINS $RELAYSERVER_LE_CERT_DOMAINS
  updateConfigVar RELAYSERVER_REMOTE_USERNAME $RELAYSERVER_REMOTE_USERNAME
  updateConfigVar RELAYSERVER_HSHQ_BASE_DIR $RELAYSERVER_HSHQ_BASE_DIR
  updateConfigVar RELAYSERVER_HSHQ_DATA_DIR $RELAYSERVER_HSHQ_DATA_DIR
  updateConfigVar RELAYSERVER_HSHQ_NONBACKUP_DIR $RELAYSERVER_HSHQ_NONBACKUP_DIR
  updateConfigVar RELAYSERVER_HSHQ_SCRIPTS_DIR $RELAYSERVER_HSHQ_SCRIPTS_DIR
  updateConfigVar RELAYSERVER_HSHQ_SECRETS_DIR $RELAYSERVER_HSHQ_SECRETS_DIR
  updateConfigVar RELAYSERVER_HSHQ_STACKS_DIR $RELAYSERVER_HSHQ_STACKS_DIR
  updateConfigVar RELAYSERVER_HSHQ_SSL_DIR $RELAYSERVER_HSHQ_SSL_DIR
  updateConfigVar RELAYSERVER_SERVER_IP $RELAYSERVER_SERVER_IP
  updateConfigVar RELAYSERVER_CURRENT_SSH_PORT $RELAYSERVER_CURRENT_SSH_PORT
  updatePlaintextRootConfigVar PRIMARY_VPN_SUBNET $PRIMARY_VPN_SUBNET
  leCertsArr=($(echo $RELAYSERVER_LE_CERT_DOMAINS | tr "," "\n"))
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from lecertdomains;"
  for leCert in "${leCertsArr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "insert or ignore into lecertdomains(Domain,BaseDomain) values('$leCert','$HOMESERVER_DOMAIN');"
    curBaseDomain=$(getBaseDomain $leCert)
    curSubDomain=$(getSubDomain $leCert)
    if [ "$curBaseDomain" = "$HOMESERVER_DOMAIN" ]; then
      for curSVC in "${SVCS_ARR[@]}"
      do
        var_base=$(echo $curSVC | cut -d"=" -f1 | cut -d"_" -f 2-)
        subdom=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f6)
        subdom="${subdom//\"}"
        if [ "$subdom" = "$curSubDomain" ]; then
          var_name="SVCD_"$var_base
          var_value=$(getConfigVar $var_name)
          var_valueArr=($(echo $var_value | tr "," "\n"))
          var_valueArr[6]=le
          printf -v new_value '%s,' "${var_valueArr[@]}"
          new_value="$(echo "${new_value%,}")"
          updateConfigVar $var_name $new_value
        fi
      done
    fi
  done
  initRelayServerCredentials
  outputHostedVPNConfigs
  insertSQLHostedVPN
  # This upload must take place as soon as possible after the
  # validation check, as the RelayServer might be installing
  # docker and reboooting (required for debian 12 atm)
  # See "Performing pre-installation checks" comment above.
  echo "Generating RelayServer install scripts..."
  outputRelayServerInstallSetupScript
  outputRelayServerInstallFreshScript
  outputRelayServerInstallTransferScript
  loadSSHKey
  scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
  scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME
  unloadSSHKey
  set +e
  sendDNSRecordsEmail $HOMESERVER_DOMAIN
  sleep 2
  prepSvcsHostedVPN
  set +e
  startStopStack mailu stop
  sleep 1
  echo "Generating mailu certs..."
  generateCert mail "$SMTP_HOSTNAME,$SUB_POSTFIX.$HOMESERVER_DOMAIN"
  echo "Setting mailu relay creds..."
  updateMailuStackRelayHost
  # Start Install
  set +e
  echo "Starting installation on RelayServer..."
  loadSSHKey
  set +e
  countRSPreRetries=0
  maxRSPreRetries=20
  while true;
  do
    ssh -p $RELAYSERVER_CURRENT_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP "if [ -f ~/$RELAYSERVER_NOT_READY_FILE ]; then exit 1; fi" <<< "$USER_RELAY_SUDO_PW"
    if [ $? -eq 0 ]; then
      break
    fi
    if [ $countRSPreRetries -ge $maxRSPreRetries ]; then
      echo "Max retries reached. Something has likely gone wrong with the RelayServer pre-installation script, exiting..."
      exit 2
    fi
    ((countRSPreRetries++))
    echo "($countRSPreRetries of $maxRSPreRetries) RelayServer not ready for installation, sleeping 30 seconds then will retry..."
    sleep 30
  done
  ssh -p $RELAYSERVER_CURRENT_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP "bash $RS_INSTALL_FRESH_SCRIPT_NAME -s" <<< "$USER_RELAY_SUDO_PW"
  ssh -p $RELAYSERVER_CURRENT_SSH_PORT -o ConnectTimeout=10 -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP "export TERM=linux; screen -r hshqInstall"
  unloadSSHKey
  echo "RelayServer is rebooting..."
  echo "Sleeping 30 seconds, then will attempt to connect..."
  sleep 30
  set +e
  connectPrimaryInternet
  set +e
  connectPrimaryVPN false
  set +e
  updateEndpointIPs
  set +e
  rs_wg_user_conf=$(sudo cat $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf)
  wgconfig=""
  wgconfig="$wgconfig""============= User WireGuard Configuration ============\n"
  wgconfig="$wgconfig""""""$rs_wg_user_conf""""\n"
  wgconfig="$wgconfig""=======================================================\n"
  if [ "$IS_DESKTOP_ENV" = "true" ]; then
    wgconfigfile="$HOME/Desktop/User1_WireGuard.conf"
  else
    wgconfigfile="$HOME/User1_WireGuard.conf"
  fi
  rm -f $wgconfigfile
  echo -e "$wgconfig" > $wgconfigfile
  echo "Emailing credentials..."
  emailVaultwardenCredentials true
}

function initRelayServerCredentials()
{
  if [ -z "$RELAYSERVER_PORTAINER_ADMIN_USERNAME" ]; then
    RELAYSERVER_PORTAINER_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_portainer"
    updateConfigVar RELAYSERVER_PORTAINER_ADMIN_USERNAME $RELAYSERVER_PORTAINER_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_PORTAINER_ADMIN_PASSWORD" ]; then
    RELAYSERVER_PORTAINER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_PORTAINER_ADMIN_PASSWORD $RELAYSERVER_PORTAINER_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_ADGUARD_ADMIN_USERNAME" ]; then
    RELAYSERVER_ADGUARD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_adguard"
    updateConfigVar RELAYSERVER_ADGUARD_ADMIN_USERNAME $RELAYSERVER_ADGUARD_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_ADGUARD_ADMIN_PASSWORD" ]; then
    RELAYSERVER_ADGUARD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_ADGUARD_ADMIN_PASSWORD $RELAYSERVER_ADGUARD_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_CADDYDNS_ADMIN_USERNAME" ]; then
    RELAYSERVER_CADDYDNS_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_caddydns"
    updateConfigVar RELAYSERVER_CADDYDNS_ADMIN_USERNAME $RELAYSERVER_CADDYDNS_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_CADDYDNS_ADMIN_PASSWORD" ]; then
    RELAYSERVER_CADDYDNS_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_CADDYDNS_ADMIN_PASSWORD $RELAYSERVER_CADDYDNS_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_WGPORTAL_ADMIN_USERNAME" ]; then
    RELAYSERVER_WGPORTAL_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_wgportal"
    updateConfigVar RELAYSERVER_WGPORTAL_ADMIN_USERNAME $RELAYSERVER_WGPORTAL_ADMIN_USERNAME
    RELAYSERVER_WGPORTAL_ADMIN_EMAIL=$RELAYSERVER_WGPORTAL_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar RELAYSERVER_WGPORTAL_ADMIN_EMAIL $RELAYSERVER_WGPORTAL_ADMIN_EMAIL
  fi
  if [ -z "$RELAYSERVER_WGPORTAL_ADMIN_PASSWORD" ]; then
    RELAYSERVER_WGPORTAL_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_WGPORTAL_ADMIN_PASSWORD $RELAYSERVER_WGPORTAL_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_CLIENTDNS_ADMIN_USERNAME" ]; then
    RELAYSERVER_CLIENTDNS_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_clientdns"
    updateConfigVar RELAYSERVER_CLIENTDNS_ADMIN_USERNAME $RELAYSERVER_CLIENTDNS_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD" ]; then
    RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD $RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_RSPAMD_ADMIN_USERNAME" ]; then
    RELAYSERVER_RSPAMD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_rspamd"
    updateConfigVar RELAYSERVER_RSPAMD_ADMIN_USERNAME $RELAYSERVER_RSPAMD_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_RSPAMD_ADMIN_PASSWORD" ]; then
    RELAYSERVER_RSPAMD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_RSPAMD_ADMIN_PASSWORD $RELAYSERVER_RSPAMD_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_FILEBROWSER_ADMIN_USERNAME" ]; then
    RELAYSERVER_FILEBROWSER_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_filebrowser"
    updateConfigVar RELAYSERVER_FILEBROWSER_ADMIN_USERNAME $RELAYSERVER_FILEBROWSER_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD" ]; then
    RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD $RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_SYNCTHING_ADMIN_USERNAME" ]; then
    RELAYSERVER_SYNCTHING_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_rs_syncthing"
    updateConfigVar RELAYSERVER_SYNCTHING_ADMIN_USERNAME $RELAYSERVER_SYNCTHING_ADMIN_USERNAME
  fi
  if [ -z "$RELAYSERVER_SYNCTHING_ADMIN_PASSWORD" ]; then
    RELAYSERVER_SYNCTHING_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_SYNCTHING_ADMIN_PASSWORD $RELAYSERVER_SYNCTHING_ADMIN_PASSWORD
  fi
  if [ -z "$RELAYSERVER_SYNCTHING_API_KEY" ]; then
    RELAYSERVER_SYNCTHING_API_KEY=$(pwgen -c -n 32 1)
    updateConfigVar RELAYSERVER_SYNCTHING_API_KEY $RELAYSERVER_SYNCTHING_API_KEY
  fi
  if [ -z "$RELAYSERVER_SYNCTHING_FOLDER_ID" ]; then
    RELAYSERVER_SYNCTHING_FOLDER_ID=$(pwgen -c -n 5 1)-$(pwgen -c -n 5 1)
    updateConfigVar RELAYSERVER_SYNCTHING_FOLDER_ID $RELAYSERVER_SYNCTHING_FOLDER_ID
  fi
  RELAYSERVER_WG_SV_IP=$(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f2- | rev).$(($(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f1 | rev)))
  updateConfigVar RELAYSERVER_WG_SV_IP $RELAYSERVER_WG_SV_IP
  if [ -z "$RELAYSERVER_WG_SV_PRIVATEKEY" ]; then
    RELAYSERVER_WG_SV_PRIVATEKEY=$(wg genkey)
    updateConfigVar RELAYSERVER_WG_SV_PRIVATEKEY $RELAYSERVER_WG_SV_PRIVATEKEY
    RELAYSERVER_WG_SV_PUBLICKEY=$(echo $RELAYSERVER_WG_SV_PRIVATEKEY | wg pubkey)
    updateConfigVar RELAYSERVER_WG_SV_PUBLICKEY $RELAYSERVER_WG_SV_PUBLICKEY
  fi
  RELAYSERVER_WG_SV_PRESHAREDKEY=$(wg genpsk)
  updateConfigVar RELAYSERVER_WG_SV_PRESHAREDKEY $RELAYSERVER_WG_SV_PRESHAREDKEY
  RELAYSERVER_WG_SV_CLIENTDNS_IP=$(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f2- | rev).$(($(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f1 | rev)-1))
  updateConfigVar RELAYSERVER_WG_SV_CLIENTDNS_IP $RELAYSERVER_WG_SV_CLIENTDNS_IP
  RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY=$(wg genkey)
  updateConfigVar RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY $RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY
  RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY=$(wg genpsk)
  updateConfigVar RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY $RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY
  RELAYSERVER_WG_SV_CLIENTDNS_PUBLICKEY=$(echo $RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY | wg pubkey)
  RELAYSERVER_WG_HS_IP=$(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f2- | rev).$(($(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f1 | rev)-2))
  updateConfigVar RELAYSERVER_WG_HS_IP $RELAYSERVER_WG_HS_IP
  RELAYSERVER_WG_HS_PRIVATEKEY=$(wg genkey)
  updateConfigVar RELAYSERVER_WG_HS_PRIVATEKEY $RELAYSERVER_WG_HS_PRIVATEKEY
  RELAYSERVER_WG_HS_PRESHAREDKEY=$(wg genpsk)
  updateConfigVar RELAYSERVER_WG_HS_PRESHAREDKEY $RELAYSERVER_WG_HS_PRESHAREDKEY
  RELAYSERVER_WG_HS_PUBLICKEY=$(echo $RELAYSERVER_WG_HS_PRIVATEKEY | wg pubkey)
  RELAYSERVER_WG_HS_CLIENTDNS_IP=$(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f2- | rev).$(($(sipcalc $PRIMARY_VPN_SUBNET | grep "^Usable range" | rev | cut -d" " -f1 | cut -d"." -f1 | rev)-3))
  updateConfigVar RELAYSERVER_WG_HS_CLIENTDNS_IP $RELAYSERVER_WG_HS_CLIENTDNS_IP
  RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY=$(wg genkey)
  updateConfigVar RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY $RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY
  RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY=$(wg genpsk)
  updateConfigVar RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY $RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY
  RELAYSERVER_WG_HS_CLIENTDNS_PUBLICKEY=$(echo $RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY | wg pubkey)
  RELAYSERVER_WG_INTERNET_HS_IP=$(getRandomWireGuardIP)
  RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY=$(wg genkey)
  updateConfigVar RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY $RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY
  RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY=$(wg genpsk)
  updateConfigVar RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY $RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY
  RELAYSERVER_WG_INTERNET_HS_PUBLICKEY=$(echo $RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY | wg pubkey)
  RELAYSERVER_WG_USER_IP=$(getRandomWireGuardIP)
  RELAYSERVER_WG_USER_PRIVATEKEY=$(wg genkey)
  RELAYSERVER_WG_USER_PRESHAREDKEY=$(wg genpsk)
  RELAYSERVER_WG_USER_PUBLICKEY=$(echo $RELAYSERVER_WG_USER_PRIVATEKEY | wg pubkey)
  SMTP_RELAY_HOST="[$SUB_POSTFIX.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN]:$MAILU_PORT_5"
  updateConfigVar SMTP_RELAY_HOST $SMTP_RELAY_HOST
  SMTP_RELAY_USERNAME=$HOMESERVER_DOMAIN
  updateConfigVar SMTP_RELAY_USERNAME $SMTP_RELAY_USERNAME
  SMTP_RELAY_PASSWORD=$(pwgen -c -n 32 1)
  updateConfigVar SMTP_RELAY_PASSWORD $SMTP_RELAY_PASSWORD
}

function outputHostedVPNConfigs()
{
  sudo rm -f $HSHQ_WIREGUARD_DIR/vpn/${RELAYSERVER_WG_VPN_NETNAME}.conf
  sudo tee $HSHQ_WIREGUARD_DIR/vpn/${RELAYSERVER_WG_VPN_NETNAME}.conf >/dev/null <<EOFCF
[Interface]
PrivateKey = $RELAYSERVER_WG_HS_PRIVATEKEY
Address = ${RELAYSERVER_WG_HS_IP}/32
MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $RELAYSERVER_WG_HS_PRESHAREDKEY
AllowedIPs = $PRIMARY_VPN_SUBNET
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFCF
  sudo chmod 0400 $HSHQ_WIREGUARD_DIR/vpn/${RELAYSERVER_WG_VPN_NETNAME}.conf
  sudo cp $HSHQ_WIREGUARD_DIR/vpn/${RELAYSERVER_WG_VPN_NETNAME}.conf /etc/wireguard/${RELAYSERVER_WG_VPN_NETNAME}.conf
  sudo rm -f $HSHQ_WIREGUARD_DIR/internet/${RELAYSERVER_WG_INTERNET_NETNAME}.conf
  tableid=$(getNextWGRoutingTableID)
  dockerNetworkName="dwg-${RELAYSERVER_WG_INTERNET_NETNAME}"
  sudo tee $HSHQ_WIREGUARD_DIR/internet/${RELAYSERVER_WG_INTERNET_NETNAME}.conf >/dev/null <<EOFCF
#NETNAME=$RELAYSERVER_WG_INTERNET_NETNAME
#ROUTING_TABLE_ID=$tableid
#DOCKER_NETWORK_NAME=$dockerNetworkName
#DOCKER_NETWORK_SUBNET=
#CLIENT_ADDRESS=${RELAYSERVER_WG_INTERNET_HS_IP}/32
#MTU=$RELAYSERVER_CLIENT_DEFAULT_MTU
#IS_ENABLED=true
#EXT_DOMAIN=$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN

[Interface]
PrivateKey = $RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY
AllowedIPs = $(getAllowedPublicIPs)
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFCF
  sudo chmod 0400 $HSHQ_WIREGUARD_DIR/internet/${RELAYSERVER_WG_INTERNET_NETNAME}.conf
  sudo rm -f $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf
  sudo tee $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf >/dev/null <<EOFCF
[Interface]
PrivateKey = $RELAYSERVER_WG_USER_PRIVATEKEY
Address = ${RELAYSERVER_WG_USER_IP}/32
MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU
# DNS Servers (Use only one at a time)
# Home Network DNS Server
DNS = $RELAYSERVER_WG_HS_CLIENTDNS_IP
# VPN DNS Server
#DNS = $RELAYSERVER_WG_SV_CLIENTDNS_IP

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $RELAYSERVER_WG_USER_PRESHAREDKEY
AllowedIPs = $(getAllowedPublicIPs $PRIMARY_VPN_SUBNET)
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFCF
  sudo chmod 0400 $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf
  sudo rm -f $HSHQ_WIREGUARD_DIR/users/clientdns-user1.conf
  sudo tee $HSHQ_WIREGUARD_DIR/users/clientdns-user1.conf >/dev/null <<EOFCF
[Interface]
PrivateKey = $RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY
Address = ${RELAYSERVER_WG_HS_CLIENTDNS_IP}/32
MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY
AllowedIPs = $PRIMARY_VPN_SUBNET
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFCF
  sudo chmod 0400 $HSHQ_WIREGUARD_DIR/users/clientdns-user1.conf
}

function insertSQLHostedVPN()
{
  curdt=$(getCurrentDate)
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('WireGuardServer','$EMAIL_ADMIN_EMAIL_ADDRESS','wgserver','relayserver','$RELAYSERVER_WG_SV_PUBLICKEY','$RELAYSERVER_WG_SV_PRESHAREDKEY','$RELAYSERVER_WG_SV_IP',false,'$RELAYSERVER_WG_INTERFACE_NAME','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');"
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('RelayServerClientDNS','$EMAIL_ADMIN_EMAIL_ADDRESS','clientdns','relayserver','$RELAYSERVER_WG_SV_CLIENTDNS_PUBLICKEY','$RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY','$RELAYSERVER_WG_SV_CLIENTDNS_IP',false,'wg0','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');"
  db_id=$(sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated,Network_Subnet,IsExposeToNetwork,InputAllowPorts,DockerUserAllowPorts) values('Primary-VPN-${HOMESERVER_DOMAIN}','$EMAIL_ADMIN_EMAIL_ADDRESS','homeserver_vpn','primary','$RELAYSERVER_WG_HS_PUBLICKEY','$RELAYSERVER_WG_HS_PRESHAREDKEY','$RELAYSERVER_WG_HS_IP',false,'$RELAYSERVER_WG_VPN_NETNAME','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt','$PRIMARY_VPN_SUBNET',true,'$INPUT_PRIMARY_VPN_ALLOW_PORTS_DEFAULT','$DOCKERUSER_PRIMARY_VPN_ALLOW_PORTS_DEFAULT');select last_insert_rowid();")
  mail_host_id=$(sudo sqlite3 $HSHQ_DB "insert into mailhosts(MailHost) values('$SUB_POSTFIX.$HOMESERVER_DOMAIN');select last_insert_rowid();")
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into hsvpn_connections(ID,HomeServerName,IsPrimary,DomainName,ExternalPrefix,InternalPrefix,MailHostID,CA_Abbrev,CA_IP,CA_Subdomain,CA_URL,RS_VPN_IP) values($db_id,'$HOMESERVER_NAME',1,'$HOMESERVER_DOMAIN','$EXT_DOMAIN_PREFIX','$INT_DOMAIN_PREFIX',$mail_host_id,'$HOMESERVER_ABBREV','$RELAYSERVER_WG_HS_IP','$SUB_CADDY.$HOMESERVER_DOMAIN','https://$SUB_CADDY.$HOMESERVER_DOMAIN/acme/$HOMESERVER_ABBREV/directory' ,'$RELAYSERVER_WG_SV_IP');"
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into mailhostmap(MailHostID,Domain,IsFirstDomain) values ($mail_host_id,'$HOMESERVER_DOMAIN',true);"
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('clientdns-user1','$EMAIL_ADMIN_EMAIL_ADDRESS','clientdns','primary','$RELAYSERVER_WG_HS_CLIENTDNS_PUBLICKEY','$RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY','$RELAYSERVER_WG_HS_CLIENTDNS_IP',false,'wg0','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');"
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('Primary-Internet-${HOMESERVER_DOMAIN}','$EMAIL_ADMIN_EMAIL_ADDRESS','homeserver_internet','primary','$RELAYSERVER_WG_INTERNET_HS_PUBLICKEY','$RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY','$RELAYSERVER_WG_INTERNET_HS_IP',true,'$RELAYSERVER_WG_INTERNET_NETNAME','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');"
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,EndpointHostname,LastUpdated) values('User-$LDAP_PRIMARY_USER_USERNAME','$LDAP_PRIMARY_USER_EMAIL_ADDRESS','user','mynetwork','$RELAYSERVER_WG_USER_PUBLICKEY','$RELAYSERVER_WG_USER_PRESHAREDKEY','$RELAYSERVER_WG_USER_IP',true,'$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');"
}

function updateHeimdallUptimeKumaRelayServer()
{
  docker container stop heimdall > /dev/null 2>&1
  docker container stop uptimekuma > /dev/null 2>&1
  insertEnableSvcHeimdall adguard "${FMLNAME_ADGUARD}" relayserver "https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "adguardhome.png" false "$(getHeimdallOrderFromSub $SUB_ADGUARD.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcUptimeKuma adguard "${FMLNAME_ADGUARD}-RelayServer" relayserver "https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  insertEnableSvcHeimdall clientdns "${FMLNAME_CLIENTDNS}" relayserver "https://$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "dnsmasq.png" false "$(getHeimdallOrderFromSub $SUB_CLIENTDNS.$INT_DOMAIN_PREFIX relayserver)"
  checkInsertServiceHeimdall caddy-dns "${FMLNAME_CADDYDNS}" relayserver "https://$SUB_CADDYDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "dnsmasq.png" false 0 "$(getHeimdallOrderFromSub $SUB_CADDYDNS.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcHeimdall portainer "${FMLNAME_PORTAINER}" relayserver "https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "portainer.png" false "$(getHeimdallOrderFromSub $SUB_PORTAINER.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcUptimeKuma portainer "${FMLNAME_PORTAINER}-RelayServer" relayserver "https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  insertEnableSvcHeimdall rspamd "${FMLNAME_RSPAMD}" relayserver "https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "rspamd.png" false "$(getHeimdallOrderFromSub $SUB_RSPAMD.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcUptimeKuma rspamd "${FMLNAME_RSPAMD}-RelayServer" relayserver "https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  insertEnableSvcHeimdall syncthing "${FMLNAME_SYNCTHING}" relayserver "https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "syncthing.png" false "$(getHeimdallOrderFromSub $SUB_SYNCTHING.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcUptimeKuma syncthing "${FMLNAME_SYNCTHING}-RelayServer" relayserver "https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  checkInsertServiceHeimdall wgportal "${FMLNAME_WGPORTAL}" relayserver "https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "wgportal.png" false 0 "$(getHeimdallOrderFromSub $SUB_WGPORTAL.$INT_DOMAIN_PREFIX relayserver)"
  insertEnableSvcUptimeKuma wgportal "${FMLNAME_WGPORTAL}-RelayServer" relayserver "https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  checkInsertServiceUptimeKuma filebrowser "${FMLNAME_FILEBROWSER}-RelayServer" relayserver "https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false 0
  checkInsertServiceHeimdall filebrowser "${FMLNAME_FILEBROWSER}" relayserver "https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "filebrowser.png" false 0 "$(getHeimdallOrderFromSub $SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX relayserver)"
  docker container start heimdall > /dev/null 2>&1
  docker container start uptimekuma > /dev/null 2>&1
}

function prepSvcsHostedVPN()
{
  set +e
  echo "Updating Portainer and Jitsi..."
  updateSvcsIPChanges
  set +e
  echo "Updating IP tables..."
  checkUpdateAllIPTables prepSvcsHostedVPN
}

function setupHostedVPN()
{
  echo "Checking for required utils, please wait..."
  if [[ "$(isProgramInstalled dig)" = "false" ]]; then
    echo "Installing dig, please wait..."
    performAptInstall dnsutils > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled sshpass)" = "false" ]]; then
    echo "Installing sshpass, please wait..."
    performAptInstall sshpass > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled sipcalc)" = "false" ]]; then
    echo "Installing sipcalc, please wait..."
    performAptInstall sipcalc > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled jq)" = "false" ]]; then
    echo "Installing jq, please wait..."
    performAptInstall jq > /dev/null 2>&1
  fi
  resetRelayServerData
  if [ -z "$RELAYSERVER_WG_VPN_NETNAME" ]; then
    RELAYSERVER_WG_VPN_NETNAME="vpn-"${HOMESERVER_ABBREV:0:6}
    curNum=1
    while [ "$(checkInterfaceNameExists $RELAYSERVER_WG_VPN_NETNAME)" = "true" ] && [ $curNum -lt 100 ]
    do
      RELAYSERVER_WG_VPN_NETNAME="vpn-${HOMESERVER_ABBREV:0:5}${curNum}"
      ((curNum++))
    done
    if [ "$(checkInterfaceNameExists $RELAYSERVER_WG_VPN_NETNAME)" = "true" ]; then
      showMessageBox "Too Many Connections" "You have 99 other connections that start with ${HOMESERVER_ABBREV:0:5}?!?"
      return 1
    fi
    updateConfigVar RELAYSERVER_WG_VPN_NETNAME "$RELAYSERVER_WG_VPN_NETNAME"
  fi
  if [ -z "$RELAYSERVER_WG_INTERNET_NETNAME" ]; then
    RELAYSERVER_WG_INTERNET_NETNAME="ext-${HOMESERVER_ABBREV:0:6}"
    curNum=1
    while [ "$(checkInterfaceNameExists $RELAYSERVER_WG_INTERNET_NETNAME)" = "true" ] && [ $curNum -lt 100 ]
    do
      RELAYSERVER_WG_INTERNET_NETNAME="ext-${HOMESERVER_ABBREV:0:5}${curNum}"
      ((curNum++))
    done
    if [ "$(checkInterfaceNameExists $RELAYSERVER_WG_INTERNET_NETNAME)" = "true" ]; then
      showMessageBox "Too Many Connections" "You have 99 other connections that start with ${HOMESERVER_ABBREV:0:5}?!?"
      return 1
    fi
    updateConfigVar RELAYSERVER_WG_INTERNET_NETNAME "$RELAYSERVER_WG_INTERNET_NETNAME"
  fi
  if [ -z "$IS_ACCEPT_DEFAULTS" ]; then
    set +e
    showYesNoMessageBox "Accept Defaults?" "Do you wish to use defaults where applicable?"
    mbres=$?
    if [ $mbres -eq 0 ]; then
      IS_ACCEPT_DEFAULTS=yes
    else
      IS_ACCEPT_DEFAULTS=no
    fi
    set -e
  fi
  set +e
  sudo sqlite3 $HSHQ_DB "drop table portforwarding;" > /dev/null 2>&1
  set -e
  setupPortForwardingDB
  RELAYSERVER_EXT_EMAIL_HOSTNAME=$SUB_POSTFIX.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN
  updateConfigVar RELAYSERVER_EXT_EMAIL_HOSTNAME $RELAYSERVER_EXT_EMAIL_HOSTNAME
  RELAYSERVER_SSH_PORT=""
  while [ -z "$RELAYSERVER_SSH_PORT" ]
  do
	RELAYSERVER_SSH_PORT=$(promptUserInputMenu "$SSH_PORT" "Enter NEW RelayServer SSH Port" "Enter your desired SSH Port for your RelayServer. It is highly advised to change your default SSH port (22). Bots will constantly probe port 22:")
	if [ -z "$RELAYSERVER_SSH_PORT" ]; then
	  showMessageBox "SSH Port Empty" "The SSH port cannot be empty"
    elif [ "$(checkValidNumber $RELAYSERVER_SSH_PORT)" = "false" ]; then
      showMessageBox "Invalid Character(s)" "The port contains invalid character(s). It must be a number."
      RELAYSERVER_SSH_PORT=""
    elif [ $RELAYSERVER_SSH_PORT -lt 1024 ] || [ $RELAYSERVER_SSH_PORT -gt 65536 ]; then
      showMessageBox "Invalid Character(s)" "The port number is invalid, it must be between 1024-65536."
      RELAYSERVER_SSH_PORT=""
	fi
    if ! [ -z "$RELAYSERVER_SSH_PORT" ]; then
      chkSSHPort="$(checkPortForwardingIntersect tcp $RELAYSERVER_SSH_PORT $RELAYSERVER_SSH_PORT)"
      if ! [ -z "$chkSSHPort" ]; then
        showMessageBox "ERROR" "Error with port: $chkSSHPort"
        RELAYSERVER_SSH_PORT=""
      else
        updateConfigVar RELAYSERVER_SSH_PORT $RELAYSERVER_SSH_PORT
      fi
    fi
  done
  # SSH (do both protocols, even though only need TCP)
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-SSH', $RELAYSERVER_SSH_PORT, $RELAYSERVER_SSH_PORT, 0, 0, 'both','','','$curdt');"
  RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=""
  while [ -z "$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT" ]
  do
    tmp_port=$((9000 + $RANDOM % 999))
    while [ "$tmp_port" = "$RELAYSERVER_SSH_PORT" ]
    do
      tmp_port=$((9000 + $RANDOM % 999))
    done
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT="$tmp_port"
    else
      RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=$(promptUserInputMenu "$tmp_port" "Enter RelayServer Portainer Port" "Enter a port to use for Portainer on the RelayServer. A random port between 9000-9999 has been generated for you.")
    fi
	if [ -z "$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT" ]; then
	  showMessageBox "Port Empty" "The port cannot be empty"
    elif [ "$(checkValidNumber $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT)" = "false" ]; then
      showMessageBox "Invalid Character(s)" "The port contains invalid character(s). It must be a number."
      RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=""
    elif [ $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT -lt 1024 ] || [ $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT -gt 65536 ]; then
      showMessageBox "Invalid Character(s)" "The port number is invalid, it must be between 1024-65536."
      RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=""
	fi
    if ! [ -z "$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT" ]; then
      chkSSHPort="$(checkPortForwardingIntersect tcp $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT)"
      if ! [ -z "$chkSSHPort" ]; then
        showMessageBox "ERROR" "Error with port: $chkSSHPort"
        RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=""
      else
        updateConfigVar RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT
      fi
    fi
  done
  # Portainer (do both protocols, even though only need TCP)
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-Portainer', $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT, $RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT, 0, 0, 'both','','','$curdt');"
  while [ -z "$RELAYSERVER_NAME" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      RELAYSERVER_NAME="$HOMESERVER_NAME RelayServer"
    else
      RELAYSERVER_NAME=$(promptUserInputMenu "$HOMESERVER_NAME RelayServer" "Enter RelayServer Name" "Enter the RelayServer Name:")
    fi
	if [ -z "$RELAYSERVER_NAME" ]; then
	  showMessageBox "RelayServer Name Empty" "The RelayServer Name cannot be empty"
    elif [ $(checkValidStringUpperLowerNumbers "$RELAYSERVER_NAME" "[:space:],.-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The RelayServer name contains invalid character(s). It must consist of upper/lowercase letters, numbers, spaces, commas, periods, or hyphens."
      RELAYSERVER_NAME=""
	else
	  updateConfigVar RELAYSERVER_NAME "$RELAYSERVER_NAME"
	fi
  done
  while [ "$RELAYSERVER_LE_CERT_DOMAINS" = "unset" ]
  do
    lecert_def=$(getLetsEncryptCertsDefault)
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      RELAYSERVER_LE_CERT_DOMAINS="$lecert_def"
    else
      RELAYSERVER_LE_CERT_DOMAINS=$(promptUserInputMenu "$lecert_def" "Enter LE Cert Subdomains" "Enter the subdomains for which the certificates will be managed by LetsEncrypt (comma-separated):")
	  if ! [ -z "$RELAYSERVER_LE_CERT_DOMAINS" ] && [ $(checkValidString "$RELAYSERVER_LE_CERT_DOMAINS" ",.-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The domain list contains invalid character(s). It must consist of a-z (lowercase), 0-9, -, and/or ."
        RELAYSERVER_LE_CERT_DOMAINS=unset
	  fi
    fi
  done
  updateConfigVar RELAYSERVER_LE_CERT_DOMAINS $RELAYSERVER_LE_CERT_DOMAINS
  leCertsArr=($(echo $RELAYSERVER_LE_CERT_DOMAINS | tr "," "\n"))
  isReload=false
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from lecertdomains;"
  for leCert in "${leCertsArr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "insert or ignore into lecertdomains(Domain,BaseDomain) values('$leCert','$HOMESERVER_DOMAIN');"
    curBaseDomain=$(getBaseDomain $leCert)
    curSubDomain=$(getSubDomain $leCert)
    if [ "$curBaseDomain" = "$HOMESERVER_DOMAIN" ]; then
      for curSVC in "${SVCS_ARR[@]}"
      do
        var_base=$(echo $curSVC | cut -d"=" -f1 | cut -d"_" -f 2-)
        subdom=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f6)
        subdom="${subdom//\"}"
        if [ "$subdom" = "$curSubDomain" ]; then
          var_name="SVCD_"$var_base
          var_value=$(getConfigVar $var_name)
          var_valueArr=($(echo $var_value | tr "," "\n"))
          var_valueArr[6]=le
          printf -v new_value '%s,' "${var_valueArr[@]}"
          new_value="$(echo "${new_value%,}")"
          updateConfigVar $var_name $new_value
          isReload=true
        fi
      done
    fi
  done
  if [ "$isReload" = "true" ]; then
    loadSvcVars
  fi
  echo "Initializing RelayServer service credentials..."
  num_tries=1
  max_tries=100
  PRIMARY_VPN_SUBNET=""
  while [ -z "$PRIMARY_VPN_SUBNET" ] && [ $num_tries -lt $max_tries ]
  do
    ((num_tries++))
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      PRIMARY_VPN_SUBNET=10.$(( $RANDOM % 256 )).$(( $RANDOM % 256 )).0/24
    else
      PRIMARY_VPN_SUBNET=$(promptUserInputMenu "10.$(( $RANDOM % 256 )).$(( $RANDOM % 256 )).0/24" "Enter Subnet" "Enter the VPN Hosting Subnet (in CIDR): ")
    fi
	if [ -z "$PRIMARY_VPN_SUBNET" ] || [ "$(checkValidIPAddress $PRIMARY_VPN_SUBNET)" = "false" ]; then
	  showMessageBox "Invalid Subnet" "The VPN Subnet is invalid."
      PRIMARY_VPN_SUBNET=""
      continue
	fi
    is_intersect="$(isNetworkIntersectOurNetworks $PRIMARY_VPN_SUBNET false true)"
    if ! [ -z "$is_intersect" ]; then
      if ! [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
        showMessageBox "Network Collision" "Network Collision: $is_intersect"
      fi
      PRIMARY_VPN_SUBNET=""
      continue
    fi
    set +e
    firstOct=$(echo "$PRIMARY_VPN_SUBNET" | cut -d"." -f1)
    if ! [ "$firstOct" = "10" ]; then
      showYesNoMessageBox "Confirm" "This subnet is not in the 10.0.0.0/8 range. It is highly recommended that you stay within this range. Are you sure you know what you are doing?"
      if [ $? -ne 0 ]; then
        PRIMARY_VPN_SUBNET=""
        continue
      fi
    fi
    vpnCIDR=$(echo "$PRIMARY_VPN_SUBNET" | cut -d"/" -f2-)
    if ! [ "$vpnCIDR" = "24" ]; then
      showYesNoMessageBox "The VPN subnet must be of size /24."
      PRIMARY_VPN_SUBNET=""
      continue
    fi
    set -e
	updatePlaintextRootConfigVar PRIMARY_VPN_SUBNET $PRIMARY_VPN_SUBNET
  done
  if [ -z "$PRIMARY_VPN_SUBNET" ]; then
    # We tried...
    showMessageBox "ERROR" "Could not allocate VPN network subnet, returning..."
    return 1
  fi
  initRelayServerCredentials
  outputHostedVPNConfigs
  insertSQLHostedVPN
  echo "Generating RelayServer install scripts..."
  outputRelayServerInstallSetupScript
  outputRelayServerInstallFreshScript
  outputRelayServerInstallTransferScript
  set +e
  uploadVPNInstallScripts false
  if [ $? -ne 0 ]; then
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from lecertdomains;"
    return 1
  fi
  if [ "$IS_INSTALLED" = "true" ]; then
    echo "Preparing mailu, please wait..."
    startStopStack mailu stop
    sleep 5
    echo "Generating mailu certs..."
    generateCert mail "$SMTP_HOSTNAME,$SUB_POSTFIX.$HOMESERVER_DOMAIN"
    startStopStack mailu start
    prepSvcsHostedVPN
  fi
  updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
}

function transferHostedVPN()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    showMessageBox "Invalid Selection" "You are not hosting a RelayServer, returning..."
    return
  fi
  set +e
  tgLock="$(tryGetLock networkchecks transferHostedVPN)"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg networkchecks)"
    strErr="transferHostedVPN - Cannot obtain networkchecks lock: $checkRes. Please try again shortly, returning..."
    logHSHQEvent warning "$strErr"
    showMessageBox "WARNING" "WARNING: $strErr"
    return
  fi
  is_transfer=$(promptUserInputMenu "" "Transfer RelayServer" "If you wish to transfer your RelayServer, enter the word 'transfer' below:")
  if ! [ $is_transfer = "transfer" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return 0
  fi
  temp_pw=""
  while [ -z "$temp_pw" ]
  do
    temp_pw=$(promptPasswordMenu "Enter Password" "Enter the sudo password for $USERNAME: ")
    if [ $? -ne 0 ]; then
      exit 3
    fi
    echo "$temp_pw" | sudo -S -v -p "" > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      showMessageBox "Incorrect Password" "The password is incorrect, please re-enter it."
      temp_pw=""
      continue
    fi
  done
  unset temp_pw=""
  temp_pw=""
  setSudoTimeoutInstall
  setSystemState $SS_TRANSFERRING
  # Pause syncthing RelayServer
  jsonbody="{\"paused\": true}"
  curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X PATCH -d "$jsonbody" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices/$RELAYSERVER_SYNCTHING_DEVICE_ID
  outputRelayServerInstallSetupScript
  outputRelayServerInstallTransferScript
  sudo tar cvzf $HOME/rsbackup.tar.gz -C $HSHQ_RELAYSERVER_DIR/ ./backup >/dev/null
  old_rsIP=$RELAYSERVER_SERVER_IP
  uploadVPNInstallScripts true
  loadSSHKey
  scp -P $RELAYSERVER_CURRENT_SSH_PORT $HOME/rsbackup.tar.gz $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
  unloadSSHKey
  sudo rm -f $HOME/rsbackup.tar.gz
  showMessageBox "Upload Success" "The scripts and data have been uploaded to the RelayServer host. Please run 'bash $RS_INSTALL_TRANSFER_SCRIPT_NAME' on the remote host. After the installation has completed and the server has fully rebooted, press okay to begin monitoring for a successful connection transfer."
  # Remove old RelayIP with no update
  removeHomeNetIP $old_rsIP false
  set +e
  totalTries=720
  numTries=1
  sleepSeconds=5
  isMatchWG=false
  isMatchRS=false
  while [ $numTries -lt $totalTries ]
  do
    ipFromHostname=$(getIPFromHostname $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
    if [ "$RELAYSERVER_SERVER_IP" = "$ipFromHostname" ]; then
      isMatchWG=true
    else
      isMatchWG=false
    fi
    ipFromHostname=$(getIPFromHostname $RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
    if [ "$RELAYSERVER_SERVER_IP" = "$ipFromHostname" ]; then
      isMatchRS=true
    else
      isMatchRS=false
    fi
    if [ "$isMatchWG" = "true" ] && [ "$isMatchRS" = "true" ]; then
      break
    else
      echo "($numTries/$totalTries)RelayServer IP: $RELAYSERVER_SERVER_IP, $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN points to $ipFromHostname, $RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN points to $ipFromHostname. Trying again in $sleepSeconds seconds..."
    fi
    sleep $sleepSeconds
    ((numTries++))
  done
  if [ "$isMatchWG" = "true" ] && [ "$isMatchRS" = "true" ]; then
    echo "External IP updated successfully!"
  else
    echo "The RelayServer IP does not match."
  fi
  removeRelayServerAgentFromWazuhManager
  echo "Updating endpoint IP addresses..."
  updateEndpointIPs
  numTries=1
  isMatch=false
  timeout_length=5
  while [ $numTries -lt $totalTries ]
  do
    timeout $timeout_length ping -c 1 $RELAYSERVER_SUB_RELAYSERVER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN > /dev/null
    if [ $? -eq 0 ]; then
      isMatch=true
      break
    fi
    echo "($numTries/$totalTries)Could not ping RelayServer. Trying again in $sleepSeconds seconds..."
    sleep $sleepSeconds
    ((numTries++))
  done
  if [ "$isMatch" = "true" ]; then
    echo "Successfully connected to RelayServer!"
  else
    echo "Unable to ping RelayServer."
  fi
  # Resume syncthing RelayServer
  jsonbody="{\"paused\": false}"
  curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X PATCH -d "$jsonbody" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices/$RELAYSERVER_SYNCTHING_DEVICE_ID
  docker container restart syncthing
  loadSSHKey
  echo "Test login to new RelayServer: $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN"
  ssh -p $RELAYSERVER_SSH_PORT -o 'StrictHostKeyChecking accept-new' $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN 'echo Successful! IP Address is: $(curl --silent https://api.ipify.org)'
  unloadSSHKey
  notifyMyNetworkTransferRelayServer "$RELAYSERVER_SERVER_IP"
  removeSudoTimeoutInstall
  setSystemState $SS_RUNNING
  releaseLock networkchecks transferHostedVPN false
}

function outputRelayServerValidationScript()
{
  # This function assumes rs_cur_username and rs_new_username have been defined before calling it.
  # It also assumes that the caller will send the current/new user's password immediately via
  # standard input.
  if [ -z "$rs_cur_username" ] || [ -z "$rs_new_username" ]; then
    # Fatal
    echo "RelayServer usernames undefined for script, exiting..."
    exit 5
  fi
  tee $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME >/dev/null <<EOFRS
#!/bin/bash

curUsername=$rs_cur_username
newUsername=$rs_new_username
pubkey="$(cat $HSHQ_CONFIG_DIR/${RELAYSERVER_SSH_PRIVATE_KEY_FILENAME}.pub)"

function main()
{
  while getopts ':ips' opt; do
    case "\$opt" in
      s)
        startValidation ;;
      p)
        getSuper ;;
      i)
        performPreInstall ;;
      ?|h)
        echo "Usage: \$(basename \$0)"
        exit 1 ;;
    esac
  done
  shift "\$((\$OPTIND -1))"
}

function startValidation()
{
  set +e
  which sudo > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    if [ "\$curUsername" = "root" ]; then
      DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
      dpkg --configure -a > /dev/null 2>&1
      DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' sudo > /dev/null 2>&1
    else
      echo "------------------------------------------------------------------------------------"
      echo "  Sudo is not installed."
      echo "  Please either log in with the root account or install it manually."
      echo "------------------------------------------------------------------------------------"
      exit 2
    fi
  fi
  if [ "\$curUsername" = "root" ]; then
    read -r -s -p "" USER_RELAY_SUDO_PW
    id "\$newUsername" > /dev/null 2>&1
    if [ \$? -eq 0 ]; then
      echo "------------------------------------------------------------------------------------"
      echo "  User (\$newUsername) already exists, exiting..."
      echo "------------------------------------------------------------------------------------"
      removeMyself
      exit 1
    fi
    checkForHSHQ
    checkForRunningDockerContainers
    checkForBoundPorts
    sudo useradd -m -G sudo -s /bin/bash "\$newUsername" > /dev/null 2>&1
    echo "\$newUsername:\$USER_RELAY_SUDO_PW" | sudo chpasswd > /dev/null 2>&1
  else
    read -r -s -p "" USER_RELAY_SUDO_PW
    echo "\$USER_RELAY_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
    if [ \$? -ne 0 ]; then
      echo "------------------------------------------------------------------------------------"
      echo "  The sudo password for \$curUsername is incorrect, exiting..."
      echo "------------------------------------------------------------------------------------"
      removeMyself
      exit 2
    fi
    sudo bash -c "\$(declare -f checkForValidOSVersion); checkForValidOSVersion \$curUsername" 2> /dev/null
    if [ \$? -ne 0 ]; then
      removeMyself
      exit 2
    fi
    sudo bash -c "\$(declare -f checkForHSHQ); checkForHSHQ" 2> /dev/null
    if [ \$? -ne 0 ]; then
      removeMyself
      exit 2
    fi
    sudo bash -c "\$(declare -f checkForRunningDockerContainers); checkForRunningDockerContainers" 2> /dev/null
    if [ \$? -ne 0 ]; then
      removeMyself
      exit 2
    fi
    sudo bash -c "\$(declare -f checkBoundPort; declare -f checkForBoundPorts); checkForBoundPorts" 2> /dev/null
    if [ \$? -ne 0 ]; then
      removeMyself
      exit 2
    fi
  fi
  getent group docker >/dev/null || sudo groupadd docker > /dev/null 2>&1
  sudo usermod -aG docker \$newUsername > /dev/null 2>&1
  mkdir -p /home/\$newUsername/.ssh
  chmod 775 /home/\$newUsername/.ssh
  pubk=\$(echo "\$pubkey" | cut -d " " -f2)
  grep "\$pubk" /home/\$newUsername/.ssh/authorized_keys > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "\$pubkey" >> /home/\$newUsername/.ssh/authorized_keys
  fi
  chown -R \$newUsername:\$newUsername /home/\$newUsername/.ssh
  rm -f /home/\$newUsername/$RS_INSTALL_SETUP_SCRIPT_NAME
  rm -f /home/\$newUsername/$RS_INSTALL_FRESH_SCRIPT_NAME
  checkPerformPreInstall
}

function checkForValidOSVersion()
{
  source /home/\$1/$RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME lib
  checkSupportedHostOS
  rtVal=\$?
  if [ \$rtVal -ne 0 ]; then
    exit \$rtVal
  fi
}

function checkForHSHQ()
{
  findhshq="\$(find /home -maxdepth 3 -type d -name hshq 2>/dev/null | head -n 1)"
  if ! [ -z "\$findhshq" ]; then
    echo "------------------------------------------------------------------------------------"
    echo "  An hshq directory already exists: \$findhshq. You must log into the"
    echo "  RelayServer and run the nuke.sh script (bash nuke.sh) to clear everything out."
    echo "------------------------------------------------------------------------------------"
    exit 5
  fi
}

function checkForRunningDockerContainers()
{
  is_containers=\$(docker ps -q 2>/dev/null | head -n 1)
  if ! [ -z "\$is_containers" ]; then
    echo "------------------------------------------------------------------------------------"
    echo "  There are currently running docker containers, the server must be clear"
    echo "  of all activity."
    echo "------------------------------------------------------------------------------------"
    exit 6
  fi
}

function checkForBoundPorts()
{
  checkBoundPort $MAILU_PORT_1
  checkBoundPort $MAILU_PORT_5
  checkBoundPort $CADDY_HTTP_PORT
  checkBoundPort $CADDY_HTTPS_PORT
  checkBoundPort $SYNCTHING_SYNC_PORT
  checkBoundPort $SYNCTHING_DISC_PORT
  checkBoundPort $SYNCTHING_LOCAL_WEB_PORT
  checkBoundPort $RELAYSERVER_WG_PORTAL_PORT
  checkBoundPort $RELAYSERVER_WG_PORT
}

function checkBoundPort()
{
  chkPort=\$1
  set +e
  sudo netstat -tulpn | grep :\$chkPort > /dev/null 2>&1
  if [ \$? -eq 0 ]; then
    echo "------------------------------------------------------------------------------------"
    echo "  A needed port is bound by another service: \$chkPort"
    echo "  The server must be clear of all services on the following port lists:"
    echo "  External - $MAILU_PORT_1, $CADDY_HTTP_PORT, $CADDY_HTTPS_PORT, $RELAYSERVER_WG_PORT"
    echo "  Internal - $MAILU_PORT_5, $SYNCTHING_SYNC_PORT, $SYNCTHING_DISC_PORT, $SYNCTHING_LOCAL_WEB_PORT, $RELAYSERVER_WG_PORTAL_PORT"
    echo "------------------------------------------------------------------------------------"
    exit 7
  fi
}

function removeMyself()
{
  rm -f ~/$RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME
  rm -f \$0
}

function checkPerformPreInstall()
{
  sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
  sudo dpkg --configure -a > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y needrestart > /dev/null 2>&1
  which screen > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    DEBIAN_FRONTEND=noninteractive sudo apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' screen > /dev/null 2>&1
  fi
  which pwgen > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    DEBIAN_FRONTEND=noninteractive sudo apt update > /dev/null 2>&1
    sudo dpkg --configure -a > /dev/null 2>&1
    DEBIAN_FRONTEND=noninteractive sudo apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' pwgen > /dev/null 2>&1
  fi
  docker ps > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    source ~/$RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME lib
    if [ "\$DISTRO_ID" = "debian" ] && [[ "\$DISTRO_VERSION" =~ ^12. ]]; then
      echo "Installing docker on RelayServer and rebooting it..."
      # Must install docker and reboot
      touch /home/\$newUsername/$RELAYSERVER_NOT_READY_FILE
      scName=hshqPreInstall
      initScreen "\$scName"
      screen -S "\$scName" -X stuff "bash \$0 -i\n"
      return
    fi
  fi
  removeMyself
}

function performPreInstall()
{
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  sudo DEBIAN_FRONTEND=noninteractive apt dist-upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  installDocker
  rm -f /home/\$newUsername/$RELAYSERVER_NOT_READY_FILE
  removeMyself
  reboot
}

function getSuper()
{
  set +e
  stty -echo
  mkdir -p $TMP_PW_CHECKDIR
  read -r -s -p "" sudoPWKey
  USER_RELAY_SUDO_PW="\$(openssl enc -d -aes256 -pbkdf2 -in $ENC_PW_FILE -pass pass:\$sudoPWKey)"
  rm -f $ENC_PW_FILE
  echo "\$USER_RELAY_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    exit 6
  fi
  rm -fr $TMP_PW_CHECKDIR
  clear
  stty echo
}

function initScreen()
{
  set +e
  screenName="\$1"
  dirtest1=/tmp/scPre1
  isScreenSuccess=false
  curScreenAttempt=0
  maxScreenAttempt=5
  screen -XS \$screenName quit > /dev/null 2>&1
  sudoPWKey=\$(pwgen -c -n 32 1)
  echo -n "\$USER_RELAY_SUDO_PW" | openssl enc -e -aes256 -pbkdf2 -pass pass:\$sudoPWKey > $ENC_PW_FILE
  while [ \$curScreenAttempt -lt \$maxScreenAttempt ]
  do
    ((curScreenAttempt++))
    rm -fr \$dirtest1
    rm -fr $TMP_PW_CHECKDIR
    screen -dmS \$screenName
    screen -S \$screenName -X stuff "stty -echo;mkdir \$dirtest1\n"
    curCheckCount=0
    while ! [ -d \$dirtest1 ] && [ \$curCheckCount -lt 5 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    if ! [ -d \$dirtest1 ]; then
      screen -XS \$screenName quit > /dev/null 2>&1
      continue
    fi
    screen -S \$screenName -X stuff "bash \$0 -p\n"
    curCheckCount=0
    while ! [ -d $TMP_PW_CHECKDIR ] && [ \$curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    screen -S \$screenName -X stuff "\$sudoPWKey\n"
    curCheckCount=0
    while [ -d $TMP_PW_CHECKDIR ] && [ \$curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    rm -fr \$dirtest1
    if [ -d $TMP_PW_CHECKDIR ]; then
      rm -fr $TMP_PW_CHECKDIR
      echo "The sudo password was not correctly transmitted to the screen session, exiting..."
      exit 5
    fi
    rm -fr $TMP_PW_CHECKDIR
    isScreenSuccess=true
    break
  done
  USER_RELAY_SUDO_PW=""
  if ! [ "\$isScreenSuccess" = "true" ]; then
    return 1
  fi
}

main "\$@"
EOFRS
  chmod 600 $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME
}

function outputRelayServerInstallSetupScript()
{
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME
  cat <<EOFRS > $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME
#!/bin/bash

set +e

function init()
{
  USERNAME=\$(id -u -n)
  RELAYSERVER_HSHQ_BASE_DIR=\$HOME/hshq
  RELAYSERVER_HSHQ_DATA_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/data
  RELAYSERVER_HSHQ_NONBACKUP_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
  RELAYSERVER_HSHQ_SCRIPTS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/scripts
  MAIL_RELAY_SUBNET=172.16.3.0/24
  CLIENT_DNS_SUBNET=172.16.4.0/24
  loadVersionVars
}

function main()
{
  init
  echo "Running setup script..."
  outputNukeScript
  new_hostname="RelayServer-$(echo $HOMESERVER_DOMAIN | sed 's/\./-/g')"
  if [ -z "\$(cat /etc/hosts | grep \$new_hostname)" ]; then
    echo "127.0.1.1 \$new_hostname" | sudo tee -a /etc/hosts
  fi
  sudo hostnamectl set-hostname \$new_hostname
  rm -f \$HOME/dead.letter

  # Ensure we can login during the installation process,
  # since the firewall will block the connection if we
  # haven't logged in before the firewall goes up.
  cur_ssh_port=\$(sudo grep ^Port /etc/ssh/sshd_config)
  if [ \$? -ne 0 ]; then
    cur_ssh_port=22
  else
    cur_ssh_port=\$(sudo grep ^Port /etc/ssh/sshd_config | xargs | cut -d" " -f2)
  fi
  if [[ "\$(isProgramInstalled iptables)" = "false" ]]; then
    sudo DEBIAN_FRONTEND=noninteractive apt update
    performAptInstall iptables > /dev/null 2>&1
  fi
  sudo iptables -C INPUT -p tcp -m tcp --dport \$cur_ssh_port -j ACCEPT > /dev/null 2>&1 || sudo iptables -A INPUT -p tcp -m tcp --dport \$cur_ssh_port -j ACCEPT

  set +e
  # Change SSH port on host
  sudo sed -i "s|^#*Port .*\$|Port $RELAYSERVER_SSH_PORT|g" /etc/ssh/sshd_config
  sudo sed -i "s|^Port .*\$|Port $RELAYSERVER_SSH_PORT|g" /etc/ssh/sshd_config
  
  # Some other SSH settings
  sudo sed -i "s|^ClientAliveInterval .*\$|ClientAliveInterval 15|g" /etc/ssh/sshd_config
  sudo sed -i "s|^ClientAliveCountMax .*\$|ClientAliveCountMax 3|g" /etc/ssh/sshd_config
  sudo sed -i "s|^PermitEmptyPasswords .*\$|PermitEmptyPasswords no|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*ClientAliveInterval .*\$|ClientAliveInterval 15|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*ClientAliveCountMax .*\$|ClientAliveCountMax 3|g" /etc/ssh/sshd_config
  sudo sed -i "s|^#*PermitEmptyPasswords .*\$|PermitEmptyPasswords no|g" /etc/ssh/sshd_config

  # Update sudoers file
  sudo sed -i '/\/userasroot/d' /etc/sudoers >/dev/null
  echo "\$USERNAME ALL=(ALL) NOPASSWD: \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/*.sh" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/timestamp_timeout/d' /etc/sudoers >/dev/null
  echo "Defaults timestamp_timeout=$SUDO_NORMAL_TIMEOUT" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/logfile=/d' /etc/sudoers >/dev/null
  echo "Defaults logfile=/var/log/sudo.log" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/includedir/d' /etc/sudoers >/dev/null
  echo "@includedir /etc/sudoers.d" | sudo tee -a /etc/sudoers >/dev/null

  # Set timezone
  sudo timedatectl set-timezone "$TZ"

  # Create swap file
  createSwapfile

  set -e
  installDependencies
  createDockerNetworks
}

function createSwapfile()
{
  sudo grep swapfile /etc/fstab > /dev/null 2>&1
  if [ \$? -ne 0 ] && ! [ -f /swapfile ]; then
    sudo fallocate -l $RELAYSERVER_SWAP_SIZE /swapfile
    sudo chmod 600 /swapfile
    sudo mkswap /swapfile
    sudo swapon /swapfile
    echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
  fi
}

function updateSysctl()
{
  set +e
  sudo tee /etc/sysctl.d/88-hshq.conf >/dev/null <<EOFSC
kernel.panic = 10
fs.file-max = 10000000
fs.nr_open = 10000000
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
net.core.rmem_max = 4194304
net.core.wmem_max = 4194304
net.core.somaxconn = 65536
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_loose = 0
net.netfilter.nf_conntrack_tcp_timeout_established = 1800
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 10
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 20
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 20
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 10
net.ipv4.route.flush = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_timestamps = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.ip_forward = 1
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
EOFSC

  sudo sysctl --system > /dev/null 2>&1
}

function updateMOTD()
{
  cat <<EOFMD > \$HOME/88-hshq
#!/bin/bash

echo
echo "  #===============================================================#"
echo "  # ▀█  █  ▄▄  ▄▄ ▄▄ ▄▄▄ █▀▀▀█ ▄▄▄ ▄▄▄  ▄   ▄ ▄▄▄ ▄▄▄  █  █ █▀▀█  #"
echo "  #  █▀▀█ █  █ █ █ █ ▄▄  ▀▀▀▄▄ ▄▄  ▄▄▄▀ ▀▄ ▄▀ ▄▄  ▄▄▄▀ █▀▀█ █  █  #"
echo "  #  █  █ ▀▄▄▀ █   █ ▄▄▄ █▄▄▄█ ▄▄▄ ▄▄▄▄  ▀█▀  ▄▄▄ ▄▄▄▄ █  █ █▄▄█▄ #"
echo "  #===============================================================#"
echo

echo "      Linux OS:  \\\$(lsb_release -d | cut -d":" -f2 | cut -d"(" -f1 | xargs)"
printf "  Memory Usage:  %.1f%% of \\\$(free -h | awk  '/Mem:/{print \\\$2}')\n" \\\$((10000 - \\\$((10**4 * \\\$(grep "MemAvailable" /proc/meminfo | xargs | cut -d" " -f2) / \\\$(grep "MemTotal" /proc/meminfo | xargs | cut -d" " -f2)))))e-2
totSwap=\\\$(grep "SwapTotal" /proc/meminfo | xargs | cut -d" " -f2)
if [ \\\$totSwap -gt 0 ]; then
  printf "    Swap Usage:  %.1f%% of \\\$(free -h | awk  '/Swap:/{print \\\$2}')\n" \\\$((10000 - \\\$((10**4 * \\\$(grep "SwapFree" /proc/meminfo | xargs | cut -d" " -f2) / \\\$totSwap))))e-2
fi

echo
echo "  Disks: "
echo "  -----------------------------------------------------------------"
echo "  Filesystem            Size    Used    Avail   Use%    Mounted on"
echo "  -----------------------------------------------------------------"
df -hP | grep "^/dev" | awk '{printf "  %-21s %-7s %-7s %-7s %-7s %-8s\n", \\\$1, \\\$2, \\\$3, \\\$4, \\\$5, \\\$6}'
echo

# Let's only show zombie count if greater than 10
zombie_count=\\\$(ps aux | grep "defunct" | wc -l)
if [ \\\$zombie_count -gt 10 ]; then
  echo "  => There are \\\$zombie_count zombie processes."
  echo
fi

EOFMD
  chmod 755 \$HOME/88-hshq
  sudo chown root:root \$HOME/88-hshq
  sudo chmod -x /etc/update-motd.d/*
  sudo mv \$HOME/88-hshq /etc/update-motd.d/
  if [ -f /etc/motd ]; then
    sudo mv /etc/motd /etc/motd.old
  fi
}

function performSuggestedSecUpdates()
{
  disa_curE=\${-//[^e]/}
  set +e
  grep "enabled=1" /etc/default/apport > /dev/null 2>&1
  if [ \$? -eq 0 ]; then
    sudo sed -i "s/enabled=1/enabled=0/g" /etc/default/apport
    sudo systemctl stop apport
    sudo systemctl --now disable apport
    sudo systemctl daemon-reload
  fi
  echo "Authorized uses only." | sudo tee /etc/issue > /dev/null 2>&1
  echo "Authorized uses only." | sudo tee /etc/issue.net > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y telnet > /dev/null 2>&1
  # Assume the caller will restart sshd - don't want to risk breaking the installation process
  sudo sed -i "s/^#MaxAuthTries.*/MaxAuthTries 4/" /etc/ssh/sshd_config
  sudo sed -i "s/^#Banner none.*/Banner \/etc\/issue.net/" /etc/ssh/sshd_config
  sudo sed -i "s/^#MaxStartups.*/MaxStartups 10:30:60/" /etc/ssh/sshd_config
  sudo sed -i "s/^#LoginGraceTime.*/LoginGraceTime 60/" /etc/ssh/sshd_config
  sudo sed -i "s/^#AllowTcpForwarding yes.*/AllowTcpForwarding no/" /etc/ssh/sshd_config
  sudo chown root:root /etc/crontab
  sudo chmod og-rwx /etc/crontab
  sudo chown root:root /etc/cron.hourly/
  sudo chmod og-rwx /etc/cron.hourly/
  sudo chown root:root /etc/cron.daily/
  sudo chmod og-rwx /etc/cron.daily/
  sudo chown root:root /etc/cron.weekly/
  sudo chmod og-rwx /etc/cron.weekly/
  sudo chown root:root /etc/cron.monthly/
  sudo chmod og-rwx /etc/cron.monthly/
  sudo chown root:root /etc/cron.d/
  sudo chmod og-rwx /etc/cron.d/
  if ! [ -z \$disa_curE ]; then
    set -e
  fi
}

function performAptInstall()
{
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' \$1
}

function installDependencies()
{
  UTILS_LIST="$RELAYSERVER_UTILS_LIST"
  APT_REMOVE_LIST="$APT_REMOVE_LIST"

  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y needrestart > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y needrestart > /dev/null 2>&1

  performAptInstall ssmtp
  sudo tee /etc/ssmtp/ssmtp.conf >/dev/null <<EOFSM
root=$EMAIL_ADMIN_EMAIL_ADDRESS
mailhub=${SUB_POSTFIX}.${HOMESERVER_DOMAIN}:$MAILU_PORT_5
hostname=\$(cat /etc/hostname)
TLS_CA_FILE=/etc/ssl/certs/ca-certificates.crt
UseSTARTTLS=yes
FromLineOverride=no
AuthUser=$EMAIL_SMTP_EMAIL_ADDRESS
AuthPass=$EMAIL_SMTP_PASSWORD
EOFSM

  sudo tee /etc/ssmtp/revaliases >/dev/null <<EOFSM
root:$EMAIL_SMTP_EMAIL_ADDRESS
\$USERNAME:$EMAIL_SMTP_EMAIL_ADDRESS
EOFSM

  performAptInstall mailutils
  getent group mailsenders >/dev/null || sudo groupadd mailsenders
  sudo usermod -aG mailsenders \$USERNAME
  sudo chown root:mailsenders /usr/bin/mail.mailutils
  sudo chmod 750 /usr/bin/mail.mailutils

  set +e
  # Install Rsyslog
  sudo systemctl status rsyslog > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Installing rsyslog, please wait..."
    performAptInstall rsyslog > /dev/null 2>&1
    sudo systemctl enable rsyslog
    sudo systemctl start rsyslog
  fi

  for util in \$UTILS_LIST; do
    if [[ "\$(isProgramInstalled \$util)" = "false" ]]; then
      lib_name=\$(echo \$util | cut -d"|" -f2)
      echo "Installing \$lib_name, please wait..."
      performAptInstall \$lib_name > /dev/null 2>&1
    fi
  done

  updateSysctl
  updateMOTD
  performSuggestedSecUpdates
  installDocker

  if sudo test -f /etc/logrotate.d/rsyslog; then
    # Set max size of syslog to 2G
    grep maxsize /etc/logrotate.d/rsyslog > /dev/null 2>&1
    if [ \$? -ne 0 ]; then
      sudo sed -i "/weekly\$/a\        maxsize 2G" /etc/logrotate.d/rsyslog
    fi
  fi
  # Move logrotate into hourly
  if sudo test -f /etc/cron.daily/logrotate; then
    sudo mv /etc/cron.daily/logrotate /etc/cron.hourly
  fi
  # Set conditions for docker container logs
  sudo tee /etc/logrotate.d/docker >/dev/null <<EOFLR
/var/log/docker/*.log {
    weekly
    maxsize 100M
    rotate 4
    missingok
    notifempty
}
EOFLR
  sudo systemctl restart logrotate

  for rem_util in \$APT_REMOVE_LIST; do
    sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y \$rem_util
  done
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y
}

function loadVersionVars()
{
  DISTRO_ID=\$(cat /etc/*-release | grep "^ID=" | cut -d"=" -f2 | xargs | tr '[:upper:]' '[:lower:]')
  DISTRO_NAME=\$(cat /etc/*-release | grep "^NAME=" | cut -d"=" -f2 | xargs)
  DISTRO_VERSION=\$(cat /etc/*-release | grep "^VERSION=" | cut -d"=" -f2 | xargs)
}

function checkSupportedHostOS()
{
  if [ "\$DISTRO_ID" = "ubuntu" ] && [[ "\$DISTRO_VERSION" =~ ^22\.04. ]]; then
    return
  fi
  if [ "\$DISTRO_ID" = "ubuntu" ] && [[ "\$DISTRO_VERSION" =~ ^24\.04. ]]; then
    return
  fi
  if [ "\$DISTRO_ID" = "debian" ] && [[ "\$DISTRO_VERSION" =~ ^12. ]]; then
    return
  fi
  if [ "\$DISTRO_ID" = "linuxmint" ] && [[ "\$DISTRO_VERSION" =~ ^22. ]]; then
    return
  fi
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  echo "@                   Unsupported Host Operating System                  @"
  echo "@                                                                      @"
  echo "@ This installation only supports the following Linux distribution(s): @"
  echo "@                                                                      @"
  echo "@  - Ubuntu 22.04 (Jammy Jellyfish)                                    @"
  echo "@  - Ubuntu 24.04 (Noble Numbat)                                       @"
  echo "@  - Debian 12 (Bookworm)                                              @"
  echo "@  - Mint 22 (Wilma)                                                   @"
  echo "@                                                                      @"
  echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
  return 2
}

function outputDockerSettings()
{
  sudo mkdir -p /etc/docker
  sudo tee /etc/docker/daemon.json >/dev/null <<EOFRL
{
  "default-address-pools":
  [
    {"base":"$DOCKER_NETWORK_RESERVED_RANGE","size":$DOCKER_NETWORK_SIZE}
  ],
  "log-driver": "syslog",
  "log-opts": {
    "syslog-address": "unixgram:///dev/log",
    "tag": "docker/{{.Name}}"
  },
  "ipv6": false,
  "registry-mirrors": ["https://mirror.gcr.io"]
}
EOFRL
  set +e
  grep DockerDaemonLogFileName /etc/rsyslog.d/docker-logs.conf > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    sudo tee /etc/rsyslog.d/docker-logs.conf >/dev/null <<EOFRL
\\\$FileCreateMode 0644
\\\$template DockerDaemonLogFileName,"/var/log/docker/docker.log"
\\\$template DockerContainerLogFileName,"/var/log/docker/%SYSLOGTAG:R,ERE,1,FIELD:docker/(.*)\[--end:secpath-replace%.log"
if \\\$programname == 'dockerd' then {
  ?DockerDaemonLogFileName
  stop
}
if \\\$programname == 'containerd' then {
  ?DockerDaemonLogFileName
  stop
}
if \\\$programname == 'docker' then {
  if \\\$syslogtag contains 'docker/' then {
  ?DockerContainerLogFileName
  stop
  }
}
\\\$FileCreateMode 0600
EOFRL
  fi
}

function installDocker()
{
  set +e
  outputDockerSettings
  util="docker|docker"
  if [[ "\$(isProgramInstalled \$util)" = "true" ]]; then
    sudo systemctl restart rsyslog
    sudo systemctl restart docker
    return 0
  fi
  echo "Installing docker, please wait..."
  performAptInstall ca-certificates > /dev/null 2>&1
  performAptInstall curl > /dev/null 2>&1
  performAptInstall gnupg > /dev/null 2>&1
  performAptInstall lsb-release > /dev/null 2>&1
  case "\$DISTRO_ID" in
  "ubuntu")
    if [[ "\$DISTRO_VERSION" =~ ^22\.04. ]]; then
      installDockerUbuntu2204
    elif [[ "\$DISTRO_VERSION" =~ ^24\.04. ]]; then
      installDockerUbuntu2404
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  "debian")
    if [[ "\$DISTRO_VERSION" =~ ^12. ]]; then
      installDockerDebian12
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  "linuxmint")
    if [[ "\$DISTRO_VERSION" =~ ^22. ]]; then
      installDockerUbuntu2404
    elif [[ "\$DISTRO_VERSION" =~ ^6. ]]; then
      installDockerDebian12
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  *)
    ;;
  esac
  # See https://www.portainer.io/blog/portainer-and-docker-26
  sudo apt-mark hold docker-ce
  sudo apt-mark hold docker-ce-cli
  sudo systemctl restart rsyslog
  sudo systemctl restart docker
  sudo usermod -aG docker \$USERNAME
}

function installDockerUbuntu2204()
{
  # Install Docker (https://docs.docker.com/engine/install/ubuntu/)
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg --yes
  echo "deb [arch=\$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
  echo "Installing docker-ce..."
  performAptInstall docker-ce=$DOCKER_VERSION_UBUNTU_2204 > /dev/null 2>&1
  echo "Installing docker-ce-cli..."
  performAptInstall docker-ce-cli=$DOCKER_VERSION_UBUNTU_2204 > /dev/null 2>&1
  echo "Installing containerd.io..."
  performAptInstall containerd.io > /dev/null 2>&1
  echo "Installing docker-compose..."
  performAptInstall docker-compose > /dev/null 2>&1
  echo "Installing docker-compose-plugin..."
  performAptInstall docker-compose-plugin > /dev/null 2>&1
}

function installDockerUbuntu2404()
{
  # Install Docker (https://docs.docker.com/engine/install/ubuntu/)
  sudo install -m 0755 -d /etc/apt/keyrings
  sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  sudo chmod a+r /etc/apt/keyrings/docker.asc
  echo "deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \$(. /etc/os-release && echo "\$UBUNTU_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
  echo "Installing docker-ce..."
  performAptInstall docker-ce=$DOCKER_VERSION_UBUNTU_2404 > /dev/null 2>&1
  echo "Installing docker-ce-cli..."
  performAptInstall docker-ce-cli=$DOCKER_VERSION_UBUNTU_2404 > /dev/null 2>&1
  echo "Installing containerd.io..."
  performAptInstall containerd.io > /dev/null 2>&1
  echo "Installing docker-buildx-plugin..."
  performAptInstall docker-buildx-plugin > /dev/null 2>&1
  echo "Installing docker-compose-plugin..."
  performAptInstall docker-compose-plugin > /dev/null 2>&1
}

function installDockerDebian12()
{
  # Install Docker (https://docs.docker.com/engine/install/debian/)
  sudo install -m 0755 -d /etc/apt/keyrings
  sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  sudo chmod a+r /etc/apt/keyrings/docker.asc
  echo "deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \$(. /etc/os-release && echo "\$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
  echo "Installing docker-ce..."
  performAptInstall docker-ce=$DOCKER_VERSION_DEBIAN_12 > /dev/null 2>&1
  echo "Installing docker-ce-cli..."
  performAptInstall docker-ce-cli=$DOCKER_VERSION_DEBIAN_12 > /dev/null 2>&1
  echo "Installing containerd.io..."
  performAptInstall containerd.io > /dev/null 2>&1
  echo "Installing docker-compose..."
  performAptInstall docker-compose > /dev/null 2>&1
  echo "Installing docker-compose-plugin..."
  performAptInstall docker-compose-plugin > /dev/null 2>&1
}

function outputNukeScript()
{
  cat <<EOFNS > \$HOME/$NUKE_SCRIPT_NAME
HSHQ_BASE_DIR=\$RELAYSERVER_HSHQ_BASE_DIR
HSHQ_SCRIPTS_DIR=\$RELAYSERVER_HSHQ_SCRIPTS_DIR

set +e
function removeWGInterfaceQuick()
{
  config_filename=\\\$1
  sudo systemctl stop wg-quick@\\\${config_filename}.service
  sudo systemctl disable wg-quick@\\\${config_filename}.service
  sudo systemctl daemon-reload
  sudo rm -f /etc/wireguard/\\\${config_filename}.conf
}

function main()
{
  echo
  echo
  echo
  echo
  echo "============================================================"
  echo "This script will entirely remove HSHQ and all artifacts."
  echo "It will permanently delete ALL data"
  echo "It will not delete any previously downloaded docker images."
  echo "In order to remove them as well, type 'docker image prune -f'"
  echo "Please type 'nuclear' in order to continue."
  echo "============================================================"
  echo
  echo
  read -r -p "Type 'nuclear' (no quotes): " isnuke
  if ! [ "\\\$isnuke" = "nuclear" ]; then
    echo "String does not match, exiting..."
    exit 1
  fi
  sudo -k
  sudo crontab -r
  sudo docker ps -q | xargs sudo docker stop
  sleep 5
  sudo docker container prune -f
  sudo docker volume rm \\\$(sudo docker volume ls -q)
  sudo docker network prune -f
  sudo ls /etc/wireguard | while read fname
  do
    bname=\\\$(basename \\\$fname .conf)
    removeWGInterfaceQuick \\\$bname
  done
  sudo run-parts --regex '.*sh\\\$' \\\$HSHQ_SCRIPTS_DIR/root/portforwarding
  sudo systemctl stop runOnBootRoot
  sudo systemctl disable runOnBootRoot
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo \\\$HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh
  sudo rm -f /etc/sysctl.d/88-hshq.conf
  sudo sysctl --system > /dev/null 2>&1
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  # Check if systemd-resolved is installed.
  # If not, then modify /etc/resolv.conf directly.
  if [ -f /etc/systemd/resolved.conf ]; then
    sudo systemctl enable systemd-resolved > /dev/null 2>&1
    sudo systemctl start systemd-resolved > /dev/null 2>&1
    sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
    sudo grep "^nameserver 9.9.9.9" /etc/resolv.conf > /dev/null 2>&1
    if [ \\\$? -ne 0 ]; then
      sudo tee /etc/systemd/resolved.conf >/dev/null <<EOFRE
[Resolve]
DNS=9.9.9.9 149.112.112.112
EOFRE
      sudo systemctl restart systemd-resolved > /dev/null 2>&1
    fi
  else
    sudo tee /etc/resolv.conf >/dev/null <<EOFRE
nameserver 9.9.9.9
nameserver 149.112.112.112
EOFRE
  fi
  sudo systemctl restart docker
  sudo docker container prune -f
  sudo docker volume rm \\\$(sudo docker volume ls -q)
  sudo docker network prune -f
  sudo systemctl stop wazuh-agent
  sudo systemctl disable wazuh-agent
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge wazuh-agent -y --allow-change-held-packages
  sudo apt-mark unhold wazuh-agent
  sudo systemctl daemon-reload
  sudo rm -f /usr/local/share/ca-certificates/*
  sudo update-ca-certificates
  sudo systemctl stop docker
  sudo systemctl start docker
  sudo rm -fr \\\$HSHQ_BASE_DIR
  sudo rm -f \$HOME/$NUKE_SCRIPT_NAME
  sudo rm -fr \$HOME/.ssh/*
  sudo rm -fr /tmp/hshqopen
  sudo rm -f /etc/update-motd.d/88-hshq
  if [ -f /etc/motd.old ]; then
    sudo mv /etc/motd.old /etc/motd
  else
    sudo chmod +x /etc/update-motd.d/*
  fi
}

main "\\\$@"
EOFNS
  chmod 0600 \$HOME/$NUKE_SCRIPT_NAME
}

function isProgramInstalled()
{
  bin_name=\$(echo \$1 | cut -d"|" -f1)
  lib_name=\$(echo \$1 | cut -d"|" -f2)
  if [[ -z \$(sudo which \${bin_name}) ]]; then
    echo "false"
  else
    echo "true"
  fi
}

function getDockerSubnet()
{
  echo \$(docker network inspect \$1 | grep Subnet | awk '{print \$2}' | sed 's/[",]//g')
}

function createDockerNetworks()
{
  set -e
  docker network create -o com.docker.network.bridge.name=$NET_EXTERNAL_BRIDGE_NAME --driver=bridge --subnet $NET_EXTERNAL_SUBNET dock-ext
  docker network create -o com.docker.network.bridge.name=$NET_WEBPROXY_BRIDGE_NAME --driver=bridge --subnet $NET_WEBPROXY_SUBNET --internal dock-proxy
  docker network create -o com.docker.network.bridge.name=brd-mailrelay --driver=bridge --subnet \$MAIL_RELAY_SUBNET dock-mailrelay
  docker network create -o com.docker.network.bridge.name=brcd-user1 --driver=bridge --subnet \$CLIENT_DNS_SUBNET cdns-user1
}

case "\$1" in
  "lib")     init;;
  *)         main "\$@";;
esac

EOFRS
  chmod 0600 $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME
}

function outputRelayServerInstallTransferScript()
{
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_TRANSFER_SCRIPT_NAME
  cat <<EOFRS > $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_TRANSFER_SCRIPT_NAME
#!/bin/bash

set -e

TZ=$TZ
USERNAME=\$(id -u -n)
USERID=\$(id -u)
GROUPID=\$(id -g)
cd ~
RELAYSERVER_HSHQ_BASE_DIR=\$HOME/hshq
RELAYSERVER_HSHQ_DATA_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/data
RELAYSERVER_HSHQ_NONBACKUP_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
RELAYSERVER_HSHQ_SCRIPTS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/scripts
RELAYSERVER_HSHQ_SECRETS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/secrets
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/stacks
RELAYSERVER_HSHQ_SSL_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/ssl

function main()
{
  if [ \$USERID = "0" ]; then
    echo "This script should be run as a non-root user. Exiting..."
    exit 1
  fi
  sudo DEBIAN_FRONTEND=noninteractive apt update
  echo -e "\n\nInstalling a few utilities..."
  performAptInstall curl > /dev/null 2>&1
  performAptInstall dnsutils > /dev/null 2>&1
  performAptInstall screen > /dev/null 2>&1
  mkdir -p \$RELAYSERVER_HSHQ_BASE_DIR
  bash \$HOME/$RS_INSTALL_SETUP_SCRIPT_NAME
  sudo tar xvzf \$HOME/rsbackup.tar.gz >/dev/null
  sudo rm -fr \$RELAYSERVER_HSHQ_DATA_DIR
  sudo mv \$HOME/backup \$RELAYSERVER_HSHQ_DATA_DIR
  restoreNonBackupDir
  restoreSSL
  pullDockerImages
  restoreScripts
  restorePortainer
  restoreAdguard
  restoreMailRelay
  haltAndWaitForConfirmation
  restoreWireGuard
  restoreCaddy
  restoreOfelia
  restoreSyncthing
  startWazuhAgent
  sudo rm -f \$HOME/rsbackup.tar.gz
  sudo rm -f \$HOME/$RS_INSTALL_SETUP_SCRIPT_NAME
  sudo rm -f \$HOME/$RS_INSTALL_TRANSFER_SCRIPT_NAME
  clear
  echo
  echo
  echo
  echo
  echo "============================================================"
  echo "Transfer Complete!"
  echo "Rebooting in 60 seconds..."
  echo "============================================================"
  echo
  echo
  sleep 60
  sudo reboot
}

function getIPFromHostname()
{
  echo \$(dig \$1 +short | grep '^[.0-9]*\$')
}

function performAptInstall()
{
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' \$1
}

function haltAndWaitForConfirmation()
{
  clear
  echo
  echo
  echo
  echo
  echo "============================================================"
  echo "This server has been prepped for transfer. Please modify"
  echo "your DNS A records to point to this new IP Address:"
  echo
  echo "$RELAYSERVER_SERVER_IP"
  echo
  echo "After this has been done, enter 'transfer' to complete"
  echo "the remaining steps of the process."
  echo "============================================================"
  echo
  echo
  read -r -p "Type 'transfer' (no quotes) to continue: " isTransfer
  while ! [ "\$isTransfer" = "transfer" ]
  do
    echo "The string does not match, please try again."
    read -r -p "Type 'transfer' (no quotes) to continue: " isTransfer
  done
  totalTries=720
  numTries=1
  sleepSeconds=5
  isMatch=false
  while [ \$numTries -lt \$totalTries ]
  do
    ipFromHostname=\$(getIPFromHostname $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
    if [ "$RELAYSERVER_SERVER_IP" = "\$ipFromHostname" ]; then
      isMatch=true
      break
    fi
    echo "(\$numTries/\$totalTries)This host's IP: $RELAYSERVER_SERVER_IP, $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN points to \$ipFromHostname. Trying again in \$sleepSeconds seconds..."
    sleep \$sleepSeconds
    ((numTries++))
  done

  if [ "\$isMatch" = "true" ]; then
    echo "Success! The IP matches the hostname, continuing the installation..."
  else
    read -r -p "Failure. The IP does not match. The installation will continue, but you need to point the IP address correctly in order for everything to function properly. Press Enter to continue.   "
  fi
}

function restoreNonBackupDir()
{
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/adguard
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/adguard/work
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/config
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/data
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/syncthing
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/syncthing/data
}

function restoreSSL()
{
  docker volume create --driver local -o device=\$RELAYSERVER_HSHQ_SSL_DIR/caddy -o o=bind -o type=none caddy-certs
  sudo cp \$RELAYSERVER_HSHQ_DATA_DIR/ssl/${CERTS_ROOT_CA_NAME}.crt /usr/local/share/ca-certificates/
  sudo cp \$RELAYSERVER_HSHQ_DATA_DIR/ssl/relayserver-ca.crt /usr/local/share/ca-certificates/
  sudo update-ca-certificates
}

function pullImage()
{
  img_and_version=\$1
  echo "Pulling Image: \$img_and_version"
  is_success=1
  num_tries=1
  set +e
  while [ \$is_success -ne 0 ] && [ \$num_tries -lt $MAX_DOCKER_PULL_TRIES ]
  do
    # Refresh the sudo timestamp
    sudo -v
    docker pull \$img_and_version
    docker image inspect \$img_and_version > /dev/null 2>&1
    is_success=\$?
    ((num_tries++))
  done
  set -e
  if [ \$is_success -ne 0 ]; then
    echo "Error pulling docker image: $img_and_version"
    return 5
  fi
  set -e
}

function pullDockerImages()
{
  OLDIFS=\$IFS
  IFS=\$(echo -en "\n\b")
  img_arr=(\$(sudo grep -r "image: " \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/compose))
  for cur_item in "\${img_arr[@]}"
  do
    cur_img=\$(echo \$cur_item | xargs | cut -d" " -f3)
    if [[ "\$cur_img" =~ ^hshq ]]; then continue; fi
    pullImage \$cur_img
  done
  IFS=\$OLDIFS

  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build
  sudo rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
  git clone https://github.com/homeserverhq/mail-relay.git \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
  docker image build --network host -t $IMG_MAIL_RELAY_POSTFIX -f \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix/Dockerfile \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix
  docker image build --network host -t $IMG_MAIL_RELAY_RSPAMD -f \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/rspamd/Dockerfile \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/rspamd
  sudo rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
}

function restoreScripts()
{
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo ln -s \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service /etc/systemd/system/runOnBootRoot.service
  sudo systemctl daemon-reload
  sudo systemctl enable runOnBootRoot
}

function getPortainerToken()
{
  while [ -n "\$1" ]
  do case "\$1" in
  -u) port_username="\$2";;
  -p) port_password="\$2"
  shift ;;
  --) shift
  break ;;
  esac
  shift
  done
  if [ -z "\$port_username" ]; then
    read -r -p "Enter the portainer username: " port_username
	echo
  fi
  if [ -z "\$port_password" ]; then
    read -r -s -p "Enter the portainer password: " port_password
	echo
  fi

  echo \$(http --check-status --ignore-stdin --verify=no https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/auth username=\$port_username password=\$port_password | jq -r .jwt)
}

function getStackID()
{
  stackID="NA"
  stackName=\$1
  qry=\$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" endpointId==1)
  for row in \$(echo "\${qry}" | jq -r '.[] | @base64'); do
    _jq()
    {
      echo \${row} | base64 --decode | jq -r \${1}
    }
    if [ "\$(_jq '.Name')" = "\$stackName" ]; then
      stackID=\$(_jq '.Id')
      break
    fi
  done
  if ! [ "\$stackID" = "NA" ]; then
    echo \$stackID
  fi
}

function startStopStack()
{
  stackName=\$1
  startStop=\$2
  stackID=\$(getStackID \$stackName)
  http --check-status --ignore-stdin --verify=no --timeout=300 POST https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/stacks/\$stackID/\$startStop "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" endpointId==1 > /dev/null
}

function restorePortainer()
{
  sed -i "s|^UID=.*|UID=\${USERID}|g" $RELAYSERVER_HSHQ_STACKS_DIR/portainer/portainer.env
  sed -i "s|^GID=.*|GID=\${GROUPID}|g" $RELAYSERVER_HSHQ_STACKS_DIR/portainer/portainer.env
  cd ~
  docker compose -f \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/docker-compose.yml up -d
  RELAYSERVER_PORTAINER_TOKEN="\$(getPortainerToken -u $RELAYSERVER_PORTAINER_ADMIN_USERNAME -p $RELAYSERVER_PORTAINER_ADMIN_PASSWORD)"
}

function restoreAdguard()
{
  sudo systemctl stop systemd-resolved > /dev/null 2>&1
  sudo systemctl disable systemd-resolved > /dev/null 2>&1
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  sudo tee /etc/resolv.conf >/dev/null <<EOFR
nameserver 127.0.0.1
EOFR
  np_path="/etc/netplan/*"
  for cur_np in "\$np_path"
  do
    sudo sed -i "s|8.8.8.8|9.9.9.9|g" \$cur_np
    sudo sed -i "s|8.8.4.4|149.112.112.112|g" \$cur_np
  done
  set +e
  sudo which netplan && sudo netplan apply > /dev/null 2>&1
  set -e
  oldIP=\$(grep -A 1 "$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" \$RELAYSERVER_HSHQ_STACKS_DIR/adguard/conf/AdGuardHome.yaml | tail -n 1 | cut -d":" -f2 | xargs)
  sed -i "s|\$oldIP|$RELAYSERVER_SERVER_IP|g" \$RELAYSERVER_HSHQ_STACKS_DIR/adguard/conf/AdGuardHome.yaml
  sudo chown -R \${USERID}:\${GROUPID} \$RELAYSERVER_HSHQ_STACKS_DIR/adguard/conf
  sudo chown -R \${USERID}:\${GROUPID} \$RELAYSERVER_HSHQ_NONBACKUP_DIR/adguard/work
  startStopStack adguard stop
  startStopStack adguard start
}

function restoreMailRelay()
{
  startStopStack mail-relay stop
  startStopStack mail-relay start
}

function restoreWireGuard()
{
  sudo mv \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/$RELAYSERVER_WG_INTERFACE_NAME.conf /etc/wireguard/$RELAYSERVER_WG_INTERFACE_NAME.conf
  # Gotta make it a hard link just as it was before, dummy.
  sudo ln /etc/wireguard/$RELAYSERVER_WG_INTERFACE_NAME.conf \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/$RELAYSERVER_WG_INTERFACE_NAME.conf
  sudo systemctl enable wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
  sudo systemctl start wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
  startStopStack wgportal stop
  startStopStack wgportal start
  startStopStack clientdns stop
  startStopStack clientdns start
  # Let's restart the interface just to make sure
  timeout 10 sudo systemctl restart wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
}

function restoreCaddy()
{
  startStopStack caddy stop
  startStopStack caddy start
}

function restoreOfelia()
{
  startStopStack ofelia stop
  startStopStack ofelia start
}

function restoreSyncthing()
{
  startStopStack syncthing stop
  startStopStack syncthing start
}

function startWazuhAgent()
{
  curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | sudo gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import && sudo chmod 644 /usr/share/keyrings/wazuh.gpg
  echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo WAZUH_MANAGER="$SUB_WAZUH.$HOMESERVER_DOMAIN" DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wazuh-agent=$WAZUH_AGENT_VERSION
  sudo apt-mark hold wazuh-agent
  sudo systemctl daemon-reload
  set +e
  sudo grep "/var/log/docker/" /var/ossec/etc/ossec.conf > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    sudo sed -i "/<\/ossec_config>/{s//  <localfile>\n    <log_format>syslog<\/log_format>\n    <location>\/var\/log\/docker\/*<\/location>\n  <\/localfile>\n\n<\/ossec_config>/;:p;n;bp}" /var/ossec/etc/ossec.conf
  fi
  sudo tee /var/ossec/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
  sudo chmod 640 /var/ossec/etc/authd.pass
  sudo chown root:wazuh /var/ossec/etc/authd.pass
  set -e
  sudo systemctl enable wazuh-agent
  sudo systemctl start wazuh-agent
}

main "\$@"
EOFRS
  chmod 0600 $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_TRANSFER_SCRIPT_NAME
}

function outputRelayServerInstallFreshScript()
{
  rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME
  cat <<EOFRS > $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME
#!/bin/bash

set -e
TZ=$TZ
USERNAME=\$(id -u -n)
USERID=\$(id -u)
GROUPID=\$(id -g)
if [ \$USERID = "0" ]; then
  echo "This script should be run as a non-root user. Exiting..."
  exit 1
fi
if [ -d /tmp/hshqopen ]; then
  echo "Installation already in progess, exiting..."
  exit 2
fi
cd ~
RELAYSERVER_HSHQ_BASE_DIR=\$HOME/hshq
RELAYSERVER_HSHQ_DATA_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/data
RELAYSERVER_HSHQ_NONBACKUP_DIR=\$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
RELAYSERVER_HSHQ_SCRIPTS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/scripts
RELAYSERVER_HSHQ_SECRETS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/secrets
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/stacks
RELAYSERVER_HSHQ_SSL_DIR=\$RELAYSERVER_HSHQ_DATA_DIR/ssl

function main()
{
  while getopts ':ips' opt; do
    case "\$opt" in
      s)
        startInstall ;;
      p)
        getSuper ;;
      i)
        performInstall ;;
      ?|h)
        echo "Usage: \$(basename \$0)"
        exit 1 ;;
    esac
  done
  shift "\$((\$OPTIND -1))"
}

function startInstall()
{
  set +e
  read -r -s -t 30 -p "[sudo] password for \$USERNAME: " USER_RELAY_SUDO_PW
  echo "\$USER_RELAY_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Error with RelayServer sudo password, exiting..."
    exit 8
  fi
  loadVersionVars
  echo "Update apt..."
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo dpkg --configure -a > /dev/null 2>&1
  echo "Checking for required utils..."
  set +e
  which curl > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Installing curl..."
    performAptInstall curl > /dev/null 2>&1
  fi
  which dig > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Installing dnsutils..."
    performAptInstall dnsutils > /dev/null 2>&1
  fi
  which screen > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Installing screen..."
    performAptInstall screen > /dev/null 2>&1
  fi
  which pwgen > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Installing pwgen..."
    performAptInstall pwgen > /dev/null 2>&1
  fi
  set -e
  mkdir -p \$RELAYSERVER_HSHQ_BASE_DIR
  installLogNotify "Start Installation"
  scName=hshqInstall
  initScreen "\$scName"
  screen -S "\$scName" -X stuff "bash \$0 -i\n"
}

function getSuper()
{
  set +e
  stty -echo
  mkdir -p $TMP_PW_CHECKDIR
  read -r -s -p "" sudoPWKey
  USER_RELAY_SUDO_PW="\$(openssl enc -d -aes256 -pbkdf2 -in $ENC_PW_FILE -pass pass:\$sudoPWKey)"
  rm -f $ENC_PW_FILE
  echo "\$USER_RELAY_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    installLogNotify "Error with sudo password, exiting installation..."
    exit 6
  fi
  rm -fr $TMP_PW_CHECKDIR
  clear
  stty echo
}

function initScreen()
{
  set +e
  screenName="\$1"
  dirtest1=/tmp/sctest1
  isScreenSuccess=false
  curScreenAttempt=0
  maxScreenAttempt=5
  screen -XS \$screenName quit > /dev/null 2>&1
  # The screen utility has a problem with stuffing
  # special characters in strings, specifically
  # in this case when trying to inject the sudo
  # password. Thus, the easiest way to handle this 
  # is to create a temporary "safe" key, output
  # the encrypted password to file using the key
  # and transmit the key to the screen session.
  sudoPWKey=\$(pwgen -c -n 32 1)
  echo -n "\$USER_RELAY_SUDO_PW" | openssl enc -e -aes256 -pbkdf2 -pass pass:\$sudoPWKey > $ENC_PW_FILE
  while [ \$curScreenAttempt -lt \$maxScreenAttempt ]
  do
    ((curScreenAttempt++))
    rm -fr \$dirtest1
    rm -fr $TMP_PW_CHECKDIR
    screen -L -Logfile \$RELAYSERVER_HSHQ_BASE_DIR/$RELAYSERVER_HSHQ_FULL_LOG_NAME -dmS \$screenName
    screen -S \$screenName -X stuff "stty -echo;mkdir \$dirtest1\n"
    curCheckCount=0
    while ! [ -d \$dirtest1 ] && [ \$curCheckCount -lt 5 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    if ! [ -d \$dirtest1 ]; then
      screen -XS \$screenName quit > /dev/null 2>&1
      continue
    fi
    screen -S \$screenName -X stuff "bash \$0 -p\n"
    curCheckCount=0
    while ! [ -d $TMP_PW_CHECKDIR ] && [ \$curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    screen -S \$screenName -X stuff "\$sudoPWKey\n"
    curCheckCount=0
    while [ -d $TMP_PW_CHECKDIR ] && [ \$curCheckCount -lt 15 ]
    do
      ((curCheckCount++))
      sleep 1
    done
    rm -fr \$dirtest1
    if [ -d $TMP_PW_CHECKDIR ]; then
      rm -fr $TMP_PW_CHECKDIR
      echo "The sudo password was not correctly transmitted to the screen session, exiting..."
      exit 5
    fi
    rm -fr $TMP_PW_CHECKDIR
    isScreenSuccess=true
    break
  done
  USER_RELAY_SUDO_PW=""
  if ! [ "\$isScreenSuccess" = "true" ]; then
    return 1
  fi
}

function performAptInstall()
{
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' \$1
}

function isProgramInstalled()
{
  bin_name=\$(echo \$1 | cut -d"|" -f1)
  lib_name=\$(echo \$1 | cut -d"|" -f2)
  if [ -z "\$(sudo which \${bin_name})" ]; then
    echo "false"
  else
    echo "true"
  fi
}

function installLogNotify()
{
  log_message=\$1
  echo \$(date)" - \$log_message" >> \$RELAYSERVER_HSHQ_BASE_DIR/$RELAYSERVER_HSHQ_TIMESTAMP_LOG_NAME
}

function getIPFromHostname()
{
  echo \$(dig \$1 +short | grep '^[.0-9]*\$')
}

function getConnectingIPAddress()
{
  cIP=\$(echo \$SSH_CLIENT | xargs | cut -d" " -f1)
  if [ "\$(checkValidIPAddress \$cIP)" = "true" ]; then
    echo "\$cIP"
  else
    echo ""
  fi
}

function checkIsIPPrivate()
{
  check_ip="\$1"
  set +e
  priv_arr=(10.0.0.0/8 172.16.0.0/12 192.168.0.0/16)
  for subnet in "\${priv_arr[@]}"
  do
    is_in_subnet=\$(isIPInSubnet \$check_ip \$subnet)
    if [ "\$is_in_subnet" = "true" ]; then
      echo "true"
      return
    fi
  done
  echo "false"
}

function isIPInSubnet()
{
  iiis_curE=\${-//[^e]/}
  check_ipaddr=\$1
  check_subnet=\$2
  set +e
  grepcidr \${check_subnet} <(echo \${check_ipaddr}) > /dev/null 2>&1
  if [ \$? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
  set +e
  if ! [ -z \$iiis_curE ]; then
    set -e
  fi
}

function checkValidIPAddress()
{
  ip=\$(echo \$1 | cut -d "/" -f1)
  stat=1
  if [[ \$ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\$ ]]; then
    OLDIFS=\$IFS
    IFS='./'
    ip=(\$ip)
    IFS=\$OLDIFS
    [[ \${ip[0]} -le 255 && \${ip[1]} -le 255 && \${ip[2]} -le 255 && \${ip[3]} -le 255 ]]
    stat=\$?
  fi
  if [ \$stat -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function loadVersionVars()
{
  set +e
  DISTRO_ID=\$(cat /etc/*-release | grep "^ID=" | cut -d"=" -f2 | xargs | tr '[:upper:]' '[:lower:]')
  DISTRO_NAME=\$(cat /etc/*-release | grep "^NAME=" | cut -d"=" -f2 | xargs)
  DISTRO_VERSION=\$(cat /etc/*-release | grep "^VERSION=" | cut -d"=" -f2 | xargs)
}

function performInstall()
{
  mkdir /tmp/hshqopen
  sudo -v
  bash \$HOME/$RS_INSTALL_SETUP_SCRIPT_NAME
  docker ps > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Docker was not install properly, exiting..."
    touch ~/$RELAYSERVER_INSTALL_FAILED_FILE
    exit 6
  fi
  set -e
  mkdir -p \$RELAYSERVER_HSHQ_DATA_DIR
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR
  mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR
  mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot
  mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
  mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user
  sudo mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root
  sudo chmod 700 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root
  sudo mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot
  sudo chmod 700 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot
  sudo mkdir -p \$RELAYSERVER_HSHQ_SECRETS_DIR
  mkdir -p \$RELAYSERVER_HSHQ_SSL_DIR
  mkdir -p \$RELAYSERVER_HSHQ_STACKS_DIR
  outputCerts
  pullDockerImages
  outputScripts
  installLogNotify "Installing Stacks"
  installPortainer
  installMailRelay
  installWireGuard
  installFileBrowser
  installCaddy
  installOfelia
  installSyncthing
  installLogNotify "Starting Wazuh Agent"
  startWazuhAgent
  installAdGuard
  sudo rm -f \$HOME/$RS_INSTALL_FRESH_SCRIPT_NAME
  sudo rm -f \$HOME/$RS_INSTALL_SETUP_SCRIPT_NAME
  docker image prune -af
  installLogNotify "Rebooting"
  echo -e "\n\n\n########################################\n"
  echo "  RelayServer Installation Complete!"
  echo "  Restarting server..."
  echo -e "\n########################################\n\n"
  rm -fr /tmp/hshqopen
  # Successfull installation, clean up the logs
  #rm -f \$RELAYSERVER_HSHQ_BASE_DIR/$RELAYSERVER_HSHQ_FULL_LOG_NAME
  #rm -f \$RELAYSERVER_HSHQ_BASE_DIR/$RELAYSERVER_HSHQ_TIMESTAMP_LOG_NAME
  touch \$RELAYSERVER_HSHQ_BASE_DIR/$RELAYSERVER_INSTALL_COMPLETE_FILE
  sudo reboot
}

function outputCerts()
{
  mkdir \$RELAYSERVER_HSHQ_SSL_DIR/caddy
  docker volume create --driver local -o device=\$RELAYSERVER_HSHQ_SSL_DIR/caddy -o o=bind -o type=none caddy-certs
  echo """$(cat $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt)""" > \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt
  openssl x509 -in \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -out \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der -outform DER
  echo "Generating DH parameters, 512 bit long safe prime..."
  openssl dhparam -out \$RELAYSERVER_HSHQ_SSL_DIR/dhparam.pem $CERTS_INTERNAL_DHPARAMS_KEYLENGTH > /dev/null 2>&1
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/dhparam.pem
  sudo cp \$RELAYSERVER_HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
  initCertificateAuthority
  sudo update-ca-certificates
}

function initCertificateAuthority()
{
  # Certificate Authority Key
  openssl genrsa -out \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.key 4096

  cat <<EOFCA > \$HOME/ca.conf 
[ req ]
distinguished_name = req_distinguished_name
prompt = no
x509_extensions = v3_ca

[ req_distinguished_name ]
C   = $CERTS_INTERNAL_COUNTRY
ST  = $CERTS_INTERNAL_STATE
L   = $CERTS_INTERNAL_LOCALITY
O   = $HOMESERVER_NAME RelayServer
OU  = $CERTS_INTERNAL_OU_NAME
CN  = $CERTS_INTERNAL_ROOT_CN

[ v3_ca ]
basicConstraints = critical,CA:TRUE
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always,issuer
keyUsage = critical, cRLSign, keyCertSign
EOFCA

  # Certificate Authority Certificate
  openssl req -new -x509 -sha256 -nodes -days $CERTS_INTERNAL_CA_DAYS -key \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.key -out \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.crt -config \$HOME/ca.conf
  rm -f \$HOME/ca.conf

  chmod 0400 \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.key
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.crt

  sudo cp \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.crt /usr/local/share/ca-certificates/
}

function generateCert()
{
  CERT_NAME=\$1
  DNS=\$2
  IP_ADDRESSES=\$3

  rm -fr \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.key
  rm -fr \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.crt

  CERTS_INTERNAL_COUNTRY="$CERTS_INTERNAL_COUNTRY"
  CERTS_INTERNAL_STATE="$CERTS_INTERNAL_STATE"
  CERTS_INTERNAL_LOCALITY="$CERTS_INTERNAL_LOCALITY"
  CERTS_INTERNAL_OU_NAME="$CERTS_INTERNAL_OU_NAME"
  ORGANIZATION_NAME="$HOMESERVER_NAME"
  CERTS_INTERNAL_CA_DAYS=$CERTS_INTERNAL_CA_DAYS

  # Generate certificate key
  openssl genrsa -out \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.key 4096

  cat <<EOFCR > \$HOME/\$CERT_NAME-csr.cnf
[ req ]
distinguished_name = req_distinguished_name
prompt = no
req_extensions = req_ext

[ req_distinguished_name ]
C   = \$CERTS_INTERNAL_COUNTRY
ST  = \$CERTS_INTERNAL_STATE
L   = \$CERTS_INTERNAL_LOCALITY
O   = \$ORGANIZATION_NAME RelayServer
OU  = \$CERTS_INTERNAL_OU_NAME
CN  = \$CERT_NAME

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
EOFCR

  cat <<EOFCR > \$HOME/\$CERT_NAME-ext.cnf
basicConstraints = CA:FALSE
nsComment = "OpenSSL Certificate Generated By \$ORGANIZATION_NAME"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth,clientAuth
subjectAltName = @alt_names

[ alt_names ]
EOFCR

  dnslist=\$(sed 's|,|\n|g' <<< \$DNS)
  ipnum=1
  for dn in \$dnslist
  do
    echo "DNS."\$ipnum" = "\$dn >> \$HOME/\$CERT_NAME-csr.cnf
    echo "DNS."\$ipnum" = "\$dn >> \$HOME/\$CERT_NAME-ext.cnf
    ((ipnum++))
  done

  iplist=\$(sed 's|,|\n|g' <<< \$IP_ADDRESSES)
  ipnum=1
  for ip in \$iplist
  do
    echo "IP."\$ipnum" = "\$ip >> \$HOME/\$CERT_NAME-csr.cnf
    echo "IP."\$ipnum" = "\$ip >> \$HOME/\$CERT_NAME-ext.cnf
    ((ipnum++))
  done

  # Generate certificate request
  openssl req -config \$HOME/\$CERT_NAME-csr.cnf -new -sha256 -key \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.key -out \$HOME/\$CERT_NAME.csr
  openssl x509 -req -sha256 -days \$CERTS_INTERNAL_CA_DAYS -in \$HOME/\$CERT_NAME.csr -CA \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.crt -CAkey \$RELAYSERVER_HSHQ_SSL_DIR/relayserver-ca.key -out \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.crt -extfile \$HOME/\$CERT_NAME-ext.cnf -CAcreateserial
  rm -f \$HOME/\$CERT_NAME-csr.cnf
  rm -f \$HOME/\$CERT_NAME-ext.cnf
  rm -f \$HOME/\$CERT_NAME.csr
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.key
  chmod 0444 \$RELAYSERVER_HSHQ_SSL_DIR/\$CERT_NAME.crt
}

function pullImage()
{
  img_and_version=\$1
  echo "Pulling Image: \$img_and_version"
  is_success=1
  num_tries=1
  set +e
  while [ \$is_success -ne 0 ] && [ \$num_tries -lt $MAX_DOCKER_PULL_TRIES ]
  do
    # Refresh the sudo timestamp
    sudo -v
    docker pull \$img_and_version
    docker image inspect \$img_and_version > /dev/null 2>&1
    is_success=\$?
    ((num_tries++))
  done
  set -e
  if [ \$is_success -ne 0 ]; then
    echo "Error pulling docker image: $img_and_version"
    exit 5
  fi
  set -e
}

function pullDockerImages()
{
  pullImage $IMG_ADGUARD
  pullImage $IMG_CADDY
  pullImage $IMG_DNSMASQ
  pullImage $IMG_MAIL_RELAY_UNBOUND
  pullImage $IMG_FILEBROWSER
  pullImage $IMG_OFELIA
  pullImage $IMG_PORTAINER
  pullImage $IMG_SYNCTHING
  pullImage $IMG_REDIS
  pullImage $IMG_WGPORTAL
  pullImage $IMG_WIREGUARD
  mkdir -p \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build
  sudo rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
  git clone https://github.com/homeserverhq/mail-relay.git \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
  docker image build --network host -t $IMG_MAIL_RELAY_POSTFIX -f \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix/Dockerfile \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix
  docker image build --network host -t $IMG_MAIL_RELAY_RSPAMD -f \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/rspamd/Dockerfile \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/rspamd
  sudo rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay
}

function outputScripts()
{
  outputBootScripts
  outputCaddyScripts
  outputRelayedDomainsScript
  outputPortforwardingScripts
}

function outputBootScripts()
{
  exposedPortsList=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$RELAYSERVER_WG_PORTAL_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/*.sh
run-parts --regex '.*sh\$' \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
EOFBS
  sudo chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh

  default_iface=\$(getDefaultIface)
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh >/dev/null <<EOFBS
#!/bin/bash
  set +e

  SSH_PORT=$RELAYSERVER_SSH_PORT
  WG_CON_PORT=$RELAYSERVER_WG_PORT
  WG_PORTAL_PORT=$RELAYSERVER_WG_PORTAL_PORT
  DOCK_EXT_NET=$NET_EXTERNAL_SUBNET
  ports_list=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT

  sudo iptables -t filter -F DOCKER-USER > /dev/null
  sudo iptables -t filter -X DOCKER-USER > /dev/null
  sudo iptables -t filter -N DOCKER-USER > /dev/null

  portsArr=(\\\$(echo \\\$ports_list | tr "," "\n"))
  for cur_port in "\\\${portsArr[@]}"
  do
    iptables -D DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j RETURN 2> /dev/null
    iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j DROP 2> /dev/null
    iptables -I DOCKER-USER -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j DROP
    iptables -I DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j RETURN
  done

  # See https://gist.github.com/mattia-beta/bd5b1c68e3d51db933181d8a3dc0ba64?permalink_comment_id=3728715#gistcomment-3728715
  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -N chain-icmp > /dev/null 2>&1
  iptables -t raw -N chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -A PREROUTING -s 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 0.0.0.0/8 -j DROP
  # Block spoofed packets
  iptables -t raw -A PREROUTING -s 0.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,169.254.0.0/16,224.0.0.0/4,198.18.0.0/15,100.64.0.0/10,192.88.99.0/24 -i \$default_iface -j DROP
  iptables -t raw -A PREROUTING -s 127.0.0.0/8 ! -i lo -j DROP
  iptables -t raw -A PREROUTING -p udp -m udp -m multiport --ports 0 -j DROP
  iptables -t raw -A PREROUTING -p icmp -j chain-icmp
  iptables -t raw -A PREROUTING -p tcp -m tcp -j chain-bad_tcp
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type network-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type host-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type protocol-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type port-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type fragmentation-needed -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -i \$default_iface -j DROP
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type parameter-problem -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type any -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,ACK FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,URG URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,FIN FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,PSH PSH -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL ALL -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp -m tcp -m multiport --ports 0 -j DROP
  iptables -t raw -P PREROUTING ACCEPT

  # Limit connections per source IP
  iptables -C INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset > /dev/null 2>&1 || iptables -A INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset

  # Allow established connections
  iptables -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

  # Drop invalid packets
  iptables -C INPUT -m conntrack --ctstate INVALID -j DROP > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate INVALID -j DROP

  # Drop fragments
  iptables -C INPUT -f -j DROP > /dev/null 2>&1 || iptables -A INPUT -f -j DROP

  # Drop SYN packets with suspicious MSS value
  iptables -C INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP > /dev/null 2>&1 || iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP

  # Configure loopback
  iptables -C INPUT -i lo -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -i lo -j ACCEPT
  iptables -C INPUT ! -i lo -s 127.0.0.0/8 -j DROP > /dev/null 2>&1 || iptables -A INPUT ! -i lo -s 127.0.0.0/8 -j DROP

  # Allow ICMP
  iptables -C INPUT -p icmp -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p icmp -j ACCEPT

  # Allow SSH
  iptables -C INPUT -p tcp -m tcp --dport \\\$SSH_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp --dport \\\$SSH_PORT -j ACCEPT

  # Allow WireGuard
  iptables -C INPUT -p udp --dport \\\$WG_CON_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p udp --dport \\\$WG_CON_PORT -j ACCEPT

  # Special case for WG Portal from reverse proxy
  iptables -C INPUT -p tcp -m tcp -i brdockext -s \\\$DOCK_EXT_NET --dport \\\$WG_PORTAL_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp -i brdockext -s \\\$DOCK_EXT_NET --dport \\\$WG_PORTAL_PORT -j ACCEPT
  iptables -D DOCKER-USER -s 127.0.0.0/8 -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j RETURN 2> /dev/null
  iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j DROP 2> /dev/null
  iptables -I DOCKER-USER -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j DROP
  iptables -I DOCKER-USER -s 127.0.0.0/8 -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j RETURN

  # Policy drop for input and forward
  iptables -P INPUT DROP
  iptables -P FORWARD DROP

  # Policy drop all ipv6 traffic
  ip6tables -P INPUT DROP
  ip6tables -P FORWARD DROP
  ip6tables -P OUTPUT DROP

  sysctl --system > /dev/null 2>&1

EOFBS

# Special case - if RelayServer is behind a firewall and using a private IP for default route,
# then allow traffic from the gateway, since raw table blocks all private ranges
def_route_gate=\$(ip route | grep -e "^default" | awk '{print \$3}')
is_def_priv=\$(checkIsIPPrivate \$def_route_gate)
def_route_cidr_part=\$(ip route | grep \$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1) | grep / | xargs | cut -d" " -f1 | cut -d"/" -f2)
if [ "\$is_def_priv" = "true" ]; then
  echo "Default route is in private range, adding allowance to (raw)iptables..."
  sudo sed -i "/  # Block spoofed packets.*/a\  iptables -t raw -C PREROUTING -s \$def_route_gate\/\$def_route_cidr_part -i \$default_iface -j ACCEPT > \/dev\/null 2>&1 || iptables -t raw -I PREROUTING -s \$def_route_gate\/\$def_route_cidr_part -i \$default_iface -j ACCEPT" \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
else
  echo "Default route is in public range."
fi

  sudo chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh >/dev/null <<EOFBS
#!/bin/bash
  set +e

  SSH_PORT=$RELAYSERVER_SSH_PORT
  WG_CON_PORT=$RELAYSERVER_WG_PORT
  WG_PORTAL_PORT=$RELAYSERVER_WG_PORTAL_PORT
  DOCK_EXT_NET=$NET_EXTERNAL_SUBNET
  ports_list=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT

  portsArr=(\\\$(echo \\\$ports_list | tr "," "\n"))
  for cur_port in "\\\${portsArr[@]}"
  do
    iptables -D DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j ACCEPT 2> /dev/null
    iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j DROP 2> /dev/null
  done

  iptables -D INPUT -f -j DROP > /dev/null 2>&1
  iptables -D INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP > /dev/null 2>&1
  iptables -D INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset > /dev/null 2>&1
  iptables -D INPUT -m conntrack --ctstate INVALID -j DROP > /dev/null 2>&1
  iptables -D INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -i lo -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT ! -i lo -s 127.0.0.0/8 -j DROP > /dev/null 2>&1
  iptables -D INPUT -p icmp -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p tcp -m tcp --dport \\\$SSH_PORT -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p udp --dport \\\$WG_CON_PORT -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p tcp -m tcp -i brdockext -s \\\$DOCK_EXT_NET --dport \\\$WG_PORTAL_PORT -j ACCEPT > /dev/null 2>&1
  iptables -D DOCKER-USER -s 127.0.0.0/8 -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j ACCEPT 2> /dev/null
  iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j DROP 2> /dev/null

  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1

  iptables -P INPUT ACCEPT
  ip6tables -P INPUT ACCEPT
  ip6tables -P FORWARD ACCEPT
  ip6tables -P OUTPUT ACCEPT

EOFBS
  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service >/dev/null <<EOFBS
[Unit]
Description=Load HSHQ IP Tables
DefaultDependencies=no

Before=network-pre.target
Wants=network-pre.target

Wants=systemd-modules-load.service local-fs.target
After=systemd-modules-load.service local-fs.target

Conflicts=shutdown.target
Before=shutdown.target

[Service]
Type=oneshot
RemainAfterExit=no
ExecStart=\$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh

[Install]
WantedBy=multi-user.target
EOFBS
  sudo chmod 644 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  sudo chown root:root \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo ln -s \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service /etc/systemd/system/runOnBootRoot.service
  sudo systemctl daemon-reload
  sudo systemctl enable runOnBootRoot

}

function outputCaddyScripts()
{
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh >/dev/null <<EOFCD
#!/bin/bash
RELAYSERVER_HSHQ_NONBACKUP_DIR=\$RELAYSERVER_HSHQ_NONBACKUP_DIR
RELAYSERVER_HSHQ_SSL_DIR=\$RELAYSERVER_HSHQ_SSL_DIR

docker container stop caddy
rm -fr \\\$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/config/*
rm -fr \\\$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/data/*
rm -fr \\\$RELAYSERVER_HSHQ_SSL_DIR/caddy/*
docker container start caddy

EOFCD

  sudo chmod 0500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh
  sudo chown root:root \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh
  cat <<EOFCD > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addLECertDomains.sh
#!/bin/bash

subdomlist=\\\$1
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  set +e
  leCertsArr=(\\\$(echo "\\\$subdomlist" | tr "," "\n"))
  for subdom in "\\\${leCertsArr[@]}"
  do
    if [ -z "\\\$subdom" ]; then continue; fi
    grep "# LE certs path \\\$subdom BEGIN" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile >/dev/null
    if [ \\\$? -ne 0 ]; then
      strBlock=""
      strBlock=\\\$strBlock"# LE certs path \\\$subdom BEGIN\n"
      strBlock=\\\$strBlock"http://\\\$subdom {\n"
      strBlock=\\\$strBlock"  handle /.well-known/acme-challenge/* {\n"
      strBlock=\\\$strBlock"    reverse_proxy \\\$subdom {\n"
      strBlock=\\\$strBlock"      import sn-resolver\n"
      strBlock=\\\$strBlock"    }\n"
      strBlock=\\\$strBlock"  }\n"
      strBlock=\\\$strBlock"}\n"
      strBlock=\\\$strBlock"# LE certs path \\\$subdom END\n"
      echo -e "\\\$strBlock" >> \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
    fi
  done
  docker container restart caddy
}

main "\\\$@"
EOFCD
  chmod 0500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addLECertDomains.sh


  cat <<EOFCD > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeLECertDomains.sh
#!/bin/bash
set +e

RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  subdomlist="\\\$1"
  leCertsArr=(\\\$(echo "\\\$subdomlist" | tr "," "\n"))
  for subdom in "\\\${leCertsArr[@]}"
  do
    if [ -z "\\\$subdom" ]; then continue; fi
    sed -i "/# LE certs path \\\$subdom BEGIN/,/# LE certs path \\\$subdom END/d" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  done
  cat -s \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile > \\\$HOME/tmpcadfile
  mv \\\$HOME/tmpcadfile \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  docker container restart caddy
}

main "\\\$@"
EOFCD
  chmod 0500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeLECertDomains.sh

  cat <<EOFEX > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addExposeDomains.sh
#!/bin/bash

RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  subdomlist="\\\$1"
  exposeArr=(\\\$(echo "\\\$subdomlist" | tr "," "\n"))
  for subdom in "\\\${exposeArr[@]}"
  do
    if [ -z "\\\$subdom" ]; then continue; fi
    grep "# Expose domain \\\$subdom BEGIN" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile >/dev/null
    if [ \\\$? -ne 0 ]; then
      strBlock=""
      strBlock=\\\$strBlock"# Expose domain \\\$subdom BEGIN\n"
      strBlock=\\\$strBlock"https://\\\$subdom {\n"
      strBlock=\\\$strBlock"  import safe-header\n"
      strBlock=\\\$strBlock"  reverse_proxy https://\\\$subdom {\n"
      strBlock=\\\$strBlock"    import sn-resolver\n"
      strBlock=\\\$strBlock"  }\n"
      strBlock=\\\$strBlock"}\n"
      strBlock=\\\$strBlock"# Expose domain \\\$subdom END\n"
      echo -e "\\\$strBlock" >> \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
    fi
  done
  docker container restart caddy
}
main "\\\$@"
EOFEX
  chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addExposeDomains.sh

  cat <<EOFEX > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeExposeDomains.sh
#!/bin/bash
set +e

RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  subdomlist="\\\$1"
  exposeArr=(\\\$(echo "\\\$subdomlist" | tr "," "\n"))
  for subdom in "\\\${exposeArr[@]}"
  do
    if [ -z "\\\$subdom" ]; then continue; fi
    sed -i "/# Expose domain \\\$subdom BEGIN/,/# Expose domain \\\$subdom END/d" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  done
  cat -s \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile > \\\$HOME/tmpcadfile
  mv \\\$HOME/tmpcadfile \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  docker container restart caddy
}

main "\\\$@"
EOFEX
  chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeExposeDomains.sh

}

function outputRelayedDomainsScript()
{
  cat <<EOFRD > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addRelayedDomains.sh
#!/bin/bash
set +e

domains_to_add=\\\$1
deliver_to_host=\\\$2
deliver_to_ip=\\\$3
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  addRelayedDomains
}

function addRelayedDomains()
{
  if [ -z \\\$deliver_to_ip ]; then
    deliver_ip=\\\$(getIPFromHostname \\\$deliver_to_host)
  else
    deliver_ip=\\\$deliver_to_ip
  fi
  docker exec mail-relay-postfix /etc/postfix/scripts/addRelayedMailDomains.sh \\\$domains_to_add \\\$deliver_to_host
  # Add domains to caddy dnsmasq container
  domains_to_add_Arr=(\\\$(echo \\\$domains_to_add | tr "," "\n"))
  for add_domain in "\\\${domains_to_add_Arr[@]}"
  do
    sed -i "/.\\\$add_domain/d" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/dns/dnsmasq.conf
    echo "address=/.\\\$add_domain/\\\$deliver_ip" >> \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/dns/dnsmasq.conf
  done
  docker container restart caddy-dns
  
  grep \\\${deliver_to_host} \\\$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf >/dev/null
  if [ \\\$? -ne 0 ]; then
    echo "local-data: \"\\\${deliver_to_host}. A \\\$deliver_ip\"" >> \\\$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf
    echo "local-data-ptr: \"\\\$deliver_ip \\\${deliver_to_host}.\"" >> \\\$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf
  fi
  docker container restart mail-relay-unbound
}

function getIPFromHostname()
{
  echo \\\$(dig \\\$1 +short | grep '^[.0-9]*\\\$')
}

main "\\\$@"
EOFRD
  chmod 0500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addRelayedDomains.sh

  cat <<EOFRD > \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeRelayedDomains.sh
#!/bin/bash
set +e

domains_to_remove=\\\$1
deliver_to_host=\\\$2
mail_user_domain=\\\$3
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  removeRelayedDomains
}

function removeRelayedDomains()
{
  docker exec mail-relay-postfix /etc/postfix/scripts/removeRelayedMailDomains.sh \\\$domains_to_remove \\\$mail_user_domain

  # Remove domains from caddy dnsmasq container
  domains_to_rem_Arr=(\\\$(echo \\\$domains_to_remove | tr "," "\n"))
  for rem_domain in "\\\${domains_to_rem_Arr[@]}"
  do
    sed -i "/.\\\$rem_domain/d" \\\$RELAYSERVER_HSHQ_STACKS_DIR/caddy/dns/dnsmasq.conf
  done
  docker container restart caddy-dns

  if ! [ -z \\\$deliver_to_host ]; then
    sed -i "/\\\$deliver_to_host/d" \\\$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf
    docker container restart mail-relay-unbound
  fi
}

main "\\\$@"
EOFRD
  chmod 0500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeRelayedDomains.sh
}

function outputPortforwardingScripts()
{
  sudo mkdir -p \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding

  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPortForward.sh >/dev/null <<EOFCD
#!/bin/bash
set +e

ID=\\\$1
ExtStart=\\\$2
ExtEnd=\\\$3
IntStart=\\\$4
IntEnd=\\\$5
Protocol=\\\$6
IPAddress=\\\$7
RELAYSERVER_PF_ADD_DIR=\$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
RELAYSERVER_PF_REMOVE_DIR=\$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding
RELAYSERVER_WG_SV_IP=$RELAYSERVER_WG_SV_IP
RELAYSERVER_WG_INTERFACE_NAME=$RELAYSERVER_WG_INTERFACE_NAME
DEFAULT_IFACE=\\\$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \\\$2}' | xargs | cut -d" " -f1)

function main()
{
  tee \\\$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\\\${ID}.sh >/dev/null <<EOFSC
#!/bin/bash
set +e

function main()
{
  case "\\\$Protocol" in
    tcp)
      addTCP
    ;;
    udp)
      addUDP
    ;;
    both)
      addTCP
      addUDP
    ;;
    *)
    ;;
  esac
}

function addTCP()
{
  iptables -C PREROUTING -t nat -i \\\$DEFAULT_IFACE -p tcp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart > /dev/null 2>&1 || iptables -A PREROUTING -t nat -i \\\$DEFAULT_IFACE -p tcp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart
  iptables -C FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT
  iptables -C FORWARD -i \\\$RELAYSERVER_WG_INTERFACE_NAME -o \\\$DEFAULT_IFACE -p tcp -s \\\$IPAddress --sport \\\$IntStart:\\\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \\\$RELAYSERVER_WG_INTERFACE_NAME -o \\\$DEFAULT_IFACE -p tcp -s \\\$IPAddress --sport \\\$IntStart:\\\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT
  iptables -C POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart > /dev/null 2>&1 || iptables -A POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart
}

function addUDP()
{
  iptables -C PREROUTING -t nat -i \\\$DEFAULT_IFACE -p udp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart > /dev/null 2>&1 || iptables -A PREROUTING -t nat -i \\\$DEFAULT_IFACE -p udp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart
  iptables -C FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd -j ACCEPT
  iptables -C POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart > /dev/null 2>&1 || iptables -A POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart
}

main "\\\\\\\$@"
EOFSC
  chmod 744 \\\$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\\\${ID}.sh
  \\\$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\\\${ID}.sh

  tee \\\$RELAYSERVER_PF_REMOVE_DIR/pfRem-\\\${ID}.sh >/dev/null <<EOFSC
#!/bin/bash
set +e

function main()
{
  case "\\\$Protocol" in
    tcp)
      remTCP
    ;;
    udp)
      remUDP
    ;;
    both)
      remTCP
      remUDP
    ;;
    *)
    ;;
  esac
}

function remTCP()
{
  iptables -D PREROUTING -t nat -i \\\$DEFAULT_IFACE -p tcp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart > /dev/null 2>&1
  iptables -D FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT > /dev/null 2>&1
  iptables -D FORWARD -i \\\$RELAYSERVER_WG_INTERFACE_NAME -o \\\$DEFAULT_IFACE -p tcp -s \\\$IPAddress --sport \\\$IntStart:\\\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1
  iptables -D POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart > /dev/null 2>&1
}

function remUDP()
{
  iptables -D PREROUTING -t nat -i \\\$DEFAULT_IFACE -p udp --dport \\\$ExtStart:\\\$ExtEnd -j DNAT --to-destination \\\$IPAddress:\\\$IntStart-\\\$IntEnd/\\\$ExtStart > /dev/null 2>&1
  iptables -D FORWARD -i \\\$DEFAULT_IFACE -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \\\$IPAddress --dport \\\$IntStart:\\\$IntEnd -j ACCEPT > /dev/null 2>&1
  iptables -D POSTROUTING -t nat -o \\\$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \\\$IntStart:\\\$IntEnd -d \\\$IPAddress -j SNAT --to-source \\\$RELAYSERVER_WG_SV_IP:\\\$ExtStart-\\\$ExtEnd/\\\$IntStart > /dev/null 2>&1
}

main "\\\\\\\$@"
EOFSC
  chmod 744 \\\$RELAYSERVER_PF_REMOVE_DIR/pfRem-\\\${ID}.sh

}

main "\\\$@"

EOFCD
  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPortForward.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePortForward.sh >/dev/null <<EOFCD
#!/bin/bash
set +e

ID=\\\$1
RELAYSERVER_PF_REMOVE_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding
RELAYSERVER_PF_ADD_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts

\\\$RELAYSERVER_PF_REMOVE_DIR/pfRem-\\\${ID}.sh
rm -f \\\$RELAYSERVER_PF_REMOVE_DIR/pfRem-\\\${ID}.sh
rm -f \\\$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\\\${ID}.sh
EOFCD
  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePortForward.sh

}

function getPortainerToken()
{
  while [ -n "\$1" ]
  do case "\$1" in
  -u) port_username="\$2";;
  -p) port_password="\$2"
  shift ;;
  --) shift
  break ;;
  esac
  shift
  done
  if [ -z "\$port_username" ]; then
    read -r -p "Enter the portainer username: " port_username
	echo
  fi
  if [ -z "\$port_password" ]; then
    read -r -s -p "Enter the portainer password: " port_password
	echo
  fi

  echo \$(http --check-status --ignore-stdin --verify=no https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/auth username=\$port_username password=\$port_password | jq -r .jwt)
}

function createStackJson()
{
  echo "{\"Name\":\"\$1\",""\$( jq -Rscjr '{StackFileContent: . }' \$2 | tail -c +2 | head -c -1 )"",\"Env\":"\$(envToJson \$3)"}"
}

function envToJson()
{
  if [ -z "\$1" ]; then
    echo "[]"
	return
  fi
  OLDIFS=\$IFS
  IFS=\$(echo -en "\n\b")
  lines=\$(cat \$1)
  jsonstring="["
  for line in \$lines
  do
    key="\$(sed 's/=.*//' <<< "\$line")"
    value="\$(sed 's/^[^=]*=//' <<< "\$line")"
    jsonstring="\$jsonstring{\"name\":\"\$key\",\"value\":\"\$value\"},"
  done
  jsonstring="\${jsonstring%?}]"
  IFS=\$OLDIFS
  echo \$jsonstring
}

function getStackID()
{
  stackID="NA"
  stackName=\$1
  qry=\$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" endpointId==1)
  for row in \$(echo "\${qry}" | jq -r '.[] | @base64'); do
    _jq()
    {
      echo \${row} | base64 --decode | jq -r \${1}
    }
    if [ "\$(_jq '.Name')" = "\$stackName" ]; then
      stackID=\$(_jq '.Id')
      break
    fi
  done
  if ! [ "\$stackID" = "NA" ]; then
    echo \$stackID
  fi
}

function startStopStack()
{
  stackName=\$1
  startStop=\$2
  stackID=\$(getStackID \$stackName)
  http --check-status --ignore-stdin --verify=no --timeout=300 POST https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/stacks/\$stackID/\$startStop "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" endpointId==1 > /dev/null
}

function installStack()
{
  stack_name=\$1
  container_name=\$2
  stack_search_string=\$3
  envfile=\$4
  installLogNotify "Installing Stack (\$stack_name)"
  sudo -v
  echo
  echo "Creating stack: \$stack_name"
  echo "\$(createStackJson \$stack_name \$HOME/\$stack_name-compose.yml "\$envfile")" > \$HOME/\$stack_name-json.tmp
  http --check-status --ignore-stdin --verify=no --timeout=300 https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/stacks/create/standalone/string "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" endpointId==1 @\$HOME/\$stack_name-json.tmp > /dev/null
  search=\$stack_search_string
  isFound=false
  i=0
  set +e
  while [ \$i -le 300 ]
  do
    findtext=\$(docker logs \$container_name 2>&1 | grep "\$search")
    if ! [ -z "\$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=\$i seconds..."
    sleep 1
    i=\$((i+1))
  done
  set -e
  if ! [ "\$isFound" = "true" ]; then
    echo "\$stack_name did not start up correctly..."
    exit 1
  fi
  sleep 5
  echo
  rm -f \$HOME/\$stack_name-json.tmp
  rm -f \$HOME/\$stack_name-compose.yml
  rm -f \$envfile
}

function startWazuhAgent()
{
  curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | sudo gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import && sudo chmod 644 /usr/share/keyrings/wazuh.gpg
  echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo WAZUH_MANAGER="$SUB_WAZUH.$HOMESERVER_DOMAIN" DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wazuh-agent=$WAZUH_AGENT_VERSION
  sudo apt-mark hold wazuh-agent
  sudo systemctl daemon-reload
  set +e
  sudo grep "/var/log/docker/" /var/ossec/etc/ossec.conf
  if [ \$? -ne 0 ]; then
    sudo sed -i "/<\/ossec_config>/{s//  <localfile>\n    <log_format>syslog<\/log_format>\n    <location>\/var\/log\/docker\/*<\/location>\n  <\/localfile>\n\n<\/ossec_config>/;:p;n;bp}" /var/ossec/etc/ossec.conf
  fi
  sudo tee /var/ossec/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
  sudo chmod 640 /var/ossec/etc/authd.pass
  sudo chown root:wazuh /var/ossec/etc/authd.pass
  set -e
  sudo systemctl enable wazuh-agent
  sudo systemctl start wazuh-agent
}

function getDockerSubnet()
{
  echo \$(docker network inspect \$1 | grep Subnet | awk '{print \$2}' | sed 's/[",]//g')
}

function installPortainer()
{
  if [ -d "\$RELAYSERVER_HSHQ_STACKS_DIR/portainer" ]; then
    return
  fi
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/portainer
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/certs
  outputConfigPortainer

  generateCert portainer portainer
  
  PORTAINER_DB_KEY=\$(pwgen -c -n 64 1)
  echo \$PORTAINER_DB_KEY | sudo tee \$RELAYSERVER_HSHQ_SECRETS_DIR/portainer_key.txt >/dev/null
  sudo chmod 0400 \$RELAYSERVER_HSHQ_SECRETS_DIR/portainer_key.txt
  cd ~
  docker compose -f \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/docker-compose.yml up -d
  search="starting HTTPS server"
  isFound=false
  i=0
  set +e
  while [ \$i -le 300 ]
  do
    findtext=\$(docker logs portainer 2>&1 | grep "\$search")
    if ! [ -z "\$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=\$i seconds..."
    sleep 1
    i=\$((i+1))
  done
  set -e
  if ! [ "\$isFound" = "true" ]; then
    echo "Portainer did not start up correctly..."
    exit 1
  fi

  echo "Portainer has been loaded and started..."
  echo "Sleeping 10 seconds to ensure Portainer has loaded completely."
  sleep 10

  RELAYSERVER_PORTAINER_ADMIN_USERID=\$(http --verify=no --print="b" POST https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/users/admin/init Username="$RELAYSERVER_PORTAINER_ADMIN_USERNAME" Password="$RELAYSERVER_PORTAINER_ADMIN_PASSWORD" | jq -r .Id)
  RELAYSERVER_PORTAINER_TOKEN="\$(getPortainerToken -u $RELAYSERVER_PORTAINER_ADMIN_USERNAME -p $RELAYSERVER_PORTAINER_ADMIN_PASSWORD)"
  http -f --verify=no --timeout=300 --print="b" POST https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/endpoints "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" Name="$RELAYSERVER_NAME" EndpointCreationType=1 >/dev/null

  # Enable dark mode because it looks better
  echo "{\"theme\":{\"color\":\"dark\"}}" > portainer-json.tmp
  http --verify=no --timeout=300 PUT https://127.0.0.1:$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT/api/users/\$RELAYSERVER_PORTAINER_ADMIN_USERID "Authorization: Bearer \$RELAYSERVER_PORTAINER_TOKEN" @portainer-json.tmp > /dev/null
  rm portainer-json.tmp
}

function outputConfigPortainer()
{
  cat <<EOFPC > \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/docker-compose.yml
$STACK_VERSION_PREFIX portainer $(getScriptStackVersion portainer)

services:
  portainer:
    image: $IMG_PORTAINER
    container_name: portainer
    hostname: portainer
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    env_file: portainer.env
    networks:
      - dock-proxy-net
      # Comment out the external network to disable external (web) access
      # Also ensure to comment out the ports section and dock-ext-net section at the bottom
      - dock-ext-net
    ports:
      - "$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT:9443"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - \$RELAYSERVER_HSHQ_STACKS_DIR/portainer:/data
      - \$RELAYSERVER_HSHQ_SSL_DIR/portainer.crt:/certs/portainer.crt
      - \$RELAYSERVER_HSHQ_SSL_DIR/portainer.key:/certs/portainer.key
      - \$RELAYSERVER_HSHQ_SECRETS_DIR/portainer_key.txt:/run/secrets/portainer
    command:
      --sslcert /certs/portainer.crt
      --sslkey /certs/portainer.key
      --http-disabled

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFPC

  cat <<EOFPC > \$RELAYSERVER_HSHQ_STACKS_DIR/portainer/portainer.env
RELAYSERVER_HSHQ_DATA_DIR=\$RELAYSERVER_HSHQ_DATA_DIR
RELAYSERVER_HSHQ_NONBACKUP_DIR=\$RELAYSERVER_HSHQ_NONBACKUP_DIR
RELAYSERVER_HSHQ_SCRIPTS_DIR=\$RELAYSERVER_HSHQ_SCRIPTS_DIR
RELAYSERVER_HSHQ_SECRETS_DIR=\$RELAYSERVER_HSHQ_SECRETS_DIR
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR
RELAYSERVER_HSHQ_SSL_DIR=\$RELAYSERVER_HSHQ_SSL_DIR
TZ=\$TZ
UID=\$USERID
GID=\$GROUPID
EOFPC
}

function installAdGuard()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/adguard
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/adguard/conf
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/adguard
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/adguard/work

  outputConfigAdGuard
  generateCert adguard adguard

  set +e
  sudo systemctl stop systemd-resolved > /dev/null 2>&1
  sudo systemctl disable systemd-resolved > /dev/null 2>&1
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  sudo tee /etc/resolv.conf >/dev/null <<EOFR
nameserver 127.0.0.1
EOFR
  if sudo test -d /etc/netplan; then
    for cur_np in /etc/netplan/*
    do
      if ! test -f "\$cur_np"; then continue; fi
      sudo sed -i "s|8.8.8.8|9.9.9.9|g" \$cur_np
      sudo sed -i "s|8.8.4.4|149.112.112.112|g" \$cur_np
    done
    sudo which netplan && sudo netplan apply > /dev/null 2>&1
  fi
  set -e
  installStack adguard adguard "entering listener loop proto=tls" \$HOME/adguard.env
}

function outputConfigAdGuard()
{
  RELAYSERVER_ADGUARD_ADMIN_PASSWORD_HASH=\$(htpasswd -B -n -b $RELAYSERVER_ADGUARD_ADMIN_USERNAME $RELAYSERVER_ADGUARD_ADMIN_PASSWORD | cut -d":" -f2-)
  
  cat <<EOFAC > \$HOME/adguard-compose.yml
$STACK_VERSION_PREFIX adguard $(getScriptStackVersion adguard)

services:
  adguard:
    image: $IMG_ADGUARD
    container_name: adguard
    hostname: adguard
    restart: unless-stopped
    env_file: stack.env
    user: "\\\${UID}:\\\${GID}"
    security_opt:
      - no-new-privileges:true
    networks:
      dock-proxy-net:
      dock-ext-net:
        ipv4_address: ${NET_EXTERNAL_SUBNET_PREFIX}.253
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/adguard/conf:/opt/adguardhome/conf
      - \\\${RELAYSERVER_HSHQ_NONBACKUP_DIR}/adguard/work:/opt/adguardhome/work
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/adguard.crt:/opt/adguardhome/conf/cert.pem
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/adguard.key:/opt/adguardhome/conf/key.pem

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFAC

  cat <<EOFAC > \$HOME/adguard.env
GODEBUG=tlskyber=0
EOFAC

  cat <<EOFAD > \$RELAYSERVER_HSHQ_STACKS_DIR/adguard/conf/AdGuardHome.yaml
http:
  pprof:
    port: 6060
    enabled: false
  address: 0.0.0.0:3000
  session_ttl: 720h
users:
  - name: $RELAYSERVER_ADGUARD_ADMIN_USERNAME
    password: \$RELAYSERVER_ADGUARD_ADMIN_PASSWORD_HASH
auth_attempts: 5
block_auth_min: 15
http_proxy: ""
language: en
theme: dark
dns:
  bind_hosts:
    - 0.0.0.0
  port: 53
  anonymize_client_ip: false
  ratelimit: 0
  ratelimit_subnet_len_ipv4: 24
  ratelimit_subnet_len_ipv6: 56
  ratelimit_whitelist: []
  refuse_any: true
  upstream_dns:
    - https://dns.quad9.net/dns-query
    - https://anycast.dns.nextdns.io/dns-query
    - quic://dns-unfiltered.adguard.com:784
    - https://dns.nextdns.io/dns-query
  upstream_dns_file: ""
  bootstrap_dns:
    - 9.9.9.9
    - 149.112.112.112
  fallback_dns:
    - 9.9.9.10
    - 149.112.112.10
    - 94.140.14.14
    - 94.140.15.15
  upstream_mode: parallel
  fastest_timeout: 1s
  allowed_clients:
    - 127.0.0.0/8
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  disallowed_clients: []
  blocked_hosts:
    - version.bind
    - id.server
    - hostname.bind
  trusted_proxies:
    - 127.0.0.0/8
    - ::1/128
  cache_size: 41943040
  cache_ttl_min: 0
  cache_ttl_max: 0
  cache_optimistic: true
  bogus_nxdomain: []
  aaaa_disabled: true
  enable_dnssec: true
  edns_client_subnet:
    custom_ip: ""
    enabled: false
    use_custom: false
  max_goroutines: 300
  handle_ddr: true
  ipset: []
  ipset_file: ""
  bootstrap_prefer_ipv6: false
  upstream_timeout: 3s
  private_networks: []
  use_private_ptr_resolvers: true
  local_ptr_upstreams: []
  use_dns64: false
  dns64_prefixes: []
  serve_http3: false
  use_http3_upstreams: false
  serve_plain_dns: true
  hostsfile_enabled: true
tls:
  enabled: true
  server_name: adguard
  force_https: true
  port_https: 443
  port_dns_over_tls: 853
  port_dns_over_quic: 853
  port_dnscrypt: 0
  dnscrypt_config_file: ""
  allow_unencrypted_doh: false
  certificate_chain: ""
  private_key: ""
  certificate_path: /opt/adguardhome/conf/cert.pem
  private_key_path: /opt/adguardhome/conf/key.pem
  strict_sni_check: false
querylog:
  dir_path: ""
  ignored:
    - $HOMESERVER_DOMAIN
    - '*.$HOMESERVER_DOMAIN'
  interval: 720h
  size_memory: 1000
  enabled: true
  file_enabled: true
statistics:
  dir_path: ""
  ignored:
    - $HOMESERVER_DOMAIN
    - '*.$HOMESERVER_DOMAIN'
  interval: 720h
  enabled: true
filters:
  - enabled: true
    url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
    name: AdGuard DNS filter
    id: 1
  - enabled: true
    url: https://adaway.org/hosts.txt
    name: AdAway Default Blocklist
    id: 2
  - enabled: false
    url: https://someonewhocares.org/hosts/zero/hosts
    name: Dan Pollock's List
    id: 1657273139
  - enabled: false
    url: https://raw.githubusercontent.com/Perflyst/PiHoleBlocklist/master/SmartTV-AGH.txt
    name: Perflyst and Dandelion Sprout's Smart-TV Blocklist
    id: 1657273140
  - enabled: false
    url: https://raw.githubusercontent.com/crazy-max/WindowsSpyBlocker/master/data/hosts/spy.txt
    name: WindowsSpyBlocker - Hosts spy rules
    id: 1657273141
  - enabled: false
    url: https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareAdGuardHome.txt
    name: Dandelion Sprout's Anti-Malware List
    id: 1657273142
  - enabled: false
    url: https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt
    name: NoCoin Filter List
    id: 1657273143
  - enabled: false
    url: https://raw.githubusercontent.com/durablenapkin/scamblocklist/master/adguard.txt
    name: Scam Blocklist by DurableNapkin
    id: 1657273144
  - enabled: false
    url: https://raw.githubusercontent.com/mitchellkrogza/The-Big-List-of-Hacked-Malware-Web-Sites/master/hosts
    name: The Big List of Hacked Malware Web Sites
    id: 1657273145
  - enabled: false
    url: https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-agh-online.txt
    name: Online Malicious URL Blocklist
    id: 1657273146
  - enabled: true
    url: https://pgl.yoyo.org/adservers/serverlist.php?hostformat=adblockplus&showintro=1&mimetype=plaintext
    name: Peter Lowe's List
    id: 1657273147
whitelist_filters: []
user_rules:
  - '@@||api.ipify.org^'
dhcp:
  enabled: false
  interface_name: ""
  local_domain_name: lan
  dhcpv4:
    gateway_ip: ""
    subnet_mask: ""
    range_start: ""
    range_end: ""
    lease_duration: 86400
    icmp_timeout_msec: 1000
    options: []
  dhcpv6:
    range_start: ""
    lease_duration: 86400
    ra_slaac_only: false
    ra_allow_slaac: false
filtering:
  blocking_ipv4: ""
  blocking_ipv6: ""
  blocked_services:
    schedule:
      time_zone: Local
    ids: []
  protection_disabled_until: null
  safe_search:
    enabled: false
    bing: true
    duckduckgo: true
    ecosia: true
    google: true
    pixabay: true
    yandex: true
    youtube: true
  blocking_mode: default
  parental_block_host: family-block.dns.adguard.com
  safebrowsing_block_host: standard-block.dns.adguard.com
  rewrites:
    - domain: '*.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN'
      answer: $RELAYSERVER_SERVER_IP
    - domain: '*.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN'
      answer: $RELAYSERVER_WG_SV_IP
    - domain: '$HOMESERVER_DOMAIN'
      answer: $RELAYSERVER_WG_HS_IP
    - domain: '*.$HOMESERVER_DOMAIN'
      answer: $RELAYSERVER_WG_HS_IP
  safe_fs_patterns:
    - /opt/adguardhome/work/data/userfilters/*
  safebrowsing_cache_size: 10485760
  safesearch_cache_size: 10485760
  parental_cache_size: 10485760
  cache_time: 30
  filters_update_interval: 24
  blocked_response_ttl: 10
  filtering_enabled: true
  parental_enabled: false
  safebrowsing_enabled: false
  protection_enabled: true
clients:
  runtime_sources:
    whois: true
    arp: true
    rdns: true
    dhcp: true
    hosts: true
  persistent: []
log:
  enabled: true
  file: ""
  max_backups: 0
  max_size: 100
  max_age: 3
  compress: false
  local_time: false
  verbose: false
os:
  group: ""
  user: ""
  rlimit_nofile: 0
schema_version: 29
EOFAD
}

function installMailRelay()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/config
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/sasl
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/var
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/redis
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/clamav
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound

  mail_relay_subnet=\$(getDockerSubnet dock-mailrelay)
  mail_relay_net_prefix=\$(echo \$mail_relay_subnet | rev | cut -d '.' -f2- | rev)

  pw_hash=\$(docker run --rm $IMG_MAIL_RELAY_RSPAMD rspamadm pw -p $RELAYSERVER_RSPAMD_ADMIN_PASSWORD)
  outputConfigMailRelay
  echo "Generating DH parameters, 1024 bit long safe prime..."
  openssl dhparam -out \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/dh1024.pem 1024 > /dev/null 2>&1
  echo "Generating DH parameters, 512 bit long safe prime..."
  openssl dhparam -out \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/dh512.pem 512 > /dev/null 2>&1
  openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:4096 -keyout \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/key.pem -out \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/cert.pem -subj "/C=US/ST=MO/L=STL/O=HomeServerHQ/OU=SampleCert/CN=$RELAYSERVER_EXT_EMAIL_HOSTNAME"
  chmod 0400 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/cert.pem
  chmod 0400 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/tls/key.pem
  installStack mail-relay mail-relay-postfix "Starting Postfix Mail Transport Agent" \$HOME/mail-relay.env
  docker exec mail-relay-postfix bash -c "echo $SMTP_RELAY_PASSWORD | saslpasswd2 -c -p -f /etc/postfix/sasl/sasldb2 $SMTP_RELAY_USERNAME"
}

function outputConfigMailRelay()
{
  cat <<EOFPF > \$HOME/mail-relay-compose.yml
$STACK_VERSION_PREFIX mail-relay $(getScriptStackVersion mail-relay)

services:
  mail-relay-postfix:
    image: $IMG_MAIL_RELAY_POSTFIX
    container_name: mail-relay-postfix
    hostname: mail-relay-postfix
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ext-net
      - dock-mailrelay-net
    ports:
      - "$MAILU_PORT_1:$MAILU_PORT_1"
      - "$MAILU_PORT_5:$MAILU_PORT_5"
    dns:
      - \\\${SUBNET_PREFIX}.253
    depends_on:
      - mail-relay-redis
      - mail-relay-unbound
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/etc/postfix/tls/${CERTS_ROOT_CA_NAME}.crt:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/postfix/config:/etc/postfix/config
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/postfix/sasl:/etc/postfix/sasl
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/postfix/scripts:/etc/postfix/scripts
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/postfix/tls:/etc/postfix/tls
      - caddy-certs:/caddycerts:ro
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.mailcerts-15minute.schedule=@every 15m"
      - "ofelia.job-exec.mailcerts-15minute.command=/etc/postfix/scripts/copycerts.sh"
      - "ofelia.job-exec.mailcerts-daily.schedule=0 0 8 * * *"
      - "ofelia.job-exec.mailcerts-daily.command=/etc/postfix/scripts/copycerts.sh"
      - "ofelia.job-exec.mailcerts-daily.smtp-host=$SUB_POSTFIX.$HOMESERVER_DOMAIN"
      - "ofelia.job-exec.mailcerts-daily.smtp-port=$MAILU_PORT_5"
      - "ofelia.job-exec.mailcerts-daily.smtp-user=$EMAIL_SMTP_EMAIL_ADDRESS"
      - "ofelia.job-exec.mailcerts-daily.smtp-password=$EMAIL_SMTP_PASSWORD"
      - "ofelia.job-exec.mailcerts-daily.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.mailcerts-daily.email-from=Mail Certificate Updater <$EMAIL_SMTP_EMAIL_ADDRESS>"
      - "ofelia.job-exec.mailcerts-daily.mail-only-on-error=true"

  mail-relay-rspamd:
    image: $IMG_MAIL_RELAY_RSPAMD
    container_name: mail-relay-rspamd
    hostname: mail-relay-rspamd
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ext-net
      - dock-proxy-net
      - dock-mailrelay-net
    dns:
      - \\\${SUBNET_PREFIX}.253
    depends_on:
      - mail-relay-redis
      - mail-relay-unbound
      - mail-relay-postfix
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-mail-relay-rspamd-var:/var/lib/rspamd
      - v-mail-relay-rspamd-conf:/etc/rspamd/local.d

  mail-relay-unbound:
    image: $IMG_MAIL_RELAY_UNBOUND
    container_name: mail-relay-unbound
    hostname: mail-relay-unbound
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-ext-net:
      dock-mailrelay-net:
        ipv4_address: \\\${SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/unbound/mailhosts.conf:/opt/unbound/etc/unbound/a-records.conf:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/unbound/forward-records.conf:/opt/unbound/etc/unbound/forward-records.conf:ro

#  mail-relay-clamav:
#    image: $IMG_MAIL_RELAY_CLAMAV
#    container_name: mail-relay-clamav
#    hostname: mail-relay-clamav
#    restart: unless-stopped
#    env_file: stack.env
#    security_opt:
#      - no-new-privileges:true
#    networks:
#      - dock-ext-net
#      - dock-mailrelay-net
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - /etc/timezone:/etc/timezone:ro
#      - v-mail-relay-clamav:/var/lib/clamav

  mail-relay-redis:
    image: $IMG_REDIS
    container_name: mail-relay-redis
    hostname: mail-relay-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailrelay-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mail-relay-redis:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

volumes:
  caddy-certs:
    external: true
  v-mail-relay-rspamd-var:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/rspamd/var
  v-mail-relay-rspamd-conf:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/rspamd/conf
#  v-mail-relay-clamav:
#    driver: local
#    driver_opts:
#      type: none
#      o: bind
#      device: \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/clamav
  v-mail-relay-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \\\${RELAYSERVER_HSHQ_STACKS_DIR}/mail-relay/redis

networks:
  dock-ext-net:
    name: dock-ext
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-mailrelay-net:
    name: dock-mailrelay
    external: true

EOFPF

  cat <<EOFPF > \$HOME/mail-relay.env
TZ=\\\${TZ}
MAIL_FQDN=$RELAYSERVER_EXT_EMAIL_HOSTNAME
POSTMASTER_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
INTERNAL_CA_CERT_FILENAME=${CERTS_ROOT_CA_NAME}.crt
REDIS_HOST=mail-relay-redis
WEB_GUI_PASSWORD_HASH='\$pw_hash'
SUBNET=\$mail_relay_subnet
SUBNET_PREFIX=\$mail_relay_net_prefix
EOFPF

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/groups.conf
group "policies" {
  symbols = {
    "DMARC_POLICY_REJECT" = {
      weight = 100.0;
    }
  }
}

EOFHC
  sudo chown root:root \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/groups.conf
  sudo chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/groups.conf

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/multimap.conf
IP_WHITELIST {
  type = "ip";
  prefilter = true;
  map = "/etc/rspamd/local.d/ip_whitelist.map";
  action = "accept";
}

IP_BLACKLIST {
  type = "ip";
  prefilter = true;
  map = "/etc/rspamd/local.d/ip_blacklist.map";
  action = "reject";
}

DOMAIN_WHITELIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "/etc/rspamd/local.d/domain_whitelist.map";
  score = -100.0;
  action = "accept";
}

DOMAIN_BLACKLIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "/etc/rspamd/local.d/domain_blacklist.map";
  score = 100.0;
  action = "reject";
}

EOFHC

  touch \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_whitelist.map
  sudo chown 101:102 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_whitelist.map
  sudo chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_whitelist.map
  touch \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_blacklist.map
  sudo chown 101:102 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_blacklist.map
  sudo chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/ip_blacklist.map
  touch \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_whitelist.map
  sudo chown 101:102 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_whitelist.map
  sudo chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_whitelist.map
  touch \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_blacklist.map
  sudo chown 101:102 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_blacklist.map
  sudo chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/domain_blacklist.map

  sudo chown 101:102 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/config/header_checks
/^Received:/              IGNORE
/^X-Originating-IP:/    IGNORE
/^X-Mailer:/            IGNORE
/^User-Agent:/          IGNORE
/^X-Mailer-Type:/       IGNORE
/^Authentication-Results:/      IGNORE
EOFHC

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/config/relay
$HOMESERVER_DOMAIN     OK
EOFHC

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/config/transport
$HOMESERVER_DOMAIN     relay:[$SUB_POSTFIX.$HOMESERVER_DOMAIN]:25
EOFHC

  cat <<EOFHC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/config/sasl_senders
@$HOMESERVER_DOMAIN     $HOMESERVER_DOMAIN@mail-relay-postfix
EOFHC

  cat <<EOFCC > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/copycerts.sh
#!/bin/bash

find_certs=(\\\$(find /caddycerts -name \\\${MAIL_FQDN}.crt))
find_cert=\\\${find_certs[0]}
if ! [ -z "\\\$find_cert" ]; then
  find_key=\\\$(dirname \\\$find_cert)/\\\${MAIL_FQDN}.key
fi
if ! [ -z "\\\$find_cert" ] && ! [ -z "\\\$find_key" ] && [ -f \\\$find_key ]; then
  diff \\\$find_cert /etc/postfix/tls/cert.pem >/dev/null
  if [ \\\$? -ne 0 ]; then
    cp \\\$find_cert /etc/postfix/tls/cert.pem
    cp \\\$find_key /etc/postfix/tls/key.pem
    # Bypass the health check reload
    rm -rf /tmp/tls 2> /dev/null
    cp -a /etc/postfix/tls /tmp/tls
    postfix reload
    echo "Certificates Successfully Updated"
    exit 2
  fi
else
  echo "Certificate (\\\${MAIL_FQDN}.crt) does not exist"
  exit 1
fi
EOFCC
  chmod 544 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/copycerts.sh

  cat <<EOFCS > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addRelayedMailDomains.sh
#!/bin/bash
set -e
domains_to_add=\\\$1
deliver_to_host=\\\$2

if [ -z "\\\$domains_to_add" ] || [ -z "\\\$deliver_to_host" ]; then
  echo "Empty Parameters"
  exit 1
fi

deliver_to_host_username=\\\$(echo \\\$deliver_to_host | cut -d"." -f2-)
domains_to_add_Arr=(\\\$(echo \\\$domains_to_add | tr "," "\n"))

for curDomain in "\\\${domains_to_add_Arr[@]}"
do
  sed -i "/^@\\\$curDomain /d" /etc/postfix/config/sasl_senders
  sed -i "/\\\$curDomain/d" /etc/postfix/config/transport
  sed -i "/^\\\$curDomain /d" /etc/postfix/config/relay
  echo "@\\\${curDomain}     \\\${deliver_to_host_username}@mail-relay-postfix" >> /etc/postfix/config/sasl_senders
  sed -i "1s/^/\\\${curDomain}     relay:[\\\${deliver_to_host}]:25\n/" /etc/postfix/config/transport
  echo "\\\${curDomain}     OK" >> /etc/postfix/config/relay
done

postmap /etc/postfix/config/transport
postmap /etc/postfix/config/sasl_senders
postmap /etc/postfix/config/relay
postfix reload
EOFCS
  chmod 544 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addRelayedMailDomains.sh

  cat <<EOFCS > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/removeRelayedMailDomains.sh
#!/bin/bash
set +e
domains_to_remove=\\\$1
mail_user_domain=\\\$2

domains_to_rem_Arr=(\\\$(echo \\\$domains_to_remove | tr "," "\n"))

for curDomain in "\\\${domains_to_rem_Arr[@]}"
do
  sed -i "/^@\\\$curDomain /d" /etc/postfix/config/sasl_senders
  sed -i "/\\\$curDomain/d" /etc/postfix/config/transport
  sed -i "/^\\\$curDomain /d" /etc/postfix/config/relay
done

if ! [ -z \\\$mail_user_domain ]; then
  saslpasswd2 -f /etc/postfix/sasl/sasldb2 -d \\\$mail_user_domain
fi

postmap /etc/postfix/config/transport
postmap /etc/postfix/config/sasl_senders
postmap /etc/postfix/config/relay
postfix reload
EOFCS
  chmod 544 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/removeRelayedMailDomains.sh

  cat <<EOFCS > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addMailUser.sh
#!/bin/bash
set -e
username=\\\$1
password=\\\$2

echo \\\$password | saslpasswd2 -c -p -f /etc/postfix/sasl/sasldb2 \\\$username

postfix reload
EOFCS
  chmod 544 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addMailUser.sh

  cat <<EOFUB > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf
local-data: "$SUB_POSTFIX.${HOMESERVER_DOMAIN}. A $RELAYSERVER_WG_HS_IP"
local-data-ptr: "$RELAYSERVER_WG_HS_IP $SUB_POSTFIX.${HOMESERVER_DOMAIN}."
EOFUB
  chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/mailhosts.conf

  touch \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/forward-records.conf
  chmod 644 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/unbound/forward-records.conf
}

function getAllowedPublicIPs()
{
  set +e
  ips="0.0.0.0/5,8.0.0.0/7,11.0.0.0/8,12.0.0.0/6,16.0.0.0/4,32.0.0.0/3,64.0.0.0/2,128.0.0.0/3,160.0.0.0/5,168.0.0.0/6,172.0.0.0/12,172.32.0.0/11,172.64.0.0/10,172.128.0.0/9,173.0.0.0/8,174.0.0.0/7,176.0.0.0/4,192.0.0.0/9,192.128.0.0/11,192.160.0.0/13,192.169.0.0/16,192.170.0.0/15,192.172.0.0/14,192.176.0.0/12,192.192.0.0/10,193.0.0.0/8,194.0.0.0/7,196.0.0.0/6,200.0.0.0/5,208.0.0.0/4"
  if ! [ -z \$1 ]; then
    ips+=","\$1
  fi
  set -e
  echo \$ips
}

function installWireGuard()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/clientdns
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal
  wgdate=\$(date)
  wginitdate=\$(date --date="\$wgdate" -u '+%Y-%m-%d %H:%M:%S.%N %z %Z')
  wgdbdate=\$(date --date="\$wgdate" -u '+%Y-%m-%d %H:%M:%S.%N')

  clientdns_subnet=\$(getDockerSubnet cdns-user1)
  clientdns_subnet_prefix=\$(echo \$clientdns_subnet | rev | cut -d "." -f2- | rev)

  outputConfigWireGuard
  sudo ln /etc/wireguard/$RELAYSERVER_WG_INTERFACE_NAME.conf \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/$RELAYSERVER_WG_INTERFACE_NAME.conf
  sudo systemctl enable wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
  sudo systemctl start wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
  installStack wgportal wgportal "starting web service on" \$HOME/wgportal.env
  startStopStack wgportal stop
  sudo sqlite3 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/wg_portal.db "update devices set display_name='WireGuard Server', mtu=$RELAYSERVER_SERVER_DEFAULT_MTU, dns_str='$RELAYSERVER_WG_SV_IP', post_up='\$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh up;', post_down='\$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh down;', default_endpoint='$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT', default_allowed_ips_str='\$(getAllowedPublicIPs $PRIMARY_VPN_SUBNET)', default_persistent_keepalive=0, created_at='\$wgdbdate', updated_at='\$wgdbdate' where device_name='$RELAYSERVER_WG_INTERFACE_NAME';"
  startStopStack wgportal start
  sleep 2
  wgPortalAuth="\$(echo \$(echo -n ${RELAYSERVER_WGPORTAL_ADMIN_EMAIL}:${RELAYSERVER_WGPORTAL_ADMIN_PASSWORD} | base64) | sed 's| ||g')"
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh "RelayServerClientDNS" "$EMAIL_ADMIN_EMAIL_ADDRESS" "$RELAYSERVER_WG_SV_CLIENTDNS_PUBLICKEY" "$RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY" "$RELAYSERVER_WG_SV_CLIENTDNS_IP" "false" "true" "\$wgPortalAuth"
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh "HomeServerClientDNS" "$EMAIL_ADMIN_EMAIL_ADDRESS" "$RELAYSERVER_WG_HS_CLIENTDNS_PUBLICKEY" "$RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY" "$RELAYSERVER_WG_HS_CLIENTDNS_IP" "false" "true" "\$wgPortalAuth"
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh "Primary-VPN-$HOMESERVER_DOMAIN" "$EMAIL_ADMIN_EMAIL_ADDRESS" "$RELAYSERVER_WG_HS_PUBLICKEY" "$RELAYSERVER_WG_HS_PRESHAREDKEY" "$RELAYSERVER_WG_HS_IP" "false" "true" "\$wgPortalAuth"
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh "Primary-Internet-$HOMESERVER_DOMAIN" "$EMAIL_ADMIN_EMAIL_ADDRESS" "$RELAYSERVER_WG_INTERNET_HS_PUBLICKEY" "$RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY" "$RELAYSERVER_WG_INTERNET_HS_IP" "true" "false" "\$wgPortalAuth"
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh "User-$LDAP_PRIMARY_USER_USERNAME" "$LDAP_PRIMARY_USER_EMAIL_ADDRESS" "$RELAYSERVER_WG_USER_PUBLICKEY" "$RELAYSERVER_WG_USER_PRESHAREDKEY" "$RELAYSERVER_WG_USER_IP" "true" "false" "\$wgPortalAuth"
  sudo systemctl stop wg-quick@$RELAYSERVER_WG_INTERFACE_NAME.service
  installStack clientdns clientdns-wireguard " " \$HOME/clientdns.env
}

function getDefaultIface()
{
  echo \$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1)
}

function outputConfigWireGuard()
{
  sudo touch \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset
  sudo chmod 600 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset
  default_iface=\$(getDefaultIface)
  sudo tee \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh >/dev/null <<EOFPU
#!/bin/bash
COMMAND=\\\$1
RELAYSERVER_HSHQ_STACKS_DIR=\$RELAYSERVER_HSHQ_STACKS_DIR
set +e

default_iface=\$default_iface

function main()
{
  shift
  shift
  case "\\\$COMMAND" in
    up) up ;;
    down) down ;;
  esac
}

function up()
{
  ipset create inetusers hash:net
  iplist=\\\$(cat \\\$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset)
  for curip in \\\$iplist
  do
    if [ -z \\\$curip ]; then continue; fi
    ipset add inetusers \\\$curip
  done
  ipset create alldevices hash:net
  alliplist=(\\\$(sqlite3 \\\$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/wg_portal.db "select ips_str from peers;"))
  for cur_ip in "\\\${alliplist[@]}"
  do
    if [ -z \\\$cur_ip ]; then continue; fi
    ipset add alldevices \\\$cur_ip
  done
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j ACCEPT
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -A POSTROUTING -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j MASQUERADE
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o \\\$default_iface -m set --match-set inetusers src -j ACCEPT
  iptables -A FORWARD -i \\\$default_iface -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -A POSTROUTING -o \\\$default_iface -m set --match-set inetusers src -j MASQUERADE
}

function down()
{
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j ACCEPT
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -D POSTROUTING -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j MASQUERADE
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o \\\$default_iface -m set --match-set inetusers src -j ACCEPT
  iptables -D FORWARD -i \\\$default_iface -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -D POSTROUTING -o \\\$default_iface -m set --match-set inetusers -j MASQUERADE
  ipset destroy inetusers
  ipset destroy alldevices
}

main "\\\$@"
EOFPU
  sudo chmod 500 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh

  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh >/dev/null <<EOFWA
#!/bin/bash

name=\\\$1
email=\\\$2
publicKey=\\\$3
presharedKey=\\\$4
ipAddress=\\\$5
isInet=\\\$6
isInVPNSubnet=\\\$7
auth=\\\$8

uuid=\\\$(uuidgen | sed 's|-||g')
jsonbody="{\"UID\": \"\\\$uuid\", \"DeviceName\": \"$RELAYSERVER_WG_INTERFACE_NAME\", \"DeviceType\": \"client\", \"Identifier\": \"\\\$name\", \"Email\": \"\\\$email\", \"IgnoreGlobalSettings\": true, \"PublicKey\": \"\\\$publicKey\", \"PresharedKey\": \"\\\$presharedKey\", \"Endpoint\": \"$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT\", \"PersistentKeepalive\": 0, \"IPsStr\": \"\\\${ipAddress}/32\", \"Mtu\": $RELAYSERVER_CLIENT_DEFAULT_MTU}"
curl -s -X 'POST' 'http://127.0.0.1:$RELAYSERVER_WG_PORTAL_PORT/api/v1/backend/peers?DeviceName=$RELAYSERVER_WG_INTERFACE_NAME' -H 'accept: application/json' -H "Authorization: Basic \\\$auth" -H 'Content-Type: application/json' -d "\\\$jsonbody" >/dev/null
if [ \\\$? -ne 0 ]; then
  echo "There was a problem adding this client..."
  exit 1
fi

ipset add alldevices \\\${ipAddress}/32

if ! [ "\\\$isInVPNSubnet" = "true" ]; then
  route add \\\${ipAddress}/32 $RELAYSERVER_WG_INTERFACE_NAME
fi

if [ "\\\$isInet" = "true" ]; then
  ipset add inetusers \\\${ipAddress}/32
  echo \\\${ipAddress}/32 | tee -a \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset >/dev/null
fi


EOFWA
  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh

  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh >/dev/null <<EOFWA
#!/bin/bash
set +e
publicKey=\\\$1
ipAddress=\\\$2
isInet=\\\$3
isInVPNSubnet=\\\$4
auth=\\\$5

function main()
{
  curl -s -X 'DELETE' "http://127.0.0.1:$RELAYSERVER_WG_PORTAL_PORT/api/v1/backend/peer?PublicKey=\\\$(urlEncode \\\$publicKey)" -H 'accept: application/json' -H "Authorization: Basic \\\$auth" -H 'Content-Type: application/json' >/dev/null
  if [ \\\$? -ne 0 ]; then
    echo "There was a problem removing this client..."
  fi
  ipset del alldevices \\\${ipAddress}/32
  if ! [ "\\\$isInVPNSubnet" = "true" ]; then
    route del \\\${ipAddress}/32 $RELAYSERVER_WG_INTERFACE_NAME
  fi
  if [ "\\\$isInet" = "true" ]; then
    ipset del inetusers \\\${ipAddress}/32
    sed -i '/\\\${ipAddress}/d' \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset
  fi
}

function urlEncode()
{
  strLength="\\\${#1}"
  for (( i = 0; i < strLength; i++ )); do
    c="\\\${1:i:1}"
    case \\\$c in
      [a-zA-Z0-9.~_-]) printf "\\\$c" ;;
      *) printf '%%%02X' "'\\\$c" ;;
    esac
  done
}

function urlDecode()
{
  url_encoded="\\\${1//+/ }"
  printf '%b' "\\\${url_encoded//%/\\x}"
}

main "\\\$@"
EOFWA
  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh

  network_bits=\$(echo $PRIMARY_VPN_SUBNET | cut -d "/" -f2)
  sudo tee /etc/wireguard/$RELAYSERVER_WG_INTERFACE_NAME.conf >/dev/null <<EOFWG
# AUTOGENERATED FILE - DO NOT EDIT
# -WGP- Interface: $RELAYSERVER_WG_INTERFACE_NAME / Updated: \$wginitdate / Created: \$wginitdate
# -WGP- Interface display name: WireGuard Server
# -WGP- Interface mode: server
# -WGP- PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY

[Interface]

# Core settings
PrivateKey = $RELAYSERVER_WG_SV_PRIVATEKEY
Address    = ${RELAYSERVER_WG_SV_IP}/\$network_bits

# Misc. settings (optional)
ListenPort = $RELAYSERVER_WG_PORT
MTU        = $RELAYSERVER_SERVER_DEFAULT_MTU

# Interface hooks (optional)
PostUp     = \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh up
PostDown   = \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh down

#
# Peers
#

EOFWG
  sudo chmod 500 /etc/wireguard/$RELAYSERVER_WG_INTERFACE_NAME.conf

  cat <<EOFWP > \$HOME/wgportal-compose.yml
$STACK_VERSION_PREFIX wgportal $(getScriptStackVersion wgportal)

services:
  wgportal:
    image: $IMG_WGPORTAL
    container_name: wgportal
    hostname: wgportal
    restart: unless-stopped
    env_file: stack.env
    network_mode: "host"
    cap_add:
      - NET_ADMIN
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/wireguard:/etc/wireguard
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/wireguard/wgportal:/app/data
EOFWP

  cat <<EOFWP > \$HOME/wgportal.env
CONFIG_FILE=/app/data/config.yml
EOFWP

  cat <<EOFWC > \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/config.yml
core:
  listeningAddress: :$RELAYSERVER_WG_PORTAL_PORT
  externalUrl: https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/
  adminUser: $RELAYSERVER_WGPORTAL_ADMIN_EMAIL
  adminPass: $RELAYSERVER_WGPORTAL_ADMIN_PASSWORD
  editableKeys: true
  createDefaultPeer: false
  ldapEnabled: false
  company: $RELAYSERVER_NAME
  title: $RELAYSERVER_NAME WG Portal
  mailFrom: WireGuard <$EMAIL_SMTP_EMAIL_ADDRESS>
database:
  type: sqlite
  database: data/wg_portal.db
email:
  host: $SUB_POSTFIX.$HOMESERVER_DOMAIN
  port: $MAILU_PORT_5
  tls: true
  user: $EMAIL_SMTP_EMAIL_ADDRESS
  pass: $EMAIL_SMTP_PASSWORD
wg:
  devices:
    - $RELAYSERVER_WG_INTERFACE_NAME
  defaultDevice: $RELAYSERVER_WG_INTERFACE_NAME
  configDirectory: /etc/wireguard
  manageIPAddresses: true
EOFWC
  chmod 600 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/config.yml

  cat <<EOFCD > \$HOME/clientdns-compose.yml
$STACK_VERSION_PREFIX clientdns $(getScriptStackVersion clientdns)

services:
  clientdns-dnsmasq:
    image: $IMG_DNSMASQ
    container_name: clientdns-dnsmasq
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-ext-net:
      dock-proxy-net:
      cdns-user1-net:
        ipv4_address: \\\${CLIENTDNS_SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/wireguard/clientdns/dnsmasq.conf:/etc/dnsmasq.conf
    environment:
      - HTTP_USER=$RELAYSERVER_CLIENTDNS_ADMIN_USERNAME
      - HTTP_PASS=$RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD

  clientdns-wireguard:
    image: $IMG_WIREGUARD
    container_name: clientdns-wireguard
    hostname: clientdns-wireguard
    restart: unless-stopped
    env_file: stack.env
    cap_add:
      - NET_ADMIN
    networks:
      - dock-ext-net
      - cdns-user1-net
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/wireguard/clientdns/Corefile:/config/coredns/Corefile:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/wireguard/clientdns/rsClientDNS.conf:/config/wg0.conf

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  cdns-user1-net:
    name: cdns-user1
    external: true
EOFCD

  cat <<EOFCD > \$HOME/clientdns.env
TZ=\\\${TZ}
CLIENTDNS_SUBNET_PREFIX=\$clientdns_subnet_prefix
USE_COREDNS=true
EOFCD

  cat <<EOFCD > \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/clientdns/dnsmasq.conf
# IP Address of this DNS Server: ${RELAYSERVER_WG_SV_CLIENTDNS_IP}/32
#======================
no-resolv
no-hosts
domain-needed
bogus-priv
server=127.0.0.11
cache-size=0
#======================
# Add new entries here


EOFCD

  cat <<EOFCF > \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/clientdns/Corefile
. {
    loop
    reload 15s
    forward . \${clientdns_subnet_prefix}.253
}
EOFCF

  sudo tee \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/clientdns/rsClientDNS.conf >/dev/null <<EOFWQ
[Interface]
PrivateKey = $RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY
Address = ${RELAYSERVER_WG_SV_CLIENTDNS_IP}/32
MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY
AllowedIPs = $PRIMARY_VPN_SUBNET
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFWQ

  sudo chmod 0400 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/clientdns/rsClientDNS.conf
}

function installFileBrowser()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/filebrowser
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/filebrowser/db
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/filebrowser/srv
  RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD=$RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD
  FILEBROWSER_PASSWORD_HASH=\$(htpasswd -bnBC 10 "" \$RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$2y/\$2a/')
  outputConfigFileBrowser
  installStack filebrowser filebrowser "Listening on" \$HOME/filebrowser.env
  startStopStack filebrowser stop
}

function outputConfigFileBrowser()
{
  cat <<EOFFB > \$HOME/filebrowser-compose.yml
$STACK_VERSION_PREFIX filebrowser $(getScriptStackVersion filebrowser)

services:
  filebrowser:
    image: $IMG_FILEBROWSER
    container_name: filebrowser
    hostname: filebrowser
    restart: unless-stopped
    env_file: stack.env
    user: "\\\${UID}:\\\${GID}"
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/filebrowser/filebrowser.json:/.filebrowser.json
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/filebrowser/srv:/srv
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/filebrowser/db:/database

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true

EOFFB

  cat <<EOFFB > \$HOME/filebrowser.env
UID=\$USERID
GID=\$GROUPID
FB_USERNAME=$RELAYSERVER_FILEBROWSER_ADMIN_USERNAME
FB_PASSWORD='\$FILEBROWSER_PASSWORD_HASH'
EOFFB

  cat <<EOFFB > \$RELAYSERVER_HSHQ_STACKS_DIR/filebrowser/filebrowser.json
{
  "port": 80,
  "baseURL": "",
  "address": "",
  "log": "stdout",
  "database": "/database/filebrowser.db",
  "root": "/srv"
}
EOFFB

}

function installCaddy()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/caddy
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/dns
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/data
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/config
  outputConfigCaddy
  installStack caddy caddy "serving initial configuration" \$HOME/caddy.env
}

function outputConfigCaddy()
{
  cat <<EOFCC > \$HOME/caddy-compose.yml
$STACK_VERSION_PREFIX caddy-rs $(getScriptStackVersion caddy-rs)

services:
  caddy:
    image: $IMG_CADDY
    container_name: caddy
    hostname: caddy
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/caddy/Caddyfile:/etc/caddy/Caddyfile
      - \\\${RELAYSERVER_HSHQ_NONBACKUP_DIR}/caddy/data:/data
      - \\\${RELAYSERVER_HSHQ_NONBACKUP_DIR}/caddy/config:/config
      - caddy-certs:/data/caddy/certificates

  caddy-dns:
    image: $IMG_DNSMASQ
    container_name: caddy-dns
    hostname: caddy-dns
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-proxy-net:
        ipv4_address: \\\${NET_WEBPROXY_SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/caddy/dns/dnsmasq.conf:/etc/dnsmasq.conf

volumes:
  caddy-certs:
    external: true

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCC

  connIP=\$(getConnectingIPAddress)
  privSubnets="${RELAYSERVER_WG_HS_IP}/32 ${RELAYSERVER_WG_USER_IP}/32"
  if ! [ -z "\$connIP" ]; then
    privSubnets=\$privSubnets" \${connIP}/32"
  fi
  cat <<EOFCC > \$HOME/caddy.env
CERT_RENEW_INTERVAL=1h
PRIVATE_SUBNETS=\$privSubnets
INTERNAL_SUBNETS=10.0.0.0/8
NET_WEBPROXY_SUBNET_PREFIX=$NET_WEBPROXY_SUBNET_PREFIX
HTTP_USER=$RELAYSERVER_CADDYDNS_ADMIN_USERNAME
HTTP_PASS=$RELAYSERVER_CADDYDNS_ADMIN_PASSWORD
EOFCC

  cat <<EOFDM > \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/dns/dnsmasq.conf
no-resolv
address=/.$HOMESERVER_DOMAIN/$RELAYSERVER_WG_HS_IP
address=/.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/$RELAYSERVER_WG_SV_IP
EOFDM

  cat <<EOFCA > \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
{
  email $CERTS_EMAIL_ADDRESS
  acme_ca https://acme.zerossl.com/v2/DV90
  renew_interval {\\\$CERT_RENEW_INTERVAL}
}

(rip-private) {
  @subnet remote_ip {\\\$PRIVATE_SUBNETS}
}

(rip-internal) {
  @subnet remote_ip {\\\$INTERNAL_SUBNETS}
}

(tls-$HOMESERVER_ABBREV) {
  tls {
    ca https://$SUB_CADDY.$HOMESERVER_DOMAIN/acme/$HOMESERVER_ABBREV/directory
  }
}

(rip-private-tls-$HOMESERVER_ABBREV) {
  import rip-private
  import tls-$HOMESERVER_ABBREV
}

(rip-internal-tls-$HOMESERVER_ABBREV) {
  import rip-internal
  import tls-$HOMESERVER_ABBREV
}

(safe-header) {
  header {
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

(safe-header-allow-frame) {
  header {
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

(safe-header-cors) {
  @origin{args[0]} header Origin {args[0]}
  header @origin{args[0]} {
    Access-Control-Allow-Origin "{args[0]}"
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

($CADDY_SNIPPET_TRUSTEDPROXIES) {
  trusted_proxies $TRUSTED_PROXIES
}

(sn-resolver) {
  transport http {
    resolvers {\\\$NET_WEBPROXY_SUBNET_PREFIX}.253:53
  }
}

# This obtains/maintains the external ZeroSSL certificate for the postfix mail relay

https://$RELAYSERVER_EXT_EMAIL_HOSTNAME {
  templates
  header Content-Type text/plain
  respond "Your IP Address is {{.RemoteIP}}"
}

# This provides a way to share files externally
# The service is disabled by default.

#https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
#  import safe-header
#  reverse_proxy http://filebrowser {
#    import trusted-proxy-list
#  }
#}

# Sample for providing public internet access to a service.
# Remove the # from the beginning of each line in the block
# below and restart caddy to enable. If adding Mastodon or 
# Matrix, you must also add a route for the base domain.

#https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN {
#  import safe-header
#  reverse_proxy https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN {
#    import sn-resolver
#  }
#}

# Internal admin services only available on VPN to specific IPs.

https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy https://portainer:9443 {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy https://adguard {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_CADDYDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy http://caddy-dns:8080 {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy http://clientdns-dnsmasq:8080 {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy http://mail-relay-rspamd {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy https://syncthing:$SYNCTHING_LOCAL_WEB_PORT {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN {
  import rip-private-tls-$HOMESERVER_ABBREV
  handle @subnet {
    reverse_proxy http://host.docker.internal:$RELAYSERVER_WG_PORTAL_PORT {
      import $CADDY_SNIPPET_TRUSTEDPROXIES
    }
  }
  respond 404
}

# Add any internal User services here



# LetsEncrypt paths for HTTP challenge

EOFCA

  leCertsArr=(\$(echo "$RELAYSERVER_LE_CERT_DOMAINS" | tr "," "\n"))
  for leCert in "\${leCertsArr[@]}"
  do
    echo -e "# LE certs path \${leCert} BEGIN\nhttp://\${leCert} {\n  handle /.well-known/acme-challenge/* {\n    reverse_proxy \${leCert} {\n      import sn-resolver\n    }\n  }\n}\n# LE certs path \${leCert} END\n" >> \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  done
}

function installOfelia()
{
  outputConfigOfelia
  installStack ofelia ofelia " "
}

function outputConfigOfelia()
{
  cat <<EOFOF > \$HOME/ofelia-compose.yml
$STACK_VERSION_PREFIX ofelia $(getScriptStackVersion ofelia)

services:
  ofelia:
    image: $IMG_OFELIA
    container_name: ofelia
    hostname: ofelia
    restart: unless-stopped
    command: daemon --docker
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ext-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
    labels:
      - "ofelia.job-local.my-test-job.schedule=@every 5m"
      - "ofelia.job-local.my-test-job.command=date"

networks:
  dock-ext-net:
    name: dock-ext
    external: true
EOFOF
}

function installSyncthing()
{
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/syncthing
  mkdir \$RELAYSERVER_HSHQ_STACKS_DIR/syncthing/config
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/syncthing
  mkdir \$RELAYSERVER_HSHQ_NONBACKUP_DIR/syncthing/data
  generateCert syncthing syncthing
  outputConfigSyncthing
  cd ~
  docker compose -f \$HOME/syncthing-compose-tmp.yml up -d
  search="Access the GUI via the following URL"
  isFound="F"
  i=0
  set +e
  while [ \$i -le 60 ]
  do
    findtext=\$(docker logs syncthing 2>&1 | grep "\$search")
    if ! [ -z "\$findtext" ]; then
      isFound="T"
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=\$i seconds..."
    sleep 1
    i=\$((i+1))
  done
  if [ "\$isFound" = "F" ]; then
    echo "There was a problem installing syncthing"
    exit
  fi
  set -e
  cd ~
  docker compose -f \$HOME/syncthing-compose-tmp.yml down -v
  sleep 5
  rm -f \$HOME/syncthing-compose-tmp.yml
  alltext=\$(sudo cat \$RELAYSERVER_HSHQ_STACKS_DIR/syncthing/config/config.xml)
  pwhash=\$(htpasswd -bnBC 10 "" $RELAYSERVER_SYNCTHING_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$2y/\$2a/')
  replacetext='<gui enabled="true" tls="true" debugging="false">\n        <address>127.0.0.1:'$SYNCTHING_LOCAL_WEB_PORT'</address>\n        <user>'$RELAYSERVER_SYNCTHING_ADMIN_USERNAME'</user>\n        <password>'\$pwhash'</password>\n        <apikey>'$RELAYSERVER_SYNCTHING_API_KEY'</apikey>\n        <theme>dark</theme>\n    </gui>'
  echo -e "\${alltext%%<gui*}\${replacetext}\${alltext##*</gui>}" > \$HOME/st_config.xml
  alltext=\$(cat \$HOME/st_config.xml)
  replacetext='<globalAnnounceEnabled>false</globalAnnounceEnabled>'
  echo -e "\${alltext%%<globalAnnounceEnabled*}\${replacetext}\${alltext##*</globalAnnounceEnabled>}" > \$HOME/st_config.xml
  alltext=\$(cat \$HOME/st_config.xml)
  replacetext='<globalAnnounceEnabled>false</globalAnnounceEnabled>'
  echo -e "\${alltext%%<globalAnnounceEnabled*}\${replacetext}\${alltext##*</globalAnnounceEnabled>}" > \$HOME/st_config.xml
  alltext=\$(cat \$HOME/st_config.xml)
  replacetext='<natEnabled>false</natEnabled>'
  echo -e "\${alltext%%<natEnabled*}\${replacetext}\${alltext##*</natEnabled>}" > \$HOME/st_config.xml
  alltext=\$(cat \$HOME/st_config.xml)
  replacetext='<localAnnounceEnabled>false</localAnnounceEnabled>'
  echo -e "\${alltext%%<localAnnounceEnabled*}\${replacetext}\${alltext##*</localAnnounceEnabled>}" > \$HOME/st_config.xml
  alltext=\$(cat \$HOME/st_config.xml)
  replacetext='<relaysEnabled>false</relaysEnabled>'
  echo -e "\${alltext%%<relaysEnabled*}\${replacetext}\${alltext##*</relaysEnabled>}" > \$HOME/st_config.xml
  chmod 600 \$HOME/st_config.xml
  sudo chown root:root \$HOME/st_config.xml
  sudo mv \$HOME/st_config.xml \$RELAYSERVER_HSHQ_STACKS_DIR/syncthing/config/config.xml

  installStack syncthing syncthing "Access the GUI via the following URL" \$HOME/syncthing.env

  sleep 3
  curl -s -H "X-API-Key: $RELAYSERVER_SYNCTHING_API_KEY" -X DELETE -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders/default
}

function outputConfigSyncthing()
{
  cat <<EOFST > \$HOME/syncthing-compose-tmp.yml

services:
  syncthing:
    image: $IMG_SYNCTHING
    container_name: syncthing
    hostname: syncthing
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/tcp"
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/udp"
      - "$SYNCTHING_DISC_PORT:$SYNCTHING_DISC_PORT/udp"
      - "127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT:$SYNCTHING_LOCAL_WEB_PORT"
    environment:
      - PUID=0
      - PGID=0
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/cert.pem:ro
      - \${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/key.pem:ro
      - \${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/https-cert.pem:ro
      - \${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/https-key.pem:ro
      - \${RELAYSERVER_HSHQ_STACKS_DIR}/syncthing/config:/var/syncthing/config
      - \${RELAYSERVER_HSHQ_NONBACKUP_DIR}/syncthing/data:/var/syncthing/data
      - \${RELAYSERVER_HSHQ_DATA_DIR}:/relayserver

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFST

  cat <<EOFST > \$HOME/syncthing-compose.yml
$STACK_VERSION_PREFIX syncthing $(getScriptStackVersion syncthing)

services:
  syncthing:
    image: $IMG_SYNCTHING
    container_name: syncthing
    hostname: syncthing
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/tcp"
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/udp"
      - "$SYNCTHING_DISC_PORT:$SYNCTHING_DISC_PORT/udp"
      - "127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT:$SYNCTHING_LOCAL_WEB_PORT"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/cert.pem:ro
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/key.pem:ro
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/https-cert.pem:ro
      - \\\${RELAYSERVER_HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/https-key.pem:ro
      - \\\${RELAYSERVER_HSHQ_STACKS_DIR}/syncthing/config:/var/syncthing/config
      - \\\${RELAYSERVER_HSHQ_NONBACKUP_DIR}/syncthing/data:/var/syncthing/data
      - \\\${RELAYSERVER_HSHQ_DATA_DIR}:/relayserver

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFST

  cat <<EOFST > \$HOME/syncthing.env
PUID=0
PGID=0
STCONFDIR=/var/syncthing/config
STDATADIR=/var/syncthing/data
STHOMEDIR=
EOFST
}

main "\$@"
EOFRS
  chmod 0600 $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME
}

function uploadVPNInstallScripts()
{
  isTransfer=$1
  if [ -z "$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME" ]; then
    echo "Generating keys, please wait..."
    RELAYSERVER_SSH_PRIVATE_KEY_FILENAME=$HOMESERVER_ABBREV".key"
    updateConfigVar RELAYSERVER_SSH_PRIVATE_KEY_FILENAME $RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    rm -f $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    rm -f $HSHQ_CONFIG_DIR/${RELAYSERVER_SSH_PRIVATE_KEY_FILENAME}.pub
    RELAYSERVER_SSH_PRIVATE_KEY_PHRASE=$(pwgen -c -n 64 1)
    updateConfigVar RELAYSERVER_SSH_PRIVATE_KEY_PHRASE $RELAYSERVER_SSH_PRIVATE_KEY_PHRASE
    ssh-keygen -f $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME -N $RELAYSERVER_SSH_PRIVATE_KEY_PHRASE
    chmod 0400 $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME
    chmod 0400 $HSHQ_CONFIG_DIR/${RELAYSERVER_SSH_PRIVATE_KEY_FILENAME}.pub
  fi
  set +e
  echo "Checking known_hosts..."
  if ! [ -z "$RELAYSERVER_SSH_PORT" ]; then
    echo "Removing old known_hosts entry: [$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN]:$RELAYSERVER_SSH_PORT"
    ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN]:$RELAYSERVER_SSH_PORT" > /dev/null 2>&1
    if ! [ -z "$RELAYSERVER_SERVER_IP" ] && [ "$(checkValidIPAddress $RELAYSERVER_SERVER_IP)" = "true" ]; then
      echo "Removing old known_hosts entry: [$RELAYSERVER_SERVER_IP]:$RELAYSERVER_SSH_PORT"
      ssh-keygen -f "$HOME/.ssh/known_hosts" -R "[$RELAYSERVER_SERVER_IP]:$RELAYSERVER_SSH_PORT" > /dev/null 2>&1
    fi
  fi
  is_err=0
  err_message="unknown"
  while true;
  do
    if [ $is_err -ne 0 ]; then
      errmenu=$(cat << EOF

$(getLogo)

There is a problem with the RelayServer host:
-----------------------------------------------------------------
$err_message
-----------------------------------------------------------------
Please address this issue, then press Retry to proceed or Cancel to exit.

EOF
  )
      if ! (whiptail --title "Login Error" --yesno "$errmenu" $MENU_HEIGHT $MENU_WIDTH --yes-button "Retry" --no-button "Cancel"); then
        return 1
      fi
    fi
    is_err=0
    err_message="unknown"
    rs_new_username=""
    rs_cur_password=""
    trUsername=$RELAYSERVER_REMOTE_USERNAME
    rs_cur_username=$(promptUserInputMenu "root" "Enter Username" "Enter the CURRENT Linux OS username for the RelayServer host. A fresh installation will typically default to root: ")
    if [ $? -ne 0 ]; then
      return 1
    fi
    if [ $(checkValidString "$rs_cur_username" "-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The username contains invalid character(s). It must consist of a-z (lowercase), 0-9, and/or hyphens"
      rs_cur_username=""
      continue
    fi
    if [ "$rs_cur_username" = "root" ]; then
      rs_cur_password=$(promptPasswordMenu "Enter Password" "Enter the password for your RelayServer Linux OS root account: ")
      if [ $(checkValidPassword "$rs_cur_password") = "false" ]; then
        showMessageBox "ERROR" "The password is invalid . It must consist of uppercase/lowercase letters, numbers, or the following symbols: ~!@#%^&*()-_+=<>?., Please change your root password on the remote host to fit this set in order to continue."
        continue
      fi
      while [ -z "$rs_new_username" ]
      do
        if [ "$isTransfer" = "true" ]; then
          rs_new_username=$trUsername
        else
          rs_new_username=$(promptUserInputMenu "$USERNAME" "Enter New Username" "Enter a NEW Linux OS username to add (in place of root): ")
          if [ $? -ne 0 ]; then
            return 1
          fi
          if [ $(checkValidString "$rs_new_username" "-") = "false" ]; then
            showMessageBox "Invalid Character(s)" "The name contains invalid character(s). It must consist of a-z (lowercase), 0-9, and/or hyphens"
            rs_new_username=""
          fi
        fi
      done
      RELAYSERVER_REMOTE_USERNAME="$rs_new_username"
    else
      RELAYSERVER_REMOTE_USERNAME="$rs_cur_username"
    fi
    if [ "$isTransfer" = "true" ] && ! [ "$RELAYSERVER_REMOTE_USERNAME" = "$trUsername" ]; then
      showMessageBox "Invalid Username" "The username must match the username from the previous installation ($trUsername) when doing a transfer. Either login with root and allow this script to create this user or create it manually on the RelayServer."
      continue
    fi
    tmp_pw1=""
    tmp_pw2=""
    while [ -z "$tmp_pw1" ] || ! [ "$tmp_pw1" = "$tmp_pw2" ]
    do
      if ! [ -z "$rs_new_username" ]; then
        tmp_pw1=$(promptPasswordMenu "Create Password" "Create a password for your RelayServer Linux OS user ($RELAYSERVER_REMOTE_USERNAME) account: ")
        if [ $? -ne 0 ]; then
          return 1
        fi
        if [ -z "$tmp_pw1" ]; then
          showMessageBox "Password Empty" "The password cannot be empty, please try again."
          continue
        fi
        if [ $(checkValidPassword "$tmp_pw1" 16) = "false" ]; then
          showMessageBox "Weak Password" "The password is invalid or is too weak. It must contain at least 16 characters and consist of uppercase letters, lowercase letters, and numbers. It can only contain the following symbols: ~!@#%^&*()-_+=<>?.,"
          tmp_pw1=""
          tmp_pw2=""
          continue
        fi
        tmp_pw2=$(promptPasswordMenu "Confirm Password" "Enter the password again to confirm: ")
        if [ $? -ne 0 ]; then
          return 1
        fi
        if ! [ "$tmp_pw1" = "$tmp_pw2" ]; then
          showMessageBox "Password Mismatch" "The passwords do not match, please try again."
        fi
      else
        tmp_pw1=$(promptPasswordMenu "Enter Password" "Enter the password for your RelayServer Linux OS user ($RELAYSERVER_REMOTE_USERNAME) account: ")
        if [ $? -ne 0 ]; then
          return 1
        fi
        if [ -z "$tmp_pw1" ]; then
          showMessageBox "Password Empty" "The password cannot be empty, please try again."
          continue
        fi
        tmp_pw2=$tmp_pw1
      fi
    done
    USER_RELAY_SUDO_PW="$tmp_pw1"
    tmp_pw1=""
    tmp_pw2=""
    domain_ip_guess=$(getIPFromHostname ip.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
    if [ -z "$domain_ip_guess" ] || [ "$isTransfer" = "true" ]; then
      domain_ip_guess="0.0.0.0"
    fi
    RELAYSERVER_SERVER_IP=""
    while [ -z "$RELAYSERVER_SERVER_IP" ]
    do
      RELAYSERVER_SERVER_IP=$(promptUserInputMenu $domain_ip_guess "Enter IP Address" "Enter the IP Address of the RelayServer. It is IMPORTANT that you enter this value correctly. If you have already pointed your DNS of your HomeServer domain to your RelayServer, then ensure the guessed IP is correct.")
      if [ $? -ne 0 ]; then
        return 1
      fi
      if [ -z "$RELAYSERVER_SERVER_IP" ]; then
        showMessageBox "IP Address Empty" "The IP Address cannot be empty"
      elif [ "$(checkValidIPAddress $RELAYSERVER_SERVER_IP)" = "false" ] || [ "$RELAYSERVER_SERVER_IP" = "0.0.0.0" ]; then
        showMessageBox "Invalid Character(s)" "The IP address contains invalid character(s)."
        RELAYSERVER_SERVER_IP=""
      fi
    done
    RELAYSERVER_CURRENT_SSH_PORT=""
    while [ -z "$RELAYSERVER_CURRENT_SSH_PORT" ]
    do
      RELAYSERVER_CURRENT_SSH_PORT=$(promptUserInputMenu "22" "Enter CURRENT SSH Port" "Enter the CURRENT SSH port for the RelayServer host, (a fresh installation defaults to port 22): ")
      if [ -z "$RELAYSERVER_CURRENT_SSH_PORT" ]; then
        showMessageBox "SSH Port Empty" "The SSH port cannot be empty"
      fi
    done
    set +e
    if [ -z "$rs_new_username" ]; then
      rs_new_username="$RELAYSERVER_REMOTE_USERNAME"
      rs_cur_password="$USER_RELAY_SUDO_PW"
    fi
    echo "Logging into RelayServer..."
    SSHPASS="$rs_cur_password" sshpass -e ssh -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 -p $RELAYSERVER_CURRENT_SSH_PORT $rs_cur_username@$RELAYSERVER_SERVER_IP "echo hello >/dev/null"
    is_err=$?
    if [ $is_err -ne 0 ]; then
      err_message="Could not log in to RelayServer. It could be wrong IP address/port and/or incorrect credentials. Please check your records and try again."
      continue
    fi
    # 2. Upload check script
    outputRelayServerValidationScript
    echo "Uploading validation script..."
    sshpass -p "$rs_cur_password" scp -P $RELAYSERVER_CURRENT_SSH_PORT $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME $rs_cur_username@$RELAYSERVER_SERVER_IP:~/
    is_err=$?
    rm -f $HOME/$RS_INSTALL_VALIDATION_SCRIPT_NAME
    if [ $is_err -ne 0 ]; then
      err_message="There was an error uploading the validation script to the RelayServer."
      continue
    fi
    sshpass -p "$rs_cur_password" scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME $rs_cur_username@$RELAYSERVER_SERVER_IP:~/$RS_INSTALL_VALIDATION_LIB_SCRIPT_NAME
    is_err=$?
    if [ $is_err -ne 0 ]; then
      err_message="There was an error uploading the setup script to the RelayServer."
      continue
    fi
    echo "Performing pre-installation checks, please wait..."
    SSHPASS="$rs_cur_password" sshpass -e ssh -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 -p $RELAYSERVER_CURRENT_SSH_PORT $rs_cur_username@$RELAYSERVER_SERVER_IP "bash ~/$RS_INSTALL_VALIDATION_SCRIPT_NAME -s" <<< "$USER_RELAY_SUDO_PW" > /tmp/rsValidationOutput.txt
    is_err=$?
    if [ $is_err -ne 0 ]; then
      err_message="$(cat /tmp/rsValidationOutput.txt)"
      rm -f /tmp/rsValidationOutput.txt
      continue
    fi
    unloadSSHKey
    if [ $is_err -eq 0 ]; then
      break
    fi
  done
  if [ -f /tmp/rsValidationOutput.txt ]; then
    cat /tmp/rsValidationOutput.txt
  fi
  rm -f /tmp/rsValidationOutput.txt
  refreshSudo
  rs_cur_password=""
  updateConfigVar RELAYSERVER_CURRENT_SSH_PORT $RELAYSERVER_CURRENT_SSH_PORT
  updateConfigVar RELAYSERVER_SERVER_IP $RELAYSERVER_SERVER_IP
  addHomeNetIP ${RELAYSERVER_SERVER_IP}/32 true
  if [ "$IS_INSTALLED" = "true" ]; then
    addDomainAdguardHS "*.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" "$RELAYSERVER_SERVER_IP"
  fi
  if ! [ "$isTransfer" = "true" ]; then
    updateConfigVar RELAYSERVER_REMOTE_USERNAME $RELAYSERVER_REMOTE_USERNAME
    RELAYSERVER_HSHQ_BASE_DIR=/home/$RELAYSERVER_REMOTE_USERNAME/hshq
    RELAYSERVER_HSHQ_DATA_DIR=$RELAYSERVER_HSHQ_BASE_DIR/data
    RELAYSERVER_HSHQ_NONBACKUP_DIR=$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
    RELAYSERVER_HSHQ_SCRIPTS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/scripts
    RELAYSERVER_HSHQ_SECRETS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/secrets
    RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/stacks
    RELAYSERVER_HSHQ_SSL_DIR=$RELAYSERVER_HSHQ_DATA_DIR/ssl
    updateConfigVar RELAYSERVER_HSHQ_BASE_DIR $RELAYSERVER_HSHQ_BASE_DIR
    updateConfigVar RELAYSERVER_HSHQ_DATA_DIR $RELAYSERVER_HSHQ_DATA_DIR
    updateConfigVar RELAYSERVER_HSHQ_NONBACKUP_DIR $RELAYSERVER_HSHQ_NONBACKUP_DIR
    updateConfigVar RELAYSERVER_HSHQ_SCRIPTS_DIR $RELAYSERVER_HSHQ_SCRIPTS_DIR
    updateConfigVar RELAYSERVER_HSHQ_SECRETS_DIR $RELAYSERVER_HSHQ_SECRETS_DIR
    updateConfigVar RELAYSERVER_HSHQ_STACKS_DIR $RELAYSERVER_HSHQ_STACKS_DIR
    updateConfigVar RELAYSERVER_HSHQ_SSL_DIR $RELAYSERVER_HSHQ_SSL_DIR
  fi
  loadSSHKey
  scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_SETUP_SCRIPT_NAME $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
  if [ "$isTransfer" = "true" ]; then
    scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_TRANSFER_SCRIPT_NAME $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
  else
    scp -P $RELAYSERVER_CURRENT_SSH_PORT $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SERVER_IP:/home/$RELAYSERVER_REMOTE_USERNAME
    rm -f $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_FRESH_SCRIPT_NAME
  fi
  unloadSSHKey
}

function loadSSHKey()
{
  set +e
  ssh-add -L > /dev/null 2>&1
  if [ $? -eq 2 ]; then
    eval "$(ssh-agent)"
  fi
  set -e
  cat <<EOFAP > $HSHQ_CONFIG_DIR/askpass
#!/bin/bash
echo $RELAYSERVER_SSH_PRIVATE_KEY_PHRASE
EOFAP
  chmod u+x $HSHQ_CONFIG_DIR/askpass
  DISPLAY=1 SSH_ASKPASS="$HSHQ_CONFIG_DIR/askpass" ssh-add $HSHQ_CONFIG_DIR/$RELAYSERVER_SSH_PRIVATE_KEY_FILENAME < /dev/null
  rm $HSHQ_CONFIG_DIR/askpass
}

function unloadSSHKey()
{
  ssh-add -D 2> /dev/null
}

function connectPrimaryVPN()
{
  is_prompt_user="$1"
  db_id=$(getPrimaryVPN_DBID)
  if ! [ -z "$db_id" ]; then
    connectVPN $db_id "$is_prompt_user"
  fi
}

function getPrimaryVPN_DBID()
{
  echo $(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='primary';")
}

function getPrimaryVPN_IP()
{
  prim_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ConnectionType='homeserver_vpn' and NetworkType='primary';")
}

function connectPrimaryInternet()
{
  db_id=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_internet' and NetworkType='primary';")
  if [ -z "$db_id" ]; then
    return
  fi
  ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  dockerSubnet=$(getConfigVarFromFile \#DOCKER_NETWORK_SUBNET $HSHQ_WIREGUARD_DIR/internet/${ifaceName}.conf root)
  if [ -z "$dockerSubnet" ]; then
    dockerNetworkName=$(getConfigVarFromFile \#DOCKER_NETWORK_NAME $HSHQ_WIREGUARD_DIR/internet/${ifaceName}.conf root)
    conn_mtu=$(getConfigVarFromFile \#MTU $HSHQ_WIREGUARD_DIR/internet/${ifaceName}.conf root)
    dockerSubnet=$(getNextAvailableWGDockerNetwork $dockerNetworkName $conn_mtu)
    sudo sed -i "s|^#DOCKER_NETWORK_SUBNET.*|#DOCKER_NETWORK_SUBNET=$dockerSubnet|g" $HSHQ_WIREGUARD_DIR/internet/${ifaceName}.conf
  fi
  connectInternet $db_id
}

function connectVPN()
{
  echo "Connecting to RelayServer via WireGuard..."
  # Configuration files of this type are expected to be located in /etc/wireguard
  db_id=$1
  is_prompt_user="$2"
  if [ -z "$db_id" ]; then
    echo "ERROR: No database ID provided."
    return
  fi
  client_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  hs_name=$(sqlite3 $HSHQ_DB "select HomeServerName from hsvpn_connections where ID=$db_id;")
  ext_prefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$db_id;")
  int_prefix=$(sqlite3 $HSHQ_DB "select InternalPrefix from hsvpn_connections where ID=$db_id;")
  ca_abbrev=$(sqlite3 $HSHQ_DB "select CA_Abbrev from hsvpn_connections where ID=$db_id;")
  domain_name=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$db_id;")
  ca_ip=$(sqlite3 $HSHQ_DB "select CA_IP from hsvpn_connections where ID=$db_id;")
  ca_subdomain=$(sqlite3 $HSHQ_DB "select CA_Subdomain from hsvpn_connections where ID=$db_id;")
  ca_url=$(sqlite3 $HSHQ_DB "select CA_URL from hsvpn_connections where ID=$db_id;")
  vpn_subnet=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections where ID=$db_id;")
  rs_vpn_ip=$(sqlite3 $HSHQ_DB "select RS_VPN_IP from hsvpn_connections where ID=$db_id;")
  is_primary=$(sqlite3 $HSHQ_DB "select IsPrimary from hsvpn_connections where ID=$db_id;")
  if [ $is_primary = 1 ] && [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    loadSSHKey
    set +e
    while true;
    do
      max_attempts=40
      total_attempts=1
      isBreak=false
      while [ $total_attempts -le $max_attempts ]
      do
        ssh -p $RELAYSERVER_SSH_PORT -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "echo \"Logged in to RelayServer...\"; if test -f ~/$RELAYSERVER_INSTALL_FAILED_FILE; then exit 23; fi; test -f ~/hshq/$RELAYSERVER_INSTALL_COMPLETE_FILE && rm -f ~/hshq/$RELAYSERVER_INSTALL_COMPLETE_FILE > /dev/null 2>&1"
        rtVal=$?
        if [ $rtVal -eq 0 ]; then
          isBreak=true
          break
        elif [ $rtVal -eq 23 ]; then
          echo "************************************************************************************"
          echo " ERROR: The RelayServer installation failed to complete. Please remove it and retry."
          echo "************************************************************************************"
          return
        fi
        if [ $total_attempts -lt 10 ]; then
          echo "($total_attempts of $max_attempts) RelayServer installation has not completed, retrying in 30 seconds..."
        else
          echo "($total_attempts of $max_attempts) RelayServer installation has not completed, it could be a firewall issue with the provider. Ensure that the port $RELAYSERVER_SSH_PORT (SSH) is open and accessible. Retrying in 30 seconds..."
        fi
        refreshSudo
        sleep 30
        total_attempts=$((total_attempts + 1))
      done
      if ! [ "$isBreak" = "true" ]; then
        if [ "$is_prompt_user" = "true" ]; then
          echo "ERROR: Could not log in to RelayServer to setup Syncthing. If this step is skipped, you will have to manually set up the RelayServer backup in Syncthing."
          while true;
          do
            read -r -p "Enter 'retry' or 'cancel': " isRetryConnect
            case "$isRetryConnect" in
              "retry")
                break
              ;;
              "cancel")
                isBreak=true
                break
              ;;
              *)
                echo "Unknown response..."
              ;;
            esac
          done
        else
          echo "ERROR: Could not log in to RelayServer to setup Syncthing. Something likely went wrong with the RelayServer installation. You might have to entirely remove the Primary VPN and start over (In Script-server: 06 My Network -> 15 Remove Primary VPN)."
          isBreak=true
        fi
      fi
      if [ "$isBreak" = "true" ]; then
        break
      fi
    done
    unloadSSHKey
  fi
  enableWGInterfaceQuick $ifaceName
  # If not hosting or non-primary VPN, then add CA domain.
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || ! [ $is_primary = 1 ]; then
    addDomainAndWildcardAdguardNoReplaceHS "$domain_name" "$ca_ip"
    addDomainAdguardHS "*.$ext_prefix.$domain_name" "A"
    addDomainAndWildcardIgnoreQuerylogAndStatsHS "$domain_name"
    insertEnableSvcUptimeKuma uptimekuma "${hs_name}" homeservers "https://$SUB_HSHQSTATUS.$domain_name" true
  fi
  addDomainAdguardHS "*.$int_prefix.$domain_name" "$rs_vpn_ip"
  primary_string=other
  if [ $is_primary = 1 ]; then
    primary_string=primary
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
      restartAllCaddyContainers
    fi
  fi
  updateSvcsIPChanges
  # Add new Caddy container.
  installCaddy $ifaceName $primary_string $ifaceName $client_ip $ca_abbrev $ca_url $ca_subdomain $ca_ip
  if [ $is_primary = 1 ] && [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    updateMailuStackRelayHost
  fi
  # If hosting VPN, add ClientDNS stack and setup Syncthing
  if [ $is_primary = 1 ] && [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    set +e
    echo "Installing ClientDNS..."
    CLIENTDNS_USER1_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_clientdns"
    CLIENTDNS_USER1_ADMIN_PASSWORD="$(pwgen -c -n 32 1)"
    installClientDNS user1 $RELAYSERVER_WG_HS_CLIENTDNS_IP "$CLIENTDNS_USER1_ADMIN_USERNAME" "$CLIENTDNS_USER1_ADMIN_PASSWORD"
    echo "Sleeping for 5 seconds..."
    sleep 5
    loadSSHKey
    # Setup syncthing link
    echo "Setting up Syncthing..."
    SYNCTHING_DEVICE_ID=$(curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X GET -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices | jq '.[0]' | jq -r '.deviceID')
    updateConfigVar SYNCTHING_DEVICE_ID $SYNCTHING_DEVICE_ID
    # Remote Syncthing
    echo "Getting RelayServer syncthing device ID..."
    runCommandOnRelayServer true "curl -s -H \"X-API-Key: $RELAYSERVER_SYNCTHING_API_KEY\" -X GET -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices | jq '.[0]' | jq -r '.deviceID'"
    if [ $? -ne 0 ]; then
      echo "There was an error obtaining the remote RelayServer Synchthing device ID. This is likely due to an issue with your internet connection. You can either manually set up Syncthing to backup your RelayServer's data or remove the VPN and retry."
      set -e
      unloadSSHKey
      updateHeimdallUptimeKumaRelayServer
      return
    fi
    RELAYSERVER_SYNCTHING_DEVICE_ID="$rsCaptureResults"
    updateConfigVar RELAYSERVER_SYNCTHING_DEVICE_ID $RELAYSERVER_SYNCTHING_DEVICE_ID
    jsonbody="{\\\"deviceID\\\": \\\"$SYNCTHING_DEVICE_ID\\\", \\\"name\\\": \\\"$HOMESERVER_NAME HomeServer\\\",\\\"addresses\\\": [\\\"tcp://$SUB_SYNCTHING.$HOMESERVER_DOMAIN:$SYNCTHING_SYNC_PORT\\\"], \\\"compression\\\": \\\"metadata\\\", \\\"certName\\\": \\\"\\\", \\\"skipIntroductionRemovals\\\": false,\\\"introducedBy\\\": \\\"\\\",\\\"paused\\\": false,\\\"allowedNetworks\\\": [],\\\"autoAcceptFolders\\\": false,\\\"maxSendKbps\\\": 0,\\\"maxRecvKbps\\\": 0,\\\"ignoredFolders\\\": [],\\\"maxRequestKiB\\\": 0,\\\"untrusted\\\": false,\\\"remoteGUIPort\\\": 0}"
    echo "Adding HomeServer device to RelayServer syncthing..."
    runCommandOnRelayServer false "curl -s -H \"X-API-Key: $RELAYSERVER_SYNCTHING_API_KEY\" -X POST -d \"$jsonbody\" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices"
    if [ $? -ne 0 ]; then
      echo "There was an error setting up Syncthing on the remote RelayServer instance. This is likely due to an issue with your internet connection. You can either manually set up Syncthing to backup your RelayServer's data or remove the VPN and retry."
      set -e
      unloadSSHKey
      updateHeimdallUptimeKumaRelayServer
      return
    fi
    jsonbody="{\\\"id\\\": \\\"$RELAYSERVER_SYNCTHING_FOLDER_ID\\\", \\\"label\\\": \\\"RelayServer Backup\\\",\\\"filesystemType\\\": \\\"basic\\\", \\\"path\\\": \\\"/relayserver/\\\", \\\"type\\\": \\\"sendonly\\\",\\\"devices\\\": [{\\\"deviceID\\\": \\\"$RELAYSERVER_SYNCTHING_DEVICE_ID\\\",\\\"introducedBy\\\": \\\"\\\",\\\"encryptionPassword\\\": \\\"\\\"},{\\\"deviceID\\\": \\\"$SYNCTHING_DEVICE_ID\\\",\\\"introducedBy\\\": \\\"\\\",\\\"encryptionPassword\\\": \\\"\\\"}], \\\"rescanIntervalS\\\": 3600,\\\"fsWatcherEnabled\\\": true,\\\"fsWatcherDelayS\\\": 10,\\\"ignorePerms\\\": false,\\\"autoNormalize\\\": true,\\\"minDiskFree\\\": {\\\"value\\\": 1,\\\"unit\\\": \\\"%\\\"},\\\"versioning\\\": {\\\"type\\\": \\\"\\\",\\\"params\\\": {},\\\"cleanupIntervalS\\\": 3600,\\\"fsPath\\\": \\\"\\\",\\\"fsType\\\": \\\"basic\\\"},\\\"copiers\\\": 0,\\\"pullerMaxPendingKiB\\\": 0,\\\"hashers\\\": 0,\\\"order\\\": \\\"random\\\",\\\"ignoreDelete\\\": false,\\\"scanProgressIntervalS\\\": 0,\\\"pullerPauseS\\\": 0,\\\"maxConflicts\\\": 10,\\\"disableSparseFiles\\\": false,\\\"disableTempIndexes\\\": false,\\\"paused\\\": false,\\\"weakHashThresholdPct\\\": 25,\\\"markerName\\\": \\\".stfolder\\\",\\\"copyOwnershipFromParent\\\": false,\\\"modTimeWindowS\\\": 0,\\\"maxConcurrentWrites\\\": 2,\\\"disableFsync\\\": false,\\\"blockPullOrder\\\": \\\"standard\\\",\\\"copyRangeMethod\\\": \\\"standard\\\",\\\"caseSensitiveFS\\\": false,\\\"junctionsAsDirs\\\": false,\\\"syncOwnership\\\": false,\\\"sendOwnership\\\": true,\\\"syncXattrs\\\": false,\\\"sendXattrs\\\": false,\\\"xattrFilter\\\": {\\\"entries\\\": [],\\\"maxSingleEntrySize\\\": 1024,\\\"maxTotalSize\\\": 4096}}"
    echo "Setting up backup directory on RelayServer syncthing..."
    runCommandOnRelayServer false "curl -s -H \"X-API-Key: $RELAYSERVER_SYNCTHING_API_KEY\" -X POST -d \"$jsonbody\" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders"
    if [ $? -ne 0 ]; then
      echo "There was an error configuring Syncthing on the remote RelayServer instance. This is likely due to an issue with your internet connection. You can either manually set up Syncthing to backup your RelayServer's data or remove the VPN and retry."
      set -e
      unloadSSHKey
      updateHeimdallUptimeKumaRelayServer
      return
    fi
    # Local Syncthing
    jsonbody="{\"deviceID\": \"$RELAYSERVER_SYNCTHING_DEVICE_ID\", \"name\": \"$RELAYSERVER_NAME\",\"addresses\": [\"tcp://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$SYNCTHING_SYNC_PORT\"], \"compression\": \"metadata\", \"certName\": \"\", \"skipIntroductionRemovals\": false,\"introducedBy\": \"\",\"paused\": false,\"allowedNetworks\": [],\"autoAcceptFolders\": false,\"maxSendKbps\": 0,\"maxRecvKbps\": 0,\"ignoredFolders\": [],\"maxRequestKiB\": 0,\"untrusted\": false,\"remoteGUIPort\": 0}"
    echo "Setting up RelayServer device on HomeServer syncthing..."
    if [ "$LOG_LEVEL" = "debug" ]; then
      echo -e "Running this command on HomeServer:"
      echo -e "++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
      echo "curl -s -H \"X-API-Key: $SYNCTHING_API_KEY\" -X POST -d \"$jsonbody\" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices"
      echo -e " \n\n++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
    fi
    curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X POST -d "$jsonbody" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices
    jsonbody="{\"id\": \"$RELAYSERVER_SYNCTHING_FOLDER_ID\", \"label\": \"RelayServer Backup\",\"filesystemType\": \"basic\", \"path\": \"/relayserver/\", \"type\": \"receiveonly\",\"devices\": [{\"deviceID\": \"$SYNCTHING_DEVICE_ID\",\"introducedBy\": \"\",\"encryptionPassword\": \"\"},{\"deviceID\": \"$RELAYSERVER_SYNCTHING_DEVICE_ID\",\"introducedBy\": \"\",\"encryptionPassword\": \"\"}], \"rescanIntervalS\": 3600,\"fsWatcherEnabled\": true,\"fsWatcherDelayS\": 10,\"ignorePerms\": false,\"autoNormalize\": true,\"minDiskFree\": {\"value\": 1,\"unit\": \"%\"},\"versioning\": {\"type\": \"\",\"params\": {},\"cleanupIntervalS\": 3600,\"fsPath\": \"\",\"fsType\": \"basic\"},\"copiers\": 0,\"pullerMaxPendingKiB\": 0,\"hashers\": 0,\"order\": \"random\",\"ignoreDelete\": false,\"scanProgressIntervalS\": 0,\"pullerPauseS\": 0,\"maxConflicts\": 10,\"disableSparseFiles\": false,\"disableTempIndexes\": false,\"paused\": false,\"weakHashThresholdPct\": 25,\"markerName\": \".stfolder\",\"copyOwnershipFromParent\": false,\"modTimeWindowS\": 0,\"maxConcurrentWrites\": 2,\"disableFsync\": false,\"blockPullOrder\": \"standard\",\"copyRangeMethod\": \"standard\",\"caseSensitiveFS\": false,\"junctionsAsDirs\": false,\"syncOwnership\": true,\"sendOwnership\": false,\"syncXattrs\": false,\"sendXattrs\": false,\"xattrFilter\": {\"entries\": [],\"maxSingleEntrySize\": 1024,\"maxTotalSize\": 4096}}"
    echo "Setting up backup directory on HomeServer syncthing..."
    if [ "$LOG_LEVEL" = "debug" ]; then
      echo -e "Running this command on HomeServer:"
      echo -e "++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
      echo "curl -s -H \"X-API-Key: $SYNCTHING_API_KEY\" -X POST -d \"$jsonbody\" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders"
      echo -e " \n\n++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
    fi
    curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X POST -d "$jsonbody" -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders
    echo "Restarting caddy instance on RelayServer..."
    runCommandOnRelayServer false "docker container restart caddy"
    if [ $? -ne 0 ]; then
      echo "There was an error restarting caddy on the remote RelayServer instance. This is likely due to an issue with your internet connection. This is not a breaking issue, it will likely resolve itself automatically."
      set -e
      unloadSSHKey
      updateHeimdallUptimeKumaRelayServer
      return
    fi
    echo "Finished setting up syncthing..."
    set -e
    unloadSSHKey
    curdt=$(getCurrentDate)
    sudo sqlite3 $HSHQ_DB "update connections set LastUpdated='$curdt' where ID=$db_id;"
    updateHeimdallUptimeKumaRelayServer
  fi
}

function runCommandOnRelayServer()
{
  set +e
  isCaptureResult="$1"
  rsCommand="$2"
  maxRSRetries="$3"
  rsInterval="$4"
  if [ -z "$maxRSRetries" ]; then
    maxRSRetries=30
  fi
  if [ -z "$rsInterval" ]; then
    rsInterval=10
  fi
  total_attempts=1
  isRSSuccess=false
  rsCaptureResults=""
  if [ "$LOG_LEVEL" = "debug" ]; then
    echo -e "Running this command on RelayServer:"
    echo -e "++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
    echo "$rsCommand"
    echo -e "\n\n++++++++++++++++++++++++++++++++++++++++++++++++++\n\n"
  fi
  while [ $total_attempts -le $maxRSRetries ]
  do
    rsCaptureResults=""
    if [ "$isCaptureResult" = "true" ]; then
      rsCaptureResults=$(timeout $rsInterval ssh -p $RELAYSERVER_SSH_PORT -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$rsCommand")
    else
      timeout $rsInterval ssh -p $RELAYSERVER_SSH_PORT -o 'StrictHostKeyChecking accept-new' -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$rsCommand"
    fi
    if [ $? -eq 0 ]; then
      isRSSuccess=true
      break
    fi
    echo "($total_attempts of $maxRSRetries), retrying in 5 seconds..."
    refreshSudo
    sleep 5
    total_attempts=$((total_attempts + 1))
  done
  if ! [ "$isRSSuccess" = "true" ]; then
    rsCaptureResults=""
    return 10
  fi
}

function connectInternet()
{
  db_id=$1
  ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${ifaceName}.conf up
}

function resetRelayServerData()
{
  sudo rm -fr $HSHQ_RELAYSERVER_DIR/backup/*
  sudo rm -fr $HSHQ_RELAYSERVER_DIR/scripts/*
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where NetworkType in ('relayserver','primary','mynetwork');"
}

function createOrJoinPrimaryVPN()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    is_remove=$(promptUserInputMenu "" "Existing RelayServer" "There is already a RelayServer set up. If you wish to remove all connections/data, enter the word 'remove' below:")
    if ! [ "$is_remove" = "remove" ]; then
      showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
      return 0
    fi
    set +e
    disconnect_reason=$(promptUserInputMenu "" "Enter Reason" "Enter a reason for removal/disconnect: ")
    removeMyNetworkPrimaryVPN "$disconnect_reason"
  fi

  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option for your PRIMARY VPN connection" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
    "1" "Host a VPN" \
    "2" "Join a VPN" \
    "3" "Exit" 3>&1 1>&2 2>&3)

    case $menures in
      1)
        confirmHost=$(promptUserInputMenu "" "Confirmation" "This function will set up a hosted VPN. Ensure you have the RelayServer ready and you can readily log into it. Enter the word 'confirm' below:")
        if ! [ "$confirmHost" = "confirm" ]; then
          showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
          return 0
        fi
        PRIMARY_VPN_SETUP_TYPE=host
        updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
        setupHostedVPN
        if [ $? -ne 0 ]; then
          return 0
        fi
        rs_wg_user_conf=$(sudo cat $HSHQ_WIREGUARD_DIR/users/${RELAYSERVER_WG_VPN_NETNAME}-user1.conf)
        # Set env vars in mailu stack
        set +e
        updateMailuStackRelayHost
        email_msg="Your new RelayServer has been configured. Below is your first WireGuard User Connection Info:\n\n================ WireGuard Configuration ================\n${rs_wg_user_conf}\n=======================================================\n"
        sendEmail -s "New RelayServer" -b "$email_msg" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
        clear
        echo -e "\n\n$(getDNSRecordsInfo $HOMESERVER_DOMAIN)\n\n"
        echo -e "============= User WireGuard Configuration ============\n"
        echo -e """""$rs_wg_user_conf""""\n"
        echo -e "=======================================================\n"
        echo -e "_______________________________________________________"
        echo -e "The installation script has been uploaded. Please log in to"
        echo -e "the RelayServer with your newly created username ($RELAYSERVER_REMOTE_USERNAME),"
        echo -e "and perform the installation by entering the command"
        echo -e "'bash $RS_INSTALL_FRESH_SCRIPT_NAME', and follow the prompts.\n"
        echo -e "Ensure to copy your new WireGuard configuration above for your first user.\n"
        echo -e "AFTER the RelayServer has completed the installation, and AFTER the server"
        echo -e "has FULLY rebooted, enter 'integrate' to finish the integration. When this"
        echo -e "process completes, and you are returned to the main menu, then you can"
        echo -e "safely activate your new WireGuard connection to access your HomeServer"
        echo -e "network and masquerade your IP address.\n"
        echo -e "Check your admin email ($EMAIL_ADMIN_EMAIL_ADDRESS) for a copy of the WireGuard config info."
        while true;
        do
          read -r -p "Enter 'integrate' to complete the integration (no quotes, all lowercase): " is_continue
          if [ "$is_continue" = "integrate" ]; then
            break
          fi
        done
        connectPrimaryInternet
        connectPrimaryVPN true
        ;;
      2)
        confirmJoin=$(promptUserInputMenu "" "Confirmation" "This function will prepare you server to join another hosted VPN as your primary. Enter the word 'confirm' below:")
        if ! [ "$confirmJoin" = "confirm" ]; then
          showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
          return 0
        fi
        PRIMARY_VPN_SETUP_TYPE=join
        updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
        setupJoinPrimaryVPN
        join_res=$?
        if [ $join_res -ne 0 ]; then
          return
        fi
        connectPrimaryVPN true
        email_msg="Your joined RelayServer has been configured, please update your DNS MX record with your domain name provider to the new mail server:  $RELAYSERVER_EXT_EMAIL_HOSTNAME\n\n"
        # Set env vars in mailu stack
        set +e
        sendEmail -s "New RelayServer" -b "$email_msg" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
        showMessageBox "Joined RelayServer" "The RelayServer has been joined. Check your email ($EMAIL_ADMIN_EMAIL_ADDRESS) for further details."
        ;;
      3)
        return ;;
    esac
}

function showRemovePrimaryVPN()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    is_remove=$(promptUserInputMenu "" "Remove RelayServer" "If you wish to remove all connections/data, enter the word 'remove' below:")
    if [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
      showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
      return 0
    fi
    set +e
    disconnect_reason=$(promptUserInputMenu "" "Enter Reason" "Enter a reason for removal/disconnect: ")
    removeMyNetworkPrimaryVPN "$disconnect_reason"
  else
    showMessageBox "Invalid Selection" "You are not currently connected to a RelayServer, returning..."
  fi
}

# VPN Menus
function showNetworkMenu()
{
  networkmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$networkmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "My Network" \
  "2" "Other Networks" \
  "3" "RelayServer Utils" \
  "4" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
        showMessageBox "No RelayServer" "You are not hosting a RelayServer, returning..."
        return
      fi
      showMyNetworkMenu ;;
    2)
      refreshSudo
      showOtherNetworksMenu ;;
    3)
      showRelayServerUtilsMenu ;;
    *)
      return ;;
  esac
}

function showMyNetworkMenu()
{
  networkmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$networkmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Invite to My Network" \
  "2" "Remove from My Network" \
  "3" "My Network Utils" \
  "4" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      createMyNetworkInvite ;;
    2)
      showMyNetworkRemoveMenu ;;
    3)
      showMyNetworkUtilsMenu ;;
    *)
      return ;;
  esac
}

function showOtherNetworksMenu()
{
  networkmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$networkmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Apply to Another Network" \
  "2" "Join Another Network" \
  "3" "Disconnect From Another Network" \
  "4" "Other Network Utils" \
  "5" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      showOtherNetworkApplyMenu ;;
    2)
      showOtherNetworkJoinMenu ;;
    3)
      showOtherNetworkDisconnectMenu ;;
    4)
      showOtherNetworkUtilsMenu ;;
    *)
      return ;;
  esac
}

function showRelayServerUtilsMenu()
{
  netutilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$netutilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Add Domain(s) To RelayServer" \
  "2" "Remove Domain(s) From RelayServer" \
  "3" "Add Subdomain to be managed by LetsEncrypt" \
  "4" "Create or Join a VPN RelayServer" \
  "5" "Transfer RelayServer" \
  "6" "Remove VPN RelayServer" \
  "7" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      addDomainsToRelayServer ;;
    2)
      removeDomainsFromRelayServer ;;
    3)
      addLECertPathsToRelayServerMsgbox ;;
    4)
      #createOrJoinPrimaryVPN
      showMessageBox "Deprecated" "This function is now only accessible via Script-server (https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN)."
    ;;
    5)
      #transferHostedVPN
      showMessageBox "Deprecated" "This function is outdated and unsupported at the moment. If you need to transfer your RelayServer, then make a feature request on the forum (https://forum.homeserverhq.com)."
    ;;
    6)
      showRemovePrimaryVPN ;;
    *)
      return ;;
  esac
}

function showMyNetworkRemoveMenu()
{
  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "HomeServer VPN" \
  "2" "HomeServer Internet" \
  "3" "User" \
  "4" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      showMyNetworkRemoveVPNMenu ;;
    2)
      showMyNetworkRemoveInternetMenu ;;
    3)
      showMyNetworkRemoveUserMenu ;;
    *)
      return ;;
  esac
}

function showMyNetworkUtilsMenu()
{
  netutilmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$netutilmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Email HomeServers DNS List" \
  "2" "Email Users DNS List" \
  "3" "Create ClientDNS Server" \
  "4" "Remove ClientDNS Server" \
  "5" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      showEmailMyNetworkHomeServerDNSListMenu ;;
    2)
      showEmailMyNetworkHomeServerDNSListClientDNSMenu ;;
    3)
      showMyNetworkCreateClientDNSMenu ;;
    4)
      showMyNetworkRemoveClientDNSMenu ;;
    *)
      return ;;
  esac
}

function showOtherNetworkApplyMenu()
{
  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "HomeServer VPN (Producer)" \
  "2" "HomeServer Internet (Consumer)" \
  "3" "User (Consumer)" \
  "4" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      createOtherNetworkApplyHomeServerVPNConfig ;;
    2)
      createOtherNetworkApplyHomeServerInternetConfig ;;
    3)
      createOtherNetworkApplyUserConfig ;;
    *)
      return ;;
  esac
}

function showOtherNetworkJoinMenu()
{
  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "VPN" \
  "2" "Internet" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      createNetworkJoin true
      if [ $? -ne 0 ]; then
        return
      fi
      ;;
    2)
      createNetworkJoin true
      if [ $? -ne 0 ]; then
        return
      fi
      ;;
    *)
      return ;;
  esac
}

function showOtherNetworkDisconnectMenu()
{
  vpnmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$vpnmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "VPN" \
  "2" "Internet" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      showOtherNetworkDisconnectVPNMenu ;;
    2)
      showOtherNetworkDisconnectInternetMenu ;;
    *)
      return ;;
  esac
}

function showOtherNetworkUtilsMenu()
{
  utilsmenu=$(cat << EOF

$(getLogo)
EOF
)
  menures=$(whiptail --title "Select an option" --menu "$utilsmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT \
  "1" "Update HomeServer DNS" \
  "2" "Sync Adguard DNS Server from DB" \
  "3" "Exit" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    menures=0
  fi
  case $menures in
    1)
      showUpdateHomeServerDNSMenu ;;
    2)
      syncAdguardDNSFromDB ;;
    *)
      return ;;
  esac
}

function showMyNetworkRemoveVPNMenu()
{
  vpnremovemenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to remove:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpnremovemenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  is_remove=$(promptUserInputMenu "" "Confirm Removal" "This will remove all selected network connections. To confirm, enter the word 'remove' below:")
  if [ $? -ne 0 ] || [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  removal_reason=$(promptUserInputMenu "" "Removal Reason" "Enter a reason for removal: ")
  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    removeMyNetworkHomeServerVPNConnection $curvpnID "$removal_reason"
  done
}

function showMyNetworkRemoveInternetMenu()
{
  vpnremovemenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to remove:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='homeserver_internet' and NetworkType='mynetwork';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpnremovemenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  is_remove=$(promptUserInputMenu "" "Confirm Removal" "This will remove all selected network connections. To confirm, enter the word 'remove' below:")
  if [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  removal_reason=$(promptUserInputMenu "" "Removal Reason" "Enter a reason for removal: ")
  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    peer_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$curvpnID;")
    removeMyNetworkNonHomeServerConnection $curvpnID
    # Notify peer that you have removed them.
    notifyHomeServerInternetNetworkRemoval "$peer_email" "$removal_reason"
  done
}

function notifyHomeServerInternetNetworkRemoval()
{
  peer_email="$1"
  removal_reason="$2"
  email_subj="HomeServer Removal Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=${email_body}"HomeServer Removal Notice from $HOMESERVER_NAME\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"Your HomeServer internet connection has been removed from the network.\n"
  email_body=${email_body}"Ensure to disconnect accordingly.\n\n"
  email_body=${email_body}"Host Domain: $HOMESERVER_DOMAIN\n"
  email_body=${email_body}"Reason Provided: $removal_reason\n\n"
  sendEmail -s "$email_subj" -b "$email_body" -t "$peer_email" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function showMyNetworkRemoveUserMenu()
{
  vpnremovemenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to remove:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='user' and NetworkType='mynetwork';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpnremovemenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  removal_reason=$(promptUserInputMenu "" "Removal Reason" "Enter a reason for removal: ")
  is_remove=$(promptUserInputMenu "" "Confirm Removal" "This will remove all selected network connections. To confirm, enter the word 'remove' below:")
  if [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi

  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    peer_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$curvpnID;")
    removeMyNetworkNonHomeServerConnection $curvpnID
    # Notify peer that you have removed them.
    notifyUserNetworkRemoval "$peer_email" "$removal_reason"
  done
}

function notifyUserNetworkRemoval()
{
  peer_email="$1"
  removal_reason="$2"
  email_subj="HomeServer Removal Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=${email_body}"HomeServer Removal Notice from $HOMESERVER_NAME\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"Your client connection has been removed from the network.\n"
  email_body=${email_body}"Ensure to disconnect accordingly.\n\n"
  email_body=${email_body}"Host Domain: $HOMESERVER_DOMAIN\n"
  email_body=${email_body}"Reason Provided: $removal_reason\n\n"
  sendEmail -s "$email_subj" -b "$email_body" -t "$peer_email" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function showMyNetworkCreateClientDNSMenu()
{
  clientdns_stack_name=$(promptUserInputMenu "" "ClientDNS Stack Name" "Enter a unique name for this stack, 3-10 alpha-numeric lowercase characters: ")
  if [ -z "$clientdns_stack_name" ]; then
    showMessageBox "Stack Name Empty" "The name cannot be empty."
  fi
  if [ -z "$clientdns_stack_name" ]; then
    return
  fi
  performMyNetworkCreateClientDNS "$clientdns_stack_name"
}

function performMyNetworkCreateClientDNS()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  clientdns_stack_name="$1"
  if [ $(checkValidString "$clientdns_stack_name") = "false" ] || [ ${#clientdns_stack_name} -lt 3 ] || [ ${#clientdns_stack_name} -gt 10 ]; then
    echo "ERROR: Invalid ClientDNS stack name - must contain 3-10 lowercase alpha-numeric characters, no spaces or special characters."
    return
  fi
  # Check if name exists in DB
  cdns_stack_name=$(sqlite3 $HSHQ_DB "select Name from connections where Name='clientdns-$clientdns_stack_name';")
  if ! [ -z "$cdns_stack_name" ]; then
    echo "ERROR: A stack with this name already exists."
    return
  fi
  # Check if stack exists in Portainer
  checkID=$(getStackID clientdns-${clientdns_stack_name})
  if ! [ -z "$checkID" ]; then
    echo "ERROR: A stack with this name already exists."
    return
  fi
  # Generate WireGuard config
  wg_ip=$(getRandomVPNIP)
  if [ -z "$wg_ip" ]; then
    echo "ERROR: Could not allocate an IP address, your network is full."
    return
  fi
  wg_priv_key=$(wg genkey)
  wg_pre_key=$(wg genpsk)
  wg_pub_key=$(echo $wg_priv_key | wg pubkey)
  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"ClientDNS-$clientdns_stack_name\" \"$EMAIL_ADMIN_EMAIL_ADDRESS\" \"$wg_pub_key\" \"$wg_pre_key\" \"$wg_ip\" \"false\" \"true\" \"$wgPortalAuth\""
  mbres=$?
  if [ $mbres -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer, returning..."
    return
  fi
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('clientdns-$clientdns_stack_name','$EMAIL_ADMIN_EMAIL_ADDRESS','clientdns','mynetwork','$wg_pub_key','$wg_pre_key','$wg_ip',false,'wg0','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$(getCurrentDate)');"

  sudo rm -f $HSHQ_WIREGUARD_DIR/users/clientdns-${clientdns_stack_name}.conf
  sudo tee $HSHQ_WIREGUARD_DIR/users/clientdns-${clientdns_stack_name}.conf >/dev/null <<EOFCF
[Interface]
PrivateKey = $wg_priv_key
Address = ${wg_ip}/32
MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU

[Peer]
PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY
PresharedKey = $wg_pre_key
AllowedIPs = $PRIMARY_VPN_SUBNET
Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT
PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE
EOFCF
  sudo chmod 0400 $HSHQ_WIREGUARD_DIR/users/clientdns-${clientdns_stack_name}.conf

  adm_username=$ADMIN_USERNAME_BASE"_clientdns"
  adm_pw=$(pwgen -c -n 32 1)
  installClientDNS $clientdns_stack_name $wg_ip $adm_username $adm_pw
  email_subj="ClientDNS-${clientdns_stack_name} Setup Info"
  email_body=""
  email_body=${email_body}"ClientDNS-${clientdns_stack_name} Setup Info\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"DNS IP Address: ${wg_ip}\n"
  email_body=${email_body}"DNSMasq URL: https://${SUB_CLIENTDNS}-${clientdns_stack_name}.${HOMESERVER_DOMAIN}\n"
  email_body=${email_body}"Admin Username: ${adm_username}\n"
  email_body=${email_body}"Admin Password: ${adm_pw}\n\n"
  sendEmail -s "$email_subj" -b "$email_body"
}

function showMyNetworkRemoveClientDNSMenu()
{
  vpnremovemenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to remove:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='clientdns' and NetworkType='mynetwork';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpnremovemenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  is_remove=$(promptUserInputMenu "" "Confirm Removal" "This will remove all selected network connections. To confirm, enter the word 'remove' below:")
  if [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    cdns_stack_name=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$curvpnID;")
    performMyNetworkRemoveClientDNS "$curvpnID" "$cdns_stack_name" true true
  done
}

function performMyNetworkRemoveClientDNS()
{
  dbID="$1"
  cdns_stack_name="$2"
  is_remove_network_conn="$3"
  is_manage_heimdall="$4"
  removeCaddySnippetImport home sn-sub-${cdns_stack_name}
  removeCaddySnippetImport primary sn-sub-${cdns_stack_name}
  removeCaddySnippet "# sn-sub-${cdns_stack_name} BEGIN" "# sn-sub-${cdns_stack_name} END"
  removeServiceFromConfig "${cdns_stack_name}"
  checkDeleteStackAndDirectory $cdns_stack_name "$cdns_stack_name" true true
  dock_net_name_suffix=$(echo "$cdns_stack_name" | cut -d"-" -f2-)
  docker network rm cdns-$dock_net_name_suffix > /dev/null 2>&1
  deleteSvcHeimdall admin "https://${cdns_stack_name}.$HOMESERVER_DOMAIN" "$is_manage_heimdall"
  if [ "$is_remove_network_conn" = "true" ]; then
    removeMyNetworkNonHomeServerConnection $dbID true
  else
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where ID=$dbID;"
  fi
}

function showOtherNetworkDisconnectVPNMenu()
{
  vpndisconnectmenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to disconnect:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='homeserver_vpn' and NetworkType='other';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpndisconnectmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  disconnect_reason=$(promptUserInputMenu "" "Disconnect Reason" "Enter a reason for disconnecting: ")
  is_remove=$(promptUserInputMenu "" "Confirm Disconnect" "This will disconnect all selected network connections. To confirm, enter the word 'disconnect' below:")
  if [ $? -ne 0 ] || [ -z "$is_remove" ] || ! [ "$is_remove" = "disconnect" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  
  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    disconnectOtherNetworkHomeServerVPNConnection $curvpnID "$disconnect_reason"
  done
}

function showOtherNetworkDisconnectInternetMenu()
{
  vpndisconnectmenu=$(cat << EOF

$(getLogo)
Select the network connections that you wish to disconnect:

EOF
  )
  vpn_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='homeserver_internet' and NetworkType='other';"))
  if [ -z "$vpn_arr" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curvpn in "${vpn_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curvpn | sed 's/|/)/1')) | OFF "
  done
  sel_vpn=($(whiptail --title "Select Network Connections" --checklist "$vpndisconnectmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  disconnect_reason=$(promptUserInputMenu "" "Disconnect Reason" "Enter a reason for disconnecting: ")
  is_remove=$(promptUserInputMenu "" "Confirm Disconnect" "This will disconnect all selected network connections. To confirm, enter the word 'disconnect' below:")
  if [ $? -ne 0 ] || [ -z "$is_remove" ] || ! [ "$is_remove" = "disconnect" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  for curvpn in "${sel_vpn[@]}"
  do
    curvpnID=$(echo $curvpn | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
    disconnectOtherNetworkHomeServerInternetConnection "$curvpnID" "$disconnect_reason"
  done
}

# VPN Apply functions
function applyHomeServerPrimaryVPNConfig()
{
  is_primary=$1
  set +e
  le_cert_domains=unset
  while [ "$le_cert_domains" = "unset" ]
  do
    le_cert_domains=$(promptUserInputMenu "$(getLetsEncryptCertsDefault)" "Enter LE Cert Subdomains" "Enter the subdomains for which the certificates will be managed by LetsEncrypt (comma-separated):")
    if [ $? -ne 0 ]; then
      return 1
    fi
	if [ $(checkValidString "$le_cert_domains" ",.-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The domain list contains invalid character(s). It must consist of a-z (lowercase), 0-9, -, and/or ."
      le_cert_domains=unset
    fi
  done
  createOtherNetworkApplyHomeServerVPNConfig true "$le_cert_domains"
}

function createOtherNetworkApplyHomeServerVPNConfig()
{
  is_primary=$1
  le_cert_domains="$2"
  recipient_email=$(promptUserInputMenu "" "Enter Recipient" "Enter the administrator email address of the network to which you are applying:")
  if [ $? -ne 0 ]; then
    return 1
  fi
  sendOtherNetworkApplyHomeServerVPNConfig "$recipient_email" "$is_primary" "$le_cert_domains"
  if [ "$IS_INSTALLED" = "true" ]; then
    showMessageBox "Check Email" "Check your email ($EMAIL_ADMIN_EMAIL_ADDRESS) for the configuration application. You will need to forward the application to the manager of the network to which you are applying."
  fi
}

function sendOtherNetworkApplyHomeServerVPNConfig()
{
  recipient_email="$1"
  is_primary="$2"
  le_cert_domains="$3"
  set +e
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] && ! [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ] && ! [ "$is_primary" = "true" ]; then
    echo "ERROR: Cannot host on another network without a primary VPN connection."
    return 1
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] && [ "$is_primary" = "true" ]; then
    echo "ERROR: You are already hosting a VPN. You must remove this first."
    return 1
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ] && [ "$is_primary" = "true" ]; then
    echo "ERROR: You already have a primary connection. You must disconnect from your primary network first."
    return 1
  fi
  request_id=$(getRandomRequestID)
  priv_key=$(wg genkey)
  pub_key=$(echo $priv_key | wg pubkey)
  echo "RequestID = $request_id" > $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "PrivateKey = $priv_key" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "ConnectionType = HomeServer VPN" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "IsPrimary = $is_primary" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  chmod 0400 $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  domain_name=$HOMESERVER_DOMAIN
  msg_body="$APPLICATION_FIRST_LINE\n"
  msg_body=$msg_body"RequestID = $request_id\n"
  msg_body=$msg_body"ConnectionType = HomeServer VPN\n"
  msg_body=$msg_body"EmailAddress = $EMAIL_ADMIN_EMAIL_ADDRESS\n"
  msg_body=$msg_body"PublicKey = $pub_key\n"
  msg_body=$msg_body"PresharedKey = \n"
  msg_body=$msg_body"DomainName = $domain_name\n"
  msg_body=$msg_body"HomeServerName = $HOMESERVER_NAME\n"
  msg_body=$msg_body"ExternalPrefix = $EXT_DOMAIN_PREFIX\n"
  if [ "$is_primary" = "true" ]; then
    RELAYSERVER_LE_CERT_DOMAINS="$le_cert_domains"
    updateConfigVar RELAYSERVER_LE_CERT_DOMAINS $RELAYSERVER_LE_CERT_DOMAINS
    leCertsArr=($(echo $RELAYSERVER_LE_CERT_DOMAINS | tr "," "\n"))
    isReload=false
    for leCert in "${leCertsArr[@]}"
    do
      curBaseDomain=$(getBaseDomain $leCert)
      curSubDomain=$(getSubDomain $leCert)
      if [ "$curBaseDomain" = "$HOMESERVER_DOMAIN" ]; then
        for curSVC in "${SVCS_ARR[@]}"
        do
          var_base=$(echo $curSVC | cut -d"=" -f1 | cut -d"_" -f 2-)
          subdom=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f6)
          subdom="${subdom//\"}"
          if [ "$subdom" = "$curSubDomain" ]; then
            var_name="SVCD_"$var_base
            var_value=$(getConfigVar $var_name)
            var_valueArr=($(echo $var_value | tr "," "\n"))
            var_valueArr[6]=le
            printf -v new_value '%s,' "${var_valueArr[@]}"
            new_value="$(echo "${new_value%,}")"
            updateConfigVar $var_name $new_value
            isReload=true
          fi
        done
      fi
    done
    if [ "$isReload" = "true" ]; then
      loadSvcVars
    fi
    msg_body=$msg_body"IsPrimary = true\n"
    msg_body=$msg_body"MailSubdomain = $SUB_POSTFIX.$HOMESERVER_DOMAIN\n"
    msg_body=$msg_body"LetsEncryptDomains = $RELAYSERVER_LE_CERT_DOMAINS\n"
  else
    msg_body=$msg_body"IsPrimary = false\n"
  fi
  msg_body=$msg_body"$APPLICATION_LAST_LINE\n"
  set -e
  if ! [ "$IS_INSTALLED" = "true" ]; then
    clear
    echo -e "\n"
    echo -e "$msg_body"
    echo -e "\n"
    echo -e "Copy the above section and submit it to your RelayServer administrator."
  else
    msg_header="HomeServer VPN Application from $HOMESERVER_NAME ($request_id)\n\n"
    msg_header=${msg_header}"For the receiving manager: \n"
    msg_header=${msg_header}"1) Go to the Script-server app, and navigate to 06 My Network > 01 Invite to Network.\n"
    msg_header=${msg_header}"2) Copy everything BELOW the following line and paste the contents where appropriate.\n\n"
    msg_header=${msg_header}"_______________________________________________________________________\n\n"
    msg_body=${msg_header}"$msg_body"
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
      sendEmail -s "HomeServer VPN Application from $HOMESERVER_NAME ($request_id)" -b "$msg_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$recipient_email"
      echo "Application successfully sent!"
    else
      echo "You do not have a primary network, you will only receive a manager (MGR) copy of the application. Ensure to transfer this to the manager of the network to which you are applying."
    fi
    sendEmail -s "(MGR COPY)HomeServer VPN Application from $HOMESERVER_NAME ($request_id)" -b "$msg_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  fi
}

function createOtherNetworkApplyHomeServerInternetConfig()
{
  recipient_email=$(promptUserInputMenu "" "Enter Recipient" "Enter the administrator email address of the network to which you are applying:")
  if [ $? -ne 0 ]; then
    return
  fi
  sendOtherNetworkApplyHomeServerInternetConfig "$recipient_email"
}

function sendOtherNetworkApplyHomeServerInternetConfig()
{
  recipient_email="$1"
  request_id=$(getRandomRequestID)
  priv_key=$(wg genkey)
  pub_key=$(echo $priv_key | wg pubkey)
  echo "RequestID = $request_id" > $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "PrivateKey = $priv_key" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "ConnectionType = HomeServer Internet" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  echo "IsPrimary = false" >> $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  chmod 0400 $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
  msg_body=""
  msg_body=$msg_body"$APPLICATION_FIRST_LINE\n"
  msg_body=$msg_body"RequestID = $request_id\n"
  msg_body=$msg_body"ConnectionType = HomeServer Internet\n"
  msg_body=$msg_body"EmailAddress = $EMAIL_ADMIN_EMAIL_ADDRESS\n"
  msg_body=$msg_body"PublicKey = $pub_key\n"
  msg_body=$msg_body"DomainName = $HOMESERVER_DOMAIN\n"
  msg_body=$msg_body"IsInternet = true\n"
  msg_body=$msg_body"$APPLICATION_LAST_LINE\n"
  msg_header="Copy everything BELOW the following line:\n\n"
  msg_header=$msg_header"_______________________________________________________________________\n\n"
  msg_body=${msg_header}"$msg_body"
  sendEmail -s "HomeServer Internet Application from $HOMESERVER_NAME ($request_id)" -b "$msg_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$recipient_email"
  echo "Application successfully sent!"
}

function createOtherNetworkApplyUserConfig()
{
  email_address=$(promptUserInputMenu "$EMAIL_ADMIN_EMAIL_ADDRESS" "Enter Email Address" "Enter the email address that you wish to associate with this request: ")
  if [ $? -ne 0 ]; then
    return
  fi
  showYesNoMessageBox "Internet Access" "Request public internet IP masquerade for this connection?"
  if [ $? -eq 0 ]; then
    isInternetAccess=true
  else
    isInternetAccess=false
  fi
  ip_address=$(promptUserInputMenu "" "Enter IP Address" "Enter your client device IP address. Leave blank if you do not have one and want it generated for you: ")
  if [ $? -ne 0 ]; then
    return
  fi
  if ! [ -z "$ip_address" ]; then
    if [ "$(checkValidIPAddress $ip_address)" = "false" ] || [ "$(isIPInSubnet $ip_address 10.0.0.0/8)" = "false" ]; then
      showMessageBox "Invalid IP" "Invalid IP address, returning..."
      return
    fi
    ip_address=$(echo $ip_address | cut -d "/" -f1)
    pub_key=$(promptUserInputMenu "" "Enter Public Key" "Enter your client device public key: ")
    if [ $? -ne 0 ]; then
      return
    fi
    if [ -z "$pub_key" ]; then
      showMessageBox "Invalid Public Key" "Invalid Public Key, returning..."
      return
    fi
  fi
  recipient_email=$(promptUserInputMenu "" "Enter Recipient" "Enter the administrator email address of the network to which you are applying:")
  if [ $? -ne 0 ]; then
    return
  fi
  description=$(promptUserInputMenu "" "Enter Description" "Enter a description of what this connection will be used for:")
  if [ $? -ne 0 ]; then
    return
  fi
  sendOtherNetworkApplyUserConfig "$recipient_email" "$email_address" "$isInternetAccess" "$ip_address" "$pub_key" "$description"
}

function sendOtherNetworkApplyUserConfig()
{
  recipient_email="$1"
  email_address="$2"
  is_internet="$3"
  ip_address="$4"
  pub_key="$5"
  description="$6"

  request_id=$(getRandomRequestID)
  if [ -z "$pub_key" ] && ! [ -z "$ip_address" ]; then
    echo "ERROR: IP address provided without public key."
    return 2
  fi
  if [ -z "$ip_address" ]; then
    ip_address="New"
  fi
  if [ -z "$pub_key" ]; then
    priv_key=$(wg genkey)
    pub_key=$(echo $priv_key | wg pubkey)
    sendEmail -s "Private Key ($request_id)" -b "DO NOT SEND THIS TO ANYONE!!!\n\nKeep it secret, keep it safe.\n\nRequestID: $request_id\nDescription: $description\nPrivate Key: $priv_key\n" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t $email_address
  elif [ "$(checkValidWireGuardKey $client_public_key)" = "false" ]; then
    echo "ERROR: Invalid public key."
    return 2
  elif ! [ -z "$(getWGNameFromPubkey $pub_key)" ]; then
    echo "ERROR: Duplicate public key."
    return 2
  fi
  msg_body=""
  msg_body=$msg_body"$APPLICATION_FIRST_LINE\n"
  msg_body=$msg_body"RequestID = $request_id\n"
  msg_body=$msg_body"ConnectionType = User\n"
  msg_body=$msg_body"EmailAddress = $email_address\n"
  msg_body=$msg_body"PublicKey = $pub_key\n"
  msg_body=$msg_body"IsInternet = $is_internet\n"
  msg_body=$msg_body"IPAddress = $ip_address\n"
  msg_body=$msg_body"$APPLICATION_LAST_LINE\n"
  msg_header=""
  msg_header=$msg_header"Description: $description\n\n"
  msg_header=$msg_header"Copy everything BELOW the following line:\n"
  msg_header=$msg_header"_______________________________________________________________________\n\n"
  msg_body=${msg_header}"$msg_body"
  sendEmail -s "User Application from $HOMESERVER_NAME ($request_id)" -b "$msg_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$recipient_email"
}

# VPN Invite functions
function getValueFromConfig()
{
  get_val="$1"
  apply_file="$2"
  retVal=$(grep "^$get_val = " $apply_file)
  if [ $? -eq 0 ]; then
    echo "$(echo $retVal | sed 's/^[^=]*=//' | sed 's/ *$//g' | sed 's/^[ \t]*//;s/[ \t]*$//')"
  fi
}

function createMyNetworkInvite()
{
  set +e
  config_name=$(promptUserInputMenu "" "Enter Config Name" "Enter a name for this configuration: ")
  if [ $? -ne 0 ]; then
    return
  fi
  apply_file=$HOME/apply_hsv.cnf
  showMessageBox "Paste Configuration" "In this next step, you will need to paste the application that you received via email. After pasting the contents, press CTRL-o to save, then Enter to confirm, then CTRL-x to exit. Please remember these key combinations. Press OK to proceed."
  nano $apply_file
  if ! [ -f $apply_file ]; then
    showMessageBox "Empty Config File" "The application is empty, returning..."
    return
  fi
  performNetworkInvite "$apply_file" "$config_name"
  rm -f $apply_file
  if [ $? -ne 0 ]; then
    showMessageBox "Config File Error" "There was an error with the config file, returning..."
    return
  fi
}

function createMyNetworkUserInvite()
{
  email_address="$1"
  is_internet="$2"
  ip_address="$3"
  pub_key="$4"
  pre_key="$5"
  apply_file="$6"
  priv_key=""
  request_id=$(getRandomRequestID)
  if [ -z "$pub_key" ] && ! [ -z "$ip_address" ]; then
    echo "ERROR: IP address provided without public key."
    return 1
  fi
  if [ -z "$ip_address" ]; then
    ip_address="New"
  fi
  if [ -z "$pub_key" ]; then
    priv_key=$(wg genkey)
    pub_key=$(echo $priv_key | wg pubkey)
  fi
  msg_body=""
  msg_body=$msg_body"$APPLICATION_FIRST_LINE\n"
  msg_body=$msg_body"RequestID = $request_id\n"
  msg_body=$msg_body"ConnectionType = User\n"
  msg_body=$msg_body"EmailAddress = $email_address\n"
  if ! [ -z "$priv_key" ]; then
    msg_body=$msg_body"PrivateKey = $priv_key\n"
  fi
  msg_body=$msg_body"PresharedKey = $pre_key\n"
  msg_body=$msg_body"PublicKey = $pub_key\n"
  msg_body=$msg_body"IsInternet = $is_internet\n"
  msg_body=$msg_body"IPAddress = $ip_address\n"
  msg_body=$msg_body"$APPLICATION_LAST_LINE\n"
  echo -e "$msg_body" > $apply_file
}

function performNetworkInvite()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  apply_file="$1"
  config_name="$2"
  # First check if there are any shell expansions in the file.
  # If there is, throw up a big red flag.
  check_file=$(checkFileShellExpansion $apply_file)
  if ! [ -z "$check_file" ]; then
    echo -e "$check_file"
    return 2
  fi
  # Do basic checks
  removeSpecialChars "$apply_file"
  first_line="$(awk 'NF{print;exit}' $apply_file)"
  last_line="$(awk 'NF{s=$0}END{print s}' $apply_file)"
  if ! [ "$first_line" = "$APPLICATION_FIRST_LINE" ] || ! [ "$last_line" = "$APPLICATION_LAST_LINE" ]; then
    echo "ERROR: Incomplete application."
    echo "first_line: $first_line"
    echo "last_line: $last_line"
    return 7
  fi
  request_id=$(getValueFromConfig "RequestID" $apply_file)
  if [ -z "$request_id" ]; then
    echo "ERROR: Invalid request ID."
    return 7
  fi
  conn_type=$(getValueFromConfig "ConnectionType" $apply_file)
  email_address=$(getValueFromConfig "EmailAddress" $apply_file)
  if [ "$(checkValidEmail $email_address)" = "false" ]; then
    echo "ERROR: Invalid email address."
    return 7
  fi
  pub_key=$(getValueFromConfig "PublicKey" $apply_file)
  if [ -z "$pub_key" ] || [ "$(checkValidWireGuardKey $pub_key)" = "false" ]; then
    echo "ERROR: Invalid public key."
    return 7
  fi
  if ! [ -z "$(getWGNameFromPubkey $pub_key)" ]; then
    echo "ERROR: Duplicate public key."
    return 7
  fi
  preshared_key=$(getValueFromConfig "PresharedKey" $apply_file)
  if ! [ -z "$preshared_key" ] && [ "$(checkValidWireGuardKey $preshared_key)" = "false" ]; then
    echo "ERROR: Invalid preshared key."
    return 7
  fi

  case "$conn_type" in
    "HomeServer VPN")
      domain_name=$(getValueFromConfig "DomainName" $apply_file)
      if [ -z "$domain_name" ] || [ $(checkValidBaseDomain "$domain_name") = "false" ]; then
        echo "ERROR: Invalid domain name."
        return 7
      fi
      cur_hs_name=$(getValueFromConfig "HomeServerName" $apply_file)
      if [ -z "$cur_hs_name" ]; then
        echo "ERROR: Invalid HomeServer name."
        return 7
      fi
      external_prefix=$(getValueFromConfig "ExternalPrefix" $apply_file)
      if [ -z "$external_prefix" ] || [ $(checkValidString "$external_prefix" "-") = "false" ]; then
        echo "ERROR: Invalid external prefix."
        return 7
      fi
      is_primary=$(getValueFromConfig "IsPrimary" $apply_file)
      if [ -z "$is_primary" ] || ! ( [ "$is_primary" = "true" ] || [ "$is_primary" = "false" ] ); then
        echo "ERROR: Invalid primary VPN selection."
        return 7
      fi
      if [ "$is_primary" = "true" ]; then
        mail_subdomain=$(getValueFromConfig "MailSubdomain" $apply_file)
        if [ -z "$mail_subdomain" ] || [ $(checkValidString "$mail_subdomain" ".-") = "false" ]; then
          echo "ERROR: Invalid mail subdomain."
          return 7
        fi
        le_domains=$(getValueFromConfig "LetsEncryptDomains" $apply_file)
        if [ -z "$le_domains" ] || [ $(checkValidString "$external_prefix" ",.-") = "false" ]; then
          echo "ERROR: Invalid LetsEncrypt subdomains."
          return 7
        fi
      fi
    ;;
    "HomeServer Internet")
      domain_name=$(getValueFromConfig "DomainName" $apply_file)
      if [ -z "$domain_name" ] || [ $(checkValidBaseDomain "$domain_name") = "false" ]; then
        echo "ERROR: Invalid domain name."
        return 7
      fi
      is_internet=$(getValueFromConfig "IsInternet" $apply_file)
      if [ -z "$is_internet" ] || ! ( [ "$is_internet" = "true" ] || [ "$is_internet" = "false" ] ); then
        echo "ERROR: Invalid IsInternet selection."
        return 7
      fi
    ;;
    "User")
      if [ -z "$config_name" ] || [ $(checkValidStringUpperLowerNumbers "$config_name" "-") = "false" ]; then
        echo "ERROR: Invalid config name."
        return 7
      fi
      is_internet=$(getValueFromConfig "IsInternet" $apply_file)
      if [ -z "$is_internet" ] || ! ( [ "$is_internet" = "true" ] || [ "$is_internet" = "false" ] ); then
        echo "ERROR: Invalid IsInternet selection."
        return 7
      fi
      ip_address=$(getValueFromConfig "IPAddress" $apply_file)
      if [ -z "$pub_key" ] && ! [ "$ip_address" = "New" ]; then
        echo "ERROR: IP address provided without public key."
        return 7
      fi
      if [ "$ip_address" = "New" ]; then
        ip_address=$(getRandomWireGuardIP)
        is_ip_provided=false
      else
        is_ip_provided=true
      fi
      if [ -z "$ip_address" ] || [ "$(checkValidIPAddress $ip_address)" = "false" ] || [ "$(isIPInSubnet $ip_address 10.0.0.0/8)" = "false" ]; then
        echo "ERROR: Invalid IP address."
        return 7
      fi
    ;;
    *)
      echo "ERROR: Connection type not found."
      return 7
    ;;
  esac

  # Do logical checks
  case "$conn_type" in
    "HomeServer VPN")
      if [ "$domain_name" = "$HOMESERVER_DOMAIN" ]; then
        echo "ERROR: This is your domain, dummy!"
        return 7
      fi
      config_name="HS-VPN-$domain_name"
      checkname_db=$(sqlite3 $HSHQ_DB "select Name from connections where Name='$config_name';")
      if ! [ -z "$checkname_db" ]; then
        echo "ERROR: There is already a connection with this name."
        return 7
      fi
      check_dom=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections join connections on hsvpn_connections.ID = connections.ID where hsvpn_connections.DomainName='$domain_name' and connections.NetworkType='mynetwork';")
      if ! [ -z "$check_dom" ]; then
        echo "ERROR: There is already a connection with this domain ($domain_name)."
        return 7
      fi
      if ! [ "$(isEmailMatchBaseDomain $email_address $domain_name)" = "true" ]; then
        echo "ERROR: Requesting email is not from the same base domain. Email: $email_address, Domain: $domain_name"
        return 7
      fi
      new_ip=$(getRandomVPNIP)
      if [ -z "$new_ip" ]; then
        echo "ERROR: The VPN network is full."
        return 7
      fi
      isPrimary=0
      if [ "$is_primary" = "true" ]; then
        isPrimary=1
      fi
    ;;
    "HomeServer Internet")
      if [ "$domain_name" = "$HOMESERVER_DOMAIN" ]; then
        echo "ERROR: This is your domain, dummy!"
        return 7
      fi
      if ! [ "$(isEmailMatchBaseDomain $email_address $domain_name)" = "true" ]; then
        echo "ERROR: Requesting email is not from the same base domain. Email: $email_address, Domain: $domain_name"
        return 7
      fi
      config_name="HS-Internet-$domain_name"
      checkname_db=$(sqlite3 $HSHQ_DB "select Name from connections where Name='$config_name';")
      if ! [ -z "$checkname_db" ]; then
        echo "ERROR: There is already a connection with this name."
        return 7
      fi
    ;;
    "User")
      is_db=$(getWGNameFromIP $ip_address)
      if ! [ -z "$is_db" ]; then
        echo "ERROR: This IP address is already being used (Connection Name: $is_db)."
        return 7
      fi
      is_in_subnet=$(isIPInSubnet $ip_address $PRIMARY_VPN_SUBNET)
      if [ "$is_in_subnet" = "true" ]; then
        echo "ERROR: This IP address is inside of your VPN range designated for hosting HomeServers."
        return 7
      fi
    ;;
  esac

  # Perform invitation steps
  tmp_preshared_key=$(wg genpsk)
  if [ -z "$preshared_key" ]; then
    preshared_key="$tmp_preshared_key"
  fi
  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  curdt=$(getCurrentDate)
  case "$conn_type" in
    "HomeServer VPN")
      echo "Adding to RelayServer..."
      ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"HS-$domain_name\" \"$email_address\" \"$pub_key\" \"$preshared_key\" \"$new_ip\" \"false\" \"true\" \"$wgPortalAuth\""
      mbres=$?
      if [ $mbres -ne 0 ]; then
        echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer."
        unloadSSHKey
        return 7
      fi
      db_id=$(sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('$config_name','$email_address','homeserver_vpn','mynetwork','$pub_key','$preshared_key','$new_ip',false,'','$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN','$curdt');select last_insert_rowid();")
      mail_host_id=NULL
      if [ "$is_primary" = "true" ]; then
        mail_host_id=$(sudo sqlite3 $HSHQ_DB "insert into mailhosts(MailHost) values('$mail_subdomain');select last_insert_rowid();")
      fi
      sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into hsvpn_connections(ID,HomeServerName,IsPrimary,DomainName,ExternalPrefix,MailHostID) values($db_id,'$cur_hs_name','$isPrimary','$domain_name','$external_prefix',$mail_host_id);"
      echo "Adding DNS entries to AdguardHome..."
      addDomainAndWildcardAdguardHS "$domain_name" "$new_ip"
      addDomainAndWildcardAdguardRS "$domain_name" "$new_ip"
      addDomainAdguardHS "*.$external_prefix.$domain_name" "A"
      addDomainAdguardRS "*.$external_prefix.$domain_name" "A"
      addDomainAndWildcardIgnoreQuerylogAndStatsHS "$domain_name"
      sudo sqlite3 $HSHQ_DB "update hsvpn_dns set IsActive=0 where PeerDomain='$domain_name';"
      sudo sqlite3 $HSHQ_DB "insert into hsvpn_dns(HostDomain,PeerDomain,PeerDomainExtPrefix,IPAddress,DateAdded,IsActive) values('$HOMESERVER_DOMAIN','$domain_name','$external_prefix','$new_ip','$curdt',1);"
      if [ "$is_primary" = "true" ]; then
        echo "Adding mail domain to RelayServer..."
        sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into mailhostmap(MailHostID,Domain,IsFirstDomain) values ($mail_host_id,'$domain_name',true);"
        mail_relay_password=$(pwgen -c -n 32 1)
        ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "docker exec mail-relay-postfix /etc/postfix/scripts/addMailUser.sh $domain_name $mail_relay_password"
        ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addRelayedDomains.sh $domain_name $mail_subdomain $new_ip"
        if ! [ -z "$le_domains" ]; then
          echo "Primary Adding LECertDomains: $le_domains"
          addLECertPathsToRelayServer "$le_domains" "$domain_name"
        fi
      fi
    ;;
    "HomeServer Internet")
      new_ip=$(getRandomWireGuardIP)
      if [ -z "$new_ip" ]; then
        echo "ERROR: The HomeServer Internet network is full."
        unloadSSHKey
        return 7
      fi
      ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"$config_name\" \"$email_address\" \"$pub_key\" \"$preshared_key\" \"$new_ip\" \"true\" \"false\" \"$wgPortalAuth\""
      mbres=$?
      if [ $mbres -ne 0 ]; then
        echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer."
        unloadSSHKey
        return 7
      fi
      sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,LastUpdated) values('$config_name','$email_address','homeserver_internet','mynetwork','$pub_key','$preshared_key','$new_ip',true,'$curdt');"
    ;;
    "User")
      ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"$config_name\" \"$email_address\" \"$pub_key\" \"$preshared_key\" \"$ip_address\" \"$is_internet\" \"false\" \"$wgPortalAuth\""
      mbres=$?
      if [ $mbres -ne 0 ]; then
        echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer."
        unloadSSHKey
        return 7
      fi
      isInternet=false
      if [ "$is_internet" = "true" ]; then
        isInternet=true
      fi
      sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,LastUpdated) values('$config_name','$email_address','user','mynetwork','$pub_key','$preshared_key','$ip_address',$isInternet,'$curdt');"
      priv_key=$(getValueFromConfig "PrivateKey" $apply_file)
    ;;
  esac
  unloadSSHKey
  echo "Emailing the invitation..."
  # Finally, email the invitation.
  case "$conn_type" in
    "HomeServer VPN")
      mail_subj="HomeServer VPN Invitation from $HOMESERVER_NAME, RequestID: $request_id"
      mail_body=""
      mail_body=${mail_body}"HomeServer VPN Invitation from $HOMESERVER_NAME\n"
      mail_body=${mail_body}"================================================================\n\n"
      if [ "$is_primary" = "true" ]; then
        mail_body=${mail_body}"$(getDNSRecordsInfo $domain_name)\n\n"
      fi
      mail_body=$mail_body"1) Go to the Script-server app, and navigate to 07 Other Networks > 05 Join Network.\n"
      mail_body=$mail_body"2) Copy everything BELOW the following line and paste the contents where appropriate.\n"
      mail_body=$mail_body"_______________________________________________________________________\n"
      mail_body=$mail_body"\n$INVITATION_FIRST_LINE\n"
      mail_body=$mail_body"\n###################### Base Config Begin #######################\n\n"
      mail_body=$mail_body"RequestID = $request_id\n"
      mail_body=$mail_body"ConnectionType = $conn_type\n"
      mail_body=$mail_body"InterfaceName = $RELAYSERVER_WG_VPN_NETNAME\n"
      mail_body=$mail_body"EmailAddress = $EMAIL_ADMIN_EMAIL_ADDRESS\n"
      mail_body=$mail_body"DomainName = $HOMESERVER_DOMAIN\n"
      mail_body=$mail_body"EndpointHostname = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN\n"
      mail_body=$mail_body"EndpointPort = $RELAYSERVER_WG_PORT\n"
      mail_body=$mail_body"ClientIP = $new_ip\n"
      mail_body=$mail_body"ClientPublicKey = $pub_key\n"
      mail_body=$mail_body"PresharedKey = $tmp_preshared_key\n"
      mail_body=$mail_body"HomeServerName = $HOMESERVER_NAME\n"
      mail_body=$mail_body"ExternalPrefix = $EXT_DOMAIN_PREFIX\n"
      mail_body=$mail_body"InternalPrefix = $INT_DOMAIN_PREFIX\n"
      mail_body=$mail_body"CertificateAuthorityAbbrev = $HOMESERVER_ABBREV\n"
      mail_body=$mail_body"CertificateAuthorityIP = $RELAYSERVER_WG_HS_IP\n"
      mail_body=$mail_body"CertificateAuthoritySubdomain = $SUB_CADDY.$HOMESERVER_DOMAIN\n"
      mail_body=$mail_body"CertificateAuthorityURL = https://$SUB_CADDY.$HOMESERVER_DOMAIN/acme/$HOMESERVER_ABBREV/directory\n"
      mail_body=$mail_body"VPNSubnet = $PRIMARY_VPN_SUBNET\n"
      mail_body=$mail_body"RelayServerExternalIP = $RELAYSERVER_SERVER_IP\n"
      mail_body=$mail_body"RelayServerVPNIP = $RELAYSERVER_WG_SV_IP\n"
      mail_body=$mail_body"IsPrimary = $is_primary\n"
      if [ "$is_primary" = "true" ]; then
        mail_body=$mail_body"SMTPRelayHost = $SMTP_RELAY_HOST\n"
        mail_body=$mail_body"SMTPRelayUsername = $domain_name\n"
        mail_body=$mail_body"SMTPRelayPassword = $mail_relay_password\n"
        mail_body=$mail_body"RelayServerExtEmailHostname = $RELAYSERVER_EXT_EMAIL_HOSTNAME\n"
      fi
      mail_body=$mail_body"\n####################### Base Config End ########################\n"
      mail_body=$mail_body"\n#################### WireGuard Config Begin ####################\n\n"
      mail_body=$mail_body"[Interface]\n"
      mail_body=$mail_body"PrivateKey =\n"
      mail_body=$mail_body"Address = $new_ip/32\n"
      mail_body=$mail_body"MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU\n\n"
      mail_body=$mail_body"[Peer]\n"
      mail_body=$mail_body"PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY\n"
      mail_body=$mail_body"PresharedKey = $tmp_preshared_key\n"
      mail_body=$mail_body"AllowedIPs = $PRIMARY_VPN_SUBNET\n"
      mail_body=$mail_body"Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT\n"
      mail_body=$mail_body"PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE\n"
      mail_body=$mail_body"\n##################### WireGuard Config End #####################\n"
      mail_body=$mail_body"\n#################### HomeServers DNS Begin #####################\n\n"
      mail_body=$mail_body"$(getMyNetworkHomeServerDNSList)"
      mail_body=$mail_body"\n##################### HomeServers DNS End ######################\n"
      mail_body=$mail_body"\n######################### Root CA Begin #########################\n\n"
      mail_body=$mail_body"""$(cat $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt)"""
      mail_body=$mail_body"\n\n########################## Root CA End ##########################\n"
      if [ "$is_primary" = "true" ]; then
        generateCert $mail_subdomain "$SMTP_HOSTNAME,$mail_subdomain"
        mail_body=$mail_body"\n######################## mail.crt Begin ########################\n\n"
        mail_body=$mail_body"""$(cat $HSHQ_SSL_DIR/${mail_subdomain}.crt)"""
        mail_body=$mail_body"\n\n######################### mail.crt End #########################\n"
        mail_body=$mail_body"\n######################## mail.key Begin ########################\n\n"
        mail_body=$mail_body"""$(cat $HSHQ_SSL_DIR/${mail_subdomain}.key)"""
        mail_body=$mail_body"\n\n######################### mail.key End #########################\n"
        rm -f $RELAYSERVER_SSH_PORT $HSHQ_SSL_DIR/$mail_subdomain*
      fi
      mail_body=$mail_body"\n$INVITATION_LAST_LINE\n\n"
      if [ "$is_primary" = "true" ]; then
        echo -e "\n\n\n########################################"
        echo -e "  This is a primary VPN request."
        echo -e "  No email will be sent to $email_address."
        echo -e "  You will have to transfer your MGR copy"
        echo -e "  to them through alternative means."
        echo -e "########################################\n"
        outputDNSZoneFile $domain_name /tmp/${DNS_ZONE_FILENAME_BASE}_${domain_name}.txt
        # Send ourself a copy
        sendEmail -s "(MGR COPY)$mail_subj" -b "$mail_body" -a /tmp/${DNS_ZONE_FILENAME_BASE}_${domain_name}.txt
      else
        sendEmail -s "$mail_subj" -b "$mail_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$email_address"
        # Send ourself a copy
        sendEmail -s "(MGR COPY)$mail_subj" -b "$mail_body"
      fi
      insertEnableSvcUptimeKuma uptimekuma "${cur_hs_name}" homeservers "https://$SUB_HSHQSTATUS.$domain_name" true
      insertEnableSvcHeimdall heimdall "$cur_hs_name" homeservers "https://$SUB_HSHQHOME.$domain_name" "hs2.png" true "$(getHeimdallOrderFromSub $SUB_HSHQHOME homeservers)"
      # Send update email to other HomeServers on our network
      notifyMyNetworkHomeServersDNSUpdate add "$cur_hs_name" "$domain_name"
      # Send update email to other users on our network
      notifyMyNetworkUsersDNSUpdate add "$cur_hs_name" "$domain_name" "$external_prefix" "$new_ip"
      rm -f /tmp/${DNS_ZONE_FILENAME_BASE}_${domain_name}.txt
    ;;
    "HomeServer Internet")
      mail_subj="HomeServer Internet Invitation from $HOMESERVER_NAME, RequestID: $request_id"
      mail_body=""
      mail_body=${mail_body}"HomeServer Internet Invitation from $HOMESERVER_NAME\n"
      mail_body=${mail_body}"================================================================\n\n"
      mail_body=$mail_body"1) Copy everything BELOW the following line.\n"
      mail_body=$mail_body"2) Go to the Script-server app, and navigate to 07 Other Networks > 05 Join Network.\n"
      mail_body=$mail_body"3) Paste the contents where appropriate. \n"
      mail_body=$mail_body"_______________________________________________________________________\n\n"
      mail_body=$mail_body"\n$INVITATION_FIRST_LINE\n"
      mail_body=$mail_body"\n###################### Base Config Begin #######################\n\n"
      mail_body=$mail_body"RequestID = $request_id\n"
      mail_body=$mail_body"ConnectionType = $conn_type\n"
      mail_body=$mail_body"InterfaceName = $RELAYSERVER_WG_INTERNET_NETNAME\n"
      mail_body=$mail_body"EmailAddress = $EMAIL_ADMIN_EMAIL_ADDRESS\n"
      mail_body=$mail_body"DomainName = $HOMESERVER_DOMAIN\n"
      mail_body=$mail_body"EndpointHostname = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN\n"
      mail_body=$mail_body"EndpointPort = $RELAYSERVER_WG_PORT\n"
      mail_body=$mail_body"ClientIP = $new_ip\n"
      mail_body=$mail_body"ClientPublicKey = $pub_key\n"
      mail_body=$mail_body"EndpointPublicKey = $RELAYSERVER_WG_SV_PUBLICKEY\n"
      mail_body=$mail_body"PresharedKey = $tmp_preshared_key\n"
      mail_body=$mail_body"MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU\n"
      mail_body=$mail_body"\n####################### Base Config End ########################\n"
      mail_body=$mail_body"\n$INVITATION_LAST_LINE\n\n"
      # Send ourself a copy
      sendEmail -s "(MGR COPY)$mail_subj" -b "$mail_body"
      sendEmail -s "$mail_subj" -b "$mail_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$email_address"
    ;;
    "User")
      mail_subj="User Invitation from $HOMESERVER_NAME, RequestID: $request_id"
      mail_body=""
      mail_body=${mail_body}"User Invitation from $HOMESERVER_NAME\n"
      mail_body=${mail_body}"================================================================\n\n"
      mail_body=$mail_body"The public root certificate is attached to this email or downloaded via the following links (must be connected to network first):\n"
      mail_body=$mail_body"Root CA (PEM): http://$SUB_FILES.$HOMESERVER_DOMAIN/ca.crt\n"
      mail_body=$mail_body"Root CA (DER): http://$SUB_FILES.$HOMESERVER_DOMAIN/ca.der\n"
      mail_body=$mail_body"VPN Owner Home Page: https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN\n\n"
      if [ "$is_ip_provided" = "false" ]; then
        mail_body=$mail_body"The configuration can be loaded using one of the three following ways: \n"
        mail_body=$mail_body"     1. Copy and paste the configuration INSIDE the ### borders below, or\n"
        mail_body=$mail_body"     2. Scan the attached QR image (${config_name}-qr.png) from within the WireGuard client, or\n"
        mail_body=$mail_body"     3. Load the attached config file (${config_name}.conf).\n\n"
        if [ -z "$priv_key" ]; then
          mail_body=$mail_body"Ensure to replace your private key in the config before activating.\n"
        fi
      else
        mail_body=$mail_body"Append the config section below to your existing configuration.\n"
      fi
      mail_body=$mail_body"_______________________________________________________________________\n"
      if [ "$is_internet" = "true" ]; then
        allowed_ips=$(getAllowedPublicIPs $PRIMARY_VPN_SUBNET)
      else
        allowed_ips=$PRIMARY_VPN_SUBNET
      fi
      wg_config=""
      if [ -z "$priv_key" ]; then
        priv_key=$(wg genkey)
      fi
      if [ "$is_ip_provided" = "false" ]; then
        wg_config=$wg_config"[Interface]\n"
        wg_config=$wg_config"PrivateKey = $priv_key\n"
        wg_config=$wg_config"Address = ${ip_address}/32\n"
        wg_config=$wg_config"MTU = $RELAYSERVER_CLIENT_DEFAULT_MTU\n"
        wg_config=$wg_config"DNS = $RELAYSERVER_WG_SV_CLIENTDNS_IP\n\n"
      fi
      wg_config=$wg_config"[Peer]\n"
      wg_config=$wg_config"PublicKey = $RELAYSERVER_WG_SV_PUBLICKEY\n"
      wg_config=$wg_config"PresharedKey = $tmp_preshared_key\n"
      wg_config=$wg_config"AllowedIPs = $allowed_ips\n"
      wg_config=$wg_config"Endpoint = $RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT\n"
      wg_config=$wg_config"PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE\n"
      mail_body=$mail_body"\n#################### WireGuard Config Begin ####################\n\n"
      mail_body=$mail_body"$wg_config"
      mail_body=$mail_body"\n##################### WireGuard Config End #####################\n\n"
      mail_body=$mail_body"If this is not your primary VPN, add/update the entries below into your ClientDNS server.\n"
      mail_body=$mail_body"_______________________________________________________________________\n"
      mail_body=$mail_body"\n#################### HomeServers DNS Begin #####################\n\n"
      mail_body=$mail_body"$(getMyNetworkHomeServerDNSListForClientDNS)"
      mail_body=$mail_body"##################### HomeServers DNS End ######################\n"
      if [ "$is_ip_provided" = "false" ]; then
        echo -e "$wg_config" > $HOME/${config_name}.conf
        qrencode -t png -o $HOME/${config_name}-qr.png -r $HOME/${config_name}.conf
        mail_attachments="-a $HOME/${config_name}.conf -a $HOME/${config_name}-qr.png -a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der"
      else
        mail_attachments="-a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der"
      fi
      sendEmail -s "$mail_subj" -b "$mail_body" $mail_attachments -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$email_address"
      # Send ourself a copy
      sendEmail -s "(MGR COPY)$mail_subj" -b "$mail_body" $mail_attachments -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" 
      rm -f $HOME/${config_name}.conf
      rm -f $HOME/${config_name}-qr.png
    ;;
  esac
  echo "Invite complete."
}

# VPN Join functions
function createNetworkJoin()
{
  is_connect="$1"
  refreshSudo
  set +e
  join_file=$HOME/joinvpn_hs.cnf
  showMessageBox "Paste Configuration" "In this next step, you will need to paste your configuration file contents that you received via email. After pasting the contents, press CTRL-o to save, then Enter to confirm, then CTRL-x to exit. Please remember these key combinations. Press OK to proceed."
  nano $join_file
  if ! [ -f $join_file ]; then
    showMessageBox "Empty Config File" "The configuration file is empty, returning..."
    return 1
  fi
  performNetworkJoin "$is_connect" "$join_file"
  rm -f $join_file
  if [ $? -ne 0 ]; then
    showMessageBox "Config File Error" "There was an error with the config file, returning..."
    return 1
  fi
}

function performNetworkJoin()
{
  is_connect="$1"
  join_file="$2"
  echo "Joining network..."
  # First check if there are any shell expansions in the file.
  # If there is, throw up a big red flag.
  check_file=$(checkFileShellExpansion $join_file)
  if ! [ -z "$check_file" ]; then
    echo -e "$check_file"
    return 2
  fi
  # Do basic checks
  removeSpecialChars "$join_file"
  first_line="$(awk 'NF{print;exit}' $join_file)"
  last_line="$(awk 'NF{s=$0}END{print s}' $join_file)"
  if ! [ "$first_line" = "$INVITATION_FIRST_LINE" ] || ! [ "$last_line" = "$INVITATION_LAST_LINE" ]; then
    echo "ERROR: Incomplete invitation."
    return 8
  fi
  # Check right away for matching RequestID
  request_id=$(getValueFromConfig "RequestID" $join_file)
  if [ -z "$request_id" ]; then
    echo "ERROR: Invalid request ID."
    return 8
  fi
  if ! [ -f $HSHQ_WIREGUARD_DIR/requestkeys/$request_id ]; then
    echo "ERROR: No matching key for this request."
    return 8
  fi
  base_config_section=$(getTextBetweenStrings $join_file "Base Config Begin" "Base Config End")
  wireguard_config_section=$(getTextBetweenStrings $join_file "WireGuard Config Begin" "WireGuard Config End")
  dns_section=$(getTextBetweenStrings $join_file "HomeServers DNS Begin" "HomeServers DNS End")
  root_ca_section=$(getTextBetweenStrings $join_file "Root CA Begin" "Root CA End")
  mail_crt_section=$(getTextBetweenStrings $join_file "mail.crt Begin" "mail.crt End")
  mail_key_section=$(getTextBetweenStrings $join_file "mail.key Begin" "mail.key End")
  join_base_config_file=$HOME/joinvpn_base_config.cnf
  echo -e "$base_config_section" > $join_base_config_file

  priv_key=$(getValueFromConfig "PrivateKey" $HSHQ_WIREGUARD_DIR/requestkeys/$request_id)
  req_conn_type=$(getValueFromConfig "ConnectionType" $HSHQ_WIREGUARD_DIR/requestkeys/$request_id)
  req_is_primary=$(getValueFromConfig "IsPrimary" $HSHQ_WIREGUARD_DIR/requestkeys/$request_id)

  conn_type=$(getValueFromConfig "ConnectionType" $join_base_config_file)
  if ! [ "$conn_type" = "$req_conn_type" ]; then
    echo "ERROR: Apply/join connection type mismatch. You applied for $req_conn_type, but invitation has $conn_type."
    rm -f $join_base_config_file
    return 8
  fi
  interface_name=$(getValueFromConfig "InterfaceName" $join_base_config_file)
  if [ -z "$interface_name" ] || [ $(checkValidString "$interface_name" "-") = "false" ]; then
    echo "ERROR: Invalid interface name."
    rm -f $join_base_config_file
    return 8
  fi
  # Version 121 - Put vpn- and ext- at beginning of interface name rather than the end
  if [ "${interface_name: -4}" = "-vpn" ] && ! [ "${interface_name:0:4}" = "vpn-" ]; then
    interface_name="vpn-${interface_name%????}"
  fi
  if [ "${interface_name: -4}" = "-ext" ] && ! [ "${interface_name:0:4}" = "ext-" ]; then
    interface_name="ext-${interface_name%????}"
  fi
  email_address=$(getValueFromConfig "EmailAddress" $join_base_config_file)
  if [ -z "$email_address" ] || [ $(checkValidEmail "$email_address") = "false" ]; then
    echo "ERROR: Invalid email address."
    rm -f $join_base_config_file
    return 8
  fi
  domain_name=$(getValueFromConfig "DomainName" $join_base_config_file)
  if [ -z "$domain_name" ] || [ $(checkValidBaseDomain "$domain_name") = "false" ]; then
    echo "ERROR: Invalid domain name."
    rm -f $join_base_config_file
    return 8
  fi
  endpoint_hostname=$(getValueFromConfig "EndpointHostname" $join_base_config_file)
  if [ -z "$endpoint_hostname" ] || [ $(checkValidString "$endpoint_hostname" ".-") = "false" ]; then
    echo "ERROR: Invalid endpoint hostname."
    rm -f $join_base_config_file
    return 8
  fi
  endpoint_port=$(getValueFromConfig "EndpointPort" $join_base_config_file)
  if [ -z "$endpoint_port" ] || [ $(checkValidNumber "$endpoint_port") = "false" ]; then
    echo "ERROR: Invalid endpoint port."
    rm -f $join_base_config_file
    return 8
  fi
  client_ip=$(getValueFromConfig "ClientIP" $join_base_config_file)
  if [ -z "$client_ip" ] || [ $(checkValidIPAddress "$client_ip") = "false" ]; then
    echo "ERROR: Invalid client IP address."
    rm -f $join_base_config_file
    return 8
  fi
  client_public_key=$(getValueFromConfig "ClientPublicKey" $join_base_config_file)
  if [ -z "$client_public_key" ] || [ "$(checkValidWireGuardKey $client_public_key)" = "false" ]; then
    echo "ERROR: Invalid client public key."
    rm -f $join_base_config_file
    return 8
  fi
  if ! [ -z "$(getWGNameFromPubkey $client_public_key)" ]; then
    echo "ERROR: Duplicate client public key."
    rm -f $join_base_config_file
    return 8
  fi
  preshared_key=$(getValueFromConfig "PresharedKey" $join_base_config_file)
  if [ -z "$preshared_key" ]; then
    echo "ERROR: Invalid preshared key."
    rm -f $join_base_config_file
    return 8
  fi

  case "$conn_type" in
    "HomeServer VPN")
      cur_hs_name=$(getValueFromConfig "HomeServerName" $join_base_config_file)
      if [ -z "$cur_hs_name" ]; then
        echo "ERROR: Invalid HomeServer name."
        rm -f $join_base_config_file
        return 8
      fi
      ext_prefix=$(getValueFromConfig "ExternalPrefix" $join_base_config_file)
      if [ -z "$ext_prefix" ]; then
        echo "ERROR: Invalid external prefix."
        rm -f $join_base_config_file
        return 8
      fi
      int_prefix=$(getValueFromConfig "InternalPrefix" $join_base_config_file)
      if [ -z "$int_prefix" ]; then
        echo "ERROR: Invalid internal prefix."
        rm -f $join_base_config_file
        return 8
      fi
      ca_abbrev=$(getValueFromConfig "CertificateAuthorityAbbrev" $join_base_config_file)
      if [ -z "$ca_abbrev" ]; then
        echo "ERROR: Invalid CA abbrev."
        rm -f $join_base_config_file
        return 8
      fi
      ca_ip=$(getValueFromConfig "CertificateAuthorityIP" $join_base_config_file)
      if [ -z "$ca_ip" ] || [ $(checkValidIPAddress "$ca_ip") = "false" ]; then
        echo "ERROR: Invalid CA IP address."
        rm -f $join_base_config_file
        return 8
      fi
      ca_subdomain=$(getValueFromConfig "CertificateAuthoritySubdomain" $join_base_config_file)
      if [ -z "$ca_subdomain" ] || [ $(checkValidString "$ca_subdomain" ".-") = "false" ]; then
        echo "ERROR: Invalid CA subdomain."
        rm -f $join_base_config_file
        return 8
      fi
      ca_url=$(getValueFromConfig "CertificateAuthorityURL" $join_base_config_file)
      if [ -z "$ca_url" ]; then
        echo "ERROR: Invalid CA URL."
        rm -f $join_base_config_file
        return 8
      fi
      vpn_subnet=$(getValueFromConfig "VPNSubnet" $join_base_config_file)
      if [ -z "$vpn_subnet" ]; then
        echo "ERROR: Invalid VPN subnet."
        rm -f $join_base_config_file
        return 8
      fi
      rs_ext_ip=$(getValueFromConfig "RelayServerExternalIP" $join_base_config_file)
      if [ -z "$rs_ext_ip" ] || [ $(checkValidIPAddress "$rs_ext_ip") = "false" ]; then
        echo "ERROR: Invalid RelayServer external IP address."
        rm -f $join_base_config_file
        return 8
      fi
      rs_vpn_ip=$(getValueFromConfig "RelayServerVPNIP" $join_base_config_file)
      if [ -z "$rs_vpn_ip" ] || [ $(checkValidIPAddress "$rs_vpn_ip") = "false" ]; then
        echo "ERROR: Invalid RelayServer VPN IP address."
        rm -f $join_base_config_file
        return 8
      fi
      is_primary=$(getValueFromConfig "IsPrimary" $join_base_config_file)
      if [ -z "$is_primary" ] || ! ( [ "$is_primary" = "true" ] || [ "$is_primary" = "false" ] ); then
        echo "ERROR: Invalid primary VPN selection."
        rm -f $join_base_config_file
        return 8
      fi
      conn_type=$(getValueFromConfig "ConnectionType" $join_base_config_file)
      if ! [ "$is_primary" = "$req_is_primary" ]; then
        if [ "$is_primary" = "true" ]; then
          echo "ERROR: Apply/join IsPrimary mismatch. You applied for a non-primary connection, but the invitation indicates a primary connection."
        else
          echo "ERROR: Apply/join IsPrimary mismatch. You applied for a primary connection, but the invitation indicates a non-primary connection."
        fi
        rm -f $join_base_config_file
        return 8
      fi
      if [ "$is_primary" = "true" ]; then
        if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
          echo "ERROR: You are already hosting a VPN, cannot join another network as primary."
          rm -f $join_base_config_file
          return 8
        fi
        smtp_relay_host=$(getValueFromConfig "SMTPRelayHost" $join_base_config_file)
        if [ -z "$smtp_relay_host" ]; then
          echo "ERROR: Invalid SMTP relay host."
          rm -f $join_base_config_file
          return 8
        fi
        smtp_relay_username=$(getValueFromConfig "SMTPRelayUsername" $join_base_config_file)
        if [ -z "$smtp_relay_username" ]; then
          echo "ERROR: Invalid SMTP username."
          rm -f $join_base_config_file
          return 8
        fi
        smtp_relay_password=$(getValueFromConfig "SMTPRelayPassword" $join_base_config_file)
        if [ -z "$smtp_relay_password" ]; then
          echo "ERROR: Invalid SMTP password."
          rm -f $join_base_config_file
          return 8
        fi
        rs_ext_email_hostname=$(getValueFromConfig "RelayServerExtEmailHostname" $join_base_config_file)
        if [ -z "$rs_ext_email_hostname" ]; then
          echo "ERROR: Invalid RelayServer external email hostname."
          rm -f $join_base_config_file
          return 8
        fi
      fi
    ;;
    "HomeServer Internet")
      endpoint_pub_key=$(getValueFromConfig "EndpointPublicKey" $join_base_config_file)
      if [ -z "$endpoint_pub_key" ]; then
        echo "ERROR: Invalid endpoint public key."
        rm -f $join_base_config_file
        return 8
      fi
      mtu=$(getValueFromConfig "MTU" $join_base_config_file)
      if [ -z "$mtu" ]; then
        echo "ERROR: Invalid MTU."
        rm -f $join_base_config_file
        return 8
      fi
    ;;
    *)
      echo "ERROR: Connection type not found."
      rm -f $join_base_config_file
      return 8
    ;;
  esac

  # Do logical checks
  if [ "$domain_name" = "$HOMESERVER_DOMAIN" ]; then
    echo "ERROR: This is your domain, dummy!"
    rm -f $join_base_config_file
    return 8
  fi
  if ! [ "$(isEmailMatchBaseDomain $email_address $domain_name)" = "true" ]; then
    echo "ERROR: Join email is not from the same base domain. Email: $email_address, Domain: $domain_name"
    return 8
  fi
  if [ "$(checkInterfaceNameExists $interface_name)" = "true" ]; then
    echo "ERROR: An interface with this name already exists. Change the InterfaceName value to something unique (using 10 characters or less)."
    rm -f $join_base_config_file
    return 8
  fi
  if [ ${#interface_name} -gt 10 ]; then
    echo "ERROR: Change the InterfaceName value to something shorter, no more than 10 characters, exiting..."
    rm -f $join_base_config_file
    return 8
  fi
  my_pub_key=$(echo $priv_key | wg pubkey)
  if ! [ "$client_public_key" = "$my_pub_key" ]; then
    echo "ERROR: The private key does not align with the public key submitted in the application."
    rm -f $join_base_config_file
    return 8
  fi
  is_db=$(getWGNameFromIP $client_ip)
  if ! [ -z "$is_db" ]; then
    echo "ERROR: This IP address is already being used (Connection Name: $is_db). Please request a new one."
    rm -f $join_base_config_file
    return 8
  fi

  case "$conn_type" in
    "HomeServer VPN")
      check_ca_dom=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections join connections on hsvpn_connections.ID = connections.ID where hsvpn_connections.DomainName='$domain_name' and connections.NetworkType='other';")
      if ! [ -z "$check_ca_dom" ]; then
        echo "ERROR: There is already an existing connection with this domain ($domain_name), please disconnect that existing connection and try again."
        rm -f $join_base_config_file
        return 8
      fi
      vpn_subnet=$(getValueFromConfig VPNSubnet $join_base_config_file)
      # Check for intersection with our networks
      echo "Checking for network collision..."
      check_intersect="$(isNetworkIntersectOurNetworks $vpn_subnet false true)"
      if ! [ -z "$check_intersect" ]; then
        echo "ERROR: Network collision: $check_intersect"
        rm -f $join_base_config_file
        return 8
      fi
      echo "No collision."
      join_rootca_name="$(getCACertificateNameFromDomain $domain_name)"
      join_rootca_file=$HOME/$join_rootca_name
      echo -e "$root_ca_section" > $join_rootca_file
      openssl x509 -in $join_rootca_file -noout -text 1> /dev/null 2>&1
      check_cert=$?
      if [ $check_cert -ne 0 ]; then
        echo "ERROR: There was an unknown error parsing the provided root certificate, exiting..."
        rm -f $join_base_config_file
        rm -f $join_rootca_file
        return 8
      fi
      join_wireguard_config_file=$HOME/${interface_name}.conf
      echo -e "$wireguard_config_section" > $join_wireguard_config_file
      sed -i "s|^PrivateKey =.*|PrivateKey = $priv_key|g" $join_wireguard_config_file
      config_name="Other-VPN-$domain_name"
      net_type="other"
      isPrimary=0
      input_ports_list=$INPUT_OTHER_VPN_ALLOW_PORTS_DEFAULT
      docker_user_ports_list=$DOCKERUSER_OTHER_VPN_ALLOW_PORTS_DEFAULT
      if [ "$is_primary" = "true" ]; then
        isPrimary=1
        config_name="Primary-VPN-$domain_name"
        net_type="primary"
        input_ports_list=$INPUT_PRIMARY_VPN_ALLOW_PORTS_DEFAULT
        docker_user_ports_list=$DOCKERUSER_PRIMARY_VPN_ALLOW_PORTS_DEFAULT
      fi
      checkname_db=$(sqlite3 $HSHQ_DB "select Name from connections where Name='$config_name';")
      if ! [ -z "$checkname_db" ]; then
        echo "ERROR: There is already a connection with this name."
        rm -f $join_base_config_file
        rm -f $join_rootca_file
        rm -f $join_wireguard_config_file
        return 8
      fi
      if [ "$is_primary" = "true" ]; then
        checkPrimary=$(sqlite3 $HSHQ_DB "select ID from connections where NetworkType='primary';")
        if ! [ -z "$checkPrimary" ]; then
          echo "ERROR: There is already a primary network."
          rm -f $join_base_config_file
          rm -f $join_rootca_file
          rm -f $join_wireguard_config_file
          return 8
        fi
        echo -e "$mail_crt_section" > $HOME/mail-cert.crt
        openssl x509 -in $HOME/mail-cert.crt -noout -text 1> /dev/null 2>&1
        check_cert=$?
        if [ $check_cert -ne 0 ]; then
          echo "ERROR: There was an unknown error parsing the provided mail certificate."
          rm -f $join_base_config_file
          rm -f $join_rootca_file
          rm -f $join_wireguard_config_file
          rm -f $HOME/mail-cert.crt
          return 8
        fi
        echo -e "$mail_key_section" > $HOME/mail-key.key
        openssl rsa -in $HOME/mail-key.key -check 1> /dev/null 2>&1
        check_cert=$?
        if [ $check_cert -ne 0 ]; then
          echo "ERROR: There was an unknown error parsing the provided mail certificate key, exiting..."
          rm -f $join_base_config_file
          rm -f $join_rootca_file
          rm -f $join_wireguard_config_file
          rm -f $HOME/mail-cert.crt
          rm -f $HOME/mail-key.key
          return 8
        fi
        mv -f $HOME/mail-cert.crt $HSHQ_SSL_DIR/mail.crt
        mv -f $HOME/mail-key.key $HSHQ_SSL_DIR/mail.key
        chmod 0444 $HSHQ_SSL_DIR/mail.crt
        chmod 0444 $HSHQ_SSL_DIR/mail.key
        SMTP_RELAY_HOST="$smtp_relay_host"
        updateConfigVar SMTP_RELAY_HOST $SMTP_RELAY_HOST
        SMTP_RELAY_USERNAME="$smtp_relay_username"
        updateConfigVar SMTP_RELAY_USERNAME $SMTP_RELAY_USERNAME
        SMTP_RELAY_PASSWORD="$smtp_relay_password"
        updateConfigVar SMTP_RELAY_PASSWORD $SMTP_RELAY_PASSWORD
        RELAYSERVER_SERVER_IP="$rs_ext_ip"
        updateConfigVar RELAYSERVER_SERVER_IP $RELAYSERVER_SERVER_IP
        RELAYSERVER_EXT_EMAIL_HOSTNAME=$rs_ext_email_hostname
        updateConfigVar RELAYSERVER_EXT_EMAIL_HOSTNAME $RELAYSERVER_EXT_EMAIL_HOSTNAME
        PRIMARY_VPN_SETUP_TYPE=join
        updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
      fi
      dns_file=$HOME/dns.tmp
      echo -e "$dns_section" > $dns_file
      curdt=$(getCurrentDate)
      db_id=$(sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated,Network_Subnet,IsExposeToNetwork,InputAllowPorts,DockerUserAllowPorts) values('$config_name','$email_address','homeserver_vpn','$net_type','$my_pub_key','$preshared_key','$client_ip',false,'$interface_name','$endpoint_hostname','$curdt','$vpn_subnet',true,'$input_ports_list','$docker_user_ports_list');select last_insert_rowid();")
      sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into hsvpn_connections(ID,HomeServerName,IsPrimary,DomainName,ExternalPrefix,InternalPrefix,CA_Abbrev,CA_IP,CA_Subdomain,CA_URL,RS_VPN_IP) values($db_id,'$cur_hs_name','$isPrimary','$domain_name','$ext_prefix','$int_prefix','$ca_abbrev','$ca_ip','$ca_subdomain','$ca_url','$rs_vpn_ip');"
      checkUpdateAllIPTables performNetworkJoin
      if [ "$IS_INSTALLED" = "true" ]; then
        echo "Updating HomeServer DNS and restarting Heimdall..."
        docker container stop heimdall >/dev/null
        updateHomeServerDNS $dns_file
        docker container start heimdall >/dev/null
        rm -f $dns_file
      fi
      echo "Creating WireGuard config..."
      JOINED_DB_ID=$db_id
      rm -f $join_base_config_file
      sudo mv $join_wireguard_config_file $HSHQ_WIREGUARD_DIR/vpn/${interface_name}.conf
      sudo chown root:root $HSHQ_WIREGUARD_DIR/vpn/${interface_name}.conf
      sudo chmod 0400 $HSHQ_WIREGUARD_DIR/vpn/${interface_name}.conf
      sudo cp $HSHQ_WIREGUARD_DIR/vpn/${interface_name}.conf /etc/wireguard/${interface_name}.conf
      echo "Installing CA certificate..."
      sudo mv $join_rootca_file $HSHQ_SSL_DIR/$join_rootca_name
      sudo chmod 0444 $HSHQ_SSL_DIR/$join_rootca_name
      sudo cp $HSHQ_SSL_DIR/$join_rootca_name /usr/local/share/ca-certificates/
      sudo update-ca-certificates
      echo "Updating services due to new CA certificate..."
      if [ "$IS_INSTALLED" = "true" ]; then
        docker ps | grep nextcloud-app > /dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo "Updating CA certificates in Nextcloud..."
          docker exec -u www-data nextcloud-app php occ --no-warnings security:certificates:import /usr/local/share/ca-certificates/$join_rootca_name
        fi
        #echo "Restarting HomeAssistant (if running) due to new CA certificate..."
        #restartStackIfRunning homeassistant 10
      fi
      set -e
      if [ "$is_connect" = "true" ]; then
        connectVPN $db_id true
      fi
    ;;
    "HomeServer Internet")
      dockerNetworkName="dwg-${interface_name}"
      config_name="Other-Internet-$domain_name"
      checkname_db=$(sqlite3 $HSHQ_DB "select Name from connections where Name='$config_name';")
      if ! [ -z "$checkname_db" ]; then
        echo "ERROR: There is already a connection with this name."
        rm -f $join_base_config_file
        return 8
      fi
      # Check for intersection with our networks
      echo "Checking for network collision..."
      check_intersect="$(isNetworkIntersectOurNetworks ${client_ip}/32 false true)"
      if ! [ -z "$check_intersect" ]; then
        echo "ERROR: Network collision: $check_intersect"
        rm -f $join_base_config_file
        return 8
      fi
      echo "No collision."
      join_wireguard_config_file=$HOME/${interface_name}.conf
      tableid=$(getNextWGRoutingTableID)
      allowed_ips=$(getAllowedPublicIPs)
      dockerSubnet=$(getNextAvailableWGDockerNetwork $dockerNetworkName $mtu)
      echo -e "#NETNAME=$interface_name" > $join_wireguard_config_file
      echo -e "#ROUTING_TABLE_ID=$tableid" >> $join_wireguard_config_file
      echo -e "#DOCKER_NETWORK_NAME=$dockerNetworkName" >> $join_wireguard_config_file
      echo -e "#DOCKER_NETWORK_SUBNET=$dockerSubnet" >> $join_wireguard_config_file
      echo -e "#CLIENT_ADDRESS=$client_ip" >> $join_wireguard_config_file
      echo -e "#MTU=$mtu" >> $join_wireguard_config_file
      echo -e "#IS_ENABLED=true" >> $join_wireguard_config_file
      echo -e "#EXT_DOMAIN=$endpoint_hostname" >> $join_wireguard_config_file
      echo -e "\n[Interface]" >> $join_wireguard_config_file
      echo -e "PrivateKey = $priv_key" >> $join_wireguard_config_file
      echo -e "\n[Peer]" >> $join_wireguard_config_file
      echo -e "PublicKey = $endpoint_pub_key" >> $join_wireguard_config_file
      echo -e "PresharedKey = $preshared_key" >> $join_wireguard_config_file
      echo -e "AllowedIPs = $allowed_ips" >> $join_wireguard_config_file
      echo -e "Endpoint = ${endpoint_hostname}:${endpoint_port}" >> $join_wireguard_config_file
      echo -e "PersistentKeepalive = $RELAYSERVER_PERSISTENT_KEEPALIVE" >> $join_wireguard_config_file
      chmod 0400 $join_wireguard_config_file
      sudo chown root:root $join_wireguard_config_file
      sudo mv $join_wireguard_config_file $HSHQ_WIREGUARD_DIR/internet/${interface_name}.conf
      rm -f $join_base_config_file
      curdt=$(getCurrentDate)
      db_id=$(sudo sqlite3 $HSHQ_DB "insert into connections(Name,EmailAddress,ConnectionType,NetworkType,PublicKey,PresharedKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,LastUpdated) values('$config_name','$email_address','homeserver_internet','other','$my_pub_key','$preshared_key','$client_ip',true,'$interface_name','$endpoint_hostname','$curdt');select last_insert_rowid();")
      JOINED_DB_ID=$db_id
      set -e
      if [ "$is_connect" = "true" ]; then
        connectInternet $db_id
      fi
    ;;
  esac
  rm -f $HSHQ_WIREGUARD_DIR/requestkeys/$request_id
}

# VPN Remove functions
function removeMyNetworkPrimaryVPN()
{
  disconnect_reason="$1"
  db_id=$(getPrimaryVPN_DBID)
  if ! [ -z "$db_id" ]; then
    client_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
    ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
    ca_abbrev=$(sqlite3 $HSHQ_DB "select CA_Abbrev from hsvpn_connections where ID=$db_id;")
    domain_name=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$db_id;")
    ext_prefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$db_id;")
    int_prefix=$(sqlite3 $HSHQ_DB "select InternalPrefix from hsvpn_connections where ID=$db_id;")
    ca_ip=$(sqlite3 $HSHQ_DB "select CA_IP from hsvpn_connections where ID=$db_id;")
    ca_subdomain=$(sqlite3 $HSHQ_DB "select CA_Subdomain from hsvpn_connections where ID=$db_id;")
    ca_url=$(sqlite3 $HSHQ_DB "select CA_URL from hsvpn_connections where ID=$db_id;")
    vpn_subnet=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections where ID=$db_id;")
    rs_vpn_ip=$(sqlite3 $HSHQ_DB "select RS_VPN_IP from hsvpn_connections where ID=$db_id;")
    # Do notifications first, since this will tear down our network.
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
      # Notify everyone that they have been removed
      notifyMyNetworkFullRemoval
      echo "Waiting 30 seconds to proceed so that Disconnect Notice email(s) can get sent..."
      sleep 30
    elif [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
      host_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
      # Notify host that you have disconnected.
      email_subj="HomeServer Disconnect Notice from $HOMESERVER_NAME"
      email_body=""
      email_body=${email_body}"HomeServer Disconnect Notice from $HOMESERVER_NAME\n"
      email_body=${email_body}"================================================================\n\n"
      email_body=${email_body}"Domain: $HOMESERVER_DOMAIN\n"
      email_body=${email_body}"Reason Provided: $disconnect_reason\n\n"
      sendEmail -s "$email_subj" -b "$email_body" -t "$host_email" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      echo "Waiting 30 seconds to proceed so that Disconnect Notice email(s) can get sent..."
      sleep 30
    fi
  fi
  refreshSudo
  if sudo test -f /etc/wireguard/${ifaceName}.conf; then
    echo "Removing WireGuard interface: $ifaceName"
    removeWGInterfaceQuick $ifaceName
  fi
  sudo rm -f $HSHQ_WIREGUARD_DIR/vpn/${ifaceName}.conf
  deleteDomainAdguardHS "*.$int_prefix.$domain_name"
  checkDeleteStackAndDirectory caddy-$ifaceName "Caddy" true true
  removeHomeNetIP ${RELAYSERVER_SERVER_IP}/32 true
  docker container stop uptimekuma >/dev/null
  docker container stop heimdall >/dev/null
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "Removing Wazuh agent..."
    sudo sqlite3 $HSHQ_DB "drop table portforwarding;"
    removeRelayServerAgentFromWazuhManager
    echo "Removing Syncthing backup..."
    curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X DELETE -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders/$RELAYSERVER_SYNCTHING_FOLDER_ID > /dev/null 2>&1
    curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X DELETE -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/devices/$RELAYSERVER_SYNCTHING_DEVICE_ID > /dev/null 2>&1
    echo "Removing ClientDNS instances..."
    cdns_arr=($(sqlite3 $HSHQ_DB "select ID,Name from connections where ConnectionType='clientdns' and NetworkType in ('primary','mynetwork');"))
    for cur_cdns in "${cdns_arr[@]}"
    do
      cur_cdns_id=$(echo "$cur_cdns" | cut -d"|" -f1)
      cur_cdns_name=$(echo "$cur_cdns" | cut -d"|" -f2)
      performMyNetworkRemoveClientDNS $cur_cdns_id "$cur_cdns_name" false false
    done
    sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${RELAYSERVER_WG_INTERNET_NETNAME}.conf down
    sudo rm -f $HSHQ_WIREGUARD_DIR/internet/${RELAYSERVER_WG_INTERNET_NETNAME}.conf
    docker container restart syncthing
    # Remove any DNS entries resulting from our network.
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from hsvpn_dns where HostDomain='$HOMESERVER_DOMAIN';"
    vpn_arr=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork';"))
    for curID in "${vpn_arr[@]}"
    do
      curDomain=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$curID;")
      curDomainExtPrefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$curID;")
      curMailHostID=$(sqlite3 $HSHQ_DB "select MailHostID from hsvpn_connections where ID=$curID;")
      if ! [ -z "$curMailHostID" ]; then
        sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhostmap where MailHostID=$curMailHostID;"
        sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhosts where ID=$curMailHostID;"
      fi
      removeRevertDNS $curDomain $curDomainExtPrefix
    done
    curMailHostID=$(sqlite3 $HSHQ_DB "select MailHostID from hsvpn_connections join connections on connections.ID = hsvpn_connections.ID where ConnectionType = 'homeserver_vpn' and NetworkType='primary';")
    if ! [ -z "$curMailHostID" ]; then
      sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhostmap where MailHostID=$curMailHostID;"
      sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhosts where ID=$curMailHostID;"
    fi
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from lecertdomains;"
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from exposedomains;"
    deleteSvcAll relayserver "https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcAll relayserver "https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcAll relayserver "https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcAll relayserver "https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcAll relayserver "https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcAll relayserver "https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcHeimdall relayserver "https://$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
    deleteSvcHeimdall relayserver "https://$SUB_CADDYDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN" false
  elif [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    sudo rm -f $HSHQ_SSL_DIR/"$(getCACertificateNameFromDomain $domain_name)"
    sudo rm -f /usr/local/share/ca-certificates/"$(getCACertificateNameFromDomain $domain_name)"
    sudo update-ca-certificates
    dns_arr=($(sqlite3 $HSHQ_DB "select PeerDomain,PeerDomainExtPrefix from hsvpn_dns where HostDomain='$domain_name';"))
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from hsvpn_dns where HostDomain='$domain_name';"
    for cur_dns in "${dns_arr[@]}"
    do
      curPeerDomain=$(echo "$cur_dns" | cut -d "|" -f1)
      curPeerDomainExtPrefix=$(echo "$cur_dns" | cut -d "|" -f2)
      removeRevertDNS $curPeerDomain $curPeerDomainExtPrefix
      deleteSvcHeimdall homeservers https://$SUB_HSHQHOME.$curPeerDomain false
    done
  fi
  docker container start uptimekuma >/dev/null
  docker container start heimdall >/dev/null
  PRIMARY_VPN_SETUP_TYPE=none
  updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
  resetRelayServerData
  updateSvcsIPChanges
  checkUpdateAllIPTables removeMyNetworkPrimaryVPN

}

function removeMyNetworkHomeServerVPNConnection()
{
  db_id=$1
  removal_reason="$2"
  # Multiple queries is wasteful...but easier...
  pub_key=$(sqlite3 $HSHQ_DB "select PublicKey from connections where ID=$db_id;")
  ip_addr=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  peer_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  domain_name=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$db_id;")
  hs_name=$(sqlite3 $HSHQ_DB "select HomeServerName from hsvpn_connections where ID=$db_id;")
  is_primary=$(sqlite3 $HSHQ_DB "select IsPrimary from hsvpn_connections where ID=$db_id;")
  mail_host_id=$(sqlite3 $HSHQ_DB "select MailHostID from hsvpn_connections where ID=$db_id;")
  domain_ext_prefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$db_id;")
  if [ -z "$pub_key" ]; then
    echo "ERROR: No matching DB entry, returning..."
    return
  fi
  # Notify peer that you are removing them.
  email_subj="HomeServer Removal Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=${email_body}"HomeServer Removal Notice from $HOMESERVER_NAME\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"Your HomeServer connection has been removed from the network.\n"
  email_body=${email_body}"Ensure to disconnect accordingly.\n\n"
  email_body=${email_body}"Host Domain: $HOMESERVER_DOMAIN\n"
  email_body=${email_body}"Reason Provided: $removal_reason\n\n"
  sendEmail -s "$email_subj" -b "$email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$peer_email" 
  if [ $is_primary = 1 ]; then
    echo "Waiting 30 seconds to proceed so that Removal Notice email(s) can get sent..."
    sleep 30
  fi

  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh \"$pub_key\" \"$ip_addr\" \"false\" \"true\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer, returning..."
    return
  fi
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from hsvpn_dns where HostDomain='$HOMESERVER_DOMAIN' and PeerDomain='$domain_name';"
  removeRevertDNS $domain_name $domain_ext_prefix
  deleteDomainAndWildcardAdguardRS $domain_name
  deleteDomainAdguardRS "*.$domain_ext_prefix.$domain_name"
  deleteSvcHeimdall homeservers "https://$SUB_HSHQHOME.$domain_name" true

  if [ $is_primary = 1 ]; then
    domains_to_remove=$(sqlite3 $HSHQ_DB "select Domain from mailhostmap where MailHostID=$mail_host_id and IsFirstDomain=true;")
    domains_to_rem_qry=($(sqlite3 $HSHQ_DB "select Domain from mailhostmap where MailHostID=$mail_host_id and IsFirstDomain=false;"))
    for curdom in "${domains_to_rem_qry[@]}"
    do
      domains_to_remove="${domains_to_remove},$curdom"
    done
    deliver_to_host=$(sqlite3 $HSHQ_DB "select MailHost from mailhosts where ID=$mail_host_id;")
    ssh -p $RELAYSERVER_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeRelayedDomains.sh $domains_to_remove $deliver_to_host $domain_name"
    if [ $? -ne 0 ]; then
      echo "ERROR: Could not connect to RelayServer host or there was an error removing the peer, returning..."
      return
    fi
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhostmap where MailHostID=$mail_host_id;"
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhosts where ID=$mail_host_id;"
    removeSecondaryDomainFromRelayServer "$domain_name"
  fi
  unloadSSHKey
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where ID=$db_id;"
  # Send update email to other HomeServers on our network
  notifyMyNetworkHomeServersDNSUpdate remove "$hs_name" "$domain_name"
  # Send update email to other users on our network
  notifyMyNetworkUsersDNSUpdate remove "$hs_name" "$domain_name" "$domain_ext_prefix" "$ip_addr"
}

function removeMyNetworkHomeServerInternetConnection()
{
  db_id=$1
  removal_reason="$2"
  echo "Removing $db_id"
  peer_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  removeMyNetworkNonHomeServerConnection $db_id
  echo "Sending email to $peer_email"
  notifyHomeServerInternetNetworkRemoval "$peer_email" "$removal_reason"
}

function removeMyNetworkUserConnection()
{
  db_id=$1
  removal_reason="$2"
  peer_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  removeMyNetworkNonHomeServerConnection $db_id
  echo "Sending email to $peer_email, reason: $removal_reason"
  notifyUserNetworkRemoval "$peer_email" "$removal_reason"
}

function removeMyNetworkNonHomeServerConnection()
{
  db_id=$1
  is_vpn=$2
  pub_key=$(sqlite3 $HSHQ_DB "select PublicKey from connections where ID=$db_id;")
  ip_addr=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  is_int=$(sqlite3 $HSHQ_DB "select IsInternet from connections where ID=$db_id;")
  is_internet="false"
  if [ $is_int = 1 ]; then
    is_internet="true"
  fi
  is_in_vpn=false
  if ! [ -z "$is_vpn" ] && [ "$is_vpn" = "true" ]; then
    is_in_vpn=true
  fi

  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh \"$pub_key\" \"$ip_addr\" \"$is_internet\" \"$is_in_vpn\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an error adding the peer, returning..."
    return
  fi
  unloadSSHKey
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where ID=$db_id;"
}

# VPN Disconnect functions
function disconnectOtherNetworkHomeServerVPNConnection()
{
  db_id=$1
  disconnect_reason="$2"
  ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  client_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  host_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  domain_name=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$db_id;")
  ext_prefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$db_id;")
  int_prefix=$(sqlite3 $HSHQ_DB "select InternalPrefix from hsvpn_connections where ID=$db_id;")
  ca_ip=$(sqlite3 $HSHQ_DB "select CA_IP from hsvpn_connections where ID=$db_id;")
  if sudo test -f /etc/wireguard/${ifaceName}.conf; then
    removeWGInterfaceQuick $ifaceName
  else
    echo "ERROR: WireGuard config file not found: /etc/wireguard/${ifaceName}.conf"
  fi
  sudo rm -f $HSHQ_WIREGUARD_DIR/vpn/${ifaceName}.conf
  sudo rm -f $HSHQ_SSL_DIR/"$(getCACertificateNameFromDomain $domain_name)"
  sudo rm -f /usr/local/share/ca-certificates/"$(getCACertificateNameFromDomain $domain_name)"
  sudo update-ca-certificates
  checkDeleteStackAndDirectory caddy-$ifaceName "Caddy" true true
  rm -f $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-caddy-$ifaceName
  deleteDomainAdguardHS "*.$int_prefix.$domain_name"
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where ID=$db_id;"
  peer_list=($(sqlite3 $HSHQ_DB "select PeerDomain,PeerDomainExtPrefix,IsActive from hsvpn_dns where HostDomain='$domain_name';"))
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from hsvpn_dns where HostDomain='$domain_name';"
  for cur_peer in "${peer_list[@]}"
  do
    curPeerDomain=$(echo "$cur_peer" | cut -d "|" -f1)
    curPeerDomainExtPrefix=$(echo "$cur_peer" | cut -d "|" -f2)
    curIsActive=$(echo "$cur_peer" | cut -d "|" -f3)
    if [ $curIsActive = 1 ]; then
      removeRevertDNS $curPeerDomain $curPeerDomainExtPrefix
    fi
  done
  updateSvcsIPChanges
  checkUpdateAllIPTables disconnectOtherNetworkHomeServerVPNConnection
  # Notify host that you have disconnected.
  email_subj="HomeServer VPN Disconnect Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=${email_body}"HomeServer VPN Disconnect Notice from $HOMESERVER_NAME\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"Domain: $HOMESERVER_DOMAIN\n"
  email_body=${email_body}"Reason Provided: $disconnect_reason\n\n"
  sendEmail -s "$email_subj" -b "$email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$host_email" 
}

function disconnectOtherNetworkHomeServerInternetConnection()
{
  db_id=$1
  disconnect_reason="$2"
  set +e
  wg_config=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  host_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${wg_config}.conf down
  del_network=$(sudo grep ^\#DOCKER_NETWORK_NAME= $HSHQ_WIREGUARD_DIR/internet/${wg_config}.conf | sed 's/^[^=]*=//')
  docker network rm $del_network > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not remove the docker network associated with this connection. There is likely one or more containers still attached to it. Ensure to shut down the container(s) and manually delete the network ($del_network)."
  fi
  sudo rm -f $HSHQ_WIREGUARD_DIR/internet/${wg_config}.conf
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where ID=$db_id;"

  # Notify host that you have disconnected.
  email_subj="HomeServer Internet Disconnect Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=${email_body}"HomeServer Internet Disconnect Notice from $HOMESERVER_NAME\n"
  email_body=${email_body}"================================================================\n\n"
  email_body=${email_body}"Domain: $HOMESERVER_DOMAIN\n"
  email_body=${email_body}"Reason Provided: $disconnect_reason\n\n"
  sendEmail -s "$email_subj" -b "$email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$host_email" 
}

function changeHSInternetPrimaryIPAddress()
{
  # Just in case there's a network collision, allow
  # user to change the IP address rather than having
  # to tear down the entire hosted VPN structure.
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  new_ip=$1
  echo "Checking for network collision..."
  check_intersect="$(isNetworkIntersectOurNetworks ${new_ip}/32 false true)"
  if ! [ -z "$check_intersect" ]; then
    echo "ERROR: Network collision: $check_intersect"
    return 2
  fi
  echo "No collision."
  if [ "$(isIPInSubnet $new_ip 10.0.0.0/8)" = "false" ]; then
    echo "ERROR: IP not in the 10.0.0.0/8 range."
    return 3
  fi
  db_id=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_internet' and NetworkType='primary';")
  pub_key=$(sqlite3 $HSHQ_DB "select PublicKey from connections where ID=$db_id;")
  cur_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  interface_name=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$db_id;")
  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh \"$pub_key\" \"$cur_ip\" \"true\" \"false\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an unknown error, returning..."
    unloadSSHKey
    return 4
  fi
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"Primary-Internet-$HOMESERVER_DOMAIN\" \"$EMAIL_ADMIN_EMAIL_ADDRESS\" \"$pub_key\" \"$RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY\" \"$new_ip\" \"true\" \"false\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an unknown error, returning..."
    unloadSSHKey
    return 5
  fi
  unloadSSHKey
  sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${interface_name}.conf down
  sudo sed -i "s/^#CLIENT_ADDRESS=.*/#CLIENT_ADDRESS=$new_ip\/32/g" $HSHQ_WIREGUARD_DIR/internet/${interface_name}.conf
  sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${interface_name}.conf up
  sudo sqlite3 $HSHQ_DB "update connections set IPAddress='$new_ip' where ID=$db_id;"
}

function changeDeviceIPAddress()
{
  # Just in case there's a network collision, allow
  # user to change the IP address rather than having
  # to redo the apply/invite.
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  db_id=$1
  new_ip=$2

  is_db=$(getWGNameFromIP $new_ip)
  if ! [ -z "$is_db" ]; then
    echo "ERROR: This IP address is already being used (Connection Name: $is_db)."
    return 2
  fi
  is_in_subnet=$(isIPInSubnet $new_ip $PRIMARY_VPN_SUBNET)
  if [ "$is_in_subnet" = "true" ]; then
    echo "ERROR: This IP address is inside of your VPN range designated for hosting HomeServers."
    return 3
  fi
  cur_name=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$db_id;")
  email_address=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$db_id;")
  pub_key=$(sqlite3 $HSHQ_DB "select PublicKey from connections where ID=$db_id;")
  pre_key=$(sqlite3 $HSHQ_DB "select PresharedKey from connections where ID=$db_id;")
  cur_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$db_id;")
  isInt=$(sqlite3 $HSHQ_DB "select IsInternet from connections where ID=$db_id;")
  is_internet="false"
  if [ "$isInt" = "1" ]; then
    is_internet="true"
  fi
  wgPortalAuth="$(getWGPortalAuth)"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh \"$pub_key\" \"$cur_ip\" \"$is_internet\" \"false\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an unknown error, returning..."
    unloadSSHKey
    return 4
  fi
  ssh -p $RELAYSERVER_SSH_PORT -t -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh \"$cur_name\" \"$email_address\" \"$pub_key\" \"$pre_key\" \"$new_ip\" \"$is_internet\" \"false\" \"$wgPortalAuth\""
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not connect to RelayServer host or there was an unknown error, returning..."
    unloadSSHKey
    return 5
  fi
  unloadSSHKey
  sudo sqlite3 $HSHQ_DB "update connections set IPAddress='$new_ip' where ID=$db_id;"
  email_subj="User Interface IP Address Change Notice from $HOMESERVER_NAME"
  email_body=""
  email_body=$email_body"User Interface IP Address Change Notice from $HOMESERVER_NAME\n"
  email_body=$email_body"================================================================\n\n"
  email_body=$email_body"IP address successfully changed.\n\n"
  email_body=$email_body"Old: $cur_ip\n"
  email_body=$email_body"New: $new_ip\n"
  sendEmail -s "$email_subj" -b "$email_body" -t "$email_address" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function outputLockUtilsScript()
{
  rm -f $HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME
  cat <<EOFUS > $HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME
#!/bin/bash

isDebug=false
LOGF=$HSHQ_LOG_FILE
LOCKHOLDER_FILENAME=$LOCKHOLDER_FILENAME
ALL_LOCKS="$ALL_LOCKS"

function tryGetLock()
{
  lockName="\$1"
  callerName="\$2"
  cohs_curE=\${-//[^e]/}
  set +e
  if [ -z "\$callerName" ]; then
    callerName=UnknownCaller
  fi
  isLockFound=false
  for curLock in \$ALL_LOCKS
  do
    if [ "\$lockName" = "\$curLock" ]; then
      isLockFound=true
      break
    fi
  done
  if [ "\$isLockFound" = "false" ]; then
    if ! [ -z "\$cohs_curE" ]; then
      set -e
    fi
    # Unknown lock name
    echo "false"
    return
  fi
  # BeforeNetwork is always the first one called during boot,
  # so this will clean up any mess prior to the last reboot.
  if [ "\$callerName" = "BeforeNetwork" ]; then
    releaseLock "\$lockName" "BeforeNetwork" false
  fi
  # mkdir is an atomic operation, so its the best mechanism
  # for performing locking operations
  if mkdir -- "/tmp/\$lockName" > /dev/null 2>&1; then
    echo \$callerName > /tmp/locktmp
    echo \$(date '+%s') >> /tmp/locktmp
    echo 0 >> /tmp/locktmp
    chmod 755 /tmp/locktmp
    chmod 644 /tmp/locktmp
    mv /tmp/locktmp /tmp/\$lockName/\$LOCKHOLDER_FILENAME
    if [ "\$isDebug" = "true" ]; then
      echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] tryGetLock - \$lockName lock obtained by \$callerName" >> \$LOGF
    fi
    echo "true"
  else
    if [ "\$isDebug" = "true" ]; then
      echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] tryGetLock - \$lockName lock denied from \$callerName" >> \$LOGF
    fi
    echo "false"
  fi
  if ! [ -z "\$cohs_curE" ]; then
    set -e
  fi
}

function forceGetLock()
{
  lockName="\$1"
  callerName="\$2"
  if [ -d /tmp/\$lockName ]; then
    sudo rm -f /tmp/\$lockName/\$LOCKHOLDER_FILENAME
  else
    mkdir -- "/tmp/\$lockName"
  fi
  echo \$callerName > /tmp/locktmp
  echo \$(date '+%s') >> /tmp/locktmp
  echo 0 >> /tmp/locktmp
  chmod 755 /tmp/locktmp
  chmod 644 /tmp/locktmp
  mv /tmp/locktmp /tmp/\$lockName/\$LOCKHOLDER_FILENAME
  if [ "\$isDebug" = "true" ]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] forceGetLock - \$lockName lock obtained by \$callerName" >> \$LOGF
  fi
}

function getLockOpenMsg()
{
  lockName="\$1"
  if test -f /tmp/\$lockName/\$LOCKHOLDER_FILENAME; then
    lastCaller=\$(sed -n 1p /tmp/\$lockName/\$LOCKHOLDER_FILENAME)
    lastExecute=\$(sed -n 2p /tmp/\$lockName/\$LOCKHOLDER_FILENAME)
    lastAttempts=\$(sed -n 3p /tmp/\$lockName/\$LOCKHOLDER_FILENAME)
    lastExecuteDate=\$(date -d @\${lastExecute} '+%Y-%m-%d %H:%M:%S')
    dtNow=\$(date '+%s')
    secondsDiff=\$((\$dtNow - \$lastExecute))
    strMessage=""
    if [ \$secondsDiff -lt 60 ]; then
      strMessage="Lock obtained \$secondsDiff second(s) ago by"
    else
      totMinutes=\$((\$secondsDiff / 60))
      strMessage="Lock obtained \$totMinutes minute(s) ago by"
    fi
    strMessage="\$strMessage \$lastCaller @ \$lastExecuteDate"
  else
    strMessage="Unknown-User"
  fi
  echo "\$strMessage"
}

function getIncrementLockAttempts()
{
  lockName="\$1"
  if test -f /tmp/\$lockName/\$LOCKHOLDER_FILENAME; then
    lastAttempts=\$(sed -n 3p /tmp/\$lockName/\$LOCKHOLDER_FILENAME)
    totAttempts=\$((\$lastAttempts + 1))
    sed -i '\$d' /tmp/\$lockName/\$LOCKHOLDER_FILENAME
    echo "\$totAttempts" >> /tmp/\$lockName/\$LOCKHOLDER_FILENAME
    echo "\$totAttempts"
  fi
}

function checkIsLockEnabled()
{
  lockName="\$1"
  if [ -d "/tmp/\$lockName" ]; then
    echo "\$(getLockOpenMsg \$lockName)"
  fi
}

function releaseLock()
{
  lockName="\$1"
  callerName="\$2"
  isForceRelease="\$3"
  if [ "\$isForceRelease" = "true" ]; then
    sudo rm -fr /tmp/\$lockName
  else
    rm -fr /tmp/\$lockName
  fi
  if [ "\$isDebug" = "true" ]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] releaseLock - \$lockName lock released by \$callerName" >> \$LOGF
  fi
}

EOFUS
}

function getHSHQScriptOpenMsg()
{
  getLockOpenMsg hshqopen
}

function checkHSHQScriptOpen()
{
  checkIsLockEnabled hshqopen
}

function closeHSHQScript()
{
  releaseLock hshqopen "$1" false
}

function acquireAllLocks()
{
  tgLock="$(tryGetLock networkchecks acquireAllLocks)"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg networkchecks)"
    echo "networkchecks: $checkRes"
    return 23
  fi
  tgLock="$(tryGetLock hshqopen acquireAllLocks)"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg hshqopen)"
    releaseLock networkchecks acquireAllLocks false
    echo "hshqopen: $checkRes"
    return 24
  fi
}

function releaseAllLocks()
{
  isForce="$1"
  releaseLock hshqopen "releaseAllLocks" "$isForce"
  releaseLock networkchecks "releaseAllLocks" "$isForce"
}

# Util Functions
function isConfigVar()
{
  isVar=$(grep ^$1= $CONFIG_FILE)
  if [ -z "$isVar" ]; then
    echo "false"
  else
    echo "true"
  fi
}

function getConfigVar()
{
  echo $(getConfigVarFromFile $1 $CONFIG_FILE)
}

function getPlaintextRootConfigVar()
{
  echo $(getConfigVarFromFile $1 $HSHQ_PLAINTEXT_ROOT_CONFIG root)
}

function getConfigVarFromFile()
{
  if [ "$3" = "root" ]; then
    echo $(sudo grep ^$1= $2 | sed 's/^[^=]*=//' | sed 's/ *$//g' | sed 's/"//g')
  else
    echo $(grep ^$1= $2 | sed 's/^[^=]*=//' | sed 's/ *$//g' | sed 's/"//g')
  fi
}

function updateConfigVar()
{
  updateConfigVarInFile "$1" "$2" $CONFIG_FILE
}

function updatePlaintextRootConfigVar()
{
  updateConfigVarInFile "$1" "$2" $HSHQ_PLAINTEXT_ROOT_CONFIG root
}

function removePlaintextRootConfigVar()
{
  if [ -z "$1" ]; then
    echo "FATAL: removePlaintextRootConfigVar - the variable name cannot be empty"
    exit 11
  fi
  sudo sed -i "/$1/d" $HSHQ_PLAINTEXT_ROOT_CONFIG
}

function updatePlaintextUserConfigVar()
{
  updateConfigVarInFile "$1" "$2" $HSHQ_PLAINTEXT_USER_CONFIG
}

function removePlaintextUserConfigVar()
{
  if [ -z "$1" ]; then
    echo "FATAL: removePlaintextUserConfigVar - the variable name cannot be empty"
    exit 11
  fi
  sed -i "/$1/d" $HSHQ_PLAINTEXT_USER_CONFIG
}

function updateConfigVarInFile()
{
  ucv_curE=${-//[^e]/}
  if [ -z "$3" ]; then
    return
  fi
  if [ -z "$1" ]; then
    echo "FATAL: updateConfigVarInFile - the variable name cannot be empty"
    exit 11
  fi
  if ! [ "$(echo $2 | head -n 1)" = "$2" ]; then
    echo "FATAL: updateConfigVarInFile - the value cannot have move than one line"
    exit 11
  fi
  set +e
  is_ds=false
  if [ "$4" = "root" ]; then
    if sudo grep -q "[$]" <<< "$2"; then
      is_ds=true
    fi
    sudo grep -q "${1}=" "$3"
  else
    if grep -q "[$]" <<< "$2"; then
      is_ds=true
    fi
    grep -q "${1}=" "$3"
  fi
  if [ $? -ne 0 ]; then
    echo "Variable not found (${1}), exiting..."
    exit 3
  fi
  if [ "$is_ds" = "true" ]; then
    if [ "$4" = "root" ]; then
      sudo sed -i "s|^${1}=.*|${1}=\'${2}\'|g" "$3"
    else
      sed -i "s|^${1}=.*|${1}=\'${2}\'|g" "$3"
    fi
  else
    if [ "$4" = "root" ]; then
      sudo sed -i "s|^${1}=.*|${1}=\"${2}\"|g" "$3"
    else
      sed -i "s|^${1}=.*|${1}=\"${2}\"|g" "$3"
    fi
  fi
  if ! [ -z "$ucv_curE" ]; then
    set -e
  fi
}

function getCurrentDate()
{
  date '+%Y-%m-%d %H:%M:%S'
}

function getDomainTLD()
{
  domain_name=$1
  echo $domain_name | rev | cut -d"." -f1 | rev
}

function getBaseDomain()
{
  domain_name=$1
  echo $domain_name | cut -d"." -f2- 
}

function getSubDomain()
{
  domain_name=$1
  echo $domain_name | cut -d"." -f1 
}

function getAdminEmailName()
{
  #echo "${HOMESERVER_ABBREV^^} Admin"
  echo "$HSHQ_ADMIN_NAME"
}

function removeRelayServerAgentFromWazuhManager()
{
  removeAgentFromWazuhManager "RelayServer"
}

function removeHomeServerAgentFromWazuhManager()
{
  removeAgentFromWazuhManager "HomeServer"
}

function removeAgentFromWazuhManager()
{
  strMatch="$1"
  rrswa_curE=${-//[^e]/}
  set +e
  docker ps | grep "wazuh.manager" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    rsID=$(docker exec -it wazuh.manager bash -c "/var/ossec/bin/manage_agents -l" | grep "$strMatch" | xargs | cut -d"," -f1 | cut -d" " -f2| xargs)
    if ! [ -z "$rsID" ]; then
      docker exec wazuh.manager bash -c "/var/ossec/bin/manage_agents -r $rsID" > /dev/null 2>&1
    fi
  fi
  if ! [ -z "$rrswa_curE" ]; then
    set -e
  fi
}

function checkDeleteStackAndDirectory()
{
  cdsad_curE=${-//[^e]/}
  stack_name="$1"
  formal_name="$2"
  is_check_stack="$3"
  is_force_delete="$4"
  is_delete_stack=false
  is_delete_dirs=false
  refreshSudo
  set +e
  if ! [ "$is_check_stack" = "false" ]; then
    stackID=$(getStackID $stack_name)
    if ! [ -z "$stackID" ]; then
      if ! [ "$ENABLE_STACK_DELETE" = "true" ] && ! [ "$is_force_delete" = "true" ]; then
        echo "ERROR: Stack deletion is disabled, exiting..."
        exit 5
      fi
      if [ "$is_force_delete" = "true" ]; then
        is_delete_stack=true
      else
        showYesNoMessageBox "Stack Exists" "The stack '$stack_name' exists. Do you wish to delete it?"
        mbres=$?
	    if [ $mbres -ne 0 ]; then
          return 1
        else
          is_delete_stack=true
        fi
      fi
    fi
  fi
  if [ -d "$HSHQ_STACKS_DIR/$stack_name" ] || [ -d "$HSHQ_NONBACKUP_DIR/$stack_name" ]; then
    if ! [ "$ENABLE_STACK_DELETE" = "true" ] && ! [ "$is_force_delete" = "true" ]; then
      echo "ERROR: Stack deletion is disabled, exiting..."
      exit 5
    fi
    if [ "$is_force_delete" = "true" ]; then
      is_delete_dirs=true
    else
      showYesNoMessageBox "$formal_name Directory Exists" "The $formal_name directory already exists. Do you wish to delete it?"
	  mbres=$?
	  if [ $mbres -eq 0 ]; then
        is_delete_dirs=true
      fi
    fi
  fi
  set -e
  if [ "$is_delete_stack" = "true" ]; then
    deleteStack $stack_name
  fi
  set +e
  if [ "$is_delete_dirs" = "true" ]; then
    sudo rm -fr $HSHQ_STACKS_DIR/$stack_name
    sudo rm -fr $HSHQ_NONBACKUP_DIR/$stack_name
    # Delete any volumes
    OLDIFS=$IFS
    IFS=$(echo -en "\n\b")
    vol_list=($(docker volume ls | grep v-${stack_name}))
    for curVol in "${vol_list[@]}"
    do
      curVolName=$(echo $curVol | xargs | cut -d" " -f2)
      docker volume rm $curVolName
    done
    IFS=$OLDIFS
  fi
  performPostStackRemoval $stack_name
  set +e
  if ! [ -z "$cdsad_curE" ]; then
    set -e
  fi
}

function checkAvailableHomeServerPort()
{
  check_port=$1
  if [ $check_port -le 1024 ]; then
    return 1
  fi
  allPortsArr=($(echo "$(getHomeServerPortsList)" | tr "," "\n"))
  for curPort in "${allPortsArr[@]}"
  do
    echo "$curPort" | grep ":" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      # Range of ports
      startPort=$(echo $curPort | cut -d":" -f1)
      endPort=$(echo $curPort | cut -d":" -f2)
      if [ $check_port -ge $startPort ] && [ $check_port -le $endPort ]; then
        return 2
      fi
    else
      # Single port
      if [ $check_port -eq $curPort ]; then
        return 3
      fi
    fi
  done
}

function getPrivateIPRangesCaddy()
{
  if ! [ "$(checkIsIPPrivate $1)" = "true" ]; then
    str_res=""
    if ! [ -z "$CONNECTING_IP" ]; then
      str_res="${CONNECTING_IP}/32"
    fi
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
      rsip=$(getIPFromHostname ip.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
      if ! [ -z "$rsip" ] && ! [ "$rsip" = "$CONNECTING_IP" ]; then
        str_res=${str_res}" ${rsip}/32"
      fi
    fi
    echo "$str_res"
  fi
}

function getNonPrivateConnectingIP()
{
  if ! [ "$(checkIsIPPrivate $HOMESERVER_HOST_PRIMARY_INTERFACE_IP)" = "true" ]; then
    str_res=""
    if ! [ -z "$CONNECTING_IP" ]; then
      str_res="${CONNECTING_IP}/32"
    fi
    rsip=$(getIPFromHostname ip.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN)
    if ! [ -z "$rsip" ] && ! [ "$rsip" = "$CONNECTING_IP" ]; then
      str_res=${str_res}" ${rsip}/32"
    fi
    set +e
    echo "$str_res" | grep "$HOMESERVER_HOST_PRIMARY_INTERFACE_IP" > /dev/null 2>&1
    if [ $? -ne 0 ] && ! [ -z "$HOMESERVER_HOST_PRIMARY_INTERFACE_IP" ]; then
      str_res=${str_res}" ${HOMESERVER_HOST_PRIMARY_INTERFACE_IP}/32"
    fi
    set -e
    echo "$str_res"
  fi
}

function getConnectingIPAddress()
{
  echo $(echo $SSH_CLIENT | xargs | cut -d" " -f1)
}

function getDefaultIface()
{
  echo $(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print $2}' | xargs | cut -d" " -f1)
}

function getIPAddressOfInterface()
{
  interface_name=$1
  ip_addr=$(ip route | grep $interface_name | grep / | awk -F'src ' '{print $2}' | xargs | cut -d" " -f1)
  if ! [ "$(checkValidIPAddress $ip_addr)" = "true" ]; then
    ip_addr=""
  fi
  if [[ $ip_addr =~ ^169\.254\. ]]; then
    ip_addr="$DEFAULT_UNFOUND_IP_ADDRESS"
  fi
  echo $ip_addr
}

function getCIDRLengthOfInterface()
{
  interface_name=$1
  ip route | grep "$interface_name" | grep / | xargs | cut -d" " -f1 | cut -d"/" -f2
}

function getSubnetOfInterface()
{
  net_interface=$1
  net_ip=$2
  is_priv=$3
  gsoa_curE=${-//[^e]/}
  set +e
  if [ -z "$net_ip" ]; then
    net_ip=$(getIPAddressOfInterface $net_interface)
  fi
  if [ -z "$is_priv" ]; then
    is_priv=$(checkIsIPPrivate "$net_ip")
  fi
  this_subnet=""
  num_tries=1
  max_tries=6
  while [ -z "$this_subnet" ] && [ $num_tries -lt $max_tries ]
  do
    if [ "$is_priv" = "true" ]; then
      rpt="$(sipcalc $(ip -o -f inet addr show $net_interface | awk '/scope global/ {print $4}'))"
      netaddr=$(echo "$rpt" | grep -o "Network address.*" | cut -d"-" -f2 | xargs | cut -d" " -f1)
      netsize=$(echo "$rpt" | grep -o "Network mask (bits).*" | cut -d"-" -f2 | xargs | cut -d" " -f1)
      if ! [ -z "$netaddr" ] && ! [ -z "$netsize" ]; then
        this_subnet="${netaddr}/${netsize}"
      fi
    else
      this_subnet="${net_ip}/32"
    fi
    if ! [ -z "$this_subnet" ]; then
      break
    fi
    sleep 3
    ((num_tries++))
  done
  if [[ $net_ip =~ ^169\.254\. ]]; then
    this_subnet="$DEFAULT_UNFOUND_IP_SUBNET"
  fi
  if ! [ -z "$gsoa_curE" ]; then
    set -e
  fi
  echo "$this_subnet"
}

function getGatewayOfInterface()
{
  interface_name=$1
  ip route | grep "$interface_name" | grep -e "^default" | awk '{print $3}' | head -1
}

function getIPFromHostname()
{
  echo $(timeout 5 dig $1 A +short | grep '^[.0-9]*$' | head -n 1)
}

function getAllowedPublicIPs()
{
  set +e
  ips="0.0.0.0/5,8.0.0.0/7,11.0.0.0/8,12.0.0.0/6,16.0.0.0/4,32.0.0.0/3,64.0.0.0/2,128.0.0.0/3,160.0.0.0/5,168.0.0.0/6,172.0.0.0/12,172.32.0.0/11,172.64.0.0/10,172.128.0.0/9,173.0.0.0/8,174.0.0.0/7,176.0.0.0/4,192.0.0.0/9,192.128.0.0/11,192.160.0.0/13,192.169.0.0/16,192.170.0.0/15,192.172.0.0/14,192.176.0.0/12,192.192.0.0/10,193.0.0.0/8,194.0.0.0/7,196.0.0.0/6,200.0.0.0/5,208.0.0.0/4"
  if ! [ -z "$1" ]; then
    ips+=","$1
  fi
  set -e
  echo $ips
}

function checkIsIPPrivate()
{
  check_ip="$1"
  if [ -z "$check_ip" ]; then
    echo "false"
    return
  fi
  set +e
  priv_arr=(10.0.0.0/8 172.16.0.0/12 192.168.0.0/16)
  for subnet in "${priv_arr[@]}"
  do
    is_in_subnet=$(isIPInSubnet $check_ip $subnet)
    if [ "$is_in_subnet" = "true" ]; then
      echo "true"
      return
    fi
  done
  echo "false"
}

function outputInterfaceInfo()
{
  interfaceName="$1"
  strOut="\n----------------------------------------------------------------"
  strOut="${strOut}\n          Interface Name:  $interfaceName"
  strOut="${strOut}\n              IP Address:  $(getIPAddressOfInterface $interfaceName)"
  strOut="${strOut}\n                  Subnet:  $(getSubnetOfInterface $interfaceName)"
  interfaceType=Other
  connectedTo=""
  ipAssignment=""
  sudo netplan get network | yq -r '.ethernets | keys' 2> /dev/null | grep $interfaceName > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    interfaceType=Wired
    if [ "$(sudo netplan get network.ethernets.${interfaceName}.dhcp4)" = "true" ]; then
      ipAssignment="dhcp"
    else
      ipAssignment="static"
    fi
  fi
  sudo netplan get network | yq -r '.wifis | keys' 2> /dev/null | grep $interfaceName > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    interfaceType=Wireless
    connectedTo=$(sudo iwconfig $interfaceName | grep -o "ESSID.*" | cut -d":" -f2)
    if [ "$(sudo netplan get network.wifis.${interfaceName}.dhcp4)" = "true" ]; then
      ipAssignment="dhcp"
    else
      ipAssignment="static"
    fi
  fi
  strOut="${strOut}\n          Interface Type:  $interfaceType"
  if ! [ -z "$ipAssignment" ]; then
    strOut="${strOut}\n    IP Assignment Method:  $ipAssignment"
  fi
  if ! [ -z "$connectedTo" ]; then
    strOut="${strOut}\n            Wifi Network:  $connectedTo"
  fi
  isPrimary=$(sqlite3 $HSHQ_DB "select ConnectionType from connections where InterfaceName='$interfaceName';")
  strOut="${strOut}\n               IsPrimary:  $isPrimary"
  isExposeToNetwork=$(sqlite3 $HSHQ_DB "select IsExposeToNetwork from connections where InterfaceName='$interfaceName';")
  if [ "$isExposeToNetwork" = "1" ]; then
    isExposeToNetwork=true
  else
    isExposeToNetwork=false
  fi
  strOut="${strOut}\n       IsExposeToNetwork:  $isExposeToNetwork"
  inputAllowPorts=$(sqlite3 $HSHQ_DB "select InputAllowPorts from connections where InterfaceName='$interfaceName';")
  strOut="${strOut}\n         InputAllowPorts:  $inputAllowPorts"
  dockerUserAllowPorts=$(sqlite3 $HSHQ_DB "select DockerUserAllowPorts from connections where InterfaceName='$interfaceName';")
  strOut="${strOut}\n    DockerUserAllowPorts:  $dockerUserAllowPorts"
  strOut="${strOut}\n----------------------------------------------------------------\n"
  echo "$strOut"
}

function setAsWiredDHCP()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  isReplace="$2"
  set +e
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null" > /dev/null 2>&1
  if [ "$isReplace" = "true" ]; then
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}=null" > /dev/null 2>&1
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.addresses=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.nameservers=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.routes=null" > /dev/null 2>&1
  fi
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.dhcp4=true"
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.optional=true"
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function setAsWiredStaticIP()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  isReplace="$2"
  ipAddress="$3"
  cidrLength="$4"
  interfaceGateway="$5"
  set +e
  if [ -z "$ipAddress" ]; then
    echo "ERROR: The IP address cannot be blank. No actions were performed."
    return 1
  elif [ -z "$cidrLength" ]; then
    echo "ERROR: The CIDR length cannot be blank. No actions were performed."
    return 2
  elif [ -z "$interfaceGateway" ]; then
    echo "ERROR: The network gateway cannot be blank. No actions were performed."
    return 3
  fi
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null" > /dev/null 2>&1
  if [ "$isReplace" = "true" ]; then
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}=null" > /dev/null 2>&1
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.addresses=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.nameservers=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.routes=null" > /dev/null 2>&1
  fi
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.addresses=[${ipAddress}/${cidrLength}]"
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.routes=[{to: default, via: $interfaceGateway}]"
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.dhcp4=false"
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}.optional=true"
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function setAsWirelessDHCP()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  isReplace="$2"
  wifiSSID="$3"
  wifiPass="$4"
  set +e
  sudo netplan get | yq '.network.wifis | keys' 2> /dev/null | grep $interfaceName > /dev/null 2>&1
  if [ $? -ne 0 ] || [ "$isReplace" = "true" ]; then
    if [ -z "$wifiSSID" ]; then
      echo "ERROR: This is a new interface or a forced replacement, thus the wifi SSID cannot be blank. No actions were performed."
      return 1
    elif ! [ -z "$wifiPass" ] && ([ ${#wifiPass} -lt 8 ] || [ ${#wifiPass} -gt 63 ]); then
      echo "ERROR: The wifi password must be between 8 and 63 characters. No actions were performed."
      return 2
    fi
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null" > /dev/null 2>&1
    if [ -z "$wifiPass" ]; then
      sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}={dhcp4: true, optional: true, access-points: {$wifiSSID: {}}}"
    else
      sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}={dhcp4: true, optional: true, access-points: {$wifiSSID: {auth: {key-management: psk, password: $wifiPass}}}}"
    fi
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.addresses=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.nameservers=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.routes=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.dhcp4=true"
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.optional=true"
  fi
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function setAsWirelessStaticIP()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  isReplace="$2"
  ipAddress="$3"
  cidrLength="$4"
  interfaceGateway="$5"
  wifiSSID="$6"
  wifiPass="$7"
  set +e
  if [ -z "$ipAddress" ]; then
    echo "ERROR: The IP address cannot be blank. No actions were performed."
    return 1
  elif [ -z "$cidrLength" ]; then
    echo "ERROR: The CIDR length cannot be blank. No actions were performed."
    return 2
  elif [ -z "$interfaceGateway" ]; then
    echo "ERROR: The network gateway cannot be blank. No actions were performed."
    return 3
  fi
  sudo netplan get | yq '.network.wifis | keys' 2> /dev/null | grep $interfaceName > /dev/null 2>&1
  if [ $? -ne 0 ] || [ "$isReplace" = "true" ]; then
    if [ -z "$wifiSSID" ]; then
      echo "ERROR: This is a new interface or a forced replacement, thus the wifi SSID cannot be blank. No actions were performed."
      return 4
    elif ! [ -z "$wifiPass" ] && ([ ${#wifiPass} -lt 8 ] || [ ${#wifiPass} -gt 63 ]); then
      echo "ERROR: The wifi password must be between 8 and 63 characters. No actions were performed."
      return 6
    fi
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null" > /dev/null 2>&1
    if [ -z "$wifiPass" ]; then
      sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}={dhcp4: false, optional: true, addresses: [${ipAddress}/${cidrLength}], routes: [{to: default, via: $interfaceGateway}], access-points: {$wifiSSID: {}}}"
    else
      sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}={dhcp4: false, optional: true, addresses: [${ipAddress}/${cidrLength}], routes: [{to: default, via: $interfaceGateway}], access-points: {$wifiSSID: {auth: {key-management: psk, password: $wifiPass}}}}"
    fi
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.addresses=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.nameservers=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.routes=null" > /dev/null 2>&1
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.addresses=[${ipAddress}/${cidrLength}]"
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.routes=[{to: default, via: $interfaceGateway}]"
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.dhcp4=false"
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.optional=false"
  fi
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function removeFromNetplan()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  set +e
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.ethernets.${interfaceName}=null"
  sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null"
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function displayWifiNetworks()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  interfaceName="$1"
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  resArr=($(sudo iwlist $interfaceName scanning | grep -E --color 'Frequency|Quality|Encryption|ESSID'))
  if [ $? -ne 0 ]; then
    return
  fi
  numItems=$((${#resArr[@]} - 1))
  unset fmtArr
  fmtArr=""
  sudo rm -f /tmp/wifi.txt
  curIndex=0
  fmtArr=()
  for curID in $(seq 0 $numItems);
  do
    if ! [[ $(echo "${resArr[$curID]}" | sed 's/^[ \t]*//') =~ ^Frequency ]] || ! [[ $(echo "${resArr[$(($curID + 1))]}" | sed 's/^[ \t]*//') =~ ^Quality ]] || ! [[ $(echo "${resArr[$(($curID + 2))]}" | sed 's/^[ \t]*//') =~ ^Encryption ]] || ! [[ $(echo "${resArr[$(($curID + 3))]}" | sed 's/^[ \t]*//') =~ ^ESSID ]]; then
      continue
    fi
    curFrequency="${resArr[$curID]}"
    curQuality="${resArr[$(($curID + 1))]}"
    curEncryption="${resArr[$(($curID + 2))]}"
    curESSID="${resArr[$(($curID + 3))]}"
    echo "$curESSID" | grep "x00" > /dev/null 2>&1
    if [ $? -eq 0 ] || [ -z "$curESSID" ]; then
      continue
    fi
    curFrequency="$(echo $curFrequency | cut -d":" -f2- | cut -d"(" -f1 | xargs -0)"
    curQualityNum="$(echo $curQuality | cut -d"=" -f2- | cut -d"/" -f1 | xargs -0)"
    curSignal="$(echo $curQuality | rev | cut -d"=" -f1 | rev | xargs -0)"
    curSignalNum="$(echo $curSignal | cut -d" " -f1 | xargs -0)"
    curEncryption="$(echo $curEncryption | cut -d":" -f2 | xargs -0)"
    if [ "$curEncryption" = "off" ]; then
      curEncryption="open"
    elif [ "$curEncryption" = "on" ]; then
      curEncryption=""
    else
      curEncryption="unknown"
    fi
    curESSID="$(echo $curESSID | cut -d":" -f2- | tr -d '"' | xargs -0)"
    fmtArr+=( "$curESSID|$curQualityNum|$curSignal|$curFrequency|$curEncryption" )
    echo "$curQualityNum $curSignalNum $curIndex" >> /tmp/wifi.txt
    ((curIndex+=1))
  done
  sort -k1 -k2 -rn </tmp/wifi.txt > /tmp/wifi-sorted.txt
  readarray -t sortedArr < /tmp/wifi-sorted.txt
  echo "----------------------------------------------------------------"
  echo "       SSID          Quality     Signal     Frequency    Open   "
  echo "----------------------------------------------------------------"
  for curLine in "${sortedArr[@]}"
  do
    curIndex=$(echo "$curLine" | rev | cut -d" " -f1 | rev)
    curESSID=$(echo "${fmtArr[$curIndex]}" | cut -d"|" -f1)
    curQualityNum=$(echo "${fmtArr[$curIndex]}" | cut -d"|" -f2)/70
    curSignal=$(echo "${fmtArr[$curIndex]}" | cut -d"|" -f3)
    curFrequency=$(echo "${fmtArr[$curIndex]}" | cut -d"|" -f4)
    curEncryption=$(echo "${fmtArr[$curIndex]}" | cut -d"|" -f5)
    if [ -z "$curESSID" ]; then
      continue
    fi
    printf "%-20s  %-8s  %-10s  %-12s %-9s\n" "${curESSID:0:20}" "${curQualityNum:0:6}" "${curSignal:0:10}" "${curFrequency:0:10}" "${curEncryption:0:8}"
  done
  echo "----------------------------------------------------------------"
  IFS=$OLDIFS
  rm -f /tmp/wifi.txt
  rm -f /tmp/wifi-sorted.txt
}

function addUpdateWifiAccessPoint()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  wifiSSID="$2"
  wifiPass="$3"
  set +e
  if [ -z "$wifiSSID" ]; then
    echo "ERROR: The wifi SSID cannot be blank. No actions were performed."
    return 1
  elif ! [ -z "$wifipass" ] && ([ ${#wifiPass} -lt 8 ] || [ ${#wifiPass} -gt 63 ]); then
    echo "ERROR: The wifi password must be between 8 and 63 characters. No actions were performed."
    return 2
  fi
  sudo netplan get | yq '.network.wifis | keys' | grep $interfaceName > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "ERROR: This wireless interface was not found within netplan. First try adding the interface."
    return 3
  fi
  sudo netplan get "network.wifis.${interfaceName}.access-points" | yq 'keys' | grep "$wifiSSID" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    if [ $(sudo netplan get "network.wifis.${interfaceName}.access-points" | yq 'keys' | wc -l) -eq 1 ]; then
      # This is the only access point, and we only need to update the password
      # Since netplan is so poorly designed, we (stupidly) have to remove and re-add the entire interface
      # Unfortunately, this will cause any other edits in netplan by the user will be lost.
      # This is so clumsy and dumb.
      if [ "$(sudo netplan get network.wifis.wlp2s0.dhcp4)" = "true" ]; then
        sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null"
        setAsWirelessDHCP "$interfaceName" "$wifiSSID" "$wifiPass"
      else
        ipaddr=$(sudo netplan get "network.wifis.${interfaceName}" | yq .addresses[0])
        if [ $? -ne 0 ] || [ -z "$ipaddr" ]; then
          echo "ERROR: There was a problem updating the password. Please remove this interface and re-add it with the updated password."
          return 4
        fi
        iponly=$(echo $ipaddr | cut -d"/" -f1)
        if [ $? -ne 0 ] || [ -z "$iponly" ]; then
          echo "ERROR: There was a problem updating the password. Please remove this interface and re-add it with the updated password."
          return 5
        fi
        cidr=$(echo $ipaddr | cut -d"/" -f2)
        if [ $? -ne 0 ] || [ -z "$cidr" ]; then
          echo "ERROR: There was a problem updating the password. Please remove this interface and re-add it with the updated password."
          return 6
        fi
        gateway=$(sudo netplan get "network.wifis.${interfaceName}" | yq .routes[0].via)
        if [ $? -ne 0 ] || [ -z "$gateway" ]; then
          echo "ERROR: There was a problem updating the password. Please remove this interface and re-add it with the updated password."
          return 7
        fi
        sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null"
        setAsWirelessStaticIP "$interfaceName" "$iponly" "$cidr" "$gateway" "$wifiSSID" "$wifiPass"
      fi
      return
    else
      sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.access-points.${wifiSSID}=null"
    fi
  fi
  if [ -z "$wifipass" ]; then
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.access-points.${wifiSSID}={}"
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.access-points.${wifiSSID}={auth: {key-management: psk, password: $wifiPass}}"
  fi
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function removeWifiAccessPoint()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  if ! sudo test -f /etc/netplan/${NETPLAN_ORIGIN_HINT}.yaml; then
    echo -e "\nYour netplan configuration is not managed by HSHQ. Please rename your\nconfiguration file to /etc/netplan/88-hshq.yaml in order to use this function.\n"
    return
  fi
  interfaceName="$1"
  wifiSSID="$2"
  set +e
  if [ -z "$wifiSSID" ]; then
    echo "ERROR: The wifi SSID cannot be blank. No actions were performed."
    return 1
  fi
  sudo netplan get | yq '.network.wifis | keys' | grep $interfaceName > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "ERROR: This wireless interface was not found within netplan. First try adding the interface."
    return 2
  fi
  sudo netplan get | interfaceName=$interfaceName yq '.network.wifis.[strenv(interfaceName)].access-points | keys' | grep "$wifiSSID" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "ERROR: The wireless SSID ($wifiSSID) is not a listed access point. No actions were performed."
    return 3
  fi
  numAP=$(sudo netplan get | interfaceName=$interfaceName yq '.network.wifis.[strenv(interfaceName)].access-points | keys' | wc -l)
  if [ $numAP -le 1 ]; then
    # This the last access point, must remove the interface
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}=null"
  else
    sudo netplan set --origin-hint $NETPLAN_ORIGIN_HINT "network.wifis.${interfaceName}.access-points.${wifiSSID}=null"
  fi
  sudo netplan apply
  sleep $NETPLAN_APPLY_WAIT
  checkUpdateSingleHostInterface "$interfaceName"
}

function getAllNetworkInterfacesCSV()
{
  set +e
  allInterfaces=($(ls /sys/class/net | grep -v -E "veth.*|docker.*|lo|vpn-*|ext-*"))
  timeout 10 docker network ls > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    dockerNets=($(docker network ls -q))
    networksArr=()
    for curNet in "${dockerNets[@]}"
    do
      brName=$(docker network inspect $curNet | jq -r '.[] | .Options."com.docker.network.bridge.name"')
      if [ -z "$brName" ] || [ "$brName" = "null" ]; then
        brName="br-${curNet}"
      fi
      networksArr+=($brName)
    done
  fi
  allInts=""
  for curInt in "${allInterfaces[@]}"
  do
    isFound=false
    for curNet in "${networksArr[@]}"
    do
      if [ "$curNet" = "$curInt" ]; then
        isFound=true
        break
      fi
    done
    if [ "$isFound" = "false" ]; then
      if [ -z "$allInts" ]; then
        allInts="$curInt"
      else
        allInts="${allInts},$curInt"
      fi
    fi
  done
  echo "$allInts"
}

function outputAllNetworkInterfaces()
{
  allInterfacesArr=($(echo "$(getAllNetworkInterfacesCSV)" | tr "," "\n")) 

  for curInt in "${allInterfacesArr[@]}"
  do
    ifconfig $curInt
  done
}

function checkIsPrimaryInterfacePrivate()
{
  checkIsIPPrivate "$(getPlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_IP)"
}

function setHostInternetTrafficWGInterface()
{
  if [ "$(checkIsPrimaryInterfacePrivate)" = "false" ]; then
    echo "Your HomeServer primary interface is a public static IP address. This option is not available."
    return
  fi
  set +e
  selWG="$1"
  curInt=$(getPlaintextRootConfigVar HOST_INTERNET_TRAFFIC_INTERFACE)
  if [ "$curInt" = "$selWG" ]; then
    strMsg="This is already the current interface, no changes were made."
    echo "$strMsg"
    return
  fi
  if ! [ "$selWG" = "default" ]; then
    if ! sudo test -f $HSHQ_WIREGUARD_DIR/internet/${selWG}.conf; then
      strMsg="Could not find WireGuard interface ($selWG)"
      echo "$strMsg"
      logHSHQEvent error "setHostInternetTrafficWGInterface - $strMsg"
      return 1
    fi
    rTable=$(getConfigVarFromFile \#ROUTING_TABLE_ID $HSHQ_WIREGUARD_DIR/internet/${selWG}.conf root)
    if [ -z "$rTable" ]; then
      strMsg="Could not determine routing table ($selWG)"
      echo "$strMsg"
      logHSHQEvent error "setHostInternetTrafficWGInterface - $strMsg"
      return 2
    fi
  fi
  sudo ip rule delete priority 8000 > /dev/null 2>&1
  while [ $? -eq 0 ]
  do
    sudo ip rule delete priority 8000 > /dev/null 2>&1
  done
  if ! [ "$selWG" = "default" ]; then
    sudo ip rule add not fwmark $rTable table $rTable priority 8000
  fi
  HOST_INTERNET_TRAFFIC_INTERFACE="$selWG"
  updatePlaintextRootConfigVar HOST_INTERNET_TRAFFIC_INTERFACE $HOST_INTERNET_TRAFFIC_INTERFACE
}

function initHSHQDB()
{
  sudo rm -f $HSHQ_DB
  sqlite3 $HSHQ_DB "create table connections(ID integer not null primary key autoincrement,Name text,EmailAddress text,ConnectionType text,NetworkType text,PublicKey text,PresharedKey text,IPAddress text,IsInternet boolean,InterfaceName text,EndpointHostname text,EndpointIP text default null,LastUpdated datetime,Network_Subnet text default null,IsExposeToNetwork boolean,InputAllowPorts text default null,DockerUserAllowPorts text default null);"
  sqlite3 $HSHQ_DB "create table mailhosts(ID integer not null primary key autoincrement,MailHost text not null);"
  sqlite3 $HSHQ_DB "create table hsvpn_connections(ID integer not null primary key references connections(ID) on delete cascade,HomeServerName text,IsPrimary boolean,DomainName text default null,ExternalPrefix text default null,InternalPrefix text default null,MailHostID integer references mailhosts(ID) on delete cascade,CA_Abbrev text default null,CA_IP text default null,CA_Subdomain text default null,CA_URL text default null,RS_VPN_IP text default null);"
  sqlite3 $HSHQ_DB "create table hsvpn_dns(ID integer not null primary key autoincrement,HostDomain text not null,PeerDomain text not null,PeerDomainExtPrefix text not null,IPAddress text not null,DateAdded datetime,IsActive boolean);"
  sqlite3 $HSHQ_DB "create unique index hpdns on hsvpn_dns(HostDomain,PeerDomain);"
  sqlite3 $HSHQ_DB "create table mailhostmap(MailHostID integer not null references mailhosts(ID) on delete cascade,Domain text not null,IsFirstDomain boolean,primary key (MailHostID,Domain));"
  sqlite3 $HSHQ_DB "create table lecertdomains(Domain text primary key,BaseDomain text not null);"
  sqlite3 $HSHQ_DB "create table exposedomains(Domain text primary key,BaseDomain text not null);"
  sqlite3 $HSHQ_DB "create table customfwsubnet(ID integer not null primary key autoincrement,Name text not null, Subnet text not null, InputAllowPorts text default null, DockerUserAllowPorts text default null);"
  sudo chmod 640 $HSHQ_DB
  sudo chown root $HSHQ_DB
}

function getWGNameFromIP()
{
  check_ip=$1
  echo $(sqlite3 $HSHQ_DB "select Name from connections where IPAddress='$check_ip';")
}

function getWGNameFromPubkey()
{
  check_key=$1
  echo $(sqlite3 $HSHQ_DB "select Name from connections where PublicKey='$check_key';")
}

function checkInterfaceNameExists()
{
  check_iface="$1"
  ifaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where InterfaceName='$check_iface';")
  if [ -z "$ifaceName" ]; then
    echo "false"
  else
    echo "true"
  fi
}

function checkValidWireGuardKey()
{
  # Thank you gjoranv: https://stackoverflow.com/questions/74438436/how-to-validate-a-wireguard-public-key
  check_key=$1
  keyregex="^[A-Za-z0-9+/]{42}[AEIMQUYcgkosw480]=$"
  if [[ $check_key =~ $keyregex ]]; then
    echo "true"
  else
    echo "false"
  fi
}

function isIPInSubnet()
{
  iiis_curE=${-//[^e]/}
  check_ipaddr=$1
  check_subnet=$2
  if [ -z "$check_ipaddr" ] || [ -z "$check_subnet" ]; then
    echo "true"
    return
  fi
  set +e
  grepcidr ${check_subnet} <(echo ${check_ipaddr}) > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
  set +e
  if ! [ -z "$iiis_curE" ]; then
    set -e
  fi
}

function getRandomVPNIP()
{
  # This function is specific to a /24 sized subnet.
  # It should be improved to a more general case based on the size of the network.
  vpnbase=$(echo $PRIMARY_VPN_SUBNET | rev | cut -d "." -f2- | rev)
  numvpnipTries=1
  maxvpnipTries=88
  while [ $numvpnipTries -lt $maxvpnipTries ]
  do
    randIP=${vpnbase}.$(($(($RANDOM%250))+1))
    if [ -z "$(getWGNameFromIP $randIP)" ]; then
      echo $randIP
      return
    fi
    ((numvpnipTries++))
  done
  # Just start at the beginning...
  ip_host_part=1
  while [ $ip_host_part -le 250 ]
  do
    randIP=${vpnbase}.$ip_host_part
    if [ -z "$(getWGNameFromIP $randIP)" ]; then
      echo $randIP
      return
    fi
    ((ip_host_part++))
  done
  # The network is full. Caller needs to handle this.
  echo ""
}

function getRandomWireGuardIP()
{
  numRIPTries=1
  maxRIPTries=1000
  while [ $numRIPTries -lt $maxRIPTries ]
  do
    randIP=10.$(( $RANDOM % 256 )).$(( $RANDOM % 256 )).$(($(($RANDOM%250))+1))
    if [ "$(isIPInSubnet $randIP $PRIMARY_VPN_SUBNET)" = "false" ] && [ -z "$(getWGNameFromIP $randIP)" ]; then
      echo $randIP
      return
    fi
    ((numRIPTries++))
  done
  echo ""
}

function checkNetworkIntersect()
{
  net1=$1
  net2=$2
  if [ -z "$net1" ] || [ -z "$net2" ]; then
    echo "true"
    return
  fi
  net1_beginip=$(sipcalc $net1 | grep "^Network range" | rev | cut -d " " -f3 | rev)
  net1_endip=$(sipcalc $net1 | grep "^Network range" | rev | cut -d " " -f1 | rev)
  is_in_subnet=$(isIPInSubnet $net1_beginip $net2)
  if [ "$is_in_subnet" = "true" ]; then
    echo "true"
    return
  fi
  is_in_subnet=$(isIPInSubnet $net1_endip $net2)
  if [ "$is_in_subnet" = "true" ]; then
    echo "true"
    return
  fi
  net2_beginip=$(sipcalc $net2 | grep "^Network range" | rev | cut -d " " -f3 | rev)
  net2_endip=$(sipcalc $net2 | grep "^Network range" | rev | cut -d " " -f1 | rev)
  is_in_subnet=$(isIPInSubnet $net2_beginip $net1)
  if [ "$is_in_subnet" = "true" ]; then
    echo "true"
    return
  fi
  is_in_subnet=$(isIPInSubnet $net2_endip $net1)
  if [ "$is_in_subnet" = "true" ]; then
    echo "true"
    return
  fi
  echo "false"
}

function isNetworkIntersectOurNetworks()
{
  checkNetwork=$1
  checkAll=$2
  checkHostInterfaceSubnets=$3
  checknet_ip=$(echo $checkNetwork | cut -d"/" -f1)
  if [ "$(checkValidIPAddress $checknet_ip)" = "false" ]; then
    echo "ERROR: Invalid IP address/subnet."
    return
  fi
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  vpn_arr=($(sqlite3 $HSHQ_DB "select connections.Network_Subnet,hsvpn_connections.HomeServerName from connections join hsvpn_connections on connections.ID = hsvpn_connections.ID where connections.Network_Subnet is not null;"))
  for curvpncheck in "${vpn_arr[@]}"
  do
    curvpn=$(echo "$curvpncheck" | cut -d "|" -f1)
    curhsname=$(echo "$curvpncheck" | cut -d "|" -f2)
    if [ "$(checkNetworkIntersect $curvpn $checkNetwork)" = "true" ]; then
      echo "The requested subnet ($checkNetwork) collides with ${curhsname} VPN subnet ($curvpn)"
      IFS=$OLDIFS
      return
    fi
  done
  if [ "$checkHostInterfaceSubnets" = "true" ] || [ "$checkAll" = "true" ]; then
    hsnet_arr=($(sqlite3 $HSHQ_DB "select Network_Subnet,Name from connections where NetworkType='home_network';"))
    for curhscheck in "${hsnet_arr[@]}"
    do
      curhsnet=$(echo "$curhscheck" | cut -d "|" -f1)
      curhsname=$(echo "$curhscheck" | cut -d "|" -f2)
      if [ -z "$curhsnet" ]; then
        continue
      fi
      if [ "$(checkNetworkIntersect $curhsnet $checkNetwork)" = "true" ]; then
        echo "The requested subnet ($checkNetwork) collides with a HomeServer host interface subnet ($curhsname - $curhsnet)"
        IFS=$OLDIFS
        return
      fi
    done
  fi
  if [ "$checkAll" = "true" ]; then
    # Check all possible connections
    ip_arr=($(sqlite3 $HSHQ_DB "select IPAddress,Name from connections;"))
  else
    # Check only connections on this HomeServer.
    ip_arr=($(sqlite3 $HSHQ_DB "select IPAddress,Name from connections where ConnectionType='homeserver_internet' and NetworkType in ('primary','other');"))
  fi
  for curipcheck in "${ip_arr[@]}"
  do
    curip=$(echo "$curipcheck" | cut -d "|" -f1)
    curconname=$(echo "$curipcheck" | cut -d "|" -f2)
    if [ "$(checkNetworkIntersect ${curip}/32 $checkNetwork)" = "true" ]; then
      echo "The requested subnet ($checkNetwork) collides with connection ${curconname} ($curip)"
      IFS=$OLDIFS
      return
    fi
  done
  IFS=$OLDIFS
  echo ""
}

function getNextWGRoutingTableID()
{
  rtid=100
  flist=$(sudo ls $HSHQ_WIREGUARD_DIR/internet)
  if [ -z "$flist" ]; then
    echo $rtid
    exit 0
  fi
  arr=()
  for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
  do
    if ! test -f "$conf"; then continue; fi
	arr+=($(sudo grep ^\#ROUTING_TABLE_ID= $conf | sed 's/^[^=]*=//'))
  done
  while true;
  do
    echo ${arr[@]} | grep $rtid > /dev/null
	if [[ $? -ne 0 ]]; then
	  break
	else
	  rtid=$(($rtid+1))
	fi
  done
  echo $rtid
}

function getNextAvailableWGDockerNetwork()
{
  docker_network_name=$1
  conn_mtu=$2
  docker network create --driver=bridge $docker_network_name > /dev/null 2>&1
  docker_subnet=$(getDockerSubnet $docker_network_name)
  docker network rm $docker_network_name > /dev/null 2>&1
  docker network create $docker_network_name --driver=bridge --subnet $docker_subnet -o com.docker.network.driver.mtu=$conn_mtu -o com.docker.network.bridge.name=$docker_network_name > /dev/null 2>&1
  echo $docker_subnet
}

function getWGPortalAuth()
{
  echo "$(echo $(echo -n ${RELAYSERVER_WGPORTAL_ADMIN_EMAIL}:${RELAYSERVER_WGPORTAL_ADMIN_PASSWORD} | base64) | sed 's| ||g')"
}

function getCACertificateNameFromDomain()
{
  dom_name="$1"
  echo ${dom_name}-ca.crt
}

function sortCSVList()
{
  inCSVList="$1"
  if [ -z "$inCSVList" ]; then
    echo ""
    return
  fi
  inCSVArr=($(echo $inCSVList | tr "," "\n"))
  OLDIFS=$IFS
  IFS=$'\n'
  sortedCSVArr=($(sort <<< "${inCSVArr[*]}"))
  IFS=$OLDIFS
  sortedCSVList=""
  for curItem in "${sortedCSVArr[@]}"
  do
    if [ -z "$curItem" ]; then continue; fi
    sortedCSVList="${sortedCSVList}${curItem},"
  done
  if ! [ -z "$sortedCSVList" ]; then
    sortedCSVList=${sortedCSVList%?}
  fi
  echo "$sortedCSVList"
}

function getPortainerToken()
{
  local OPTIND opt u p
  while getopts ':u:p:' opt; do
    case "$opt" in
      u)
        port_username="$OPTARG" ;;
      p)
        port_password="$OPTARG" ;;
      ?|h)
        return 1;;
    esac
  done
  shift "$(($OPTIND -1))"
  set +e
  # Portainer sometimes exhibits issues with API, so we'll add some error handling and restart capabilities.
  cur_timeout=5
  ptok_retVal=1
  ptok_numTries=1
  while [ $cur_timeout -le 30 ]
  do
    ptok_full=$(http --check-status --ignore-stdin --timeout=$cur_timeout --verify=no https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/auth username=$port_username password=$port_password)
    ptok_retVal=$?
    if [ $ptok_retVal -eq 0 ] && ! [ -z "$ptok_full" ]; then
      # Do a sample query
      ptok=$(echo $ptok_full | jq -r .jwt)
      qry=$(http --check-status --ignore-stdin --verify=no --timeout=$cur_timeout --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $ptok" endpointId==1)
      if [ $? -eq 0 ]; then
        break
      fi
      ptok_retVal=1
    fi
    echo "Could not obtain Portainer token, restarting stack ($ptok_numTries of 6)..." 1>&2
    restartPortainer 1>&2
    cur_timeout=$((cur_timeout+5))
    ((ptok_numTries++))
  done
  # Probably going to need to implement full error handling for this type of issue.
  if [ $ptok_retVal -ne 0 ]; then
    return 1
  fi
  echo $ptok
}

function getStackID()
{
  stackID="NA"
  stackName=$1
  stackName="${stackName//.}"
  portainerToken=$2
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  gsid_numTries=1
  gsid_totalTries=5
  gsid_retVal=1
  qry=""
  while [ $gsid_numTries -le $gsid_totalTries ]
  do
    qry=$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1)
    gsid_retVal=$?
    if [ $gsid_retVal -eq 0 ]; then
      break
    fi
    ((gsid_numTries++))
  done
  if [ $gsid_retVal -ne 0 ]; then
    echo "ERROR: Could not obtain stack ID from Portainer..." 1>&2
    return
  fi
  for row in $(echo "${qry}" | jq -r '.[] | @base64'); do
    _jq()
    {
      echo ${row} | base64 --decode | jq -r ${1}
    }
    if [ $(_jq '.Name') = $stackName ]; then
      stackID=$(_jq '.Id')
	  break
    fi
  done
  if ! [ $stackID = "NA" ]; then
    echo $stackID
  fi
}

function updateStackByID()
{
  update_stack_name=$1
  update_stack_id=$2
  update_compose_file=$3
  update_env_file=$4
  portainerToken=$5

  echo "{$( jq -Rscjr '{StackFileContent: . }' $update_compose_file | tail -c +2 | head -c -1 ),\"Env\":$(envToJson $update_env_file)}" > $HOME/${update_stack_name}-json.tmp
  usid_numTries=1
  usid_totalTries=5
  usid_retVal=1
  while [ $usid_numTries -le $usid_totalTries ]
  do
    http --check-status --ignore-stdin --verify=no --timeout=300 PUT https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$update_stack_id "Authorization: Bearer $portainerToken" endpointId==1 @$HOME/${update_stack_name}-json.tmp > /dev/null 2>&1
    usid_retVal=$?
    if [ $usid_retVal -eq 0 ]; then
      break
    fi
    ((usid_numTries++))
  done
  if [ $usid_retVal -ne 0 ]; then
    echo "ERROR: Could not update stack in Portainer..." 1>&2
    return
  fi
  rm -f $update_compose_file $update_env_file $HOME/${update_stack_name}-json.tmp
}

function restartAllStacksDialog()
{
  set +e
  showYesNoMessageBox "Confirm Restart Stacks" "This action will shut down all running stacks, restart the docker daemon, then restart the stacks that were stopped. Depending on the number of stacks, it could take up to 10-15 minutes to complete. Continue?"
  if [ $? -ne 0 ]; then
    return 0
  fi
  sudo -k
  refreshSudo
  restartAllStacks
}

function restartAllStacks()
{
  ras_curE=${-//[^e]/}
  set +e
  skipRestart="$1"
  isOnlyHSHQManaged="$2"
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  startStopStack uptimekuma stop "$portainerToken"

  rsi_numTries=1
  rsi_totalTries=5
  rsi_retVal=1
  rstackIDsQry=""
  while [ $rsi_numTries -le $rsi_totalTries ]
  do
    rstackIDsQry=$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1)
    rsi_retVal=$?
    if [ $rsi_retVal -eq 0 ]; then
      break
    fi
    ((rsi_numTries++))
  done
  if [ $rsi_retVal -ne 0 ]; then
    echo "ERROR: Could not get list of stack IDs in Portainer..." 1>&2
    return
  fi
  rstackIDs=($(echo $rstackIDsQry | jq -r '.[] | select(.Status == 1) | .Id'))
  rstackNames=($(echo $rstackIDsQry | jq -r '.[] | select(.Status == 1) | .Name'))

  numItems=$((${#rstackIDs[@]} - 1))
  for curID in $(seq 0 $numItems);
  do
    echo "Stopping ${rstackNames[$curID]} (${rstackIDs[$curID]})..."
    startStopStackByID ${rstackIDs[$curID]} stop $portainerToken
    sleep 1
  done
  stopPortainer
  removeDockerNetworks
  sudo docker ps -q | xargs sudo docker stop
  docker container prune -f
  echo "Restarting Docker..."
  sudo systemctl restart docker
  createDockerNetworks
  startPortainer
  total_tries=10
  num_tries=1
  sleep 5
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  retVal=$?
  while [ $retVal -ne 0 ] && [ $num_tries -lt $total_tries ]
  do
    echo "Error getting portainer token, retrying ($(($num_tries + 1)) of $total_tries)..."
    sleep 5
    ((num_tries++))
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
    retVal=$?
  done
  if [ $retVal -ne 0 ]; then
    echo "Error getting portainer token, exiting..."
    exit 1
  fi

  for curID in $(seq 0 $numItems);
  do
    if ! [ -z "$skipRestart" ]; then
      echo "$skipRestart" | grep ,${rstackNames[$curID]} > /dev/null 2>&1 || echo "$skipRestart" | grep ${rstackNames[$curID]}, > /dev/null 2>&1
      retVal_1=$?
      retVal_2=1
      if [ "$isOnlyHSHQManaged" = "true" ] && ! [ "$(isStackHSHQManaged ${rstackIDs[$curID]})" = "true" ]; then
        retVal_2=0
      fi
      if [ $retVal_1 -eq 0 ] || [ $retVal_2 -eq 0 ]; then
        echo "Skipping ${rstackNames[$curID]} (${rstackIDs[$curID]})..."
        continue
      fi
    fi
    echo "Starting ${rstackNames[$curID]} (${rstackIDs[$curID]})..."
    startStopStackByID ${rstackIDs[$curID]} start $portainerToken
    sleep 3
  done
  startStopStack uptimekuma start "$portainerToken"
  if ! [ -z "$ras_curE" ]; then
    set -e
  fi
}

function isStackHSHQManaged()
{
  stackID=$1
  check_stack_firstline=$(sudo sed -n 1p $HSHQ_STACKS_DIR/portainer/compose/$stackID/docker-compose.yml)
  echo "$(checkStackHSHQManaged $check_stack_firstline)"
}

function updateGlobalVarsEnvFile()
{
  curEnv=$1
  sed -i '/^HSHQ_BASE_DIR=/d' $curEnv
  sed -i '/^HSHQ_DATA_DIR=/d' $curEnv
  sed -i '/^HSHQ_BACKUP_DIR=/d' $curEnv
  sed -i '/^HSHQ_NONBACKUP_DIR=/d' $curEnv
  sed -i '/^HSHQ_ASSETS_DIR=/d' $curEnv
  sed -i '/^HSHQ_BUILD_DIR=/d' $curEnv
  sed -i '/^HSHQ_CONFIG_DIR=/d' $curEnv
  sed -i '/^HSHQ_LIB_DIR=/d' $curEnv
  sed -i '/^HSHQ_RELAYSERVER_DIR=/d' $curEnv
  sed -i '/^HSHQ_SCRIPTS_DIR=/d' $curEnv
  sed -i '/^HSHQ_SECRETS_DIR=/d' $curEnv
  sed -i '/^HSHQ_SSL_DIR=/d' $curEnv
  sed -i '/^HSHQ_STACKS_DIR=/d' $curEnv
  sed -i '/^HSHQ_WIREGUARD_DIR=/d' $curEnv
  sed -i "s|^TZ=.*|TZ=\${TZ}|g" $curEnv
}

function envToJson()
{
  # A kludgy function, but spaces and multiple equal signs in the values are just a pain...
  if [ -z "$1" ]; then
    echo "[]"
	return
  fi
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  lines="$(cat $1)"
  jsonstring="["
  for line in $lines
  do
    key="$(sed 's/=.*//' <<< "$line")"
    value="$(sed 's/^[^=]*=//' <<< "$line")"
    value="$(echo $value | sed 's/\"/\\\"/g')"
    jsonstring="$jsonstring{\"name\":\"$key\",\"value\":\"$value\"},"
  done
  jsonstring="${jsonstring%?}]"
  IFS=$OLDIFS
  echo $jsonstring
}

function extractStackToHome()
{
  extract_stack_name=$1
  extract_stack_id=$2

  sudo cp $HSHQ_STACKS_DIR/portainer/compose/$extract_stack_id/stack.env $HOME/${extract_stack_name}.env
  sudo cp $HSHQ_STACKS_DIR/portainer/compose/$extract_stack_id/docker-compose.yml $HOME/${extract_stack_name}-compose.yml
  sudo chown $USERNAME:$USERNAME $HOME/${extract_stack_name}.env
  sudo chown $USERNAME:$USERNAME $HOME/${extract_stack_name}-compose.yml
}

function updateStackEnv()
{
  updateStackName=$1
  updateModFunction=$2
  portainerToken=$3
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  updateStackID=$(getStackID $updateStackName "$portainerToken")
  if [ -z "$updateStackID" ]; then
    echo "ERROR: Could not find stack ID for $updateStackName"
    return 2
  fi
  extractStackToHome $updateStackName $updateStackID
  $updateModFunction
  rtVal=$?
  if [ $rtVal -ne 0 ]; then
    rm -f $HOME/${updateStackName}-compose.yml $HOME/${updateStackName}.env
    return $rtVal
  fi
  updateStackByID $updateStackName $updateStackID $HOME/${updateStackName}-compose.yml $HOME/${updateStackName}.env "$portainerToken"
  rm -f $HOME/${updateStackName}-compose.yml $HOME/${updateStackName}.env
}

function updateMailuStackRelayHost()
{
  echo "Updating mailu stack with new RelayServer settings..."
  updateStackEnv mailu modFunUpdateMailuRelaySettings
  # Wait for stack to come all the way up.
  search="Listening at: http://0.0.0.0:8080"
  isFound="F"
  i=0
  max_interval=300
  sleep_interval=5
  set +e
  while [ $i -le $max_interval ]
  do
    findtext=$(docker logs mailu-admin 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound="T"
      break
    fi
    echo "Container not ready, sleeping $sleep_interval second(s), total wait=$i seconds..."
    sleep $sleep_interval
    ((i=$i+$sleep_interval))
  done
  sleep 5
}

function modFunUpdateMailuRelaySettings()
{
  sed -i "s|RELAYHOST=.*|RELAYHOST=$SMTP_RELAY_HOST|" $HOME/${updateStackName}.env
  sed -i "s|RELAYUSER=.*|RELAYUSER=$SMTP_RELAY_USERNAME|" $HOME/${updateStackName}.env
  sed -i "s|RELAYPASSWORD=.*|RELAYPASSWORD=$SMTP_RELAY_PASSWORD|" $HOME/${updateStackName}.env
}

function getPasswordWithSymbol()
{
  # Generates a password with "_" inserted somewhere randomly
  # This appeases any symbol requirements that certain password policies enforce.
  pw_length=$1
  if [ -z "$pw_length" ] || [ $pw_length -lt 2 ]; then
    pw_length=32
  fi
  pw_length=$((pw_length-1))
  rand_pw=$(pwgen -c -n $pw_length 1)
  rand_pos=$(( ( RANDOM % $pw_length )  + 1 ))
  echo ${rand_pw:0:rand_pos}"@"${rand_pw:rand_pos}
}

function performExitFunctions()
{
  is_show_msgbox="$1"
  releaseLock hshqopen "performExitFunctions" false
  #unloadSSHKey
  # This is more aggressive, but cleans up any pre-existing sessions (in case the script terminated abnormally)
  set +e
  killall ssh-agent > /dev/null 2>&1
  set -e
  if ([ -z "$IS_CONFIG_INIT" ] || ! [ "$IS_INSTALLED" = "true" ]) && ! [ "$IS_CONFIG_FILE_UNENCRYPTED" = "true" ]; then
    return
  fi
  encryptConfigFile
  if [ "$is_show_msgbox" = "true" ]; then
    showMessageBox "Config File Encrypted" "The configuration file has been encrypted."
  else
    echo "=========================================="
    echo "The configuration file has been encrypted."
    echo "=========================================="
  fi
}

function encryptConfigFile()
{
  if ! [ -f $HSHQ_CONFIG_DIR/$CONFIG_FILE_DEFAULT_FILENAME ] && ! [ -f $HSHQ_CONFIG_DIR/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME]; then
    echo "ERROR: Plain text config file does not exist"
  elif ! [ -z "$CONFIG_ENCRYPTION_PASSPHRASE" ]; then
    rm -f $HSHQ_CONFIG_DIR/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
    openssl enc -e -aes256 -pbkdf2 -pass pass:$CONFIG_ENCRYPTION_PASSPHRASE -in $HSHQ_CONFIG_DIR/$CONFIG_FILE_DEFAULT_FILENAME -out $HSHQ_CONFIG_DIR/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
    if [ -f $HSHQ_CONFIG_DIR/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME ]; then
      chmod 0400 $HSHQ_CONFIG_DIR/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
      rm -f $HSHQ_CONFIG_DIR/$CONFIG_FILE_DEFAULT_FILENAME
      IS_CONFIG_FILE_UNENCRYPTED=false
    fi
  fi
}

function decryptFile()
{
  encFile=$1
  resFile=$2
  rm -f $resFile
  touch $resFile
  # Set the file permissions BEFORE decrypting...
  chmod 600 $resFile
  if [ -z "$USER_CONFIG_PW" ]; then
    openssl enc -d -aes256 -pbkdf2 -in $encFile >> $resFile 2>/dev/null
  else
    openssl enc -d -aes256 -pbkdf2 -in $encFile -pass file:<( echo -n "$USER_CONFIG_PW" ) >> $resFile 2>/dev/null
  fi
  retVal=$?
  if [ $retVal -ne 0 ]; then
    rm -f $resFile
  fi
  return $retVal
}

function decryptConfigFile()
{
  encConfig=$1
  if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
    IS_CONFIG_FILE_UNENCRYPTED=true
    set -e
    return
  fi
  set +e
  decrypt_res=1
  while [ $decrypt_res -ne 0 ]
  do 
    decryptFile $encConfig $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
    decrypt_res=$?
    if [ $decrypt_res -ne 0 ]; then
      echo "Decryption error, bad password"
      rm -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
      showYesNoMessageBox "Password Error" "You did not enter the correct password, try again?"
      if [ $? -ne 0 ]; then
        releaseLock hshqopen "decryptConfigFile" false
        exit 1
      fi
    fi
  done
  mv -f $encConfig $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_BACKUP_FILENAME
  CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
  IS_CONFIG_FILE_UNENCRYPTED=true
  set -e
}

function decryptConfigFileAndLoadEnvNoPrompts()
{
  if [ -z "$USER_CONFIG_PW" ]; then
    USER_CONFIG_PW="$1"
  fi
  tgLock="$(tryGetLock hshqopen User-ScriptServer)"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg hshqopen)"
    USER_CONFIG_PW=""
    echo "ERROR: The HSHQ script is already open or running in a different instance ($checkRes). This situation could occur if another scheduled process is currently running or the script exited prematurely with an error. If you are sure that this has occurred erroneously, then run the 04 System Utils -> 06 Reset Mutex Lock function to reset it."
    exit 9
  fi
  set -e
  decryptAndLoad true
}

function decryptAndLoad()
{
  ENC_CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
  if ! [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    decryptFile "$ENC_CONFIG_FILE" "$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME"
    mv -f $ENC_CONFIG_FILE $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_BACKUP_FILENAME
  fi
  USER_CONFIG_PW=""
  CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME
  if ! [ -f $CONFIG_FILE ]; then
    echo "There was a critical error with the configuration file, exiting..."
    exit 9
  fi
  IS_CONFIG_FILE_UNENCRYPTED=true
  loadConfigVars "$1"
}

function checkDecryptConfigFile()
{
  if [ -z "$USER_CONFIG_PW" ]; then
    USER_CONFIG_PW="$1"
  fi
  set +e
  if ! [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME ]; then
      DEF_ENC_CONFIG_FILE=$CONFIG_FILE_DEFAULT_LOCATION/$ENCRYPTED_CONFIG_FILE_DEFAULT_FILENAME
    else
      echo "ERROR: Could not find encrypted configuration file."
      return 2
    fi
    if ! [ -z "$DEF_ENC_CONFIG_FILE" ]; then
      openssl enc -d -aes256 -pbkdf2 -in "$DEF_ENC_CONFIG_FILE" -pass file:<( echo -n "$USER_CONFIG_PW" ) > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "bad"
        echo "ERROR: Incorrect password for encrypted configuration file."
        return 3
      else
        echo "good"
      fi
    else
      echo "ERROR: Unknown error decrypting configuration file."
      exit 4
    fi
  fi
}

function promptTestDecryptConfigFile()
{
  if ! [ -z "$USER_CONFIG_PW" ]; then
    checkDecryptConfigFile > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      USER_CONFIG_PW=""
    fi
  fi
  while [ -z "$USER_CONFIG_PW" ]
  do
    USER_CONFIG_PW=$(promptPasswordMenu "Enter Decrypt Password" "Enter your config decrypt password: ")
    retVal=$?
    if [ $retVal -ne 0 ]; then
      return 3
    fi
    checkDecryptConfigFile > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      showMessageBox "Incorrect Password" "The password is incorrect, please re-enter it."
      USER_CONFIG_PW=""
    fi
  done
  decryptAndLoad false
  USER_CONFIG_PW=""
}

function checkFileShellExpansion()
{
  cfse_curE=${-//[^e]/}
  check_file=$1
  set +e
  retVal=""
  grep '\$' $check_file > /dev/null 2>&1
  retDS=$?
  grep '\~' $check_file > /dev/null 2>&1
  retTD=$?
  grep '\*' $check_file > /dev/null 2>&1
  retAS=$?
  if [ $retDS -eq 0 ] || [ $retTD -eq 0 ] || [ $retAS -eq 0 ]; then
    retVal=$retVal"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n"
    retVal=$retVal"@               Shell expansion attempt detected!              @\n"
    retVal=$retVal"@            Check the sender of this configuration.           @\n"
    retVal=$retVal"@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n"
  else
    echo ""
  fi
  if ! [ -z "$cfse_curE" ]; then
    set -e
  fi
  echo "$retVal"
}

function createStackJson()
{
  echo "{\"Name\":\"$1\",""$( jq -Rscjr '{StackFileContent: . }' $2 | tail -c +2 | head -c -1 )"",\"Env\":"$(envToJson $3)"}"
}

function installStack()
{
  set +e
  stack_name=$1
  container_name=$2
  stack_search_string=$3
  envfile=$4
  sleep_interval=$5
  max_interval=$6

  if [ -z "$sleep_interval" ]; then
    sleep_interval=1
  fi
  if [ -z "$max_interval" ]; then
    max_interval=300
  fi
  logHSHQEvent info "installStack - Installing Stack ($stack_name)"
  # Refresh the sudo timestamp
  refreshSudo
  if [ -z "$PORTAINER_TOKEN" ]; then
    PORTAINER_TOKEN="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  echo "Creating stack: $stack_name"
  set -f
  echo "$(createStackJson $stack_name $HOME/$stack_name-compose.yml "$envfile")" > $HOME/$stack_name-json.tmp
  set +f
  sleep 1
  ins_numTries=1
  ins_totalTries=5
  ins_retVal=1
  while [ $ins_numTries -le $ins_totalTries ]
  do
    if [ "$IS_STACK_DEBUG" = "true" ] || [ $ins_numTries -eq $ins_totalTries ]; then
      http --check-status --ignore-stdin --verify=no --timeout=300 https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/create/standalone/string "Authorization: Bearer $PORTAINER_TOKEN" endpointId==1 @$HOME/$stack_name-json.tmp
    else
      http --check-status --ignore-stdin --verify=no --timeout=300 https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/create/standalone/string "Authorization: Bearer $PORTAINER_TOKEN" endpointId==1 @$HOME/$stack_name-json.tmp >/dev/null
    fi
    ins_retVal=$?
    if [ $ins_retVal -eq 0 ]; then
      break
    fi
    ((ins_numTries++))
  done
  if [ $ins_retVal -ne 0 ]; then
    logHSHQEvent error "installStack - Error installing stack ($stack_name)"
    echo "ERROR: Could not install stack ($stack_name) in Portainer..." 1>&2
    return $ins_retVal
  fi
  sleep 1
  search=$stack_search_string
  isFound=false
  i=0
  while [ $i -le $max_interval ]
  do
    findtext=$(docker logs $container_name 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping $sleep_interval second(s), total wait=$i seconds..."
    sleep $sleep_interval
    ((i=$i+$sleep_interval))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "$stack_name did not start up correctly..."
    return 1
  fi
  set -e
  sleep 1
  rm -f $HOME/$stack_name-json.tmp
  rm -f $HOME/$stack_name-compose.yml
  rm -f $envfile
}

function startStopStack()
{
  stackname=$1
  startStop=$2
  portainerToken=$3
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  stackID=$(getStackID $stackname "$portainerToken")
  if [ -z "$stackID" ]; then
    return
  fi
  startStopStackByID $stackID $startStop $portainerToken
}

function startStopStackByID()
{
  stackID=$1
  startStop=$2
  portainerToken=$3
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  sss_numTries=1
  sss_totalTries=5
  sss_retVal=1
  while [ $sss_numTries -le $sss_totalTries ]
  do
    if [ "$IS_STACK_DEBUG" = "true" ] || [ $sss_numTries -eq $sss_totalTries ]; then
      http --check-status --ignore-stdin --verify=no --timeout=300 POST https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$stackID/$startStop "Authorization: Bearer $portainerToken" endpointId==1
    else
      http --check-status --ignore-stdin --verify=no --timeout=300 POST https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$stackID/$startStop "Authorization: Bearer $portainerToken" endpointId==1 > /dev/null
    fi
    sss_retVal=$?
    if [ $sss_retVal -eq 0 ]; then
      break
    fi
    sleep 1
    sudo docker container prune -f
    sleep 1
    ((sss_numTries++))
  done
  if [ $sss_retVal -ne 0 ]; then
    echo "ERROR: Could not $startStop stack (ID=$stackID) in Portainer..." 1>&2
    return
  fi
}

function restartStackIfRunning()
{
  stackName=$1
  waitTime=$2
  portainerToken=$3
  if [ "$stackName" = "portainer" ]; then
    # Special case for portainer
    restartPortainer
    return
  fi
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  stackID=$(getStackID $stackName "$portainerToken")
  if [ -z "$stackID" ]; then
    return
  fi
  stackStatus=$(getStackStatusByID $stackID "$portainerToken")
  if [ "$stackStatus" = "1" ]; then
    startStopStackByID $stackID stop $portainerToken
    sleep $waitTime
    startStopStackByID $stackID start $portainerToken
  fi
}

function forceRestartStack()
{
  stackName=$1
  waitTime=$2
  portainerToken=$3
  if [ "$stackName" = "portainer" ]; then
    # Special case for portainer
    restartPortainer
    return
  fi
  set +e
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  stackID=$(getStackID $stackName "$portainerToken")
  if [ -z "$stackID" ]; then
    return
  fi
  set +e
  startStopStackByID $stackID stop $portainerToken
  sleep $waitTime
  startStopStackByID $stackID start $portainerToken
}

function getStackStatusByID()
{
  stackID=$1
  portainerToken=$2
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  gss_numTries=1
  gss_totalTries=5
  gss_retVal=1
  stackStatus=""
  while [ $gss_numTries -le $gss_totalTries ]
  do
    stackStatus=$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$stackID "Authorization: Bearer $portainerToken" endpointId==1)
    gss_retVal=$?
    if [ $gss_retVal -eq 0 ]; then
      break
    fi
    ((gss_numTries++))
  done
  if [ $gss_retVal -ne 0 ]; then
    echo "ERROR: Could not get stack status from Portainer..." 1>&2
    return
  fi
  echo $stackStatus | jq -r '.Status'
}

function getStackStatusByName()
{
  stackName=$1
  portainerToken=$2
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  stackID=$(getStackID $stackName "$portainerToken")
  if [ -z "$stackID" ]; then
    return
  fi
  stackStatus=$(getStackStatusByID $stackID "$portainerToken")
  echo $stackStatus
}

function deleteStack()
{
  stackname=$1
  portainerToken=$2
  if [ -z "$portainerToken" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
  stackID=$(getStackID $stackname "$portainerToken")
  if [ -z "$stackID" ]; then
    return
  fi
  ds_numTries=1
  ds_totalTries=5
  ds_retVal=1
  while [ $ds_numTries -le $ds_totalTries ]
  do
    http --check-status --ignore-stdin --verify=no --timeout=300 DELETE https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$stackID "Authorization: Bearer $portainerToken" endpointId==1 > /dev/null
    ds_retVal=$?
    if [ $ds_retVal -eq 0 ]; then
      break
    fi
    ((ds_numTries++))
  done
  if [ $ds_retVal -ne 0 ]; then
    echo "ERROR: Could not delete stack from Portainer..." 1>&2
    return
  fi
}

function waitForStack()
{
  searchText="$1"
  containerName="$2"
  max_interval=$3
  sleep_interval=$4
  wfs_curE=${-//[^e]/}
  set +e
  if [ -z "$max_interval" ]; then
    max_interval=300
  fi
  if [ -z "$sleep_interval" ]; then
    sleep_interval=5
  fi
  isStackReady="false"
  i=0
  while [ $i -le $max_interval ]
  do
    findtext=$(docker logs $containerName 2>&1 | grep "$searchText")
    if ! [ -z "$findtext" ]; then
      isStackReady="true"
      break
    fi
    echo "Container not ready, sleeping $sleep_interval second(s), total wait=$i seconds..."
    sleep $sleep_interval
    ((i=$i+$sleep_interval))
  done
  sleep 5
  set +e
  if ! [ -z "$wfs_curE" ]; then
    set -e
  fi
}

function waitForContainerLogString()
{
  container_name="$1"
  sleep_interval="$2"
  max_checks="$3"
  search_string="$4"
  isFound=false
  curCheckIter=0
  totalWait=0
  set +e
  echo "Checking container log ($container_name)..."
  while [ $curCheckIter -le $max_checks ]
  do
    findtext=$(docker logs $container_name 2>&1 | grep "$search_string")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping $sleep_interval seconds, total wait=$totalWait seconds..."
    sleep $sleep_interval
    totalWait=$(($totalWait+$sleep_interval))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "String not found within alotted time for container $container_name: $search_string"
    return 1
  fi
}

function showMessageBox()
{
  msgmenu=$(cat << EOF
$(getLogo)

$2

EOF
  )
  whiptail --title "$1" --msgbox "$msgmenu" $MENU_HEIGHT $MENU_WIDTH
}

function showYesNoMessageBox()
{
  msgmenu=$(cat << EOF
$(getLogo)

$2

EOF
  )
  whiptail --title "$1" --yesno "$msgmenu" $MENU_HEIGHT $MENU_WIDTH
}

function showNoYesMessageBox()
{
  msgmenu=$(cat << EOF
$(getLogo)

$2

EOF
  )
  whiptail --title "$1" --yesno "$msgmenu" $MENU_HEIGHT $MENU_WIDTH --yes-button "No" --no-button "Yes"
}

function promptUserInputMenu()
{
  usermenu=$(cat << EOF
$(getLogo)

$3

EOF
  )
  menures=$(whiptail --title "$2" --inputbox "$usermenu" $MENU_HEIGHT $MENU_WIDTH "$1" 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ]; then
    exit 1
  fi
  echo "$menures"
}

function promptPasswordMenu()
{
  usermenu=$(cat << EOF
$(getLogo)

$2

EOF
  )
  menures=$(whiptail --title "$1" --passwordbox "$usermenu" $MENU_HEIGHT $MENU_WIDTH 3>&1 1>&2 2>&3)
  retVal=$?
  echo "$menures"
  return $retVal
}

function getDockerSubnet()
{
  subnet=$(docker network inspect $1 | grep Subnet | awk '{print $2}' | sed 's/[",]//g')
  echo $subnet
}

function removeSpecialChars()
{
  # This was an interesting one...https://askubuntu.com/questions/357248/how-to-remove-special-m-bm-character-with-sed
  sed -i 's/\xc2\xa0/ /g' "$1"
  sed -i 's/\r$//g' "$1"
}

function extractValueFromApplication()
{
  app_var_starts_with=$1
  app_file_name=$2
  grep "^${app_var_starts_with}:" $app_file_name | cut -d ":" -f2- | sed 's/^ *//' | sed 's/ *$//' | sed 's/  */ /'
}

function replaceSingleLineInFile()
{
  rslif_curE=${-//[^e]/}
  block_match_begin="$1"
  replace_text="$2"
  r_filename=$3
  set +e
  match=$(grep "$block_match_begin" $r_filename)
  if ! [ -z "$match" ]; then
    all_text=$(cat $r_filename)
    echo -e "${all_text%%$block_match_begin*}${replace_text}${all_text##*$block_match_begin}" > $r_filename
  fi
  if ! [ -z "$rslif_curE" ]; then
    set -e
  fi
}

function replaceTextBlockInFile()
{
  block_match_begin="$1"
  block_match_end="$2"
  replace_text="$3"
  r_filename=$4
  is_keep_block_headers=$5
  space_delim=$6
  set +e
  match=$(grep "$block_match_begin" $r_filename)
  if ! [ -z "$match" ]; then
    all_text=$(cat $r_filename)
    if ! [ -z "$space_delim" ]; then
      replace_text=$(echo $replace_text | sed "s|$space_delim| |g")
    fi
    if [ "$is_keep_block_headers" = "true" ]; then
      echo -e "${all_text%%$block_match_begin*}${block_match_begin}\n${replace_text}\n${block_match_end}${all_text##*$block_match_end}" > $r_filename
    else
      echo -e "${all_text%%$block_match_begin*}\n${replace_text}\n${all_text##*$block_match_end}" > $r_filename
    fi
  fi
  set -e
}

function replaceOrAppendTextBlockInFile()
{
  block_match_begin="$1"
  block_match_end="$2"
  replace_text="$3"
  r_filename=$4
  space_delim=$5
  set +e
  match=$(grep "$block_match_begin" $r_filename)
  if [ -z "$match" ]; then
    #Append
    if ! [ -z "$space_delim" ]; then
      replace_text=$(echo $replace_text | sed "s|$space_delim| |g")
    fi
    echo -e "\n${block_match_begin}\n${replace_text}\n${block_match_end}" >> $r_filename
  else
    #Replace
    replaceTextBlockInFile "$block_match_begin" "$block_match_end" "$replace_text" $r_filename true "$space_delim"
  fi
  set -e
}

function removeTextBlockInFile()
{
  rtbif_curE=${-//[^e]/}
  block_match_begin="$1"
  block_match_end="$2"
  r_filename=$3
  set +e
  match=$(grep "$block_match_begin" $r_filename)
  if ! [ -z "$match" ]; then
    sed -i "/$block_match_begin/,/$block_match_end/d" $r_filename
    cat -s $r_filename > $HOME/tmpremfile
    mv $HOME/tmpremfile $r_filename
  fi
  set +e
  if ! [ -z "$rtbif_curE" ]; then
    set -e
  fi
}

function insertSubAuthelia()
{
  insSub="$1"
  selBlock="$2"
  set +e
  all_text=$(cat $HSHQ_STACKS_DIR/authelia/config/configuration.yml)
  echo $all_text | grep -oP '(?<=#AC_BEGIN).*(?=#AC_END)' | grep "$insSub" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    return
  fi
  grep "# Authelia $selBlock END" $HSHQ_STACKS_DIR/authelia/config/configuration.yml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    return
  fi
  sed -i "/# Authelia $selBlock END/i\        - $insSub" $HSHQ_STACKS_DIR/authelia/config/configuration.yml
  docker container restart authelia > /dev/null 2>&1
  docker ps | grep codeserver > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker container restart codeserver > /dev/null 2>&1
  fi
}

function insertOIDCClientAuthelia()
{
  oidcName="$1"
  oidcBlock="$2"
  set +e
  grep "# Authelia OIDC Client $oidcName" $HSHQ_STACKS_DIR/authelia/config/configuration.yml > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    replaceTextBlockInFile "# Authelia OIDC Client $oidcName BEGIN" "# Authelia OIDC Client $oidcName END" "$oidcBlock" $HSHQ_STACKS_DIR/authelia/config/configuration.yml false
  else
    oidcBlock="${oidcBlock}\n# Authelia OIDC Clients END"
    replaceTextBlockInFile "# Authelia OIDC Clients END" "# Authelia OIDC Clients END" "$oidcBlock" $HSHQ_STACKS_DIR/authelia/config/configuration.yml false
  fi
  sed -i '/^$/{:a;N;s/\n$//;ta}' $HSHQ_STACKS_DIR/authelia/config/configuration.yml
  set +e
  docker container restart authelia > /dev/null 2>&1
  docker ps | grep codeserver > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker container restart codeserver > /dev/null 2>&1
  fi
}

function urlEncode()
{
  strLength="${#1}"
  for (( i = 0; i < strLength; i++ )); do
    c="${1:i:1}"
    case $c in
      [a-zA-Z0-9.~_-]) printf "$c" ;;
      *) printf '%%%02X' "'$c" ;;
    esac
  done
}

function urlDecode()
{
  url_encoded="${1//+/ }"
  printf '%b' "${url_encoded//%/\\x}"
}

function getTextBetweenStrings()
{
  # This function could probably be done better
  filename=$1
  stringbegin=$2
  stringend=$3
  stringlinebegin=$(grep "$stringbegin" $filename)
  stringlineend=$(grep "$stringend" $filename)
  allfiledata=$(cat $filename)
  textafter=$(echo "${allfiledata##*$stringlinebegin}")
  result=$(echo "${textafter%%$stringlineend*}")
  echo -e "$result"
}

function checkValidString()
{
  check_string=$1
  addchars=$2
  if [[ "$check_string" =~ ^[0-9a-z$addchars]+$ ]]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidDirectory()
{
  check_string=$1
  if [ $(checkValidString "$check_string" "/") = "false" ]; then
    echo "false"
  fi
  if [[ ${check_string:0:1} != "/" ]]; then
    echo "false"
  fi
  echo "true"
}

function checkValidBaseDomain()
{
  check_domain=$1
  if [ $(checkValidString "$check_domain" ".-") = "false" ]; then
    echo "false"
    return
  fi
  if [ -z "$(getDomainTLD $check_domain)" ]; then
    echo "false"
    return
  fi
  if [ -z "$(echo $check_domain | cut -d"." -f1)" ]; then
    echo "false"
    return
  fi
  echo "true"
}

function checkValidEmail()
{
  check_string=$1
  if [ -z "$check_string" ]; then echo "false"; fi
  regex="^([A-Za-z]+[A-Za-z0-9]*((\.|\-|\_)?[A-Za-z]+[A-Za-z0-9]*){1,})@(([A-Za-z]+[A-Za-z0-9]*)+((\.|\-|\_)?([A-Za-z]+[A-Za-z0-9]*)+){1,})+\.([A-Za-z]{2,})+"
  if [[ "$check_string" =~ $regex ]]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidStringUpperLowerNumbers()
{
  check_string=$1
  addchars=$2
  if [[ $check_string =~ ^[0-9a-zA-Z$addchars]+$ ]]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidStringUpper()
{
  check_string=$1
  addchars=$2
  if [[ $check_string =~ ^[A-Z$addchars]+$ ]]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidNumber()
{
  check_string=$1
  if [[ $check_string =~ ^[0-9]+$ ]]; then 
    echo "true"
  else
    echo "false"
  fi
}

function checkValidVersionNumber()
{
  check_number="$1"
  if [ "$(checkValidNumber "$check_number")" = "false" ]; then
    echo "false"
  elif [ $check_number -lt 1 ] || [ $check_number -gt 10000 ]; then
    echo "false"
  else
    echo "true"
  fi
}

function checkValidIPAddress()
{
  set +e
  ip=$(echo "$1" | cut -d "/" -f1)
  cidr=""
  echo "$1" | grep "/" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    cidr=$(echo "$1" | cut -d "/" -f2-)
  fi
  stat=1
  if [[ $ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
    OLDIFS=$IFS
    IFS='./'
    ip=($ip)
    IFS=$OLDIFS
    [[ ${ip[0]} -le 255 && ${ip[1]} -le 255 && ${ip[2]} -le 255 && ${ip[3]} -le 255 ]]
    stat=$?
  fi
  if ! [ -z "$cidr" ]; then
    if [ "$(checkValidNumber $cidr)" = "false" ] || [ $cidr -lt 0 ] || [ $cidr -gt 32 ]; then
      stat=1
    fi
  fi
  set -e
  if [ $stat -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidPassword()
{
  pw_in="$1"
  min_length=$2
  pw_length=${#pw_in}
  if [ -z "$min_length" ]; then
    min_length=1
  fi
  if ! [[ "$pw_in" =~ [[:upper:]] ]]; then
    # Does not contain upper case.
    echo "false"
  elif ! [[ "$pw_in" =~ [[:lower:]] ]]; then
    # Does not contain lower case.
    echo "false"
  elif ! [[ "$pw_in" =~ [0-9] ]]; then
    # Does not contain number.
    echo "false"
  elif [[ "$pw_in" =~ [[:space:]] ]]; then
    # Contains a space.
    echo "false"
  elif [[ "$pw_in" =~ '$' ]]; then
    # Contains a dollar sign.
    echo "false"
  elif [[ "$pw_in" =~ '"' ]]; then
    # Contains a double quote.
    echo "false"
  elif [[ "$pw_in" =~ '`' ]]; then
    # Contains a backtick.
    echo "false"
  elif [ $pw_length -lt $min_length ]; then
    # Less than min characters
    echo "false"
  elif echo "$pw_in" | grep -Eq '^[a-zA-Z0-9(~!@#%^&*_+=<>?.,)-]+$'; then
    echo "true"
  else
    # Some other problem
    echo "false"
  fi
}

function checkValidUsername()
{
  chkName="$1"
  if echo "$chkName" | grep -Eq '^[a-z0-9]+$' && echo "$chkName" | cut -c1 | grep -Eq '[a-z]' && [ ${#chkName} -le 32 ] && [ ${#chkName} -ge 4 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function checkValidPortsList()
{
  check_string="$1"
  if ! [ $(checkValidString "$check_string" ",:/") = "true" ]; then 
    echo "The list of ports is invalid. It must consist of 0-9, a-z, commas(,), colons(:), and/or fwd slash (/) with no spaces."
    return 1
  else
    portListArr=($(echo "$check_string" | tr "," "\n"))
    for curPort in "${portListArr[@]}"
    do
      port_no=$(echo "$curPort" | cut -d"/" -f1 | xargs)
      port_prot=""
      if [[ $curPort =~ "/" ]]; then
        port_prot=$(echo "$curPort" | cut -d"/" -f2- | xargs)
      fi
      if ! [[ $port_no =~ ^[0-9:]+$ ]]; then
        echo "One of the port numbers in the list is invalid ($port_no). It must consist of 0-9, and/or colons(:) with no spaces. Full string: $check_string"
        return 2
      fi
      if [[ $port_no =~ ":" ]]; then
        port_begin=$(echo "$port_no" | cut -d":" -f1 | xargs)
        port_end=$(echo "$port_no" | cut -d":" -f2- | xargs)
        if ! [[ $port_begin =~ ^[0-9]+$ ]] || ! [[ $port_end =~ ^[0-9]+$ ]]; then
          echo "One of the port numbers in the list is invalid [$port_begin:$port_end]. It must consist of 0-9, and/or colons(:) with no spaces."
          return 3
        fi
      fi
      if ! [ -z "$port_prot" ]; then
        case "$port_prot" in
          tcp|udp|both)
            continue
          ;;
          *)
            echo "One of the port protocols in the list is invalid. It must be either tcp, udp, or both: $port_prot"
            return 4
          ;;
        esac
      fi
    done
  fi
}

function checkValidINPUTChainPortsList()
{
  check_string="$1"
  portListArr=($(echo "$check_string" | tr "," "\n"))
  for curPort in "${portListArr[@]}"
  do
    port_no=$(echo "$curPort" | cut -d"/" -f1 | xargs)
    if [[ $curPort =~ "/" ]]; then
      port_prot=$(echo "$curPort" | cut -d"/" -f2- | xargs)
    else
      echo "One of the ports in the list did not specify a protocol, which is required for the INPUT chain. It must be either tcp, udp, or both: $curPort"
      return 1
    fi
    if ! [[ $port_no =~ ^[0-9:]+$ ]]; then
      echo "One of the port numbers in the list is invalid ($port_no). It must consist of 0-9, and/or colons(:) with no spaces. Full string: $check_string"
      return 2
    fi
    if [[ $port_no =~ ":" ]]; then
      port_begin=$(echo "$port_no" | cut -d":" -f1 | xargs)
      port_end=$(echo "$port_no" | cut -d":" -f2- | xargs)
      if ! [[ $port_begin =~ ^[0-9]+$ ]] || ! [[ $port_end =~ ^[0-9]+$ ]]; then
        echo "One of the port numbers in the list is invalid [$port_begin:$port_end]. It must consist of 0-9, and/or colons(:) with no spaces."
        return 3
      fi
    fi
    case "$port_prot" in
      tcp|udp|both)
        continue
      ;;
      *)
        echo "One of the port protocols in the list is invalid. It must be either tcp, udp, or both: $port_prot"
        return 4
      ;;
    esac
  done
}

function getStringLength()
{
  echo "${#1}"
}

function isEmailMatchBaseDomain()
{
  check_email_addr="$1"
  check_base_domain="$2"
  email_addr_domain=$(echo "$check_email_addr" | cut -d"@" -f2-)
  if [ "$email_addr_domain" = "$check_base_domain" ]; then
    echo "true"
  else
    echo "false"
  fi
}

function addHomeNetIP()
{
  add_ip=$1
  is_update_iptables=$2
  set +e
  echo $HOMENET_ADDITIONAL_IPS | grep $add_ip >/dev/null
  if [ $? -ne 0 ]; then
    if [ -z "$HOMENET_ADDITIONAL_IPS" ]; then
      HOMENET_ADDITIONAL_IPS=$add_ip
    else
      HOMENET_ADDITIONAL_IPS=$HOMENET_ADDITIONAL_IPS","$add_ip
    fi
    updatePlaintextRootConfigVar HOMENET_ADDITIONAL_IPS "$HOMENET_ADDITIONAL_IPS"
    if [ "$IS_INSTALLED" = "true" ]; then
      checkUpdateAllIPTables addHomeNetIP
    fi
  fi
}

function removeHomeNetIP()
{
  remove_ip=$1
  is_update_iptables=$2
  set +e
  echo $HOMENET_ADDITIONAL_IPS | grep $remove_ip >/dev/null
  if [ $? -eq 0 ]; then
    HOMENET_ADDITIONAL_IPS=$(echo $HOMENET_ADDITIONAL_IPS | sed "s|${remove_ip},||g")
    HOMENET_ADDITIONAL_IPS=$(echo $HOMENET_ADDITIONAL_IPS | sed "s|,${remove_ip}||g")
    updatePlaintextRootConfigVar HOMENET_ADDITIONAL_IPS "$HOMENET_ADDITIONAL_IPS"
    if [ "$IS_INSTALLED" = "true" ]; then
      checkUpdateAllIPTables removeHomeNetIP
    fi
  fi
}

function isServiceDisabled()
{
  check_svc_disabled="$1"
  isd_curE=${-//[^e]/}
  set +e
  if grep -q "$check_svc_disabled" <<< "$HSHQ_REQUIRED_STACKS"; then
    isd_RetVal="false"
  elif [ "$DISABLED_SERVICES" = "minimal" ]; then
    isd_RetVal="true"
  elif [ "$DISABLED_SERVICES" = "none" ]; then
    isd_RetVal="false"
  else
    isd_RetVal="$(isItemInCSVList $check_svc_disabled $DISABLED_SERVICES)"
  fi
  if ! [ -z "$isd_curE" ]; then
    set -e
  fi
  echo "$isd_RetVal"
}

function isItemInCSVList()
{
  check_item="$1"
  check_list="$2"
  checkListArr=($(echo $check_list | tr "," "\n"))
  for curItem in "${checkListArr[@]}"
  do
    if [ "$check_item" = "$curItem" ]; then
      echo "true"
      return
    fi
  done
  echo "false"
}

function checkDisableStack()
{
  if [ "$(isServiceDisabled $1)" = "true" ]; then
    echo "Disabling $1"
    startStopStack $1 stop
  fi
}

function getSvcCredentialsVW()
{
  svc_name=$1
  login_uri=$2
  abbrev=$3
  username=$4
  password=$5
  echo "$abbrev,,login,$svc_name,,,0,$login_uri,$username,$password,"
}

function getFmtCredentials()
{
  svc_name="$1"
  login_uri="$2"
  abbrev="$3"
  username="$4"
  password="$5"
  echo "$svc_name, $username, $password, $login_uri"
}

function sendRootCAEmail()
{
  is_sudo=$1
  mail_msg=""
  mail_msg=${mail_msg}"Below is the public root certificate for your network. "
  mail_msg=${mail_msg}"If you are connected to the internal network, then it can also be downloaded via: \n"
  mail_msg=${mail_msg}"PEM: http://$SUB_FILES.$HOMESERVER_DOMAIN/ca.crt \n"
  mail_msg=${mail_msg}"DER: http://$SUB_FILES.$HOMESERVER_DOMAIN/ca.der \n"
  mail_msg=${mail_msg}"Add this to any device that you wish to use to access web-based resources on your network. "
  mail_msg=${mail_msg}"It only needs to be installed once, and is good for at least 40 years. "
  mail_msg=${mail_msg}"It is also included as an attachment in both formats (Some mobile devices may require the DER format). "
  mail_msg=${mail_msg}"You can freely share this with anyone, it will not compromise any security measures. \n"
  mail_msg=${mail_msg}"\n######################### Root CA Begin #########################\n\n"
  mail_msg=${mail_msg}"""$(cat $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt)"""
  mail_msg=${mail_msg}"\n\n########################## Root CA End ##########################\n"
  if [ "$is_sudo" = "true" ]; then
    # This special case is only need during the initial installation due
    # to issues with adding members to groups (mailsenders) within a script.
    echo -e "$mail_msg" | sudo timeout $MAILX_TIMEOUT mailx -s "Public Root Certificate" -a "From: $(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -a "Message-Id: <$(uuidgen)@$HOMESERVER_DOMAIN>" -A $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -A $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der "$EMAIL_ADMIN_EMAIL_ADDRESS"
  else
    sendEmail -s "Public Root Certificate" -b "$mail_msg" -a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -a $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der
  fi
}

function getDNSRecordsInfo()
{
  cur_domain=$1
  str_res="DNS Info for ${cur_domain}:\n"
  str_res="${str_res}========================General========================\n"
  str_res="${str_res}1. Type: A | Name: @ | Value: $RELAYSERVER_SERVER_IP |\n"
  str_res="${str_res}2. Type: A | Name: * | Value: $RELAYSERVER_SERVER_IP |\n"
  str_res="${str_res}=======================================================\n"
  str_res="${str_res}=========================Email=========================\n"
  str_res="${str_res}1. Type: MX | Name: @ | Priority: 0 | Value: $RELAYSERVER_EXT_EMAIL_HOSTNAME |\n"
  str_res="${str_res}2. Type: TXT | Name: @ | Value: v=spf1 mx -all |\n"
  str_res="${str_res}3. Type: TXT | Name: * | Value: v=spf1 -all |\n"
  str_res="${str_res}4. Type: TXT | Name: ${cur_domain}._report._dmarc | Value: v=DMARC1 |\n"
  str_res="${str_res}5. Type: TXT | Name: _dmarc | Value: v=DMARC1;p=reject;rua=mailto:$EMAIL_ADMIN_EMAIL_ADDRESS;ruf=mailto:$EMAIL_ADMIN_EMAIL_ADDRESS;adkim=s;aspf=s |\n"
  str_res="${str_res}6*. Type: TXT | Name: dkim._domainkey | Value: v=DKIM1;k=rsa;p=YourDomainKey |\n"
  str_res="${str_res}\n* - Ensure you replace YourDomainKey correctly\n"
  str_res="${str_res}======================================================="
  echo "$str_res"
}

function outputDNSZoneFile()
{
  cur_domain="$1"
  strFilename="$2"
  tee $strFilename >/dev/null <<EOFDZ
; Domain: $cur_domain

\$ORIGIN ${cur_domain}.

; A Record
@	600	 IN 	A	$RELAYSERVER_SERVER_IP
*	600	 IN 	A	$RELAYSERVER_SERVER_IP

; TXT Record
@	3600	 IN 	TXT	"v=spf1 mx -all"
*	3600	 IN 	TXT	"v=spf1 -all"
${cur_domain}._report._dmarc	3600	 IN 	TXT	"v=DMARC1"
_dmarc	3600	 IN 	TXT	"v=DMARC1;p=reject;rua=mailto:$EMAIL_ADMIN_EMAIL_ADDRESS;ruf=mailto:$EMAIL_ADMIN_EMAIL_ADDRESS;adkim=s;aspf=s"

; MX Record
@	3600	 IN 	MX	0	${RELAYSERVER_EXT_EMAIL_HOSTNAME}.
EOFDZ
}

function sendDNSRecordsEmail()
{
  email_dns_domain=$1
  outputDNSZoneFile $email_dns_domain /tmp/${DNS_ZONE_FILENAME_BASE}_${email_dns_domain}.txt
  sendEmail -s "DNS Info for $email_dns_domain" -b "Below are the DNS records for the domain $email_dns_domain. There is also a DNS Zone file attachment, which is compatible with most DNS providers. Unless you are doing some sort of advanced setup and/or you know what you are doing, you should delete any other preexisting A, MX, CNAME, or TXT records that may have been created by your domain name provider. Just ensure that you do NOT edit/delete the nameserver (NS) or Start of Authority (SOA) records. \n\n$(getDNSRecordsInfo $email_dns_domain)" -a /tmp/${DNS_ZONE_FILENAME_BASE}_${email_dns_domain}.txt
  sleep 1
  rm -f /tmp/${DNS_ZONE_FILENAME_BASE}_${email_dns_domain}.txt
}

function sendEmail()
{
  email_attachments=""
  email_body=""
  email_from=""
  email_subj=""
  email_to=""
  local OPTIND opt a b f s t
  while getopts ':a:b:f:s:t:' opt; do
    case "$opt" in
      a)
        email_attachments="${email_attachments}-A "$OPTARG" " ;;
      b)
        email_body="$OPTARG" ;;
      f)
        email_from="$OPTARG" ;;
      s)
        email_subj="$OPTARG" ;;
      t)
        email_to="$OPTARG" ;;
      ?|h)
        echo "Usage: sendEmail [-a arg] [-b arg] [-f arg] [-s arg] [-t arg]"
        return ;;
    esac
  done
  shift "$(($OPTIND -1))"
  if [ -z "$email_body" ]; then
    echo "sendEmail Error: Empty Body"
    return
  fi
  if [ -z "$email_subj" ]; then
    echo "sendEmail Error: Empty Subject"
    return
  fi
  if [ -z "$email_from" ]; then
    email_from="$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  fi
  if [ -z "$email_to" ]; then
    email_to=$EMAIL_ADMIN_EMAIL_ADDRESS
  fi
  set +e
  num_email_tries=1
  max_email_tries=5
  while [ $num_email_tries -lt $max_email_tries ]
  do
    echo -e "$email_body" | timeout $MAILX_TIMEOUT mailx -s "$email_subj" -a "From: $email_from" -a "Message-Id: <$(uuidgen)@$HOMESERVER_DOMAIN>" $email_attachments "$email_to"
    if [ $? -eq 0 ]; then
      break
    fi
    echo "ERROR: Could not send email, retrying ($num_email_tries of $max_email_tries)..."
    rm -f dead.letter
    sleep 3
    ((num_email_tries++))
  done
}

function sendEmailToList()
{
  send_email_list="$1"
  send_email_subj="$2"
  send_email_body="$3"
  for curEmail in "${send_email_list[@]}"
  do
    echo "Sending email to $curEmail"
    sendEmail -s "$send_email_subj" -b "$send_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  done
}

function loadSvcVars()
{
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  SVCS_ARR=($(grep "SVCD_" $CONFIG_FILE))
  subdom_list=()
  for curSVC in "${SVCS_ARR[@]}"
  do
    var_base=$(echo $curSVC | cut -d"=" -f1 | cut -d"_" -f 2-)
    stack_name=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f1)
    service_name=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f2)
    net_default=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f3)
    user_type=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f4)
    formal_name=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f5)
    subdom=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f6)
    subdom="${subdom//\"}"
    manage_tls=$(echo $curSVC | cut -d"=" -f2 | cut -d"," -f7)
    for curSub in "${subdom_list[@]}"
    do
      if [ "$curSub" = "$subdom" ]; then
        echo "FATAL: A duplicate subdomain ($curSub) was found in the configuration file. Please fix this issue and restart the script."
        exit 1
      fi
    done
    subdom_list+=($subdom)
    printf -v "STACKNAME_${var_base}" '%s' "${stack_name//\"}"
    printf -v "SERVICENAME_${var_base}" '%s' "${service_name//\"}"
    printf -v "NETDEFAULT_${var_base}" '%s' "${net_default//\"}"
    printf -v "USERTYPE_${var_base}" '%s' "${user_type//\"}"
    printf -v "FMLNAME_${var_base}" '%s' "${formal_name//\"}"
    printf -v "SUB_${var_base}" '%s' "${subdom//\"}"
    printf -v "MANAGETLS_${var_base}" '%s' "${manage_tls//\"}"
  done
  IFS=$OLDIFS
}

function loadConfigVars()
{
  lcv_curE=${-//[^e]/}
  is_chk_update="$1"
  initServiceVars
  set -e
  sudo -v
  if [ $? -ne 0 ]; then
    # Fatal
    echo "Error obtaining sudo privileges, exiting..."
    exit 1
  fi
  set +e
  if sudo test -f $HSHQ_PLAINTEXT_ROOT_CONFIG; then
    set -e
    ptvar="$(sudo cat $HSHQ_PLAINTEXT_ROOT_CONFIG)"
    source <(echo "$ptvar")
  fi
  set +e
  if test -f $HSHQ_PLAINTEXT_USER_CONFIG; then
    set -e
    source $HSHQ_PLAINTEXT_USER_CONFIG
  fi
  set +e
  fixConfigV130
  set -e
  source $CONFIG_FILE
  loadSvcVars
  if ! [ "$is_chk_update" = "false" ]; then
    checkUpdateVersion
  fi
  set +e
  if ! [ -z "$lcv_curE" ]; then
    set -e
  fi
}

function fixConfigV130()
{
  sed -i "s/,le\"\"/,le\"/g" $CONFIG_FILE
}

function checkAddSvc()
{
  svcVar=$(echo $1 | cut -d"=" -f1)
  svcVal=$(echo $1 | cut -d"=" -f2)
  grep -q "^${svcVar}=" $CONFIG_FILE
  if [ $? -ne 0 ]; then
    sed -i "s|^# Services Info END|${svcVar}=\"${svcVal}\"\n# Services Info END|g" $CONFIG_FILE
  fi 
}

function loadDirectoryStructure()
{
  if [ -z "$HSHQ_BASE_DIR" ]; then
    HSHQ_BASE_DIR=$HOME/hshq
  fi
  HSHQ_DATA_DIR=$HSHQ_BASE_DIR/data
  HSHQ_BACKUP_DIR=$HSHQ_BASE_DIR/backup
  HSHQ_NONBACKUP_DIR=$HSHQ_BASE_DIR/nonbackup
  HSHQ_ASSETS_DIR=$HSHQ_DATA_DIR/assets
  HSHQ_BUILD_DIR=$HSHQ_NONBACKUP_DIR/build
  HSHQ_CONFIG_DIR=$HSHQ_DATA_DIR/config
  HSHQ_LIB_DIR=$HSHQ_DATA_DIR/lib
  HSHQ_RELAYSERVER_DIR=$HSHQ_DATA_DIR/relayserver
  HSHQ_SCRIPTS_DIR=$HSHQ_DATA_DIR/scripts
  HSHQ_SECRETS_DIR=$HSHQ_DATA_DIR/secrets
  HSHQ_SSL_DIR=$HSHQ_DATA_DIR/ssl
  HSHQ_STACKS_DIR=$HSHQ_DATA_DIR/stacks
  HSHQ_WIREGUARD_DIR=$HSHQ_DATA_DIR/wireguard
  HSHQ_RESTORE_DIR=$HOME/hshqrestore
  HSHQ_WRAP_SCRIPT=$HOME/$HSHQ_WRAP_FILENAME
  HSHQ_LIB_SCRIPT=$HSHQ_LIB_DIR/$HSHQ_LIB_FILENAME
  HSHQ_NEW_LIB_SCRIPT=$HSHQ_LIB_DIR/$HSHQ_NEW_LIB_FILENAME
  if ! [ -f $HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME ]; then
    outputLockUtilsScript
  fi
  source $HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME
}

function getLatestVersionWrapper()
{
  if [ -f $HOME/hshq/$IS_HSHQ_DEV_FILENAME ]; then
    vnum=$(curl -L --silent $HSHQ_WRAP_DEV_VER_URL | head -n 1)
  elif [ -f $HOME/hshq/$IS_HSHQ_TEST_FILENAME ]; then
    vnum=$(curl -L --silent $HSHQ_WRAP_TEST_VER_URL | head -n 1)
  else
    vnum=$(curl -L --silent $HSHQ_WRAP_VER_URL | head -n 1)
  fi
  if [ "$(checkValidVersionNumber "$vnum")" = "true" ]; then
    echo "$vnum"
  fi
}

function getLatestWrapperURL()
{
  if [ -f $HOME/hshq/$IS_HSHQ_DEV_FILENAME ]; then
    echo "$HSHQ_WRAP_DEV_URL"
  elif [ -f $HOME/hshq/$IS_HSHQ_TEST_FILENAME ]; then
    echo "$HSHQ_WRAP_TEST_URL"
  else
    echo "$HSHQ_WRAP_URL"
  fi
}

function getThisVersionWrapper()
{
  if ! [ -f $HSHQ_WRAP_SCRIPT ]; then
    echo 0
  fi
  echo $(sed -n 2p $HSHQ_WRAP_SCRIPT | cut -d"=" -f2)
}

function getLatestVersionLib()
{
  if [ -f $HOME/hshq/$IS_HSHQ_DEV_FILENAME ]; then
    vnum=$(curl -L --silent $HSHQ_LIB_DEV_VER_URL | head -n 1)
  elif [ -f $HOME/hshq/$IS_HSHQ_TEST_FILENAME ]; then
    vnum=$(curl -L --silent $HSHQ_LIB_TEST_VER_URL | head -n 1)
  else
    vnum=$(curl -L --silent $HSHQ_LIB_VER_URL | head -n 1)
  fi
  if [ "$(checkValidVersionNumber "$vnum")" = "true" ]; then
    echo "$vnum"
  fi
}

function getLatestLibURL()
{
  if [ -f $HOME/hshq/$IS_HSHQ_DEV_FILENAME ]; then
    echo "$HSHQ_LIB_DEV_URL"
  elif [ -f $HOME/hshq/$IS_HSHQ_TEST_FILENAME ]; then
    echo "$HSHQ_LIB_TEST_URL"
  else
    echo "$HSHQ_LIB_URL"
  fi
}

function getThisVersionLib()
{
  if ! [ -f $HSHQ_LIB_SCRIPT ]; then
    echo 0
  fi
  echo $(sed -n 2p $HSHQ_LIB_SCRIPT | cut -d"=" -f2)
}

function getPendingVersionLib()
{
  if [ -f $HSHQ_NEW_LIB_SCRIPT ]; then
    echo $(sed -n 2p $HSHQ_NEW_LIB_SCRIPT | cut -d"=" -f2)
  fi
}

function verifyFile()
{
  # Perform 4 checks:
  # 1 - Ensure both src and sig files exist
  # 2 - Verify the file
  # 3 - Ensure the verification process used the correct key
  # 4 - Ensure the output contains "Good signature" (This step is likely redundant, but thats fine)
  src_file=$1
  sig_file=$2
  if ! [ -f "$src_file" ] || ! [ -f "$sig_file" ]; then
    return 4
  fi
  gpg --verify $sig_file $src_file >/dev/null 2>/tmp/verify
  ver_res=$?
  if [ $ver_res -ne 0 ]; then
    rm -f /tmp/verify
    return $ver_res
  fi
  grep $HSHQ_GPG_FINGERPRINT /tmp/verify > /dev/null 2>&1
  ver_res=$?
  if [ $ver_res -ne 0 ]; then
    rm -f /tmp/verify
    return $ver_res
  fi
  grep "Good signature" /tmp/verify > /dev/null 2>&1
  ver_res=$ver_res
  if [ $? -ne 0 ]; then
    rm -f /tmp/verify
    return $ver_res
  fi
  rm -f /tmp/verify
}

function getRandomRequestID()
{
  # Use the date, plus throw some randomness at the end.
  # Could use a GUID/UUID, but date is more informative.
  echo "$(date '+%Y%m%d%H%M%S')$((1000 + RANDOM % 9999))$((1000 + RANDOM % 9999))$((10 + RANDOM % 99))"
}

# BEGIN bash_progress_bar
#
# The following section of code was obtained
# from the project:
# https://github.com/pollev/bash_progress_bar
# It consists of a total of 12 functions,
# and the code is enclosed between the comments:
# BEGIN bash_progress_bar and END bash_progress_bar
#
# SPDX-License-Identifier: MIT
#
# Copyright (c) 2018--2020 Polle Vanhoof
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# Usage:
# Source this script
# enable_trapping <- optional to clean up properly if user presses ctrl-c
# setup_scroll_area <- create empty progress bar
# draw_progress_bar 10 <- advance progress bar
# draw_progress_bar 40 <- advance progress bar
# block_progress_bar 45 <- turns the progress bar yellow to indicate some action is requested from the user
# draw_progress_bar 90 <- advance progress bar
# destroy_scroll_area <- remove progress bar

function pb_init_constants()
{
  # Constants
  CODE_SAVE_CURSOR="\033[s"
  CODE_RESTORE_CURSOR="\033[u"
  CODE_CURSOR_IN_SCROLL_AREA="\033[1A"
  COLOR_FG="\e[30m"
  COLOR_BG="\e[42m"
  COLOR_BG_BLOCKED="\e[43m"
  RESTORE_FG="\e[39m"
  RESTORE_BG="\e[49m"
  # Variables
  PROGRESS_BLOCKED="false"
  TRAPPING_ENABLED="false"
  ETA_ENABLED="false"
  TRAP_SET="false"
  CURRENT_NR_LINES=0
  PROGRESS_TITLE=""
  PROGRESS_TOTAL=100
  PROGRESS_START=0
  BLOCKED_START=0
}

function setup_scroll_area()
{
  pb_init_constants
  # If trapping is enabled, we will want to activate it whenever we setup the scroll area and remove it when we break the scroll area
  if [ "$TRAPPING_ENABLED" = "true" ]; then
    trap_on_interrupt
  fi
  # Handle first parameter: alternative progress bar title
  [ -n "$1" ] && PROGRESS_TITLE="$1" || PROGRESS_TITLE="Progress"
  # Handle second parameter : alternative total count
  [ -n "$2" ] && PROGRESS_TOTAL=$2 || PROGRESS_TOTAL=100
  lines=$(tput lines)
  CURRENT_NR_LINES=$lines
  lines=$((lines-1))
  # Scroll down a bit to avoid visual glitch when the screen area shrinks by one row
  echo -en "\n"
  # Save cursor
  echo -en "$CODE_SAVE_CURSOR"
  # Set scroll region (this will place the cursor in the top left)
  echo -en "\033[0;${lines}r"
  # Restore cursor but ensure its inside the scrolling area
  echo -en "$CODE_RESTORE_CURSOR"
  echo -en "$CODE_CURSOR_IN_SCROLL_AREA"
  # Store start timestamp to compute ETA
  if [ "$ETA_ENABLED" = "true" ]; then
    PROGRESS_START=$( date +%s )
  fi
  # Start empty progress bar
  draw_progress_bar 0
}

function destroy_scroll_area()
{
  lines=$(tput lines)
  # Save cursor
  echo -en "$CODE_SAVE_CURSOR"
  # Set scroll region (this will place the cursor in the top left)
  echo -en "\033[0;${lines}r"
  # Restore cursor but ensure its inside the scrolling area
  echo -en "$CODE_RESTORE_CURSOR"
  echo -en "$CODE_CURSOR_IN_SCROLL_AREA"
  # We are done so clear the scroll bar
  clear_progress_bar
  # Scroll down a bit to avoid visual glitch when the screen area grows by one row
  echo -en "\n\n"
  # Reset title for next usage
  PROGRESS_TITLE=""
  # Once the scroll area is cleared, we want to remove any trap previously set. Otherwise, ctrl+c will exit our shell
  if [ "$TRAP_SET" = "true" ]; then
    trap - EXIT
  fi
}

function format_eta()
{
  local T=$1
  local D=$((T/60/60/24))
  local H=$((T/60/60%24))
  local M=$((T/60%60))
  local S=$((T%60))
  [ $D -eq 0 -a $H -eq 0 -a $M -eq 0 -a $S -eq 0 ] && echo "--:--:--" && return
  [ $D -gt 0 ] && printf '%d days, ' $D
  printf 'ETA: %d:%02.f:%02.f' $H $M $S
}

function draw_progress_bar()
{
  if ! [ "$is_draw_pb" = "true" ]; then
    return
  fi
  eta=""
  if [ "$ETA_ENABLED" = "true" -a $1 -gt 0 ]; then
    if [ "$PROGRESS_BLOCKED" = "true" ]; then
      blocked_duration=$(($(date +%s)-$BLOCKED_START))
      PROGRESS_START=$((PROGRESS_START+blocked_duration))
    fi
    running_time=$(($(date +%s)-PROGRESS_START))
    total_time=$((PROGRESS_TOTAL*running_time/$1))
    eta=$( format_eta $(($total_time-$running_time)) )
  fi
  percentage=$1
  if [ $PROGRESS_TOTAL -ne 100 ]
  then [ $PROGRESS_TOTAL -eq 0 ] && percentage=100 || percentage=$((percentage*100/$PROGRESS_TOTAL))
  fi
  extra=$2
  lines=$(tput lines)
  lines=$((lines))
  # Check if the window has been resized. If so, reset the scroll area
  if [ "$lines" -ne "$CURRENT_NR_LINES" ]; then
    setup_scroll_area
  fi
  # Save cursor
  echo -en "$CODE_SAVE_CURSOR"
  # Move cursor position to last row
  echo -en "\033[${lines};0f"
  # Clear progress bar
  tput el
  # Draw progress bar
  PROGRESS_BLOCKED="false"
  print_bar_text $percentage "$extra" "$eta"
  # Restore cursor position
  echo -en "$CODE_RESTORE_CURSOR"
}

function block_progress_bar()
{
  percentage=$1
  lines=$(tput lines)
  lines=$((lines))
  # Save cursor
  echo -en "$CODE_SAVE_CURSOR"
  # Move cursor position to last row
  echo -en "\033[${lines};0f"
  # Clear progress bar
  tput el
  # Draw progress bar
  PROGRESS_BLOCKED="true"
  BLOCKED_START=$( date +%s )
  print_bar_text $percentage
  # Restore cursor position
  echo -en "$CODE_RESTORE_CURSOR"
}

function clear_progress_bar()
{
  lines=$(tput lines)
  lines=$((lines))
  # Save cursor
  echo -en "$CODE_SAVE_CURSOR"
  # Move cursor position to last row
  echo -en "\033[${lines};0f"
  # clear progress bar
  tput el
  # Restore cursor position
  echo -en "$CODE_RESTORE_CURSOR"
}

function print_bar_text()
{
  local percentage=$1
  local extra=$2
  [ -n "$extra" ] && extra=" ($extra)"
  local eta=$3
  if [ -n "$eta" ]; then
    [ -n "$extra" ] && extra="$extra "
    extra="$extra$eta"
  fi
  local cols=$(tput cols)
  bar_size=$((cols-9-${#PROGRESS_TITLE}-${#extra}))
  local color="${COLOR_FG}${COLOR_BG}"
  if [ "$PROGRESS_BLOCKED" = "true" ]; then
    color="${COLOR_FG}${COLOR_BG_BLOCKED}"
  fi
  # Prepare progress bar
  complete_size=$(((bar_size*percentage)/100))
  remainder_size=$((bar_size-complete_size))
  progress_bar=$(echo -ne "["; echo -en "${color}"; printf_new "#" $complete_size; echo -en "${RESTORE_FG}${RESTORE_BG}"; printf_new "." $remainder_size; echo -ne "]");
  # Print progress bar
  echo -ne " $PROGRESS_TITLE ${percentage}% ${progress_bar}${extra}"
}

function enable_trapping()
{
  TRAPPING_ENABLED="true"
}

function trap_on_interrupt()
{
  # If this function is called, we setup an interrupt handler to cleanup the progress bar
  TRAP_SET="true"
  trap cleanup_on_interrupt EXIT
}

function cleanup_on_interrupt()
{
  destroy_scroll_area
  exit
}

function printf_new()
{
  str=$1
  num=$2
  v=$(printf "%-${num}s" "$str")
  echo -ne "${v// /$str}"
}
# END bash_progress_bar

# RelayServer Utils
function resetCaddyDataRelayServer()
{
  is_prompt=$1
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    if [ "$is_prompt" = "true" ]; then
      showMessageBox "No RelayServer" "You do not have a RelayServer set up, exiting..."
    else
      echo "ERROR: You do not have a RelayServer set up."
    fi
    return
  fi
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh"
  unloadSSHKey
}

function getVPNIPFromHostname()
{
  lookup_hostname=$1
  base_domain=$(getBaseDomain $lookup_hostname)
  if [ "$base_domain" = "$HOMESERVER_DOMAIN" ]; then
    echo $(getPrimaryVPN_IP)
    return
  fi
  ip_addr=$(sqlite3 $HSHQ_DB "select IPAddress from connections join hsvpn_connections on connections.ID = hsvpn_connections.ID where ConnectionType='homeserver_vpn' and NetworkType='mynetwork' and DomainName='$lookup_hostname';")
  echo "$ip_addr"
}

function addDomainsToRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    showMessageBox "No RelayServer" "You do not have a RelayServer setup, exiting..."
    return
  fi
  set +e
  domains_to_add=""
  while [ -z "$domains_to_add" ]
  do
    domains_to_add=$(promptUserInputMenu "" "Enter New Domains" "Enter the new domain names that you wish to add, separated by comma (no spaces):")
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return 1
    fi
    if [ -z "$domains_to_add" ]; then
      showMessageBox "Domains List Empty" "The domains list cannot be empty"
    elif [ $(checkValidString "$domains_to_add" ",.-") = "false" ]; then
      showMessageBox "Invalid Character(s)" "The domain list contain invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
      domains_to_add=""
    fi
    domains_to_add_Arr=($(echo $domains_to_add | tr "," "\n"))
    for curDomain in "${domains_to_add_Arr[@]}"
    do
      if [ -z "$curDomain" ] || [ $(checkValidString "$curDomain" ".-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "A domain contains invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
        domains_to_add=""
      fi
    done
  done

  deliveryhostmenu=$(cat << EOF

$(getLogo)
Select the mail delivery host for this domain:

EOF
  )
  dh_arr=($(sqlite3 $HSHQ_DB "select ID,MailHost from mailhosts;"))
  menu_items=""
  for curdh in "${dh_arr[@]}"
  do
    menu_items=${menu_items}"$(echo "("$(echo $curdh | sed 's/|/)/1')) | OFF "
  done
  sel_host=$(whiptail --title "Select Delivery Host" --radiolist "$deliveryhostmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ] || [ -z "$sel_host" ]; then
    showMessageBox "Selection Empty" "Delivery host selection is empty, returning..."
    return 1
  fi

  mail_host_id=$(echo $sel_host | cut -d ")" -f1 | sed 's/(//' | sed 's/"//g')
  deliver_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections join hsvpn_connections on connections.ID = hsvpn_connections.ID where MailHostID=$mail_host_id;")
  if [ -z "$deliver_ip" ]; then
    showMessageBox "IP Not Found" "There is no domain in your network based on this delivery host, returning..."
    return 1
  fi
  deliver_to_host=$(sqlite3 $HSHQ_DB "select MailHost from mailhosts where ID=$mail_host_id;")
  loadSSHKey
  mbres=$?
  if [ $mbres -ne 0 ]; then
    showMessageBox "Error" "There was a problem loading the SSH key"
    return 1
  fi
  ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addRelayedDomains.sh $domains_to_add $deliver_to_host $deliver_ip"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    showMessageBox "Error" "There was a problem adding the domain(s)"
    return 1
  fi
  domains_to_add_Arr=($(echo $domains_to_add | tr "," "\n"))
  for curDomain in "${domains_to_add_Arr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into mailhostmap(MailHostID,Domain,IsFirstDomain) values($mail_host_id,'$curDomain',false);"
    sendDNSRecordsEmail $curDomain
  done
  set -e
}

function removeDomainsFromRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    showMessageBox "No RelayServer" "You do not have a RelayServer setup, exiting..."
    return
  fi
  set +e
  rem_menu=$(cat << EOF

$(getLogo)
Select the domains that you wish to remove:

EOF
  )
  domains_to_rem_qry=($(sqlite3 $HSHQ_DB "select Domain,MailHost from mailhostmap join mailhosts on mailhostmap.MailHostID = mailhosts.ID where IsFirstDomain=false;"))
  if [ -z "$domains_to_rem_qry" ]; then
    showMessageBox "Empty" "There are no eligible connections for this selection, returning..."
    return
  fi
  menu_items=""
  for curdom in "${domains_to_rem_qry[@]}"
  do
    menu_items=${menu_items}"$(echo $(echo $curdom | sed 's/|/(/1')")") | OFF "
  done
  sel_doms=($(whiptail --title "Select Domains" --checklist "$rem_menu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3))
  is_remove=$(promptUserInputMenu "" "Confirm Removal" "This will remove these domains from the RelayServer. To confirm, enter the word 'remove' below:")
  if [ $? -ne 0 ] || [ -z "$is_remove" ] || ! [ "$is_remove" = "remove" ]; then
    showMessageBox "Incorrect Confirmation" "The text did not match, returning..."
    return
  fi
  domains_to_remove=""
  for dom in "${sel_doms[@]}"
  do
    curdom=$(echo $dom | cut -d "(" -f1 | sed 's/"//g')
    domains_to_remove="${domains_to_remove}${curdom},"
  done
  if -z [ "$domains_to_remove" ]; then
    showMessageBox "No Selection" "Nothing was selected, returning..."
    return
  fi
  domains_to_remove=${domains_to_remove%?}
  loadSSHKey
  mbres=$?
  if [ $mbres -ne 0 ]; then
    showMessageBox "Error" "There was a problem loading the SSH key"
    return 1
  fi
  ssh -p $RELAYSERVER_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeRelayedDomains.sh $domains_to_remove"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    showMessageBox "Error" "There was a problem removing the domain(s)"
    return 1
  fi
  for dom in "${sel_doms[@]}"
  do
    curdom=$(echo $dom | cut -d "(" -f1 | sed 's/"//g')
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhostmap where Domain='$curdom';"
  done
}

function addSecondaryDomainToRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  add_domain="$1"
  mail_host_id="$2"
  # Need to check domain name string for validity
  if [ -z "$add_domain" ] || [ $(checkValidString "$add_domain" ".-") = "false" ]; then
    echo "ERROR: Invalid domain name."
    return 5
  fi
  deliver_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections join hsvpn_connections on connections.ID = hsvpn_connections.ID where MailHostID=$mail_host_id;")
  if [ -z "$deliver_ip" ]; then
    echo "ERROR: There is no domain in your network based on this delivery host."
    return 5
  fi
  deliver_to_host=$(sqlite3 $HSHQ_DB "select MailHost from mailhosts where ID=$mail_host_id;")
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addRelayedDomains.sh $add_domain $deliver_to_host $deliver_ip"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem adding the domain to the RelayServer."
    return 5
  fi
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into mailhostmap(MailHostID,Domain,IsFirstDomain) values($mail_host_id,'$add_domain',false);"
  sendDNSRecordsEmail $add_domain
}

function removeSecondaryDomainFromRelayServer()
{
  dom_to_remove="$1"

  le_arr=($(sqlite3 $HSHQ_DB "select Domain from lecertdomains where BaseDomain='$dom_to_remove';"))
  subdomlist=""
  for cursub in "${le_arr[@]}"
  do
    subdomlist=${subdomlist}"${cursub},"
  done
  if ! [ -z "$subdomlist" ]; then
    subdomlist=${subdomlist%?}
    echo "Removing LE cert paths from RelayServer for $dom_to_remove..."
    removeLECertPathsFromRelayServer "$subdomlist"
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return $mbres
    fi
  fi

  exp_arr=($(sqlite3 $HSHQ_DB "select Domain from exposedomains where BaseDomain='$dom_to_remove';"))
  subdomlist=""
  for cursub in "${exp_arr[@]}"
  do
    subdomlist=${subdomlist}"${cursub},"
  done
  if ! [ -z "$subdomlist" ]; then
    subdomlist=${subdomlist%?}
    echo "Removing expose paths from RelayServer for $dom_to_remove..."
    removeExposeDomainPathsFromRelayServer "$subdomlist"
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return $mbres
    fi
  fi

  loadSSHKey
  echo "Removing $dom_to_remove from RelayServer..."
  ssh -p $RELAYSERVER_SSH_PORT -o ConnectTimeout=10 $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeRelayedDomains.sh $dom_to_remove"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem connecting to the RelayServer."
    return 1
  fi
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from mailhostmap where Domain='$dom_to_remove';"
}

function addLECertPathsToRelayServerMsgbox()
{
  set +e
  add_subdomains=$(promptUserInputMenu "" "Enter Subdomain" "Enter the subdomains for which you want LetsEncrypt to manage the certificates(separated by comma):")
  if [ $? -ne 0 ]; then
    return
  fi
  seldomainmenu=$(cat << EOF

$(getLogo)
Select the base domain to associate with these subdomains:

EOF
  )
  dom_arr=($(sqlite3 $HSHQ_DB "select Domain from mailhostmap order by MailHostID asc;"))
  menu_items=""
  for curdom in "${dom_arr[@]}"
  do
    menu_items=${menu_items}"$curdom | OFF "
  done
  sel_domain=$(whiptail --title "Select Base Domain" --radiolist "$seldomainmenu" $MENU_HEIGHT $MENU_WIDTH $MENU_INT_HEIGHT $menu_items 3>&1 1>&2 2>&3)
  if [ $? -ne 0 ] || [ -z "$sel_domain" ]; then
    showMessageBox "Selection Empty" "Base domain selection is empty, returning..."
    return 1
  fi
  sel_domain=$(echo $sel_domain | cut -d "|" -f1 | sed 's/"//g')
  showYesNoMessageBox "Confirm Selection" "Adding $add_subdomains - associated with $sel_domain. Continue?"
  if [ $? -eq 0 ]; then
    addLECertPathsToRelayServer "$add_subdomains" "$sel_domain"
  fi
}

function addLECertPathsToRelayServer()
{
  subdoms_le="$1"
  base_domain="$2"
  if [ $(checkValidString "$subdoms_le" ",.-") = "false" ]; then
    echo "ERROR: A subdomain contains invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
    return 1
  fi
  newList=""
  add_subdomains_Arr=($(echo $subdoms_le | tr "," "\n"))
  for add_sub in "${add_subdomains_Arr[@]}"
  do
    if [ $(checkValidString "$add_sub" ".-") = "false" ]; then
      echo "ERROR: The subdomain contains invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
      return 2
    fi
    checkSub=$(sqlite3 $HSHQ_DB "select Domain from lecertdomains where Domain='$add_sub';")
    if ! [ -z "$checkSub" ]; then
      echo "$checkSub LE path has already been added to RelayServer."
    else
      newList=$newList"${add_sub},"
    fi
  done
  if [ -z "$newList" ]; then
    return
  fi
  newList=${newList%?}
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    sendEmail -s "Add LetsEncrypt Domain" -b "If you have not done so already, you need to contact your RelayServer administrator and ask them to add these subdomains to be managed by LetsEncrypt.\nSubdomains: $subdoms_le" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    return
  fi
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    sendEmail -s "Add LetsEncrypt Domain" -b "If and when you setup a RelayServer, you will need to add these subdomains to be managed by LetsEncrypt.\nSubdomains: $subdoms_le" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    return
  fi

  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addLECertDomains.sh $subdoms_le"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem connecting to the RelayServer."
    return 6
  fi
  add_subdomains_Arr=($(echo $subdoms_le | tr "," "\n"))
  for add_sub in "${add_subdomains_Arr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "insert or ignore into lecertdomains(Domain,BaseDomain) values('$add_sub','$base_domain');"
  done
}

function removeLECertPathsFromRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  subdoms_le="$1"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeLECertDomains.sh $subdoms_le"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem connecting to the RelayServer."
    return 1
  fi
  rem_subdomains_Arr=($(echo $subdoms_le | tr "," "\n"))
  for rem_sub in "${rem_subdomains_Arr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from lecertdomains where Domain='$rem_sub';"
  done
}

function addExposeDomainPathsToRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  subdoms_exp="$1"
  base_domain="$2"

  if [ $(checkValidString "$subdoms_exp" ",.-") = "false" ]; then
    echo "ERROR: A subdomain contains invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
    return 2
  fi
  add_subdomains_Arr=($(echo $subdoms_exp | tr "," "\n"))
  newList=""
  for add_sub in "${add_subdomains_Arr[@]}"
  do
    if [ $(checkValidString "$add_sub" ".-") = "false" ]; then
      echo "ERROR: The subdomain contains invalid character(s). The value must consist of a-z (lowercase), 0-9, -, and/or ."
      return 3
    fi
    checkSub=$(sqlite3 $HSHQ_DB "select Domain from exposedomains where Domain='$add_sub';")
    if ! [ -z "$checkSub" ]; then
      echo "$checkSub is already exposed on the RelayServer."
    else
      newList=$newList"${add_sub},"
    fi
  done
  if [ -z "$newList" ]; then
    return
  fi
  last_relay_expose_filename=lastrelayexpose.txt
  if ! [ -f $HSHQ_CONFIG_DIR/$last_relay_expose_filename ]; then
    echo "$(date +%s)" > $HSHQ_CONFIG_DIR/$last_relay_expose_filename
  else
    lastExpose=$(head -n 1 $HSHQ_CONFIG_DIR/$last_relay_expose_filename)
    if [ $(date +%s) -lt $(($lastExpose+300)) ]; then
      echo "ERROR: You need to wait at least 5 minutes between subsequent requests to allow the certificate-issuing process to complete."
      return 4
    fi
  fi
  newList=${newList%?}
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addExposeDomains.sh $subdoms_exp"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem connecting to the RelayServer."
    return 5
  fi
  add_subdomains_Arr=($(echo $subdoms_exp | tr "," "\n"))
  for add_sub in "${add_subdomains_Arr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "insert or ignore into exposedomains(Domain,BaseDomain) values('$add_sub','$base_domain');"
  done
  echo "$(date +%s)" > $HSHQ_CONFIG_DIR/$last_relay_expose_filename
}

function removeExposeDomainPathsFromRelayServer()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  subdoms_exp="$1"
  loadSSHKey
  ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeExposeDomains.sh $subdoms_exp"
  mbres=$?
  unloadSSHKey
  if [ $mbres -ne 0 ]; then
    echo "ERROR: There was a problem connecting to the RelayServer."
    return 1
  fi
  rem_subdomains_Arr=($(echo $subdoms_exp | tr "," "\n"))
  for rem_sub in "${rem_subdomains_Arr[@]}"
  do
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from exposedomains where Domain='$rem_sub';"
  done
}

function showEmailMyNetworkHomeServerDNSListMenu()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    showMessageBox "No RelayServer" "You are not hosting a RelayServer, returning..."
    return
  fi
  sendEmailMyNetworkHomeServerDNSList
}

function showEmailMyNetworkHomeServerDNSListNoMenu()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  sendEmailMyNetworkHomeServerDNSList
}

function sendEmailMyNetworkHomeServerDNSList()
{
  hs_email_subj="(MGR COPY)HomeServer DNS Update from $HOMESERVER_NAME"
  hs_email_body="$(getMyNetworkHomeServersDNSUpdateEmailBody)"
  echo "Sending HomeServer Update email to self"
  sendEmail -s "$hs_email_subj" -b "$hs_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function showEmailMyNetworkHomeServerDNSListClientDNSMenu()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    showMessageBox "No RelayServer" "You are not hosting a RelayServer, returning..."
    return
  fi
  sendEmailMyNetworkHomeServerDNSListClient
}

function showEmailMyNetworkHomeServerDNSListClientDNSNoMenu()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  sendEmailMyNetworkHomeServerDNSListClient
}

function sendEmailMyNetworkHomeServerDNSListClient()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  users_email_subj="(MGR COPY)HomeServer ClientDNS Update from $HOMESERVER_NAME"
  users_email_body="$(getMyNetworkHomeServerDNSListClientDNSBody)"
  echo "Sending ClientDNS email to self"
  sendEmail -s "$users_email_subj" -b "$users_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function sendEmailMyNetworkFullUserDetails()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  full_network_email_subj="Full User Details for Hosted VPN"
  full_network_email_body=""
  full_network_email_body=$full_network_email_body"Full User Details for Hosted VPN\n\n"
  full_network_email_body=$full_network_email_body"------------------------------------------------------------------------\n"
  full_network_email_body=$full_network_email_body"Name,Email,PublicKey,PresharedKey,IP Address,Is Internet?\n"
  full_network_email_body=$full_network_email_body"------------------------------------------------------------------------\n"
  user_arr=($(sqlite3 $HSHQ_DB "select ID from connections where NetworkType='mynetwork' and ConnectionType='user';"))
  for cur_user_id in "${user_arr[@]}"
  do
    cur_name=$(sqlite3 $HSHQ_DB "select Name from connections where ID='$cur_user_id';")
    cur_email=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID='$cur_user_id';")
    pub_key=$(sqlite3 $HSHQ_DB "select PublicKey from connections where ID='$cur_user_id';")
    pre_key=$(sqlite3 $HSHQ_DB "select PresharedKey from connections where ID='$cur_user_id';")
    ip_addr=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID='$cur_user_id';")
    is_int=$(sqlite3 $HSHQ_DB "select IsInternet from connections where ID='$cur_user_id';")
    is_internet="No"
    if [ $is_int = 1 ]; then
      is_internet="Yes"
    fi
    full_network_email_body=$full_network_email_body"$cur_name,$cur_email,$pub_key,$pre_key,$ip_addr,$is_internet\n"
  done
  full_network_email_body=$full_network_email_body"\n\n"
  sendEmail -s "$full_network_email_subj" -b "$full_network_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function sendEmailMyNetworkBroadcast()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "ERROR: You are not hosting a RelayServer."
    return 1
  fi
  strMessage="$1"
  full_network_email_subj="Broadcase Message from $HOMESERVER_NAME"
  full_network_email_body=""
  full_network_email_body=$full_network_email_body"Broadcase Message from $HOMESERVER_NAME\n"
  full_network_email_body=$full_network_email_body"------------------------------------------------------------------------\n"
  full_network_email_body=$full_network_email_body"$strMessage\n\n"
  email_list=($(sqlite3 $HSHQ_DB "select EmailAddress from connections where NetworkType='mynetwork';"))
  for cur_email in "${email_list[@]}"
  do
    echo "Sending broadcast message to ${cur_email}..."
    sendEmail -s "$full_network_email_subj" -b "$full_network_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>" -t "$cur_email"
  done
  # Send to self
  echo "Sending broadcast message to self..."
  sendEmail -s "$full_network_email_subj" -b "$full_network_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function notifyMyNetworkHomeServersDNSUpdate()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    return
  fi
  addOrRemove="$1"
  addRemoveHSName="$2"
  addRemoveDomainName="$3"
  hs_email_subj="HomeServer DNS Update from $HOMESERVER_NAME"
  hs_email_body=$(getMyNetworkHomeServersDNSUpdateEmailBody "$addOrRemove" "$addRemoveHSName" "$addRemoveDomainName")
  hs_list=($(sqlite3 $HSHQ_DB "select EmailAddress from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork' group by EmailAddress;"))
  for curEmail in "${hs_list[@]}"
  do
    # Skip the domain being added/removed. This will skip anyone with an email address on that domain, but this is less impactful and likely better than the alternative.
    if ! [ "$(getDomainFromEmailAddress $curEmail)" = "$addRemoveDomainName" ]; then 
      echo "Sending HomeServer Update email to $curEmail"
      sendEmail -s "$hs_email_subj" -b "$hs_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
    fi
  done
  echo "Sending HomeServer Update email to self"
  hs_email_subj="(MGR COPY)HomeServer DNS Update from $HOMESERVER_NAME"
  sendEmail -s "$hs_email_subj" -b "$hs_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function getDomainFromEmailAddress()
{
  email_addr="$1"
  echo echo "$email_addr" | cut -d "@" -f2
}

function notifyMyNetworkUsersDNSUpdate()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    return
  fi
  addOrRemove="$1"
  addRemoveHSName="$2"
  addRemoveDomainName="$3"
  addRemoveDomainNameExtPrefix="$4"
  addRemoveDomainNameIPAddress="$5"
  users_email_subj="HomeServer ClientDNS Update from $HOMESERVER_NAME"
  users_email_body=$(getMyNetworkHomeServerDNSListClientDNSBody "$addOrRemove" "$addRemoveHSName" "$addRemoveDomainName" "$addRemoveDomainNameExtPrefix" "$addRemoveDomainNameIPAddress")
  users_list=($(sqlite3 $HSHQ_DB "select EmailAddress from connections where ConnectionType='user' and NetworkType='mynetwork' group by EmailAddress;"))
  for curEmail in "${users_list[@]}"
  do
    echo "Sending ClientDNS email to $curEmail"
    sendEmail -s "$users_email_subj" -b "$users_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  done
  echo "Sending ClientDNS email to self"
  users_email_subj="(MGR COPY)HomeServer ClientDNS Update from $HOMESERVER_NAME"
  sendEmail -s "$users_email_subj" -b "$users_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function getMyNetworkHomeServersDNSUpdateEmailBody()
{
  addOrRemove="$1"
  addRemoveHSName="$2"
  addRemoveDomainName="$3"
  email_body=""
  email_body=${email_body}"HomeServer DNS Update from $HOMESERVER_NAME\n"
  email_body=${email_body}"=======================================================================\n\n"
  if ! [ -z "$addOrRemove" ]; then
    case "$addOrRemove" in
      add)
        email_body=${email_body}"ADDED the following HomeServer: \n\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n"
        email_body=${email_body}"HomeServer Name: ${addRemoveHSName}\n"
        email_body=${email_body}"HomeServer Domain: ${addRemoveDomainName}\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n\n"
        ;;
      remove)
        email_body=${email_body}"REMOVED the following HomeServer: \n\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n"
        email_body=${email_body}"HomeServer Name: ${addRemoveHSName}\n"
        email_body=${email_body}"HomeServer Domain: ${addRemoveDomainName}\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n\n"
        ;;
    esac
  fi
  email_body=${email_body}"1. Ensure this is the most recent version of this email with matching subject\n"
  email_body=${email_body}"line (HomeServer DNS Update from $HOMESERVER_NAME).\n\n"
  email_body=${email_body}"2. Go to the Script-server app, and navigate to 07 Other Networks > 08 Update HomeServer DNS\n"
  email_body=${email_body}"and paste the ENTIRE list BELOW the following line where appropriate.\n\n"
  email_body=${email_body}"3. After applying the update, you may delete any prior emails with the matching\n"
  email_body=${email_body}"subject line (HomeServer DNS Update from $HOMESERVER_NAME).\n\n\n"
  email_body=${email_body}"HomeServer Name|Host Domain|Peer Domain|External Prefix|IP Address\n"
  email_body=${email_body}"_______________________________________________________________________\n\n"
  email_body=${email_body}"$(getMyNetworkHomeServerDNSList)\n\n"
  echo "${email_body}"
}

function getMyNetworkHomeServerDNSListClientDNSBody()
{
  addOrRemove="$1"
  addRemoveHSName="$2"
  addRemoveDomainName="$3"
  addRemoveDomainNameExtPrefix="$4"
  addRemoveDomainNameIPAddress="$5"
  email_body=""
  email_body=${email_body}"HomeServer ClientDNS Update from $HOMESERVER_NAME\n"
  email_body=${email_body}"=======================================================================\n\n"
  email_body=${email_body}"If your client device uses a DNS server in this network\n"
  email_body=${email_body}"($PRIMARY_VPN_SUBNET), then you can likely disregard this message.\n"
  email_body=${email_body}"Otherwise, see changes and full DNS list below and update accordingly.\n"
  email_body=${email_body}"These entries are formatted for DNSMasq and can be dropped directly\n"
  email_body=${email_body}"into your ClientDNS server.\n\n"

  if ! [ -z "$addOrRemove" ]; then
    case "$addOrRemove" in
      add)
        email_body=${email_body}"ADDED the following HomeServer: \n\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n"
        email_body=${email_body}"# ${addRemoveHSName} \n"
        email_body=${email_body}"server=/.${addRemoveDomainNameExtPrefix}.${addRemoveDomainName}/127.0.0.11\n"
        email_body=${email_body}"address=/.${addRemoveDomainName}/${addRemoveDomainNameIPAddress}\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n\n\n"
        ;;
      remove)
        email_body=${email_body}"REMOVED the following HomeServer: \n\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n"
        email_body=${email_body}"# ${addRemoveHSName} \n"
        email_body=${email_body}"server=/.${addRemoveDomainNameExtPrefix}.${addRemoveDomainName}/127.0.0.11\n"
        email_body=${email_body}"address=/.${addRemoveDomainName}/${addRemoveDomainNameIPAddress}\n"
        email_body=${email_body}"-----------------------------------------------------------------------\n\n\n"
        ;;
    esac
  fi
  email_body=${email_body}"Full Domain List for ${HOMESERVER_NAME}: \n"
  email_body=${email_body}"_______________________________________________________________________\n\n"
  email_body=${email_body}"$(getMyNetworkHomeServerDNSListForClientDNS)\n\n"
  echo "${email_body}"
}

function notifyMyNetworkFullRemoval()
{
  hs_email_join_addendum=""
  hs_email_subj="HomeServer Network Reset Notice from $HOMESERVER_NAME"
  hs_email_body=""
  hs_email_body=${hs_email_body}"HomeServer Network Reset Notice from $HOMESERVER_NAME\n"
  hs_email_body=${hs_email_body}"================================================================\n\n"
  hs_email_body=${hs_email_body}"$HOMESERVER_NAME has initiated a full network reset. \n"
  hs_email_body=${hs_email_body}"Your HomeServer along with all other connections have been \n"
  hs_email_body=${hs_email_body}"removed from the network. Please disconnect accordingly.\n\n"
  hs_email_body=${hs_email_body}"Host Domain: $HOMESERVER_DOMAIN\n"
  hs_email_body=${hs_email_body}"Reason Provided: $disconnect_reason\n\n"
  full_hs_list=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork';"))

  for curID in "${full_hs_list[@]}"
  do
    curEmail=$(sqlite3 $HSHQ_DB "select EmailAddress from connections where ID=$curID;")
    is_primary=$(sqlite3 $HSHQ_DB "select IsPrimary from hsvpn_connections where ID=$curID;")
    hs_email_join_addendum=""
    if [ $is_primary = 1 ]; then
      hs_email_join_addendum=${hs_email_join_addendum}"\nThis is your HomeServer's primary VPN connection. Thus, you will\n"
      hs_email_join_addendum=${hs_email_join_addendum}"lose the ability to receive external emails, etc. In the $HSHQ_WRAP_FILENAME script,\n"
      hs_email_join_addendum=${hs_email_join_addendum}"go to Network -> RelayServer Utils -> Create or Join a VPN RelayServer\n"
      hs_email_join_addendum=${hs_email_join_addendum}"and set up a new primary VPN connection.\n\n"
    fi
    cur_email_body="${hs_email_body}\n${hs_email_join_addendum}"
    echo "Sending email to $curEmail"
    sendEmail -s "$hs_email_subj" -b "$cur_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  done

  user_email_subj="HomeServer Network Reset Notice from $HOMESERVER_NAME"
  user_email_body=""
  user_email_body=${user_email_body}"HomeServer Network Reset Notice from $HOMESERVER_NAME\n"
  user_email_body=${user_email_body}"================================================================\n\n"
  user_email_body=${user_email_body}"$HOMESERVER_NAME has initiated a full network reset. \n"
  user_email_body=${user_email_body}"Your client connection along with all other connections have been \n"
  user_email_body=${user_email_body}"removed from the network. Please remove this connection accordingly.\n\n"
  user_email_body=${user_email_body}"Host Domain: $HOMESERVER_DOMAIN\n"
  user_email_body=${user_email_body}"Reason Provided: $disconnect_reason\n\n"
  full_user_list=($(sqlite3 $HSHQ_DB "select EmailAddress from connections where ConnectionType='user' and NetworkType='mynetwork' group by EmailAddress;"))

  for curEmail in "${full_user_list[@]}"
  do
    echo "Sending email to $curEmail"
    sendEmail -s "$user_email_subj" -b "$user_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  done
}

function notifyMyNetworkTransferRelayServer()
{
  new_rs_ip="$1"
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    return
  fi
  users_email_subj="RelayServer Transfer Notice from $HOMESERVER_NAME"
  users_email_body="RelayServer Transfer Notice from ${HOMESERVER_NAME}\n"
  users_email_body=${users_email_body}"=======================================================================\n\n"
  users_email_body=${users_email_body}"$HOMESERVER_NAME has performed a RelayServer transfer. You will\n"
  users_email_body=${users_email_body}"need to disable, then re-enable your WireGuard client(s) in order\n"
  users_email_body=${users_email_body}"to restore connection to this network. There may also be some\n"
  users_email_body=${users_email_body}"short-term connectivity issues with servers on this network\n"
  users_email_body=${users_email_body}"while the network is auto-adjusting to this change.\n\n"
  users_list=($(sqlite3 $HSHQ_DB "select EmailAddress from connections where ConnectionType='user' and NetworkType='mynetwork' group by EmailAddress;"))
  for curEmail in "${users_list[@]}"
  do
    echo "Sending Transfer Notice email to $curEmail"
    sendEmail -s "$users_email_subj" -b "$users_email_body" -t "$curEmail" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  done
  echo "Sending Transfer Notice email to self"
  users_email_subj="(MGR COPY)RelayServer Transfer Notice from $HOMESERVER_NAME"
  other_doms=($(sqlite3 $HSHQ_DB "select Domain from mailhostmap where Domain not in ('$HOMESERVER_DOMAIN');"))
  doms_list=""
  for curDom in "${other_doms[@]}"
  do
    doms_list=${doms_list}${curDom}"\n"
  done
  mgr_email_body="$users_email_body"
  if ! [ -z "$doms_list" ]; then
    mgr_email_body=${mgr_email_body}"The following domains also need the DNS records to be updated\n"
    mgr_email_body=${mgr_email_body}"with the new RelayServer IP Address ($new_rs_ip): \n${doms_list}"
  fi
  sendEmail -s "$users_email_subj" -b "$mgr_email_body" -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function getMyNetworkHomeServerDNSList()
{
  strOutput=""
  hs_arr=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType in ('primary','mynetwork');"))
  for curID in "${hs_arr[@]}"
  do
    strOutput=${strOutput}"$(sqlite3 $HSHQ_DB "select HomeServerName from hsvpn_connections where ID=$curID;")|"
    strOutput=${strOutput}"$HOMESERVER_DOMAIN|"
    strOutput=${strOutput}"$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$curID;")|"
    strOutput=${strOutput}"$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$curID;")|"
    strOutput=${strOutput}"$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$curID;")\n"
  done
  echo "$strOutput"
  strOutput=""
}

function getMyNetworkHomeServerDNSListForClientDNS()
{
  strOutput=""
  # First, output our primary network info
  prim_id=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='primary';")
  curExtPrefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$prim_id;")
  curIntPrefix=$(sqlite3 $HSHQ_DB "select InternalPrefix from hsvpn_connections where ID=$prim_id;")
  curDomName=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$prim_id;")
  curHSName=$(sqlite3 $HSHQ_DB "select HomeServerName from hsvpn_connections where ID=$prim_id;")
  curIPAddr=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$prim_id;")
  strOutput=${strOutput}"# ${curHSName}\n"
  strOutput=${strOutput}"server=/.${curExtPrefix}.${curDomName}/127.0.0.11\n"
  strOutput=${strOutput}"address=/.${curDomName}/${curIPAddr}\n"
  curIPAddr=$(sqlite3 $HSHQ_DB "select RS_VPN_IP from hsvpn_connections where ID=$prim_id;")
  strOutput=${strOutput}"address=/.${curIntPrefix}.${curDomName}/${curIPAddr}\n\n"

  # Then, output the rest of the network. Slightly repetitive of above, but ensures primary network gets output first, for organizational purposes.
  hs_arr=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork';"))
  for curID in "${hs_arr[@]}"
  do
    curExtPrefix=$(sqlite3 $HSHQ_DB "select ExternalPrefix from hsvpn_connections where ID=$curID;")
    curDomName=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections where ID=$curID;")
    curHSName=$(sqlite3 $HSHQ_DB "select HomeServerName from hsvpn_connections where ID=$curID;")
    curIPAddr=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$curID;")
    strOutput=${strOutput}"# ${curHSName}\n"
    strOutput=${strOutput}"server=/.${curExtPrefix}.${curDomName}/127.0.0.11\n"
    strOutput=${strOutput}"address=/.${curDomName}/${curIPAddr}\n\n"
  done
  echo "$strOutput"
  strOutput=""
}

function showUpdateHomeServerDNSMenu()
{
  dns_file=$HOME/dns.tmp
  showMessageBox "Paste DNS Entries" "In this next step, you will need to paste the entire list of DNS entries. After pasting, press CTRL-o to save, then Enter to confirm, then CTRL-x to exit. Please remember these key combinations. Press OK to proceed."
  nano $dns_file
  if ! [ -f $dns_file ]; then
    showMessageBox "Empty File" "The file is empty, returning..."
    return
  fi
  updateHomeServerDNS $dns_file
  rm -f $dns_file
}

function removeRevertDNS()
{
  curDomain=$1
  curExtPrefix=$2
  # First, try to downgrade to direct connection, i.e. we are hosting on their network.
  new_dns=$(sqlite3 $HSHQ_DB "select ID,PeerDomainExtPrefix,IPAddress from hsvpn_dns where PeerDomain='$curDomain' and HostDomain='$curDomain';")
  if [ -z "$new_dns" ]; then
    # No direct connection, try to find any other possible connections.
    new_dns=$(sqlite3 $HSHQ_DB "select ID,PeerDomainExtPrefix,IPAddress from hsvpn_dns where PeerDomain='$curDomain' order by DateAdded asc limit 1;")
  fi
  if [ -z "$new_dns" ]; then
    # No entries, delete current DNS entry
    deleteDomainAndWildcardAdguardHS "$curDomain"
    deleteDomainAdguardHS "*.$curExtPrefix.$curDomain"
    removeDomainAndWildcardIgnoreQuerylogAndStatsHS "$curDomain"
    # Eventually delete this next line, but we'll leave it in for awhile
    deleteSvcUptimeKuma "https://$SUB_HSHQHOME.${curDomain}" true
    deleteSvcUptimeKuma "https://$SUB_HSHQSTATUS.${curDomain}" true
  else
    # Found an alternate, replace it
    curID=$(echo "$new_dns" | cut -d "|" -f1)
    ext_prefix=$(echo "$new_dns" | cut -d "|" -f2)
    ip_addr=$(echo "$new_dns" | cut -d "|" -f3)
    addDomainAndWildcardAdguardHS "$curDomain" "$ip_addr"
    addDomainAdguardHS "*.$curExtPrefix.$curDomain" "A"
    sudo sqlite3 $HSHQ_DB "update hsvpn_dns set IsActive=1 where ID=$curID;"
  fi
}

function updateHomeServerDNS()
{
  dns_file=$1
  removeSpecialChars "$dns_file"
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  lines=$(cat $dns_file)
  curdt=$(getCurrentDate)
  sudo sqlite3 $HSHQ_DB "drop table if exists dns_tmp;"
  sudo sqlite3 $HSHQ_DB "create table dns_tmp(HostDomain text not null,PeerDomain text not null,PRIMARY KEY (HostDomain, PeerDomain));"
  primaryDomain=$(sqlite3 $HSHQ_DB "select DomainName from hsvpn_connections join connections on hsvpn_connections.ID = connections.ID where ConnectionType='homeserver_vpn' and NetworkType='primary';")
  is_error=false
  error_text=""
  for curLine in $lines
  do
    if [ -z "$curLine" ]; then
      continue
    fi
    curHSName=$(echo "$curLine" | cut -d "|" -f1)
    curHostDomain=$(echo "$curLine" | cut -d "|" -f2)
    curPeerDomain=$(echo "$curLine" | cut -d "|" -f3)
    curExtPrefix=$(echo "$curLine" | cut -d "|" -f4)
    curIP=$(echo "$curLine" | cut -d "|" -f5)
    if [ "$curPeerDomain" = "$HOMESERVER_DOMAIN" ]; then
      continue
    fi
    if [ -z "$curHSName" ]; then
      is_error=true
      error_text="The HomeServer name is empty."
      break
    fi
    if [ -z "$curHostDomain" ]; then
      is_error=true
      error_text="The host domain name is empty."
      break
    fi
    if [ -z "$curPeerDomain" ]; then
      is_error=true
      error_text="The peer domain name is empty."
      break
    fi
    if [ -z "$curExtPrefix" ]; then
      is_error=true
      error_text="The ext prefix is empty."
      break
    fi
    if [ -z "$curIP" ]; then
      is_error=true
      error_text="The ip address is empty."
      break
    fi
    check_ip=$(checkHomeServerDNSIPAddressInVPN $curHostDomain $curPeerDomain $curIP)
    if ! [ "$check_ip" = "true" ]; then
      is_error=true
      error_text="$check_ip"
      break
    fi
    if [ "$(checkUpdateHomeServerDNSVars)" = "true" ]; then
      is_dns_added=$(sqlite3 $HSHQ_DB "select IsActive from hsvpn_dns where HostDomain='$curHostDomain' and PeerDomain='$curPeerDomain';")
      sudo sqlite3 $HSHQ_DB "insert into dns_tmp(HostDomain,PeerDomain) values('$curHostDomain','$curPeerDomain');"
      if [ "$curHostDomain" = "$HOMESERVER_DOMAIN" ]; then
        continue
      fi
      if ! [ -z "$is_dns_added" ]; then
        # Check if IP has changed and update accordingly.
        db_ip=$(sqlite3 $HSHQ_DB "select IPAddress from hsvpn_dns where HostDomain='$curHostDomain' and PeerDomain='$curPeerDomain';")
        if ! [ "$db_ip" = "$curIP" ]; then
          echo "IP has changed, Old: $db_ip, New: $curIP"
          sudo sqlite3 $HSHQ_DB "update hsvpn_dns set IPAddress='$curIP' where HostDomain='$curHostDomain' and PeerDomain='$curPeerDomain';"
          if [ $is_dns_added = 1 ]; then
            addDomainAndWildcardAdguardHS "$curPeerDomain" "$curIP"
          fi
        fi
        continue
      fi
      is_active=0
      is_dns_exist=$(sqlite3 $HSHQ_DB "select PeerDomain from hsvpn_dns where PeerDomain='$curPeerDomain';")
      is_host_my_network=$(sqlite3 $HSHQ_DB "select PeerDomain from hsvpn_dns where HostDomain='$HOMESERVER_DOMAIN' and PeerDomain='$curPeerDomain';")
      if [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ] && [ "$primaryDomain" = "$curHostDomain" ]; then
        is_active=1
        if ! [ -z "$is_dns_exist" ]; then
          # DNS entry exists, but need to upgrade it since it is on our primary network.
          sudo sqlite3 $HSHQ_DB "update hsvpn_dns set IsActive=0 where PeerDomain='$curPeerDomain';"
        fi
        addDomainAndWildcardAdguardHS "$curPeerDomain" "$curIP"
        addDomainAdguardHS "*.$curExtPrefix.$curPeerDomain" "A"
        insertEnableSvcHeimdall heimdall "$curHSName" homeservers "https://$SUB_HSHQHOME.$curPeerDomain" "hs2.png" true "$(getHeimdallOrderFromSub $SUB_HSHQHOME homeservers)"
      else
        if [ -z "$is_dns_exist" ]; then
          # No entry exists, add a new one
          is_active=1
          addDomainAndWildcardAdguardHS "$curPeerDomain" "$curIP"
          addDomainAdguardHS "*.$curExtPrefix.$curPeerDomain" "A"
        elif [ -z "$is_host_my_network" ] && [ "$curHostDomain" = "$curPeerDomain" ]; then
          # DNS entry exists, but need to upgrade it since it is a direct connection.
          is_active=1
          addDomainAndWildcardAdguardHS "$curPeerDomain" "$curIP"
          addDomainAdguardHS "*.$curExtPrefix.$curPeerDomain" "A"
          sudo sqlite3 $HSHQ_DB "update hsvpn_dns set IsActive=0 where PeerDomain='$curPeerDomain';"
        fi
      fi
      sudo sqlite3 $HSHQ_DB "insert into hsvpn_dns(HostDomain,PeerDomain,PeerDomainExtPrefix,IPAddress,DateAdded,IsActive) values('$curHostDomain','$curPeerDomain','$curExtPrefix','$curIP','$curdt',$is_active);"
    fi
  done
  IFS=$OLDIFS
  if [ "$is_error" = "true" ]; then
    email_subj="ERROR - HomeServer DNS Update"
    email_body="There was an error detected with the most recent HomeServer DNS Update: \n\n"
    email_body=$email_body"$error_text"
    sendEmail -s "$email_subj" -b "$email_body"
    echo "Error detected, see admin email ($EMAIL_ADMIN_EMAIL_ADDRESS) for details, returning..."
    sudo sqlite3 $HSHQ_DB "drop table dns_tmp;"
    return
  fi
  host_list=($(sqlite3 $HSHQ_DB "select HostDomain from dns_tmp group by HostDomain;"))
  for cur_host in "${host_list[@]}"
  do
    if  [ "$curHostDomain" = "$HOMESERVER_DOMAIN" ]; then
      # Don't process our own records (protect user error)
      continue
    fi
    # Check if any DNS entries need to be deleted/reverted
    del_list=($(sqlite3 $HSHQ_DB "select hsvpn_dns.PeerDomain,hsvpn_dns.PeerDomainExtPrefix from hsvpn_dns left join dns_tmp on hsvpn_dns.HostDomain = dns_tmp.HostDomain and hsvpn_dns.PeerDomain = dns_tmp.PeerDomain where hsvpn_dns.HostDomain = '$cur_host' and dns_tmp.HostDomain is NULL;"))
    for curdns in "${del_list[@]}"
    do
      curPeerDomain=$(echo "$curdns" | cut -d "|" -f1)
      curExtPrefix=$(echo "$curdns" | cut -d "|" -f2)
      is_dns_active=$(sqlite3 $HSHQ_DB "select IsActive from hsvpn_dns where HostDomain='$cur_host' and PeerDomain='$curPeerDomain';")
      sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from hsvpn_dns where HostDomain='$cur_host' and PeerDomain='$curPeerDomain';"
      if [ $is_dns_active = 1 ]; then
        removeRevertDNS $curPeerDomain $curExtPrefix
      fi
      if [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ] && [ "$primaryDomain" = "$cur_host" ]; then
        deleteSvcHeimdall homeservers "https://$SUB_HSHQHOME.$curPeerDomain" false
      fi
    done
  done
  sudo sqlite3 $HSHQ_DB "drop table dns_tmp;"
}

function checkHomeServerDNSIPAddressInVPN()
{
  host_domain=$1
  peer_domain=$2
  ip_addr=$3
  host_net=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections join hsvpn_connections on connections.ID = hsvpn_connections.ID where connections.NetworkType='other' and hsvpn_connections.DomainName='$host_domain';")
  is_in_subnet=$(isIPInSubnet $ip_addr $host_net)
  if [ "$is_in_subnet" = "true" ]; then
    echo "true"
  else
    echo "Host Domain: $host_domain, Peer domain: $peer_domain, IP address ($ip_addr) is not in correct subnet ($host_net)."
  fi
}

function syncAdguardDNSFromDB()
{
  dns_list=($(sqlite3 $HSHQ_DB "select PeerDomain,PeerDomainExtPrefix,IPAddress from hsvpn_dns where IsActive=1;"))
  for curdns in "${dns_list[@]}"
  do
    curPeerDomain=$(echo "$curdns" | cut -d "|" -f1)
    curExtPrefix=$(echo "$curdns" | cut -d "|" -f2)
    curIPAddress=$(echo "$curdns" | cut -d "|" -f3)
    if ! [ "$curPeerDomain" = "$HOMESERVER_DOMAIN" ]; then
      addDomainAndWildcardAdguardHS "$curPeerDomain" "$curIPAddress"
      addDomainAdguardHS "*.$curExtPrefix.$curPeerDomain" "A"
    fi
  done
}

function checkUpdateHomeServerDNSVars()
{
  # TODO
  echo "true"
}

# Adguard Utils
function getAdguardCredentialsHS()
{
  echo -n $ADGUARD_ADMIN_USERNAME:$ADGUARD_ADMIN_PASSWORD | base64
}

function getAdguardCredentialsRS()
{
  echo -n $RELAYSERVER_ADGUARD_ADMIN_USERNAME:$RELAYSERVER_ADGUARD_ADMIN_PASSWORD | base64
}

function addDomainAndWildcardAdguardHS()
{
  deleteDomainAndWildcardAdguardHS "$1"
  addDomainAdguardHS "$1" "$2"
  addDomainAdguardHS "*.$1" "$2"
}

function addDomainAdguardHS()
{
  set +e
  add_domain="$1"
  add_ip_addr="$2"
  basic_auth="$(getAdguardCredentialsHS)"
  deleteDomainAdguardHS $add_domain "$basic_auth"
  dom_json=$(jq -n --arg add_domain $add_domain --arg add_ip_addr $add_ip_addr '{domain: $add_domain, answer: $add_ip_addr}')
  curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/add
}

function addDomainAndWildcardAdguardNoReplaceHS()
{
  addDomainAdguardNoReplaceHS "$1" "$2"
  addDomainAdguardNoReplaceHS "*.$1" "$2"
}

function addDomainAdguardNoReplaceHS()
{
  set +e
  add_domain="$1"
  add_ip_addr="$2"
  basic_auth="$(getAdguardCredentialsHS)"
  curl -s -H "Authorization: Basic $basic_auth" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/list | jq -r --arg add_domain $add_domain '.[] | select(.domain==$add_domain) | .domain' | grep $add_domain > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    dom_json=$(jq -n --arg add_domain $add_domain --arg add_ip_addr $add_ip_addr '{domain: $add_domain, answer: $add_ip_addr}')
    curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/add
  fi
}

function deleteDomainAndWildcardAdguardHS()
{
  deleteDomainAdguardHS "$1"
  deleteDomainAdguardHS "*.$1"
}

function deleteDomainAdguardHS()
{
  set +e
  del_domain="$1"
  basic_auth="$(getAdguardCredentialsHS)"
  curl -s -H "Authorization: Basic $basic_auth" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/list | jq -r --arg del_domain $del_domain '.[] | select(.domain==$del_domain) | .domain' | grep "$del_domain" >/dev/null
  if [ $? -eq 0 ]; then
    # Exists, need to determine IP address to delete
    del_ip_addr=$(curl -s -H "Authorization: Basic $basic_auth" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/list | jq -r --arg del_domain $del_domain '.[] | select(.domain==$del_domain) | .answer')
    dom_json=$(jq -n --arg del_domain $del_domain --arg del_ip_addr $del_ip_addr '{domain: $del_domain, answer: $del_ip_addr}')
    curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/delete
  fi
}

function deleteDomainByIPAndWildcardAdguardHS()
{
  deleteDomainByIPAdguardHS "$1" "$2"
  deleteDomainByIPAdguardHS "*.$1" "$2"
}

function deleteDomainByIPAdguardHS()
{
  set +e
  del_domain="$1"
  del_ip_addr="$2"
  basic_auth="$(getAdguardCredentialsHS)"
  dom_json=$(jq -n --arg del_domain $del_domain --arg del_ip_addr $del_ip_addr '{domain: $del_domain, answer: $del_ip_addr}')
  curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/rewrite/delete
}

function clearQueryLogAndStatsAdguardHS()
{
  basic_auth="$(getAdguardCredentialsHS)"
  http --verify=no POST https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog_clear "Authorization: Basic $basic_auth" >/dev/null
  http --verify=no POST https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats_reset "Authorization: Basic $basic_auth" >/dev/null
}

function addDomainAndWildcardIgnoreQuerylogAndStatsHS()
{
  adawiqs_curE=${-//[^e]/}
  set +e
  add_domain="$1"
  basic_auth="$(getAdguardCredentialsHS)"

  # Query log
  check_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config "Authorization: Basic $basic_auth" | jq '.ignored')
  echo "$check_conf" | grep "$add_domain" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    new_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config "Authorization: Basic $basic_auth" | jq --arg add_domain "$add_domain" '.ignored += [$add_domain]' | jq --arg add_domain "*.$add_domain" '.ignored += [$add_domain]')
    curl -s -X PUT -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$new_conf" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config/update
  fi

  # Stats
  check_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config "Authorization: Basic $basic_auth" | jq '.ignored')
  echo "$check_conf" | grep "$add_domain" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    new_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config "Authorization: Basic $basic_auth" | jq --arg add_domain "$add_domain" '.ignored += [$add_domain]' | jq --arg add_domain "*.$add_domain" '.ignored += [$add_domain]')
    curl -s -X PUT -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$new_conf" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config/update
  fi

  if ! [ -z "$adawiqs_curE" ]; then
    set -e
  fi
}

function removeDomainAndWildcardIgnoreQuerylogAndStatsHS()
{
  rdawiqs_curE=${-//[^e]/}
  set +e
  rem_domain="$1"
  basic_auth="$(getAdguardCredentialsHS)"

  # Query log
  check_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config "Authorization: Basic $basic_auth" | jq '.ignored')
  echo "$check_conf" | grep "$rem_domain" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    new_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config "Authorization: Basic $basic_auth" | jq --arg rem_domain "$rem_domain" '.ignored -= [$rem_domain]' | jq --arg rem_domain "*.$rem_domain" '.ignored -= [$rem_domain]')
    curl -s -X PUT -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$new_conf" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/querylog/config/update
  fi

  # Stats
  check_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config "Authorization: Basic $basic_auth" | jq '.ignored')
  echo "$check_conf" | grep "$rem_domain" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    new_conf=$(http --verify=no GET https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config "Authorization: Basic $basic_auth" | jq --arg rem_domain "$rem_domain" '.ignored -= [$rem_domain]' | jq --arg rem_domain "*.$rem_domain" '.ignored -= [$rem_domain]')
    curl -s -X PUT -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$new_conf" -k https://127.0.0.1:$ADGUARD_LOCALHOST_PORT/control/stats/config/update
  fi

  if ! [ -z "$rdawiqs_curE" ]; then
    set -e
  fi
}

function addDomainAndWildcardAdguardRS()
{
  deleteDomainAndWildcardAdguardRS "$1"
  addDomainAdguardRS "$1" "$2"
  addDomainAdguardRS "*.$1" "$2"
}

function addDomainAdguardRS()
{
  set +e
  add_domain=$1
  add_ip_addr=$2
  basic_auth="$(getAdguardCredentialsRS)"
  deleteDomainAdguardRS "$add_domain" "$basic_auth"
  dom_json=$(jq -n --arg add_domain $add_domain --arg add_ip_addr $add_ip_addr '{domain: $add_domain, answer: $add_ip_addr}')
  curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/add
}

function addDomainAndWildcardAdguardNoReplaceRS()
{
  addDomainAdguardNoReplaceRS "$1" "$2"
  addDomainAdguardNoReplaceRS "*.$1" "$2"
}

function addDomainAdguardNoReplaceRS()
{
  set +e
  add_domain="$1"
  add_ip_addr="$2"
  basic_auth="$(getAdguardCredentialsRS)"
  curl -s -H "Authorization: Basic $basic_auth" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/list | jq -r --arg add_domain $add_domain '.[] | select(.domain==$add_domain) | .domain' | grep $add_domain > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    dom_json=$(jq -n --arg add_domain $add_domain --arg add_ip_addr $add_ip_addr '{domain: $add_domain, answer: $add_ip_addr}')
    curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/add
  fi
}

function deleteDomainAndWildcardAdguardRS()
{
  deleteDomainAdguardRS "$1"
  deleteDomainAdguardRS "*.$1"
}

function deleteDomainAdguardRS()
{
  set +e
  del_domain="$1"
  basic_auth="$(getAdguardCredentialsRS)"
  curl -s -H "Authorization: Basic $basic_auth" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/list | jq -r --arg del_domain $del_domain '.[] | select(.domain==$del_domain) | .domain' | grep "$del_domain" >/dev/null
  if [ $? -eq 0 ]; then
    # Exists, need to determine IP address to delete
    del_ip_addr=$(curl -s -H "Authorization: Basic $basic_auth" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/list | jq -r --arg del_domain $del_domain '.[] | select(.domain==$del_domain) | .answer')
    dom_json=$(jq -n --arg del_domain $del_domain --arg del_ip_addr $del_ip_addr '{domain: $del_domain, answer: $del_ip_addr}')
    curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/delete
  fi
}

function deleteDomainByIPAndWildcardAdguardRS()
{
  deleteDomainByIPAdguardRS "$1" "$2"
  deleteDomainByIPAdguardRS "*.$1" "$2"
}

function deleteDomainByIPAdguardRS()
{
  set +e
  del_domain="$1"
  del_ip_addr="$2"
  basic_auth="$(getAdguardCredentialsRS)"
  dom_json=$(jq -n --arg del_domain $del_domain --arg del_ip_addr $del_ip_addr '{domain: $del_domain, answer: $del_ip_addr}')
  curl -s -H "Authorization: Basic $basic_auth" -H 'Content-Type: application/json' -d "$dom_json" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/rewrite/delete
}

function clearQueryLogAndStatsAdguardRS()
{
  basic_auth="$(getAdguardCredentialsRS)"
  http --verify=no POST https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/querylog_clear "Authorization: Basic $basic_auth" >/dev/null
  http --verify=no POST https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/control/stats_reset "Authorization: Basic $basic_auth" >/dev/null
}

# Port Forwarding
function setupPortForwardingDB()
{
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    return
  fi
  isPFTable=$(sqlite3 $HSHQ_DB "select name from sqlite_master where type='table' and name='portforwarding';")
  if [ -z "$isPFTable" ]; then
    curdt=$(getCurrentDate)
    sudo sqlite3 $HSHQ_DB "create table portforwarding(ID integer not null primary key autoincrement, PFType text, Name text, ExtStart integer, ExtEnd integer, IntStart integer, IntEnd integer, Protocol text, InternalHost text, IPAddress text, LastUpdated datetime);"

    # Email SMTP (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-EmailSMTP', 25, 25, 0, 0, 'both','','','$curdt');"

    # DNS Server (need both)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-DNS', 53, 53, 0, 0, 'both','','','$curdt');"

    # HTTP (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-HTTP', 80, 80, 0, 0, 'both','','','$curdt');"

    # HTTPS (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-HTTPS', 443, 443, 0, 0, 'both','','','$curdt');"

    # Email Submission (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-EmailSubmit', $MAILU_PORT_5, $MAILU_PORT_5, 0, 0, 'both','','','$curdt');"

    # WireGuard Portal (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-WGPortal', 8323, 8323, 0, 0, 'both','','','$curdt');"

    # Syncthing Web (do both protocols, even though only need TCP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-SyncthingWeb', $SYNCTHING_LOCAL_WEB_PORT, $SYNCTHING_LOCAL_WEB_PORT, 0, 0, 'both','','','$curdt');"

    # Syncthing Sync (need both)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-SyncthingSync', $SYNCTHING_SYNC_PORT, $SYNCTHING_SYNC_PORT, 0, 0, 'both','','','$curdt');"

    # Syncthing Discovery (do both protocols, even though only need UDP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-SyncthingDiscovery', $SYNCTHING_DISC_PORT, $SYNCTHING_DISC_PORT, 0, 0, 'both','','','$curdt');"

    # WireGuard (do both protocols, even though only need UDP)
    sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('System', 'RS-WireGuard', $RELAYSERVER_WG_PORT, $RELAYSERVER_WG_PORT, 0, 0, 'both','','','$curdt');"
  fi
}

function version91UploadPortForwardingScripts()
{
    # Upload add/remove scripts to RelayServer
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nYou will be prompted for you sudo password on the RelayServer.\n"
    notifyRSLogin
    rm -f $HOME/addPortForward.sh
    rm -f $HOME/removePortForward.sh
    tee $HOME/addPortForward.sh >/dev/null <<EOFCD
#!/bin/bash
set +e

ID=\$1
ExtStart=\$2
ExtEnd=\$3
IntStart=\$4
IntEnd=\$5
Protocol=\$6
IPAddress=\$7
RELAYSERVER_PF_ADD_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
RELAYSERVER_PF_REMOVE_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding
RELAYSERVER_WG_SV_IP=$RELAYSERVER_WG_SV_IP
RELAYSERVER_WG_INTERFACE_NAME=$RELAYSERVER_WG_INTERFACE_NAME
DEFAULT_IFACE=\$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1)

function main()
{
  tee \$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\${ID}.sh >/dev/null <<EOFSC
#!/bin/bash
set +e

function main()
{
  case "\$Protocol" in
    tcp)
      addTCP
    ;;
    udp)
      addUDP
    ;;
    both)
      addTCP
      addUDP
    ;;
    *)
    ;;
  esac
}

function addTCP()
{
  iptables -C PREROUTING -t nat -i \$DEFAULT_IFACE -p tcp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart > /dev/null 2>&1 || iptables -A PREROUTING -t nat -i \$DEFAULT_IFACE -p tcp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart
  iptables -C FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \$IPAddress --dport \$IntStart:\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \$IPAddress --dport \$IntStart:\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT
  iptables -C FORWARD -i \$RELAYSERVER_WG_INTERFACE_NAME -o \$DEFAULT_IFACE -p tcp -s \$IPAddress --sport \$IntStart:\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \$RELAYSERVER_WG_INTERFACE_NAME -o \$DEFAULT_IFACE -p tcp -s \$IPAddress --sport \$IntStart:\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT
  iptables -C POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart > /dev/null 2>&1 || iptables -A POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart
}

function addUDP()
{
  iptables -C PREROUTING -t nat -i \$DEFAULT_IFACE -p udp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart > /dev/null 2>&1 || iptables -A PREROUTING -t nat -i \$DEFAULT_IFACE -p udp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart
  iptables -C FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \$IPAddress --dport \$IntStart:\$IntEnd -j ACCEPT > /dev/null 2>&1 || iptables -A FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \$IPAddress --dport \$IntStart:\$IntEnd -j ACCEPT
  iptables -C POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart > /dev/null 2>&1 || iptables -A POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart
}

main "\\\$@"
EOFSC
  chmod 744 \$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\${ID}.sh
  \$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\${ID}.sh

  tee \$RELAYSERVER_PF_REMOVE_DIR/pfRem-\${ID}.sh >/dev/null <<EOFSC
#!/bin/bash
set +e

function main()
{
  case "\$Protocol" in
    tcp)
      remTCP
    ;;
    udp)
      remUDP
    ;;
    both)
      remTCP
      remUDP
    ;;
    *)
    ;;
  esac
}

function remTCP()
{
  iptables -D PREROUTING -t nat -i \$DEFAULT_IFACE -p tcp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart > /dev/null 2>&1
  iptables -D FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp -d \$IPAddress --dport \$IntStart:\$IntEnd --syn -m conntrack --ctstate NEW -j ACCEPT > /dev/null 2>&1
  iptables -D FORWARD -i \$RELAYSERVER_WG_INTERFACE_NAME -o \$DEFAULT_IFACE -p tcp -s \$IPAddress --sport \$IntStart:\$IntEnd -m state --state ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1
  iptables -D POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p tcp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart > /dev/null 2>&1
}

function remUDP()
{
  iptables -D PREROUTING -t nat -i \$DEFAULT_IFACE -p udp --dport \$ExtStart:\$ExtEnd -j DNAT --to-destination \$IPAddress:\$IntStart-\$IntEnd/\$ExtStart > /dev/null 2>&1
  iptables -D FORWARD -i \$DEFAULT_IFACE -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp -d \$IPAddress --dport \$IntStart:\$IntEnd -j ACCEPT > /dev/null 2>&1
  iptables -D POSTROUTING -t nat -o \$RELAYSERVER_WG_INTERFACE_NAME -p udp --dport \$IntStart:\$IntEnd -d \$IPAddress -j SNAT --to-source \$RELAYSERVER_WG_SV_IP:\$ExtStart-\$ExtEnd/\$IntStart > /dev/null 2>&1
}

main "\\\$@"
EOFSC
  chmod 744 \$RELAYSERVER_PF_REMOVE_DIR/pfRem-\${ID}.sh

}

main "\$@"

EOFCD
    chmod 500 $HOME/addPortForward.sh
    tee $HOME/removePortForward.sh >/dev/null <<EOFCD
#!/bin/bash
set +e

ID=\$1
RELAYSERVER_PF_REMOVE_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding
RELAYSERVER_PF_ADD_DIR=$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts

\$RELAYSERVER_PF_REMOVE_DIR/pfRem-\${ID}.sh
rm -f \$RELAYSERVER_PF_REMOVE_DIR/pfRem-\${ID}.sh
rm -f \$RELAYSERVER_PF_ADD_DIR/15-pfAdd-\${ID}.sh
EOFCD
    chmod 500 $HOME/removePortForward.sh
    loadSSHKey
    scp -P $RELAYSERVER_SSH_PORT $HOME/addPortForward.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/removePortForward.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo mkdir -p $RELAYSERVER_HSHQ_SCRIPTS_DIR/root/portforwarding; sudo chown root:root ~/addPortForward.sh; sudo chown root:root ~/removePortForward.sh; sudo mv ~/addPortForward.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPortForward.sh; sudo mv ~/removePortForward.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePortForward.sh"
    unloadSSHKey
    rm -f $HOME/addPortForward.sh
    rm -f $HOME/removePortForward.sh
  fi
}

function addPortForwardingRule()
{
  Name="$1"
  ExtStart=$2
  ExtEnd=$3
  IntStart=$4
  IntEnd=$5
  Protocol=$6
  InternalHost=$7
  IPAddress=$8
  PFType="User"
  curdt=$(getCurrentDate)

  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "You are not hosting a RelayServer, returning..."
    return 1
  fi
  # Check if name is valid
  if [ $(checkValidStringUpperLowerNumbers "$Name" "-") = "false" ]; then
    echo "Invalid Name: $Name. It must consist of a-z (upper or lowercase), 0-9, and/or -"
    return 2
  fi
  if [ ${#Name} -ge 32 ]; then
    echo "Name is too long, must be less than 32 characters, returning..."
    return 3
  fi
  # Check if ranges are valid
  if [ $ExtStart -le 0 ] || [ $ExtStart -ge 65536 ]; then
    echo "Invalid External Start Port: $ExtStart, returning..."
    return 4
  fi
  if [ $ExtEnd -le 0 ] || [ $ExtEnd -ge 65536 ]; then
    echo "Invalid External End Port: $ExtEnd, returning..."
    return 5
  fi
  if [ $IntStart -le 0 ] || [ $IntStart -ge 65536 ]; then
    echo "Invalid Internal Start Port: $IntStart, returning..."
    return 6
  fi
  if [ $IntEnd -le 0 ] || [ $IntEnd -ge 65536 ]; then
    echo "Invalid Internal End Port: $IntEnd, returning..."
    return 7
  fi
  if [ $ExtStart -gt $ExtEnd ]; then
    echo "External Start Port is greater than External End Port, returning..."
    return 8
  fi
  if [ $IntStart -gt $IntEnd ]; then
    echo "External Start Port is greater than External End Port, returning..."
    return 9
  fi
  if [ $(($ExtEnd - $ExtStart)) -ne $(($IntEnd - $IntStart)) ]; then
    echo "The port ranges for External vs Internal are not of equal size, returning..."
    return 10
  fi
  # Check to see if ranges intersect
  case "$Protocol" in
    tcp)
      checkTCP=$(checkPortForwardingIntersect tcp $ExtStart $ExtEnd)
    ;;
    udp)
      checkUDP=$(checkPortForwardingIntersect udp $ExtStart $ExtEnd)
    ;;
    both)
      checkTCP=$(checkPortForwardingIntersect tcp $ExtStart $ExtEnd)
      if ! [ -z "$checkTCP" ]; then
        break
      fi
      checkUDP=$(checkPortForwardingIntersect udp $ExtStart $ExtEnd)
    ;;
    *)
      echo "Unknown protocol, returning..."
      return 11
    ;;
  esac
  if ! [ -z "$checkTCP" ]; then
    echo "$checkTCP"
    return 12
  fi
  if ! [ -z "$checkUDP" ]; then
    echo "$checkUDP"
    return 13
  fi

  if ! [ -z "$InternalHost" ]; then
    InternalHostID=$(echo $InternalHost | cut -d"-" -f1)
    InternalHostName=$(echo $InternalHost | cut -d"-" -f2)
  fi
  # Check for valid IP Address or InternalHost
  useThisIP=""
  if ! [ -z "$IPAddress" ] && ! [ "$IPAddress" = "0.0.0.0" ]; then
    if [ "$(checkValidIPAddress $IPAddress)" = "true" ]; then
      useThisIP=$IPAddress
      InternalHostName=""
    else
      echo "Invalid IP address, returning..."
      return 14
    fi
  else
    if [ -z "$InternalHost" ]; then
      echo "Invalid hostname, returning..."
      return 15
    fi
    useThisIP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$InternalHostID;")
    if ! [ "$(checkValidIPAddress $useThisIP)" = "true" ]; then
      echo "Invalid IP address, returning..."
      return 16
    fi
    IPAddress=$useThisIP
  fi
  # Check if IP is in VPN range
  if ! [ "$(isIPInSubnet $useThisIP $PRIMARY_VPN_SUBNET)" = "true" ]; then
    echo "IP address is not in range, IP: $useThisIP, VPN Subnet: $PRIMARY_VPN_SUBNET, returning..."
    return 17
  fi

  pfID=$(sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;insert into portforwarding(PFType, Name, ExtStart, ExtEnd, IntStart, IntEnd, Protocol, InternalHost, IPAddress, LastUpdated) values('$PFType', '$Name', $ExtStart, $ExtEnd, $IntStart, $IntEnd, '$Protocol','$InternalHostName','$IPAddress','$curdt');select last_insert_rowid();")
  loadSSHKey
  pfResult=$(ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPortForward.sh $pfID $ExtStart $ExtEnd $IntStart $IntEnd $Protocol $useThisIP")
  retVal=$?
  unloadSSHKey
  if [ $retVal -ne 0 ]; then
    echo "There was a problem adding this port forwarding rule: $pfResult"
    echo
    echo "Ensure to delete the rule before trying again."
    return 18
  fi
}

function removePortForwardingRule()
{
  pfID=$1
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo "You are not hosting a RelayServer, returning..."
    return 1
  fi
  loadSSHKey
  pfResult=$(ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePortForward.sh $pfID")
  retVal=$?
  unloadSSHKey
  if [ $retVal -ne 0 ]; then
    echo "There was a problem removing this port forwarding rule: $pfResult"
    echo
    echo "The rule was not removed."
    return 2
  fi
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from portforwarding where ID=$pfID;"
}

function checkPortForwardingIntersect()
{
  pfProto=$1
  pfStartPort=$2
  pfEndPort=$3
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  pfRows=($(sqlite3 $HSHQ_DB "select Name,PFType,ExtStart,ExtEnd,Protocol,LastUpdated from portforwarding where Protocol in ('$pfProto','both');"))
  for curPF in "${pfRows[@]}"
  do
    curPFName=$(echo "$curPF" | cut -d "|" -f1)
    curPFType=$(echo "$curPF" | cut -d "|" -f2)
    curPFExtStart=$(echo "$curPF" | cut -d "|" -f3)
    curPFExtEnd=$(echo "$curPF" | cut -d "|" -f4)
    curPFProto=$(echo "$curPF" | cut -d "|" -f5)
    curPFLastUpdated=$(echo "$curPF" | cut -d "|" -f6)
    if ([ $pfStartPort -ge $curPFExtStart ] && [ $pfStartPort -le $curPFExtEnd ]) ||
       ([ $pfEndPort -ge $curPFExtStart ] && [ $pfEndPort -le $curPFExtEnd ]) ||
       ([ $curPFExtStart -ge $pfStartPort ] && [ $curPFExtStart -le $pfEndPort ]) ||
       ([ $curPFExtEnd -ge $pfStartPort ] && [ $curPFExtEnd -le $pfEndPort ]); then
      if [ "$curPFType" = "System" ]; then
        echo "The range $pfStartPort-$pfEndPort intersects with an existing System Reserved entry - Name: $curPFName, PortRange: $curPFExtStart-$curPFExtEnd, Protocol: $curPFProto, LastUpdated: $curPFLastUpdated"
      elif [ "$curPFType" = "User" ]; then
        echo "The range $pfStartPort-$pfEndPort intersects with an existing User entry - Name: $curPFName, PortRange: $curPFExtStart-$curPFExtEnd, Protocol: $curPFProto, LastUpdated: $curPFLastUpdated"
      else
        echo "The range $pfStartPort-$pfEndPort intersects with an existing (Unknown Type) entry - Name: $curPFName, PortRange: $curPFExtStart-$curPFExtEnd, Protocol: $curPFProto, LastUpdated: $curPFLastUpdated"
      fi
      IFS=$OLDIFS
      return
    fi
  done
  IFS=$OLDIFS
}

# Desktop Functions
function addRootCertificateToApps()
{
  set +e
  which firefox > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    tryFind=$(findCertByKeyword firefox)
    if [ -z "$tryFind" ] || ! [ "$tryFind" = "true" ]; then
      initDesktopApp firefox true findCertByKeyword
    fi
  fi
  which thunderbird > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    tryFind=$(findCertByKeyword thunderbird)
    if [ -z "$tryFind" ] || ! [ "$tryFind" = "true" ]; then
      initDesktopApp thunderbird true findCertByKeyword
    fi
  fi
  # This is a little bit kludgy, but it covers the case when
  # Firefox is installed via snap vs apt, i.e. the profile
  # directory is not the same.
  for certDB in $(find ~ -name "cert9.db" 2> /dev/null)
  do
    certDir=$(dirname $certDB)
    echo "Adding certificate (${CERTS_ROOT_CA_NAME}.crt) to app..."
    certutil -A -n "${HOMESERVER_NAME} Root CA" -t "CT,C,C" -i "/usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt" -d sql:${certDir}
  done
  which brave-browser > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    tryFind=$(getBraveCertDB)
    if [ -z "$tryFind" ] || ! [ -f "$tryFind" ]; then
      initDesktopApp brave-browser true getBraveCertDB
    fi
  fi
  if [ -d ~/.pki/nssdb ]; then
    echo "Adding certificate (${CERTS_ROOT_CA_NAME}.crt) to Chromium-based browser(s) pki..."
    certutil -A -n "${HOMESERVER_NAME} Root CA" -t "CT,C,C" -i "/usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt" -d sql:~/.pki/nssdb 2> /dev/null
  fi
}

function tryDeleteRootCAFirefox()
{
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  for certDB in $(find ~ -name "cert9.db" 2> /dev/null)
  do
    certDir=$(dirname $certDB)
    certList=($(certutil -L -d sql:${certDir} | grep -o ".*Root CA"))
    for curCert in "${certList[@]}"
    do
      certutil -D -n "$curCert" -d sql:${certDir}
    done
  done
  IFS=$OLDIFS
}

function findCertByKeyword()
{
  keyw="$1"
  findres=$(find ~ -name "cert9.db" 2> /dev/null)
  echo "$findres" | grep "$keyw" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function getBraveCertDB()
{
  find ~/.pki -type d -name nssdb 2> /dev/null
}

function initDesktopApp()
{
  appName="$1"
  isRunHeadless="$2"
  checkFunction="$3"
  # 1. Start app on desktop
  # 2. Wait for checkFunction to return a result
  # 3. Kill app
  export DISPLAY=:0
  if [ "$isRunHeadless" = "true" ]; then
    nohup $appName --headless > /dev/null 2>&1 & > /dev/null 2>&1
  else
    nohup $appName > /dev/null 2>&1 & > /dev/null 2>&1
  fi
  sleep 5
  curCount=0
  maxCount=30
  while [ $curCount -lt $maxCount ]
  do
    tryFind=$($checkFunction "$appName")
    if ! [ -z "$tryFind" ] && [ "$tryFind" = "true" ]; then
      break
    fi
    sleep 1
    ((curCount++))
  done
  pkill $appName > /dev/null 2>&1
}

function configureFirefox()
{
  # The settings in the file below are taken directly from
  # https://github.com/pyllyukko/user.js. It is an active,
  # well-documented project that seeks to provide
  # security-hardened settings for the Firefox browser.
  # These settings are very aggressive and can detract
  # from a normal user experience. However, keep in mind
  # that this is a server, not a client device. It should
  # not be used in a traditional everyday environment.
  # If you want to remove these settings, then the
  # easiest way is to close Firefox, remove the profile
  # directory (likely ~/.mozilla/firefox, then restart
  # Firefox. This will remove all related Firefox data,
  # such as bookmarks, etc. So backup everything accordingly.
  cat <<EOFUS > $HOME/user.js
//
// A few more added
user_pref("extensions.formautofill.addresses.enabled", false);
user_pref("extensions.formautofill.addresses.capture.enabled", false);
user_pref("extensions.formautofill.addresses.ignoreAutocompleteOff", false);
user_pref("extensions.formautofill.creditCards.available", false);
user_pref("extensions.formautofill.creditCards.enabled", false);
user_pref("browser.urlbar.suggest.topsites", false);
user_pref("identity.fxaccounts.enabled", false);
user_pref("browser.startup.couldRestoreSession.count", 1);
user_pref("browser.startup.page", 3);
user_pref("browser.urlbar.placeholderName", "DuckDuckGo");
user_pref("browser.urlbar.placeholderName.private", "DuckDuckGo");

// Always dark mode:)
user_pref("layout.css.prefers-color-scheme.content-override", 0);
user_pref("browser.in-content.dark-mode", true);
user_pref("ui.systemUsesDarkTheme", 1);

/******************************************************************************
 * user.js                                                                    *
 * https://github.com/pyllyukko/user.js                                       *
 ******************************************************************************/

/******************************************************************************
 * SECTION: HTML5 / APIs / DOM                                                *
 ******************************************************************************/

// PREF: Disable Service Workers
// https://developer.mozilla.org/en-US/docs/Web/API/Worker
// https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorker_API
// https://wiki.mozilla.org/Firefox/Push_Notifications#Service_Workers
// NOTICE: Disabling ServiceWorkers breaks functionality on some sites (Google Street View...)
// NOTICE: Disabling ServiceWorkers breaks Firefox Sync
// Unknown security implications
// CVE-2016-5259, CVE-2016-2812, CVE-2016-1949, CVE-2016-5287 (fixed)
user_pref("dom.serviceWorkers.enabled",				false);

// PREF: Disable web notifications
// https://support.mozilla.org/en-US/questions/1140439
user_pref("dom.webnotifications.enabled",			false);

// PREF: Disable DOM timing API
// https://wiki.mozilla.org/Security/Reviews/Firefox/NavigationTimingAPI
// https://www.w3.org/TR/navigation-timing/#privacy
// NOTICE: Disabling DOM timing API breaks item pages in AliExpress (https://github.com/pyllyukko/user.js/issues/561)
user_pref("dom.enable_performance",				false);

// PREF: Disable resource timing API
// https://www.w3.org/TR/resource-timing/#privacy-security
// NOTICE: Disabling resource timing API breaks some DDoS protection pages (Cloudflare)
user_pref("dom.enable_resource_timing",				false);

// PREF: Make sure the User Timing API does not provide a new high resolution timestamp
// https://trac.torproject.org/projects/tor/ticket/16336
// https://www.w3.org/TR/2013/REC-user-timing-20131212/#privacy-security
user_pref("dom.enable_user_timing",				false);

// PREF: Disable Web Audio API
// https://bugzilla.mozilla.org/show_bug.cgi?id=1288359
// NOTICE: Web Audio API is required for Unity web player/games
// Set this to true for Jitsi
user_pref("dom.webaudio.enabled",				true);

// PREF: Disable Location-Aware Browsing (geolocation)
// https://www.mozilla.org/en-US/firefox/geolocation/
user_pref("geo.enabled",					false);

// PREF: When geolocation is enabled, use Mozilla geolocation service instead of Google
// https://bugzilla.mozilla.org/show_bug.cgi?id=689252
user_pref("geo.wifi.uri", "https://location.services.mozilla.com/v1/geolocate?key=%MOZILLA_API_KEY%");

// PREF: When geolocation is enabled, don't log geolocation requests to the console
user_pref("geo.wifi.logging.enabled", false);

// PREF: Disable raw TCP socket support (mozTCPSocket)
// https://trac.torproject.org/projects/tor/ticket/18863
// https://www.mozilla.org/en-US/security/advisories/mfsa2015-97/
// https://developer.mozilla.org/docs/Mozilla/B2G_OS/API/TCPSocket
user_pref("dom.mozTCPSocket.enabled",				false);

// PREF: Disable DOM storage (disabled)
// http://kb.mozillazine.org/Dom.storage.enabled
// https://html.spec.whatwg.org/multipage/webstorage.html
// NOTICE-DISABLED: Disabling DOM storage is known to cause TypeError: localStorage is null  errors
//user_pref("dom.storage.enabled",		false);

// PREF: Disable leaking network/browser connection information via Javascript
// Network Information API provides general information about the system's connection type (WiFi, cellular, etc.)
// https://developer.mozilla.org/en-US/docs/Web/API/Network_Information_API
// https://wicg.github.io/netinfo/#privacy-considerations
// https://bugzilla.mozilla.org/show_bug.cgi?id=960426
user_pref("dom.netinfo.enabled",				false);

// PREF: Disable network API (Firefox < 32)
// https://developer.mozilla.org/en-US/docs/Web/API/Connection/onchange
// https://www.torproject.org/projects/torbrowser/design/#fingerprinting-defenses
user_pref("dom.network.enabled",				false);

// PREF: Disable WebRTC entirely to prevent leaking internal IP addresses (Firefox < 42)
// NOTICE: Disabling WebRTC breaks peer-to-peer file sharing tools (reep.io ...)
// Set this to true for FileDrop
user_pref("media.peerconnection.enabled",			true);

// PREF: Don't reveal your internal IP when WebRTC is enabled (Firefox >= 42)
// https://wiki.mozilla.org/Media/WebRTC/Privacy
// https://github.com/beefproject/beef/wiki/Module%3A-Get-Internal-IP-WebRTC
user_pref("media.peerconnection.ice.default_address_only",	true); // Firefox 42-51
user_pref("media.peerconnection.ice.no_host",			true); // Firefox >= 52

// PREF: Disable WebRTC getUserMedia, screen sharing, audio capture, video capture
// https://wiki.mozilla.org/Media/getUserMedia
// https://blog.mozilla.org/futurereleases/2013/01/12/capture-local-camera-and-microphone-streams-with-getusermedia-now-enabled-in-firefox/
// https://developer.mozilla.org/en-US/docs/Web/API/Navigator
user_pref("media.navigator.enabled",				false);
user_pref("media.navigator.video.enabled",			false);
user_pref("media.getusermedia.screensharing.enabled",		false);
user_pref("media.getusermedia.audiocapture.enabled",		false);

// PREF: Disable battery API (Firefox < 52)
// https://developer.mozilla.org/en-US/docs/Web/API/BatteryManager
// https://bugzilla.mozilla.org/show_bug.cgi?id=1313580
user_pref("dom.battery.enabled",				false);

// PREF: Disable telephony API
// https://wiki.mozilla.org/WebAPI/Security/WebTelephony
user_pref("dom.telephony.enabled",				false);

// PREF: Disable "beacon" asynchronous HTTP transfers (used for analytics)
// https://developer.mozilla.org/en-US/docs/Web/API/navigator.sendBeacon
user_pref("beacon.enabled",					false);

// PREF: Disable clipboard event detection (onCut/onCopy/onPaste) via Javascript
// https://web.archive.org/web/20210416195937/https://developer.mozilla.org/en-US/docs/Mozilla/Preferences/Preference_reference/dom.event.clipboardevents.enabled
// https://github.com/pyllyukko/user.js/issues/287
// NOTICE: Disabling clipboard events breaks Ctrl+C/X/V copy/cut/paste functionaility in JS-based web applications (Google Docs...)
user_pref("dom.event.clipboardevents.enabled",			false);

// PREF: Disable "copy to clipboard" functionality via Javascript (Firefox >= 41)
// https://hg.mozilla.org/mozilla-central/rev/2f9f8ea4b9c3
// https://github.com/pyllyukko/user.js/issues/287
// NOTICE: Disabling clipboard operations will break legitimate JS-based "copy to clipboard" functionality
user_pref("dom.allow_cut_copy", false);

// PREF: Disable speech recognition
// https://dvcs.w3.org/hg/speech-api/raw-file/tip/speechapi.html
// https://developer.mozilla.org/en-US/docs/Web/API/SpeechRecognition
// https://wiki.mozilla.org/HTML5_Speech_API
user_pref("media.webspeech.recognition.enable",			false);

// PREF: Disable speech synthesis
// https://developer.mozilla.org/en-US/docs/Web/API/SpeechSynthesis
user_pref("media.webspeech.synth.enabled",			false);

// PREF: Disable sensor API
// https://wiki.mozilla.org/Sensor_API
user_pref("device.sensors.enabled",				false);

// PREF: Disable pinging URIs specified in HTML <a> ping= attributes
// http://kb.mozillazine.org/Browser.send_pings
user_pref("browser.send_pings",					false);

// PREF: When browser pings are enabled, only allow pinging the same host as the origin page
// http://kb.mozillazine.org/Browser.send_pings.require_same_host
user_pref("browser.send_pings.require_same_host",		true);

// PREF: Disable IndexedDB (disabled)
// https://developer.mozilla.org/en-US/docs/IndexedDB
// https://en.wikipedia.org/wiki/Indexed_Database_API
// https://wiki.mozilla.org/Security/Reviews/Firefox4/IndexedDB_Security_Review
// http://forums.mozillazine.org/viewtopic.php?p=13842047
// https://github.com/pyllyukko/user.js/issues/8
// NOTICE-DISABLED: IndexedDB could be used for tracking purposes, but is required for some add-ons to work (notably uBlock), so is left enabled
//user_pref("dom.indexedDB.enabled",		false);

// TODO: "Access Your Location" "Maintain Offline Storage" "Show Notifications"

// PREF: Disable gamepad API to prevent USB device enumeration
// https://www.w3.org/TR/gamepad/
// https://trac.torproject.org/projects/tor/ticket/13023
user_pref("dom.gamepad.enabled",				false);

// PREF: Disable virtual reality devices APIs
// https://developer.mozilla.org/en-US/Firefox/Releases/36#Interfaces.2FAPIs.2FDOM
// https://developer.mozilla.org/en-US/docs/Web/API/WebVR_API
user_pref("dom.vr.enabled",					false);

// PREF: Disable vibrator API
user_pref("dom.vibrator.enabled",           false);

// PREF: Disable Archive API (Firefox < 54)
// https://wiki.mozilla.org/WebAPI/ArchiveAPI
// https://bugzilla.mozilla.org/show_bug.cgi?id=1342361
user_pref("dom.archivereader.enabled",				false);

// PREF: Disable webGL
// https://en.wikipedia.org/wiki/WebGL
// https://www.contextis.com/resources/blog/webgl-new-dimension-browser-exploitation/
// NOTICE: Disabling WebGL breaks WebGL-based websites/applications (windy, meteoblue...)
user_pref("webgl.disabled",					true);
// PREF: When webGL is enabled, use the minimum capability mode
user_pref("webgl.min_capability_mode",				true);
// PREF: When webGL is enabled, disable webGL extensions
// https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API#WebGL_debugging_and_testing
user_pref("webgl.disable-extensions",				true);
// PREF: When webGL is enabled, force enabling it even when layer acceleration is not supported
// https://trac.torproject.org/projects/tor/ticket/18603
user_pref("webgl.disable-fail-if-major-performance-caveat",	true);
// PREF: When webGL is enabled, do not expose information about the graphics driver
// https://bugzilla.mozilla.org/show_bug.cgi?id=1171228
// https://developer.mozilla.org/en-US/docs/Web/API/WEBGL_debug_renderer_info
user_pref("webgl.enable-debug-renderer-info",			false);
// somewhat related...
//user_pref("pdfjs.enableWebGL",					false);

// PREF: Spoof dual-core CPU
// https://trac.torproject.org/projects/tor/ticket/21675
// https://bugzilla.mozilla.org/show_bug.cgi?id=1360039
user_pref("dom.maxHardwareConcurrency",				2);

// PREF: Disable WebAssembly
// https://webassembly.org/
// https://en.wikipedia.org/wiki/WebAssembly
// https://trac.torproject.org/projects/tor/ticket/21549
// NOTICE: WebAssembly is required for Unity web player/games
// Required by InfluxDB
user_pref("javascript.options.wasm",				true);

/******************************************************************************
 * SECTION: Misc                                                              *
 ******************************************************************************/

// PREF: Disable face detection
user_pref("camera.control.face_detection.enabled",		false);

// PREF: Disable GeoIP lookup on your address to set default search engine region
// https://trac.torproject.org/projects/tor/ticket/16254
// https://support.mozilla.org/en-US/kb/how-stop-firefox-making-automatic-connections#w_geolocation-for-default-search-engine
user_pref("browser.search.countryCode",				"US");
user_pref("browser.search.region",				"US");
user_pref("browser.search.geoip.url",				"");

// PREF: Set Accept-Language HTTP header to en-US regardless of Firefox localization
// https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Language
user_pref("intl.accept_languages",				"en-US, en");

// PREF: Don't use OS values to determine locale, force using Firefox locale setting
// http://kb.mozillazine.org/Intl.locale.matchOS
user_pref("intl.locale.matchOS",				false);

// Use LANG environment variable to choose locale (disabled)
//pref("intl.locale.requested", "");

// PREF: Don't use Mozilla-provided location-specific search engines
user_pref("browser.search.geoSpecificDefaults",			false);

// PREF: Do not automatically send selection to clipboard on some Linux platforms
// http://kb.mozillazine.org/Clipboard.autocopy
user_pref("clipboard.autocopy",					false);

// PREF: Prevent leaking application locale/date format using JavaScript
// https://bugzilla.mozilla.org/show_bug.cgi?id=867501
// https://hg.mozilla.org/mozilla-central/rev/52d635f2b33d
user_pref("javascript.use_us_english_locale",			true);

// PREF: Do not submit invalid URIs entered in the address bar to the default search engine
// http://kb.mozillazine.org/Keyword.enabled
//user_pref("keyword.enabled",					false);

// PREF: Don't trim HTTP off of URLs in the address bar.
// https://bugzilla.mozilla.org/show_bug.cgi?id=665580
user_pref("browser.urlbar.trimURLs",				false);

// PREF: Disable preloading of autocomplete URLs.
// https://wiki.mozilla.org/Privacy/Privacy_Task_Force/firefox_about_config_privacy_tweeks
user_pref("browser.urlbar.speculativeConnect.enabled", false);

// PREF: Don't try to guess domain names when entering an invalid domain name in URL bar
// http://www-archive.mozilla.org/docs/end-user/domain-guessing.html
user_pref("browser.fixup.alternate.enabled",			false);

// PREF: When browser.fixup.alternate.enabled is enabled, strip password from 'user:password@...' URLs
// https://github.com/pyllyukko/user.js/issues/290#issuecomment-303560851
user_pref("browser.fixup.hide_user_pass", true);

// PREF: Send DNS request through SOCKS when SOCKS proxying is in use
// https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO/WebBrowsers
user_pref("network.proxy.socks_remote_dns",			true);

// PREF: Don't monitor OS online/offline connection state
// https://trac.torproject.org/projects/tor/ticket/18945
user_pref("network.manage-offline-status",			false);

// PREF: Enforce Mixed Active Content Blocking
// https://support.mozilla.org/t5/Protect-your-privacy/Mixed-content-blocking-in-Firefox/ta-p/10990
// https://developer.mozilla.org/en-US/docs/Site_Compatibility_for_Firefox_23#Non-SSL_contents_on_SSL_pages_are_blocked_by_default
// https://blog.mozilla.org/tanvi/2013/04/10/mixed-content-blocking-enabled-in-firefox-23/
user_pref("security.mixed_content.block_active_content",	true);

// PREF: Enforce Mixed Passive Content blocking (a.k.a. Mixed Display Content)
// NOTICE: Enabling Mixed Display Content blocking can prevent images/styles... from loading properly when connection to the website is only partially secured
user_pref("security.mixed_content.block_display_content",	true);

// PREF: Disable JAR from opening Unsafe File Types
// http://kb.mozillazine.org/Network.jar.open-unsafe-types
// CIS Mozilla Firefox 24 ESR v1.0.0 - 3.7 
user_pref("network.jar.open-unsafe-types",			false);

// CIS 2.7.4 Disable Scripting of Plugins by JavaScript
// http://forums.mozillazine.org/viewtopic.php?f=7&t=153889
user_pref("security.xpconnect.plugin.unrestricted",		false);

// PREF: Set File URI Origin Policy
// http://kb.mozillazine.org/Security.fileuri.strict_origin_policy
// CIS Mozilla Firefox 24 ESR v1.0.0 - 3.8
user_pref("security.fileuri.strict_origin_policy",		true);

// PREF: Disable Displaying Javascript in History URLs
// http://kb.mozillazine.org/Browser.urlbar.filter.javascript
// CIS 2.3.6 
user_pref("browser.urlbar.filter.javascript",			true);

// PREF: Disable asm.js
// http://asmjs.org/
// https://www.mozilla.org/en-US/security/advisories/mfsa2015-29/
// https://www.mozilla.org/en-US/security/advisories/mfsa2015-50/
// https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2015-2712
user_pref("javascript.options.asmjs",				false);

// PREF: Disable SVG in OpenType fonts
// https://wiki.mozilla.org/SVGOpenTypeFonts
// https://github.com/iSECPartners/publications/tree/master/reports/Tor%20Browser%20Bundle
user_pref("gfx.font_rendering.opentype_svg.enabled",		false);

// PREF: Disable in-content SVG rendering (Firefox >= 53) (disabled)
// NOTICE-DISABLED: Disabling SVG support breaks many UI elements on many sites
// https://bugzilla.mozilla.org/show_bug.cgi?id=1216893
// https://github.com/iSECPartners/publications/raw/master/reports/Tor%20Browser%20Bundle/Tor%20Browser%20Bundle%20-%20iSEC%20Deliverable%201.3.pdf#16
//user_pref("svg.disabled", true);

// PREF: Disable video stats to reduce fingerprinting threat
// https://bugzilla.mozilla.org/show_bug.cgi?id=654550
// https://github.com/pyllyukko/user.js/issues/9#issuecomment-100468785
// https://github.com/pyllyukko/user.js/issues/9#issuecomment-148922065
user_pref("media.video_stats.enabled",				false);

// PREF: Don't reveal build ID
// Value taken from Tor Browser
// https://bugzilla.mozilla.org/show_bug.cgi?id=583181
user_pref("general.buildID.override",				"20100101");
user_pref("browser.startup.homepage_override.buildID",		"20100101");

// PREF: Don't use document specified fonts to prevent installed font enumeration (fingerprinting)
// https://github.com/pyllyukko/user.js/issues/395
// https://browserleaks.com/fonts
// https://github.com/pyllyukko/user.js/issues/120
user_pref("browser.display.use_document_fonts",			0);

// PREF: Enable only whitelisted URL protocol handlers
// http://kb.mozillazine.org/Network.protocol-handler.external-default
// http://kb.mozillazine.org/Network.protocol-handler.warn-external-default
// http://kb.mozillazine.org/Network.protocol-handler.expose.%28protocol%29
// https://news.ycombinator.com/item?id=13047883
// https://bugzilla.mozilla.org/show_bug.cgi?id=167475
// https://github.com/pyllyukko/user.js/pull/285#issuecomment-298124005
// NOTICE: Disabling nonessential protocols breaks all interaction with custom protocols such as mailto:, irc:, magnet: ... and breaks opening third-party mail/messaging/torrent/... clients when clicking on links with these protocols
// TODO: Add externally-handled protocols from Windows 8.1 and Windows 10 (currently contains protocols only from Linux and Windows 7) that might pose a similar threat (see e.g. https://news.ycombinator.com/item?id=13044991)
// TODO: Add externally-handled protocols from Mac OS X that might pose a similar threat (see e.g. https://news.ycombinator.com/item?id=13044991)
// If you want to enable a protocol, set network.protocol-handler.expose.(protocol) to true and network.protocol-handler.external.(protocol) to:
//   * true, if the protocol should be handled by an external application
//   * false, if the protocol should be handled internally by Firefox
user_pref("network.protocol-handler.warn-external-default",	true);
user_pref("network.protocol-handler.external.http",		false);
user_pref("network.protocol-handler.external.https",		false);
user_pref("network.protocol-handler.external.javascript",	false);
user_pref("network.protocol-handler.external.moz-extension",	false);
user_pref("network.protocol-handler.external.ftp",		false);
user_pref("network.protocol-handler.external.file",		false);
user_pref("network.protocol-handler.external.about",		false);
user_pref("network.protocol-handler.external.chrome",		false);
user_pref("network.protocol-handler.external.blob",		false);
user_pref("network.protocol-handler.external.data",		false);
user_pref("network.protocol-handler.expose-all",		false);
user_pref("network.protocol-handler.expose.http",		true);
user_pref("network.protocol-handler.expose.https",		true);
user_pref("network.protocol-handler.expose.javascript",		true);
user_pref("network.protocol-handler.expose.moz-extension",	true);
user_pref("network.protocol-handler.expose.ftp",		true);
user_pref("network.protocol-handler.expose.file",		true);
user_pref("network.protocol-handler.expose.about",		true);
user_pref("network.protocol-handler.expose.chrome",		true);
user_pref("network.protocol-handler.expose.blob",		true);
user_pref("network.protocol-handler.expose.data",		true);

/******************************************************************************
 * SECTION: Extensions / plugins                                                       *
 ******************************************************************************/

// PREF: Ensure you have a security delay when installing add-ons (milliseconds)
// http://kb.mozillazine.org/Disable_extension_install_delay_-_Firefox
// http://www.squarefree.com/2004/07/01/race-conditions-in-security-dialogs/
user_pref("security.dialog_enable_delay",			1000);

// PREF: Require signatures
// https://wiki.mozilla.org/Addons/Extension_Signing
//user_pref("xpinstall.signatures.required",		true);

// PREF: Opt-out of add-on metadata updates
// https://blog.mozilla.org/addons/how-to-opt-out-of-add-on-metadata-updates/
user_pref("extensions.getAddons.cache.enabled",			false);

// PREF: Opt-out of themes (Persona) updates
// https://support.mozilla.org/t5/Firefox/how-do-I-prevent-autoamtic-updates-in-a-50-user-environment/td-p/144287
user_pref("lightweightThemes.update.enabled",			false);

// PREF: Disable Flash Player NPAPI plugin
// http://kb.mozillazine.org/Flash_plugin
user_pref("plugin.state.flash",					0);

// PREF: Disable Java NPAPI plugin
user_pref("plugin.state.java",					0);

// PREF: Disable sending Flash Player crash reports
user_pref("dom.ipc.plugins.flash.subprocess.crashreporter.enabled",	false);

// PREF: When Flash crash reports are enabled, don't send the visited URL in the crash report
user_pref("dom.ipc.plugins.reportCrashURL",			false);

// PREF: When Flash is enabled, download and use Mozilla SWF URIs blocklist
// https://bugzilla.mozilla.org/show_bug.cgi?id=1237198
// https://github.com/mozilla-services/shavar-plugin-blocklist
user_pref("browser.safebrowsing.blockedURIs.enabled", true);

// PREF: Disable Gnome Shell Integration NPAPI plugin
user_pref("plugin.state.libgnome-shell-browser-plugin",		0);

// PREF: Disable the bundled OpenH264 video codec (disabled)
// http://forums.mozillazine.org/viewtopic.php?p=13845077&sid=28af2622e8bd8497b9113851676846b1#p13845077
//user_pref("media.gmp-provider.enabled",		false);

// PREF: Enable plugins click-to-play
// https://wiki.mozilla.org/Firefox/Click_To_Play
// https://blog.mozilla.org/security/2012/10/11/click-to-play-plugins-blocklist-style/
user_pref("plugins.click_to_play",				true);

// PREF: Updates addons automatically
// https://blog.mozilla.org/addons/how-to-turn-off-add-on-updates/
user_pref("extensions.update.enabled",				true);

// PREF: Enable add-on and certificate blocklists (OneCRL) from Mozilla
// https://wiki.mozilla.org/Blocklisting
// https://blocked.cdn.mozilla.net/
// http://kb.mozillazine.org/Extensions.blocklist.enabled
// http://kb.mozillazine.org/Extensions.blocklist.url
// https://blog.mozilla.org/security/2015/03/03/revoking-intermediate-certificates-introducing-onecrl/
// Updated at interval defined in extensions.blocklist.interval (default: 86400)
user_pref("extensions.blocklist.enabled",			true);
user_pref("services.blocklist.update_enabled",			true);

// PREF: Decrease system information leakage to Mozilla blocklist update servers
// https://trac.torproject.org/projects/tor/ticket/16931
user_pref("extensions.blocklist.url",				"https://blocklist.addons.mozilla.org/blocklist/3/%APP_ID%/%APP_VERSION%/");

// PREF: Disable system add-on updates (hidden & always-enabled add-ons from Mozilla)
// https://firefox-source-docs.mozilla.org/toolkit/mozapps/extensions/addon-manager/SystemAddons.html
// https://blog.mozilla.org/data/2018/08/20/effectively-measuring-search-in-firefox/
// https://github.com/pyllyukko/user.js/issues/419
// https://dxr.mozilla.org/mozilla-central/source/toolkit/mozapps/extensions/AddonManager.jsm#1248-1257
// NOTICE: Disabling system add-on updates prevents Mozilla from "hotfixing" your browser to patch critical problems (one possible use case from the documentation)
user_pref("extensions.systemAddon.update.enabled",		false);

/******************************************************************************
 * SECTION: Firefox (anti-)features / components                              *                            *
 ******************************************************************************/

// PREF: Disable Extension recommendations (Firefox >= 65)
// https://support.mozilla.org/en-US/kb/extension-recommendations
user_pref("browser.newtabpage.activity-stream.asrouter.userprefs.cfr",	false);

// PREF: Trusted Recursive Resolver (DNS-over-HTTPS) (disabled)
// https://wiki.mozilla.org/Trusted_Recursive_Resolver
//user_pref("network.trr.mode",					0);

// PREF: Disable WebIDE
// https://trac.torproject.org/projects/tor/ticket/16222
// https://developer.mozilla.org/docs/Tools/WebIDE
user_pref("devtools.webide.enabled",				false);
user_pref("devtools.webide.autoinstallADBHelper",		false);
user_pref("devtools.webide.autoinstallFxdtAdapters",		false);

// PREF: Disable remote debugging
// https://developer.mozilla.org/en-US/docs/Tools/Remote_Debugging/Debugging_Firefox_Desktop
// https://developer.mozilla.org/en-US/docs/Tools/Tools_Toolbox#Advanced_settings
user_pref("devtools.debugger.remote-enabled",			false);
user_pref("devtools.chrome.enabled",				false);
user_pref("devtools.debugger.force-local",			true);

// PREF: Disable Mozilla telemetry/experiments
// https://wiki.mozilla.org/Platform/Features/Telemetry
// https://wiki.mozilla.org/Privacy/Reviews/Telemetry
// https://wiki.mozilla.org/Telemetry
// https://www.mozilla.org/en-US/legal/privacy/firefox.html#telemetry
// https://support.mozilla.org/t5/Firefox-crashes/Mozilla-Crash-Reporter/ta-p/1715
// https://wiki.mozilla.org/Security/Reviews/Firefox6/ReviewNotes/telemetry
// https://gecko.readthedocs.io/en/latest/browser/experiments/experiments/manifest.html
// https://wiki.mozilla.org/Telemetry/Experiments
// https://support.mozilla.org/en-US/questions/1197144
// https://firefox-source-docs.mozilla.org/toolkit/components/telemetry/telemetry/internals/preferences.html#id1
user_pref("toolkit.telemetry.enabled",				false);
user_pref("toolkit.telemetry.unified",				false);
user_pref("toolkit.telemetry.archive.enabled",			false);
user_pref("experiments.supported",				false);
user_pref("experiments.enabled",				false);
user_pref("experiments.manifest.uri",				"");

// PREF: Disallow Necko to do A/B testing
// https://trac.torproject.org/projects/tor/ticket/13170
user_pref("network.allow-experiments",				false);

// PREF: Disable sending Firefox crash reports to Mozilla servers
// https://wiki.mozilla.org/Breakpad
// http://kb.mozillazine.org/Breakpad
// https://dxr.mozilla.org/mozilla-central/source/toolkit/crashreporter
// https://bugzilla.mozilla.org/show_bug.cgi?id=411490
// A list of submitted crash reports can be found at about:crashes
user_pref("breakpad.reportURL",					"");

// PREF: Disable sending reports of tab crashes to Mozilla (about:tabcrashed), don't nag user about unsent crash reports
// https://hg.mozilla.org/mozilla-central/file/tip/browser/app/profile/firefox.js
user_pref("browser.tabs.crashReporting.sendReport",		false);
user_pref("browser.crashReports.unsubmittedCheck.enabled",	false);

// PREF: Disable FlyWeb (discovery of LAN/proximity IoT devices that expose a Web interface)
// https://wiki.mozilla.org/FlyWeb
// https://wiki.mozilla.org/FlyWeb/Security_scenarios
// https://docs.google.com/document/d/1eqLb6cGjDL9XooSYEEo7mE-zKQ-o-AuDTcEyNhfBMBM/edit
// http://www.ghacks.net/2016/07/26/firefox-flyweb
user_pref("dom.flyweb.enabled",					false);

// PREF: Disable the UITour backend
// https://trac.torproject.org/projects/tor/ticket/19047#comment:3
user_pref("browser.uitour.enabled",				false);

// PREF: Enable Firefox Tracking Protection
// https://wiki.mozilla.org/Security/Tracking_protection
// https://support.mozilla.org/en-US/kb/tracking-protection-firefox
// https://support.mozilla.org/en-US/kb/tracking-protection-pbm
// https://kontaxis.github.io/trackingprotectionfirefox/
// https://feeding.cloud.geek.nz/posts/how-tracking-protection-works-in-firefox/
user_pref("privacy.trackingprotection.enabled",			true);
user_pref("privacy.trackingprotection.pbmode.enabled",		true);

// PREF: Enable contextual identity Containers feature (Firefox >= 52)
// NOTICE: Containers are not available in Private Browsing mode
// https://wiki.mozilla.org/Security/Contextual_Identity_Project/Containers
user_pref("privacy.userContext.enabled",			true);

// PREF: Enable Firefox's anti-fingerprinting mode ("resist fingerprinting" or RFP) (Tor Uplift project)
// https://wiki.mozilla.org/Security/Tor_Uplift/Tracking
// https://bugzilla.mozilla.org/show_bug.cgi?id=1333933
// https://wiki.mozilla.org/Security/Fingerprinting
// NOTICE: RFP breaks some keyboard shortcuts used in certain websites (see #443)
// NOTICE: RFP changes your time zone
// NOTICE: RFP breaks some DDoS protection pages (Cloudflare)
// Must have this for Adguard, Linkwarden, and possibly others - affects the displayed time
user_pref("privacy.resistFingerprinting",			false);

// PREF: disable mozAddonManager Web API [FF57+]
// https://bugzilla.mozilla.org/buglist.cgi?bug_id=1384330
// https://bugzilla.mozilla.org/buglist.cgi?bug_id=1406795
// https://bugzilla.mozilla.org/buglist.cgi?bug_id=1415644
// https://bugzilla.mozilla.org/buglist.cgi?bug_id=1453988
// https://trac.torproject.org/projects/tor/ticket/26114
user_pref("privacy.resistFingerprinting.block_mozAddonManager", true);
user_pref("extensions.webextensions.restrictedDomains", "");

// PREF: enable RFP letterboxing / resizing of inner window [FF67+] (disabled)
// https://bugzilla.mozilla.org/1407366
//user_pref("privacy.resistFingerprinting.letterboxing", true);
//user_pref("privacy.resistFingerprinting.letterboxing.dimensions", "800x600, 1000x1000, 1600x900");

// PREF: disable showing about:blank/maximized window as soon as possible during startup [FF60+]
// https://bugzilla.mozilla.org/1448423
user_pref("browser.startup.blankWindow", false);

// PREF: Disable the built-in PDF viewer
// https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2743
// https://blog.mozilla.org/security/2015/08/06/firefox-exploit-found-in-the-wild/
// https://www.mozilla.org/en-US/security/advisories/mfsa2015-69/
user_pref("pdfjs.disabled",					true);

// PREF: Disable collection/sending of the health report (healthreport.sqlite*)
// https://support.mozilla.org/en-US/kb/firefox-health-report-understand-your-browser-perf
// https://gecko.readthedocs.org/en/latest/toolkit/components/telemetry/telemetry/preferences.html
user_pref("datareporting.healthreport.uploadEnabled",		false);
user_pref("datareporting.healthreport.service.enabled",		false);
user_pref("datareporting.policy.dataSubmissionEnabled",		false);
// "Allow Firefox to make personalized extension recommendations"
user_pref("browser.discovery.enabled",				false);

// PREF: Disable Shield/Heartbeat/Normandy (Mozilla user rating telemetry)
// https://wiki.mozilla.org/Advocacy/heartbeat
// https://trac.torproject.org/projects/tor/ticket/19047
// https://trac.torproject.org/projects/tor/ticket/18738
// https://wiki.mozilla.org/Firefox/Shield
// https://github.com/mozilla/normandy
// https://support.mozilla.org/en-US/kb/shield
// https://bugzilla.mozilla.org/show_bug.cgi?id=1370801
// https://wiki.mozilla.org/Firefox/Normandy/PreferenceRollout
user_pref("app.normandy.enabled", false);
user_pref("app.normandy.api_url", "");
user_pref("extensions.shield-recipe-client.enabled",		false);
user_pref("app.shield.optoutstudies.enabled",			false);


// PREF: Disable Firefox Hello (disabled) (Firefox < 49)
// https://wiki.mozilla.org/Loop
// https://support.mozilla.org/t5/Chat-and-share/Support-for-Hello-discontinued-in-Firefox-49/ta-p/37946
// NOTICE-DISABLED: Firefox Hello requires setting  media.peerconnection.enabled  and  media.getusermedia.screensharing.enabled  to true,  security.OCSP.require  to false to work.
//user_pref("loop.enabled",		false);

// PREF: Disable Firefox Hello metrics collection
// https://groups.google.com/d/topic/mozilla.dev.platform/nyVkCx-_sFw/discussion
user_pref("loop.logDomains",					false);

// PREF: Enable Auto Update (disabled)
// NOTICE: Fully automatic updates are disabled and left to package management systems on Linux. Windows users may want to change this setting.
// CIS 2.1.1
//user_pref("app.update.auto",					true);

// PREF: Enforce checking for Firefox updates
// http://kb.mozillazine.org/App.update.enabled
// NOTICE: Update check page might incorrectly report Firefox ESR as out-of-date
user_pref("app.update.enabled",                 true);

// PREF: Enable blocking reported web forgeries
// https://wiki.mozilla.org/Security/Safe_Browsing
// http://kb.mozillazine.org/Safe_browsing
// https://support.mozilla.org/en-US/kb/how-does-phishing-and-malware-protection-work
// http://forums.mozillazine.org/viewtopic.php?f=39&t=2711237&p=12896849#p12896849
// CIS 2.3.4
user_pref("browser.safebrowsing.enabled",			true); // Firefox < 50
user_pref("browser.safebrowsing.phishing.enabled",		true); // firefox >= 50

// PREF: Enable blocking reported attack sites
// http://kb.mozillazine.org/Browser.safebrowsing.malware.enabled
// CIS 2.3.5
user_pref("browser.safebrowsing.malware.enabled",		true);

// PREF: Disable querying Google Application Reputation database for downloaded binary files
// https://www.mozilla.org/en-US/firefox/39.0/releasenotes/
// https://wiki.mozilla.org/Security/Application_Reputation
user_pref("browser.safebrowsing.downloads.remote.enabled",	false);

// PREF: Disable Pocket
// https://support.mozilla.org/en-US/kb/save-web-pages-later-pocket-firefox
// https://github.com/pyllyukko/user.js/issues/143
user_pref("browser.pocket.enabled",				false);
user_pref("extensions.pocket.enabled",				false);

// PREF: Disable "Recommended by Pocket" in Firefox Quantum
user_pref("browser.newtabpage.activity-stream.feeds.section.topstories",	false);

// PREF: Enable Global Privacy Control (GPC) (Firefox >= 120)
// https://support.mozilla.org/1/firefox/126.0/Linux/en-US/global-privacy-control
// https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Sec-GPC
// https://globalprivacycontrol.org/
user_pref("privacy.globalprivacycontrol.enabled",		true);

/******************************************************************************
 * SECTION: Automatic connections                                             *
 ******************************************************************************/

// PREF: Limit the connection keep-alive timeout to 15 seconds (disabled)
// https://github.com/pyllyukko/user.js/issues/387
// http://kb.mozillazine.org/Network.http.keep-alive.timeout
// https://httpd.apache.org/docs/current/mod/core.html#keepalivetimeout
//user_pref("network.http.keep-alive.timeout",			15);

// PREF: Disable prefetching of <link rel="next"> URLs
// http://kb.mozillazine.org/Network.prefetch-next
// https://developer.mozilla.org/en-US/docs/Web/HTTP/Link_prefetching_FAQ#Is_there_a_preference_to_disable_link_prefetching.3F
user_pref("network.prefetch-next",				false);

// PREF: Disable DNS prefetching
// http://kb.mozillazine.org/Network.dns.disablePrefetch
// https://developer.mozilla.org/en-US/docs/Web/HTTP/Controlling_DNS_prefetching
user_pref("network.dns.disablePrefetch",			true);
user_pref("network.dns.disablePrefetchFromHTTPS",		true);

// PREF: Disable the predictive service (Necko)
// https://wiki.mozilla.org/Privacy/Reviews/Necko
user_pref("network.predictor.enabled",				false);

// PREF: Reject .onion hostnames before passing the to DNS
// https://bugzilla.mozilla.org/show_bug.cgi?id=1228457
// RFC 7686
user_pref("network.dns.blockDotOnion",				true);

// PREF: Disable search suggestions in the search bar
// http://kb.mozillazine.org/Browser.search.suggest.enabled
user_pref("browser.search.suggest.enabled",			false);

// PREF: Disable "Show search suggestions in location bar results"
user_pref("browser.urlbar.suggest.searches",			false);
// PREF: When using the location bar, don't suggest URLs from browsing history
user_pref("browser.urlbar.suggest.history",			false);
// PREF: Disable Firefox Suggest
// https://www.ghacks.net/2021/09/09/how-to-disable-firefox-suggest/
// https://support.mozilla.org/en-US/kb/navigate-web-faster-firefox-suggest
user_pref("browser.urlbar.groupLabels.enabled", false); // Firefox >= 93

// PREF: Disable SSDP
// https://bugzilla.mozilla.org/show_bug.cgi?id=1111967
user_pref("browser.casting.enabled",				false);

// PREF: Disable automatic downloading of OpenH264 codec
// https://support.mozilla.org/en-US/kb/how-stop-firefox-making-automatic-connections#w_media-capabilities
// https://andreasgal.com/2014/10/14/openh264-now-in-firefox/
user_pref("media.gmp-gmpopenh264.enabled",			false);
user_pref("media.gmp-manager.url",				"");

// PREF: Disable speculative pre-connections
// https://support.mozilla.org/en-US/kb/how-stop-firefox-making-automatic-connections#w_speculative-pre-connections
// https://bugzilla.mozilla.org/show_bug.cgi?id=814169
user_pref("network.http.speculative-parallel-limit",		0);

// PREF: Disable downloading homepage snippets/messages from Mozilla
// https://support.mozilla.org/en-US/kb/how-stop-firefox-making-automatic-connections#w_mozilla-content
// https://wiki.mozilla.org/Firefox/Projects/Firefox_Start/Snippet_Service
user_pref("browser.aboutHomeSnippets.updateUrl",		"");

// PREF: Never check updates for search engines
// https://support.mozilla.org/en-US/kb/how-stop-firefox-making-automatic-connections#w_auto-update-checking
user_pref("browser.search.update",				false);

// PREF: Disable automatic captive portal detection (Firefox >= 52.0)
// https://support.mozilla.org/en-US/questions/1157121
user_pref("network.captive-portal-service.enabled",		false);

// PREF: Disable (parts of?) "TopSites"
user_pref("browser.topsites.contile.enabled",				false);
user_pref("browser.newtabpage.activity-stream.feeds.topsites",		false);
user_pref("browser.newtabpage.activity-stream.showSponsoredTopSites",	false);

/******************************************************************************
 * SECTION: HTTP                                                              *
 ******************************************************************************/

// PREF: Disallow NTLMv1
// https://bugzilla.mozilla.org/show_bug.cgi?id=828183
user_pref("network.negotiate-auth.allow-insecure-ntlm-v1",	false);
// it is still allowed through HTTPS. uncomment the following to disable it completely.
//user_pref("network.negotiate-auth.allow-insecure-ntlm-v1-https",		false);

// PREF: Enable CSP 1.1 script-nonce directive support
// https://bugzilla.mozilla.org/show_bug.cgi?id=855326
user_pref("security.csp.experimentalEnabled",			true);

// PREF: Enable Content Security Policy (CSP)
// https://developer.mozilla.org/en-US/docs/Web/Security/CSP/Introducing_Content_Security_Policy
// https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP
user_pref("security.csp.enable",				true);

// PREF: Enable Subresource Integrity
// https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity
// https://wiki.mozilla.org/Security/Subresource_Integrity
user_pref("security.sri.enable",				true);

// PREF: DNT HTTP header (disabled)
// https://www.mozilla.org/en-US/firefox/dnt/
// https://en.wikipedia.org/wiki/Do_not_track_header
// https://dnt-dashboard.mozilla.org
// https://github.com/pyllyukko/user.js/issues/11
// NOTICE: Do No Track must be enabled manually
//user_pref("privacy.donottrackheader.enabled",		true);

// PREF: Send a referer header with the target URI as the source (disabled)
// https://bugzilla.mozilla.org/show_bug.cgi?id=822869
// https://github.com/pyllyukko/user.js/issues/227
// NOTICE-DISABLED: Spoofing referers breaks functionality on websites relying on authentic referer headers
// NOTICE-DISABLED: Spoofing referers breaks visualisation of 3rd-party sites on the Lightbeam addon
// NOTICE-DISABLED: Spoofing referers disables CSRF protection on some login pages not implementing origin-header/cookie+token based CSRF protection
// TODO: https://github.com/pyllyukko/user.js/issues/94, commented-out XOriginPolicy/XOriginTrimmingPolicy = 2 prefs
//user_pref("network.http.referer.spoofSource",			true);

// PREF: Don't send referer headers when following links across different domains
// https://github.com/pyllyukko/user.js/issues/227
// https://github.com/pyllyukko/user.js/issues/328
// https://feeding.cloud.geek.nz/posts/tweaking-referrer-for-privacy-in-firefox/
// https://wiki.mozilla.org/Privacy/Privacy_Task_Force/firefox_about_config_privacy_tweeks
// NOTICE: Blocking referers across same eTLD sites breaks some login flows relying on them, consider lowering this pref to 1
user_pref("network.http.referer.XOriginPolicy",		2);

// PREF: Trim HTTP referer headers to only send the scheme, host, and port
// https://wiki.mozilla.org/Privacy/Privacy_Task_Force/firefox_about_config_privacy_tweeks
user_pref("network.http.referer.trimmingPolicy",	2);

// PREF: When sending Referer across domains, only send scheme, host, and port in the Referer header
// https://wiki.mozilla.org/Privacy/Privacy_Task_Force/firefox_about_config_privacy_tweeks
user_pref("network.http.referer.XOriginTrimmingPolicy",	2);

// PREF: Accept Only 1st Party Cookies
// http://kb.mozillazine.org/Network.cookie.cookieBehavior#1
// NOTICE: Blocking 3rd-party cookies breaks a number of payment gateways
// CIS 2.5.1
//user_pref("network.cookie.cookieBehavior",			1);

// PREF: Enable first-party isolation
// https://bugzilla.mozilla.org/show_bug.cgi?id=1299996
// https://bugzilla.mozilla.org/show_bug.cgi?id=1260931
// https://wiki.mozilla.org/Security/FirstPartyIsolation
// NOTICE: First-party isolation breaks Microsoft Teams
// NOTICE: First-party isolation causes HTTP basic auth to ask for credentials for every new tab (see #425)
user_pref("privacy.firstparty.isolate",				true);

// PREF: Make sure that third-party cookies (if enabled) never persist beyond the session.
// https://feeding.cloud.geek.nz/posts/tweaking-cookies-for-privacy-in-firefox/
// http://kb.mozillazine.org/Network.cookie.thirdparty.sessionOnly
// https://developer.mozilla.org/en-US/docs/Cookies_Preferences_in_Mozilla#network.cookie.thirdparty.sessionOnly
//user_pref("network.cookie.thirdparty.sessionOnly",		true);

// PREF: Spoof User-agent (disabled)
//user_pref("general.useragent.override",				"Mozilla/5.0 (Windows NT 6.1; rv:45.0) Gecko/20100101 Firefox/45.0");
//user_pref("general.appname.override",				"Netscape");
//user_pref("general.appversion.override",			"5.0 (Windows)");
//user_pref("general.platform.override",				"Win32");
//user_pref("general.oscpu.override",				"Windows NT 6.1");

/*******************************************************************************
 * SECTION: Caching                                                            *
 ******************************************************************************/

// PREF: Permanently enable private browsing mode
// https://support.mozilla.org/en-US/kb/Private-Browsing
// https://wiki.mozilla.org/PrivateBrowsing
// NOTICE: You can not view or inspect cookies when in private browsing: https://bugzilla.mozilla.org/show_bug.cgi?id=823941
// NOTICE: When Javascript is enabled, Websites can detect use of Private Browsing mode
// NOTICE: Private browsing breaks Kerberos authentication
// NOTICE: Disables "Containers" functionality (see below)
// NOTICE: "Always use private browsing mode" (browser.privatebrowsing.autostart) disables the possibility to use password manager: https://support.mozilla.org/en-US/kb/usernames-and-passwords-are-not-saved#w_private-browsing
//user_pref("browser.privatebrowsing.autostart",			true);

// PREF: Do not download URLs for the offline cache
// http://kb.mozillazine.org/Browser.cache.offline.enable
user_pref("browser.cache.offline.enable",			false);

// PREF: Clear history when Firefox closes
// https://support.mozilla.org/en-US/kb/Clear%20Recent%20History#w_how-do-i-make-firefox-clear-my-history-automatically
// NOTICE: Installing user.js will remove your browsing history, caches and local storage.
// NOTICE: Installing user.js **will remove your saved passwords** (https://github.com/pyllyukko/user.js/issues/27)
// NOTICE: Clearing open windows on Firefox exit causes 2 windows to open when Firefox starts https://bugzilla.mozilla.org/show_bug.cgi?id=1334945
//user_pref("privacy.sanitize.sanitizeOnShutdown",		true);
//user_pref("privacy.clearOnShutdown.cache",			true);
//user_pref("privacy.clearOnShutdown.cookies",			true);
user_pref("privacy.clearOnShutdown.downloads",			true);
user_pref("privacy.clearOnShutdown.formdata",			true);
//user_pref("privacy.clearOnShutdown.history",			true);
user_pref("privacy.clearOnShutdown.offlineApps",		true);
//user_pref("privacy.clearOnShutdown.sessions",			true);
//user_pref("privacy.clearOnShutdown.openWindows",		true);

// PREF: Set time range to "Everything" as default in "Clear Recent History"
//user_pref("privacy.sanitize.timeSpan",				0);

// PREF: Clear everything but "Site Preferences" in "Clear Recent History"
user_pref("privacy.cpd.offlineApps",				true);
//user_pref("privacy.cpd.cache",					true);
//user_pref("privacy.cpd.cookies",				true);
user_pref("privacy.cpd.downloads",				true);
user_pref("privacy.cpd.formdata",				true);
//user_pref("privacy.cpd.history",				true);
//user_pref("privacy.cpd.sessions",				true);

// PREF: Don't remember browsing history
user_pref("places.history.enabled",				false);

// PREF: Don't remember recently closed tabs
//user_pref("browser.sessionstore.max_tabs_undo",		0);

// PREF: Disable disk cache
// http://kb.mozillazine.org/Browser.cache.disk.enable
user_pref("browser.cache.disk.enable",				false);

// PREF: Disable memory cache (disabled)
// http://kb.mozillazine.org/Browser.cache.memory.enable
//user_pref("browser.cache.memory.enable",		false);

// PREF: Disable Caching of SSL Pages
// CIS Version 1.2.0 October 21st, 2011 2.5.8
// http://kb.mozillazine.org/Browser.cache.disk_cache_ssl
user_pref("browser.cache.disk_cache_ssl",			false);

// PREF: Disable download history
// CIS Version 1.2.0 October 21st, 2011 2.5.5
user_pref("browser.download.manager.retention",			0);

// PREF: Disable password manager (use an external password manager!)
// CIS Version 1.2.0 October 21st, 2011 2.5.2
user_pref("signon.rememberSignons",				false);

// PREF: Disable form autofill, don't save information entered in web page forms and the Search Bar
user_pref("browser.formfill.enable",				false);

// PREF: Cookies expires at the end of the session (when the browser closes)
// http://kb.mozillazine.org/Network.cookie.lifetimePolicy#2
//user_pref("network.cookie.lifetimePolicy",			2);

// PREF: Require manual intervention to autofill known username/passwords sign-in forms
// http://kb.mozillazine.org/Signon.autofillForms
// https://www.torproject.org/projects/torbrowser/design/#identifier-linkability
user_pref("signon.autofillForms",				false);

// PREF: Disable formless login capture
// https://bugzilla.mozilla.org/show_bug.cgi?id=1166947
user_pref("signon.formlessCapture.enabled",			false);

// PREF: When username/password autofill is enabled, still disable it on non-HTTPS sites
// https://hg.mozilla.org/integration/mozilla-inbound/rev/f0d146fe7317
user_pref("signon.autofillForms.http",				false);

// PREF: Show in-content login form warning UI for insecure login fields
// https://hg.mozilla.org/integration/mozilla-inbound/rev/f0d146fe7317
user_pref("security.insecure_field_warning.contextual.enabled", true);

// PREF: Disable the password manager for pages with autocomplete=off (disabled)
// https://bugzilla.mozilla.org/show_bug.cgi?id=956906
// OWASP ASVS V9.1
// Does not prevent any kind of auto-completion (see browser.formfill.enable, signon.autofillForms)
//user_pref("signon.storeWhenAutocompleteOff",			false);

// PREF: Delete Search and Form History
// CIS Version 1.2.0 October 21st, 2011 2.5.6
user_pref("browser.formfill.expire_days",			0);

// PREF: Clear SSL Form Session Data
// http://kb.mozillazine.org/Browser.sessionstore.privacy_level#2
// Store extra session data for unencrypted (non-HTTPS) sites only.
// CIS Version 1.2.0 October 21st, 2011 2.5.7
// NOTE: CIS says 1, we use 2
user_pref("browser.sessionstore.privacy_level",			2);

// PREF: Delete temporary files on exit
// https://bugzilla.mozilla.org/show_bug.cgi?id=238789
user_pref("browser.helperApps.deleteTempFileOnExit",		true);

// PREF: Do not create screenshots of visited pages (relates to the "new tab page" feature)
// https://support.mozilla.org/en-US/questions/973320
// https://developer.mozilla.org/en-US/docs/Mozilla/Preferences/Preference_reference/browser.pagethumbnails.capturing_disabled
user_pref("browser.pagethumbnails.capturing_disabled",		true);

// PREF: Don't fetch and permanently store favicons for Windows .URL shortcuts created by drag and drop
// NOTICE: .URL shortcut files will be created with a generic icon
// Favicons are stored as .ico files in \profile_dir\shortcutCache
user_pref("browser.shell.shortcutFavicons",					false);

// PREF: Disable bookmarks backups (default: 15)
// http://kb.mozillazine.org/Browser.bookmarks.max_backups
user_pref("browser.bookmarks.max_backups", 0);

// PREF: Export bookmarks to HTML automatically when closing Firefox (disabled)
// https://support.mozilla.org/en-US/questions/1176242
//user_pref("browser.bookmarks.autoExportHTML", 				true);
//user_pref("browser.bookmarks.file",	'/path/to/bookmarks-export.html');

// PREF: Disable downloading of favicons in response to favicon fingerprinting techniques
// https://github.com/jonasstrehle/supercookie
// http://kb.mozillazine.org/Browser.chrome.site_icons
// https://blog.mozilla.org/security/2021/01/26/supercookie-protections/
user_pref("browser.chrome.site_icons",				false);

/*******************************************************************************
 * SECTION: UI related                                                         *
 *******************************************************************************/

// PREF: Enable insecure password warnings (login forms in non-HTTPS pages)
// https://blog.mozilla.org/tanvi/2016/01/28/no-more-passwords-over-http-please/
// https://bugzilla.mozilla.org/show_bug.cgi?id=1319119
// https://bugzilla.mozilla.org/show_bug.cgi?id=1217156
user_pref("security.insecure_password.ui.enabled",		true);

// PREF: Disable right-click menu manipulation via JavaScript (disabled)
//user_pref("dom.event.contextmenu.enabled",		false);

// PREF: Disable "Are you sure you want to leave this page?" popups on page close
// https://support.mozilla.org/en-US/questions/1043508
// NOTICE: disabling "beforeunload" events may lead to losing data entered in web forms
// Does not prevent JS leaks of the page close event.
// https://developer.mozilla.org/en-US/docs/Web/Events/beforeunload
//user_pref("dom.disable_beforeunload",    true);

// PREF: Disable Downloading on Desktop
// CIS 2.3.2
user_pref("browser.download.folderList",			2);

// PREF: Always ask the user where to download
// https://developer.mozilla.org/en/Download_Manager_preferences (obsolete)
user_pref("browser.download.useDownloadDir",			false);

// PREF: Disable the "new tab page" feature and show a blank tab instead
// https://wiki.mozilla.org/Privacy/Reviews/New_Tab
// https://support.mozilla.org/en-US/kb/new-tab-page-show-hide-and-customize-top-sites#w_how-do-i-turn-the-new-tab-page-off
user_pref("browser.newtabpage.enabled",				false);
user_pref("browser.newtab.url",					"about:blank");

// PREF: Disable Snippets
// https://wiki.mozilla.org/Firefox/Projects/Firefox_Start/Snippet_Service
// https://support.mozilla.org/en-US/kb/snippets-firefox-faq
user_pref("browser.newtabpage.activity-stream.feeds.snippets",	false);

// PREF: Disable Activity Stream
// https://wiki.mozilla.org/Firefox/Activity_Stream
user_pref("browser.newtabpage.activity-stream.enabled",		false);

// PREF: Disable new tab tile ads & preload
// http://www.thewindowsclub.com/disable-remove-ad-tiles-from-firefox
// http://forums.mozillazine.org/viewtopic.php?p=13876331#p13876331
// https://wiki.mozilla.org/Tiles/Technical_Documentation#Ping
// https://gecko.readthedocs.org/en/latest/browser/browser/DirectoryLinksProvider.html#browser-newtabpage-directory-source
// https://gecko.readthedocs.org/en/latest/browser/browser/DirectoryLinksProvider.html#browser-newtabpage-directory-ping
// TODO: deprecated? not in DXR, some dead links
user_pref("browser.newtabpage.enhanced",			false);
user_pref("browser.newtab.preload",				false);
user_pref("browser.newtabpage.directory.ping",			"");
user_pref("browser.newtabpage.directory.source",		"data:text/plain,{}");

// PREF: Disable Mozilla VPN ads on the about:protections page
// https://support.mozilla.org/en-US/kb/what-mozilla-vpn-and-how-does-it-work
// https://en.wikipedia.org/wiki/Mozilla_VPN
// https://blog.mozilla.org/security/2021/08/31/mozilla-vpn-security-audit/
// https://www.mozilla.org/en-US/security/advisories/mfsa2021-31/
user_pref("browser.vpn_promo.enabled",			false);

// PREF: Enable Auto Notification of Outdated Plugins (Firefox < 50)
// https://wiki.mozilla.org/Firefox3.6/Plugin_Update_Awareness_Security_Review
// CIS Version 1.2.0 October 21st, 2011 2.1.2
// https://hg.mozilla.org/mozilla-central/rev/304560
user_pref("plugins.update.notifyUser",				true);

// PREF: Force Punycode for Internationalized Domain Names
// http://kb.mozillazine.org/Network.IDN_show_punycode
// https://www.xudongz.com/blog/2017/idn-phishing/
// https://wiki.mozilla.org/IDN_Display_Algorithm
// https://en.wikipedia.org/wiki/IDN_homograph_attack
// https://www.mozilla.org/en-US/security/advisories/mfsa2017-02/
// CIS Mozilla Firefox 24 ESR v1.0.0 - 3.6
user_pref("network.IDN_show_punycode",				true);

// PREF: Disable inline autocomplete in URL bar
// http://kb.mozillazine.org/Inline_autocomplete
user_pref("browser.urlbar.autoFill",				false);
user_pref("browser.urlbar.autoFill.typed",			false);

// PREF: Disable CSS :visited selectors
// https://blog.mozilla.org/security/2010/03/31/plugging-the-css-history-leak/
// https://dbaron.org/mozilla/visited-privacy
user_pref("layout.css.visited_links_enabled",			false);

// PREF: Disable URL bar autocomplete and history/bookmarks suggestions dropdown
// http://kb.mozillazine.org/Disabling_autocomplete_-_Firefox#Firefox_3.5
user_pref("browser.urlbar.autocomplete.enabled",		false);

// PREF: Do not check if Firefox is the default browser
user_pref("browser.shell.checkDefaultBrowser",			false);

// PREF: When password manager is enabled, lock the password storage periodically
// CIS Version 1.2.0 October 21st, 2011 2.5.3 Disable Prompting for Credential Storage
user_pref("security.ask_for_password",				2);

// PREF: Lock the password storage every 1 minutes (default: 30)
user_pref("security.password_lifetime",				1);

// PREF: Display a notification bar when websites offer data for offline use
// http://kb.mozillazine.org/Browser.offline-apps.notify
user_pref("browser.offline-apps.notify",			true);

/******************************************************************************
 * SECTION: Cryptography                                                      *
 ******************************************************************************/

// PREF: Enable HTTPS-Only Mode
// https://blog.mozilla.org/security/2020/11/17/firefox-83-introduces-https-only-mode/
// https://www.feistyduck.com/bulletproof-tls-newsletter/issue_71_firefox_introduces_https_only_mode
user_pref("dom.security.https_only_mode",			true);

// PREF: Enable HSTS preload list (pre-set HSTS sites list provided by Mozilla)
// https://blog.mozilla.org/security/2012/11/01/preloading-hsts/
// https://wiki.mozilla.org/Privacy/Features/HSTS_Preload_List
// https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security
user_pref("network.stricttransportsecurity.preloadlist",	true);

// PREF: Enable Online Certificate Status Protocol
// https://en.wikipedia.org/wiki/Online_Certificate_Status_Protocol
// https://www.imperialviolet.org/2014/04/19/revchecking.html
// https://www.maikel.pro/blog/current-state-certificate-revocation-crls-ocsp/
// https://wiki.mozilla.org/CA:RevocationPlan
// https://wiki.mozilla.org/CA:ImprovingRevocation
// https://wiki.mozilla.org/CA:OCSP-HardFail
// https://news.netcraft.com/archives/2014/04/24/certificate-revocation-why-browsers-remain-affected-by-heartbleed.html
// https://news.netcraft.com/archives/2013/04/16/certificate-revocation-and-the-performance-of-ocsp.html
// NOTICE: OCSP leaks your IP and domains you visit to the CA when OCSP Stapling is not available on visited host
// NOTICE: OCSP is vulnerable to replay attacks when nonce is not configured on the OCSP responder
// NOTICE: OCSP adds latency (performance)
// NOTICE: Short-lived certificates are not checked for revocation (security.pki.cert_short_lifetime_in_days, default:10)
// CIS Version 1.2.0 October 21st, 2011 2.2.4
user_pref("security.OCSP.enabled",				1);

// PREF: Enable OCSP Stapling support
// https://en.wikipedia.org/wiki/OCSP_stapling
// https://blog.mozilla.org/security/2013/07/29/ocsp-stapling-in-firefox/
// https://www.digitalocean.com/community/tutorials/how-to-configure-ocsp-stapling-on-apache-and-nginx
user_pref("security.ssl.enable_ocsp_stapling",			true);

// PREF: Enable OCSP Must-Staple support (Firefox >= 45)
// https://blog.mozilla.org/security/2015/11/23/improving-revocation-ocsp-must-staple-and-short-lived-certificates/
// https://www.entrust.com/ocsp-must-staple/
// https://github.com/schomery/privacy-settings/issues/40
// NOTICE: Firefox falls back on plain OCSP when must-staple is not configured on the host certificate
user_pref("security.ssl.enable_ocsp_must_staple",		true);

// PREF: Require a valid OCSP response for OCSP enabled certificates (disabled)
// https://groups.google.com/forum/#!topic/mozilla.dev.security/n1G-N2-HTVA
// https://www.feistyduck.com/newsletter/issue_121_the_slow_death_of_ocsp
// Disabling this will make OCSP bypassable by MitM attacks suppressing OCSP responses
// NOTICE:  security.OCSP.require  will make the connection fail when the OCSP responder is unavailable
// NOTICE:  security.OCSP.require  is known to break browsing on some [captive portals](https://en.wikipedia.org/wiki/Captive_portal)
//user_pref("security.OCSP.require",				true);

// PREF: Disable TLS Session Tickets
// https://www.blackhat.com/us-13/briefings.html#NextGen
// https://media.blackhat.com/us-13/US-13-Daigniere-TLS-Secrets-Slides.pdf
// https://media.blackhat.com/us-13/US-13-Daigniere-TLS-Secrets-WP.pdf
// https://bugzilla.mozilla.org/show_bug.cgi?id=917049
// https://bugzilla.mozilla.org/show_bug.cgi?id=967977
user_pref("security.ssl.disable_session_identifiers",		true);

// PREF: Only allow TLS 1.[2-3]
// http://kb.mozillazine.org/Security.tls.version.*
// 1 = TLS 1.0 is the minimum required / maximum supported encryption protocol. (This is the current default for the maximum supported version.)
// 2 = TLS 1.1 is the minimum required / maximum supported encryption protocol.
// 3 = TLS 1.2 is the minimum required / maximum supported encryption protocol.
// 4 = TLS 1.3 is the minimum required / maximum supported encryption protocol.
user_pref("security.tls.version.min",				3);
user_pref("security.tls.version.max",				4);

// PREF: Disable insecure TLS version fallback
// https://bugzilla.mozilla.org/show_bug.cgi?id=1084025
// https://github.com/pyllyukko/user.js/pull/206#issuecomment-280229645
user_pref("security.tls.version.fallback-limit",		4);

// PREF: Enforce Public Key Pinning
// https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning
// https://wiki.mozilla.org/SecurityEngineering/Public_Key_Pinning
// "2. Strict. Pinning is always enforced."
user_pref("security.cert_pinning.enforcement_level",		2);

// PREF: Disallow SHA-1
// https://bugzilla.mozilla.org/show_bug.cgi?id=1302140
// https://shattered.io/
user_pref("security.pki.sha1_enforcement_level",		1);

// PREF: Warn the user when server doesn't support RFC 5746 ("safe" renegotiation)
// https://wiki.mozilla.org/Security:Renegotiation#security.ssl.treat_unsafe_negotiation_as_broken
// https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555
user_pref("security.ssl.treat_unsafe_negotiation_as_broken",	true);

// PREF: Disallow connection to servers not supporting safe renegotiation (disabled)
// https://wiki.mozilla.org/Security:Renegotiation#security.ssl.require_safe_negotiation
// https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2009-3555
// TODO:  security.ssl.require_safe_negotiation  is more secure but makes browsing next to impossible (2012-2014-... -  ssl_error_unsafe_negotiation  errors), so is left disabled
//user_pref("security.ssl.require_safe_negotiation",		true);

// PREF: Disable automatic reporting of TLS connection errors
// https://support.mozilla.org/en-US/kb/certificate-pinning-reports
// we could also disable security.ssl.errorReporting.enabled, but I think it's
// good to leave the option to report potentially malicious sites if the user
// chooses to do so.
// you can test this at https://pinningtest.appspot.com/
user_pref("security.ssl.errorReporting.automatic",		false);

// PREF: Pre-populate the current URL but do not pre-fetch the certificate in the "Add Security Exception" dialog
// http://kb.mozillazine.org/Browser.ssl_override_behavior
// https://github.com/pyllyukko/user.js/issues/210
user_pref("browser.ssl_override_behavior",			1);

// PREF: Encrypted SNI (when TRR is enabled)
// https://www.cloudflare.com/ssl/encrypted-sni/
// https://wiki.mozilla.org/Trusted_Recursive_Resolver#ESNI
// https://en.wikipedia.org/wiki/Server_Name_Indication#Security_implications_(ESNI)
user_pref("network.security.esni.enabled",			true);

// PREF: Disable the Enterprise Roots preference
// https://support.mozilla.org/en-US/kb/how-disable-enterprise-roots-preference
// https://github.com/pyllyukko/user.js/issues/560
user_pref("security.certerrors.mitm.auto_enable_enterprise_roots",	false);
user_pref("security.enterprise_roots.enabled",				false);

/******************************************************************************
 * SECTION: Cipher suites                                                     *
 ******************************************************************************/

// PREF: Disable null ciphers
user_pref("security.ssl3.rsa_null_sha",				false);
user_pref("security.ssl3.rsa_null_md5",				false);
user_pref("security.ssl3.ecdhe_rsa_null_sha",			false);
user_pref("security.ssl3.ecdhe_ecdsa_null_sha",			false);
user_pref("security.ssl3.ecdh_rsa_null_sha",			false);
user_pref("security.ssl3.ecdh_ecdsa_null_sha",			false);

// PREF: Disable SEED cipher
// https://en.wikipedia.org/wiki/SEED
user_pref("security.ssl3.rsa_seed_sha",				false);

// PREF: Disable 40/56/128-bit ciphers
// 40-bit ciphers
user_pref("security.ssl3.rsa_rc4_40_md5",			false);
user_pref("security.ssl3.rsa_rc2_40_md5",			false);
// 56-bit ciphers
user_pref("security.ssl3.rsa_1024_rc4_56_sha",			false);
// 128-bit ciphers
user_pref("security.ssl3.rsa_camellia_128_sha",			false);
user_pref("security.ssl3.ecdhe_rsa_aes_128_sha",		false);
user_pref("security.ssl3.ecdhe_ecdsa_aes_128_sha",		false);
user_pref("security.ssl3.ecdh_rsa_aes_128_sha",			false);
user_pref("security.ssl3.ecdh_ecdsa_aes_128_sha",		false);
user_pref("security.ssl3.dhe_rsa_camellia_128_sha",		false);
user_pref("security.ssl3.dhe_rsa_aes_128_sha",			false);

// PREF: Disable RC4
// https://developer.mozilla.org/en-US/Firefox/Releases/38#Security
// https://bugzilla.mozilla.org/show_bug.cgi?id=1138882
// https://rc4.io/
// https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2013-2566
user_pref("security.ssl3.ecdh_ecdsa_rc4_128_sha",		false);
user_pref("security.ssl3.ecdh_rsa_rc4_128_sha",			false);
user_pref("security.ssl3.ecdhe_ecdsa_rc4_128_sha",		false);
user_pref("security.ssl3.ecdhe_rsa_rc4_128_sha",		false);
user_pref("security.ssl3.rsa_rc4_128_md5",			false);
user_pref("security.ssl3.rsa_rc4_128_sha",			false);
user_pref("security.tls.unrestricted_rc4_fallback",		false);

// PREF: Disable 3DES (effective key size is < 128)
// https://en.wikipedia.org/wiki/3des#Security
// http://en.citizendium.org/wiki/Meet-in-the-middle_attack
// http://www-archive.mozilla.org/projects/security/pki/nss/ssl/fips-ssl-ciphersuites.html
user_pref("security.ssl3.dhe_dss_des_ede3_sha",			false);
user_pref("security.ssl3.dhe_rsa_des_ede3_sha",			false);
user_pref("security.ssl3.ecdh_ecdsa_des_ede3_sha",		false);
user_pref("security.ssl3.ecdh_rsa_des_ede3_sha",		false);
user_pref("security.ssl3.ecdhe_ecdsa_des_ede3_sha",		false);
user_pref("security.ssl3.ecdhe_rsa_des_ede3_sha",		false);
user_pref("security.ssl3.rsa_des_ede3_sha",			false);
user_pref("security.ssl3.rsa_fips_des_ede3_sha",		false);

// PREF: Disable ciphers with ECDH (non-ephemeral)
user_pref("security.ssl3.ecdh_rsa_aes_256_sha",			false);
user_pref("security.ssl3.ecdh_ecdsa_aes_256_sha",		false);

// PREF: Disable 256 bits ciphers without PFS
user_pref("security.ssl3.rsa_camellia_256_sha",			false);

// PREF: Enable GCM ciphers (TLSv1.2 only)
// https://en.wikipedia.org/wiki/Galois/Counter_Mode
user_pref("security.ssl3.ecdhe_ecdsa_aes_128_gcm_sha256",	true); // 0xc02b
user_pref("security.ssl3.ecdhe_rsa_aes_128_gcm_sha256",		true); // 0xc02f

// PREF: Enable ChaCha20 and Poly1305 (Firefox >= 47)
// https://www.mozilla.org/en-US/firefox/47.0/releasenotes/
// https://tools.ietf.org/html/rfc7905
// https://bugzilla.mozilla.org/show_bug.cgi?id=917571
// https://bugzilla.mozilla.org/show_bug.cgi?id=1247860
// https://cr.yp.to/chacha.html
user_pref("security.ssl3.ecdhe_ecdsa_chacha20_poly1305_sha256",	true);
user_pref("security.ssl3.ecdhe_rsa_chacha20_poly1305_sha256",	true);

// PREF: Disable ciphers susceptible to the logjam attack
// https://weakdh.org/
user_pref("security.ssl3.dhe_rsa_camellia_256_sha",		false);
user_pref("security.ssl3.dhe_rsa_aes_256_sha",			false);

// PREF: Disable ciphers with DSA (max 1024 bits)
user_pref("security.ssl3.dhe_dss_aes_128_sha",			false);
user_pref("security.ssl3.dhe_dss_aes_256_sha",			false);
user_pref("security.ssl3.dhe_dss_camellia_128_sha",		false);
user_pref("security.ssl3.dhe_dss_camellia_256_sha",		false);

// PREF: Ciphers with CBC & SHA-1 (disabled)
//user_pref("security.ssl3.rsa_aes_256_sha",			false); // 0x35
//user_pref("security.ssl3.rsa_aes_128_sha",			false); // 0x2f
//user_pref("security.ssl3.ecdhe_rsa_aes_256_sha",		false); // 0xc014
//user_pref("security.ssl3.ecdhe_ecdsa_aes_256_sha",		false); // 0xc00a

// PREF: Enable X25519Kyber768Draft00 (post-quantum key exchange) [FF Nightly 2024-01-18+]
// https://datatracker.ietf.org/doc/draft-tls-westerbaan-xyber768d00/
// https://twitter.com/bwesterb/status/1748017372764475519
// https://pq.cloudflareresearch.com/
user_pref("security.tls.enable_kyber",				true);
EOFUS
  for curFile in $(find ~ -name prefs.js 2> /dev/null | grep firefox)
  do
    curDir=$(dirname $curFile)
    cp $HOME/user.js $curDir/
  done
  rm -f $HOME/user.js
}

function addVNCServer()
{
  set +e
  sudo systemctl list-unit-files x11vnc.service > /dev/null 2>&1
  if [ $? -eq 0 ] || sudo test -f /lib/systemd/system/x11vnc.service; then
    echo "There is already an existing x11vnc service installed. Please remove it, then retry."
    return
  fi
  echo "Installing x11vnc..."
  performAptUpdate true > /dev/null 2>&1
  performAptInstall x11vnc > /dev/null 2>&1
  echo "Configuring x11vnc..."
  sudo x11vnc -storepasswd "$USER_SUDO_PW" /etc/x11vnc.pass > /dev/null 2>&1
  sudo tee /lib/systemd/system/x11vnc.service >/dev/null <<EOFVN
[Unit]
Description=x11vnc service
After=display-manager.service network.target syslog.target

[Service]
Type=simple
ExecStart=/usr/bin/x11vnc -shared -display :0 -auth guess -rfbauth /etc/x11vnc.pass -rfbport $VNC_SERVER_PORT -geometry 1600x900 -xkb -noxrecord -noxdamage
ExecStop=/usr/bin/killall x11vnc
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOFVN
  sudo systemctl daemon-reload > /dev/null 2>&1
  sudo systemctl enable --now x11vnc.service > /dev/null 2>&1
  echo "Updating firewall..."
  # Allow dock-ext network access (for Guacamole)
  ruleName="dock-ext-net"
  subnet="${NET_EXTERNAL_SUBNET_PREFIX}.0/24"
  addFirewallSubnet "$ruleName" "${NET_EXTERNAL_SUBNET_PREFIX}.0" "24" > /dev/null 2>&1
  custNetID=$(sqlite3 $HSHQ_DB "select ID from customfwsubnet where Name='$ruleName' and Subnet='$subnet';")
  curPortsList=$(sqlite3 $HSHQ_DB "select InputAllowPorts from customfwsubnet where ID=$custNetID;")
  echo "$curPortsList" | grep -q "$VNC_SERVER_PORT" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    if [ -z "$curPortsList" ]; then
      curPortsList="${VNC_SERVER_PORT}/both"
    else
      curPortsList="${curPortsList},${VNC_SERVER_PORT}/both"
    fi
  fi
  updateExposedPortsLists INPUT "$custNetID (Custom)" "$curPortsList" > /dev/null 2>&1
  # Allow local network access
  primaryIfaceDBID=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType = 'primary' and NetworkType = 'home_network';")
  primaryIfaceBaseName=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$primaryIfaceDBID;")
  primaryIfaceIFName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$primaryIfaceDBID;")
  curPortsList=$(sqlite3 $HSHQ_DB "select InputAllowPorts from connections where ID=$primaryIfaceDBID;")
  echo "$curPortsList" | grep -q "$VNC_SERVER_PORT" > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    if [ -z "$curPortsList" ]; then
      curPortsList="${VNC_SERVER_PORT}/both"
    else
      curPortsList="${curPortsList},${VNC_SERVER_PORT}/both"
    fi
  fi
  updateExposedPortsLists INPUT "$primaryIfaceIFName ($primaryIfaceBaseName)" "$curPortsList" > /dev/null 2>&1
  echo "x11vnc installation complete!"
}

function removeVNCServer()
{
  set +e
  echo "Removing x11vnc..."
  sudo systemctl disable --now x11vnc.service > /dev/null 2>&1
  sudo rm -f /lib/systemd/system/x11vnc.service > /dev/null 2>&1
  sudo systemctl daemon-reload > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge -y x11vnc > /dev/null 2>&1
  echo "Updating firewall..."
  # dock-ext network
  ruleName="dock-ext-net"
  subnet="${NET_EXTERNAL_SUBNET_PREFIX}.0/24"
  custNetID=$(sqlite3 $HSHQ_DB "select ID from customfwsubnet where Name='$ruleName' and Subnet='$subnet';")
  if ! [ -z "$custNetID" ]; then
    curPortsList=$(sqlite3 $HSHQ_DB "select InputAllowPorts from customfwsubnet where ID=$custNetID;")
    echo "$curPortsList" | grep -q "$VNC_SERVER_PORT" > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      newPortsList=""
      portsListArr=($(echo "$curPortsList" | tr "," "\n"))
      for curPort in "${portsListArr[@]}"
      do
        chkPort=$(echo $curPort | cut -d"/" -f1)
        if [ "$chkPort" = "$VNC_SERVER_PORT" ]; then
          continue
        fi
        if [ -z "$newPortsList" ]; then
          newPortsList="$curPort"
        else
          newPortsList="${newPortsList},$curPort"
        fi
      done
      updateExposedPortsLists "INPUT" "$custNetID (Custom)" "$newPortsList" > /dev/null 2>&1
    fi
  fi
  # Local network
  primaryIfaceDBID=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType = 'primary' and NetworkType = 'home_network';")
  primaryIfaceBaseName=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$primaryIfaceDBID;")
  primaryIfaceIFName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$primaryIfaceDBID;")
  curPortsList=$(sqlite3 $HSHQ_DB "select InputAllowPorts from connections where ID=$primaryIfaceDBID;")
  echo "$curPortsList" | grep -q "$VNC_SERVER_PORT" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    newPortsList=""
    portsListArr=($(echo "$curPortsList" | tr "," "\n"))
    for curPort in "${portsListArr[@]}"
    do
      chkPort=$(echo $curPort | cut -d"/" -f1)
      if [ "$chkPort" = "$VNC_SERVER_PORT" ]; then
        continue
      fi
      if [ -z "$newPortsList" ]; then
        newPortsList="$curPort"
      else
        newPortsList="${newPortsList},$curPort"
      fi
    done
    updateExposedPortsLists INPUT "$primaryIfaceIFName ($primaryIfaceBaseName)" "$newPortsList" > /dev/null 2>&1
  fi
  echo "x11vnc removal complete!"
}

# Initialization
function createInitialEnv()
{
  createHSHQLog
  mkdir -p $HSHQ_BASE_DIR
  mkdir -p $HSHQ_DATA_DIR
  mkdir -p $HSHQ_BACKUP_DIR
  mkdir -p $HSHQ_NONBACKUP_DIR
  mkdir -p $HSHQ_BUILD_DIR
  mkdir -p $HSHQ_CONFIG_DIR
  mkdir -p $HSHQ_RELAYSERVER_DIR
  mkdir -p $HSHQ_SCRIPTS_DIR
  mkdir -p $HSHQ_SECRETS_DIR
  mkdir -p $HSHQ_SSL_DIR
  mkdir -p $HSHQ_STACKS_DIR
  mkdir -p $HSHQ_WIREGUARD_DIR
  mkdir -p $HSHQ_WIREGUARD_DIR/internet
  mkdir -p $HSHQ_WIREGUARD_DIR/vpn
  mkdir -p $HSHQ_WIREGUARD_DIR/scripts
  mkdir -p $HSHQ_WIREGUARD_DIR/users
  mkdir -p $HSHQ_WIREGUARD_DIR/requestkeys
  mkdir -p $HSHQ_WIREGUARD_DIR/logs
  mkdir -p $HSHQ_RELAYSERVER_DIR/backup
  mkdir -p $HSHQ_RELAYSERVER_DIR/scripts
  mkdir -p $HSHQ_SCRIPTS_DIR/user
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/root
  sudo chmod 700 $HSHQ_SCRIPTS_DIR/root
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/userasroot
  sudo chmod 700 $HSHQ_SCRIPTS_DIR/userasroot
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot/beforenetwork
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot/afterdocker
  sudo sed -i '/\/userasroot/d' /etc/sudoers >/dev/null
  echo "$USERNAME ALL=(ALL) NOPASSWD: $HSHQ_SCRIPTS_DIR/userasroot/*.sh" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/timestamp_timeout/d' /etc/sudoers >/dev/null
  echo "Defaults timestamp_timeout=$SUDO_NORMAL_TIMEOUT" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/passwd_tries/d' /etc/sudoers >/dev/null
  echo "Defaults passwd_tries=$SUDO_MAX_RETRIES" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/logfile=/d' /etc/sudoers >/dev/null
  echo "Defaults logfile=/var/log/sudo.log" | sudo tee -a /etc/sudoers >/dev/null
  sudo sed -i '/includedir/d' /etc/sudoers >/dev/null
  echo "@includedir /etc/sudoers.d" | sudo tee -a /etc/sudoers >/dev/null
  mkdir -p $HOME/.ssh
  set +e
  tmp_pw1=""
  tmp_pw2=""
  while [ -z "$tmp_pw1" ] || ! [ "$tmp_pw1" = "$tmp_pw2" ]
  do
    tmp_pw1=$(promptPasswordMenu "Create Password" "Create a password to encrypt/decrypt the configuration file. ENSURE you remember this or you will be IRREVERSIBLY locked out of it (unless you have a quantum super-computer) and you will not be able to apply updates, add new services, do networking functions, etc. Also note that this password will be stored in plain text inside of the same config file, in order to (re)encrypt the file in the future: ")
    if [ $? -ne 0 ]; then exit; fi
    if [ -z "$tmp_pw1" ]; then
      showMessageBox "Password Empty" "The password cannot be empty, please try again."
      continue
    fi
    if [ $(checkValidPassword "$tmp_pw1" 8) = "false" ]; then
      showMessageBox "Password Invalid" "The password is too short or contains invalid characters. It must contain at least 8 characters and consist of uppercase letters, lowercase letters, and numbers. It can only contain the following symbols: ~!@#%^&*()-_+=<>?.,"
      tmp_pw1=abc
      tmp_pw2=def
      continue
    fi
    tmp_pw2=$(promptPasswordMenu "Confirm Password" "Enter the password again to confirm: ")
    if [ $? -ne 0 ]; then exit; fi
    if [ -z "$tmp_pw1" ] || ! [ "$tmp_pw1" = "$tmp_pw2" ]; then
      showMessageBox "Password Mismatch" "The passwords do not match, please try again."
    fi
  done
  CONFIG_ENCRYPTION_PASSPHRASE="$tmp_pw1"
  tmp_pw1=""
  tmp_pw2=""
  CONFIG_FILE=$HSHQ_CONFIG_DIR/$CONFIG_FILE_DEFAULT_FILENAME
  outputEncConfigFile
  source $CONFIG_FILE
  outputPlainTextRootConfig
  source <(sudo cat $HSHQ_PLAINTEXT_ROOT_CONFIG)
  outputPlainTextUserConfig
  source $HSHQ_PLAINTEXT_USER_CONFIG
  initHSHQDB
  set -e
}

function createHSHQLog()
{
  if ! sudo test -f $HSHQ_LOG_FILE; then
    sudo touch $HSHQ_LOG_FILE
    sudo chown $USERNAME:$USERNAME $HSHQ_LOG_FILE
    sudo chmod 644 $HSHQ_LOG_FILE
  fi
}

# Version Updates
function checkUpdateVersion()
{
  if [ "$IS_INSTALLED" = "false" ] || [ "$IS_PERFORM_RESTORE" = "true" ]; then
    return
  fi
  is_update_performed=false
  if [ $HSHQ_VERSION -lt $HSHQ_LIB_SCRIPT_VERSION ]; then
    set +e
    checkAddAllNewSvcs
    set -e
    is_update_performed=true
    pauseCronService
  fi
  if [ $HSHQ_VERSION -lt 11 ]; then
    echo "Updating to Version 11..."
    HSHQ_VERSION=11
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 14 ]; then
    echo "Updating to Version 14..."
    version14Update
    HSHQ_VERSION=14
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 22 ]; then
    echo "Updating to Version 22..."
    version22Update
    HSHQ_VERSION=22
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 23 ]; then
    echo "Updating to Version 23..."
    version23Update
    HSHQ_VERSION=23
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 24 ]; then
    echo "Updating to Version 24..."
    version24Update
    HSHQ_VERSION=24
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 25 ]; then
    echo "Updating to Version 25..."
    version25Update
    HSHQ_VERSION=25
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 26 ]; then
    echo "Updating to Version 26..."
    version26Update
    HSHQ_VERSION=26
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 27 ]; then
    echo "Updating to Version 27..."
    version27Update
    HSHQ_VERSION=27
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 29 ]; then
    echo "Updating to Version 29..."
    version29Update
    HSHQ_VERSION=29
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 30 ]; then
    echo "Updating to Version 30..."
    version30Update
    HSHQ_VERSION=30
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 31 ]; then
    echo "Updating to Version 31..."
    version31Update
    HSHQ_VERSION=31
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 32 ]; then
    echo "Updating to Version 32..."
    version32Update
    HSHQ_VERSION=32
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 34 ]; then
    echo "Updating to Version 34..."
    version34Update
    HSHQ_VERSION=34
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 35 ]; then
    echo "Updating to Version 35..."
    version35Update
    HSHQ_VERSION=35
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 37 ]; then
    echo "Updating to Version 37..."
    version37Update
    HSHQ_VERSION=37
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 38 ]; then
    echo "Updating to Version 38..."
    version38Update
    HSHQ_VERSION=38
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 39 ]; then
    echo "Updating to Version 39..."
    version39Update
    HSHQ_VERSION=39
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 40 ]; then
    echo "Updating to Version 40..."
    version40Update
    HSHQ_VERSION=40
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 41 ]; then
    echo "Updating to Version 41..."
    version41Update
    HSHQ_VERSION=41
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 43 ]; then
    echo "Updating to Version 43..."
    version43Update
    HSHQ_VERSION=43
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 44 ]; then
    echo "Updating to Version 44..."
    version44Update
    HSHQ_VERSION=44
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 46 ]; then
    echo "Updating to Version 46..."
    version46Update
    if [ $HSHQ_VERSION -lt 46 ]; then
      return
    fi
  fi
  if [ $HSHQ_VERSION -lt 48 ]; then
    echo "Updating to Version 48..."
    version48Update
    HSHQ_VERSION=48
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 52 ]; then
    echo "Updating to Version 52..."
    version52Update
    HSHQ_VERSION=52
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 53 ]; then
    echo "Updating to Version 53..."
    version53Update
    HSHQ_VERSION=53
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 54 ]; then
    echo "Updating to Version 54..."
    version54Update
    HSHQ_VERSION=54
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 55 ]; then
    echo "Updating to Version 55..."
    version55Update
    HSHQ_VERSION=55
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 56 ]; then
    echo "Updating to Version 56..."
    version56Update
    HSHQ_VERSION=56
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 59 ]; then
    echo "Updating to Version 59..."
    version59Update
    HSHQ_VERSION=59
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 64 ]; then
    echo "Updating to Version 64..."
    version64Update
    HSHQ_VERSION=64
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 65 ]; then
    echo "Updating to Version 65..."
    version65Update
    HSHQ_VERSION=65
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 66 ]; then
    echo "Updating to Version 66..."
    version66Update
    HSHQ_VERSION=66
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 67 ]; then
    echo "Updating to Version 67..."
    version67Update
    HSHQ_VERSION=67
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 68 ]; then
    echo "Updating to Version 68..."
    version68Update
    HSHQ_VERSION=68
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 71 ]; then
    echo "Updating to Version 71..."
    version71Update
    HSHQ_VERSION=71
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 72 ]; then
    echo "Updating to Version 72..."
    version72Update
    HSHQ_VERSION=72
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 73 ]; then
    echo "Updating to Version 73..."
    version73Update
    HSHQ_VERSION=73
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 75 ]; then
    echo "Updating to Version 75..."
    version75Update
    HSHQ_VERSION=75
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 76 ]; then
    echo "Updating to Version 76..."
    version76Update
    HSHQ_VERSION=76
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 78 ]; then
    echo "Updating to Version 78..."
    version78Update
    HSHQ_VERSION=78
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 80 ]; then
    echo "Updating to Version 80..."
    version80Update
    HSHQ_VERSION=80
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 83 ]; then
    echo "Updating to Version 83..."
    version83Update
    HSHQ_VERSION=83
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 84 ]; then
    echo "Updating to Version 84..."
    version84Update
    HSHQ_VERSION=84
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 85 ]; then
    echo "Updating to Version 85..."
    version85Update
    HSHQ_VERSION=85
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 86 ]; then
    echo "Updating to Version 86..."
    version86Update
    HSHQ_VERSION=86
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 87 ]; then
    echo "Updating to Version 87..."
    version87Update
    HSHQ_VERSION=87
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 91 ]; then
    echo "Updating to Version 91..."
    version91Update
    HSHQ_VERSION=91
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 98 ]; then
    echo "Updating to Version 98..."
    version98Update
    HSHQ_VERSION=98
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 102 ]; then
    echo "Updating to Version 102..."
    version102Update
    HSHQ_VERSION=102
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 105 ]; then
    echo "Updating to Version 105..."
    version105Update
    HSHQ_VERSION=105
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 106 ]; then
    echo "Updating to Version 106..."
    version106Update
    HSHQ_VERSION=106
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 108 ]; then
    echo "Updating to Version 108..."
    version108Update
    HSHQ_VERSION=108
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 111 ]; then
    echo "Updating to Version 111..."
    version111Update
    HSHQ_VERSION=111
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 113 ]; then
    echo "Updating to Version 113..."
    version113Update
    HSHQ_VERSION=113
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 114 ]; then
    echo "Updating to Version 114..."
    version114Update
    HSHQ_VERSION=114
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 119 ]; then
    echo "Updating to Version 119..."
    version119Update
    HSHQ_VERSION=119
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 120 ]; then
    echo "Updating to Version 120..."
    version120Update
    HSHQ_VERSION=120
    updateConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 121 ]; then
    echo "Updating to Version 121..."
    version121Update
    HSHQ_VERSION=121
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 126 ]; then
    echo "Updating to Version 126..."
    version126Update
    HSHQ_VERSION=126
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 132 ]; then
    echo "Updating to Version 132..."
    version132Update
    HSHQ_VERSION=132
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 134 ]; then
    echo "Updating to Version 134..."
    version134Update
    HSHQ_VERSION=134
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 136 ]; then
    echo "Updating to Version 136..."
    version136Update
    HSHQ_VERSION=136
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 138 ]; then
    echo "Updating to Version 138..."
    version138Update
    HSHQ_VERSION=138
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 146 ]; then
    echo "Updating to Version 146..."
    version146Update
    HSHQ_VERSION=146
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 152 ]; then
    echo "Updating to Version 152..."
    version152Update
    HSHQ_VERSION=152
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 164 ]; then
    echo "Updating to Version 164..."
    version164Update
    HSHQ_VERSION=164
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 165 ]; then
    echo "Updating to Version 165..."
    version165Update
    HSHQ_VERSION=165
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt 171 ]; then
    echo "Updating to Version 171..."
    version171Update
    HSHQ_VERSION=171
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ $HSHQ_VERSION -lt $HSHQ_LIB_SCRIPT_VERSION ]; then
    echo "Updating to Version $HSHQ_LIB_SCRIPT_VERSION..."
    HSHQ_VERSION=$HSHQ_LIB_SCRIPT_VERSION
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  fi
  if [ "$is_update_performed" = "true" ]; then
    set +e
    outputStackListsScriptServer
    outputAllScriptServerScripts true false
    resumeCronService
    set -e
  fi
}

function performPreUpdateCheck()
{
  # This function is more of a placeholder at the moment,
  # reserved for future possible use. We already have sudo
  # and decrypted config file, so just return.
  return
}

function promptTestRelayServerPassword()
{
  set +e
  while [ -z "$USER_RELAY_SUDO_PW" ]
  do
    if [ "$IS_CONSOLE_ENV" = "true" ]; then
      USER_RELAY_SUDO_PW=$(promptPasswordMenu "Enter Relay Password" "Enter the RelayServer sudo password for $RELAYSERVER_REMOTE_USERNAME: ")
      retVal=$?
      if [ $retVal -ne 0 ]; then
        exit 3
      fi
      testRelayServerPassword
      if [ $? -ne 0 ]; then
        showMessageBox "Incorrect Password" "The password is incorrect, please re-enter it."
        USER_RELAY_SUDO_PW=""
      fi
    else
      echo -e "\n\n"
      read -r -s -p "Enter the RelayServer sudo password for $RELAYSERVER_REMOTE_USERNAME: " USER_RELAY_SUDO_PW
      echo
      testRelayServerPassword
      if [ $? -ne 0 ]; then
        echo "The password is incorrect, please re-enter it."
        USER_RELAY_SUDO_PW=""
      fi
    fi
  done
}

function testRelayServerPassword()
{
  set +e
  loadSSHKey
  set +e
  ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo -S -v" <<< "$USER_RELAY_SUDO_PW" > /dev/null 2>&1
  retVal=$?
  set +e
  unloadSSHKey
  set +e
  return $retVal
}

function version14Update()
{
  v14_curE=${-//[^e]/}
  set +e
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  fixlist=($(cat $CONFIG_FILE | grep "^#" | grep -v "# Configuration File" | grep -v "END" | grep -v "BEGIN"))
  for curitem in "${fixlist[@]}"
  do
    sed -i "s|$curitem|$curitem BEGIN|g" $CONFIG_FILE
    sed -i "s|$curitem BEGIN END|$curitem END|g" $CONFIG_FILE
  done
  IFS=$OLDIFS
  set +e
  if ! [ -z "$v14_curE" ]; then
    set -e
  fi
  addToDisabledServices netdata
}

function version22Update()
{
  updateMOTD
  set -e
  showMessageBox "Version 22 Update" "A large update needs to be applied to your system. Please be patient as it will take around 10 minutes to complete. All running stacks will be stopped and then restarted. Press okay to continue."
  refreshSudo
  set +e
  cdns_stack_name="user1"
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  uptimekumaStackID=$(getStackID uptimekuma "$portainerToken")
  startStopStack uptimekuma stop $portainerToken > /dev/null 2>&1
  grep "HOMESERVER_HOST_ISPRIVATE_IP" $CONFIG_FILE > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    HOMESERVER_HOST_ISPRIVATE_IP=$(checkIsIPPrivate "$HOMESERVER_HOST_IP")
    sed -i "s|^HOMESERVER_HOST_IP=.*|HOMESERVER_HOST_IP=$HOMESERVER_HOST_IP\nHOMESERVER_HOST_ISPRIVATE_IP=$HOMESERVER_HOST_ISPRIVATE_IP|g" $CONFIG_FILE
  fi
  grep "HOMESERVER_HOST_RANGE" $CONFIG_FILE > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    if [ "$HOMESERVER_HOST_ISPRIVATE_IP" = "true" ]; then
      HOMESERVER_HOST_RANGE=$(ip route | grep $(getDefaultIface) | grep / | awk '{print $1}' | head -1)
    else
      HOMESERVER_HOST_RANGE="${HOMESERVER_HOST_IP}/32"
    fi
    sed -i "s|^HOMESERVER_HOST_ISPRIVATE_IP=.*|HOMESERVER_HOST_ISPRIVATE_IP=$HOMESERVER_HOST_ISPRIVATE_IP\nHOMESERVER_HOST_RANGE=$HOMESERVER_HOST_RANGE|g" $CONFIG_FILE
  fi
  set -e

  mailuStackID=$(getStackID mailu "$portainerToken")
  cdnsStackID=$(getStackID clientdns-${cdns_stack_name} "$portainerToken")

  rstackIDs=($(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1 | jq -r '.[] | select(.Status == 1) | .Id'))
  rstackNames=($(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1 | jq -r '.[] | select(.Status == 1) | .Name'))
  numItems=$((${#rstackIDs[@]}-1))

  for curID in $(seq 0 $numItems);
  do
    echo "Stopping ${rstackNames[$curID]} (${rstackIDs[$curID]})..."
    startStopStackByID ${rstackIDs[$curID]} stop $portainerToken
    sleep 1
  done

  stopPortainer
  set +e
  removeDockerNetworks
  docker network rm cdns-${cdns_stack_name} > /dev/null 2>&1

  set +e
  grep DOCKER_METRICS_PORT $CONFIG_FILE >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    DOCKER_METRICS_PORT=8323
    replace_block="DOCKER_METRICS_PORT=8323\n# Docker Installation Info END"
    sed -i "s|# Docker Installation Info END|$replace_block|g" $CONFIG_FILE
    outputDockerSettings
  fi
  set -e

  echo "Restarting Docker..."
  sudo systemctl restart docker
  sleep 3
  createDockerNetworks
  outputConfigPortainer
  startPortainer
  set +e
  total_tries=10
  num_tries=1
  sleep 5
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  retVal=$?
  while [ $retVal -ne 0 ] && [ $num_tries -lt $total_tries ]
  do
    echo "Error getting portainer token, retrying ($(($num_tries + 1)) of $total_tries)..."
    sleep 5
    ((num_tries++))
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
    retVal=$?
  done
  if [ $retVal -ne 0 ]; then
    echo "Error getting portainer token, exiting..."
    exit 1
  fi

  if ! [ -z "$cdnsStackID" ]; then
    docker network create --driver=bridge tmpnet > /dev/null 2>&1
    clientdns_subnet=$(getDockerSubnet tmpnet)
    clientdns_subnet_prefix=$(echo $clientdns_subnet | rev | cut -d "." -f2- | rev)
    docker network rm tmpnet >/dev/null
    docker network create -o com.docker.network.bridge.name=brcd-${cdns_stack_name} --driver=bridge --subnet $clientdns_subnet cdns-${cdns_stack_name} > /dev/null 2>&1
  fi

  # Replace Mailu stack
  is_antivirus_commented_out=""
  if [ "$(isServiceDisabled clamav)" = "true" ]; then
    is_antivirus_commented_out="#"
  fi
  set -e
  cat <<EOFMC > $HOME/mailu-compose.yml

services:
  front:
    image: $IMG_MAILU_FRONT
    container_name: $SMTP_HOSTNAME
    hostname: $SMTP_HOSTNAME
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: journald
      options:
        tag: $SMTP_HOSTNAME
    networks:
      - dock-mailu-ext-net
      - dock-internalmail-net
      - dock-proxy-net
    ports:
      - "$MAILU_PORT_1:$MAILU_PORT_1"
      - "$MAILU_PORT_2:$MAILU_PORT_2"
      - "$MAILU_PORT_3:$MAILU_PORT_3"
      - "$MAILU_PORT_4:$MAILU_PORT_4"
      - "$MAILU_PORT_5:$MAILU_PORT_5"
      - "$MAILU_PORT_6:$MAILU_PORT_6"
      - "$MAILU_PORT_7:$MAILU_PORT_7"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/nginx:/overrides:ro

  resolver:
    image: $IMG_MAILU_UNBOUND
    container_name: mailu-unbound
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-mailu-ext-net:
        ipv4_address: \${SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  redis:
    image: $IMG_REDIS
    container_name: mailu-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mailu-redis:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

  admin:
    image: $IMG_MAILU_ADMIN
    container_name: mailu-admin
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: journald
      options:
        tag: mailu-admin
    networks:
      - dock-mailu-ext-net
    depends_on:
      - redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/data:/data
      - \${HSHQ_STACKS_DIR}/mailu/dkim:/dkim

  imap:
    image: $IMG_MAILU_IMAP
    container_name: mailu-imap
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: journald
      options:
        tag: mailu-imap
    networks:
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mail:/mail
      - \${HSHQ_STACKS_DIR}/mailu/overrides/dovecot:/overrides:ro

  smtp:
    image: $IMG_MAILU_SMTP
    container_name: mailu-smtp
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: journald
      options:
        tag: mailu-smtp
    networks:
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mailqueue:/queue
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/postfix:/overrides:ro

  oletools:
    image: $IMG_MAILU_OLETOOLS
    container_name: mailu-oletools
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  antispam:
    image: $IMG_MAILU_ANTISPAM
    container_name: mailu-antispam
    hostname: antispam
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: journald
      options:
        tag: mailu-antispam
    networks:
      - dock-mailu-ext-net
      - dock-mailu-int-net
      - dock-proxy-net
    dns:
      - \${SUBNET_PREFIX}.253
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/filter:/var/lib/rspamd
      - \${HSHQ_STACKS_DIR}/mailu/overrides/rspamd:/etc/rspamd/override.d

$is_antivirus_commented_out  antivirus:
$is_antivirus_commented_out    image: $IMG_MAILU_ANTIVIRUS
$is_antivirus_commented_out    container_name: mailu-antivirus
$is_antivirus_commented_out    restart: unless-stopped
$is_antivirus_commented_out    env_file: stack.env
$is_antivirus_commented_out    security_opt:
$is_antivirus_commented_out      - no-new-privileges:true
$is_antivirus_commented_out    networks:
$is_antivirus_commented_out      - dock-mailu-ext-net
$is_antivirus_commented_out      - dock-proxy-net
$is_antivirus_commented_out    volumes:
$is_antivirus_commented_out      - /etc/localtime:/etc/localtime:ro
$is_antivirus_commented_out      - /etc/timezone:/etc/timezone:ro
$is_antivirus_commented_out      - \${HSHQ_STACKS_DIR}/mailu/filter:/data

  webdav:
    image: $IMG_MAILU_WEBDAV
    container_name: mailu-webdav
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/dav:/data

  fetchmail:
    image: $IMG_MAILU_FETCHMAIL
    container_name: mailu-fetchmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/data/fetchmail:/data

  webmail:
    image: $IMG_MAILU_WEBMAIL
    container_name: mailu-webmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - imap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/webmail:/data
      - \${HSHQ_STACKS_DIR}/mailu/overrides/roundcube:/overrides:ro

volumes:
  v-mailu-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/mailu/redis

networks:
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-mailu-int-net:
    name: dock-mailu-int
    external: true
  dock-mailu-ext-net:
    name: dock-mailu-ext
    external: true
EOFMC
  sudo cp $HSHQ_STACKS_DIR/portainer/compose/$mailuStackID/stack.env $HOME/mailu.env
  sudo chown $USERNAME:$USERNAME $HOME/mailu.env
  updateGlobalVarsEnvFile $HOME/mailu.env
  sed -i "s|^SUBNET=.*|SUBNET=${NET_MAILU_EXT_SUBNET}|g" $HOME/mailu.env
  sed -i "s|^SUBNET_PREFIX=.*|SUBNET_PREFIX=${NET_MAILU_EXT_SUBNET_PREFIX}|g" $HOME/mailu.env
  echo "{$( jq -Rscjr '{StackFileContent: . }' $HOME/mailu-compose.yml | tail -c +2 | head -c -1 ),\"Env\":$(envToJson $HOME/mailu.env)}" > $HOME/mailu-json.tmp
  http --check-status --ignore-stdin --verify=no --timeout=300 PUT https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$mailuStackID "Authorization: Bearer $portainerToken" endpointId==1 @$HOME/mailu-json.tmp > /dev/null 2>&1
  rm $HOME/mailu-compose.yml $HOME/mailu.env $HOME/mailu-json.tmp

  if ! [ -z "$cdnsStackID" ]; then
    # Replace ClientDNS stack
    cat <<EOFGL > $HOME/clientdns-${cdns_stack_name}-compose.yml

services:
  clientdns-${cdns_stack_name}-dnsmasq:
    image: $IMG_DNSMASQ
    container_name: clientdns-${cdns_stack_name}-dnsmasq
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-ext-net:
      dock-proxy-net:
      cdns-${cdns_stack_name}-net:
        ipv4_address: \${CLIENTDNS_SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/dnsmasq.conf:/etc/dnsmasq.conf
    environment:
      - HTTP_USER=$CLIENTDNS_USER1_ADMIN_USERNAME
      - HTTP_PASS=$CLIENTDNS_USER1_ADMIN_PASSWORD

  clientdns-${cdns_stack_name}-wireguard:
    image: $IMG_WIREGUARD
    container_name: clientdns-${cdns_stack_name}-wireguard
    hostname: clientdns-${cdns_stack_name}-wireguard
    restart: unless-stopped
    env_file: stack.env
    cap_add:
      - NET_ADMIN
    networks:
      - dock-ext-net
      - cdns-${cdns_stack_name}-net
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/Corefile:/config/coredns/Corefile:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/clientdns-${cdns_stack_name}.conf:/config/wg0.conf

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  cdns-${cdns_stack_name}-net:
    name: cdns-${cdns_stack_name}
    external: true

EOFGL

    rm -f $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}/Corefile
    cat <<EOFCF > $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}/Corefile
. {
    loop
    reload 15s
    forward . ${clientdns_subnet_prefix}.253
}
EOFCF

    sudo cp $HSHQ_STACKS_DIR/portainer/compose/$cdnsStackID/stack.env $HOME/clientdns-${cdns_stack_name}.env
    sudo chown $USERNAME:$USERNAME $HOME/clientdns-${cdns_stack_name}.env
    updateGlobalVarsEnvFile $HOME/clientdns-${cdns_stack_name}.env
    sed -i "s|^CLIENTDNS_SUBNET_PREFIX=.*|CLIENTDNS_SUBNET_PREFIX=${clientdns_subnet_prefix}|g" $HOME/clientdns-${cdns_stack_name}.env
    echo "{$( jq -Rscjr '{StackFileContent: . }' $HOME/clientdns-${cdns_stack_name}-compose.yml | tail -c +2 | head -c -1 ),\"Env\":$(envToJson $HOME/clientdns-${cdns_stack_name}.env)}" > $HOME/clientdns-${cdns_stack_name}-json.tmp
    http --check-status --ignore-stdin --verify=no --timeout=300 PUT https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/$cdnsStackID "Authorization: Bearer $portainerToken" endpointId==1 @$HOME/clientdns-${cdns_stack_name}-json.tmp > /dev/null 2>&1
    rm $HOME/clientdns-${cdns_stack_name}-compose.yml $HOME/clientdns-${cdns_stack_name}.env $HOME/clientdns-${cdns_stack_name}-json.tmp
  fi

  rstackIDs[$(($numItems+1))]=$uptimekumaStackID
  rstackNames[$(($numItems+1))]=uptimekuma
  numItems=$((${#rstackIDs[@]}-1))
  
  for curID in $(seq 0 $numItems);
  do
    case ${rstackNames[$curID]} in
      mailu|clientdns-${cdns_stack_name})
        continue
      ;;
      *)
        echo "Starting ${rstackNames[$curID]} (${rstackIDs[$curID]})..."
        if sudo test -f $HSHQ_STACKS_DIR/portainer/compose/${rstackIDs[$curID]}/stack.env; then
          sudo cp $HSHQ_STACKS_DIR/portainer/compose/${rstackIDs[$curID]}/stack.env $HOME/${rstackIDs[$curID]}.env
          sudo chown $USERNAME:$USERNAME $HOME/${rstackIDs[$curID]}.env
          updateGlobalVarsEnvFile $HOME/${rstackIDs[$curID]}.env
        fi
        sudo cp $HSHQ_STACKS_DIR/portainer/compose/${rstackIDs[$curID]}/docker-compose.yml $HOME/${rstackIDs[$curID]}.yml
        sudo chown $USERNAME:$USERNAME $HOME/${rstackIDs[$curID]}.yml
      ;;
    esac

    case ${rstackNames[$curID]} in
      caddy-home)
        sed -i "s|$HOMESERVER_HOST_IP|\${HOMESERVER_HOST_IP}|g" $HOME/${rstackIDs[$curID]}.yml
        sed -i "s|^CADDY_HSHQ_PRIVATE_IPS=.*|CADDY_HSHQ_PRIVATE_IPS=\${HOMESERVER_HOST_RANGE} $(getPrivateIPRangesCaddy)|g" $HOME/${rstackIDs[$curID]}.env
      ;;
      jitsi)
        sed -i "s|^DOCKER_HOST_ADDRESS=.*|DOCKER_HOST_ADDRESS=\${HOMESERVER_HOST_IP}|g" $HOME/${rstackIDs[$curID]}.env
        JITSI_ADVERTISE_IPS=$(echo $JITSI_ADVERTISE_IPS | sed "s|$HOMESERVER_HOST_IP||g")
        updateConfigVar JITSI_ADVERTISE_IPS $JITSI_ADVERTISE_IPS
        sed -i "s|^JVB_ADVERTISE_IPS=.*|JVB_ADVERTISE_IPS=\${HOMESERVER_HOST_IP}$JITSI_ADVERTISE_IPS|g" $HOME/${rstackIDs[$curID]}.env
        sed -i '/^CONFIG=/d' $HOME/${rstackIDs[$curID]}.env
      ;;
    esac

    if ! [ -f $HOME/${rstackIDs[$curID]}.env ] || ! [ -s $HOME/${rstackIDs[$curID]}.env ]; then
      echo "TZ=\${TZ}" > $HOME/${rstackIDs[$curID]}.env
    fi
    echo "{$( jq -Rscjr '{StackFileContent: . }' $HOME/${rstackIDs[$curID]}.yml | tail -c +2 | head -c -1 ),\"Env\":$(envToJson $HOME/${rstackIDs[$curID]}.env)}" > $HOME/${rstackIDs[$curID]}-json.tmp
    num_tries=1
    while [ $num_tries -lt $total_tries ]
    do
      http --check-status --ignore-stdin --verify=no --timeout=300 PUT https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/${rstackIDs[$curID]} "Authorization: Bearer $portainerToken" endpointId==1 @$HOME/${rstackIDs[$curID]}-json.tmp > /dev/null
      if [ $? -eq 0 ]; then
        break
      else
        echo "Failed update, retrying ($(($num_tries + 1)) of $total_tries)..."
        sleep 5
        portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
      fi
      ((num_tries++))
    done
    rm -f $HOME/${rstackIDs[$curID]}.yml $HOME/${rstackIDs[$curID]}.env $HOME/${rstackIDs[$curID]}-json.tmp
    sleep 5
  done
  docker container restart ofelia
  set -e
}

function version23Update()
{
  outputBootScripts
  deleteFromRootCron "restartHomeAssistantStack.sh"
  appendToRoonCron "@reboot bash $HSHQ_SCRIPTS_DIR/root/restartHomeAssistantStack.sh >/dev/null 2>&1"
  updateSysctl true
}

function version24Update()
{
  initServicesCredentials
}

function version25Update()
{
  sudo systemctl stop systemd-resolved > /dev/null 2>&1
  sudo systemctl disable systemd-resolved > /dev/null 2>&1
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  sudo tee /etc/resolv.conf >/dev/null <<EOFR
nameserver 127.0.0.1
EOFR
  sudo tee /etc/systemd/resolved.conf >/dev/null <<EOFR
[Resolve]
#DNS=127.0.0.1
#FallbackDNS=
#Domains=
#LLMNR=no
#MulticastDNS=no
#DNSSEC=no
#DNSOverTLS=no
#Cache=no-negative
#DNSStubListener=no
#ReadEtcHosts=yes
EOFR

}

function version26Update()
{
  outputPerformPostDockerBootActionsScript
  deleteFromRootCron "restartHomeAssistantStack.sh"
  appendToRoonCron "@reboot bash $HSHQ_SCRIPTS_DIR/root/restartHomeAssistantStack.sh"
}

function version27Update()
{
  cat <<EOFRO > $HOME/custom.inc.php
<?php
\$config['show_images'] = 3;
\$config['timezone'] = '$TZ';
?>
EOFRO
  sudo chown root:root $HOME/custom.inc.php
  sudo mv $HOME/custom.inc.php $HSHQ_STACKS_DIR/mailu/overrides/roundcube/custom.inc.php
  docker container restart mailu-webmail
}

function version29Update()
{
  # This should have been addressed in the version 23 update,
  # but the metrics port was not correctly added to the config.
  # Add Docker metrics port to config
  set +e
  grep DOCKER_METRICS_PORT $CONFIG_FILE >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    DOCKER_METRICS_PORT=8323
    replace_block="DOCKER_METRICS_PORT=8323\n# Docker Installation Info END"
    sed -i "s|# Docker Installation Info END|$replace_block|g" $CONFIG_FILE
    outputDockerSettings
  fi
  set -e
  
  outputBootScripts
  setVersionOnStacks

  echo -e "\n\n========================================"
  echo -e "        Stack Versioning Results"
  echo -e "========================================"
  if [ -z "$strSetVersionReport" ]; then
    echo -e "All stacks were correctly versioned."
  else
    echo -e "$strSetVersionReport"
    echo -e "\n========================================"
    echo -e "\nCheck your email($EMAIL_ADMIN_EMAIL_ADDRESS) for a copy of these results."
    sendEmail -s "Stack Versioning Report" -b "$strSetVersionReport" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -t $EMAIL_ADMIN_EMAIL_ADDRESS
  fi
}

function version30Update()
{
  # Sidekiq should be mounted on same volume. Bitnami configured it incorrectly. (https://github.com/bitnami/containers/blob/main/bitnami/discourse/docker-compose.yml)
  discourseStackID=$(getStackID discourse)
  if ! [ -z "$discourseStackID" ]; then
    sudo sed -i "s|v-sidekiq-data:\/bitnami\/discourse|v-discourse-data:\/bitnami\/discourse|" $HSHQ_STACKS_DIR/portainer/compose/$discourseStackID/docker-compose.yml
  fi
}

function version31Update()
{
  addToDisabledServices jupyter
}

function version32Update()
{
  addToDisabledServices paperless
}

function version34Update()
{
  sudo sed -i "/timestamp_timeout/a Defaults passwd_tries=$SUDO_MAX_RETRIES" /etc/sudoers
  addToDisabledServices speedtest-tracker-local
  addToDisabledServices speedtest-tracker-vpn
}

function version35Update()
{
  updateMOTD
}

function version37Update()
{
  sed -i "s|Relay Server|RelayServer|g" $CONFIG_FILE
  CHANGEDETECTION_INIT_ENV=false
  SCRIPTSERVER_INIT_ENV=false
  SCRIPTSERVER_LOCALHOST_PORT=8008
  sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
  echo "Installing python, please wait..."
  performAptInstall python3 > /dev/null 2>&1
  echo "Installing python-pip, please wait..."
  performAptInstall python3-pip > /dev/null 2>&1
  echo "Installing unzip, please wait..."
  performAptInstall unzip > /dev/null 2>&1
  getUpdateAssets
  set +e
  outputBootScripts
  grep $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN $HSHQ_STACKS_DIR/authelia/config/configuration.yml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sed -i "/$SUB_ADGUARD.$HOMESERVER_DOMAIN/a\        - $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN" $HSHQ_STACKS_DIR/authelia/config/configuration.yml
    docker container restart authelia > /dev/null 2>&1
  fi
  if ! [ -d $HSHQ_STACKS_DIR/script-server ]; then
    installStackByName script-server
  fi
  mkdir -p $HSHQ_WIREGUARD_DIR/requestkeys
  checkFixPortainerEnv
}

function version38Update()
{
  refreshSudo
  sudo sqlite3 $HSHQ_DB "create table if not exists exposedomains(Domain text primary key,BaseDomain text not null);"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    sendRSExposeScripts
  fi

  # Fixes internal mailing issue
  startStopStack mailu stop
  cat <<EOFRS > $HOME/mailu-groups.conf
symbols {
  "R_DKIM_ALLOW" {
    weight = -22.0;
  }
}
EOFRS
  chmod 664 $HOME/mailu-groups.conf
  sudo chown 101:101 $HOME/mailu-groups.conf
  sudo mv $HOME/mailu-groups.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/groups.conf
  # Also need to add host IP to Postfix and RSpamd (this should have been done in v27)
  set +e
  sudo grep "$HOMESERVER_HOST_IP" $HSHQ_STACKS_DIR/mailu/overrides/postfix/postfix.cf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo sed -i "/^mynetworks/ s/$/ ${HOMESERVER_HOST_IP}\/32/" $HSHQ_STACKS_DIR/mailu/overrides/postfix/postfix.cf
  fi
  sudo grep "$HOMESERVER_HOST_IP" $HSHQ_STACKS_DIR/mailu/overrides/rspamd/ip_whitelist.map > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "${HOMESERVER_HOST_IP}/32" | sudo tee -a $HSHQ_STACKS_DIR/mailu/overrides/rspamd/ip_whitelist.map > /dev/null 2>&1
  fi
  sleep 3
  startStopStack mailu start
  sleep 5
  set -e
  HUGINN_INIT_ENV=false
}

function version39Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
  sudo sqlite3 $HSHQ_DB "create table newconnections(ID integer not null primary key autoincrement,Name text,EmailAddress text,ConnectionType text,NetworkType text,PublicKey text,PresharedKey text,IPAddress text,IsInternet boolean,InterfaceName text,EndpointHostname text,EndpointIP text default null,LastUpdated datetime);"
  sudo sqlite3 $HSHQ_DB "insert into newconnections(ID,Name,EmailAddress,ConnectionType,NetworkType,PublicKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,EndpointIP,LastUpdated) select ID,Name,EmailAddress,ConnectionType,NetworkType,PublicKey,IPAddress,IsInternet,InterfaceName,EndpointHostname,EndpointIP,LastUpdated from connections;"
  sudo sqlite3 $HSHQ_DB "drop table connections;"
  sudo sqlite3 $HSHQ_DB "ALTER TABLE newconnections RENAME TO connections;"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    sendRSExposeScripts
    loadSSHKey
    keylist=($(ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sqlite3 $RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/wg_portal.db \"select public_key,preshared_key from peers;\""
    unloadSSHKey))
    for curKeys in "${keylist[@]}"
    do
      pub_key=$(echo "$curKeys" | cut -d "|" -f1)
      pre_key=$(echo "$curKeys" | cut -d "|" -f2)
      sudo sqlite3 $HSHQ_DB "update connections set PresharedKey='$pre_key' where PublicKey='$pub_key';"
    done
    sudo sqlite3 $HSHQ_DB "update connections set PresharedKey='$RELAYSERVER_WG_SV_PRESHAREDKEY' where Name='WireGuardServer';"
  fi
  hs_vpn=($(sqlite3 $HSHQ_DB "select ID,InterfaceName from connections where NetworkType='other' and ConnectionType='homeserver_vpn';"))
  for curVPN in "${hs_vpn[@]}"
  do
    cur_id=$(echo "$curVPN" | cut -d "|" -f1)
    cur_iface=$(echo "$curVPN" | cut -d "|" -f2)
    pre_key=$(sudo grep "^PresharedKey" $HSHQ_WIREGUARD_DIR/vpn/${cur_iface}.conf | cut -d " " -f3)
    sudo sqlite3 $HSHQ_DB "update connections set PresharedKey='$pre_key' where ID='$cur_id';"
  done
  hs_int=($(sqlite3 $HSHQ_DB "select ID,InterfaceName from connections where NetworkType='other' and ConnectionType='homeserver_internet';"))
  for curInt in "${hs_int[@]}"
  do
    cur_id=$(echo "$curInt" | cut -d "|" -f1)
    cur_iface=$(echo "$curInt" | cut -d "|" -f2)
    pre_key=$(sudo grep "^PresharedKey" $HSHQ_WIREGUARD_DIR/internet/${cur_iface}.conf | cut -d " " -f3)
    sudo sqlite3 $HSHQ_DB "update connections set PresharedKey='$pre_key' where ID='$cur_id';"
  done
  sudo sqlite3 $HSHQ_DB "update connections set IsInternet=true where IsInternet='true';"
  sudo sqlite3 $HSHQ_DB "update connections set IsInternet=false where IsInternet='false';"
  sudo chmod 640 $HSHQ_DB
  sudo chown root $HSHQ_DB
}

function version40Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
}

function version41Update()
{
  set +e
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nThis update will also reboot the RelayServer.\nYou will be prompted for you sudo password on the RelayServer.\n"
    read -r -p "Press enter to continue."
    loadSSHKey
    set +e
    rs_default_iface=$(ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "ip route | grep -e \"^default\"" | awk -F'dev ' '{print $2}' | xargs | cut -d" " -f1)

    tee $HOME/wgupdown.sh >/dev/null <<EOFPU
#!/bin/bash
COMMAND=\$1
RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR
set +e

default_iface=$rs_default_iface

function main()
{
  shift
  shift
  case "\$COMMAND" in
    up) up ;;
    down) down ;;
  esac
}

function up()
{
  ipset create inetusers hash:net
  iplist=\$(cat \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset)
  for curip in \$iplist
  do
    if [ -z \$curip ]; then continue; fi
    ipset add inetusers \$curip
  done
  ipset create alldevices hash:net
  alliplist=(\$(sqlite3 \$RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/wg_portal.db "select ips_str from peers;"))
  for cur_ip in "\${alliplist[@]}"
  do
    if [ -z \$cur_ip ]; then continue; fi
    ipset add alldevices \$cur_ip
  done
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j ACCEPT
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -A POSTROUTING -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j MASQUERADE
  iptables -A FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o \$default_iface -m set --match-set inetusers src -j ACCEPT
  iptables -A FORWARD -i \$default_iface -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -A POSTROUTING -o \$default_iface -m set --match-set inetusers src -j MASQUERADE
}

function down()
{
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j ACCEPT
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -D POSTROUTING -o $RELAYSERVER_WG_INTERFACE_NAME -d $PRIMARY_VPN_SUBNET -m set --match-set alldevices src -j MASQUERADE
  iptables -D FORWARD -i $RELAYSERVER_WG_INTERFACE_NAME -o \$default_iface -m set --match-set inetusers src -j ACCEPT
  iptables -D FORWARD -i \$default_iface -o $RELAYSERVER_WG_INTERFACE_NAME -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -t nat -D POSTROUTING -o \$default_iface -m set --match-set inetusers -j MASQUERADE
  ipset destroy inetusers
  ipset destroy alldevices
}

main "\$@"
EOFPU

    tee $HOME/addPeer.sh >/dev/null <<EOFWA
#!/bin/bash

name=\$1
email=\$2
publicKey=\$3
presharedKey=\$4
ipAddress=\$5
isInet=\$6
isInVPNSubnet=\$7
auth=\$8

uuid=\$(uuidgen | sed 's|-||g')
jsonbody="{\"UID\": \"\$uuid\", \"DeviceName\": \"$RELAYSERVER_WG_INTERFACE_NAME\", \"DeviceType\": \"client\", \"Identifier\": \"\$name\", \"Email\": \"\$email\", \"IgnoreGlobalSettings\": true, \"PublicKey\": \"\$publicKey\", \"PresharedKey\": \"\$presharedKey\", \"Endpoint\": \"$RELAYSERVER_SUB_WG.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_WG_PORT\", \"PersistentKeepalive\": 0, \"IPsStr\": \"\${ipAddress}/32\", \"Mtu\": $RELAYSERVER_CLIENT_DEFAULT_MTU}"
curl -s -X 'POST' 'http://127.0.0.1:$RELAYSERVER_WG_PORTAL_PORT/api/v1/backend/peers?DeviceName=$RELAYSERVER_WG_INTERFACE_NAME' -H 'accept: application/json' -H "Authorization: Basic \$auth" -H 'Content-Type: application/json' -d "\$jsonbody" >/dev/null
if [ \$? -ne 0 ]; then
  echo "There was a problem adding this client..."
  exit 1
fi

ipset add alldevices \${ipAddress}/32

if ! [ "\$isInVPNSubnet" = "true" ]; then
  route add \${ipAddress}/32 $RELAYSERVER_WG_INTERFACE_NAME
fi

if [ "\$isInet" = "true" ]; then
  ipset add inetusers \${ipAddress}/32
  echo \${ipAddress}/32 | tee -a $RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset >/dev/null
fi


EOFWA

    tee $HOME/removePeer.sh >/dev/null <<EOFWA
#!/bin/bash
set +e
publicKey=\$1
ipAddress=\$2
isInet=\$3
isInVPNSubnet=\$4
auth=\$5

function main()
{
  curl -s -X 'DELETE' "http://127.0.0.1:$RELAYSERVER_WG_PORTAL_PORT/api/v1/backend/peer?PublicKey=\$(urlEncode \$publicKey)" -H 'accept: application/json' -H "Authorization: Basic \$auth" -H 'Content-Type: application/json' >/dev/null
  if [ \$? -ne 0 ]; then
    echo "There was a problem removing this client..."
  fi
  ipset del alldevices \${ipAddress}/32
  if ! [ "\$isInVPNSubnet" = "true" ]; then
    route del \${ipAddress}/32 $RELAYSERVER_WG_INTERFACE_NAME
  fi
  if [ "\$isInet" = "true" ]; then
    ipset del inetusers \${ipAddress}/32
    sed -i '/\${ipAddress}/d' $RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/inetusers.ipset
  fi
}

function urlEncode()
{
  strLength="\${#1}"
  for (( i = 0; i < strLength; i++ )); do
    c="\${1:i:1}"
    case \$c in
      [a-zA-Z0-9.~_-]) printf "\$c" ;;
      *) printf '%%%02X' "'\$c" ;;
    esac
  done
}

function urlDecode()
{
  url_encoded="\${1//+/ }"
  printf '%b' "\${url_encoded//%/\\x}"
}

main "\$@"
EOFWA

    tee $HOME/v41.sh >/dev/null <<EOFWA
#!/bin/bash

chmod 500 $RELAYSERVER_HSHQ_SCRIPTS_DIR/wgupdown.sh
chmod 500 $RELAYSERVER_HSHQ_SCRIPTS_DIR/addPeer.sh
chmod 500 $RELAYSERVER_HSHQ_SCRIPTS_DIR/removePeer.sh
chown root:root $RELAYSERVER_HSHQ_SCRIPTS_DIR/wgupdown.sh
chown root:root $RELAYSERVER_HSHQ_SCRIPTS_DIR/addPeer.sh
chown root:root $RELAYSERVER_HSHQ_SCRIPTS_DIR/removePeer.sh
mv $RELAYSERVER_HSHQ_SCRIPTS_DIR/wgupdown.sh $RELAYSERVER_HSHQ_STACKS_DIR/wireguard/server/wgupdown.sh
mv $RELAYSERVER_HSHQ_SCRIPTS_DIR/addPeer.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/addPeer.sh
mv $RELAYSERVER_HSHQ_SCRIPTS_DIR/removePeer.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/removePeer.sh
rm -f \$0
reboot
EOFWA

    scp -P $RELAYSERVER_SSH_PORT $HOME/wgupdown.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/addPeer.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/removePeer.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/v41.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo bash $RELAYSERVER_HSHQ_SCRIPTS_DIR/v41.sh"
    unloadSSHKey
    rm -f $HOME/wgupdown.sh
    rm -f $HOME/addPeer.sh
    rm -f $HOME/removePeer.sh
    rm -f $HOME/v41.sh
  fi
  set -e
  outputBootScripts
  fixAutheliaConfig
}

function version43Update()
{
  installHostNTPServer
}

function version44Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
}

function version46Update()
{
  if [ -d $HSHQ_STACKS_DIR/script-server ]; then
    if [ -d $HSHQ_STACKS_DIR/hshqmanager ]; then
      set +e
      sudo rm -f /etc/systemd/system/runHSHQManager.service
      sudo rm -f $HSHQ_SCRIPTS_DIR/root/runHSHQManager.service
      rm -f $HSHQ_SSL_DIR/hshqmanager*
      sudo rm -fr $HSHQ_STACKS_DIR/hshqmanager
    fi
    HSHQ_VERSION=46
    updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  else
    echo -e "\n\n\n++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
    echo -e "This is a 2-part update, as it is renaming HSHQ Manager to Script-server."
    echo -e "If you are using HSHQ Manager to perform this update, then you will lose connection"
    echo -e "as a result. Monitor your $EMAIL_ADMIN_EMAIL_ADDRESS account for the new credentials."
    echo -e "As soon as you recieve this email, then log into https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN"
    echo -e "with the new creditials and re-run the Perform Update HSHQ function."
    echo -e "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++\n"
    notifyRSLogin
    set -e
    getUpdateAssets
    set +e
    sed -i "/SVCD_HSHQMANAGER/d" $CONFIG_FILE
    sed -i "s/HSHQMANAGER/SCRIPTSERVER/g" $CONFIG_FILE
    sed -i "s/HSHQ Manager/Script-server/g" $CONFIG_FILE
    source $CONFIG_FILE
    SCRIPTSERVER_INIT_ENV=false
    SCRIPTSERVER_ADMIN_USERNAME=""
    updateConfigVar SCRIPTSERVER_ADMIN_USERNAME $SCRIPTSERVER_ADMIN_USERNAME
    sed -i "s/hshqmanager/script-server/g" $HSHQ_STACKS_DIR/authelia/config/configuration.yml
    sed -i "s/hshqmanager/script-server/g" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home
    sed -i "s/hshqmanager/script-server/g" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary
    sed -i "s/hshqmanager/script-server/g" $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
    cp $HSHQ_ASSETS_DIR/images/script-server.png $HSHQ_STACKS_DIR/heimdall/config/www/icons/
    sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set title='Script-server', icon='icons/script-server.png', url='https://script-server.$HOMESERVER_DOMAIN' where title='HSHQ Manager';"
    sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "Update monitor set name='Script-server', url='https://script-server.$HOMESERVER_DOMAIN' where name='HSHQ Manager';"
    docker container restart authelia > /dev/null 2>&1
    installStackByName script-server
    releaseLock hshqopen "version46Update" false
    sudo systemctl disable runHSHQManager
    sudo systemctl stop runHSHQManager
    echo -e "\n\nPlease restart the hshq.sh script to complete the update.\n"
    exit
  fi
}

function version48Update()
{
  set +e
  grep HOMEASSISTANT_CONFIGURATOR_USER $CONFIG_FILE >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    initServicesCredentials
    # Email to user
    sendEmail -s "HomeAssistant Configurator Login Info" -b "HomeAssistant Configurator Username: $HOMEASSISTANT_CONFIGURATOR_USER\nHomeAssistant Configurator Password: $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
  fi
  if [ -f $HSHQ_STACKS_DIR/homeassistant/configurator/settings.conf ]; then
    grep "USERNAME" $HSHQ_STACKS_DIR/homeassistant/configurator/settings.conf >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      hc_pw_hash=$(echo -n $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD | openssl dgst -sha256 | cut -d"=" -f2 | xargs)
      sed -i "/BASEPATH.*/a\    \"HASS_API\": \"\",\n    \"USERNAME\": \"$HOMEASSISTANT_CONFIGURATOR_USER\",\n    \"PASSWORD\": \"{sha256}$hc_pw_hash\"," $HSHQ_STACKS_DIR/homeassistant/configurator/settings.conf
      deleteSvcUptimeKuma "https://$SUB_HOMEASSISTANT_CONFIGURATOR.$HOMESERVER_DOMAIN" true
    fi
    echo "Restarting HomeAssistant stack (if running)..."
    restartStackIfRunning homeassistant 10
  fi
}

function version52Update()
{
  set +e
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nYou will be prompted for you sudo password on the RelayServer.\n"
    notifyRSLogin
    loadSSHKey
    set +e
    rs_default_iface=$(ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "ip route | grep -e \"^default\"" | awk -F'dev ' '{print $2}' | xargs | cut -d" " -f1)
    tee $HOME/88-hshq.conf >/dev/null <<EOFSC
# Some minor tuning
kernel.panic = 10
fs.file-max = 10000000
fs.nr_open = 10000000
fs.inotify.max_user_instances = 8192
fs.inotify.max_user_watches = 524288
net.core.rmem_max = 4194304
net.core.wmem_max = 4194304
net.core.somaxconn = 65536
net.netfilter.nf_conntrack_max = 1048576
net.netfilter.nf_conntrack_tcp_loose = 0
net.netfilter.nf_conntrack_tcp_timeout_established = 1800
net.netfilter.nf_conntrack_tcp_timeout_close = 10
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 10
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 20
net.netfilter.nf_conntrack_tcp_timeout_last_ack = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_recv = 20
net.netfilter.nf_conntrack_tcp_timeout_syn_sent = 20
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 10
net.ipv4.route.flush = 1
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_max_syn_backlog = 4096
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5
net.ipv4.tcp_timestamps = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv4.ip_forward = 1
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.rp_filter = 2
net.ipv4.conf.default.rp_filter = 2
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
EOFSC
    chmod 644 $HOME/88-hshq.conf

    tee $HOME/10-setupDockerUserIPTables.sh >/dev/null <<EOFSC
#!/bin/bash
  set +e

  default_iface=\$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1)
  SSH_PORT=$RELAYSERVER_SSH_PORT
  WG_CON_PORT=$RELAYSERVER_WG_PORT
  WG_PORTAL_PORT=$RELAYSERVER_WG_PORTAL_PORT
  DOCK_EXT_NET=$NET_EXTERNAL_SUBNET
  ports_list=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT

  portsArr=(\$(echo \$ports_list | tr "," "\n"))
  for cur_port in "\${portsArr[@]}"
  do
    iptables -D DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j ACCEPT 2> /dev/null
    iptables -D DOCKER-USER -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j DROP 2> /dev/null
    iptables -I DOCKER-USER -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j DROP
    iptables -I DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j ACCEPT
  done

  # See https://gist.github.com/mattia-beta/bd5b1c68e3d51db933181d8a3dc0ba64?permalink_comment_id=3728715#gistcomment-3728715
  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -N chain-icmp > /dev/null 2>&1
  iptables -t raw -N chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -A PREROUTING -s 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 0.0.0.0/8 -j DROP
  iptables -t raw -A PREROUTING -s 0.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,169.254.0.0/16,224.0.0.0/4,198.18.0.0/15,100.64.0.0/10,192.88.99.0/24 -i \$default_iface -j DROP
  iptables -t raw -A PREROUTING -s 127.0.0.0/8 ! -i lo -j DROP
  iptables -t raw -A PREROUTING -p udp -m udp -m multiport --ports 0 -j DROP
  iptables -t raw -A PREROUTING -p icmp -j chain-icmp
  iptables -t raw -A PREROUTING -p tcp -m tcp -j chain-bad_tcp
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type network-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type host-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type protocol-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type port-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type fragmentation-needed -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -i \$default_iface -j DROP
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type parameter-problem -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type any -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,ACK FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,URG URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,FIN FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,PSH PSH -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL ALL -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp -m tcp -m multiport --ports 0 -j DROP
  iptables -t raw -P PREROUTING ACCEPT

  # Limit connections per source IP
  iptables -C INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset > /dev/null 2>&1 || iptables -A INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset

  # Allow established connections
  iptables -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

  # Drop invalid packets
  iptables -C INPUT -m conntrack --ctstate INVALID -j DROP > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate INVALID -j DROP

  # Drop fragments
  iptables -C INPUT -f -j DROP > /dev/null 2>&1 || iptables -A INPUT -f -j DROP

  # Drop SYN packets with suspicious MSS value
  iptables -C INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP > /dev/null 2>&1 || iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP

  # Configure loopback
  iptables -C INPUT -i lo -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -i lo -j ACCEPT
  iptables -C INPUT ! -i lo -s 127.0.0.0/8 -j DROP > /dev/null 2>&1 || iptables -A INPUT ! -i lo -s 127.0.0.0/8 -j DROP

  # Allow ICMP
  iptables -C INPUT -p icmp -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p icmp -j ACCEPT

  # Allow SSH
  iptables -C INPUT -p tcp -m tcp --dport \$SSH_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp --dport \$SSH_PORT -j ACCEPT

  # Allow WireGuard
  iptables -C INPUT -p udp --dport \$WG_CON_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p udp --dport \$WG_CON_PORT -j ACCEPT

  # Special case for WG Portal from reverse proxy
  iptables -C INPUT -p tcp -m tcp -i brdockext -s \$DOCK_EXT_NET --dport \$WG_PORTAL_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp -i brdockext -s \$DOCK_EXT_NET --dport \$WG_PORTAL_PORT -j ACCEPT

  # Policy drop for input and forward
  iptables -P INPUT DROP
  iptables -P FORWARD DROP

  # Policy drop all ipv6 traffic
  ip6tables -P INPUT DROP
  ip6tables -P FORWARD DROP
  ip6tables -P OUTPUT DROP

  sysctl --system > /dev/null 2>&1

EOFSC
    chmod 744 $HOME/10-setupDockerUserIPTables.sh

    tee $HOME/clearDockerUserIPTables.sh >/dev/null <<EOFSC
#!/bin/bash
  set +e

  SSH_PORT=$RELAYSERVER_SSH_PORT
  WG_CON_PORT=$RELAYSERVER_WG_PORT
  WG_PORTAL_PORT=$RELAYSERVER_WG_PORTAL_PORT
  DOCK_EXT_NET=$NET_EXTERNAL_SUBNET
  ports_list=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT

  portsArr=(\$(echo \$ports_list | tr "," "\n"))
  for cur_port in "\${portsArr[@]}"
  do
    iptables -D DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j ACCEPT 2> /dev/null
    iptables -D DOCKER-USER -m conntrack --ctorigdstport \$cur_port --ctdir ORIGINAL -j DROP 2> /dev/null
  done

  iptables -D INPUT -f -j DROP > /dev/null 2>&1
  iptables -D INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP > /dev/null 2>&1
  iptables -D INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset > /dev/null 2>&1
  iptables -D INPUT -m conntrack --ctstate INVALID -j DROP > /dev/null 2>&1
  iptables -D INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -i lo -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT ! -i lo -s 127.0.0.0/8 -j DROP > /dev/null 2>&1
  iptables -D INPUT -p icmp -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p tcp -m tcp --dport \$SSH_PORT -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p udp --dport \$WG_CON_PORT -j ACCEPT > /dev/null 2>&1
  iptables -D INPUT -p tcp -m tcp -i brdockext -s \$DOCK_EXT_NET --dport \$WG_PORTAL_PORT -j ACCEPT > /dev/null 2>&1

  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1

  iptables -P INPUT ACCEPT
  ip6tables -P INPUT ACCEPT
  ip6tables -P FORWARD ACCEPT
  ip6tables -P OUTPUT ACCEPT

EOFSC
    chmod 744 $HOME/clearDockerUserIPTables.sh

    scp -P $RELAYSERVER_SSH_PORT $HOME/88-hshq.conf $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/10-setupDockerUserIPTables.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    scp -P $RELAYSERVER_SSH_PORT $HOME/clearDockerUserIPTables.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo chown root:root ~/88-hshq.conf; sudo chown root:root ~/10-setupDockerUserIPTables.sh; sudo chown root:root ~/clearDockerUserIPTables.sh; sudo mv ~/88-hshq.conf /etc/sysctl.d/88-hshq.conf; sudo mv ~/10-setupDockerUserIPTables.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh; sudo rm -f $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/setupDockerUserIPTables.sh; sudo mv ~/clearDockerUserIPTables.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh; sudo apt-mark hold docker-ce; sudo apt-mark hold docker-ce-cli; sudo reboot"
    unloadSSHKey
    rm -f $HOME/88-hshq.conf
    rm -f $HOME/10-setupDockerUserIPTables.sh
    rm -f $HOME/clearDockerUserIPTables.sh
  fi
  set -e

  updateSysctl false
  # See https://www.portainer.io/blog/portainer-and-docker-26
  sudo apt-mark hold docker-ce
  sudo apt-mark hold docker-ce-cli
}

function version53Update()
{
  set +e
  outputMaintenanceScripts
  outputPerformPostDockerBootActionsScript
  deleteFromRootCron "restartHomeAssistantStack.sh"
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/restartHomeAssistantStack.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh
  sudo tee $HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 500 $HSHQ_SCRIPTS_DIR/boot/bootscripts/*.sh
run-parts --regex '.*sh\$' $HSHQ_SCRIPTS_DIR/boot/bootscripts
EOFBS
  sudo chmod 744 $HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh
  if [ -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/setupDockerUserIPTables.sh ]; then
    sudo mv $HSHQ_SCRIPTS_DIR/boot/bootscripts/setupDockerUserIPTables.sh $HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  fi
  if [ -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/dockerWireGuardCaddyFix.sh ]; then
    sudo mv $HSHQ_SCRIPTS_DIR/boot/bootscripts/dockerWireGuardCaddyFix.sh $HSHQ_SCRIPTS_DIR/boot/bootscripts/50-dockerWireGuardCaddyFix.sh
  fi
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/restartHomeAssistantStack.sh
  updateSysctl false
  if [ -f $HSHQ_STACKS_DIR/coturn/turnserver.conf ]; then
    grep $COTURN_COMMS_MIN_PORT $HSHQ_STACKS_DIR/coturn/turnserver.conf > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      # Reinstall coturn with new ports
      echo -e "\n\n\nCoturn must be reinstalled due to a change in the port range.\nThis will result in the reverse proxy (Caddy) being restarted,\nand this web page will desync as a result. Ensure to refresh \nthe web page when this occurs, in order to continue the update."
      notifyRSLogin
      deleteListOfStacks true coturn
      installListOfServices coturn
    fi
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nThis update will also reboot the RelayServer.\nYou will be prompted for you sudo password on the RelayServer.\n"
    notifyRSLogin
    loadSSHKey
    set +e
    tee $HOME/onBootRoot.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 744 $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/*.sh
run-parts --regex '.*sh\$' $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
EOFBS
    chmod 744 $HOME/onBootRoot.sh
    scp -P $RELAYSERVER_SSH_PORT $HOME/onBootRoot.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo chown root:root ~/onBootRoot.sh; sudo mv ~/onBootRoot.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh; if [ -f $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/setupDockerUserIPTables.sh ]; then sudo mv $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/setupDockerUserIPTables.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh; fi; sleep 5; sudo reboot"
    unloadSSHKey
    rm -f $HOME/onBootRoot.sh
    sed -i "s/setupDockerUserIPTables.sh/10-setupDockerUserIPTables.sh/g" $HSHQ_RELAYSERVER_DIR/scripts/$RS_INSTALL_TRANSFER_SCRIPT_NAME
  fi

  HSHQ_VERSION=53
  updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  echo -e "\n\n\nThis update requires a reboot of the HomeServer.\n"
  notifyRSLogin
  performExitFunctions false
  sudo reboot
}

function version54Update()
{
  set +e
  echo -e "\n\n\nThis update requires restarting Script-server, which will exit the\nscript and halt any subsequent updates. Please ensure to re-run the\nupdate process after it has completed.\n"
  notifyRSLogin
  default_iface=$(getDefaultIface)
  sudo iptables -C INPUT -p tcp -m tcp -i $default_iface -s $HOMESERVER_HOST_RANGE --dport $SCRIPTSERVER_LOCALHOST_PORT -j ACCEPT > /dev/null 2>&1 || sudo iptables -A INPUT -p tcp -m tcp -i $default_iface -s $HOMESERVER_HOST_RANGE --dport $SCRIPTSERVER_LOCALHOST_PORT -j ACCEPT
  generateCert script-server "script-server,host.docker.internal,localhost" "127.0.0.1,$HOMESERVER_HOST_IP"
  insertEnableSvcHeimdall script-server "$FMLNAME_SCRIPTSERVER (IP)" $USERTYPE_SCRIPTSERVER "https://$HOMESERVER_HOST_IP:$SCRIPTSERVER_LOCALHOST_PORT" "script-server.png" true "$(getHeimdallOrderFromSub $SUB_SCRIPTSERVER $USERTYPE_SCRIPTSERVER)"
  HSHQ_VERSION=54
  updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  performExitFunctions
  sudo systemctl restart runScriptServer
  exit
}

function version55Update()
{
  set +e
  outputWireGuardScripts
  grep "HOMENET_ADDITIONAL_IPS" $CONFIG_FILE > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sed -i "s|^HOMESERVER_HOST_RANGE=.*|HOMESERVER_HOST_RANGE=$HOMESERVER_HOST_RANGE\nHOMENET_ADDITIONAL_IPS=|g" $CONFIG_FILE
  fi
  if [ "$HOMESERVER_HOST_ISPRIVATE_IP" = "false" ] && ! [ -z "$CONNECTING_IP" ]; then
    addHomeNetIP ${CONNECTING_IP}/32 false
  fi
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    addHomeNetIP ${RELAYSERVER_SERVER_IP}/32 false
  fi
  if [ "$HOMESERVER_HOST_ISPRIVATE_IP" = "false" ]; then
    # Add special rules when HomeServer is on non-private network, i.e. cloud-server, etc.
    if ! [ -z "$HOMENET_ADDITIONAL_IPS" ]; then
      default_iface=$(getDefaultIface)
      sudo iptables -C INPUT -p tcp -m tcp -i $default_iface -s $HOMENET_ADDITIONAL_IPS --dport $SCRIPTSERVER_LOCALHOST_PORT -j ACCEPT > /dev/null 2>&1 || sudo iptables -A INPUT -p tcp -m tcp -i $default_iface -s $HOMENET_ADDITIONAL_IPS --dport $SCRIPTSERVER_LOCALHOST_PORT -j ACCEPT
    fi
  fi
  set -e
}

function version56Update()
{
  performSuggestedSecUpdates
  sudo systemctl restart sshd
}

function version59Update()
{
  # This helps with sending internal emails within a primary network.
  cat <<EOFRS > $HOME/mailu-groups.conf
group "dkim" {
  symbols = {
    "R_DKIM_ALLOW" = {
      weight = -6.0;
    }
  }
}

EOFRS
  chmod 664 $HOME/mailu-groups.conf
  sudo chown 101:101 $HOME/mailu-groups.conf
  sudo mv $HOME/mailu-groups.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/groups.conf
  docker container restart mailu-antispam > /dev/null 2>&1
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nYou will be prompted for you sudo password on the RelayServer.\n"
    notifyRSLogin
    loadSSHKey
    set +e
    cat <<EOFHC > $HOME/groups.conf
group "policies" {
  symbols = {
    "DMARC_POLICY_REJECT" = {
      weight = 100.0;
    }
  }
}

EOFHC
    chmod 644 $HOME/groups.conf
    scp -P $RELAYSERVER_SSH_PORT $HOME/groups.conf $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo chown root:root ~/groups.conf; sudo mv ~/groups.conf $RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/rspamd/conf/groups.conf; docker container restart mail-relay-rspamd > /dev/null 2>&1"
    unloadSSHKey
    rm -f $HOME/groups.conf
  fi
  set +e
  cp $HSHQ_ASSETS_DIR/images/hslogo.png $HSHQ_ASSETS_DIR/images/${HOMESERVER_DOMAIN}.png
}

function version64Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
}

function version65Update()
{
  # Fixes extra leading slash in "map =" entries
  cat <<EOFRS > $HOME/multimap.conf
IP_WHITELIST {
  type = "ip";
  prefilter = true;
  map = "\${LOCAL_CONFDIR}/override.d/ip_whitelist.map";
  action = "accept";
}

IP_BLACKLIST {
  type = "ip";
  prefilter = true;
  map = "\${LOCAL_CONFDIR}/override.d/ip_blacklist.map";
  action = "reject";
}

DOMAIN_WHITELIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "\${LOCAL_CONFDIR}/override.d/domain_whitelist.map";
  score = -100.0;
  action = "accept";
}

DOMAIN_BLACKLIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "\${LOCAL_CONFDIR}/override.d/domain_blacklist.map";
  score = 100.0;
  action = "reject";
}

EOFRS

  sudo mv $HOME/multimap.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/multimap.conf
  docker container restart mailu-antispam
}

function version66Update()
{
  set +e
  grep "base target" $HSHQ_STACKS_DIR/script-server/web/index.html > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sed -i "s|<\/title>|<\/title><base target=\"_blank\">|" $HSHQ_STACKS_DIR/script-server/web/index.html
  fi
  set -e
}

function version67Update()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    loadSSHKey
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "chmod 600 $RELAYSERVER_HSHQ_STACKS_DIR/wireguard/wgportal/config.yml"
    unloadSSHKey
  fi
}

function version68Update()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nYou will be prompted for you sudo password on the RelayServer.\n"
    notifyRSLogin
    tee $HOME/resetCaddyContainer.sh >/dev/null <<EOFCD
#!/bin/bash
RELAYSERVER_HSHQ_NONBACKUP_DIR=$RELAYSERVER_HSHQ_NONBACKUP_DIR
RELAYSERVER_HSHQ_SSL_DIR=$RELAYSERVER_HSHQ_SSL_DIR

docker container stop caddy
rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/config/*
rm -fr \$RELAYSERVER_HSHQ_NONBACKUP_DIR/caddy/data/*
rm -fr \$RELAYSERVER_HSHQ_SSL_DIR/caddy/*
docker container start caddy

EOFCD
    chmod 500 $HOME/resetCaddyContainer.sh
    loadSSHKey
    scp -P $RELAYSERVER_SSH_PORT $HOME/resetCaddyContainer.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo chown root:root ~/resetCaddyContainer.sh; sudo mv ~/resetCaddyContainer.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh"
    unloadSSHKey
    rm -f $HOME/resetCaddyContainer.sh
  fi
}

function version71Update()
{
  performAptInstall hwinfo > /dev/null 2>&1
}

function version72Update()
{
  mkdir -p $HSHQ_WIREGUARD_DIR/logs
  outputWGDockInternetScript
  outputPerformPostDockerBootActionsScript
  sudo systemctl enable networkd-dispatcher > /dev/null 2>&1
  sudo systemctl start networkd-dispatcher > /dev/null 2>&1
  for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
  do
    if ! test -f "$conf"; then continue; fi
    cur_ext_dom=$(sudo grep "^#EXT_DOMAIN=" $conf | sed 's/^[^=]*=//' | sed 's/ *\$//g')
    if ! [[ $cur_ext_dom =~ ^$RELAYSERVER_SUB_WG.* ]]; then
      sudo sed -i "s|^#EXT_DOMAIN=.*|#EXT_DOMAIN=${RELAYSERVER_SUB_WG}\.${cur_ext_dom}|g" $conf
    fi
  done
}

function version73Update()
{
  updateStackEnv heimdall outputHeimdallCompose
  docker container restart ofelia > /dev/null 2>&1
}

function version75Update()
{
  if [ -d $HSHQ_STACKS_DIR/wazuh ]; then
    sudo apt update
    sudo apt install -y --only-upgrade wazuh-agent=4.7.5-1
    sudo apt-mark hold wazuh-agent
    if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
      echo -e "\n\n\nThe RelayServer requires an update which requires root privileges.\nYou will be prompted for you sudo password on the RelayServer.\n"
      notifyRSLogin
      loadSSHKey
      ssh -p $RELAYSERVER_SSH_PORT -t $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo apt update; sudo apt install -y --only-upgrade wazuh-agent=4.7.5-1; sudo apt-mark hold wazuh-agent"
      unloadSSHKey
    fi
  fi
}

function version76Update()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    outputRelayServerInstallSetupScript
    outputRelayServerInstallTransferScript
  fi
}

function version78Update()
{
  outputPerformPostDockerBootActionsScript
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    echo -e "\n\nUpdating the mail relay postfix image on the RelayServer."
    set +e
    notifyRSLogin
    nrsl_retVal=$?
    set -e
    if [ $nrsl_retVal -eq 0 ]; then
      promptTestRelayServerPassword
      loadSSHKey
      ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "sudo -S -v; git clone https://github.com/homeserverhq/mail-relay.git $RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay; docker image build --network host -t $IMG_MAIL_RELAY_POSTFIX -f $RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix/Dockerfile $RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay/postfix; sudo rm -fr $RELAYSERVER_HSHQ_NONBACKUP_DIR/build/mail-relay"  <<< "$USER_RELAY_SUDO_PW"
      unloadSSHKey
    fi
  fi
}

function version80Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
}

function version83Update()
{
  set +e
  clearAllScriptServerScripts
  set -e
}

function version84Update()
{
  set +e
  outputWGDockInternetScript
  outputPerformPostDockerBootActionsScript
  set -e
}

function version85Update()
{
  set +e
  updateLogrotateConfig
  if sudo test -f $HSHQ_STACKS_DIR/wazuh/volumes/etc/shared/default/agent.conf; then
    sudo sed -i "s/.*Shared agent configuration here.*/\  <rootcheck>\n    <ignore>\/var\/lib\/docker\/overlay2<\/ignore>\n  <\/rootcheck>/" $HSHQ_STACKS_DIR/wazuh/volumes/etc/shared/default/agent.conf
  fi
  if [ -d $HSHQ_STACKS_DIR/wazuh ]; then
    echo "Updating wazuh stack..."
    updateStackEnv wazuh mfFixCACertPath
  fi
  echo "Updating authelia stack..."
  updateStackEnv authelia mfFixCACertPath
  updateSysctl true
  set -e
}

function version86Update()
{
  # Move the priorities in the RPDB from 10,20 to 1000,2000
  # to give space for other changes that someone might want to apply.
  # Also, removed entries for private IP ranges (priority 15), as they are superfluous.
  set +e
  outputWGDockInternetScript
  outputMaintenanceScripts
  set +e
  sudo ip rule delete priority 10 > /dev/null 2>&1
  sudo ip rule delete priority 15 > /dev/null 2>&1
  while [ $? -eq 0 ]
  do
    sudo ip rule delete priority 15 > /dev/null 2>&1
  done
  sudo ip rule delete priority 20 > /dev/null 2>&1
  while [ $? -eq 0 ]
  do
    sudo ip rule delete priority 20 > /dev/null 2>&1
  done
  wgDockInternetUpAll
  set -e
}

function version87Update()
{
  if [ -d $HSHQ_STACKS_DIR/paperless/redis ]; then
    # Move paperless redis to nonbackup directory
    echo "Updating paperless stack..."
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
    # Stack status: 1=running, 2=stopped
    stackStatus=$(getStackStatusByName paperless "$portainerToken")
    mkdir -p $HSHQ_NONBACKUP_DIR/paperless
    mkdir -p $HSHQ_NONBACKUP_DIR/paperless/redis
    if [ "$stackStatus" = "1" ]; then
      startStopStack paperless stop "$portainerToken"
    fi
    updateStackEnv paperless mvFixRedisDir "$portainerToken"
    sudo rm -fr $HSHQ_STACKS_DIR/paperless/redis
    if ! [ "$stackStatus" = "1" ]; then
      startStopStack paperless stop "$portainerToken"
    fi
  fi
}

function version91Update()
{
  set +e
  refreshSudo
  setupPortForwardingDB
  version91UploadPortForwardingScripts
  version91WazuhUpdate
  set -e
}

function version98Update()
{
  set +e
  initServicesCredentials
  outputPerformPostDockerBootActionsScript
  set -e
}

function version102Update()
{
  set +e
  initServicesCredentials
  set -e
}

function version105Update()
{
  # Seriously, who replies to emails underneath rather than above?
  set +e
  sudo grep reply_mode $HSHQ_STACKS_DIR/mailu/overrides/roundcube/custom.inc.php > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo sed -i "s|?>|\$config['reply_mode'] = 1;\n?>|" $HSHQ_STACKS_DIR/mailu/overrides/roundcube/custom.inc.php
    docker container restart mailu-webmail > /dev/null 2>&1
  fi
  set -e
}

function version106Update()
{
  # Adding password auth to Wazuh manager for agent enrollment
  # Excellent article - https://neodyme.io/en/blog/wazuh_rce/#the-target-wazuh
  if [ -d /var/ossec/etc ]; then
    sudo tee /var/ossec/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
    sudo chmod 640 /var/ossec/etc/authd.pass
    sudo chown root:wazuh /var/ossec/etc/authd.pass
    sudo systemctl restart wazuh-agent
  fi

  if sudo test -d $HSHQ_STACKS_DIR/wazuh/volumes/etc; then
    sudo tee $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
    sudo chmod 640 $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass
    sudo chown root:999 $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass
    sudo sed -i "s/<use_password>no<\/use_password>/<use_password>yes<\/use_password>/" $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf
    docker container restart wazuh.manager > /dev/null 2>&1
  fi
  set +e
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    set +e
    promptTestRelayServerPassword
    set -e
    tee $HOME/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
    chmod 640 $HOME/authd.pass
    loadSSHKey
    scp -P $RELAYSERVER_SSH_PORT $HOME/authd.pass $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    unloadSSHKey
    rm -f $HOME/rsUpdateScript.sh
    cat <<EOFLO > $HOME/rsUpdateScript.sh
#!/bin/bash

function main()
{
  read -r -s -p "" rspw
  echo "\$rspw" | sudo -S -v -p "" > /dev/null 2>&1
  sudo chown root:wazuh ~/authd.pass
  sudo mv ~/authd.pass /var/ossec/etc/authd.pass
  sudo systemctl restart wazuh-agent
  echo "Done"
}
main "\$@"
EOFLO
    updateRelayServerWithScript
    rm -f $HOME/authd.pass
  fi
  set -e
}

function version108Update()
{
  set +e
  outputAutheliaIDPSecretsV108
  grep "^identity_providers:" $HSHQ_STACKS_DIR/authelia/config/configuration.yml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    auth_add=$(cat <<EOFAU
identity_providers:
  oidc:
    authorization_policies:
      everyone_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:everyone
      ${LDAP_BASIC_USER_GROUP_NAME}_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:$LDAP_BASIC_USER_GROUP_NAME
      ${LDAP_PRIMARY_USER_GROUP_NAME}_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:${LDAP_PRIMARY_USER_GROUP_NAME}
      adminusers_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:${LDAP_ADMIN_USER_GROUP_NAME}
    hmac_secret: |
      {{- fileContent "/config/secrets/authelia_identity_providers_oidc_hmac_secret.txt" | nindent 6 }}
    jwks:
      - key: |
        {{- fileContent "/config/secrets/jwks-key.pem" | nindent 10 }}
    clients:
# Authelia OIDC Clients BEGIN
# Authelia OIDC Client default BEGIN
      - client_id: default
        client_name: Default
        client_secret: '$(htpasswd -bnBC 10 "" $(pwgen -c -n 64 1) | cut -d":" -f2)'
        public: false
        authorization_policy: two_factor
        redirect_uris:
          - https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN
# Authelia OIDC Client default END
# Authelia OIDC Clients END

...
EOFAU
    )
    sed -i "s/\.\.\.//g" $HSHQ_STACKS_DIR/authelia/config/configuration.yml
    echo "$auth_add" >> $HSHQ_STACKS_DIR/authelia/config/configuration.yml
    updateStackEnv authelia modFunAutheliaConfigFilterVar
    docker ps | grep codeserver > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      docker container restart codeserver > /dev/null 2>&1
    fi
  fi
  set -e
}

function version111Update()
{
  mailuV111Bugfix
}

function version113Update()
{
  outputWGDockInternetScript
}

function version114Update()
{
  set +e
  grep "# sn-sub-${SUB_HSHQSTATUS} BEGIN" $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    hshqstatus_block=$(cat <<EOFHS
# sn-sub-${SUB_HSHQSTATUS} BEGIN
(sn-sub-${SUB_HSHQSTATUS}) {
  https://$SUB_HSHQSTATUS.$HOMESERVER_DOMAIN {
    import $CADDY_SNIPPET_TLS_HSHQ
    respond "Good"
  }
}
# sn-sub-${SUB_HSHQSTATUS} END
EOFHS
)
    repl_block="# sn-sub-${SUB_IMAGES} END"
    res_block="${repl_block}\n\n${hshqstatus_block}"
    replaceSingleLineInFile "$repl_block" "$res_block" $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
    repl_block="import sn-sub-${SUB_IMAGES}"
    res_block="${repl_block}\nimport sn-sub-${SUB_HSHQSTATUS}"
    for cfile in $HSHQ_STACKS_DIR/caddy-common/caddyfiles/*
    do
      if ! test -f "$cfile"; then continue; fi
      replaceSingleLineInFile "$repl_block" "$res_block" $cfile
    done
    restartAllCaddyContainers
    insertSubAuthelia $SUB_HSHQSTATUS.$HOMESERVER_DOMAIN bypass
    insertEnableSvcUptimeKuma uptimekuma "$HOMESERVER_NAME" homeservers "https://$SUB_HSHQSTATUS.$HOMESERVER_DOMAIN" true
    sendEmail -s "HomeServer Status Checks" -b "The HomeServer status checks performed by UptimeKuma have changed the subdomain on which they query from $SUB_HSHQHOME to $SUB_HSHQSTATUS. You should migrate your URLs over in UptimeKuma. But this will only be successful when the HomeServer you are networked with has applied this update (Version 114) as well. So first check each one before changing it.\n\nTo do this, assuming example.com is the domain you want to check, paste https://hshqstatus.example.com into a browser, and it should return a simple response of 'Good'. If this is successful, then update the URL in UptimeKuma. To make this change easily in UptimeKuma, on the left panel, select HomeServers from the Tags menu. This will only show the HomeServers. Then select one from the list, and click the edit button. In the URL, change from https://$SUB_HSHQHOME.example.com to https://$SUB_HSHQSTATUS.example.com.\n\nYou will have to perform this update over time, since not everyone updates on a regular basis. But this change will lighten the load on everyone's server, since querying Heimdall (the current home page) every minute has some heavier cascading effects."
  fi
}

function version119Update()
{
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/90-restartHomeAssistantStack.sh
  outputPerformPostDockerBootActionsScript
}

function version120Update()
{
  sudo chown root:root /etc/crontab
  sudo chmod og-rwx /etc/crontab
  sudo chown root:root /etc/cron.hourly/
  sudo chmod og-rwx /etc/cron.hourly/
  sudo chown root:root /etc/cron.daily/
  sudo chmod og-rwx /etc/cron.daily/
  sudo chown root:root /etc/cron.weekly/
  sudo chmod og-rwx /etc/cron.weekly/
  sudo chown root:root /etc/cron.monthly/
  sudo chmod og-rwx /etc/cron.monthly/
  sudo chown root:root /etc/cron.d/
  sudo chmod og-rwx /etc/cron.d/
  sudo sed -i '/logfile=/d' /etc/sudoers >/dev/null
  sudo sed -i '/includedir/d' /etc/sudoers >/dev/null
  echo "Defaults logfile=/var/log/sudo.log" | sudo tee -a /etc/sudoers >/dev/null
  echo "@includedir /etc/sudoers.d" | sudo tee -a /etc/sudoers >/dev/null
  fixNetplanBackport
  rm -f $HOME/rsUpdateScript.sh
  cat <<EOFLO > $HOME/rsUpdateScript.sh
#!/bin/bash

set +e
function main()
{
  read -r -s -p "" rspw
  echo "\$rspw" | sudo -S -v -p "" > /dev/null 2>&1
  if sudo test -f /etc/logrotate.d/rsyslog; then
    # Set max size of syslog to 2G
    grep maxsize /etc/logrotate.d/rsyslog > /dev/null 2>&1
    if [ \$? -ne 0 ]; then
      sudo sed -i "/weekly\$/a\        maxsize 2G" /etc/logrotate.d/rsyslog
    fi
  fi
  # Move logrotate into hourly
  if sudo test -f /etc/cron.daily/logrotate; then
    sudo mv /etc/cron.daily/logrotate /etc/cron.hourly
  fi
  # Set conditions for docker container logs
  sudo tee /etc/logrotate.d/docker >/dev/null <<EOFLR
/var/log/docker/*.log {
    weekly
    maxsize 100M
    rotate 4
    missingok
    notifempty
}
EOFLR
  sudo systemctl restart logrotate
  echo "Done"
}
main "\$@"
EOFLO
  updateRelayServerWithScript
}

function version121Update()
{
  set +e
  createHSHQLog
  rm -f $HOME/rsUpdateScript.sh
  cat <<EOFRS > $HOME/rsUpdateScript.sh
function main()
{
  read -r -s -p "" rspw
  echo "\$rspw" | sudo -S -v -p "" > /dev/null 2>&1
  RELAYSERVER_HSHQ_SCRIPTS_DIR=\$HOME/hshq/data/scripts
  exposedPortsList=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$RELAYSERVER_WG_PORTAL_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT
  sudo rm -f \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/*.sh
run-parts --regex '.*sh\$' \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts
EOFBS
  sudo chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh

  default_iface=\$(getDefaultIface)
  sudo rm -f \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh >/dev/null <<EOFBS
#!/bin/bash
  set +e

  SSH_PORT=$RELAYSERVER_SSH_PORT
  WG_CON_PORT=$RELAYSERVER_WG_PORT
  WG_PORTAL_PORT=$RELAYSERVER_WG_PORTAL_PORT
  DOCK_EXT_NET=$NET_EXTERNAL_SUBNET
  ports_list=53,$MAILU_PORT_5,$RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT

  sudo iptables -t filter -F DOCKER-USER > /dev/null
  sudo iptables -t filter -X DOCKER-USER > /dev/null
  sudo iptables -t filter -N DOCKER-USER > /dev/null

  portsArr=(\\\$(echo \\\$ports_list | tr "," "\n"))
  for cur_port in "\\\${portsArr[@]}"
  do
    iptables -D DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j RETURN 2> /dev/null
    iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j DROP 2> /dev/null
    iptables -I DOCKER-USER -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j DROP
    iptables -I DOCKER-USER -s 127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -m conntrack --ctorigdstport \\\$cur_port --ctdir ORIGINAL -j RETURN
  done

  # See https://gist.github.com/mattia-beta/bd5b1c68e3d51db933181d8a3dc0ba64?permalink_comment_id=3728715#gistcomment-3728715
  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -N chain-icmp > /dev/null 2>&1
  iptables -t raw -N chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -A PREROUTING -s 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 192.0.0.0/24,192.0.2.0/24,198.51.100.0/24,203.0.113.0/24 -j DROP
  iptables -t raw -A PREROUTING -d 0.0.0.0/8 -j DROP
  # Block spoofed packets
  iptables -t raw -A PREROUTING -s 0.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,169.254.0.0/16,224.0.0.0/4,198.18.0.0/15,100.64.0.0/10,192.88.99.0/24 -i \$default_iface -j DROP
  iptables -t raw -A PREROUTING -s 127.0.0.0/8 ! -i lo -j DROP
  iptables -t raw -A PREROUTING -p udp -m udp -m multiport --ports 0 -j DROP
  iptables -t raw -A PREROUTING -p icmp -j chain-icmp
  iptables -t raw -A PREROUTING -p tcp -m tcp -j chain-bad_tcp
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-reply -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type network-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type host-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type protocol-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type port-unreachable -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type fragmentation-needed -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -i \$default_iface -j DROP
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type echo-request -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type time-exceeded -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type parameter-problem -j ACCEPT
  iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type any -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,ACK FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,URG URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,FIN FIN -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,PSH PSH -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL ALL -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL NONE -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
  iptables -t raw -A chain-bad_tcp -p tcp -m tcp -m multiport --ports 0 -j DROP
  iptables -t raw -P PREROUTING ACCEPT

  # Limit connections per source IP
  iptables -C INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset > /dev/null 2>&1 || iptables -A INPUT -p tcp -m connlimit --connlimit-above 50 -j REJECT --reject-with tcp-reset

  # Allow established connections
  iptables -C INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

  # Drop invalid packets
  iptables -C INPUT -m conntrack --ctstate INVALID -j DROP > /dev/null 2>&1 || iptables -A INPUT -m conntrack --ctstate INVALID -j DROP

  # Drop fragments
  iptables -C INPUT -f -j DROP > /dev/null 2>&1 || iptables -A INPUT -f -j DROP

  # Drop SYN packets with suspicious MSS value
  iptables -C INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP > /dev/null 2>&1 || iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP

  # Configure loopback
  iptables -C INPUT -i lo -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -i lo -j ACCEPT
  iptables -C INPUT ! -i lo -s 127.0.0.0/8 -j DROP > /dev/null 2>&1 || iptables -A INPUT ! -i lo -s 127.0.0.0/8 -j DROP

  # Allow ICMP
  iptables -C INPUT -p icmp -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p icmp -j ACCEPT

  # Allow SSH
  iptables -C INPUT -p tcp -m tcp --dport \\\$SSH_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp --dport \\\$SSH_PORT -j ACCEPT

  # Allow WireGuard
  iptables -C INPUT -p udp --dport \\\$WG_CON_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p udp --dport \\\$WG_CON_PORT -j ACCEPT

  # Special case for WG Portal from reverse proxy
  iptables -C INPUT -p tcp -m tcp -i brdockext -s \\\$DOCK_EXT_NET --dport \\\$WG_PORTAL_PORT -j ACCEPT > /dev/null 2>&1 || iptables -A INPUT -p tcp -m tcp -i brdockext -s \\\$DOCK_EXT_NET --dport \\\$WG_PORTAL_PORT -j ACCEPT
  iptables -D DOCKER-USER -s 127.0.0.0/8 -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j RETURN 2> /dev/null
  iptables -D DOCKER-USER -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j DROP 2> /dev/null
  iptables -I DOCKER-USER -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j DROP
  iptables -I DOCKER-USER -s 127.0.0.0/8 -m conntrack --ctorigdstport \\\$WG_PORTAL_PORT --ctdir ORIGINAL -j RETURN

  # Policy drop for input and forward
  iptables -P INPUT DROP
  iptables -P FORWARD DROP

  # Policy drop all ipv6 traffic
  ip6tables -P INPUT DROP
  ip6tables -P FORWARD DROP
  ip6tables -P OUTPUT DROP

  sysctl --system > /dev/null 2>&1

EOFBS

# Special case - if RelayServer is behind a firewall and using a private IP for default route,
# then allow traffic from the gateway, since raw table blocks all private ranges
def_route_gate=\$(ip route | grep -e "^default" | awk '{print \$3}')
is_def_priv=\$(checkIsIPPrivate \$def_route_gate)
def_route_cidr_part=\$(ip route | grep \$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1) | grep / | xargs | cut -d" " -f1 | cut -d"/" -f2)
if [ "\$is_def_priv" = "true" ]; then
  echo "Default route is in private range, adding allowance to (raw)iptables..."
  sudo sed -i "/  # Block spoofed packets.*/a\  iptables -t raw -C PREROUTING -s \$def_route_gate\/\$def_route_cidr_part -i \$default_iface -j RETURN > \/dev\/null 2>&1 || iptables -t raw -I PREROUTING -s \$def_route_gate\/\$def_route_cidr_part -i \$default_iface -j RETURN" \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
else
  echo "Default route is in public range."
fi

  sudo chmod 744 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo rm -f \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh >/dev/null <<EOFBS
#!/bin/bash
  set +e

  iptables -t filter -F INPUT
  iptables -t filter -F DOCKER-USER
  iptables -A DOCKER-USER -j RETURN
  iptables -t raw -F PREROUTING
  iptables -t raw -F chain-icmp > /dev/null 2>&1
  iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -F chain-ipspoof > /dev/null 2>&1
  iptables -t raw -X chain-icmp > /dev/null 2>&1
  iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
  iptables -t raw -X chain-ipspoof > /dev/null 2>&1

  iptables -P INPUT ACCEPT
  ip6tables -P INPUT ACCEPT
  ip6tables -P FORWARD ACCEPT
  ip6tables -P OUTPUT ACCEPT

EOFBS

  sudo chmod 500 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh
  sudo systemctl disable runOnBootRoot
  sudo systemctl daemon-reload
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo rm -f \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  sudo tee \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service >/dev/null <<EOFBS
[Unit]
Description=Load HSHQ IP Tables
DefaultDependencies=no

Before=network-pre.target
Wants=network-pre.target

Wants=systemd-modules-load.service local-fs.target
After=systemd-modules-load.service local-fs.target

Conflicts=shutdown.target
Before=shutdown.target

[Service]
Type=oneshot
RemainAfterExit=no
ExecStart=\$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/onBootRoot.sh

[Install]
WantedBy=multi-user.target
EOFBS
  sudo chmod 644 \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  sudo chown root:root \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo ln -s \$RELAYSERVER_HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service /etc/systemd/system/runOnBootRoot.service
  sudo systemctl daemon-reload
  sudo systemctl enable runOnBootRoot
  echo "Done"
}

function getDefaultIface()
{
  echo \$(ip route | grep -e "^default" | head -n 1 | awk -F'dev ' '{print \$2}' | xargs | cut -d" " -f1)
}

function checkIsIPPrivate()
{
  check_ip="\$1"
  set +e
  priv_arr=(10.0.0.0/8 172.16.0.0/12 192.168.0.0/16)
  for subnet in "\${priv_arr[@]}"
  do
    is_in_subnet=\$(isIPInSubnet \$check_ip \$subnet)
    if [ "\$is_in_subnet" = "true" ]; then
      echo "true"
      return
    fi
  done
  echo "false"
}

function isIPInSubnet()
{
  iiis_curE=\${-//[^e]/}
  check_ipaddr=\$1
  check_subnet=\$2
  set +e
  grepcidr \${check_subnet} <(echo \${check_ipaddr}) > /dev/null 2>&1
  if [ \$? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
  set +e
  if ! [ -z \$iiis_curE ]; then
    set -e
  fi
}

main "\$@"
EOFRS
  updateRelayServerWithScript
  echo "Installing yq..."
  performAptInstall yq
  echo "Installing wireless-tools..."
  performAptInstall wireless-tools
  # Only let superuser modify db
  sudo chmod 640 $HSHQ_DB
  sudo chown root $HSHQ_DB
  isVPNSubnetMoved=$(sqlite3 $HSHQ_DB "select count(*) from pragma_table_info('hsvpn_connections') where name='VPN_Subnet';")
  if [ $isVPNSubnetMoved -ne 0 ]; then
    # Move VPN_Subnet from hsvpn_connections to Network_Subnet in connections table
    sudo sqlite3 $HSHQ_DB "alter table connections add Network_Subnet text default null;"
    sudo sqlite3 $HSHQ_DB "update connections set Network_Subnet = (select VPN_Subnet from hsvpn_connections where hsvpn_connections.ID = connections.ID);"
    sudo sqlite3 $HSHQ_DB "create table new_hsvpn_connections(ID integer not null primary key references connections(ID) on delete cascade,HomeServerName text,IsPrimary boolean,DomainName text default null,ExternalPrefix text default null,InternalPrefix text default null,MailHostID integer references mailhosts(ID) on delete cascade,CA_Abbrev text default null,CA_IP text default null,CA_Subdomain text default null,CA_URL text default null,RS_VPN_IP text default null);"
    sudo sqlite3 $HSHQ_DB "insert into new_hsvpn_connections(ID,HomeServerName,IsPrimary,DomainName,ExternalPrefix,InternalPrefix,MailHostID,CA_Abbrev,CA_IP,CA_Subdomain,CA_URL,RS_VPN_IP) select ID,HomeServerName,IsPrimary,DomainName,ExternalPrefix,InternalPrefix,MailHostID,CA_Abbrev,CA_IP,CA_Subdomain,CA_URL,RS_VPN_IP from hsvpn_connections;"
    sudo sqlite3 $HSHQ_DB "drop table hsvpn_connections;"
    sudo sqlite3 $HSHQ_DB "alter table new_hsvpn_connections rename to hsvpn_connections;"
    # Add new columns
    sudo sqlite3 $HSHQ_DB "alter table connections add IsExposeToNetwork boolean;"
    sudo sqlite3 $HSHQ_DB "alter table connections add InputAllowPorts text default null;"
    sudo sqlite3 $HSHQ_DB "alter table connections add DockerUserAllowPorts text default null;"
    sudo sqlite3 $HSHQ_DB "create table customfwsubnet(ID integer not null primary key autoincrement,Name text not null, Subnet text not null, InputAllowPorts text default null, DockerUserAllowPorts text default null);"
  fi
  
  sudo grep "172\.16\.0\.0\/12" /etc/docker/daemon.json > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    sudo sed -i "s/172.16.0.0\/12/172.16.0.0\/15/" /etc/docker/daemon.json
    echo "Restarting docker, this make take a few minutes..."
    set -e
    sudo systemctl restart docker
    set +e
    echo "Docker succesfully restarted, continuing update..."
  fi
  if ! [ -f $HSHQ_PLAINTEXT_ROOT_CONFIG ]; then
    outputPlainTextRootConfig
    source <(sudo cat $HSHQ_PLAINTEXT_ROOT_CONFIG)
    source $CONFIG_FILE
  fi
  if ! [ -f $HSHQ_PLAINTEXT_USER_CONFIG ]; then
    outputPlainTextUserConfig
    source $HSHQ_PLAINTEXT_USER_CONFIG
    source $CONFIG_FILE
  fi
  if [ -z "$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME" ]; then
    add_interface=$(getDefaultIface) 
    addHSInterface $add_interface true
    if [ $? -ne 0 ]; then
      exit 5
    fi
  fi
  moveVarsToPlaintextFile

  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/10-setupDockerUserIPTables.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/afterdocker/10-setupDockerUserIPTables.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/clearDockerUserIPTables.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/bootscripts/50-dockerWireGuardCaddyFix.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/afterdocker/50-dockerWireGuardCaddyFix.sh

  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    prID=$(getPrimaryVPN_DBID)
    PRIMARY_VPN_SUBNET=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections where ID=$prID;")
    updatePlaintextRootConfigVar PRIMARY_VPN_SUBNET $PRIMARY_VPN_SUBNET
  fi
  source <(sudo cat $HSHQ_PLAINTEXT_ROOT_CONFIG)
  source $HSHQ_PLAINTEXT_USER_CONFIG

  idList=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='other';"))
  for curID in "${idList[@]}"
  do
    sudo sqlite3 $HSHQ_DB "update connections set IsExposeToNetwork=true where ID=$curID;"
    sudo sqlite3 $HSHQ_DB "update connections set InputAllowPorts='$INPUT_OTHER_VPN_ALLOW_PORTS_DEFAULT' where ID=$curID;"
    sudo sqlite3 $HSHQ_DB "update connections set DockerUserAllowPorts='$DOCKERUSER_OTHER_VPN_ALLOW_PORTS_DEFAULT' where ID=$curID;"
  done
  primID=$(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='homeserver_vpn' and NetworkType='primary';")
  if ! [ -z "$primID" ]; then
    sudo sqlite3 $HSHQ_DB "update connections set IsExposeToNetwork=true where ID=$primID;"
    sudo sqlite3 $HSHQ_DB "update connections set InputAllowPorts='$INPUT_PRIMARY_VPN_ALLOW_PORTS_DEFAULT' where ID=$primID;"
    sudo sqlite3 $HSHQ_DB "update connections set DockerUserAllowPorts='$DOCKERUSER_PRIMARY_VPN_ALLOW_PORTS_DEFAULT' where ID=$primID;"
  fi
  set +e
  echo "Restarting Portainer..."
  stopPortainer
  outputConfigPortainer
  startPortainer
  echo "Fixing interface names..."
  fixInterfaceNames
  echo "Fixing mailu network names..."
  fixMailuNetworkNames
  echo "Clearing and re-initializing iptables..."
  performClearIPTables true
  checkUpdateAllIPTables versionUpdate
  echo "Updating Sysctl..."
  updateSysctl true
  outputMaintenanceScripts
  outputWGDockInternetScript
  PORTAINER_TOKEN="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  jitsiStackID=$(getStackID jitsi "$PORTAINER_TOKEN")
  if ! [ -z "$jitsiStackID" ]; then
    updateStackEnv jitsi outputEnvJitsi "$PORTAINER_TOKEN"
  fi
  stackID=$(getStackID caddy-home "$PORTAINER_TOKEN")
  if ! [ -z "$stackID" ]; then
    echo "Fixing caddy-home name..."
    # Reinsatll caddy-home stack
    deleteStack caddy-home "$PORTAINER_TOKEN"
    sudo mv $HSHQ_STACKS_DIR/caddy-home $HSHQ_STACKS_DIR/caddy-home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME
    outputConfigCaddy home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME caddy-home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME home $(getHSHostIPVarName $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME) $HOMESERVER_HOST_PRIMARY_INTERFACE_IP home na na na "$(getHSHostSubnetVarName $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME)" "$(getNonPrivateConnectingIP)"
    installStack caddy-home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME caddy-home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME "serving initial configuration" $HOME/caddy-home-$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME.env
  fi
  echo "Updating boot services..."
  sudo systemctl disable runOnBootRoot
  sudo systemctl daemon-reload
  sudo rm -f /etc/systemd/system/runOnBootRoot.service
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/runOnBootRoot.service
  if sudo test -d $HSHQ_SCRIPTS_DIR/boot/bootscripts; then
    sudo mv $HSHQ_SCRIPTS_DIR/boot/bootscripts $HSHQ_SCRIPTS_DIR/boot/afterdocker
  fi
  outputBootScripts
  echo "Updating cronjobs..."
  initCronJobs
  set -e
}

function version126Update()
{
  set +e
  sudo crontab -r
  ema1=$(getConfigVarFromFile EMAIL_ADMIN_EMAIL_ADDRESS $CONFIG_FILE)
  ema2=$(getConfigVarFromFile EMAIL_ADMIN_EMAIL_ADDRESS $HSHQ_PLAINTEXT_ROOT_CONFIG root)
  if ! [ -z "$ema1" ] && [ -z "$ema2" ]; then
    updatePlaintextRootConfigVar EMAIL_ADMIN_EMAIL_ADDRESS $EMAIL_ADMIN_EMAIL_ADDRESS
    sed -i "/^EMAIL_ADMIN_EMAIL_ADDRESS=/d" $CONFIG_FILE >/dev/null
  fi
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/checkUpdateIPTables.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/checkHostIPChanges.sh
  sudo rm -f $HSHQ_WIREGUARD_DIR/scripts/updateEndpointIPs.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/afterdocker/*.sh
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/beforenetwork/updateIPTablesBeforeNetwork.sh
  sudo rm -f $HSHQ_WIREGUARD_DIR/scripts/wgDockInternetUpAll.sh
  sudo rm -f /etc/networkd-dispatcher/routable.d/wgDockInternetUpAll.sh
  set +e
  sudo systemctl stop createWGDockerNetworks > /dev/null 2>&1
  sudo systemctl disable createWGDockerNetworks > /dev/null 2>&1
  sudo rm -f /etc/systemd/system/createWGDockerNetworks.service
  sudo systemctl daemon-reload
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/createWGDockerNetworks.sh
  sudo sed -i "s/CHECKIP_REFRESH_RATE/NETWORK_UPDATE_INTERVAL/" $HSHQ_PLAINTEXT_ROOT_CONFIG >/dev/null
  NETWORK_UPDATE_INTERVAL=5
  updatePlaintextRootConfigVar NETWORK_UPDATE_INTERVAL $NETWORK_UPDATE_INTERVAL
  addBindIPCaddy
  outputUpdateIPTablesBeforeNetworkBootscript
  outputPerformPostDockerBootActionsScript
  outputPerformNetworkingChecks
  outputWireGuardScripts
  initCronJobs
  updateMOTD
  outputScriptServerTheme
}

function version132Update()
{
  set +e
  # Fix matrix version number
  matrixStackID=$(getStackID matrix)
  if ! [ -z "$matrixStackID" ]; then
    echo "Checking matrix stack version..."
    matrixComposeFile="$HSHQ_STACKS_DIR/portainer/compose/$matrixStackID/docker-compose.yml"
    sudo grep "matrixdotorg/synapse:v1.118.0" $matrixComposeFile
    if [ $? -eq 0 ]; then
      echo "Fixing matrix stack version..."
      sudo sed -i "1s|.*|$STACK_VERSION_PREFIX matrix v6|" $matrixComposeFile
    fi
  fi
  updateSysctl true
  sudo grep "mirror.gcr.io" /etc/docker/daemon.json > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    outputDockerDaemonJson
    echo "Docker daemon is being restarted. If you have a lot of containers, then this may take a few minutes..."
    sudo systemctl restart docker
    echo "Docker daemon successfully restarted. Please log in to Portainer and confirm that all containers are"
    echo "running, i.e. none of them have exited. If any have exited, then ensure to restart the entire stack."
    echo "You can also double check in UptimeKuma that all services are in a good running state."  
  fi
}

function version134Update()
{
  if [ -z "$RELAYSERVER_HSHQ_BASE_DIR" ]; then
    RELAYSERVER_HSHQ_BASE_DIR=/home/$RELAYSERVER_REMOTE_USERNAME/hshq
    RELAYSERVER_HSHQ_DATA_DIR=$RELAYSERVER_HSHQ_BASE_DIR/data
    RELAYSERVER_HSHQ_NONBACKUP_DIR=$RELAYSERVER_HSHQ_BASE_DIR/nonbackup
    RELAYSERVER_HSHQ_SCRIPTS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/scripts
    RELAYSERVER_HSHQ_SECRETS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/secrets
    RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_DATA_DIR/stacks
    RELAYSERVER_HSHQ_SSL_DIR=$RELAYSERVER_HSHQ_DATA_DIR/ssl
    updateConfigVar RELAYSERVER_HSHQ_BASE_DIR $RELAYSERVER_HSHQ_BASE_DIR
    updateConfigVar RELAYSERVER_HSHQ_DATA_DIR $RELAYSERVER_HSHQ_DATA_DIR
    updateConfigVar RELAYSERVER_HSHQ_NONBACKUP_DIR $RELAYSERVER_HSHQ_NONBACKUP_DIR
    updateConfigVar RELAYSERVER_HSHQ_SCRIPTS_DIR $RELAYSERVER_HSHQ_SCRIPTS_DIR
    updateConfigVar RELAYSERVER_HSHQ_SECRETS_DIR $RELAYSERVER_HSHQ_SECRETS_DIR
    updateConfigVar RELAYSERVER_HSHQ_STACKS_DIR $RELAYSERVER_HSHQ_STACKS_DIR
    updateConfigVar RELAYSERVER_HSHQ_SSL_DIR $RELAYSERVER_HSHQ_SSL_DIR
  fi
}

function version136Update()
{
  sudo rm -f $HSHQ_STACKS_DIR/duplicati/config/hshq-backup.json
}

function version138Update()
{
  outputPerformNetworkingChecks
  updateSysctl true
}

function version146Update()
{
  outputScriptServerConfigFile
  IS_RESTART_SCRIPTSERVER=true
}

function version152Update()
{
  if [ -d $HSHQ_STACKS_DIR/coturn ]; then
    echo "Fixing allowed IPs on coturn stack..."
    outputCoturnConf
    updateCoturnAllowedIPs
  fi
  echo "Updating adguard env..."
  updateStackEnv adguard modFunAdguardFixMSS
  checkUpdateAllIPTables versionUpdate
}

function version164Update()
{
  checkUpdateAllIPTables versionUpdate
}

function version165Update()
{
  outputLockUtilsScript
}

function version171Update()
{
  # Fixes the annoying excess space at the bottom of Firefox browser windows in Heimdall
  sed -i '/\.sidenav ul {/{:a;N;/}/!ba;s/\.sidenav ul {.*}/\.sidenav ul {\n  list-style: none;\n  margin: 0;\n  padding: 20px;\n  overflow-y: auto;\n}/g}' $HSHQ_STACKS_DIR/heimdall/html/public/css/app.css
  rm -f $HOME/rsUpdateScript.sh
  cat <<EOFRS > $HOME/rsUpdateScript.sh
#!/bin/bash

RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  rm -f \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addRelayedMailDomains.sh
  cat <<EOFCS > \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addRelayedMailDomains.sh
#!/bin/bash
set -e
domains_to_add=\\\$1
deliver_to_host=\\\$2

if [ -z "\\\$domains_to_add" ] || [ -z "\\\$deliver_to_host" ]; then
  echo "Empty Parameters"
  exit 1
fi

deliver_to_host_username=\\\$(echo \\\$deliver_to_host | cut -d"." -f2-)
domains_to_add_Arr=(\\\$(echo \\\$domains_to_add | tr "," "\n"))

for curDomain in "\\\${domains_to_add_Arr[@]}"
do
  sed -i "/^@\\\$curDomain /d" /etc/postfix/config/sasl_senders
  sed -i "/\\\$curDomain/d" /etc/postfix/config/transport
  sed -i "/^\\\$curDomain /d" /etc/postfix/config/relay
  echo "@\\\${curDomain}     \\\${deliver_to_host_username}@mail-relay-postfix" >> /etc/postfix/config/sasl_senders
  sed -i "1s/^/\\\${curDomain}     relay:[\\\${deliver_to_host}]:25\n/" /etc/postfix/config/transport
  echo "\\\${curDomain}     OK" >> /etc/postfix/config/relay
done

postmap /etc/postfix/config/transport
postmap /etc/postfix/config/sasl_senders
postmap /etc/postfix/config/relay
postfix reload
EOFCS
  chmod 544 \$RELAYSERVER_HSHQ_STACKS_DIR/mail-relay/postfix/scripts/addRelayedMailDomains.sh
}

main "\$@"
EOFRS
  updateRelayServerWithScript
}

function updateRelayServerWithScript()
{
  # This function assumes that a script file
  # called $HOME/rsUpdateScript.sh has already
  # been created before executing this function.
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    chmod 500 $HOME/rsUpdateScript.sh
    set +e
    promptTestRelayServerPassword
    set -e
    loadSSHKey
    set +e
    scp -P $RELAYSERVER_SSH_PORT $HOME/rsUpdateScript.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:~/ > /dev/null 2>&1
    rsRet=$?
    if [ $rsRet -ne 0 ]; then
      unloadSSHKey
      return $rsRet
    fi
    ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "bash ~/rsUpdateScript.sh;rm -f ~/rsUpdateScript.sh" <<< "$USER_RELAY_SUDO_PW"
    rsRet=$?
    if [ $rsRet -ne 0 ]; then
      unloadSSHKey
      return $rsRet
    fi
    unloadSSHKey
  fi
  set +e
  rm -f $HOME/rsUpdateScript.sh
}

function addBindIPCaddy()
{
  set +e
  caddy_arr=($(docker ps -a --filter name=caddy-home --format "{{.Names}}"))
  for curCH in "${caddy_arr[@]}"
  do
    ifaceName=$(echo $curCH | rev | cut -d"-" -f1 | rev)
    fixBindIP=$(getIPAddressOfInterface $ifaceName)
    if ! [ "$(checkValidIPAddress $fixBindIP)" = "true" ]; then
      continue
    fi
    updateStackEnv $curCH modFunCaddyHomeBindIPFix
  done
  addBlock=$(cat << EOFAB

# sn-sub-${SUB_BIND_IP} BEGIN
(sn-sub-${SUB_BIND_IP}) {
  http://{\$CADDY_HSHQ_BIND_IP} {
    root * /files
    file_server browse
    header Content-Type "application/octet-stream"
    header Content-Disposition "attachment"
    redir /ca.crt /${CERTS_ROOT_CA_NAME}.crt
    redir /ca.der /${CERTS_ROOT_CA_NAME}.der
  }
}
# sn-sub-${SUB_BIND_IP} END

EOFAB
  )
  grep "sn-sub-${SUB_BIND_IP}" $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "$addBlock" >> $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
    echo "import sn-sub-${SUB_BIND_IP}" >> $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home
  fi
  caddy_arr=($(docker ps -a --filter name=caddy-home --format "{{.Names}}"))
  for curCH in "${caddy_arr[@]}"
  do
    docker container restart $curCH > /dev/null 2>&1
  done
}

function modFunCaddyHomeBindIPFix()
{
  set +e
  grep "CADDY_HSHQ_BIND_IP" $HOME/${updateStackName}.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "CADDY_HSHQ_BIND_IP=$fixBindIP" >> $HOME/${updateStackName}.env
  fi
}

function modFunAutheliaConfigFilterVar()
{
  set +e
  grep "X_AUTHELIA_CONFIG_FILTERS" $HOME/${updateStackName}.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "X_AUTHELIA_CONFIG_FILTERS=template" >> $HOME/${updateStackName}.env
  fi
}

function moveVarsToPlaintextFile()
{
  updatePlaintextRootConfigVar HOMENET_ADDITIONAL_IPS "$HOMENET_ADDITIONAL_IPS"
  updatePlaintextRootConfigVar HSHQ_VERSION $HSHQ_VERSION
  updatePlaintextRootConfigVar HOMESERVER_DOMAIN $HOMESERVER_DOMAIN
  updatePlaintextRootConfigVar HOMESERVER_NAME "$HOMESERVER_NAME"
  updatePlaintextRootConfigVar HOMESERVER_ABBREV $HOMESERVER_ABBREV
  updatePlaintextRootConfigVar EMAIL_ADMIN_EMAIL_ADDRESS $EMAIL_ADMIN_EMAIL_ADDRESS
  updatePlaintextRootConfigVar EXT_DOMAIN_PREFIX $EXT_DOMAIN_PREFIX
  updatePlaintextRootConfigVar INT_DOMAIN_PREFIX $INT_DOMAIN_PREFIX
  updatePlaintextRootConfigVar USERID "$USERID"
  updatePlaintextRootConfigVar GROUPID "$GROUPID"
  updatePlaintextRootConfigVar TZ "$TZ"
  updatePlaintextRootConfigVar SSH_PORT $SSH_PORT
  updatePlaintextRootConfigVar CURRENT_SSH_PORT $CURRENT_SSH_PORT
  updatePlaintextRootConfigVar ADMIN_USERNAME_BASE $ADMIN_USERNAME_BASE
  updatePlaintextRootConfigVar PRIMARY_VPN_SETUP_TYPE $PRIMARY_VPN_SETUP_TYPE
  updatePlaintextRootConfigVar DESKTOP_ENV $DESKTOP_ENV
  updatePlaintextRootConfigVar HSHQ_BASE_DIR $HSHQ_BASE_DIR
  updatePlaintextRootConfigVar DISABLED_SERVICES "$DISABLED_SERVICES"
  updatePlaintextRootConfigVar ADMIN_COLOR_CODE $ADMIN_COLOR_CODE
  updatePlaintextRootConfigVar USERS_COLOR_CODE $USERS_COLOR_CODE
  updatePlaintextRootConfigVar HOMESERVERS_COLOR_CODE $HOMESERVERS_COLOR_CODE
  updatePlaintextRootConfigVar RELAYSERVER_COLOR_CODE $RELAYSERVER_COLOR_CODE
  updatePlaintextRootConfigVar WIREGUARD_DNS_REFRESH_RATE $WIREGUARD_DNS_REFRESH_RATE
  updatePlaintextRootConfigVar LECERTS_REFRESH_RATE $LECERTS_REFRESH_RATE
  updatePlaintextRootConfigVar DOCKER_NETWORK_RESERVED_RANGE $DOCKER_NETWORK_RESERVED_RANGE
  updatePlaintextRootConfigVar DOCKER_NETWORK_SIZE $DOCKER_NETWORK_SIZE
  updatePlaintextRootConfigVar DOCKER_METRICS_PORT $DOCKER_METRICS_PORT
  updatePlaintextRootConfigVar IS_AUTO_UPDATE_NETWORK true
  updatePlaintextRootConfigVar CERTS_IS_CA_INIT $CERTS_IS_CA_INIT
  updatePlaintextRootConfigVar CERTS_ROOT_CA_NAME "$CERTS_ROOT_CA_NAME"
  updatePlaintextRootConfigVar CERTS_EMAIL_ADDRESS "$CERTS_EMAIL_ADDRESS"
  updatePlaintextRootConfigVar CERTS_INTERNAL_DHPARAMS_KEYLENGTH $CERTS_INTERNAL_DHPARAMS_KEYLENGTH
  updatePlaintextRootConfigVar CERTS_INTERNAL_COUNTRY "$CERTS_INTERNAL_COUNTRY"
  updatePlaintextRootConfigVar CERTS_INTERNAL_STATE "$CERTS_INTERNAL_STATE"
  updatePlaintextRootConfigVar CERTS_INTERNAL_LOCALITY "$CERTS_INTERNAL_LOCALITY"
  updatePlaintextRootConfigVar CERTS_INTERNAL_ORG_NAME "$CERTS_INTERNAL_ORG_NAME"
  updatePlaintextRootConfigVar CERTS_INTERNAL_OU_NAME "$CERTS_INTERNAL_OU_NAME"
  updatePlaintextRootConfigVar CERTS_INTERNAL_ROOT_CN "$CERTS_INTERNAL_ROOT_CN"
  updatePlaintextRootConfigVar CERTS_INTERNAL_INTERMEDIATE_CN "$CERTS_INTERNAL_INTERMEDIATE_CN"
  updatePlaintextRootConfigVar CERTS_INTERNAL_CA_DAYS $CERTS_INTERNAL_CA_DAYS
  updatePlaintextRootConfigVar PORTAINER_ADMIN_USERNAME $PORTAINER_ADMIN_USERNAME
  updatePlaintextRootConfigVar PORTAINER_ADMIN_PASSWORD $PORTAINER_ADMIN_PASSWORD
  updatePlaintextRootConfigVar PORTAINER_LOCAL_HTTPS_PORT $PORTAINER_LOCAL_HTTPS_PORT
  updatePlaintextRootConfigVar SCRIPTSERVER_LOCALHOST_PORT $SCRIPTSERVER_LOCALHOST_PORT
  updatePlaintextRootConfigVar ADGUARD_LOCALHOST_PORT $ADGUARD_LOCALHOST_PORT
  updatePlaintextRootConfigVar ADGUARD_ADMIN_USERNAME $ADGUARD_ADMIN_USERNAME
  updatePlaintextRootConfigVar ADGUARD_ADMIN_PASSWORD $ADGUARD_ADMIN_PASSWORD
  updatePlaintextRootConfigVar HOMEASSISTANT_LOCALHOST_PORT $HOMEASSISTANT_LOCALHOST_PORT
  updatePlaintextRootConfigVar HOMEASSISTANT_DB_LOCALHOST_PORT $HOMEASSISTANT_DB_LOCALHOST_PORT

  sudo sed -i "/^RELAYSERVER_WG_VPN_SUBNET=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMENET_ADDITIONAL_IPS=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_HOST_PRIMARY_INTERFACE_IP=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_HOST_ISPRIVATE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_HOST_ISPRIVATE_IP=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_HOST_RANGE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^WAZUH_AGENT_VERSION=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DEFAULT_NETWORK_POOL=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DEFAULT_NETWORK_SIZE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HSHQ_VERSION=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_DOMAIN=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_NAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_ABBREV=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^EMAIL_ADMIN_EMAIL_ADDRESS=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^EXT_DOMAIN_PREFIX=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^INT_DOMAIN_PREFIX=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^USERID=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^GROUPID=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^TZ=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^SSH_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CURRENT_SSH_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^ADMIN_USERNAME_BASE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^PRIMARY_VPN_SETUP_TYPE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DESKTOP_ENV=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HSHQ_BASE_DIR=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DISABLED_SERVICES=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^ADMIN_COLOR_CODE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^USERS_COLOR_CODE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVERS_COLOR_CODE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^RELAYSERVER_COLOR_CODE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^WIREGUARD_DNS_REFRESH_RATE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^LECERTS_REFRESH_RATE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DOCKER_NETWORK_RESERVED_RANGE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DOCKER_NETWORK_SIZE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^IS_AUTO_UPDATE_NETWORK=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_IS_CA_INIT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_ROOT_CA_NAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_EMAIL_ADDRESS=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_DHPARAMS_KEYLENGTH=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_COUNTRY=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_STATE=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_LOCALITY=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_ORG_NAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_OU_NAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_ROOT_CN=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_INTERMEDIATE_CN=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^CERTS_INTERNAL_CA_DAYS=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Certs BEGIN/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Certs END/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^PORTAINER_ADMIN_USERNAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^PORTAINER_ADMIN_PASSWORD=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^PORTAINER_LOCAL_HTTPS_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^SCRIPTSERVER_LOCALHOST_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^ADGUARD_LOCALHOST_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^ADGUARD_ADMIN_USERNAME=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^ADGUARD_ADMIN_PASSWORD=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMEASSISTANT_LOCALHOST_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMEASSISTANT_DB_LOCALHOST_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^DOCKER_METRICS_PORT=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^JITSI_ADVERTISE_IPS=/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Jitsi (Service Details) BEGIN/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Jitsi (Service Details) END/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Adguard (Service Details) BEGIN/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^# Adguard (Service Details) END/d" $CONFIG_FILE >/dev/null
  sudo sed -i "/^HOMESERVER_HOST_IP=/d" $CONFIG_FILE >/dev/null
  cat -s $CONFIG_FILE > $HSHQ_CONFIG_DIR/tmpfile
  mv $HSHQ_CONFIG_DIR/tmpfile $CONFIG_FILE
}

function fixNetplanBackport()
{
  set +e
  if sudo test -f /etc/netplan/00-installer-config.yaml; then
    sudo grep "optional:" /etc/netplan/00-installer-config.yaml > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      sudo sed -i '/nameservers:/i\      optional: true' /etc/netplan/00-installer-config.yaml
      sudo netplan apply > /dev/null 2>&1
    fi
  fi
}

function fixInterfaceNames()
{
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    if [ "${RELAYSERVER_WG_VPN_NETNAME: -4}" = "-vpn" ] && ! [ "${RELAYSERVER_WG_VPN_NETNAME:0:4}" = "vpn-" ]; then
      old_vpn_name=$RELAYSERVER_WG_VPN_NETNAME
      new_vpn_name="vpn-${RELAYSERVER_WG_VPN_NETNAME%????}"
      if sudo test -f $HSHQ_WIREGUARD_DIR/users/${old_vpn_name}-user1.conf; then
        sudo mv $HSHQ_WIREGUARD_DIR/users/${old_vpn_name}-user1.conf $HSHQ_WIREGUARD_DIR/users/${new_vpn_name}-user1.conf
      fi
      RELAYSERVER_WG_VPN_NETNAME=$new_vpn_name
      updateConfigVar RELAYSERVER_WG_VPN_NETNAME $RELAYSERVER_WG_VPN_NETNAME
    fi
    if [ "${RELAYSERVER_WG_INTERNET_NETNAME: -4}" = "-ext" ] && ! [ "${RELAYSERVER_WG_INTERNET_NETNAME:0:4}" = "ext-" ]; then
      old_ext_name=$RELAYSERVER_WG_INTERNET_NETNAME
      new_ext_name="ext-${RELAYSERVER_WG_INTERNET_NETNAME%????}"
      RELAYSERVER_WG_INTERNET_NETNAME=$new_ext_name
      updateConfigVar RELAYSERVER_WG_INTERNET_NETNAME $RELAYSERVER_WG_INTERNET_NETNAME
    fi
  fi

  check_vpnIDs=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType = 'homeserver_vpn' and NetworkType in ('primary','other');"))
  for curVPNID in "${check_vpnIDs[@]}"
  do
    curVPN=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID = '$curVPNID';")
    curIP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID = '$curVPNID';")
    curIsPrimary=$(sqlite3 $HSHQ_DB "select IsPrimary from hsvpn_connections where ID = '$curVPNID';")
    curCA_abbrev=$(sqlite3 $HSHQ_DB "select CA_Abbrev from hsvpn_connections where ID = '$curVPNID';")
    curCA_URL=$(sqlite3 $HSHQ_DB "select CA_URL from hsvpn_connections where ID = '$curVPNID';")
    curCA_Subdomain=$(sqlite3 $HSHQ_DB "select CA_Subdomain from hsvpn_connections where ID = '$curVPNID';")
    curCA_IP=$(sqlite3 $HSHQ_DB "select CA_IP from hsvpn_connections where ID = '$curVPNID';")
    primary_string=other
    if [ $curIsPrimary = 1 ]; then
      primary_string=primary
    fi
    if [ "${curVPN: -4}" = "-vpn" ] && ! [ "${curVPN:0:4}" = "vpn-" ]; then
      old_vpn_name=$curVPN
      new_vpn_name="vpn-${curVPN%????}"
      if sudo test -f /etc/wireguard/${old_vpn_name}.conf; then
        sudo cp /etc/wireguard/${old_vpn_name}.conf /etc/wireguard/${new_vpn_name}.conf
        removeWGInterfaceQuick ${old_vpn_name}
        enableWGInterfaceQuick ${new_vpn_name}
        sudo mv $HSHQ_WIREGUARD_DIR/vpn/${old_vpn_name}.conf $HSHQ_WIREGUARD_DIR/vpn/${new_vpn_name}.conf
      fi
      docker ps | grep caddy-${old_vpn_name} > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        deleteStack caddy-${old_vpn_name}
        sudo mv $HSHQ_STACKS_DIR/caddy-${old_vpn_name} $HSHQ_STACKS_DIR/caddy-${new_vpn_name}
        outputConfigCaddy ${new_vpn_name} caddy-${new_vpn_name} $primary_string ${new_vpn_name} $curIP $curCA_abbrev $curCA_URL $curCA_Subdomain $curCA_IP
        installStack caddy-${new_vpn_name} caddy-${new_vpn_name} "serving initial configuration" $HOME/caddy-${new_vpn_name}.env
      fi
      sudo sqlite3 $HSHQ_DB "update connections set InterfaceName = '${new_vpn_name}' where InterfaceName = '${old_vpn_name}';"
    fi
  done

  check_ext=($(sqlite3 $HSHQ_DB "select InterfaceName from connections where ConnectionType = 'homeserver_internet' and NetworkType in ('primary','other');"))
  for curEXT in "${check_ext[@]}"
  do
    if [ "${curEXT: -4}" = "-ext" ] && ! [ "${curEXT:0:4}" = "ext-" ]; then
      old_ext_name=$curEXT
      new_ext_name="ext-${curEXT%????}"
      if sudo test -f $HSHQ_WIREGUARD_DIR/internet/${old_ext_name}.conf; then
        sudo cp $HSHQ_WIREGUARD_DIR/internet/${old_ext_name}.conf $HSHQ_WIREGUARD_DIR/internet/${new_ext_name}.conf
        updateConfigVarInFile "#NETNAME" "${new_ext_name}" $HSHQ_WIREGUARD_DIR/internet/${new_ext_name}.conf root
        sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${old_ext_name}.conf down
        sudo rm -f $HSHQ_WIREGUARD_DIR/internet/${old_ext_name}.conf
        sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${new_ext_name}.conf up
      fi
      sudo sqlite3 $HSHQ_DB "update connections set InterfaceName = '${new_ext_name}' where InterfaceName = '${old_ext_name}';"
    fi
  done
}

function fixMailuNetworkNames()
{
  startStopStack mailu stop
  docker network rm dock-mailu-ext > /dev/null
  docker network rm dock-mailu-int > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_MAILU_EXT_BRIDGE_NAME --driver=bridge --subnet $NET_MAILU_EXT_SUBNET dock-mailu-ext > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_MAILU_INT_BRIDGE_NAME --driver=bridge --subnet $NET_MAILU_INT_SUBNET --internal dock-mailu-int > /dev/null
  startStopStack mailu start
}

function mfFixCACertPath()
{
  sed -i "s/\/usr\/local\/share\/ca-certificates\/${CERTS_ROOT_CA_NAME}.crt/\${HSHQ_SSL_DIR}\/${CERTS_ROOT_CA_NAME}.crt/g" $HOME/${updateStackName}-compose.yml
}

function sendRSExposeScripts()
{
  cat <<EOFCD > $HOME/addLECertDomains.sh
#!/bin/bash

subdomlist=\$1
RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  set +e
  leCertsArr=(\$(echo "\$subdomlist" | tr "," "\n"))
  for subdom in "\${leCertsArr[@]}"
  do
    if [ -z "\$subdom" ]; then continue; fi
    grep "# LE certs path \$subdom BEGIN" \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile >/dev/null
    if [ \$? -ne 0 ]; then
      strBlock=""
      strBlock=\$strBlock"# LE certs path \$subdom BEGIN\n"
      strBlock=\$strBlock"http://\$subdom {\n"
      strBlock=\$strBlock"  handle /.well-known/acme-challenge/* {\n"
      strBlock=\$strBlock"    reverse_proxy \$subdom {\n"
      strBlock=\$strBlock"      import sn-resolver\n"
      strBlock=\$strBlock"    }\n"
      strBlock=\$strBlock"  }\n"
      strBlock=\$strBlock"}\n"
      strBlock=\$strBlock"# LE certs path \$subdom END\n"
      echo -e "\$strBlock" >> \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
    fi
  done
  docker container restart caddy
}

main "\$@"
EOFCD
  chmod 0500 $HOME/addLECertDomains.sh
  cat <<EOFEX > $HOME/removeLECertDomains.sh
#!/bin/bash
set +e

RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  subdomlist="\$1"
  leCertsArr=(\$(echo "\$subdomlist" | tr "," "\n"))
  for subdom in "\${leCertsArr[@]}"
  do
    if [ -z "\$subdom" ]; then continue; fi
    sed -i "/# LE certs path \$subdom BEGIN/,/# LE certs path \$subdom END/d" \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  done
  cat -s \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile > \$HOME/tmpcadfile
  mv \$HOME/tmpcadfile \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  docker container restart caddy
}

main "\$@"
EOFEX
  chmod 500 $HOME/removeLECertDomains.sh
  cat <<EOFEX > $HOME/addExposeDomains.sh
#!/bin/bash

RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{
  subdomlist="\$1"
  exposeArr=(\$(echo "\$subdomlist" | tr "," "\n"))
  for subdom in "\${exposeArr[@]}"
  do
    if [ -z "\$subdom" ]; then continue; fi
    grep "# Expose domain \$subdom BEGIN" \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile >/dev/null
    if [ \$? -ne 0 ]; then
      strBlock=""
      strBlock=\$strBlock"# Expose domain \$subdom BEGIN\n"
      strBlock=\$strBlock"https://\$subdom {\n"
      strBlock=\$strBlock"  import safe-header\n"
      strBlock=\$strBlock"  reverse_proxy https://\$subdom {\n"
      strBlock=\$strBlock"    import sn-resolver\n"
      strBlock=\$strBlock"  }\n"
      strBlock=\$strBlock"}\n"
      strBlock=\$strBlock"# Expose domain \$subdom END\n"
      echo -e "\$strBlock" >> \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
    fi
  done
  docker container restart caddy
}
main "\$@"
EOFEX
  chmod 500 $HOME/addExposeDomains.sh
  cat <<EOFEX > $HOME/removeExposeDomains.sh
#!/bin/bash
set +e

RELAYSERVER_HSHQ_STACKS_DIR=$RELAYSERVER_HSHQ_STACKS_DIR

function main()
{

  subdomlist="\$1"
  exposeArr=(\$(echo "\$subdomlist" | tr "," "\n"))
  for subdom in "\${exposeArr[@]}"
  do
    if [ -z "\$subdom" ]; then continue; fi
    sed -i "/# Expose domain \$subdom BEGIN/,/# Expose domain \$subdom END/d" \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  done
  cat -s \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile > \$HOME/tmpcadfile
  mv \$HOME/tmpcadfile \$RELAYSERVER_HSHQ_STACKS_DIR/caddy/Caddyfile
  docker container restart caddy
}

main "\$@"
EOFEX
  chmod 500 $HOME/removeExposeDomains.sh

  loadSSHKey
  set -e
  ssh -p $RELAYSERVER_SSH_PORT $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN "rm -f $RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addLECertDomains.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeLECertDomains.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/user/addExposeDomains.sh $RELAYSERVER_HSHQ_SCRIPTS_DIR/user/removeExposeDomains.sh"
  scp -P $RELAYSERVER_SSH_PORT $HOME/addLECertDomains.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/ > /dev/null 2>&1
  scp -P $RELAYSERVER_SSH_PORT $HOME/removeLECertDomains.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/ > /dev/null 2>&1
  scp -P $RELAYSERVER_SSH_PORT $HOME/addExposeDomains.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/ > /dev/null 2>&1
  scp -P $RELAYSERVER_SSH_PORT $HOME/removeExposeDomains.sh $RELAYSERVER_REMOTE_USERNAME@$RELAYSERVER_SUB_RELAYSERVER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN:$RELAYSERVER_HSHQ_SCRIPTS_DIR/user/ > /dev/null 2>&1
  unloadSSHKey
  rm -f $HOME/addLECertDomains.sh
  rm -f $HOME/removeLECertDomains.sh
  rm -f $HOME/addExposeDomains.sh
  rm -f $HOME/removeExposeDomains.sh
}

function checkFixPortainerEnv()
{
  # A bug was introduced in the version 22 update.
  set +e
  grep "HSHQ_RELAYSERVER_DIR" $HSHQ_STACKS_DIR/portainer/portainer.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    stopPortainer
    outputConfigPortainer
    startPortainer
    startStopStack duplicati stop
    startStopStack syncthing stop
    sleep 5
    startStopStack duplicati start
    startStopStack syncthing start
  fi
}

function fixAutheliaConfig()
{
  inputfile=$HSHQ_STACKS_DIR/authelia/config/configuration.yml
  set +e
  grep "# Authelia bypass BEGIN" $inputfile > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    return
  fi
  outres=""
  OLDIFS=$IFS
  IFS=$(echo -en "\n\r")
  readarray -t inputArr < $inputfile
  curnum=0
  while [ $curnum -lt ${#inputArr[@]} ]
  do
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      if [[ "${inputArr[$curnum]}" =~ access_control ]]; then break; fi
      curnum=$((curnum+1))
    done
    curnum=$((curnum+1))
  
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      if [[ "${inputArr[$curnum]}" =~ domain: ]]; then break; fi
      curnum=$((curnum+1))
    done
    curnum=$((curnum+1))
    outres="${outres}# Authelia bypass BEGIN\n"
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      if [[ "${inputArr[$curnum]}" =~ policy: ]]; then break; fi
      outres="${outres}${inputArr[$curnum]}\n"
      curnum=$((curnum+1))
    done
    outres="${outres}# Authelia bypass END\n"
    outres="${outres}${inputArr[$curnum]}\n"
    curnum=$((curnum+1))
  
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      if [[ "${inputArr[$curnum]}" =~ domain: ]]; then break; fi
      curnum=$((curnum+1))
    done
    curnum=$((curnum+1))
    outres="${outres}# Authelia $LDAP_BASIC_USER_GROUP_NAME BEGIN\n"
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      if [[ "${inputArr[$curnum]}" =~ policy: ]]; then break; fi
      outres="${outres}${inputArr[$curnum]}\n"
      curnum=$((curnum+1))
    done
    outres="${outres}# Authelia $LDAP_BASIC_USER_GROUP_NAME END\n"
    outres="${outres}${inputArr[$curnum]}\n"
    curnum=$((curnum+1))
  
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      if [[ "${inputArr[$curnum]}" =~ domain: ]]; then break; fi
      curnum=$((curnum+1))
    done
    curnum=$((curnum+1))
    outres="${outres}# Authelia ${LDAP_PRIMARY_USER_GROUP_NAME} BEGIN\n"
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      if [[ "${inputArr[$curnum]}" =~ policy: ]]; then break; fi
      outres="${outres}${inputArr[$curnum]}\n"
      curnum=$((curnum+1))
    done
    outres="${outres}# Authelia ${LDAP_PRIMARY_USER_GROUP_NAME} END\n"
    outres="${outres}${inputArr[$curnum]}\n"
    curnum=$((curnum+1))
  
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      if [[ "${inputArr[$curnum]}" =~ domain: ]]; then break; fi
      curnum=$((curnum+1))
    done
    curnum=$((curnum+1))
    outres="${outres}# Authelia ${LDAP_ADMIN_USER_GROUP_NAME} BEGIN\n"
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      if [[ "${inputArr[$curnum]}" =~ policy: ]]; then break; fi
      outres="${outres}${inputArr[$curnum]}\n"
      curnum=$((curnum+1))
    done
    outres="${outres}# Authelia ${LDAP_ADMIN_USER_GROUP_NAME} END\n"
    outres="${outres}${inputArr[$curnum]}\n"
    curnum=$((curnum+1))
  
    while [ $curnum -lt ${#inputArr[@]} ]
    do
      outres="${outres}${inputArr[$curnum]}\n"
      curnum=$((curnum+1))
    done
  
  done
  IFS=$OLDIFS
  
  echo -e "$outres" > $inputfile
  docker container restart authelia > /dev/null 2>&1
  docker ps | grep codeserver > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker container restart codeserver > /dev/null 2>&1
  fi
}

function checkImageList()
{
  imageList=$1
  composeFile="$2"
  imageListArr=($(echo $imageList | tr "," "\n"))
  for curImg in "${imageListArr[@]}"
  do
    if ! [ -z "$curImg" ]; then
      sudo grep "$curImg$" "$composeFile" > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "false"
        return
      fi
    fi
  done
  echo "true"
}

function insertVersionNumber()
{
  stackName=$1
  versionNum="$2"
  imageList=$3
  composeFile="$4"
  check_images="$(checkImageList $imageList $composeFile)"
  if [ "$check_images" = "false" ]; then
    echo "false"
    return
  fi
  if ! [ "$(checkStackHSHQManaged $(sudo sed -n 1p $composeFile))" = "true" ]; then
    sudo sed -i "1 i$STACK_VERSION_PREFIX $stackName $versionNum" $composeFile
  else
    sudo sed -i "1s|.*|$STACK_VERSION_PREFIX $stackName $versionNum|" $composeFile
  fi
  echo "true"
}

function setVersionOnStacks()
{
  # This function modifies the variable strSetVersionReport to report the results to the caller
  # The caller is responsible for doing something with it.
  set +e
  refreshSudo
  strSetVersionReport=""
  stackListArr=($(echo ${HSHQ_REQUIRED_STACKS}","${HSHQ_OPTIONAL_STACKS} | tr "," "\n"))
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  for curStack in "${stackListArr[@]}"
  do
    echo "Versioning ${curStack} stack..."
    stackID=$(getStackID $curStack "$portainerToken")
    if ! [ "$curStack" = "portainer" ] && [ -z "$stackID" ]; then
      continue
    fi
    curCompose=$HSHQ_STACKS_DIR/portainer/compose/$stackID/docker-compose.yml
    case "$curStack" in
      portainer)
        curVersion=v1
        curImageList=portainer/portainer-ce:2.19.3-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $HSHQ_STACKS_DIR/portainer/docker-compose.yml)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=portainer/portainer-ce:2.19.4-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $HSHQ_STACKS_DIR/portainer/docker-compose.yml)" = "true" ]; then continue;fi
        strSetVersionReport="${strSetVersionReport}\n $curStack stack version not found. All images from this stack:\n$(sudo grep image: $HSHQ_STACKS_DIR/portainer/docker-compose.yml)"
        continue
      ;;
      adguard)
        curVersion=v1
        curImageList=adguard/adguardhome:v0.107.41
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=adguard/adguardhome:v0.107.43
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      sysutils)
        curVersion=v1
        curImageList=grafana/grafana-oss:9.5.8,prom/prometheus:v2.46.0,prom/node-exporter:v1.6.1,influxdb:2.7.1-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=grafana/grafana-oss:9.5.15,prom/prometheus:v2.48.1,prom/node-exporter:v1.7.0,influxdb:2.7.4-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=grafana/grafana-oss:10.3.1,prom/prometheus:v2.49.1,prom/node-exporter:v1.7.0,influxdb:2.7.5-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      openldap)
        curVersion=v1
        curImageList=osixia/openldap:1.5.0,osixia/phpldapadmin:stable,wheelybird/ldap-user-manager:v1.11
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      mailu)
        curVersion=v1
        curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2.0,ghcr.io/mailu/rspamd:2.0,ghcr.io/mailu/clamav:2.0,ghcr.io/mailu/fetchmail:2.0,ghcr.io/mailu/nginx:2.0,ghcr.io/mailu/dovecot:2.0,ghcr.io/mailu/oletools:2.0,ghcr.io/mailu/postfix:2.0,ghcr.io/mailu/unbound:2.0,ghcr.io/mailu/radicale:2.0,ghcr.io/mailu/webmail:2.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2.0.37,ghcr.io/mailu/rspamd:2.0.37,ghcr.io/mailu/clamav:2.0.37,ghcr.io/mailu/fetchmail:2.0.37,ghcr.io/mailu/nginx:2.0.37,ghcr.io/mailu/dovecot:2.0.37,ghcr.io/mailu/oletools:2.0.37,ghcr.io/mailu/postfix:2.0.37,ghcr.io/mailu/unbound:2.0.37,ghcr.io/mailu/radicale:2.0.37,ghcr.io/mailu/webmail:2.0.37
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      wazuh)
        curVersion=v1
        curImageList=wazuh/wazuh-manager:4.6.0,wazuh/wazuh-indexer:4.6.0,wazuh/wazuh-dashboard:4.6.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=wazuh/wazuh-manager:4.7.1,wazuh/wazuh-indexer:4.7.1,wazuh/wazuh-dashboard:4.7.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=wazuh/wazuh-manager:4.7.2,wazuh/wazuh-indexer:4.7.2,wazuh/wazuh-dashboard:4.7.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      collabora)
        curVersion=v1
        curImageList=collabora/code:23.05.5.3.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=collabora/code:23.05.6.4.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=collabora/code:23.05.8.2.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      nextcloud)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.3-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.23.2-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.5-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.6-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      jitsi)
        curVersion=v1
        curImageList=jitsi/jicofo:stable-8719,jitsi/jvb:stable-8719,jitsi/prosody:stable-8719,jitsi/web:stable-8719
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=jitsi/jicofo:stable-9111,jitsi/jvb:stable-9111,jitsi/prosody:stable-9111,jitsi/web:stable-9111
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=jitsi/jicofo:stable-9220,jitsi/jvb:stable-9220,jitsi/prosody:stable-9220,jitsi/web:stable-9220
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      matrix)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.90.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.40
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.98.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.52
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.100.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.57
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      wikijs)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,requarks/wiki:2.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      duplicati)
        curVersion=v1
        curImageList=linuxserver/duplicati:2.0.7
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      mastodon)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.1.6,nginx:1.23.2-alpine,elasticsearch:8.8.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.3,nginx:1.25.3-alpine,elasticsearch:8.11.3
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.3,nginx:1.25.3-alpine,elasticsearch:8.12.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      dozzle)
        curVersion=v1
        curImageList=amir20/dozzle:v4.10.26
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=amir20/dozzle:v5.8.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=amir20/dozzle:v6.0.8
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v4
        curImageList=amir20/dozzle:v6.1.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      searxng)
        curVersion=v1
        curImageList=searxng/searxng:2023.8.19-018b0a932
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=searxng/searxng:2023.12.29-27e26b3d6
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      jellyfin)
        curVersion=v1
        curImageList=jellyfin/jellyfin:10.8.10
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=jellyfin/jellyfin:10.8.13
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      filebrowser)
        curVersion=v1
        curImageList=filebrowser/filebrowser:v2.24.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=filebrowser/filebrowser:v2.26.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=filebrowser/filebrowser:v2.27.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      photoprism)
        curVersion=v1
        curImageList=mariadb:10.7.3,photoprism/photoprism:220901-bullseye
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      guacamole)
        curVersion=v1
        curImageList=guacamole/guacd:1.5.3,guacamole/guacamole:1.5.3
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=guacamole/guacd:1.5.4,guacamole/guacamole:1.5.4
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      authelia)
        curVersion=v1
        curImageList=authelia/authelia:4.37.5,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      wordpress)
        curVersion=v1
        curImageList=mariadb:10.7.3,wordpress:php8.2-apache
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=mariadb:10.7.3,wordpress:php8.3-apache
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      ghost)
        curVersion=v1
        curImageList=mariadb:10.7.3,ghost:5.59.1-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=mariadb:10.7.3,ghost:5.75.2-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=mariadb:10.7.3,ghost:5.78.0-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      peertube)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v5.2.0-bullseye,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v6.0.2-bookworm,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      homeassistant)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2023.8,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.3,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.5,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v4
        curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.6,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      gitlab)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.2.4-ce.0,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.7.0-ce.0,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.8.1-ce.0,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      vaultwarden)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,vaultwarden/server:1.29.1-alpine,thegeeklab/vaultwarden-ldap:0.6.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.1-alpine,thegeeklab/vaultwarden-ldap:0.6.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.2-alpine,thegeeklab/vaultwarden-ldap:0.6.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      discourse)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,bitnami/discourse:3.0.6,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,bitnami/discourse:3.1.3,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,bitnami/discourse:3.1.4,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      syncthing)
        curVersion=v1
        curImageList=syncthing/syncthing:1.23.7
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=syncthing/syncthing:1.27.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=syncthing/syncthing:1.27.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      codeserver)
        curVersion=v1
        curImageList=codercom/code-server:4.16.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=codercom/code-server:4.20.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=codercom/code-server:4.20.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      shlink)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.6.3,shlinkio/shlink-web-client:3.10.2,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.7.2,shlinkio/shlink-web-client:3.10.2,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.7.3,shlinkio/shlink-web-client:4.0.0,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      firefly)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.0.20,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.1,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.7,bitnami/redis:7.0.5
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      excalidraw)
        curVersion=v1
        curImageList=excalidraw/excalidraw-room,kiliandeca/excalidraw-storage-backend,kiliandeca/excalidraw
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      drawio)
        curVersion=v1
        curImageList=jgraph/drawio:21.0.2,jgraph/plantuml-server,jgraph/export-server
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=jgraph/drawio:23.1.0,jgraph/plantuml-server,jgraph/export-server
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      invidious)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,quay.io/invidious/invidious
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      ittools)
        curVersion=v1
        curImageList=ghcr.io/corentinth/it-tools:latest
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      gitea)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,gitea/gitea:1.20.3
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,gitea/gitea:1.21.3
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,gitea/gitea:1.21.4
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      mealie)
        curVersion=v1
        curImageList=hkotel/mealie:v0.5.6
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.0.0-RC2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.1.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      kasm)
        curVersion=v1
        curImageList=lscr.io/linuxserver/kasm:1.13.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=lscr.io/linuxserver/kasm:1.14.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      ntfy)
        curVersion=v1
        curImageList=binwiederhier/ntfy:v2.7.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=binwiederhier/ntfy:v2.8.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      remotely)
        curVersion=v1
        curImageList=immybot/remotely:69
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      calibre)
        curVersion=v1
        curImageList=linuxserver/calibre:7.3.0,linuxserver/calibre-web:0.6.21
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=linuxserver/calibre:7.4.0,linuxserver/calibre-web:0.6.21
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      netdata)
        curVersion=v1
        curImageList=netdata/netdata:v1.44.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      linkwarden)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.4.8
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      stirlingpdf)
        curVersion=v1
        curImageList=frooodle/s-pdf:0.19.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=frooodle/s-pdf:0.20.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      bar-assistant)
        curVersion=v1
        curImageList=barassistant/server:v3,getmeili/meilisearch:v1.4,bitnami/redis:7.0.5,barassistant/salt-rim:v2,nginx:1.25.3-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=barassistant/server:v3,getmeili/meilisearch:v1.6,bitnami/redis:7.0.5,barassistant/salt-rim:v2,nginx:1.25.3-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      freshrss)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,freshrss/freshrss:1.23.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      keila)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,pentacent/keila:0.13.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=postgres:15.0-bullseye,pentacent/keila:0.14.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      wallabag)
        curVersion=v1
        curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,wallabag/wallabag:2.6.8
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      heimdall)
        curVersion=v1
        curImageList=linuxserver/heimdall:2.4.13
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      ofelia)
        curVersion=v1
        curImageList=mcuadros/ofelia:v0.3.7
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=mcuadros/ofelia:v0.3.9
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      sqlpad)
        curVersion=v1
        curImageList=sqlpad/sqlpad:7.1.2
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=sqlpad/sqlpad:7.2.0
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v3
        curImageList=sqlpad/sqlpad:7.3.1
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
      uptimekuma)
        curVersion=v1
        curImageList=louislam/uptime-kuma:1.23.0-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
        curVersion=v2
        curImageList=louislam/uptime-kuma:1.23.11-alpine
        if [ "$(insertVersionNumber $curStack $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
      ;;
    esac
    strSetVersionReport="${strSetVersionReport}\n $curStack stack version not found. All images from this stack:\n$(sudo grep image: $curCompose)"
  done
  # Special case for Caddy
  qry=$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer $portainerToken" endpointId==1)
  caddy_stack_ids=($(echo $qry | jq '.[] | select (.Name | startswith("caddy-")) | .Id'))
  caddy_stack_names=($(echo $qry | jq -r '.[] | select (.Name | startswith("caddy-")) | .Name'))
  i=-1
  for curStackID in "${caddy_stack_ids[@]}"
  do
    i=$((i+1))
    echo "Versioning ${caddy_stack_names[i]} stack..."
    curCompose=$HSHQ_STACKS_DIR/portainer/compose/$curStackID/docker-compose.yml
    curVersion=v1
    curImageList=caddy:2.7.4
    if [ "$(insertVersionNumber ${caddy_stack_names[i]} $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
    curVersion=v2
    curImageList=caddy:2.7.6
    if [ "$(insertVersionNumber ${caddy_stack_names[i]} $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
    strSetVersionReport="${strSetVersionReport}\n caddy stack version not found. All images from this stack:\n$(sudo grep image: $curCompose)"
  done
  # Special case for ClientDNS
  clientdns_stack_ids=($(echo $qry | jq '.[] | select (.Name | startswith("clientdns-")) | .Id'))
  clientdns_stack_names=($(echo $qry | jq -r '.[] | select (.Name | startswith("clientdns-")) | .Name'))
  i=-1
  for curStackID in "${clientdns_stack_ids[@]}"
  do
    i=$((i+1))
    echo "Versioning ${clientdns_stack_names[i]} stack..."
    curCompose=$HSHQ_STACKS_DIR/portainer/compose/$curStackID/docker-compose.yml
    curVersion=v1
    curImageList=jpillora/dnsmasq:1.1,linuxserver/wireguard:1.0.20210914
    if [ "$(insertVersionNumber ${clientdns_stack_names[i]} $curVersion $curImageList $curCompose)" = "true" ]; then continue;fi
    strSetVersionReport="${strSetVersionReport}\n clientdns stack version not found. All images from this stack:\n$(sudo grep image: $curCompose)"
  done
}

function installHostNTPServer()
{
  if [[ "$(isProgramInstalled ntpq)" = "false" ]]; then
    echo "Installing ntp server, please wait..."
    sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
    performAptInstall ntp > /dev/null 2>&1
  fi
  set +e
  grep "127.127.1.0" /etc/ntp.conf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "server  127.127.1.0" | sudo tee -a /etc/ntp.conf >/dev/null
    echo "fudge   127.127.1.0 stratum 10" | sudo tee -a /etc/ntp.conf >/dev/null
  fi
  sudo systemctl enable ntp > /dev/null 2>&1
  sudo systemctl restart ntp > /dev/null 2>&1
}

function notifyRSLogin()
{
  echo -e "\n\nThe RelayServer requires an update which requires root privileges."
  echo -e "You will be prompted for your sudo password on the RelayServer.\n"
  echo -e "Enter either 'update' to perform the update or 'bypass' to ignore it."
  echo -e "Only choose bypass if you no longer have access to the RelayServer."
  echo -e "Otherwise, you'll have to manually perform the necessary updates."
  is_continue=""
  while ! [ "$is_continue" = "update" ] && ! [ "$is_continue" = "bypass" ]
  do
    read -r -p "Enter 'update' to perform the update or 'bypass' to ignore: " is_continue
    if [ "$is_continue" = "bypass" ]; then
      is_confirm=""
      while ! [ "$is_confirm" = "confirm" ] && ! [ "$is_confirm" = "cancel" ]
      do
        echo -e "           @@@@@@@@@@ !!! WARNING !!! @@@@@@@@@@"
        echo -e "This could cause unforseen side effects to your RelayServer."
        echo -e "Certain functions with your network, etc. might not work properly."
        echo -e "Only select this option if you no longer have access to this"
        echo -e "server, and you intend to remove it and create a new one.\n\n"
        read -r -p "Enter 'confirm' or 'cancel': " is_confirm
      done
      if [ "$is_confirm" = "cancel" ]; then
        is_continue=""
      fi
    fi
  done
  if [ "$is_continue" = "update" ]; then
    return 0
  elif [ "$is_continue" = "bypass" ]; then
    return 1
  else
    return 2
  fi
}

function checkAddServiceToConfig()
{
  casc_curE=${-//[^e]/}
  service_name="$1"
  variable_list=$2
  set +e
  grep "# $service_name (Service Details)" $CONFIG_FILE > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    replace_block="# $service_name (Service Details) BEGIN\n"
    varListArr=($(echo $variable_list | tr "," "\n"))
    for curVar in "${varListArr[@]}"
    do
      replace_block=$replace_block"${curVar}\n"
    done
    replace_block=$replace_block"# $service_name (Service Details) END\n\n# Service Details END"
    sed -i "s|# Service Details END|$replace_block|g" $CONFIG_FILE
  fi
  set +e
  if ! [ -z "$casc_curE" ]; then
    set -e
  fi
}

function checkAddVarsToServiceConfig()
{
  cavc_curE=${-//[^e]/}
  service_name="$1"
  variable_list="$2"
  set +e
  varListArr=($(echo $variable_list | tr "," "\n"))
  for curVar in "${varListArr[@]}"
  do
    curVarCheck=$(echo $curVar | cut -d"=" -f1)"="
    grep "$curVarCheck" $CONFIG_FILE > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      replace_block="$curVar\n# $service_name (Service Details) END"
      sed -i "s|# $service_name (Service Details) END|$replace_block|g" $CONFIG_FILE
    fi
  done
  set +e
  if ! [ -z "$cavc_curE" ]; then
    set -e
  fi
}

function removeServiceFromConfig()
{
  rsfc_curE=${-//[^e]/}
  service_name=$1
  set +e
  grep "# $service_name (Service Details)" $CONFIG_FILE > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    removeTextBlockInFile "# $service_name (Service Details) BEGIN" "# $service_name (Service Details) END" $CONFIG_FILE
  fi
  set +e
  if ! [ -z "$rsfc_curE" ]; then
    set -e
  fi
}

function outputScripts()
{
  outputBootScripts
  outputDBExportScripts
  outputWireGuardScripts
  outputMaintenanceScripts
}

function nukeHSHQ()
{
  set +e
  if [ -z "$HSHQ_BASE_DIR" ]; then HSHQ_BASE_DIR=$HOME/hshq; fi
  if [ -z "$HSHQ_WIREGUARD_DIR" ]; then HSHQ_WIREGUARD_DIR=$HOME/hshq/data/wireguard; fi
  if [ -z "$HSHQ_SCRIPTS_DIR" ]; then HSHQ_SCRIPTS_DIR=$HOME/hshq/data/scripts; fi
  clear
  echo
  echo
  echo
  echo
  echo "============================================================"
  echo "This script will entirely remove HSHQ and all artifacts."
  echo "It will permanently delete ALL data except for the backup"
  echo "directory and reboot upon completion."
  echo "It will not delete any previously downloaded docker images."
  echo "In order to remove them as well, type 'docker image prune -f'"
  echo "Please type 'nuclear' in order to continue."
  echo "============================================================"
  echo
  echo
  read -r -p "Type 'nuclear' (no quotes): " isnuke
  if ! [ "$isnuke" = "nuclear" ]; then
    echo "String does not match, exiting..."
    return 1
  fi
  sudo -k
  sudo crontab -r
  killall ssh-agent > /dev/null 2>&1
  sudo docker ps -q | xargs sudo docker stop
  sleep 5
  sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternetDownAll.sh
  sudo $HSHQ_SCRIPTS_DIR/root/clearRoutingTable.sh
  sudo rm -f /etc/networkd-dispatcher/routable.d/performNetworkingChecks.sh
  sudo rm -f /etc/NetworkManager/dispatcher.d/performNetworkingChecks.sh
  sudo systemctl stop runOnBootRootBeforeNetwork
  sudo systemctl disable runOnBootRootBeforeNetwork
  sudo rm -f /etc/systemd/system/runOnBootRootBeforeNetwork.service
  sudo systemctl stop runOnBootRootAfterDocker
  sudo systemctl disable runOnBootRootAfterDocker
  sudo rm -f /etc/systemd/system/runOnBootRootAfterDocker.service
  sudo systemctl stop runScriptServer
  sudo systemctl disable runScriptServer
  sudo rm -f /etc/systemd/system/runScriptServer.service
  performClearIPTables false
  sudo rm -f /etc/sysctl.d/88-hshq.conf
  sudo sysctl --system > /dev/null 2>&1
  sudo docker container prune -f
  sudo docker volume rm $(sudo docker volume ls -q)
  sudo docker network prune -f
  sudo ls /etc/wireguard | while read fname
  do
    bname=$(basename $fname .conf)
    removeWGInterfaceQuick $bname
  done
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  sudo systemctl status systemd-resolved > /dev/null 2>&1
  if [ $? -ne 4 ]; then
    sudo systemctl enable systemd-resolved > /dev/null 2>&1
    sudo systemctl start systemd-resolved > /dev/null 2>&1
    sudo ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf
  else
    echo "nameserver 9.9.9.9" | sudo tee /etc/resolv.conf
  fi
  sudo systemctl restart docker
  sudo docker container prune -f
  sudo docker volume rm $(sudo docker volume ls -q)
  sudo docker network prune -f
  removeWazuhAgent
  sudo rm -f /usr/local/share/ca-certificates/*
  sudo update-ca-certificates
  sudo systemctl stop docker
  sudo systemctl start docker
  sudo rm -fr $HSHQ_BASE_DIR/data
  sudo rm -fr $HSHQ_BASE_DIR/nonbackup
  sudo rm -fr $HSHQ_BASE_DIR/*.log
  sudo rm -fr $HSHQ_INSTALL_CFG
  sudo rm -fr $HOME/.ssh/*
  sudo rm -f /etc/update-motd.d/88-hshq
  if [ -f /etc/motd.old ]; then
    sudo mv /etc/motd.old /etc/motd
  else
    sudo chmod +x /etc/update-motd.d/*
  fi
  for curLock in $ALL_LOCKS
  do
    releaseLock $curLock "nukem" true
  done
  if [ "$IS_DESKTOP_ENV" = "true" ]; then
    rm -f "/home/$USERNAME/Desktop/$HSHQ_INSTALL_NOTES_FILENAME"
    rm -f ~/Desktop/HomePage.desktop
    rm -f ~/Desktop/HSHQConsole.desktop
    rm -f ~/Desktop/HSHQScriptServer.desktop
    sudo rm -f /usr/share/applications/HomePage.desktop
    sudo rm -f /usr/share/applications/HSHQConsole.desktop
    sudo rm -f /usr/share/applications/HSHQScriptServer.desktop
    which terminator > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      # Specify terminator as console if possible
      cat <<EOFHP > ~/Desktop/InstallHSHQ.desktop
[Desktop Entry]
Name=Install HSHQ
Exec=/usr/bin/terminator -x bash -ic "~/hshq.sh"
Comment=Starts the HSHQ installation script
Icon=/usr/share/icons/HSHQ/InstallHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    else
      cat <<EOFHP > ~/Desktop/InstallHSHQ.desktop
[Desktop Entry]
Name=Install HSHQ
Exec=bash -ic "~/hshq.sh"
Terminal=true
Comment=Starts the HSHQ installation script
Icon=/usr/share/icons/HSHQ/InstallHSHQ.png
Type=Application
Categories=HomeServerHQ
EOFHP
    fi
    chmod 755 ~/Desktop/InstallHSHQ.desktop
    trustDesktopIcon "InstallHSHQ.desktop"
    sudo cp -f ~/Desktop/InstallHSHQ.desktop /usr/share/applications/
    tryDeleteRootCAFirefox
  fi
  rm -f "/home/$USERNAME/$HSHQ_INSTALL_NOTES_FILENAME"
  exit 2
}

function outputBootScripts()
{
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot/beforenetwork
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/onBootRootBeforeNetwork.sh
  sudo tee $HSHQ_SCRIPTS_DIR/boot/onBootRootBeforeNetwork.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 500 $HSHQ_SCRIPTS_DIR/boot/beforenetwork/*.sh
run-parts --regex '.*sh\$' $HSHQ_SCRIPTS_DIR/boot/beforenetwork
EOFBS
  sudo chmod 500 $HSHQ_SCRIPTS_DIR/boot/onBootRootBeforeNetwork.sh

  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/runOnBootRootBeforeNetwork.service
  sudo tee $HSHQ_SCRIPTS_DIR/boot/runOnBootRootBeforeNetwork.service >/dev/null <<EOFBS
[Unit]
Description=HSHQ Startup Script (Before Network)
DefaultDependencies=no

Before=network-pre.target
Wants=network-pre.target

Wants=systemd-modules-load.service local-fs.target
After=systemd-modules-load.service local-fs.target

Conflicts=shutdown.target
Before=shutdown.target

[Service]
Type=oneshot
RemainAfterExit=no
ExecStart=$HSHQ_SCRIPTS_DIR/boot/onBootRootBeforeNetwork.sh

[Install]
WantedBy=multi-user.target
EOFBS
  sudo chmod 644 $HSHQ_SCRIPTS_DIR/boot/runOnBootRootBeforeNetwork.service
  sudo chown root:root $HSHQ_SCRIPTS_DIR/boot/runOnBootRootBeforeNetwork.service
  sudo rm -f /etc/systemd/system/runOnBootRootBeforeNetwork.service
  sudo ln -s $HSHQ_SCRIPTS_DIR/boot/runOnBootRootBeforeNetwork.service /etc/systemd/system/runOnBootRootBeforeNetwork.service
  sudo systemctl daemon-reload
  sudo systemctl enable runOnBootRootBeforeNetwork

  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot/afterdocker
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/onBootRootAfterDocker.sh
  sudo tee $HSHQ_SCRIPTS_DIR/boot/onBootRootAfterDocker.sh >/dev/null <<EOFBS
#!/bin/bash
set +e

chmod 500 $HSHQ_SCRIPTS_DIR/boot/afterdocker/*.sh
run-parts --regex '.*sh\$' $HSHQ_SCRIPTS_DIR/boot/afterdocker
EOFBS
  sudo chmod 500 $HSHQ_SCRIPTS_DIR/boot/onBootRootAfterDocker.sh

  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/runOnBootRootAfterDocker.service
  sudo tee $HSHQ_SCRIPTS_DIR/boot/runOnBootRootAfterDocker.service >/dev/null <<EOFBS
[Unit]
Description=HSHQ Startup Script (After Docker)
After=docker.service runOnBootRootBeforeNetwork.service
BindsTo=docker.service
Requires=runOnBootRootBeforeNetwork.service

[Service]
Type=oneshot
ExecStart=$HSHQ_SCRIPTS_DIR/boot/onBootRootAfterDocker.sh
RemainAfterExit=no

[Install]
WantedBy=multi-user.target
EOFBS
  sudo chmod 644 $HSHQ_SCRIPTS_DIR/boot/runOnBootRootAfterDocker.service
  sudo chown root:root $HSHQ_SCRIPTS_DIR/boot/runOnBootRootAfterDocker.service
  sudo rm -f /etc/systemd/system/runOnBootRootAfterDocker.service
  sudo ln -s $HSHQ_SCRIPTS_DIR/boot/runOnBootRootAfterDocker.service /etc/systemd/system/runOnBootRootAfterDocker.service
  sudo systemctl daemon-reload
  sudo systemctl enable runOnBootRootAfterDocker

  outputUpdateIPTablesBeforeNetworkBootscript
  outputPerformPostDockerBootActionsScript
}

function checkUpdateAllIPTables()
{
  set +e
  # This function is automatically executed at three different times:
  # prenetwork, postdocker, and maintenance (on a regular schedule, likely every minute).
  # It can also be executed on-demand pertaining to changes by the user.
  netstate="$1"
  isLogInfo=true
  echo "$netstate" | grep "cronjob" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    isLogInfo=false
  fi
  if [ "$isLogInfo" = "true" ]; then
    logHSHQEvent info "checkUpdateAllIPTables ($netstate) - BEGIN"
  fi
  # If one wants to run any script(s) prior to this function,
  # then create the following bash script accordingly. There
  # is also a post script hook at the end of this function.
  if [ -f $HSHQ_CUSTOM_PRE_IPTABLES_SCRIPT ]; then
    bash $HSHQ_CUSTOM_PRE_IPTABLES_SCRIPT "$netstate"
  fi

  isInit=false
  sudo iptables -t raw -n -L chain-icmp > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    isInit=true
  fi
  sudo iptables -t raw -n -L chain-bad_tcp > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    isInit=true
  fi
  sudo iptables -t raw -n -L chain-ipspoof > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    isInit=true
  fi
  sudo iptables -t filter -n -L DOCKER-USER > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    isInit=true
  fi

  if [ "$netstate" = "prenetwork" ] || [ "$isInit" = "true" ]; then
    logHSHQEvent info "checkUpdateAllIPTables ($netstate) - Initializing chains..."
    sudo iptables -t raw -F PREROUTING > /dev/null 2>&1
    sudo iptables -t raw -F chain-icmp > /dev/null 2>&1
    sudo iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
    sudo iptables -t raw -F chain-ipspoof > /dev/null 2>&1
    sudo iptables -t raw -X chain-icmp > /dev/null 2>&1
    sudo iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
    sudo iptables -t raw -X chain-ipspoof > /dev/null 2>&1
    sudo iptables -t raw -N chain-icmp > /dev/null 2>&1
    sudo iptables -t raw -N chain-bad_tcp > /dev/null 2>&1
    sudo iptables -t raw -N chain-ipspoof > /dev/null 2>&1
    comment="HSHQ_BEGIN INPUT Temp Keep Established HSHQ_END"
    sudo iptables -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "$comment" -j ACCEPT > /dev/null 2>&1
    while true;
    do
      sudo iptables -L INPUT -n --line-numbers | cut -d" " -f1 | grep "2" > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        sudo iptables -D INPUT 2 > /dev/null 2>&1
      else
        break
      fi
    done
    sudo iptables -t filter -F DOCKER-USER > /dev/null 2>&1
    sudo iptables -t filter -N DOCKER-USER > /dev/null 2>&1
    sudo iptables -t raw -A PREROUTING -p icmp -j chain-icmp > /dev/null 2>&1
    sudo iptables -t raw -A PREROUTING -j chain-ipspoof > /dev/null 2>&1
    sudo iptables -t raw -A PREROUTING -p tcp -m tcp -j chain-bad_tcp > /dev/null 2>&1
    sudo iptables -t raw -P PREROUTING ACCEPT > /dev/null 2>&1
  fi

  # Docker likes to append this during boot
  sudo iptables -D DOCKER-USER -j RETURN > /dev/null 2>&1

  sudo iptables -t filter -n -L > /tmp/ipt.txt
  sudo iptables -t raw -n -L >> /tmp/ipt.txt
  sudo rm -f /tmp/newRules.txt
  touch /tmp/newRules.txt

  # See https://gist.github.com/mattia-beta/bd5b1c68e3d51db933181d8a3dc0ba64?permalink_comment_id=3728715#gistcomment-3728715
  # chain-icmp
  comment="HSHQ_BEGIN chain-icmp echo-reply HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type echo-reply -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp network-unreachable HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type network-unreachable -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp host-unreachable HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type host-unreachable -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp protocol-unreachable HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type protocol-unreachable -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp port-unreachable HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type port-unreachable -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp fragmentation-needed HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type fragmentation-needed -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp echo-request all HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type echo-request -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp time-exceeded HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type time-exceeded -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp parameter-problem HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type parameter-problem -m comment --comment "$comment" -j ACCEPT'
  comment="HSHQ_BEGIN chain-icmp any HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-icmp -p icmp -m icmp --icmp-type any -m comment --comment "$comment" -j DROP'

  # chain-bad_tcp
  comment="HSHQ_BEGIN chain-bad_tcp 01 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 02 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,SYN FIN,SYN -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 03 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,RST SYN,RST -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 04 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags SYN,FIN SYN,FIN -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 05 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,RST FIN,RST -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 06 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags FIN,ACK FIN -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 07 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,URG URG -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 08 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,FIN FIN -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 09 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ACK,PSH PSH -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 10 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL ALL -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 11 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL NONE -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 12 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL FIN,PSH,URG -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 13 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-bad_tcp 14 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-bad_tcp -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -m comment --comment "$comment" -j DROP'

  # chain-ipspoof
  comment="HSHQ_BEGIN chain-ipspoof tcp multiport HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof -p tcp -m tcp -m multiport --ports 0 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof udp multiport HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof -p udp -m udp -m multiport --ports 0 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -s 192.0.0.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s 192.0.0.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -s 192.0.2.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s 192.0.2.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -s 198.51.100.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s 198.51.100.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -s 203.0.113.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s 203.0.113.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -d 192.0.0.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -d 192.0.0.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -d 192.0.2.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -d 192.0.2.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -d 198.51.100.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -d 198.51.100.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -d 203.0.113.0/24 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -d 203.0.113.0/24 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -d 0.0.0.0/8 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -d 0.0.0.0/8 -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof -s 127.0.0.0/8 ! -i lo HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s 127.0.0.0/8 ! -i lo -m comment --comment "$comment" -j DROP'

  # INPUT
  # Insert these at the top
  # Drop fragments
  comment="HSHQ_BEGIN INPUT fragments HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -I INPUT -f -m comment --comment "$comment" -j DROP'
  # Allow established connections
  comment="HSHQ_BEGIN INPUT --ctstate ESTABLISHED,RELATED HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "$comment" -j ACCEPT'
  # Drop SYN packets with suspicious MSS value
  comment="HSHQ_BEGIN INPUT suspicious MSS HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -I INPUT -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -m comment --comment "$comment" -j DROP'
  # Drop invalid packets
  comment="HSHQ_BEGIN INPUT --ctstate INVALID HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -I INPUT -m conntrack --ctstate INVALID -m comment --comment "$comment" -j DROP'
  # Limit connections per source IP
  comment="HSHQ_BEGIN INPUT --connlimit-above 200 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -I INPUT -p tcp --syn -m connlimit --connlimit-above 200 -m comment --comment "$comment" -j REJECT --reject-with tcp-reset'

  # Append any remaining to the bottom
  # Configure loopback
  comment="HSHQ_BEGIN INPUT allow loopback HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -i lo -m comment --comment "$comment" -j ACCEPT'
  # Allow ICMP
  comment="HSHQ_BEGIN INPUT allow ICMP HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p icmp -m comment --comment "$comment" -j ACCEPT'
  # Allow SSH
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp --dport $SSH_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp --dport $SSH_PORT -m comment --comment "$comment" -j ACCEPT'
  # Special case for HomeAssistant since it is using host networking
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -i $NET_EXTERNAL_BRIDGE_NAME -s $NET_EXTERNAL_SUBNET --dport $HOMEASSISTANT_LOCALHOST_PORT  HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -i $NET_EXTERNAL_BRIDGE_NAME -s $NET_EXTERNAL_SUBNET --dport $HOMEASSISTANT_LOCALHOST_PORT -m comment --comment "$comment" -j ACCEPT'
  # Special case for Script-server since it is using host networking
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -i $NET_EXTERNAL_BRIDGE_NAME -s $NET_EXTERNAL_SUBNET --dport $SCRIPTSERVER_LOCALHOST_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -i $NET_EXTERNAL_BRIDGE_NAME -s $NET_EXTERNAL_SUBNET --dport $SCRIPTSERVER_LOCALHOST_PORT -m comment --comment "$comment" -j ACCEPT'
  # Special case for Docker metrics
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -i $NET_PRIVATEIP_BRIDGE_NAME -s $NET_PRIVATEIP_SUBNET --dport $DOCKER_METRICS_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -i $NET_PRIVATEIP_BRIDGE_NAME -s $NET_PRIVATEIP_SUBNET --dport $DOCKER_METRICS_PORT -m comment --comment "$comment" -j ACCEPT'
  # Allow HTTPS for Docker networks
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $CADDY_HTTPS_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $CADDY_HTTPS_PORT -m comment --comment "$comment" -j ACCEPT'
  # Allow NTP for Docker networks
  comment="HSHQ_BEGIN INPUT -s $DOCKER_NETWORK_RESERVED_RANGE -p udp --dport 123 HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -s $DOCKER_NETWORK_RESERVED_RANGE -p udp --dport 123 -m comment --comment "$comment" -j ACCEPT'
  # Allow Coturn Primary TCP for Docker networks
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_PRIMARY_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_PRIMARY_PORT -m comment --comment "$comment" -j ACCEPT'
  # Allow Coturn Primary UDP for Docker networks
  comment="HSHQ_BEGIN INPUT -p udp -m udp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_PRIMARY_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p udp -m udp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_PRIMARY_PORT -m comment --comment "$comment" -j ACCEPT'
  # Allow Coturn Secondary TCP for Docker networks
  comment="HSHQ_BEGIN INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_SECONDARY_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_SECONDARY_PORT -m comment --comment "$comment" -j ACCEPT'
  # Allow Coturn Secondary UDP for Docker networks
  comment="HSHQ_BEGIN INPUT -p udp -m udp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_SECONDARY_PORT HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -A INPUT -p udp -m udp -s $DOCKER_NETWORK_RESERVED_RANGE --dport $COTURN_SECONDARY_PORT -m comment --comment "$comment" -j ACCEPT'

  if ! [ -z "$IS_INSTALLED" ] && [ "$IS_INSTALLED" = "false" ] && ! [ -z "$CURRENT_SSH_PORT" ] && ! [ "$CURRENT_SSH_PORT" = "$SSH_PORT" ]; then
    comment="HSHQ_BEGIN Temp allow SSH port $CURRENT_SSH_PORT HSHQ_END"
    checkAddRule "$comment" 'sudo iptables -A INPUT -p tcp -m tcp --dport $CURRENT_SSH_PORT -m comment --comment "$comment" -j ACCEPT'
  fi

  # HomeServer Host and WireGuard interfaces
  dbIDArr=($(sqlite3 $HSHQ_DB "select ID from connections where (ConnectionType='homeserver_vpn' and NetworkType in ('primary','other')) or (NetworkType='home_network') order by NetworkType;"))
  for curDBID in "${dbIDArr[@]}"
  do
    curInterfaceName=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID=$curDBID;")
    curIPAddress=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID=$curDBID;")
    curSubnet=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections where ID=$curDBID;")
    curIsExposeToNetwork=$(sqlite3 $HSHQ_DB "select IsExposeToNetwork from connections where ID=$curDBID;")
    curInputAllowPorts=$(sqlite3 $HSHQ_DB "select InputAllowPorts from connections where ID=$curDBID;")
    curDockerUserAllowPorts=$(sqlite3 $HSHQ_DB "select DockerUserAllowPorts from connections where ID=$curDBID;")
    curNetworkType=$(sqlite3 $HSHQ_DB "select NetworkType from connections where ID=$curDBID;")
    curConnectionType=$(sqlite3 $HSHQ_DB "select ConnectionType from connections where ID=$curDBID;")
    curIsIPPrivate="$(checkIsIPPrivate $curIPAddress)"
    if ! [ "$(checkValidIPAddress $curIPAddress)" = "true" ]; then
      continue
    fi
    if [ "$curIPAddress" = "$DEFAULT_UNFOUND_IP_ADDRESS" ] || [ "$curIPAddress" = "127.0.0.1" ]; then
      curIsIPPrivate=true
    else
      if [ "$curIsIPPrivate" = "true" ]; then
        if [ "$curIsExposeToNetwork" = "1" ]; then
          hn_ip_list=$curSubnet
        else
          hn_ip_list=${curIPAddress}/32
        fi
      else
        hn_ip_list=${curIPAddress}/32,${HOMENET_ADDITIONAL_IPS}
      fi
      appendINPUTBySubnetAndPortsList "$hn_ip_list" "$curInputAllowPorts"
      addDOCKERUSERBySubnetAndPortsList "$hn_ip_list" "$curDockerUserAllowPorts"
    fi
    # Add some anti-spoofing measures
    if [ "$curConnectionType" = "homeserver_vpn" ]; then
      addIPTablesSpoofRule "$curInterfaceName" "$curSubnet"
    elif [ "$curNetworkType" = "home_network" ]; then
      comment="HSHQ_BEGIN chain-ipspoof -s $DOCKER_NETWORK_RESERVED_RANGE -i $curInterfaceName HSHQ_END"
      checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s $DOCKER_NETWORK_RESERVED_RANGE -i $curInterfaceName -m comment --comment "$comment" -j DROP'
      if [ "$curIsIPPrivate" = "false" ]; then
        # Add special rules when HomeServer interface is on non-private network, i.e. cloud-server, etc.
        # Insert these at the 3rd position down
        comment="HSHQ_BEGIN chain-ipspoof -s 10.0.0.0/8 -i $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s 10.0.0.0/8 -i $curInterfaceName -m comment --comment "$comment" -j DROP'
        comment="HSHQ_BEGIN chain-ipspoof -s 172.16.0.0/12 -i $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s 172.16.0.0/12 -i $curInterfaceName -m comment --comment "$comment" -j DROP'
        comment="HSHQ_BEGIN chain-ipspoof -s 192.168.0.0/16 -i $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s 192.168.0.0/16 -i $curInterfaceName -m comment --comment "$comment" -j DROP'
        comment="HSHQ_BEGIN chain-ipspoof -s 169.254.0.0/16 -i $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s 169.254.0.0/16 -i $curInterfaceName -m comment --comment "$comment" -j DROP'
        comment="HSHQ_BEGIN chain-ipspoof -s 224.0.0.0/4 -i $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-ipspoof 3 -s 224.0.0.0/4 -i $curInterfaceName -m comment --comment "$comment" -j DROP'
        # Insert this to top of chain-icmp
        comment="HSHQ_BEGIN chain-icmp echo-request primary $curInterfaceName HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -t raw -I chain-icmp -p icmp -m icmp --icmp-type echo-request -i $curInterfaceName -m comment --comment "$comment" -j DROP'
      fi
    fi
  done

  # Custom rules
  dbIDArr=($(sqlite3 $HSHQ_DB "select ID from customfwsubnet;"))
  for curDBID in "${dbIDArr[@]}"
  do
    curSubnet=$(sqlite3 $HSHQ_DB "select Subnet from customfwsubnet where ID=$curDBID;")
    curInputAllowPorts=$(sqlite3 $HSHQ_DB "select InputAllowPorts from customfwsubnet where ID=$curDBID;")
    curDockerUserAllowPorts=$(sqlite3 $HSHQ_DB "select DockerUserAllowPorts from customfwsubnet where ID=$curDBID;")
    appendINPUTBySubnetAndPortsList "$curSubnet" "$curInputAllowPorts"
    addDOCKERUSERBySubnetAndPortsList "$curSubnet" "$curDockerUserAllowPorts"
  done

  # This following section is problematic for unnamed bridges, as it will
  # cause the user problems when stopping and starting stacks. We'll leave
  # the code in here for now, and perhaps loop back to this idea later.

  # Query docker networks and add some more anti-spoofing rules
#  if ! [ "$netstate" = "prenetwork" ]; then
#    timeout 10 docker ps > /dev/null 2>&1
#    if [ $? -eq 0 ]; then
#      networksArr=($(docker network ls -q))
#      for curNet in "${networksArr[@]}"
#      do
#        brName=$(docker network inspect $curNet | jq -r '.[] | .Options."com.docker.network.bridge.name"')
#        netName=$(docker network inspect $curNet | jq -r '.[] | .Name')
#        if [ "$netName" = "host" ] || [ "$netName" = "none" ]; then
#          continue
#        fi
#        if [ -z "$brName" ] || [ "$brName" = "null" ]; then
#          brName="br-${curNet}"
#        fi
#       ip a | grep $brName > /dev/null 2>&1
#       if [ $? -ne 0 ]; then
#          logHSHQEvent error "checkUpdateAllIPTables ($netstate) - Could not find bridge interface associated with docker network: $curNet"
#          continue
#        fi
#        brSubnet=$(docker network inspect $curNet | jq -r '.[] | .IPAM.Config[0].Subnet')
#        addIPTablesSpoofRule "$brName" "$brSubnet"
#      done
#    fi
#  fi

  # Compare rules on this pass with all exisitng rules,
  # Then delete any that do not match
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  tableArr=(raw filter)
  for curTable in "${tableArr[@]}"
  do
    allIPTCommentsArr=($(sudo iptables -t $curTable -n -L | grep -o "HSHQ_BEGIN.*HSHQ_END"))
    for curComment in "${allIPTCommentsArr[@]}"
    do
      grep "$curComment" /tmp/newRules.txt > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        curChain=$(echo $curComment | cut -d" " -f2 | xargs)
        deleteIPTableEntryByChainAndComment "$curTable" "$curChain" "$curComment"
      fi
    done
    unset allIPTCommentsArr
    allIPTCommentsArr=""
  done
  IFS=$OLDIFS

  # Policy drop for input and forward
  sudo iptables -P INPUT DROP
  sudo iptables -P FORWARD DROP
  # Policy drop all ipv6 traffic
  sudo ip6tables -P INPUT DROP
  sudo ip6tables -P FORWARD DROP
  sudo ip6tables -P OUTPUT DROP
  sudo ip6tables -t raw -P PREROUTING DROP
  sudo ip6tables -t raw -P OUTPUT DROP

  # If one wants to run a script right after this function,
  # then define the following bash script accordingly.
  if [ -f $HSHQ_CUSTOM_POST_IPTABLES_SCRIPT ]; then
    bash $HSHQ_CUSTOM_POST_IPTABLES_SCRIPT "$netstate"
  fi
  sudo rm -f /tmp/ipt.txt
  sudo rm -f /tmp/newRules.txt
  if [ "$isLogInfo" = "true" ]; then
    logHSHQEvent info "checkUpdateAllIPTables ($netstate) - END"
  fi
}

function checkAddRule()
{
  comment="$1"
  ip_cmd="$2"
  echo "$comment" >> /tmp/newRules.txt
  sudo grep "$comment" /tmp/ipt.txt > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    eval " $ip_cmd"
    if [ $? -ne 0 ]; then
      logHSHQEvent error "checkAddRule ($netstate) - Error adding rule: $ip_cmd"
    fi
    echo "$comment" >> /tmp/ipt.txt
    logHSHQEvent info "checkAddRule ($netstate) - Added rule: $comment"
  fi
}

function performClearIPTables()
{
  set +e
  isAllowExisting="$1"
  if [ -z "$isAllowExisting" ]; then
    isAllowExisting=false
  fi
  sudo iptables -P INPUT ACCEPT
  sudo ip6tables -P INPUT ACCEPT
  sudo ip6tables -P FORWARD ACCEPT
  sudo ip6tables -P OUTPUT ACCEPT
  if [ "$isAllowExisting" = "true" ]; then
    comment="HSHQ_BEGIN INPUT Temp Keep Established HSHQ_END"
    sudo iptables -I INPUT -m conntrack --ctstate ESTABLISHED,RELATED -m comment --comment "$comment" -j ACCEPT > /dev/null 2>&1
    while true;
    do
      sudo iptables -L INPUT -n --line-numbers | cut -d" " -f1 | grep "2" > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        sudo iptables -D INPUT 2 > /dev/null 2>&1
      else
        break
      fi
    done
  else
    sudo iptables -t filter -F INPUT
  fi
  sudo iptables -t filter -F DOCKER-USER
  sudo iptables -t raw -F PREROUTING
  sudo iptables -t raw -F chain-icmp > /dev/null 2>&1
  sudo iptables -t raw -F chain-bad_tcp > /dev/null 2>&1
  sudo iptables -t raw -F chain-ipspoof > /dev/null 2>&1
  sudo iptables -t raw -X chain-icmp > /dev/null 2>&1
  sudo iptables -t raw -X chain-bad_tcp > /dev/null 2>&1
  sudo iptables -t raw -X chain-ipspoof > /dev/null 2>&1
}

function appendINPUTBySubnetAndPortsList()
{
  subnetList="$1"
  portList="$2"
  if [ -z "$subnetList" ] ||  [ -z "$portList" ]; then
    return
  fi
  checkValidPortsList "$portList"
  if [ $? -ne 0 ]; then
    strMsg="There was an error with the ports list: $portList"
    logHSHQEvent error "appendINPUTBySubnetAndPortsList ($netstate) (appendINPUTBySubnetAndPortsList) - $strMsg"
    echo "ERROR: $strMsg"
    return
  fi
  portsArr=($(echo $portList | tr "," "\n"))
  subnetArr=($(echo $subnetList | tr "," "\n"))
  for cur_port in "${portsArr[@]}"
  do
    port_no=$(echo "$cur_port" | cut -d"/" -f1 | xargs)
    port_prot=$(echo "$cur_port" | cut -d"/" -f2 | xargs)
    for cur_subnet in "${subnetArr[@]}"
    do
      case $port_prot in
      tcp|udp)
        comment="HSHQ_BEGIN INPUT -s $cur_subnet -p $port_prot --dport $port_no HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -A INPUT -s $cur_subnet -p $port_prot --dport $port_no -m comment --comment "$comment" -j ACCEPT'
      ;;
      both)
        comment="HSHQ_BEGIN INPUT -s $cur_subnet -p tcp --dport $port_no HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -A INPUT -s $cur_subnet -p tcp --dport $port_no -m comment --comment "$comment" -j ACCEPT'
        comment="HSHQ_BEGIN INPUT -s $cur_subnet -p udp --dport $port_no HSHQ_END"
        checkAddRule "$comment" 'sudo iptables -A INPUT -s $cur_subnet -p udp --dport $port_no -m comment --comment "$comment" -j ACCEPT'
      ;;
      *)
      ;;
      esac
    done
  done
}

function addDOCKERUSERBySubnetAndPortsList()
{
  subnetList="$1"
  portList="$2"
  if [ -z "$subnetList" ] ||  [ -z "$portList" ]; then
    return
  fi
  checkValidPortsList "$portList"
  if [ $? -ne 0 ]; then
    strMsg="There was an error with the ports list: $portList"
    logHSHQEvent error "addDOCKERUSERBySubnetAndPortsList ($netstate) (addDOCKERUSERBySubnetAndPortsList) - $strMsg"
    echo "ERROR: $strMsg"
    return
  fi
  portsArr=($(echo $portList | tr "," "\n"))
  subnetArr=($(echo $subnetList | tr "," "\n"))
  for cur_port in "${portsArr[@]}"
  do
    # Protocol doesn't matter here, but just in case the user added it
    port_no=$(echo "$cur_port" | cut -d"/" -f1 | xargs)
    port_prot=$(echo "$cur_port" | cut -d"/" -f2 | xargs)
    for cur_subnet in "${subnetArr[@]}"
    do
      comment="HSHQ_BEGIN DOCKER-USER -s $cur_subnet -m conntrack --ctorigdstport $port_no HSHQ_END"
      checkAddRule "$comment" 'sudo iptables -I DOCKER-USER -s $cur_subnet -m conntrack --ctorigdstport $port_no --ctdir ORIGINAL -m comment --comment "$comment" -j RETURN'
      comment="HSHQ_BEGIN DOCKER-USER -s $DOCKER_NETWORK_RESERVED_RANGE -m conntrack --ctorigdstport $port_no HSHQ_END"
      checkAddRule "$comment" 'sudo iptables -I DOCKER-USER -s $DOCKER_NETWORK_RESERVED_RANGE -m conntrack --ctorigdstport $port_no --ctdir ORIGINAL -m comment --comment "$comment" -j RETURN'
      comment="HSHQ_BEGIN DOCKER-USER -m conntrack --ctorigdstport $port_no DROP HSHQ_END"
      checkAddRule "$comment" 'sudo iptables -A DOCKER-USER -m conntrack --ctorigdstport $port_no --ctdir ORIGINAL -m comment --comment "$comment" -j DROP'
    done
  done
}

function deleteIPTableEntryByChainAndComment()
{
  ipt_table="$1"
  ipt_chain="$2"
  ipt_comment="$3"
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  ipt_list=($(sudo iptables -t $ipt_table -n -L $ipt_chain --line-numbers | grep "$ipt_comment"))
  unset rule_list
  rule_list=""
  for cur_ipt in "${ipt_list[@]}"
  do
    rule_list+=( $(echo $cur_ipt | cut -d" " -f1 | xargs) )
  done
  sorted_list=($(echo "${rule_list[@]}" | tr ' ' '\n' | sort -r))
  isRuleFound=false
  for cur_rule in "${sorted_list[@]}"
  do
    sudo iptables -t $ipt_table -D $ipt_chain $cur_rule
    isRuleFound=true
    logHSHQEvent info "deleteIPTableEntryByChainAndComment ($netstate) - Removed rule: $ipt_comment"
  done
  if [ "$isRuleFound" = "false" ]; then
    logHSHQEvent error "deleteIPTableEntryByChainAndComment ($netstate) - Could not find rule to remove: $ipt_comment"
  fi
  IFS=$OLDIFS
}

function addIPTablesSpoofRule()
{
  ipt_interface_name="$1"
  ipt_source_subnet="$2"
  comment="HSHQ_BEGIN chain-ipspoof -s $ipt_source_subnet ! -i $ipt_interface_name HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof -s $ipt_source_subnet ! -i $ipt_interface_name -m comment --comment "$comment" -j DROP'
  comment="HSHQ_BEGIN chain-ipspoof ! -s $ipt_source_subnet -i $ipt_interface_name HSHQ_END"
  checkAddRule "$comment" 'sudo iptables -t raw -A chain-ipspoof ! -s $ipt_source_subnet -i $ipt_interface_name -m comment --comment "$comment" -j DROP'
}

function restartStacksOnBoot()
{
  # This script handles the chicken/egg paradox between Docker and WireGuard during boot.
  # Each Caddy instance is bound to a specific interface - in most cases, a WireGuard interface.
  # Each WireGuard VPN interface uses a domain name as opposed to an IP address for the endpoint.
  # The domain name requires a DNS lookup, which is handled by AdguardHome - in a Docker container.
  # Thus, given this setup, the WireGuard interfaces will not come up until the AdGuard container is up.
  # Unfortunately, this causes a race condition with the Caddy containers that are bound to 
  # specific WireGuard interfaces - they will fail to start if the interface doesn't exist.
  # Attempts were made within the systemd service files to start one after the other, but it still results
  # in a circular reference problem. Even manually starting the VPN interfaces before docker.service with 
  # wg rather than wg-quick fails due to wg setconf errors on an unknown endpoint. So this script, which runs
  # at boot, will wait until the interfaces are up, then start/restart the Caddy containers.
  # This script also restarts some other stacks that have issues after a reboot.
  set +e
  num_tries=1
  total_tries=20
  logHSHQEvent info "restartStacksOnBoot - BEGIN"
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  retVal=$?
  while [ $retVal -ne 0 ] && [ $num_tries -lt $total_tries ]
  do
    sleep 10
    ((num_tries++))
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
    retVal=$?
  done
  logHSHQEvent info "restartStacksOnBoot - Got Portainer token..."
  if [ $retVal -eq 0 ]; then
    logHSHQEvent info "restartStacksOnBoot - Restarting HomeAssistant stack (if running)..."
    restartStackIfRunning homeassistant 15 $portainerToken > /dev/null
    if [ $retVal -ne 0 ]; then
      logHSHQEvent error "restartStacksOnBoot - Problem restarting HomeAssistant stack..."
    fi
  else
    logHSHQEvent error "restartStacksOnBoot - Error obtaining Portainer token..."
  fi
  logHSHQEvent info "restartStacksOnBoot - Pinging WireGuard connections..."
  ips_arr=($(sqlite3 $HSHQ_DB "select IPAddress from connections where ConnectionType='homeserver_vpn' and NetworkType in ('primary','other');"))
  ns_sleep=5
  ping_timeout=5
  max_tries=15
  is_error=false
  for cur_ip in "${ips_arr[@]}"
  do
    is_up=false
    cur_tries=1
    while [ $cur_tries -le $max_tries ] && [ "$is_up" = "false" ]
    do
      timeout $ping_timeout ping -c 1 $cur_ip > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        is_up=true
      else
        ((cur_tries++))
        sleep $ns_sleep
      fi
    done
  done
  logHSHQEvent info "restartStacksOnBoot - Restarting caddy stacks..."
  caddy_arr=($(docker ps -a --filter name=caddy- --format "{{.Names}}"))
  for curcaddy in "${caddy_arr[@]}"
  do
    startStopStack $curcaddy stop
    docker container stop $curcaddy
    docker container rm $curcaddy
    sleep 1
    startStopStack $curcaddy start
  done
  isCoturn=$(docker ps -a --filter name=coturn --format "{{.Names}}")
  if ! [ -z "$isCoturn" ]; then
    logHSHQEvent info "restartStacksOnBoot - Restarting coturn stack..."
    startStopStack coturn stop > /dev/null 2>&1
    sleep 1
    startStopStack coturn start > /dev/null 2>&1
  fi
  logHSHQEvent info "restartStacksOnBoot - END"
}

function outputDBExportScripts()
{
  rm -f $HSHQ_SCRIPTS_DIR/user/exportPostgres.sh
  cat <<EOFDB > $HSHQ_SCRIPTS_DIR/user/exportPostgres.sh
#!/bin/bash

set -e
PGPASSWORD=\$POSTGRES_PASSWORD
if [ -z "\$PGPASSWORD" ]; then
  echo "ERROR: Password not set"
  exit 1
fi
pg_dump --username \$POSTGRES_USER \$POSTGRES_DB > /dbexport/dbexport.tmp
outputfilesize=\$(du -sh /dbexport/dbexport.tmp | xargs | cut -d ' ' -f1)
mv /dbexport/dbexport.tmp /dbexport/\$POSTGRES_DB.sql
chmod 0400 /dbexport/\$POSTGRES_DB.sql
echo "Success - Filesize is \$outputfilesize"
EOFDB
  chmod 0555 $HSHQ_SCRIPTS_DIR/user/exportPostgres.sh

  rm -f $HSHQ_SCRIPTS_DIR/user/exportMySQL.sh
  cat <<EOFDB > $HSHQ_SCRIPTS_DIR/user/exportMySQL.sh
#!/bin/bash

set -e
mysqldump --user \$MYSQL_USER --password=\$MYSQL_PASSWORD \$MYSQL_DATABASE > /dbexport/dbexport.tmp
outputfilesize=\$(du -sh /dbexport/dbexport.tmp | xargs | cut -d ' ' -f1)
mv /dbexport/dbexport.tmp /dbexport/\$MYSQL_DATABASE.sql
chmod 0400 /dbexport/\$MYSQL_DATABASE.sql
echo "Success - Filesize is \$outputfilesize"
EOFDB
  chmod 0555 $HSHQ_SCRIPTS_DIR/user/exportMySQL.sh
}

function outputMaintenanceScripts()
{
  if [[ "$(isProgramInstalled networkd-dispatcher)" = "false" ]]; then
    echo "Installing networkd-dispatcher, please wait..."
    sudo DEBIAN_FRONTEND=noninteractive apt update > /dev/null 2>&1
    performAptInstall networkd-dispatcher > /dev/null 2>&1
  fi
  sudo systemctl enable networkd-dispatcher > /dev/null 2>&1
  sudo systemctl start networkd-dispatcher > /dev/null 2>&1

  sudo rm -f $HSHQ_SCRIPTS_DIR/userasroot/updateLECerts.sh
  sudo tee $HSHQ_SCRIPTS_DIR/userasroot/updateLECerts.sh >/dev/null <<EOFCS
#!/bin/bash
set +e

search_dir=$HSHQ_STACKS_DIR/caddy-common/primary-certs
le_dir=$HSHQ_STACKS_DIR/caddy-common/lecerts

function main()
{
  acme_dir=\$(find \$search_dir -name "acme-*" | xargs | cut -d" " -f1)
  is_new_certs=false
  if ! [ -z "\$acme_dir" ]; then
    certList=(\$(find \$acme_dir -name "*.crt"))
    for curCert in "\${certList[@]}"
    do
      bname=\$(basename \$curCert)
      if ! [ -f \$le_dir/\$bname ]; then
        cp -f \${curCert%.*}.* \$le_dir/
        is_new_certs=true
        continue
      fi
      diff \$curCert \$le_dir/\$bname >/dev/null
      if [ \$? -ne 0 ]; then
        startD_curCert=\$(date --date="\$(openssl x509 -noout -startdate -in \$curCert | cut -d"=" -f2)" "+%Y%m%d%H%M%S")
        startD_leCert=\$(date --date="\$(openssl x509 -noout -startdate -in \$le_dir/\$bname | cut -d"=" -f2)" "+%Y%m%d%H%M%S")
        if [ \$startD_curCert -gt \$startD_leCert ]; then
          cp -f \${curCert%.*}.* \$le_dir/
          is_new_certs=true
        fi
      fi
    done
    if [ "\$is_new_certs" = "true" ]; then
      docker ps --filter name=caddy- -aq | xargs docker restart > /dev/null 2>&1
    fi
  fi
}

main "\$@"
EOFCS
  sudo chmod 0500 $HSHQ_SCRIPTS_DIR/userasroot/updateLECerts.sh
  sudo chown root:root $HSHQ_SCRIPTS_DIR/userasroot/updateLECerts.sh

  sudo rm -f $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh
  sudo tee $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh >/dev/null <<EOFMS
#!/bin/bash

stacks_dir=$HSHQ_STACKS_DIR
source <(sudo cat $HSHQ_PLAINTEXT_ROOT_CONFIG)
source $HSHQ_PLAINTEXT_USER_CONFIG

caddy_stack=\$1
portainerToken=""
function main()
{
  startStopStack \$caddy_stack stop
  rm -fr \$stacks_dir/\$caddy_stack/config/*
  rm -fr \$stacks_dir/\$caddy_stack/data/*
  startStopStack \$caddy_stack start
}

function startStopStack()
{
  stackname=\$1
  startStop=\$2
  if [ -z "\$portainerToken" ]; then
    portainerToken="\$(getPortainerToken)"
  fi
  stackID=\$(getStackID \$stackname "\$portainerToken")
  http --check-status --ignore-stdin --verify=no --timeout=300 POST https://127.0.0.1:\$PORTAINER_LOCAL_HTTPS_PORT/api/stacks/\$stackID/\$startStop "Authorization: Bearer \$portainerToken" endpointId==1 > /dev/null
}

function getPortainerToken()
{
  echo \$(http --check-status --ignore-stdin --verify=no https://127.0.0.1:\$PORTAINER_LOCAL_HTTPS_PORT/api/auth username=\$PORTAINER_ADMIN_USERNAME password=\$PORTAINER_ADMIN_PASSWORD | jq -r .jwt)
}

function getStackID()
{
  stackID="NA"
  stackName=\$1
  stackName="\${stackName//.}"
  portainerToken=\$2
  qry=\$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:\$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer \$portainerToken" endpointId==1)
  for row in \$(echo "\${qry}" | jq -r '.[] | @base64'); do
    _jq()
    {
      echo \${row} | base64 --decode | jq -r \${1}
    }
    if [ \$(_jq '.Name') = \$stackName ]; then
      stackID=\$(_jq '.Id')
	  break
    fi
  done
  if ! [ \$stackID = "NA" ]; then
    echo \$stackID
  fi
}

main "\$@"

EOFMS
  sudo chmod 0500 $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh
  sudo chown root:root $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh

  sudo rm -f $HSHQ_SCRIPTS_DIR/userasroot/checkCaddyContainers.sh
  sudo tee $HSHQ_SCRIPTS_DIR/userasroot/checkCaddyContainers.sh >/dev/null <<EOFMS
#!/bin/bash

stacks_dir=$HSHQ_STACKS_DIR
err_search="The request message was malformed"
caddy_arr=(\$(docker ps -a --filter name=caddy- --format "{{.Names}}"))
for curcaddy in "\${caddy_arr[@]}"
do
  find_err=\$(docker logs \$curcaddy 2>&1 | grep "\$err_search")
  if ! [ -z "\$find_err" ]; then
    echo "Error found with \$curcaddy stack. Clearing data and restarting..."
    echo "If this problem persists, then contact the VPN owner and ask them to reset their Caddy instance which serves the certificates."
    $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh \$curcaddy
  fi
done
EOFMS
  sudo chmod 0500 $HSHQ_SCRIPTS_DIR/userasroot/checkCaddyContainers.sh
  sudo chown root:root $HSHQ_SCRIPTS_DIR/userasroot/checkCaddyContainers.sh

  sudo rm -f $HSHQ_SCRIPTS_DIR/root/clearRoutingTable.sh
  sudo tee $HSHQ_SCRIPTS_DIR/root/clearRoutingTable.sh >/dev/null <<EOFWG
#!/bin/bash
set +e
ip rule delete priority 1000

ip rule delete priority 2000
while [ \$? -eq 0 ]
do
  ip rule delete priority 2000
done

ip rule delete priority 8000
while [ \$? -eq 0 ]
do
  ip rule delete priority 8000
done

ip route flush table 42

for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
do
  if ! test -f "\$conf"; then continue; fi
  ip route flush table \$(grep ^\#ROUTING_TABLE_ID= \$conf | sed 's/^[^=]*=//')
done
EOFWG
  sudo chmod 0500 $HSHQ_SCRIPTS_DIR/root/clearRoutingTable.sh
  sudo chown root:root $HSHQ_SCRIPTS_DIR/root/clearRoutingTable.sh

  outputPerformNetworkingChecks
}

function checkUpdateDockerPrivateIP()
{
  set +e
  CMD="sudo ip rule add suppress_prefixlength 0 table main priority 1000"
  CHECK="sudo ip rule show | grep -w \"suppress_prefixlength\" > /dev/null 2>&1"
  whileCheckCommand "$CMD" "$CHECK"

  CMD="sudo ip rule add from $NET_PRIVATEIP_SUBNET table 42 priority 2000"
  CHECK="sudo ip rule show | grep -w \"from $NET_PRIVATEIP_SUBNET lookup 42\" > /dev/null 2>&1"
  whileCheckCommand "$CMD" "$CHECK"

  CMD="sudo ip route add blackhole default metric 3 table 42"
  CHECK="sudo ip route show table 42 2>/dev/null | grep -w \"blackhole\" > /dev/null 2>&1"
  whileCheckCommand "$CMD" "$CHECK"
}

function whileCheckCommand()
{
  eval "$2"
  RETVAL=$?
  numIter=1
  while [ $RETVAL -ne 0 ] && [ $numIter -lt 100 ]; do
    eval "$1" > /dev/null 2>&1
    RETVAL=$?
    numIter=$(($numIter+1))
    sleep 1
  done
}

function outputPerformNetworkingChecks()
{
  sudo rm -f $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh
  sudo tee $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh >/dev/null <<EOFBS
#!/bin/bash

HSHQ_LOG_FILE=$HSHQ_LOG_FILE
HSHQ_BASE_DIR=$HSHQ_BASE_DIR
HSHQ_LIB_DIR=$HSHQ_LIB_DIR
HSHQ_LIB_SCRIPT=$HSHQ_LIB_SCRIPT
LOCK_UTILS_FILENAME=$LOCK_UTILS_FILENAME
SYSTEM_STATE_FILENAME=$SYSTEM_STATE_FILENAME
MIN_NETWORKCHECK_INTERVAL=$MIN_NETWORKCHECK_INTERVAL
SS_RUNNING=$SS_RUNNING

function main()
{
  if ! [ -f \$SYSTEM_STATE_FILENAME ]; then
    tee \$SYSTEM_STATE_FILENAME >/dev/null <<EOFSS
SYS_STATE=running
LAST_NETWORK_CHECK=0
IS_DEBUG=false
EOFSS
    chmod 644 \$SYSTEM_STATE_FILENAME
    chown $USERNAME:$USERNAME \$SYSTEM_STATE_FILENAME
  fi
  source \$SYSTEM_STATE_FILENAME
  isTooSoon="\$(isCheckTooSoon \$LAST_NETWORK_CHECK)"
  if ! [ "\$SYS_STATE" = "\$SS_RUNNING" ] || [ "\$isTooSoon" = "true" ]; then
    if ! [ "\$IS_DEBUG" = "false" ]; then
      echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] performNetworkingChecks.sh - Not performed, CurState: \$SYS_STATE, LastCheck: \$(date -d @\$LAST_NETWORK_CHECK +"%Y-%m-%d %T"), IsTooSoon: \$isTooSoon" >> \$HSHQ_LOG_FILE
    fi
    return
  fi
  if ! [ "\$IS_DEBUG" = "false" ]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] performNetworkingChecks.sh - BEGIN, CurState: \$SYS_STATE, LastCheck: \$(date -d @\$LAST_NETWORK_CHECK +"%Y-%m-%d %T"), IsTooSoon: \$isTooSoon" >> \$HSHQ_LOG_FILE
  fi
  source \$HSHQ_LIB_SCRIPT lib
  tgLock="\$(tryGetLock networkchecks performNetworkingChecks)"
  if ! [ "\$tgLock" = "true" ]; then
    checkRes="\$(getLockOpenMsg networkchecks)"
    totLockAttempts=\$(getIncrementLockAttempts networkchecks)
    strErr="performNetworkingChecks.sh - Cannot obtain networkchecks lock(\$totLockAttempts): \$checkRes, exiting..."
    logHSHQEvent warning "\$strErr"
    if [ \$((\$totLockAttempts % 60)) -eq 30 ]; then
      source <(sudo cat \$HSHQ_PLAINTEXT_ROOT_CONFIG)
      source \$HSHQ_PLAINTEXT_USER_CONFIG
      sendEmail -s "HSHQ Networking Error" -b "There is an issue with your HomeServer networking that needs to be addressed. For more details, you can view the log by running the command 'cat /var/log/hshq.log'. The easiest way to (possibly) fix this problem would be to simply reboot your server. However, if you continue to recieve this message then there might be a real problem that needs to fixed. You can either ask on the forum (https://forum.homeserverhq.com) or you can submit a Github issue (https://github.com/homeserverhq/hshq/issues)."
    fi
    exit 7
  fi
  if ! [ "\$IS_DEBUG" = "false" ]; then
    echo "\$(date '+%Y-%m-%d %H:%M:%S.%3N') [debug] performNetworkingChecks.sh - Got lock, args: \$@" >> \$HSHQ_LOG_FILE
  fi
  source <(sudo cat \$HSHQ_PLAINTEXT_ROOT_CONFIG)
  source \$HSHQ_PLAINTEXT_USER_CONFIG
  set +e
  checkAllHSHQNetworking "\$@"
  retVal=\$?
  releaseLock networkchecks "performNetworkingChecks" false
  return \$retVal
}

function isCheckTooSoon()
{
  last_check="\$1"
  if [ -z "\$last_check" ]; then
    last_check=0
  fi
  cur_dt=\$(date +%s)
  s_diff=\$((\$cur_dt - \$last_check))
  if [ \$s_diff -lt \$MIN_NETWORKCHECK_INTERVAL ]; then
    echo "true"
  else
    echo "false"
  fi
}

main "\$@"
EOFBS
  sudo chmod 500 $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh
  sudo rm -f /etc/networkd-dispatcher/routable.d/performNetworkingChecks.sh
  if sudo test -d "/etc/networkd-dispatcher/routable.d"; then
    sudo ln -s $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh /etc/networkd-dispatcher/routable.d/performNetworkingChecks.sh
    sudo chmod 755 /etc/networkd-dispatcher/routable.d/performNetworkingChecks.sh
  fi
  sudo rm -f /etc/NetworkManager/dispatcher.d/performNetworkingChecks.sh
  if sudo test -d "/etc/NetworkManager/dispatcher.d"; then
    sudo ln -s $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh /etc/NetworkManager/dispatcher.d/performNetworkingChecks.sh
    sudo chmod 755 /etc/NetworkManager/dispatcher.d/performNetworkingChecks.sh
  fi
}

function outputUpdateIPTablesBeforeNetworkBootscript()
{
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/beforenetwork/10-updateIPTablesBeforeNetwork.sh
  sudo tee $HSHQ_SCRIPTS_DIR/boot/beforenetwork/10-updateIPTablesBeforeNetwork.sh >/dev/null <<EOFBS
#!/bin/bash

HSHQ_BASE_DIR=$HSHQ_BASE_DIR
HSHQ_LIB_DIR=$HSHQ_LIB_DIR
HSHQ_LIB_SCRIPT=$HSHQ_LIB_SCRIPT

function main()
{
  source \$HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME
  forceGetLock hshqopen performPostDockerBootActions
  forceGetLock networkchecks performPostDockerBootActions

  source \$HSHQ_LIB_SCRIPT lib
  source <(sudo cat \$HSHQ_PLAINTEXT_ROOT_CONFIG)
  notifyBootInit
  checkUpdateAllIPTables prenetwork
  releaseLock networkchecks BeforeNetwork false
  releaseLock hshqopen BeforeNetwork false
}
main
EOFBS
  sudo chmod 500 $HSHQ_SCRIPTS_DIR/boot/beforenetwork/10-updateIPTablesBeforeNetwork.sh
}

function outputPerformPostDockerBootActionsScript()
{
  sudo mkdir -p $HSHQ_SCRIPTS_DIR/boot/afterdocker
  sudo rm -f $HSHQ_SCRIPTS_DIR/boot/afterdocker/10-performPostDockerBootActions.sh
  sudo tee $HSHQ_SCRIPTS_DIR/boot/afterdocker/10-performPostDockerBootActions.sh >/dev/null <<EOFBS
#!/bin/bash

HSHQ_BASE_DIR=$HSHQ_BASE_DIR
HSHQ_LIB_DIR=$HSHQ_LIB_DIR
HSHQ_LIB_SCRIPT=$HSHQ_LIB_SCRIPT

function main()
{
  source \$HSHQ_LIB_SCRIPT lib
  tgLock="\$(tryGetLock hshqopen performPostDockerBootActions)"
  if ! [ "\$tgLock" = "true" ]; then
    checkRes="\$(getLockOpenMsg hshqopen)"
    # This should absolutely never happen due to boot order
    strErr="performPostDockerBootActions - Cannot obtain hshqopen lock: \$checkRes, exiting..."
    logHSHQEvent error "\$strErr"
    echo "ERROR: \$strErr"
    exit 2
  fi
  tgLock="\$(tryGetLock networkchecks performPostDockerBootActions)"
  if ! [ "\$tgLock" = "true" ]; then
    checkRes="\$(getLockOpenMsg networkchecks)"
    # This should absolutely never happen due to boot order
    strErr="performPostDockerBootActions - Cannot obtain networkchecks lock: \$checkRes, exiting..."
    logHSHQEvent error "\$strErr"
    echo "ERROR: \$strErr"
    exit 3
  fi
  source <(sudo cat \$HSHQ_PLAINTEXT_ROOT_CONFIG)
  source \$HSHQ_PLAINTEXT_USER_CONFIG
  set +e
  performPostDockerBootActions
  notifyBootComplete
  releaseLock networkchecks performPostDockerBootActions false
  releaseLock hshqopen performPostDockerBootActions false
}
main
EOFBS
  sudo chmod 500 $HSHQ_SCRIPTS_DIR/boot/afterdocker/10-performPostDockerBootActions.sh
}

function performPostDockerBootActions()
{
  logHSHQEvent info "performPostDockerBootActions - BEGIN"
  docker ps > /dev/null 2>&1
  logHSHQEvent info "performPostDockerBootActions - Docker is up, continuing..."
  # Replaces 10-updateIPTablesAfterDocker.sh
  checkUpdateAllIPTables performPostDockerBootActions
  logHSHQEvent info "performPostDockerBootActions - updateSysctl"
  # Replaces 10-updateSysctl.sh
  sysctl --system > /dev/null 2>&1
  logHSHQEvent info "performPostDockerBootActions - pingGateway"
  # Replaces 15-pingGateway.sh
  cur_gate=$(ip route | grep -e "^default" | head -n 1 | awk '{print $3}')
  timeout 30 ping -c 4 $cur_gate > /dev/null
  logHSHQEvent info "performPostDockerBootActions - restartWG"
  # Replaces 20-restartWG.sh
  for curConf in /etc/wireguard/*.conf
  do
    if ! test -f "$curConf"; then continue; fi
    curSVC=$(echo ${curConf%.*} | rev | cut -d"/" -f1 | rev)
    logHSHQEvent info "performPostDockerBootActions - Checking WG Connection: $curSVC"
    systemctl is-enabled wg-quick@${curSVC} > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      logHSHQEvent info "performPostDockerBootActions - Restarting WG Connection: $curSVC"
      timeout 30 sudo systemctl restart wg-quick@${curSVC} > /dev/null 2>&1
    fi
  done
  logHSHQEvent info "performPostDockerBootActions - createWGDockerNetworks"
  # Replaces 50-wgDockInternetUpAll.sh
  createWGDockerNetworks
  logHSHQEvent info "performPostDockerBootActions - wgDockInternetUpAll"
  wgDockInternetUpAll
  logHSHQEvent info "performPostDockerBootActions - restartStacksOnBoot"
  # Replaces 90-restartSelectedStacks.sh
  restartStacksOnBoot
  logHSHQEvent info "performPostDockerBootActions - END"
}

function checkInitScriptState()
{
  if ! [ -f "$SYSTEM_STATE_FILENAME" ]; then
    is_dbg=false
    if [ "$LOG_LEVEL" = "debug" ]; then
      is_dbg=true
    fi
    tee $SYSTEM_STATE_FILENAME >/dev/null <<EOFSS
SYS_STATE=$SS_RUNNING
LAST_NETWORK_CHECK=0
IS_DEBUG=$is_dbg
EOFSS
    chmod 644 $SYSTEM_STATE_FILENAME
  fi
}

function setSystemState()
{
  checkInitScriptState
  updateConfigVarInFile "SYS_STATE" "$1" $SYSTEM_STATE_FILENAME
}

function isNetworkCheckIntervalExpired()
{
  checkInitScriptState
  last_check=$(getConfigVarFromFile LAST_NETWORK_CHECK $SYSTEM_STATE_FILENAME)
  cur_dt=$(date +%s)
  s_diff=$(($cur_dt - $last_check + 15))
  s_inter=$(($NETWORK_UPDATE_INTERVAL * 60))
  if [ $s_diff -gt $s_inter ]; then
    echo "true"
  else
    echo "false"
  fi 
}

function isNetworkCheckIntervalTooSoon()
{
  checkInitScriptState
  last_check=$(getConfigVarFromFile LAST_NETWORK_CHECK $SYSTEM_STATE_FILENAME)
  cur_dt=$(date +%s)
  s_diff=$(($cur_dt - $last_check))
  if [ $s_diff -lt $MIN_NETWORKCHECK_INTERVAL ]; then
    echo "true"
  else
    echo "false"
  fi 
}

function resetLastNetworkCheckTimestamp()
{
  checkInitScriptState
  updateConfigVarInFile "LAST_NETWORK_CHECK" "0" $SYSTEM_STATE_FILENAME
}

function updateLastNetworkCheck()
{
  checkInitScriptState
  updateConfigVarInFile "LAST_NETWORK_CHECK" "$(date +%s)" $SYSTEM_STATE_FILENAME
}

function notifyBootInit()
{
  checkInitScriptState
  setSystemState "$SS_BOOTING"
}

function notifyBootComplete()
{
  checkInitScriptState
  setSystemState "$SS_RUNNING"
}

function initCronJobs()
{
  echo "MAILTO=$EMAIL_ADMIN_EMAIL_ADDRESS" | sudo tee $HOME/rootcron >/dev/null
  echo "*/$LECERTS_REFRESH_RATE * * * * bash $HSHQ_SCRIPTS_DIR/userasroot/updateLECerts.sh >/dev/null 2>&1" | sudo tee -a $HOME/rootcron >/dev/null
  echo "0 */6 * * * bash $HSHQ_SCRIPTS_DIR/userasroot/checkCaddyContainers.sh" | sudo tee -a $HOME/rootcron >/dev/null
  echo "* * * * * bash $HSHQ_SCRIPTS_DIR/root/performNetworkingChecks.sh cron >/dev/null 2>&1" | sudo tee -a $HOME/rootcron >/dev/null
  sudo crontab $HOME/rootcron
  sudo rm -f $HOME/rootcron
}

function appendToRoonCron()
{
  cr_string="$1"
  sudo crontab -l > $HOME/rootcron
  set +e
  grep "$cr_string" $HOME/rootcron > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "$cr_string" | sudo tee -a $HOME/rootcron >/dev/null
    sudo crontab $HOME/rootcron
    sudo rm -f $HOME/rootcron
  fi
  set -e
}

function deleteFromRootCron()
{
  cr_string="$1"
  sudo crontab -l > $HOME/rootcron
  set +e
  grep "$cr_string" $HOME/rootcron > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    sudo sed -i "/$cr_string/d" $HOME/rootcron
    sudo crontab $HOME/rootcron
  fi
  sudo rm -f $HOME/rootcron
  set -e
}

function pauseCronService()
{
  sudo systemctl stop cron > /dev/null 2>&1
}

function resumeCronService()
{
  sudo systemctl restart cron > /dev/null 2>&1
}

function updateHomeServerLogoImages()
{
  set +e
  hsid=$(getHeimdallUserIDFromType homeservers)
  hs_list=($(sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "select url from items where pinned=1 and user_id=$hsid;"))
  isAnyNew=false
  for curHS in "${hs_list[@]}"
  do
    curDomain=$(getBaseDomain $(echo "$curHS" | cut -d "/" -f3))
    curURL="https://images.${curDomain}/${curDomain}.png"
    echo -e "\nGetting image for ${curDomain}..."
    wget -q --timeout=10 --tries=1 -O /tmp/tmpimage.png $curURL > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      echo "ERROR: Could not obtain image for $curDomain"
      rm -f /tmp/tmpimage.png
      continue
    fi
    curImgSize=$(du -s /tmp/tmpimage.png | xargs | cut -d" " -f1)
    if [ $curImgSize -lt 1 ] || [ $curImgSize -gt 1024 ]; then
      echo "ERROR: There was a problem with the image size for $curDomain"
      rm -f /tmp/tmpimage.png
      continue
    fi
    isNewImage=false
    if ! [ -f $HSHQ_ASSETS_DIR/images/${curDomain}.png ]; then
      echo "No existing image found for ${curDomain}, adding..."
      isNewImage=true
    else
      diff $HSHQ_ASSETS_DIR/images/${curDomain}.png /tmp/tmpimage.png > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo "New image detected for ${curDomain}, updating..."
        isNewImage=true
      else
        echo "Same image for ${curDomain}, skipping..."
      fi
    fi
    if [ "$isNewImage" = "true" ]; then
      isAnyNew=true
      mv /tmp/tmpimage.png $HSHQ_ASSETS_DIR/images/${curDomain}.png
      # Add some random string to the filename, to overcome any browser cache issues.
      rand_string=$(pwgen -c -n 8 1)
      cp $HSHQ_ASSETS_DIR/images/${curDomain}.png $HSHQ_STACKS_DIR/heimdall/config/www/icons/${curDomain}-${rand_string}.png
      sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set icon='icons/${curDomain}-${rand_string}.png' where url='$curHS';"
    else
      rm -f /tmp/tmpimage.png
    fi
  done
  echo ""
  if [ "$isAnyNew" = "true" ]; then
    echo "Restarting Heimdall..."
    docker container restart heimdall > /dev/null 2>&1
  else
    echo "No new images were detected"
  fi
  echo "Update HomeServer logo images complete!"
}

function uploadHomeServerLogo()
{
  img_file="$1"
  if ! [ "$(file -b --mime-type $img_file)" = "image/png" ]; then
    echo "ERROR: Image must be a png file"
    rm -f "$img_file"
    return
  fi
  curImgSize=$(du -s $img_file | xargs | cut -d" " -f1)
  if [ $curImgSize -lt 1 ]; then
    echo "ERROR: There was a problem with the image size"
    rm -f "$img_file"
    return
  fi
  if [ $curImgSize -gt 1024 ]; then
    echo "ERROR: Image is too large, must be less than 1MB (1024 KB)"
    rm -f "$img_file"
    return
  fi
  echo "Image is good, updating..."
  mv "$img_file" $HSHQ_ASSETS_DIR/images/${HOMESERVER_DOMAIN}.png
  # Add some random string to the filename, to overcome any browser cache issues.
  rand_string=$(pwgen -c -n 8 1)
  cp $HSHQ_ASSETS_DIR/images/${HOMESERVER_DOMAIN}.png $HSHQ_STACKS_DIR/heimdall/config/www/icons/${HOMESERVER_DOMAIN}-${rand_string}.png
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set icon='icons/${HOMESERVER_DOMAIN}-${rand_string}.png' where url='https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN';"
  echo "Restarting Heimdall..."
  docker container restart heimdall > /dev/null 2>&1
  # Update desktop icon (if exists)
  if [ -f /usr/share/icons/HSHQ/Homepage.png ]; then
    sudo rm -f /usr/share/icons/HSHQ/${HOMESERVER_DOMAIN}-*
    sudo cp -f $HSHQ_ASSETS_DIR/images/${HOMESERVER_DOMAIN}.png /usr/share/icons/HSHQ/${HOMESERVER_DOMAIN}-${rand_string}.png
    if [ -f $HOME/Desktop/HomePage.desktop ]; then
      sudo sed -i "s|^Icon=.*|Icon=/usr/share/icons/HSHQ/${HOMESERVER_DOMAIN}-${rand_string}.png|" ~/Desktop/HomePage.desktop
      trustDesktopIcon "HomePage.desktop"
    fi
    if sudo test -f /usr/share/applications/HomePage.desktop; then
      sudo sed -i "s|^Icon=.*|Icon=/usr/share/icons/HSHQ/${HOMESERVER_DOMAIN}-${rand_string}.png|" /usr/share/applications/HomePage.desktop
    fi
  fi
  echo "HomeServer logo updated succesfully!"
}

function checkAllHSHQNetworking()
{
  # Check/Update All Networking
  # This function assumes that the networking lock
  # has already been obtained. Here is a list of
  # actions performed in this function:
  #
  #  1. Check all host interfaces for IP address change
  #  2. Check if adguard is working
  #  3. Check all VPN connections for Endpoint IP change
  #  4. Cheak health of all VPN connections (ping relay)
  #  5. Check masq IP of WG Internet connections (curl internet)
  #  6. If no locking errors, update last timestamp
  #
  # Notes: 
  #  - Ensure at least NETWORK_UPDATE_INTERVAL minutes
  #    have passed since last update (check last timestamp)
  #  - This function is tied into:
  #     - routable.d (if systemd-network)
  #     - dispatcher.d (if NetworkManager)
  #     - cron job every minute, but only actually excutes
  #       after every NETWORK_UPDATE_INTERVAL(def 5) minutes
  #       unless the previous attempt at obtaining a lock
  #       resulted in an error
  #
  set +e
  funRetVal=0
  # This is for NetworkManager-dispatcher function calls.
  # See https://manpages.ubuntu.com/manpages/lunar/man8/NetworkManager-dispatcher.8.html
  # We'll only focus on 'up' actions.
  if ! [ -z "$2" ] && ! [ "$2" = "up" ]; then
    return
  fi
  cahn_callerName=unknown
  if [ "$1" = "cron" ]; then
    cahn_callerName=cron
  elif [ "$2" = "up" ]; then
    cahn_callerName=NetworkManager
  elif [ -z "$@" ]; then
    cahn_callerName=networkd
  fi
  if [ "$cahn_callerName" = "cron" ] && [ "$(isNetworkCheckIntervalExpired)" = "false" ]; then
    return
  fi
  if [ "$(isNetworkCheckIntervalTooSoon)" = "true" ]; then
    return
  fi
  if ! [ "$cahn_callerName" = "cron" ]; then
    logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) BEGIN"
  fi
  isLockError=false
  isAnyChanged="$(checkHostInterfacesIsChanged)"
  if [ "$isAnyChanged" = "true" ]; then
    tgLock="$(tryGetLock hshqopen checkAllHSHQNetworking)"
    if ! [ "$tgLock" = "true" ]; then
      checkRes="$(getLockOpenMsg hshqopen)"
      logHSHQEvent error "checkAllHSHQNetworking ($cahn_callerName) - Unable to obtain lock ($checkRes)"
      isLockError=true
    else
      setSystemState $SS_UPDATING
      logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) - Host interface IP changed..."
      checkHostAllInterfaceIPChanges true false checkAllHSHQNetworking
      logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) - Releasing lock..."
      setSystemState $SS_RUNNING
      releaseLock hshqopen "checkAllHSHQNetworking" false
    fi
  fi
  # Perform curl https://api.ipify.org. If an error,
  # assume Adguard is not working and restart stack.
  curIP=$(curl --silent --max-time 5 https://api.ipify.org)
  if [ $? -ne 0 ]; then
    logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) - Restarting adguard..."
    startStopStack adguard stop
    sleep 1
    startStopStack adguard start
    logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) - Adguard restarted..."
  fi
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - checkUpdateDockerPrivateIP (before)"
  checkUpdateDockerPrivateIP
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - checkUpdateDockerPrivateIP (after)"
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - updateEndpointIPs (before)"
  updateEndpointIPs
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - updateEndpointIPs (after)"
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - checkNonLockedUnencrytpedConfig (before)"
  checkNonLockedUnencrytpedConfig "$cahn_callerName"
  funRetVal=$(($funRetVal + $?))
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - checkNonLockedUnencrytpedConfig (after)"
  if [ "$isLockError" = "false" ]; then
    logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - updateLastNetworkCheck (before)"
    updateLastNetworkCheck
    logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - updateLastNetworkCheck (after)"
  fi
  logHSHQEvent debug "checkAllHSHQNetworking ($cahn_callerName) - Debug END"
  if ! [ "$cahn_callerName" = "cron" ]; then
    logHSHQEvent info "checkAllHSHQNetworking ($cahn_callerName) END"
  fi
  return $funRetVal
}

function checkNonLockedUnencrytpedConfig()
{
  callerName="$1"
  if [ -f $CONFIG_FILE_DEFAULT_LOCATION/$CONFIG_FILE_DEFAULT_FILENAME ]; then
    checkResCNLUC="$(checkIsLockEnabled hshqopen)"
    if [ -z "$checkResCNLUC" ]; then
      errMsg="checkNonLockedUnencrytpedConfig ($callerName) - Config file is unencrypted with no lock!"
      logHSHQEvent error "$errMsg"
      echo "ERROR: $errMsg"
      return 1
    fi
  fi
}

function updateEndpointIPs()
{
  set +e
  logHSHQEvent debug "updateEndpointIPs - Begin"
  ping_timeout=5
  conn_list=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType in ('homeserver_vpn','homeserver_internet') and NetworkType in ('other','primary');"))
  for cur_id in "${conn_list[@]}"
  do
    logHSHQEvent debug "updateEndpointIPs - Checking ID: $cur_id"
    is_int=$(sqlite3 $HSHQ_DB "select IsInternet from connections where ID='$cur_id';")
    iname=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID='$cur_id';")
    cname=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$cur_id;")
    if [ "$(checkIPByID $cur_id)" = "true" ]; then
      logHSHQEvent info "updateEndpointIPs - IP changed, restarting $cname..."
      if [ $is_int = 0 ]; then
        timeout 10 sudo systemctl restart wg-quick@$iname > /dev/null 2>&1
      else
        sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $HSHQ_WIREGUARD_DIR/internet/${iname}.conf restart > /dev/null 2>&1
      fi
    fi
	set +e
    if [ $is_int = 0 ]; then
      logHSHQEvent debug "updateEndpointIPs - Checking health: $cur_id"
      # Also need to check health of connection and reset if issues
      rs_ip=$(sqlite3 $HSHQ_DB "select RS_VPN_IP from hsvpn_connections where ID=$cur_id;")
      if ! [ -z "$rs_ip" ]; then
	    logHSHQEvent debug "updateEndpointIPs - Pinging $rs_ip"
        timeout $ping_timeout ping -c 1 $rs_ip > /dev/null 2>&1
        if [ $? -ne 0 ]; then
          logHSHQEvent error "updateEndpointIPs - Connection Error, restarting(HSVPN) $cname ($iname)..."
          timeout 10 sudo systemctl restart wg-quick@$iname > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            # If applicable, restart the associated caddy Stack
            checkCaddyInterface=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ConnectionType in ('homeserver_vpn') and NetworkType in ('other','primary') and ID=$cur_id;")
            if ! [ -z "$checkCaddyInterface" ]; then
              logHSHQEvent error "updateEndpointIPs - Connection Error, restarting caddy interface (caddy-${checkCaddyInterface})..."
              forceRestartStack "caddy-${checkCaddyInterface}" 3
            fi
          fi
          logHSHQEvent error "updateEndpointIPs - Connection Error, restart complete(HSVPN) $cname ($iname)..."
        fi
      fi
    fi
  done
  set +e
  logHSHQEvent debug "updateEndpointIPs - Check/fix ClientDNS"
  # Check/fix ClientDNS
  cdns_id=($(sqlite3 $HSHQ_DB "select ID from connections where ConnectionType='clientdns' and NetworkType in ('primary','mynetwork');"))
  for cur_cdns in "${cdns_id[@]}"
  do
    cname=$(sqlite3 $HSHQ_DB "select Name from connections where ID=$cur_cdns;")
    logHSHQEvent debug "updateEndpointIPs - Checking clientDNS: $cname ($cdns_id)"
    # First, check if container is actually running
    docker ps | grep ${cname}-wireguard > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      continue
    fi
    if ! [ -z "$cur_cdns" ] && [ "$(checkIPByID $cur_cdns)" = "true" ]; then
      logHSHQEvent info "updateEndpointIPs - IP changed, restarting(ClientDNS) $cname..."
      restartStackIfRunning "${cname}" 1
    fi
  done
  set +e
  logHSHQEvent debug "updateEndpointIPs - Check/fix tunnelled WireGuard internet connections"
  # Check/fix tunnelled WireGuard internet connections
  for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
  do
    if ! sudo test -f "$conf"; then continue; fi
    logHSHQEvent debug "updateEndpointIPs - Checking wgDockInternet: $conf"
    resOut=$(sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $conf status)
    retVal=$?
    logHSHQEvent debug "updateEndpointIPs - wgDockInternet got status: $conf"
    if [ $retVal -ne 0 ]; then
      logHSHQEvent error "updateEndpointIPs - Connection Error, restarting(HSInternet)[$retVal - $resOut] $conf..."
      sudo $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $conf restart > /dev/null 2>&1
      logHSHQEvent debug "updateEndpointIPs - Connection Error, restart complete(HSInternet)[$retVal - $resOut] $conf..."
    fi
  done
  logHSHQEvent debug "updateEndpointIPs - End"
}

function checkIPByID()
{
  dbID=$1
  ehost=$(sqlite3 $HSHQ_DB "select EndpointHostname from connections where ID='$dbID';")
  eip=$(sqlite3 $HSHQ_DB "select EndpointIP from connections where ID='$dbID';")
  if ! [ -z "$ehost" ]; then
    check_ip=$(getIPFromHostname $ehost)
  fi
  if ! [ -z "$check_ip" ] && ! [ "$check_ip" = "$eip" ]; then
    curdt=$(date '+%Y-%m-%d %H:%M:%S')
    sudo sqlite3 $HSHQ_DB "update connections set EndpointIP='$check_ip',LastUpdated='$curdt' where ID='$dbID';"
    echo "true"
  else
    echo "false"
  fi
}

function wgDockInternetUpAll()
{
  logHSHQEvent info "wgDockInternetUpAll - BEGIN"
  checkUpdateDockerPrivateIP
  for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf 
  do
    if ! test -f "$conf"; then continue; fi
    logHSHQEvent info "wgDockInternetUpAll - internet: $conf"
    $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh $conf up
  done
  logHSHQEvent info "wgDockInternetUpAll - END"
}

function outputWireGuardScripts()
{
  outputWGDockInternetScript
  sudo tee $HSHQ_WIREGUARD_DIR/scripts/wgDockInternetDownAll.sh >/dev/null <<EOFWG
#!/bin/bash
set +e
HSHQ_WIREGUARD_DIR=$HSHQ_WIREGUARD_DIR

for conf in \$HSHQ_WIREGUARD_DIR/internet/*.conf
do
  if ! test -f "\$conf"; then continue; fi
  \$HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh \$conf down
done
EOFWG
  sudo chmod 744 $HSHQ_WIREGUARD_DIR/scripts/wgDockInternetDownAll.sh
  if [[ "$(isProgramInstalled sqlite3)" = "false" ]]; then
    echo "Installing sqlite3, please wait..."
    performAptInstall sqlite3 > /dev/null 2>&1
  fi
}

function outputWGDockInternetScript()
{
  sudo rm -f $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh
  sudo tee $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh >/dev/null <<EOFWG
#!/bin/bash

#This script was adopted from this GitHub project. Special thanks to BrodyBuster!!!
#https://github.com/BrodyBuster/docker-wireguard-vpn

CONFIG_FILE=\$1
COMMAND=\$2
HSHQ_PLAINTEXT_ROOT_CONFIG=$HSHQ_CONFIG_DIR/ptRootConfig.conf

set +e
function main()
{
  if [ -z "\$CONFIG_FILE" ] || ! [ -f \$CONFIG_FILE ]; then
    echo "Missing configuration file"
    return
  fi
  CONFIG_FILE=\$(realpath \$CONFIG_FILE)
  NETWORK_NAME=\$(getConfigVar \#NETNAME)
  ROUTING_TABLE_ID=\$(getConfigVar \#ROUTING_TABLE_ID)
  DOCKER_NETWORK_NAME=\$(getConfigVar \#DOCKER_NETWORK_NAME)
  DOCKER_NETWORK_SUBNET=\$(getConfigVar \#DOCKER_NETWORK_SUBNET)
  CLIENT_ADDRESS=\$(getConfigVar \#CLIENT_ADDRESS)
  CLIENT_ADDR_NO_CIDR=\$(echo \$CLIENT_ADDRESS | cut -d"/" -f1)
  MTU=\$(getConfigVar \#MTU)
  IS_ENABLED=\$(getConfigVar \#IS_ENABLED)
  EXT_DOMAIN=\$(getConfigVar \#EXT_DOMAIN)
  HOST_INTERNET_TRAFFIC_INTERFACE=\$(sudo grep ^HOST_INTERNET_TRAFFIC_INTERFACE= \$HSHQ_PLAINTEXT_ROOT_CONFIG | sed 's/^[^=]*=//' | sed 's/ *\$//g')

  if [ \${#NETWORK_NAME} -gt 10 ]; then
    echo "Network name is too long, exiting..."
    return
  fi

  shift
  shift
  case "\$COMMAND" in
    up) up "\$@" ;;
    down) down "\$@" ;;
    restart) restart "\$@" ;;
    status) status "\$@" ;;
    *) echo "Usage: \$0 config_file up|down|restart|status" >&2; exit 1 ;;
  esac
}

function while_check()
{
  eval "\$2"
  RETVAL=\$?
  numIter=1
  while [ \$RETVAL -ne 0 ] && [ \$numIter -lt 100 ]; do
    eval "\$1" > /dev/null 2>&1
    RETVAL=\$?
    numIter=\$((\$numIter+1))
    sleep 1
  done
}

function up()
{
  if ! [ "\$(checkValidIPAddress \$EXT_DOMAIN)" = "true" ]; then
    edip=\$(dig \$EXT_DOMAIN +short | grep '^[0-9]')
    if [ \$? -ne 0 ]; then
      # Cannot resolve hostname, this happens in boot process during networkd-dispatcher startup
      echo "Cannot resolve hostname, returning..."
      return
    fi
  fi

  if [ -z \$DOCKER_NETWORK_SUBNET ]; then
    echo "Docker network subnet has not been set"
    return
  fi

  CMD="ip rule add from \$DOCKER_NETWORK_SUBNET table \$ROUTING_TABLE_ID priority 2000"
  CHECK="ip rule show | grep -w \"from \$DOCKER_NETWORK_SUBNET lookup \$ROUTING_TABLE_ID\" > /dev/null 2>&1"
  while_check "\$CMD" "\$CHECK"

  CMD="ip route add blackhole default metric 3 table \$ROUTING_TABLE_ID"
  CHECK="ip route show table \$ROUTING_TABLE_ID 2>/dev/null | grep -w \"blackhole\" > /dev/null 2>&1"
  while_check "\$CMD" "\$CHECK"

  if ! [[ "\$IS_ENABLED" = "yes" ]] && ! [[ "\$IS_ENABLED" = "true" ]]; then
    echo "Config for \$NETWORK_NAME not enabled"
    return
  fi
  ip link | grep " \${NETWORK_NAME}:" > /dev/null
  if [ \$? -ne 0 ]; then
    ip link add \$NETWORK_NAME type wireguard
    wg setconf \$NETWORK_NAME \$CONFIG_FILE
    wg set \$NETWORK_NAME fwmark \$ROUTING_TABLE_ID
    ip addr add \$CLIENT_ADDRESS dev \$NETWORK_NAME
    ip link set mtu \$MTU up dev \$NETWORK_NAME
    ip link set up dev \$NETWORK_NAME
  fi

  CMD="ip route add default via \$CLIENT_ADDR_NO_CIDR metric 2 table \$ROUTING_TABLE_ID"
  CHECK="ip route show table \$ROUTING_TABLE_ID 2>/dev/null | grep -w \"\$CLIENT_ADDR_NO_CIDR\" > /dev/null 2>&1"
  while_check "\$CMD" "\$CHECK"

  if [ "\$HOST_INTERNET_TRAFFIC_INTERFACE" = "\$NETWORK_NAME" ]; then
    status
  fi

  echo "Connection: \$NETWORK_NAME is up"
}

function down()
{
  isCurl=\$(docker ps -a --filter name=\${NETWORK_NAME}-curl --format "{{.Names}}")
  if ! [ -z "\$isCurl" ]; then
    docker container stop \${NETWORK_NAME}-curl > /dev/null 2>&1
    docker container rm \${NETWORK_NAME}-curl > /dev/null 2>&1
  fi
  ip link del \$NETWORK_NAME
  echo "Connection: \$NETWORK_NAME is down"
  if ! [ -z \$DOCKER_NETWORK_SUBNET ]; then
    CMD="ip rule add from \$DOCKER_NETWORK_SUBNET table \$ROUTING_TABLE_ID priority 2000"
    CHECK="ip rule show | grep -w \"from \$DOCKER_NETWORK_SUBNET lookup \$ROUTING_TABLE_ID\" > /dev/null 2>&1"
    while_check "\$CMD" "\$CHECK"
  fi
  CMD="ip route add blackhole default metric 3 table \$ROUTING_TABLE_ID"
  CHECK="ip route show table \$ROUTING_TABLE_ID 2>/dev/null | grep -w \"blackhole\" > /dev/null 2>&1"
  while_check "\$CMD" "\$CHECK"
}

function restart()
{
  down
  up
}

function status()
{
  if ! [ "\$(checkValidIPAddress \$EXT_DOMAIN)" = "true" ]; then
    edip=\$(timeout 5 dig \$EXT_DOMAIN +short | grep '^[0-9]')
    if [ \$? -ne 0 ]; then
      # Cannot resolve hostname, this happens in boot process during networkd-dispatcher startup
      echo "Cannot resolve hostname, returning..."
      return 4
    fi
  fi
  timeout 10 docker ps > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "Docker is not yet up, returning..."
    return 5
  fi
  # Checking the status will start a curl container.
  # So if this is called when the connection is set
  # to a down state, then the container will not be
  # cleaned up.
  CMD="ip route add blackhole default metric 3 table \$ROUTING_TABLE_ID"
  CHECK="ip route show table \$ROUTING_TABLE_ID 2>/dev/null | grep -w \"blackhole\" > /dev/null 2>&1"
  while_check "\$CMD" "\$CHECK"
  isCurl=\$(docker ps -a --filter name=\${NETWORK_NAME}-curl --format "{{.Names}}")
  if [ -z "\$isCurl" ]; then
    docker run -d --name=\${NETWORK_NAME}-curl --restart unless-stopped --net=\$DOCKER_NETWORK_NAME curlimages/curl:7.84.0 tail -f /dev/null > /dev/null 2>&1
    sleep 5
  fi
  VPNIP=\$(docker exec \${NETWORK_NAME}-curl curl -fsSL --max-time 5 https://api.ipify.org  2>/dev/null)
  IP=\$(curl --silent https://api.ipify.org)
  if [ "\$(checkValidIPAddress \$EXT_DOMAIN)" = "true" ]; then
    rsip=\$EXT_DOMAIN
  else
    rsip=\$(getIPFromHostname \$EXT_DOMAIN)
  fi
  if [ -z "\$rsip" ]; then
    echo "ERROR: Could not determine IP from \$EXT_DOMAIN"
    return 1
  elif [[ "\$VPNIP" = "\$rsip" ]]; then
    echo "Connected to \$rsip: Blackhole active"
    if [ "\$HOST_INTERNET_TRAFFIC_INTERFACE" = "\$NETWORK_NAME" ]; then
      ip rule show | grep -w "not from all fwmark .* lookup \$ROUTING_TABLE_ID" > /dev/null 2>&1
      if [ \$? -ne 0 ]; then
        sudo ip rule delete priority 8000 > /dev/null 2>&1
        while [ \$? -eq 0 ]
        do
          sudo ip rule delete priority 8000 > /dev/null 2>&1
        done
        sudo ip rule add not fwmark \$ROUTING_TABLE_ID table \$ROUTING_TABLE_ID priority 8000
      fi
    fi
    return 0
  elif [[ "\$VPNIP" = "\$IP" ]]; then
    echo "Not connected to Endpoint: Blackhole NOT active!"
    return 2
  else
    echo "Unknown error, VPNIP=\$VPNIP, RSIP=\$rsip, LocalIP=\$IP"
    return 3
  fi
}

function checkValidIPAddress()
{
  ip=\$(echo \$1 | cut -d "/" -f1)
  stat=1
  if [[ \$ip =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\$ ]]; then
    OLDIFS=\$IFS
    IFS='./'
    ip=(\$ip)
    IFS=\$OLDIFS
    [[ \${ip[0]} -le 255 && \${ip[1]} -le 255 && \${ip[2]} -le 255 && \${ip[3]} -le 255 ]]
    stat=\$?
  fi
  if [ \$stat -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function getIPFromHostname()
{
  echo \$(dig \$1 +short | grep '^[.0-9]*\$')
}

function getConfigVar()
{
  echo \$(grep ^\$1= \$CONFIG_FILE | sed 's/^[^=]*=//' | sed 's/ *\$//g')
}

main "\$@"
EOFWG
  sudo chmod 755 $HSHQ_WIREGUARD_DIR/scripts/wgDockInternet.sh
}

function createWGDockerNetworks()
{
  for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
  do
    if ! test -f "$conf"; then continue; fi
    docker_net="$(getConfigVarFromFile \#DOCKER_NETWORK_NAME $conf root)"
    docker_subnet="$(getConfigVarFromFile \#DOCKER_NETWORK_SUBNET $conf root)"
    MTU="$(getConfigVarFromFile \#MTU $conf root)"
    docker network inspect $docker_net > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      docker network create $docker_net --subnet $docker_subnet -o com.docker.network.driver.mtu=$MTU -o com.docker.network.bridge.name=$docker_net
    fi
  done
}

function enableAllWGVPNInterfaces()
{
  sudo ls /etc/wireguard | while read fname
  do
    bname=$(basename $fname .conf)
    enableWGInterfaceQuick $bname
  done
}

function enableWGInterfaceQuick()
{
  config_filename=$1
  sudo systemctl enable wg-quick@${config_filename}.service
  sudo systemctl daemon-reload
  sudo systemctl start wg-quick@${config_filename}
}

function removeWGInterfaceQuick()
{
  config_filename=$1
  sudo systemctl stop wg-quick@${config_filename}.service
  sudo systemctl disable wg-quick@${config_filename}.service
  sudo systemctl daemon-reload
  sudo rm -f /etc/wireguard/${config_filename}.conf
}

function getHSHostIPVarName()
{
  if_name="$1"
  echo "HOMESERVER_HOST_${if_name^^}_IP"
}

function getHSHostSubnetVarName()
{
  if_name="$1"
  echo "HOMESERVER_HOST_${if_name^^}_SUBNET"
}

function checkIPConflict()
{
  chk_ip="$1"
  chk_subnet="$2"
  chk_private="$3"
  if ! [ "$(checkValidIPAddress $chk_ip)" = "true" ]; then
    echo "Invalid IP"
    return
  fi
  if [[ "$chk_ip" =~ ^127\. ]]; then
    # This case should never occur, but just for completeness.
    echo "This IP address is in the 127.0.0.0/8 range. This range is specifically reserved for the loopback interface. You must either change your router's LAN subnet or daisy-chain another router in between, and ideally set it in the 192.168.0.0/16 range."
    return
  fi
  if [ "$chk_private" = "true" ]; then
    if [ "$(checkNetworkIntersect $chk_subnet 10.0.0.0/8)" = "true" ]; then
      netsize=$(echo $chk_subnet | cut -d"/" -f2)
      if [ $netsize -eq 8 ]; then
        echo "You are using the ENTIRE 10.0.0.0/8 network for your home network - a terribly poor design choice. You will not be able to host a VPN or network with anyone. Please fix your network settings are restart the installation."
        return
      fi
    fi
    if [ "$(checkNetworkIntersect $chk_subnet $DOCKER_NETWORK_RESERVED_RANGE)" = "true" ]; then
      echo "Your current home network subnet intersects within the $DOCKER_NETWORK_RESERVED_RANGE range. This range is specifically reserved for Docker networking within this infrastructure. You must either change your router's LAN subnet or daisy-chain another router in between, and ideally set it in the 192.168.0.0/16 range."
      return
    fi
    check_intersect="$(isNetworkIntersectOurNetworks $chk_subnet false false)"
    if ! [ -z "$check_intersect" ]; then
      echo "$check_intersect"
      return
    fi
  fi
}

function isInterfaceExists()
{
  set +e
  find /sys/class/net -type l -printf '%f\n' | grep "$1" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function addHSInterface()
{
  iface_name="$1"
  iface_isPrimary="$2"
  interfaceListArr=($(echo $HOMESERVER_HOST_NETWORK_INTERFACES | tr "," "\n"))
  for curInterface in "${interfaceListArr[@]}"
  do
    if [ "$iface_name" = "$curInterface" ]; then
      strMsg="addHSInterface - Interface already added."
      echo "$strMsg"
      logHSHQEvent error "$strMsg"
      return 1
    fi
  done
  interfaceListArr=($(sqlite3 $HSHQ_DB "select InterfaceName from connections where InterfaceName <> \"\";"))
  for curInterface in "${interfaceListArr[@]}"
  do
    if [ "$iface_name" = "$curInterface" ]; then
      strMsg="addHSInterface - Interface name already exists in database."
      echo "$strMsg"
      logHSHQEvent error "$strMsg"
      return 2
    fi
  done
  isFound=false
  availInterfacesArr=($(echo "$(getAllNetworkInterfacesCSV)" | tr "," "\n"))
  for curInterface in "${availInterfacesArr[@]}"
  do
    if [ "$iface_name" = "$curInterface" ]; then
      isFound=true
      break
    fi
  done
  if [ "$isFound" = "false" ]; then
    strMsg="addHSInterface - The selected interface is not available."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 3
  fi
  if [ "$(isInterfaceExists $iface_name)" = "false" ]; then
    strMsg="addHSInterface - The network interface was not found."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 3
  fi
  ip_addr=$(getIPAddressOfInterface $iface_name)
  if [ -z "$ip_addr" ] || [[ "$ip_addr" =~ ^169\.254\. ]]; then
    if [ "$iface_isPrimary" = "true" ]; then
      strMsg="addHSInterface - The IP address for this primary interface could not be determined."
      echo "$strMsg"
      logHSHQEvent error "$strMsg"
      return 3
    fi
    ip_addr=127.0.0.1
    is_private=true
    interface_subnet=127.0.0.1/32
  else
    is_private=$(checkIsIPPrivate "$ip_addr")
    interface_subnet=$(getSubnetOfInterface "$iface_name" "$ip_addr" "$is_private")
    if [ -z "$interface_subnet" ]; then
      interface_subnet="${ip_addr}/24"
    fi
    chk_conflict=$(checkIPConflict "$ip_addr" "$interface_subnet" "$is_private")
    if ! [ -z "$chk_conflict" ]; then
      strMsg="addHSInterface - $chk_conflict"
      echo "$strMsg"
      logHSHQEvent error "$strMsg"
      return 6
    fi
  fi
  if [ -z "$HOMESERVER_HOST_NETWORK_INTERFACES" ]; then
    HOMESERVER_HOST_NETWORK_INTERFACES=$iface_name
  else
    HOMESERVER_HOST_NETWORK_INTERFACES="$HOMESERVER_HOST_NETWORK_INTERFACES",$iface_name
  fi
  updatePlaintextRootConfigVar HOMESERVER_HOST_NETWORK_INTERFACES $HOMESERVER_HOST_NETWORK_INTERFACES
  if [ "$iface_isPrimary" = "true" ]; then
    isPrimaryInsert="primary"
    HOMESERVER_HOST_PRIMARY_INTERFACE_NAME=$iface_name
    updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_NAME $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME
    HOMESERVER_HOST_PRIMARY_INTERFACE_IP=$ip_addr
    updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_IP $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
  else
    isPrimaryInsert="secondary"
  fi
  curdt=$(getCurrentDate)
  sudo sqlite3 $HSHQ_DB "insert into connections(Name,ConnectionType,NetworkType,IPAddress,InterfaceName,LastUpdated,Network_Subnet,IsExposeToNetwork,InputAllowPorts,DockerUserAllowPorts) values('HomeServerHost_${iface_name^^}','$isPrimaryInsert','home_network','$ip_addr','$iface_name','$curdt','$interface_subnet',true,'$INPUT_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT','$DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT');"
}

function removeHSInterface()
{
  iface_name="$1"
  HOMESERVER_HOST_NETWORK_INTERFACES=$(echo $HOMESERVER_HOST_NETWORK_INTERFACES | sed "s|${iface_name},||g")
  HOMESERVER_HOST_NETWORK_INTERFACES=$(echo $HOMESERVER_HOST_NETWORK_INTERFACES | sed "s|,${iface_name}||g")
  updatePlaintextRootConfigVar HOMESERVER_HOST_NETWORK_INTERFACES $HOMESERVER_HOST_NETWORK_INTERFACES
  checkDeleteStackAndDirectory caddy-home-$iface_name "Caddy" true true > /dev/null 2>&1
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from connections where InterfaceName='$iface_name';" > /dev/null 2>&1
}

function setHSInterfaceAsPrimary()
{
  # This function changes the primary interface
  iface_name="$1"
  interfaceListArr=($(echo $HOMESERVER_HOST_NETWORK_INTERFACES | tr "," "\n"))
  isFound=false
  for curInterface in "${interfaceListArr[@]}"
  do
    if [ "$iface_name" = "$curInterface" ]; then
      isFound=true
      break
    fi
  done
  if [ "$isFound" = "false" ]; then
    strMsg="setHSInterfaceAsPrimary - The selected network interface was not in the list."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 1
  fi
  iface_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where InterfaceName = '$iface_name';")
  if [ -z "$iface_ip" ]; then
    strMsg="setHSInterfaceAsPrimary - The selected network interface was not found in the database."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 2
  fi
  if ! [ "$(checkValidIPAddress $iface_ip)" = "true" ]; then
    strMsg="setHSInterfaceAsPrimary - The IP address for this interface is invalid."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 3
  fi
  sudo sqlite3 $HSHQ_DB "update connections set ConnectionType='primary' where InterfaceName = '$iface_name';"
  sudo sqlite3 $HSHQ_DB "update connections set ConnectionType='secondary' where InterfaceName = '$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME';"
  HOMESERVER_HOST_PRIMARY_INTERFACE_NAME="$iface_name"
  HOMESERVER_HOST_PRIMARY_INTERFACE_IP="$iface_ip"
  updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_NAME $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME
  updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_IP $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
}

function setHSInterfaceIsExpose()
{
  # This function sets the expose setting for the selected interface
  iface_name="$1"
  iface_isExpose="$2"
  interfaceListArr=($(echo $HOMESERVER_HOST_NETWORK_INTERFACES | tr "," "\n"))
  isFound=false
  for curInterface in "${interfaceListArr[@]}"
  do
    if [ "$iface_name" = "$curInterface" ]; then
      isFound=true
      break
    fi
  done
  if [ "$isFound" = "false" ]; then
    strMsg="setHSInterfaceIsExpose - The selected network interface was not in the list."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 1
  fi
  sudo sqlite3 $HSHQ_DB "update connections set IsExposeToNetwork=$iface_isExpose where InterfaceName = '$iface_name';"
}

function checkInterfaceIPChanged()
{
  iface_name="$1"
  db_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where InterfaceName = '$iface_name';")
  current_ip=$(getIPAddressOfInterface $iface_name)
  # || [ "$db_ip" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]
  if [ "$(checkValidIPAddress $current_ip)" = "false" ] || [ -z "$db_ip" ] || [ -z "$current_ip" ] || [ "$db_ip" = "$current_ip" ] || [ "$current_ip" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
    echo "false"
    return
  fi
  is_private=$(checkIsIPPrivate "$current_ip")
  interface_subnet=$(getSubnetOfInterface "$iface_name" "$current_ip" "$is_private")
  if [ -z "$interface_subnet" ]; then
    echo "false"
    return
  fi
  chk_conflict=$(checkIPConflict "$current_ip" "$interface_subnet" "$is_private")
  if ! [ -z "$chk_conflict" ]; then
    echo "false"
    return
  fi
  echo "true"
}

function updateHSInterface()
{
  iface_name="$1"
  db_ip=$(sqlite3 $HSHQ_DB "select IPAddress from connections where InterfaceName = '$iface_name';")
  current_ip=$(getIPAddressOfInterface $iface_name)
  if [ "$(checkValidIPAddress $current_ip)" = "false" ]; then
    if ! [ "$db_ip" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
      curdt=$(getCurrentDate)
      sudo sqlite3 $HSHQ_DB "update connections set IPAddress = '$DEFAULT_UNFOUND_IP_ADDRESS', Network_Subnet = '$DEFAULT_UNFOUND_IP_SUBNET', LastUpdated = '$curdt' where InterfaceName = '$iface_name';" > /dev/null 2>&1
      return
    fi
    strMsg="updateHSInterface - Invalid IP address"
    echo "$strMsg"
    # Could be a lot of log spam, lets not log it
    #logHSHQEvent error "$strMsg"
    return 1
  fi
  if [ "$db_ip" = "$current_ip" ]; then
    strMsg="The IP address for $iface_name is unchanged ($current_ip). No updated needed."
    echo "$strMsg"
    return 2
  fi
  is_private=$(checkIsIPPrivate "$current_ip")
  interface_subnet=$(getSubnetOfInterface "$iface_name" "$current_ip" "$is_private")
  if [ -z "$interface_subnet" ]; then
    strMsg="updateHSInterface - There was an error obtaining the subnet of this interface ($iface_name)."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 3
  fi
  chk_conflict=$(checkIPConflict "$current_ip" "$interface_subnet" "$is_private")
  if ! [ -z "$chk_conflict" ]; then
    strMsg="updateHSInterface - $chk_conflict"
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 4
  fi
  if [ "$current_ip" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
    strMsg="updateHSInterface - The IP address is invalid ($DEFAULT_UNFOUND_IP_ADDRESS)."
    echo "$strMsg"
    logHSHQEvent error "$strMsg"
    return 4
  fi
  # Everything is good, the IP addresses are different, so proceed with update.
  curdt=$(getCurrentDate)
  sudo sqlite3 $HSHQ_DB "update connections set IPAddress = '$current_ip', Network_Subnet = '$interface_subnet', LastUpdated = '$curdt' where InterfaceName = '$iface_name';" > /dev/null 2>&1
  if [ "$iface_name" = "$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME" ]; then
    HOMESERVER_HOST_PRIMARY_INTERFACE_IP="$current_ip"
    updatePlaintextRootConfigVar HOMESERVER_HOST_PRIMARY_INTERFACE_IP $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
  fi
  strMsg="The IP address for $iface_name was changed from $db_ip to $current_ip."
  echo "$strMsg"
  logHSHQEvent info "$strMsg"
}

function checkUpdateHostInterface()
{
  set +e
  logHSHQEvent debug "checkUpdateHostInterface BEGIN"
  iface_operation="$1"
  iface_name="$2"
  is_close_hshq="$3"
  iface_isPrimary="$4"
  iface_isExpose="$5"
  #echo "iface_operation: $iface_operation, iface_name: $iface_name, iface_isPrimary: $iface_isPrimary, iface_isExpose: $iface_isExpose"
  primary_ip_prior=$HOMESERVER_HOST_PRIMARY_INTERFACE_IP
  case $iface_operation in
    add)
      if [ -z "$iface_name" ] || [ -z "$iface_isPrimary" ]; then
        strMsg="checkUpdateHostInterface - You must specify the interface name and if its the primary interface (true|false)."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 1
      fi
      addHSInterface $iface_name $iface_isPrimary
      if [ $? -ne 0 ]; then
        return 2
      fi
      if [ "$iface_isPrimary" = "true" ]; then
        return 3
      fi
      newIP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where InterfaceName='$iface_name';")
      ;;
    remove)
      if [ -z "$iface_name" ]; then
        strMsg="checkUpdateHostInterface - You must specify the interface name."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 4
      fi
      if [ "$iface_name" = "$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME" ]; then
        strMsg="checkUpdateHostInterface - You cannot remove the primary interface."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 5
      fi
      removeHSInterface "$iface_name"
      if [ $? -ne 0 ]; then
        return 6
      fi
      ;;
    setisprimary)
      if [ -z "$iface_name" ] || [ -z "$iface_isPrimary" ]; then
        strMsg="checkUpdateHostInterface - You must specify the interface name and if its the primary interface (true|false)."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 7
      fi
      if ! [ "$iface_isPrimary" = "true" ]; then
        strMsg="checkUpdateHostInterface - This operation is only for changing the primary interface."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 8
      fi
      if [ "$HOMESERVER_HOST_PRIMARY_INTERFACE_NAME" = "$iface_name" ]; then
        strMsg="checkUpdateHostInterface - The selected interface is already the primary interface."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 9
      fi
      setHSInterfaceAsPrimary "$iface_name"
      if [ $? -ne 0 ]; then
        return 10
      fi
      ;;
    setisexpose)
      if [ -z "$iface_name" ] || [ -z "$iface_isExpose" ]; then
        strMsg="checkUpdateHostInterface - You must specify the interface name and if its expose setting. (iface_name: $iface_name, iface_isExpose: $iface_isExpose)"
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 11
      fi
      if ! [ "$iface_isExpose" = "true" ] && ! [ "$iface_isExpose" = "false" ]; then
        strMsg="checkUpdateHostInterface - The expose setting must be either true or false. (iface_name: $iface_name, iface_isExpose: $iface_isExpose)"
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 12
      fi
      setHSInterfaceIsExpose "$iface_name" "$iface_isExpose"
      if [ $? -ne 0 ]; then
        return 13
      fi
      ;;
    update)
      logHSHQEvent debug "checkUpdateHostInterface Update 1"
      if [ -z "$iface_name" ]; then
        strMsg="checkUpdateHostInterface - You must specify the interface name."
        echo "$strMsg"
        logHSHQEvent error "$strMsg"
        return 14
      fi
      logHSHQEvent debug "checkUpdateHostInterface Update 2"
      updateHSInterface "$iface_name"
      if [ $? -ne 0 ]; then
        return 15
      fi
      logHSHQEvent debug "checkUpdateHostInterface Update 3"
      updateIP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where InterfaceName='$iface_name';")
      ;;
    *)
      strMsg="checkUpdateHostInterface - Unknown operation."
      echo "$strMsg"
      logHSHQEvent error "$strMsg"
      return 16
      ;;
  esac
  case $iface_operation in
    add|update)
      logHSHQEvent debug "checkUpdateHostInterface Update 3"
      if ! [ "$newIP" = "127.0.0.1" ]; then
        logHSHQEvent debug "checkUpdateHostInterface Update 4"
        # Regenerate Portainer and Script-server certs
        certIPList="127.0.0.1"
        ifListDBID=($(sqlite3 $HSHQ_DB "select ID from connections where NetworkType = 'home_network';"))
        for curID in "${ifListDBID[@]}"
        do
          curIF_IP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID = $curID;")
          if [ "$(checkValidIPAddress $curIF_IP)" = "true" ] && ! [ "$curIF_IP" = "$DEFAULT_UNFOUND_IP_ADDRESS" ] && ! [ "$curIF_IP" = "127.0.0.1" ]; then
            certIPList="$certIPList","$curIF_IP"
          fi
        done
        logHSHQEvent debug "checkUpdateHostInterface Update 5"
        generateCert portainer portainer "$certIPList" "$(date -u -d "86401 seconds ago" '+%Y-%m-%d %H:%M:%S') GMT"
        generateCert script-server "script-server,host.docker.internal,localhost" "$certIPList" "$(date -u -d "86401 seconds ago" '+%Y-%m-%d %H:%M:%S') GMT"
      fi
      ;;
  esac
  case $iface_operation in
    add|remove|setisprimary|update)
      logHSHQEvent debug "checkUpdateHostInterface Update 6"
      updateSvcsIPChanges
      logHSHQEvent debug "checkUpdateHostInterface Update 7"
      ;;
  esac
  case $iface_operation in
    setisprimary|update)
      if [ "$(checkValidIPAddress $primary_ip_prior)" = "true" ] && [ "$(checkValidIPAddress $HOMESERVER_HOST_PRIMARY_INTERFACE_IP)" = "true" ] && ! [ "$primary_ip_prior" = "$HOMESERVER_HOST_PRIMARY_INTERFACE_IP" ]; then
        logHSHQEvent debug "checkUpdateHostInterface Update 8"
        sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set url='https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT' where url like '%$primary_ip_prior:$PORTAINER_LOCAL_HTTPS_PORT%';" > /dev/null 2>&1
        sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set url='https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT' where url like '%$primary_ip_prior:$SCRIPTSERVER_LOCALHOST_PORT%';" > /dev/null 2>&1
        docker container restart heimdall > /dev/null 2>&1
        addDomainAndWildcardAdguardHS $HOMESERVER_DOMAIN $HOMESERVER_HOST_PRIMARY_INTERFACE_IP > /dev/null 2>&1
        logHSHQEvent debug "checkUpdateHostInterface Update 9"
      fi
      ;;
  esac
  # Update IP tables
  checkUpdateAllIPTables checkUpdateHostInterface
  case $iface_operation in
    add)
      # Add Caddy instance
      if [ "$iface_isExpose" = "true" ]; then
        installHostInterfaceCaddy "$iface_name" "$newIP"
        if [ "$newIP" = "127.0.0.1" ]; then
          startStopStack caddy-home-$iface_name stop > /dev/null 2>&1
          sudo sqlite3 $HSHQ_DB "update connections set IPAddress = '$DEFAULT_UNFOUND_IP_ADDRESS', Network_Subnet = '$DEFAULT_UNFOUND_IP_SUBNET' where ID=$curID;" > /dev/null 2>&1
          updatePortainerEnv
        fi
      fi
      ;;
    update)
      logHSHQEvent debug "checkUpdateHostInterface Update 10"
      # Restart caddy-home stacks
      if [ "$(checkValidIPAddress $updateIP)" = "true" ] && ! [ "$updateIP" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
        logHSHQEvent debug "checkUpdateHostInterface Update 11"
        startStopStack caddy-home-$iface_name stop > /dev/null 2>&1
        docker container stop caddy-home-$iface_name > /dev/null 2>&1
        docker container rm caddy-home-$iface_name > /dev/null 2>&1
        sleep 1
        startStopStack caddy-home-$iface_name start > /dev/null 2>&1
        logHSHQEvent debug "checkUpdateHostInterface Update 12"
      fi
      ;;
    *)
      ;;
  esac
  case $iface_operation in
    add|update)
      logHSHQEvent debug "checkUpdateHostInterface Update 13"
      if ! [ "$is_close_hshq" = "false" ]; then
        logHSHQEvent debug "checkUpdateHostInterface Update 14, is_close_hshq: $is_close_hshq"
        performExitFunctions false
        logHSHQEvent debug "checkUpdateHostInterface Update 15"
        set +e
      fi
      sleep 2
      logHSHQEvent debug "checkUpdateHostInterface Update 16"
      sudo systemctl restart runScriptServer
      ;;
  esac
  logHSHQEvent debug "checkUpdateHostInterface END"
}

function addFirewallSubnet()
{
  ruleName="$1"
  subnet="${2}/${3}"
  if [ $(checkValidStringUpperLowerNumbers "$ruleName" "-") = "false" ]; then
    strMsg="The rule name is invalid. It must consist of a-z (lowercase), 0-9, and/or -, no spaces."
    echo "ERROR: $strMsg"
    return 1
  fi
  chkExist=$(sqlite3 $HSHQ_DB "select Name from customfwsubnet where Name='$ruleName' and Subnet='$subnet';")
  if ! [ -z "$chkExist" ]; then
    strMsg="This rule name and subnet combo already exists..."
    echo "ERROR: $strMsg"
    return 2
  fi
  sudo sqlite3 $HSHQ_DB "insert into customfwsubnet(Name,Subnet) values('$ruleName','$subnet');"
}

function removeFirewallSubnet()
{
  db_id=$1
  sudo sqlite3 $HSHQ_DB "PRAGMA foreign_keys=ON;delete from customfwsubnet where ID=$db_id;"
  checkUpdateAllIPTables removeFirewallSubnet
}

function updateSvcsIPChanges()
{
  if [ "$IS_INSTALLED" = "false" ]; then
    return
  fi
  updatePortainerEnv
  set +e
  docker ps | grep jitsi-web > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    startStopStack jitsi stop > /dev/null 2>&1
    startStopStack jitsi start > /dev/null 2>&1
  fi
  updateCoturnAllowedIPs
}

function checkHostInterfacesIsChanged()
{
  interfaceListArr=($(echo $HOMESERVER_HOST_NETWORK_INTERFACES | tr "," "\n"))
  for curInterface in "${interfaceListArr[@]}"
  do
    checkIsChanged=$(checkInterfaceIPChanged "$curInterface")
    if [ "$checkIsChanged" = "true" ]; then
      echo "true"
      return
    fi
  done
  echo "false"
}

function checkHostAllInterfaceIPChanges()
{
  isBypassHSHQStatus=$1
  isCloseHSHQ="$2"
  callerName="$3"
  logHSHQEvent debug "checkHostAllInterfaceIPChanges BEGIN"
  set +e
  timeout 5 docker ps > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "Docker is not yet up and running, returning..."
    return 1
  fi
  if [ "$(checkHostInterfacesIsChanged)" = "false" ]; then
    # Nothing has changed, no need to continue
    return
  fi
  logHSHQEvent debug "checkHostAllInterfaceIPChanges Check 1"
  if [ -z "$$callerName" ]; then
    callerName=checkHostAllInterfaceIPChanges
  fi
  tgLock="true"
  if ! [ "$isBypassHSHQStatus" = "true" ]; then
    tgLock="$(tryGetLock hshqopen $callerName)"
  fi
  logHSHQEvent debug "checkHostAllInterfaceIPChanges Check 2"
  if ! [ "$tgLock" = "true" ]; then
    checkRes="$(getLockOpenMsg hshqopen)"
    echo "The HSHQ script is running in another instance ($checkRes), returning..."
    logHSHQEvent error "checkHostAllInterfaceIPChanges - The HSHQ script is already open or running in a different instance ($checkRes)"
    return
  fi
  logHSHQEvent debug "checkHostAllInterfaceIPChanges Check 3"
  interfaceListArr=($(echo $HOMESERVER_HOST_NETWORK_INTERFACES | tr "," "\n"))
  isUpdateIPT=false
  for curInterface in "${interfaceListArr[@]}"
  do
    checkUpdateHostInterface update "$curInterface" "$isCloseHSHQ" na na
    if [ $? -eq 0 ]; then
      isUpdateIPT=true
    fi
  done
  logHSHQEvent debug "checkHostAllInterfaceIPChanges Check 4"
  if ! [ "$isBypassHSHQStatus" = "true" ]; then
    releaseLock hshqopen "$callerName" false
  fi
  logHSHQEvent debug "checkHostAllInterfaceIPChanges Check 5"
}

function checkUpdateSingleHostInterface()
{
  curInterface="$1"
  checkUpdateHostInterface update $curInterface true na na
  if [ $? -eq 0 ]; then
    checkUpdateAllIPTables checkUpdateSingleHostInterface
  fi
}

function logHSHQEvent()
{
  msgType="$1"
  msgContent="$2"
  isLogit=false
  # We'll have to clean up this logic later for all message types,
  # i.e. debug, info, warn, error...,but for now this is good enough
  case "$LOG_LEVEL" in
    info)
      if ! [ "$msgType" = "debug" ]; then
        isLogit=true
      fi
    ;;
    debug)
      isLogit=true
    ;;
  esac
  if [ "$isLogit" = "true" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S.%3N') [$msgType] $msgContent" >> $HSHQ_LOG_FILE
  fi
}

function updateExposedPortsLists()
{
  selectedChain="$1"
  selectedList="$2"
  selectedPorts="$3"
  if ! [ -z "$selectedPorts" ]; then
    checkValidPortsList "$selectedPorts"
    if [ $? -ne 0 ]; then
      strMsg="There was an error with the ports list: $selectedPorts"
      logHSHQEvent error "updateExposedPortsLists (checkValidPortsList) - $strMsg"
      echo "ERROR: $strMsg"
      return 1
    fi
  fi
  if [ "$selectedChain" = "INPUT" ] && ! [ -z "$selectedPorts" ]; then
    checkValidINPUTChainPortsList "$selectedPorts"
    if [ $? -ne 0 ]; then
      strMsg="There was an error with the INPUT chain ports list: $selectedPorts"
      logHSHQEvent error "updateExposedPortsLists INPUT chain (checkValidPortsList) - $strMsg"
      echo "ERROR: $strMsg"
      return 2
    fi
  fi
  checkCustom=$(echo "$selectedList" | cut -d" " -f2 | xargs)
  if [ "${selectedList: -8}" = "_DEFAULT" ]; then
    echo "Default list updated - $selectedList"
    updatePlaintextUserConfigVar "$selectedList" "$selectedPorts"
  elif [ "$checkCustom" = "(Custom)" ]; then
    intID=$(echo "$selectedList" | cut -d" " -f1 | xargs)
    if [ "$selectedChain" = "INPUT" ]; then
      sudo sqlite3 $HSHQ_DB "update customfwsubnet set InputAllowPorts='$selectedPorts' where ID=$intID;"
    elif [ "$selectedChain" = "DOCKER-USER" ]; then
      sudo sqlite3 $HSHQ_DB "update customfwsubnet set DockerUserAllowPorts='$selectedPorts' where ID=$intID;" 
    fi
    echo "Applying results to firewall..."
    checkUpdateAllIPTables updatePorts1
    echo "Edits to firewall completed successfully!"
  else
    intName=$(echo "$selectedList" | cut -d" " -f1 | xargs)
    if [ "$selectedChain" = "INPUT" ]; then
      sudo sqlite3 $HSHQ_DB "update connections set InputAllowPorts='$selectedPorts' where InterfaceName='$intName';"
    elif [ "$selectedChain" = "DOCKER-USER" ]; then
      sudo sqlite3 $HSHQ_DB "update connections set DockerUserAllowPorts='$selectedPorts' where InterfaceName='$intName';"
      # Check 
    fi
    echo "Applying results to firewall..."
    checkUpdateAllIPTables updatePorts2
    echo "Edits to firewall completed successfully!"
  fi
}

function isProgramInstalled()
{
  bin_name=$(echo $1 | cut -d"|" -f1)
  lib_name=$(echo $1 | cut -d"|" -f2)
  if [[ -z "$(sudo which ${bin_name})" ]]; then
    echo "false"
  else
    echo "true"
  fi
}

function installDocker()
{
  set +e
  outputDockerSettings
  util="docker|docker"
  if [[ "$(isProgramInstalled $util)" = "true" ]]; then
    sudo systemctl restart rsyslog
    sudo systemctl restart docker
    return 0
  fi
  performAptInstall ca-certificates > /dev/null 2>&1
  performAptInstall curl > /dev/null 2>&1
  performAptInstall gnupg > /dev/null 2>&1
  performAptInstall lsb-release > /dev/null 2>&1
  case "$DISTRO_ID" in
  "ubuntu")
    if [[ "$DISTRO_VERSION" =~ ^22\.04. ]]; then
      installDockerUbuntu2204
    elif [[ "$DISTRO_VERSION" =~ ^24\.04. ]]; then
      installDockerUbuntu2404
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  "debian")
    if [[ "$DISTRO_VERSION" =~ ^12. ]]; then
      installDockerDebian12
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  "linuxmint")
    if [[ "$DISTRO_VERSION" =~ ^22. ]]; then
      installDockerUbuntu2404
    elif [[ "$DISTRO_VERSION" =~ ^6. ]]; then
      installDockerDebian12
    else
      echo "Linux version not found when installing Docker, exiting..."
      exit 5
    fi
    ;;
  *)
    ;;
  esac
  # See https://www.portainer.io/blog/portainer-and-docker-26
  sudo apt-mark hold docker-ce
  sudo apt-mark hold docker-ce-cli
  sudo systemctl restart rsyslog
  sudo systemctl restart docker
}

function removeDocker()
{
  sudo systemctl stop docker
  sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y --purge docker-engine docker docker.io docker-ce docker-compose
  sudo rm -rf /var/lib/docker /etc/docker
  sudo rm -rf /etc/apparmor.d/docker
  sudo rm -rf /var/run/docker.sock
  sudo rm -rf /usr/local/bin/docker-compose
  sudo rm -rf /etc/docker
  sudo rm -rf ~/.docker
  sudo rm -rf /usr/share/keyrings/docker-archive-keyring.gpg
  sudo rm -rf /etc/apt/sources.list.d/docker.list
  sudo groupdel docker
}

function outputDockerSettings()
{
  sudo mkdir -p /etc/docker
  if [ -z "$DOCKER_NETWORK_RESERVED_RANGE" ]; then
    DOCKER_NETWORK_RESERVED_RANGE=172.16.0.0/15
  fi
  if [ -z "$DOCKER_NETWORK_SIZE" ]; then
    DOCKER_NETWORK_SIZE=24
  fi
  if [ -z "$DOCKER_METRICS_PORT" ]; then
    DOCKER_METRICS_PORT=8323
  fi
  outputDockerDaemonJson
  sudo tee /etc/rsyslog.d/docker-logs.conf >/dev/null <<EOFRL
\$FileCreateMode 0644
\$template DockerDaemonLogFileName,"/var/log/docker/docker.log"
\$template DockerContainerLogFileName,"/var/log/docker/%SYSLOGTAG:R,ERE,1,FIELD:docker/(.*)\[--end:secpath-replace%.log"
if \$programname == 'dockerd' then {
  ?DockerDaemonLogFileName
  stop
}
if \$programname == 'containerd' then {
  ?DockerDaemonLogFileName
  stop
}
if \$programname == 'docker' then {
  if \$syslogtag contains 'docker/' then {
  ?DockerContainerLogFileName
  stop
  }
}
\$FileCreateMode 0600
EOFRL

}

function outputDockerDaemonJson()
{
  sudo tee /etc/docker/daemon.json >/dev/null <<EOFRL
{
  "default-address-pools":
  [
    {"base":"$DOCKER_NETWORK_RESERVED_RANGE","size":$DOCKER_NETWORK_SIZE}
  ],
  "log-driver": "syslog",
  "log-opts": {
    "syslog-address": "unixgram:///dev/log",
    "tag": "docker/{{.Name}}"
  },
  "ipv6": false,
  "metrics-addr": "0.0.0.0:$DOCKER_METRICS_PORT",
  "registry-mirrors": ["https://mirror.gcr.io"]
}
EOFRL
}

function installDockerUbuntu2204()
{
  # Install Docker (https://docs.docker.com/engine/install/ubuntu/)
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg --yes
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update
  echo "Installing docker, please wait..."
  performAptInstall docker-ce=$DOCKER_VERSION_UBUNTU_2204 > /dev/null 2>&1
  performAptInstall docker-ce-cli=$DOCKER_VERSION_UBUNTU_2204 > /dev/null 2>&1
  performAptInstall containerd.io > /dev/null 2>&1
  performAptInstall docker-compose > /dev/null 2>&1
  performAptInstall docker-compose-plugin > /dev/null 2>&1
}

function installDockerUbuntu2404()
{
  # Install Docker (https://docs.docker.com/engine/install/ubuntu/)
  sudo install -m 0755 -d /etc/apt/keyrings
  sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  sudo chmod a+r /etc/apt/keyrings/docker.asc
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$UBUNTU_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update
  echo "Installing docker, please wait..."
  performAptInstall docker-ce=$DOCKER_VERSION_UBUNTU_2404 > /dev/null 2>&1
  performAptInstall docker-ce-cli=$DOCKER_VERSION_UBUNTU_2404 > /dev/null 2>&1
  performAptInstall containerd.io > /dev/null 2>&1
  performAptInstall docker-buildx-plugin > /dev/null 2>&1
  performAptInstall docker-compose-plugin > /dev/null 2>&1  
}

function installDockerDebian12()
{
  # Install Docker (https://docs.docker.com/engine/install/debian/)
  sudo install -m 0755 -d /etc/apt/keyrings
  sudo curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  sudo chmod a+r /etc/apt/keyrings/docker.asc
  echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
  sudo DEBIAN_FRONTEND=noninteractive apt update
  echo "Installing docker, please wait..."
  performAptInstall docker-ce=$DOCKER_VERSION_DEBIAN_12 > /dev/null 2>&1
  performAptInstall docker-ce-cli=$DOCKER_VERSION_DEBIAN_12 > /dev/null 2>&1
  performAptInstall containerd.io > /dev/null 2>&1
  performAptInstall docker-compose > /dev/null 2>&1
  performAptInstall docker-compose-plugin > /dev/null 2>&1  
}

function initCertificateAuthority()
{
  if [ "$CERTS_IS_CA_INIT" = "true" ]; then
    return 0
  fi
  if [[ "$(isProgramInstalled openssl)" = "false" ]]; then
    echo "Installing openssl, please wait..."
    performAptInstall openssl > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled faketime)" = "false" ]]; then
    echo "Installing faketime, please wait..."
    performAptInstall faketime > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled bc)" = "false" ]]; then
    echo "Installing bc, please wait..."
    performAptInstall bc > /dev/null 2>&1
  fi
  if [[ "$(isProgramInstalled htpasswd)" = "false" ]]; then
    echo "Installing htpasswd, please wait..."
    performAptInstall apache2-utils > /dev/null 2>&1
  fi

  if [ -z "$CERTS_ROOT_CA_NAME" ]; then
    CERTS_ROOT_CA_NAME=${HOMESERVER_DOMAIN}-ca
    updatePlaintextRootConfigVar CERTS_ROOT_CA_NAME $CERTS_ROOT_CA_NAME
  fi
  while [ -z "$CERTS_INTERNAL_COUNTRY" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      CERTS_INTERNAL_COUNTRY="US"
    else
      CERTS_INTERNAL_COUNTRY=$(promptUserInputMenu "US" "Enter Certificate Country" "Enter the country abbreviation you would like to appear on your certificates: ")
      if [ -z "$CERTS_INTERNAL_COUNTRY" ]; then
        showMessageBox "Empty Value" "The country cannot be empty."
      elif [ $(checkValidStringUpper "$CERTS_INTERNAL_COUNTRY") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The country contains invalid character(s). It must consist of exactly 2 uppercase letters."
        CERTS_INTERNAL_COUNTRY=""
      elif [ $(getStringLength "$CERTS_INTERNAL_COUNTRY") -ne 2 ]; then
        showMessageBox "Invalid Length" "The country code must be exactly 2 characters."
        CERTS_INTERNAL_COUNTRY=""
      fi
    fi
    updatePlaintextRootConfigVar CERTS_INTERNAL_COUNTRY "$CERTS_INTERNAL_COUNTRY"
  done
  while [ -z "$CERTS_INTERNAL_STATE" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      CERTS_INTERNAL_STATE="Missouri"
    else
      CERTS_INTERNAL_STATE=$(promptUserInputMenu "Missouri" "Enter Certificate State" "Enter the state name you would like to appear on your certificates: ")
      if [ -z "$CERTS_INTERNAL_STATE" ]; then
        showMessageBox "Empty Value" "The state cannot be empty."
      elif [ $(checkValidStringUpperLowerNumbers "$CERTS_INTERNAL_STATE" "[:space:].,-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The state contains invalid character(s). It must consist of a-z, A-Z, 0-9, spaces, hyphens, commas or periods."
        CERTS_INTERNAL_STATE=""
      fi
    fi
    updatePlaintextRootConfigVar CERTS_INTERNAL_STATE "$CERTS_INTERNAL_STATE"
  done
  while [ -z "$CERTS_INTERNAL_LOCALITY" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      CERTS_INTERNAL_LOCALITY="St. Louis"
    else
      CERTS_INTERNAL_LOCALITY=$(promptUserInputMenu "St. Louis" "Enter Certificate Locality" "Enter the locality you would like to appear on your certificates: ")
      if [ -z "$CERTS_INTERNAL_LOCALITY" ]; then
        showMessageBox "Empty Value" "The locality cannot be empty."
      elif [ $(checkValidStringUpperLowerNumbers "$CERTS_INTERNAL_LOCALITY" "[:space:].,-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The state contains invalid character(s). It must consist of a-z, A-Z, 0-9, spaces, hyphens, commas or periods."
        CERTS_INTERNAL_LOCALITY=""
      fi
    fi
    updatePlaintextRootConfigVar CERTS_INTERNAL_LOCALITY "$CERTS_INTERNAL_LOCALITY"
  done
  while [ -z "$CERTS_INTERNAL_ROOT_CN" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      CERTS_INTERNAL_ROOT_CN="$HOMESERVER_NAME Root CA"
    else
      CERTS_INTERNAL_ROOT_CN=$(promptUserInputMenu "$HOMESERVER_NAME Root CA" "Enter Certificate Root CN" "Enter the root CN you would like to appear on your certificates: ")
      if [ -z "$CERTS_INTERNAL_ROOT_CN" ]; then
        showMessageBox "Empty Value" "The root CN cannot be empty."
      elif [ $(checkValidStringUpperLowerNumbers "$CERTS_INTERNAL_ROOT_CN" "[:space:].,-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The root CN contains invalid character(s). It must consist of a-z, A-Z, 0-9, spaces, hyphens, commas or periods."
        CERTS_INTERNAL_ROOT_CN=""
      fi
    fi
    updatePlaintextRootConfigVar CERTS_INTERNAL_ROOT_CN "$CERTS_INTERNAL_ROOT_CN"
  done
  while [ -z "$CERTS_INTERNAL_INTERMEDIATE_CN" ]
  do
    if [ "$IS_ACCEPT_DEFAULTS" = "yes" ]; then
      CERTS_INTERNAL_INTERMEDIATE_CN="$HOMESERVER_NAME ECC Intermediate"
    else
      CERTS_INTERNAL_INTERMEDIATE_CN=$(promptUserInputMenu "$HOMESERVER_NAME ECC Intermediate" "Enter Certificate Intermediate CN" "Enter the intermediate CN you would like to appear on your certificates: ")
      if [ -z "$CERTS_INTERNAL_INTERMEDIATE_CN" ]; then
        showMessageBox "Empty Value" "The intermediate CN cannot be empty."
      elif [ $(checkValidStringUpperLowerNumbers "$CERTS_INTERNAL_INTERMEDIATE_CN" "[:space:].,-") = "false" ]; then
        showMessageBox "Invalid Character(s)" "The intermediate CN contains invalid character(s). It must consist of a-z, A-Z, 0-9, spaces, hyphens, commas or periods."
        CERTS_INTERNAL_INTERMEDIATE_CN=""
      fi
    fi
    updatePlaintextRootConfigVar CERTS_INTERNAL_INTERMEDIATE_CN "$CERTS_INTERNAL_INTERMEDIATE_CN"
  done

  if [ -z "$CERTS_INTERNAL_ORG_NAME" ]; then
    CERTS_INTERNAL_ORG_NAME="$HOMESERVER_NAME"
    updatePlaintextRootConfigVar CERTS_INTERNAL_ORG_NAME "$CERTS_INTERNAL_ORG_NAME"
  fi

  if [ -f $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt ]; then
    showYesNoMessageBox "Root CA Exists" "Root CA certificate($HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt) exists.\nDo you wish to bypass this step and continue installing?"
	mbres=$?
	if [ $mbres -eq 0 ]; then
      return
	else
	  exit 1
    fi
  fi
  # Certificate Authority Key
  openssl genrsa -out $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key 4096

  cat <<EOFCA > $HOME/ca.conf 
[ req ]
distinguished_name = req_distinguished_name
prompt = no
x509_extensions = v3_ca

[ req_distinguished_name ]
C   = $CERTS_INTERNAL_COUNTRY
ST  = $CERTS_INTERNAL_STATE
L   = $CERTS_INTERNAL_LOCALITY
O   = $CERTS_INTERNAL_ORG_NAME
OU  = $CERTS_INTERNAL_OU_NAME
CN  = $CERTS_INTERNAL_ROOT_CN

[ v3_ca ]
basicConstraints = critical,CA:TRUE
subjectKeyIdentifier=hash
authorityKeyIdentifier=keyid:always,issuer
keyUsage = critical, cRLSign, keyCertSign
EOFCA
  totDays=$(echo "($(if (( $(echo "$(date --date="$CERTS_INTERNAL_CA_DAYS days" +%s.%N) < 3137754960" | bc -l) )); then echo 3137754960; else echo $(date --date="$CERTS_INTERNAL_CA_DAYS days" +%s.%N); fi)-1559365200)/86400" | bc)

  # Certificate Authority Certificate
  # Regarding faketime, see https://support.apple.com/en-us/HT210176
  faketime '2019-06-01 16:38:01 GMT' openssl req -new -x509 -sha256 -nodes -days $totDays -key $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key -out $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -config $HOME/ca.conf
  # Create a DER format for root cert
  openssl x509 -in $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -out $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der -outform DER
  rm -f $HOME/ca.conf

  chmod 0400 $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key
  chmod 0444 $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt
  chmod 0444 $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der

  sudo cp $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt /usr/local/share/ca-certificates/
  sudo update-ca-certificates

  CERTS_IS_CA_INIT=true
  updatePlaintextRootConfigVar CERTS_IS_CA_INIT $CERTS_IS_CA_INIT
}

function initDHParams()
{
  echo "Generating DH parameters, $CERTS_INTERNAL_DHPARAMS_KEYLENGTH bit long safe prime..."
  openssl dhparam -out $HSHQ_SSL_DIR/dhparam.pem $CERTS_INTERNAL_DHPARAMS_KEYLENGTH > /dev/null 2>&1
  chmod 0444 $HSHQ_SSL_DIR/dhparam.pem
}

function generateCert()
{
  CERT_NAME=$1
  DNS="$2"
  IPS="$3"
  FT_START_DATE="$4"
  FT_END_DATE="$5"
  COMMON_NAME=$(echo $DNS | sed 's|,|\n|g' | sed -n '1p')

  if ! [ -f $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key ]; then
    echo "Certificate Authority key does not exist. Please generate a CA key and certificate first, exiting..."
    return 1
  fi
  num_days=$CERTS_INTERNAL_CA_DAYS
  cur_date_seconds=$(date +%s)
  if ! [ -z "$FT_START_DATE" ]; then
    start_date_seconds=$(date -d "$FT_START_DATE" +%s)
  fi
  if ! [ -z "$FT_END_DATE" ]; then
    end_date_seconds=$(date -d "$FT_END_DATE" +%s)
    if [ $(($end_date_seconds - $cur_date_seconds)) -lt 86400 ]; then
      echo "ERROR: End date must be at least a day after current date."
      return 1
    fi
    num_days=$(($(($end_date_seconds - $(date +%s))) / 86400))
  fi
  if ! [ -z "$FT_START_DATE" ] && ! [ -z "$FT_END_DATE" ]; then
    if [ $(($end_date_seconds - $start_date_seconds)) -lt 86400 ]; then
      echo "ERROR: End date must be at least a day after start date."
      return 1
    fi
    num_days=$(($(($end_date_seconds - $start_date_seconds)) / 86400))
  fi

  rm -f $HSHQ_SSL_DIR/$CERT_NAME.key
  rm -f $HSHQ_SSL_DIR/$CERT_NAME.crt

  # Generate certificate key
  openssl genrsa -out $HSHQ_SSL_DIR/$CERT_NAME.key 4096

  cat <<EOFCN > $HOME/$CERT_NAME-csr.cnf
[ req ]
distinguished_name = req_distinguished_name
prompt = no
req_extensions = req_ext

[ req_distinguished_name ]
C   = $CERTS_INTERNAL_COUNTRY
ST  = $CERTS_INTERNAL_STATE
L   = $CERTS_INTERNAL_LOCALITY
O   = $CERTS_INTERNAL_ORG_NAME
OU  = $CERTS_INTERNAL_OU_NAME
CN  = $COMMON_NAME

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
EOFCN

  cat <<EOFCN > $HOME/$CERT_NAME-ext.cnf
basicConstraints = CA:FALSE
nsComment = "OpenSSL Certificate Generated By $HOMESERVER_NAME"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
keyUsage = critical, digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth,clientAuth
subjectAltName = @alt_names

[ alt_names ]
EOFCN

  dnslist=$(sed 's|,|\n|g' <<< $DNS)
  ipnum=1
  for dn in $dnslist
  do
    echo "DNS."$ipnum" = "$dn >> $HOME/$CERT_NAME-csr.cnf
    echo "DNS."$ipnum" = "$dn >> $HOME/$CERT_NAME-ext.cnf
    ((ipnum++))
  done

  iplist=$(sed 's|,|\n|g' <<< $IPS)
  ipnum=1
  for ip in $iplist
  do
    echo "IP."$ipnum" = "$ip >> $HOME/$CERT_NAME-csr.cnf
    echo "IP."$ipnum" = "$ip >> $HOME/$CERT_NAME-ext.cnf
    ((ipnum++))
  done

  # Generate certificate request
  openssl req -config $HOME/$CERT_NAME-csr.cnf -new -sha256 -key $HSHQ_SSL_DIR/$CERT_NAME.key -out $HOME/$CERT_NAME.csr
  # Sign certificate
  if [ -z "$FT_START_DATE" ]; then
    openssl x509 -req -sha256 -days $num_days \
    -in $HOME/$CERT_NAME.csr -CA $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -CAkey $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key \
    -out $HSHQ_SSL_DIR/$CERT_NAME.crt -extfile $HOME/$CERT_NAME-ext.cnf -CAcreateserial
  else
    faketime "$FT_START_DATE" openssl x509 -req -sha256 -days $num_days \
    -in $HOME/$CERT_NAME.csr -CA $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt -CAkey $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.key \
    -out $HSHQ_SSL_DIR/$CERT_NAME.crt -extfile $HOME/$CERT_NAME-ext.cnf -CAcreateserial
  fi

  rm -f $HOME/$CERT_NAME-csr.cnf
  rm -f $HOME/$CERT_NAME-ext.cnf
  rm -f $HOME/$CERT_NAME.csr

  chmod 0444 $HSHQ_SSL_DIR/$CERT_NAME.key
  chmod 0444 $HSHQ_SSL_DIR/$CERT_NAME.crt
  chown $USERID:$GROUPID $HSHQ_SSL_DIR/$CERT_NAME.key
  chown $USERID:$GROUPID $HSHQ_SSL_DIR/$CERT_NAME.crt
}

function generateCertDialog()
{
  set +e

  cert_name=""
  while [ -z "$cert_name" ]
  do
    cert_name=$(promptUserInputMenu "" "Enter Certificate Filename" "Enter the filename for this certificate:")
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return 1
    fi
    if [ -z "$cert_name" ]; then
      showMessageBox "Filename Empty" "The Filename cannot be empty"
    fi
  done

  cert_dom_string=""
  while [ -z "$cert_dom_string" ]
  do
    cert_dom_string=$(promptUserInputMenu "" "Enter Certificate CN" "Enter the domain names for this certificate. Domain names should be grouped together as a comma separated list:")
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return 1
    fi
    if [ -z "$cert_dom_string" ]; then
      showMessageBox "Domain Name Empty" "The Domain Name cannot be empty"
    fi
  done

  cert_ip_string=$(promptUserInputMenu "" "Enter IP Addresses" "Enter the IP addresses for this certificate. IP addresses should be grouped together as a comma separated list:")

  ft_string=""
  while [ -z "$ft_string" ]
  do
    ft_string=$(promptUserInputMenu "$(date '+%Y-%m-%d %H:%M:%S %Z')" "Enter Start Date" "Enter the Start Date for the Certificate. It must be formatted as follows - 2023-01-01 00:00:00 GMT:")
    mbres=$?
    if [ $mbres -ne 0 ]; then
      return 1
    fi
    if [ -z "$ft_string" ]; then
      showMessageBox "Date Empty" "The Date cannot be empty"
    fi
  done

  generateCert "$cert_name" "$cert_dom_string" "$cert_ip_string" "$ft_string"
}

function getUpdateAssets()
{
  if [ -d $HSHQ_ASSETS_DIR/.git ]; then
    git -C $HSHQ_ASSETS_DIR pull > /dev/null
  else
    git clone https://github.com/homeserverhq/assets.git $HSHQ_ASSETS_DIR
  fi
}

function pullImage()
{
  img_and_version=$1
  secs_mult=60
  logHSHQEvent info "Pulling Image: $img_and_version"
  echo "Pulling Image: $img_and_version"
  is_success=1
  num_tries=1
  set +e
  while [ $is_success -ne 0 ] && [ $num_tries -lt $MAX_DOCKER_PULL_TRIES ]
  do
    if [ $num_tries -lt $(($MAX_DOCKER_PULL_TRIES-1)) ]; then
      #timeout $(($num_tries*$secs_mult)) docker pull $img_and_version
      docker pull $img_and_version
    else
      docker pull $img_and_version
    fi
    if [ $? -eq 0 ]; then
      docker image inspect $img_and_version > /dev/null 2>&1
      is_success=$?
    else
      is_success=1
    fi
    ((num_tries++))
  done
  if [ $is_success -ne 0 ]; then
    echo "Error pulling docker image: $img_and_version"
    return 5
  fi
}

function createDockerNetworks()
{
  docker network create -o com.docker.network.bridge.name=$NET_EXTERNAL_BRIDGE_NAME --driver=bridge --subnet $NET_EXTERNAL_SUBNET dock-ext > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_WEBPROXY_BRIDGE_NAME --driver=bridge --subnet $NET_WEBPROXY_SUBNET --internal dock-proxy > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_PRIVATEIP_BRIDGE_NAME --driver=bridge --subnet $NET_PRIVATEIP_SUBNET dock-privateip > /dev/null
  checkUpdateDockerPrivateIP
  docker network create -o com.docker.network.bridge.name=$NET_INTERNALMAIL_BRIDGE_NAME --driver=bridge --subnet $NET_INTERNALMAIL_SUBNET --internal dock-internalmail > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_DBS_BRIDGE_NAME --driver=bridge --subnet $NET_DBS_SUBNET --internal dock-dbs > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_LDAP_BRIDGE_NAME --driver=bridge --subnet $NET_LDAP_SUBNET --internal dock-ldap > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_MAILU_EXT_BRIDGE_NAME --driver=bridge --subnet $NET_MAILU_EXT_SUBNET dock-mailu-ext > /dev/null
  docker network create -o com.docker.network.bridge.name=$NET_MAILU_INT_BRIDGE_NAME --driver=bridge --subnet $NET_MAILU_INT_SUBNET --internal dock-mailu-int > /dev/null
}

function removeDockerNetworks()
{
  docker network rm dock-ext > /dev/null 2>&1
  docker network rm dock-proxy > /dev/null 2>&1
  docker network rm dock-privateip > /dev/null 2>&1
  docker network rm dock-internalmail > /dev/null 2>&1
  docker network rm dock-dbs > /dev/null 2>&1
  docker network rm dock-ldap > /dev/null 2>&1
  docker network rm dock-mailu-ext > /dev/null 2>&1
  docker network rm dock-mailu-int > /dev/null 2>&1
}

function notifyStackInstallFailure()
{
  sf_stack_name=$1
  sendEmail -s "Stack Installation Failure ($sf_stack_name)" -b "$sf_stack_name did not install correctly. Please uninstall this stack and reinstall. If the error persists, then create a topic on the forum (https://forum.homeserverhq.com)." -f "$(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
}

function checkStackHSHQManaged()
{
  check_hshq_managed="$1"
  echo "$check_hshq_managed" | grep "^$STACK_VERSION_PREFIX" > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    echo "true"
  else
    echo "false"
  fi
}

function getStackNameFromComposeLine()
{
  echo "$1" | cut -d" " -f2
}

function getVersionFromComposeLine()
{
  echo "$1" | cut -d" " -f3 | cut -d"v" -f2
}

function getScriptStackVersionNumber()
{
  echo "$1" | cut -d"v" -f2
}

function removeImageCSVList()
{
  img_csv_list=$1
  img_list=($(echo $img_csv_list | tr "," "\n"))
  for rm_img in "${img_list[@]}"
  do
    if ! [ -z "$rm_img" ]; then
      docker image rm $rm_img > /dev/null 2>&1
    fi
  done
}

function prepPerformUpdate()
{
  # This function is a drop-in replacement for all repetetive
  # code at the beginning of each of the performUpdate functions.

  # The underlying performUpdate function modifies the variable
  # perform_update_report with the results of the update process.
  # It is up to the caller to do something with it.
  perform_update_report=""
  portainerToken="$1"
  perform_stack_id=$(getStackID $perform_stack_name "$portainerToken")
  if [ -z "$perform_stack_id" ]; then
    is_upgrade_error=true
    perform_update_report="ERROR($perform_stack_name): There was a problem with the Portainer API. If this error persists, try restarting Portainer."
    return 1
  fi
  perform_compose=$HSHQ_STACKS_DIR/portainer/compose/$perform_stack_id/docker-compose.yml
  perform_stack_firstline=$(sudo sed -n 1p $perform_compose)
  perform_stack_ver=$(getVersionFromComposeLine "$perform_stack_firstline")
  unset image_update_map
  image_update_map=""
  oldVer=v"$perform_stack_ver"
}

function upgradeStack()
{
  # This function modifies the variable stack_upgrade_report
  # with the results of the upgrade process. It is up to the 
  # caller to do something with it.

  # This function also depends on the array, image_update_map, 
  # to be set by the caller prior to entry, since passing
  # arrays as arguments in bash is a headache.

  comp_stack_name=$1
  comp_stack_id=$2
  old_ver=$3
  new_ver=$4
  cur_img_list="$5"
  upgrade_compose_file=$6
  portainerToken="$7"
  stackModFunction=$8
  isReinstallStack=$9
  stackReinstallModFunction=${10}

  rem_image_list=""
  is_upgrade_error=false
  stack_upgrade_report=""

  if [ "$(checkImageList $cur_img_list $upgrade_compose_file)" = "false" ]; then
    is_upgrade_error=true
    stack_upgrade_report="ERROR ($comp_stack_name): Container image mismatch, stack version: $old_ver, image list: $cur_img_list"
    return
  fi

  # Even though the image list (cur_img_list) matches the corresponding
  # items in the update map (image_update_map), they are both used as
  # a deliberate means of double-checking the intended images. This next
  # loop block confirms that they match.
  curImageListArr=($(echo $cur_img_list | tr "," "\n"))
  curItemNum=0
  for cur_repl in "${image_update_map[@]}"
  do
    cur_img=$(echo $cur_repl | cut -d"," -f1)
    if ! [ "$cur_img" = "${curImageListArr[$curItemNum]}" ]; then
      is_upgrade_error=true
      stack_upgrade_report="ERROR ($comp_stack_name): Image list does not match update map ($cur_img_list) - This is a developer error"
      return
    fi
    ((curItemNum++))
  done
  for cur_repl in "${image_update_map[@]}"
  do
    new_img=$(echo $cur_repl | cut -d"," -f2)
    pullImage $new_img
    if [ $? -ne 0 ]; then
      is_upgrade_error=true
      break
    fi
  done
  set +e
  if [ "$is_upgrade_error" = "true" ]; then
    stack_upgrade_report="ERROR ($comp_stack_name): Error downloading image: $new_img, current stack version: $old_ver"
    return
  fi
  rm_image_list=""
  for cur_repl in "${image_update_map[@]}"
  do
    old_img=$(echo $cur_repl | cut -d"," -f1)
    new_img=$(echo $cur_repl | cut -d"," -f2)
    if ! [ "$old_img" = "$new_img" ]; then
      rm_image_list="${rm_image_list},$old_img"
      sudo sed -i "s|image: $old_img|image: $new_img|g" $upgrade_compose_file
    fi
  done
  sudo sed -i "1s|.*|$STACK_VERSION_PREFIX $comp_stack_name $new_ver|" $upgrade_compose_file
  set +e
  $stackModFunction
  if [ "$isStartStackFromStopped" = "true" ] && [ "$isReinstallStack" = "false" ]; then
    unset isStartStackFromStopped
    isStartStackFromStopped=""
    startStopStack $comp_stack_name start "$portainerToken"
  else
    if [ "$isReinstallStack" = "true" ]; then
      sudo cp $upgrade_compose_file $HOME/${comp_stack_name}-compose.yml
      sudo cp $HSHQ_STACKS_DIR/portainer/compose/$comp_stack_id/stack.env $HOME/${comp_stack_name}.env
      sudo chown $USERNAME:$USERNAME $HOME/${comp_stack_name}-compose.yml
      sudo chown $USERNAME:$USERNAME $HOME/${comp_stack_name}.env
      set +e
      $stackReinstallModFunction
      updateStackByID ${comp_stack_name} ${comp_stack_id} $HOME/${comp_stack_name}-compose.yml $HOME/${comp_stack_name}.env "$portainerToken"
    else
      restartStackIfRunning $comp_stack_name 3 "$portainerToken"
    fi
  fi
  removeImageCSVList "$rm_image_list"
  stack_upgrade_report="${stack_upgrade_report}${comp_stack_name}: Upgraded from $old_ver to $new_ver"
}

function doNothing()
{
  return
}

# Services Functions
function loadPinnedDockerImages()
{
  IMG_ADGUARD=adguard/adguardhome:v0.107.59
  IMG_AISTACK_MINDSDB_APP=mindsdb/mindsdb:v25.4.5.0
  IMG_AISTACK_MINDSDB_MOD_APP=hshq/mindsdb:v1
  IMG_AISTACK_OPENTELEMETRY=otel/opentelemetry-collector-contrib:0.116.1
  IMG_AISTACK_LANGFUSE=langfuse/langfuse:2.87.0
  IMG_AISTACK_OLLAMA_SERVER=ollama/ollama:0.6.8
  IMG_AISTACK_OPENWEBUI=ghcr.io/open-webui/open-webui:git-aa37482
  IMG_AUTHELIA=authelia/authelia:4.39.1
  IMG_BARASSISTANT_APP=barassistant/server:5.2.0
  IMG_BARASSISTANT_SALTRIM=barassistant/salt-rim:4.1.0
  IMG_CADDY=caddy:2.9.1
  IMG_CALIBRE_SERVER=linuxserver/calibre:8.2.1
  IMG_CALIBRE_WEB=linuxserver/calibre-web:0.6.24
  IMG_CHANGEDETECTION_APP=ghcr.io/dgtlmoon/changedetection.io:0.49.11
  IMG_CHANGEDETECTION_PLAYWRIGHT_CHROME=dgtlmoon/sockpuppetbrowser:latest
  IMG_CODESERVER=codercom/code-server:4.98.2
  IMG_COLLABORA=collabora/code:24.04.13.2.1
  IMG_COTURN=coturn/coturn:4.6.3
  IMG_DISCOURSE=bitnami/discourse:3.3.2
  IMG_DNSMASQ=jpillora/dnsmasq:1.1
  IMG_DOZZLE=amir20/dozzle:v6.1.1
  IMG_DRAWIO_PLANTUML=jgraph/plantuml-server
  IMG_DRAWIO_EXPORT=jgraph/export-server
  IMG_DRAWIO_WEB=jgraph/drawio:26.2.2
  IMG_DUPLICATI=linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246
  IMG_EXCALIDRAW_SERVER=excalidraw/excalidraw-room
  IMG_EXCALIDRAW_STORAGE=kiliandeca/excalidraw-storage-backend
  IMG_EXCALIDRAW_WEB=kiliandeca/excalidraw
  IMG_ESPOCRM_APP=espocrm/espocrm:9.0.6-apache
  IMG_FILEBROWSER=filebrowser/filebrowser:v2.32.0
  IMG_FILEDROP=filedrop/filedrop:1
  IMG_FIREFLY_APP=fireflyiii/core:version-6.2.10
  IMG_FIREFLY_IMPORTER=fireflyiii/data-importer:version-1.6.1
  IMG_FIREFLY_CRON=alpine:3.21.3
  IMG_FRESHRSS=freshrss/freshrss:1.26.1
  IMG_GHOST=ghost:5.115.1-alpine
  IMG_GITEA_APP=gitea/gitea:1.23.6
  IMG_GITLAB_APP=gitlab/gitlab-ce:17.10.3-ce.0
  IMG_GRAFANA=grafana/grafana-oss:11.6.0
  IMG_GRAMPSWEB=ghcr.io/gramps-project/grampsweb:v25.4.0
  IMG_GUACAMOLE_GUACD=guacamole/guacd:1.5.5
  IMG_GUACAMOLE_WEB=guacamole/guacamole:1.5.5
  IMG_HEIMDALL=linuxserver/heimdall:2.4.13
  IMG_HOMARR_APP=ghcr.io/homarr-labs/homarr:v1.18.1
  IMG_HOMEASSISTANT_APP=homeassistant/home-assistant:2025.4.0
  IMG_HOMEASSISTANT_CONFIGURATOR=causticlab/hass-configurator-docker:0.5.2
  IMG_HOMEASSISTANT_NODERED=nodered/node-red:4.0.9-22
  IMG_HOMEASSISTANT_TASMOADMIN=ghcr.io/tasmoadmin/tasmoadmin:v4.1.3
  IMG_HUGINN_APP=ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61
  IMG_IMMICH_DB=tensorchord/pgvecto-rs:pg14-v0.3.0
  IMG_IMMICH_APP=ghcr.io/immich-app/immich-server:v1.131.3
  IMG_IMMICH_ML=ghcr.io/immich-app/immich-machine-learning:v1.131.3
  IMG_INFLUXDB=influxdb:2.7.11-alpine
  IMG_INVIDIOUS_WEB=quay.io/invidious/invidious:master
  IMG_INVIDIOUS_COMPANION=quay.io/invidious/invidious-companion:latest
  IMG_INVIDIOUS_SESSIONGEN=quay.io/invidious/youtube-trusted-session-generator
  IMG_ITTOOLS=ghcr.io/corentinth/it-tools:latest
  IMG_JELLYFIN=jellyfin/jellyfin:10.10.6
  IMG_JITSI_WEB=jitsi/web:stable-10133-1
  IMG_JITSI_PROSODY=jitsi/prosody:stable-10133-1
  IMG_JITSI_JICOFO=jitsi/jicofo:stable-10133-1
  IMG_JITSI_JVB=jitsi/jvb:stable-10133-1
  IMG_JUPYTER=continuumio/anaconda3:2024.10-1
  IMG_KASM=lscr.io/linuxserver/kasm:1.16.1-ls68
  IMG_KEILA=pentacent/keila:0.17.1
  IMG_LINKWARDEN=ghcr.io/linkwarden/linkwarden:v2.9.3
  IMG_MAIL_RELAY_POSTFIX=hshq/mail-relay/postfix:v1
  IMG_MAIL_RELAY_RSPAMD=hshq/mail-relay/rspamd:v1
  IMG_MAIL_RELAY_CLAMAV=clamav/clamav:1.2.1
  IMG_MAIL_RELAY_UNBOUND=mvance/unbound:1.19.0
  IMG_MAILU_ADMIN=ghcr.io/mailu/admin:2024.06.36
  IMG_MAILU_ANTISPAM=ghcr.io/mailu/rspamd:2024.06.36
  IMG_MAILU_ANTIVIRUS=clamav/clamav-debian:1.4.2
  IMG_MAILU_FETCHMAIL=ghcr.io/mailu/fetchmail:2024.06.36
  IMG_MAILU_FRONT=ghcr.io/mailu/nginx:2024.06.36
  IMG_MAILU_IMAP=ghcr.io/mailu/dovecot:2024.06.36
  IMG_MAILU_OLETOOLS=ghcr.io/mailu/oletools:2024.06.36
  IMG_MAILU_SMTP=ghcr.io/mailu/postfix:2024.06.36
  IMG_MAILU_TIKA=apache/tika:3.1.0.0-full
  IMG_MAILU_UNBOUND=ghcr.io/mailu/unbound:2024.06.36
  IMG_MAILU_WEBDAV=ghcr.io/mailu/radicale:2024.06.36
  IMG_MAILU_WEBMAIL=ghcr.io/mailu/webmail:2024.06.36
  IMG_MASTODON_APP=tootsuite/mastodon:v4.3.7
  IMG_MASTODON_STREAMING=tootsuite/mastodon-streaming:v4.3.7
  IMG_MASTODON_ELASTICSEARCH=elasticsearch:8.17.4
  IMG_MATRIX_ELEMENT=vectorim/element-web:v1.11.96
  IMG_MATRIX_SYNAPSE=matrixdotorg/synapse:v1.127.1
  IMG_MATOMO_APP=matomo:5.3.1-fpm-alpine
  IMG_MEALIE=ghcr.io/mealie-recipes/mealie:v2.8.0
  IMG_MEILISEARCH=getmeili/meilisearch:v1.6
  IMG_MYSQL=mariadb:10.7.3
  IMG_NETDATA=netdata/netdata:v2.3.2
  IMG_NEXTCLOUD_APP=nextcloud:31.0.2-fpm-alpine
  IMG_NEXTCLOUD_IMAGINARY=nextcloud/aio-imaginary:20250325_084656
  IMG_NEXTCLOUD_TALKHPB=ghcr.io/nextcloud-releases/aio-talk:20250512_082954
  IMG_NEXTCLOUD_TALKRECORD=ghcr.io/nextcloud-releases/aio-talk-recording:20250512_082954
  IMG_NGINX=nginx:1.27.4-alpine
  IMG_NTFY=binwiederhier/ntfy:v2.11.0
  IMG_NODE_EXPORTER=prom/node-exporter:v1.9.1
  IMG_OFELIA=mcuadros/ofelia:0.3.16
  IMG_OPENLDAP_MANAGER=wheelybird/ldap-user-manager:v1.11
  IMG_OPENLDAP_PHP=osixia/phpldapadmin:stable
  IMG_OPENLDAP_SERVER=osixia/openldap:1.5.0
  IMG_PAPERLESS_APP=ghcr.io/paperless-ngx/paperless-ngx:2.14.7
  IMG_PAPERLESS_GOTENBERG=gotenberg/gotenberg:8.19.1
  IMG_PAPERLESS_TIKA=apache/tika:3.1.0.0
  IMG_PASTEFY=interaapps/pastefy:7.0.3
  IMG_PEERTUBE_APP=chocobozzz/peertube:v7.1.0-bookworm
  IMG_PENPOT_BACKEND=penpotapp/backend:2.5.4
  IMG_PENPOT_FRONTEND=penpotapp/frontend:2.5.4
  IMG_PENPOT_EXPORTER=penpotapp/exporter:2.5.4
  IMG_PHOTOPRISM_APP=photoprism/photoprism:240915
  IMG_PIPED_FRONTEND=1337kavin/piped-frontend:latest
  IMG_PIPED_PROXY=1337kavin/piped-proxy:latest
  IMG_PIPED_API=1337kavin/piped:latest
  IMG_PIPED_CRON=barrypiccinni/psql-curl
  IMG_PIXELFED_APP=ghcr.io/jippi/docker-pixelfed:v0.12.5-docker1-apache-8.4-bookworm
  IMG_PIXELFED_MOD_APP=hshq/pixelfed:v1
  IMG_PORTAINER=portainer/portainer-ce:2.21.4-alpine
  IMG_POSTGRES=postgres:15.0-bullseye
  IMG_PROMETHEUS=prom/prometheus:v3.2.1
  IMG_QBITTORRENT=linuxserver/qbittorrent:5.1.2
  IMG_REDIS=bitnami/redis:7.4.2
  IMG_REMOTELY=immybot/remotely:1037
  IMG_SABNZBD=linuxserver/sabnzbd:4.5.1
  IMG_SEARXNG=searxng/searxng:2025.4.1-e6308b816
  IMG_SERVARR_SONARR=linuxserver/sonarr:4.0.15
  IMG_SERVARR_RADARR=linuxserver/radarr:5.27.1-nightly
  IMG_SERVARR_LIDARR=linuxserver/lidarr:2.13.1-nightly
  IMG_SERVARR_READARR=linuxserver/readarr:0.4.19-nightly
  IMG_SERVARR_BAZARR=linuxserver/bazarr:1.5.2
  IMG_SERVARR_MYLAR3=linuxserver/mylar3:0.8.2
  IMG_SERVARR_PROWLARR=linuxserver/prowlarr:2.0.1-nightly
  IMG_SHLINK_APP=shlinkio/shlink:4.4.6
  IMG_SHLINK_WEB=shlinkio/shlink-web-client:4.3.0
  IMG_SNIPPETBOX=pawelmalak/snippet-box:latest
  IMG_SPEEDTEST_TRACKER_APP=linuxserver/speedtest-tracker:1.3.0
  IMG_SQLPAD=sqlpad/sqlpad:7.5.3
  IMG_STIRLINGPDF=frooodle/s-pdf:0.45.0
  IMG_SYNCTHING=syncthing/syncthing:1.29.4
  IMG_TOMCAT=tomcat:11
  IMG_UPTIMEKUMA=louislam/uptime-kuma:1.23.16-alpine
  IMG_VAULTWARDEN_APP=vaultwarden/server:1.33.2-alpine
  IMG_VAULTWARDEN_LDAP=vividboarder/vaultwarden_ldap:2.1.1
  IMG_WALLABAG=wallabag/wallabag:2.6.10
  IMG_WAZUH_MANAGER=wazuh/wazuh-manager:4.11.2
  IMG_WAZUH_INDEXER=wazuh/wazuh-indexer:4.11.2
  IMG_WAZUH_DASHBOARD=wazuh/wazuh-dashboard:4.11.2
  IMG_WGPORTAL=wgportal/wg-portal:1.0.19
  IMG_WIKIJS=requarks/wiki:2.5.307
  IMG_WIREGUARD=linuxserver/wireguard:1.0.20210914-r4-ls72
  IMG_WORDPRESS=wordpress:php8.3-apache
  IMG_YAMTRACK_APP=ghcr.io/fuzzygrim/yamtrack:0.22.7
}

function getScriptStackVersion()
{
  stack_name=$1
  case "$stack_name" in
    portainer)
      echo "v3" ;;
    adguard)
      echo "v6" ;;
    sysutils)
      echo "v7" ;;
    openldap)
      echo "v1" ;;
    mailu)
      echo "v5" ;;
    wazuh)
      echo "v7" ;;
    collabora)
      echo "v7" ;;
    nextcloud)
      echo "v9" ;;
    jitsi)
      echo "v7" ;;
    matrix)
      echo "v7" ;;
    wikijs)
      echo "v4" ;;
    duplicati)
      echo "v5" ;;
    mastodon)
      echo "v8" ;;
    dozzle)
      echo "v6" ;;
    searxng)
      echo "v6" ;;
    jellyfin)
      echo "v5" ;;
    filebrowser)
      echo "v6" ;;
    photoprism)
      echo "v2" ;;
    guacamole)
      echo "v3" ;;
    authelia)
      echo "v5" ;;
    wordpress)
      echo "v2" ;;
    ghost)
      echo "v7" ;;
    peertube)
      echo "v6" ;;
    homeassistant)
      echo "v8" ;;
    gitlab)
      echo "v6" ;;
    vaultwarden)
      echo "v7" ;;
    discourse)
      echo "v6" ;;
    syncthing)
      echo "v7" ;;
    codeserver)
      echo "v6" ;;
    shlink)
      echo "v6" ;;
    firefly)
      echo "v8" ;;
    excalidraw)
      echo "v1" ;;
    drawio)
      echo "v6" ;;
    invidious)
      echo "v2" ;;
    ittools)
      echo "v1" ;;
    gitea)
      echo "v7" ;;
    mealie)
      echo "v8" ;;
    kasm)
      echo "v6" ;;
    ntfy)
      echo "v4" ;;
    remotely)
      echo "v4" ;;
    calibre)
      echo "v6" ;;
    netdata)
      echo "v5" ;;
    linkwarden)
      echo "v6" ;;
    stirlingpdf)
      echo "v6" ;;
    bar-assistant)
      echo "v5" ;;
    freshrss)
      echo "v4" ;;
    keila)
      echo "v5" ;;
    wallabag)
      echo "v3" ;;
    jupyter)
      echo "v4" ;;
    paperless)
      echo "v4" ;;
    speedtest-tracker-local)
      echo "v5" ;;
    speedtest-tracker-vpn)
      echo "v5" ;;
    heimdall)
      echo "v1" ;;
    changedetection)
      echo "v5" ;;
    huginn)
      echo "v3" ;;
    coturn)
      echo "v3" ;;
    filedrop)
      echo "v1" ;;
    piped)
      echo "v2" ;;
    grampsweb)
      echo "v3" ;;
    penpot)
      echo "v2" ;;
    espocrm)
      echo "v2" ;;
    immich)
      echo "v2" ;;
    homarr)
      echo "v3" ;;
    matomo)
      echo "v1" ;;
    pastefy)
      echo "v1" ;;
    snippetbox)
      echo "v1" ;;
    aistack)
      echo "v1" ;;
    pixelfed)
      echo "v1" ;;
    yamtrack)
      echo "v1" ;;
    servarr)
      echo "v1" ;;
    sabnzbd)
      echo "v1" ;;
    qbittorrent)
      echo "v1" ;;
    ofelia)
      echo "v5" ;;
    sqlpad)
      echo "v7" ;;
    caddy-*)
      echo "v4" ;;
    clientdns-*)
      echo "v2" ;;
    uptimekuma)
      echo "v5" ;;
    mail-relay)
      echo "v2" ;;
    wgportal)
      echo "v2" ;;
  esac
}

function pullDockerImages()
{
  pullImage $IMG_PORTAINER
  pullImage $IMG_REDIS
  pullImage $IMG_POSTGRES
  pullImage $IMG_MYSQL
  pullImage $IMG_NGINX
  pullImage $IMG_ADGUARD
  pullImage $IMG_GRAFANA
  pullImage $IMG_PROMETHEUS
  pullImage $IMG_NODE_EXPORTER
  pullImage $IMG_OPENLDAP_SERVER
  pullImage $IMG_OPENLDAP_PHP
  pullImage $IMG_OPENLDAP_MANAGER
  pullImage $IMG_MAILU_ADMIN
  pullImage $IMG_MAILU_ANTISPAM
  pullImage $IMG_MAILU_ANTIVIRUS
  pullImage $IMG_MAILU_FETCHMAIL
  pullImage $IMG_MAILU_FRONT
  pullImage $IMG_MAILU_IMAP
  pullImage $IMG_MAILU_OLETOOLS
  pullImage $IMG_MAILU_SMTP
  pullImage $IMG_MAILU_TIKA
  pullImage $IMG_MAILU_UNBOUND
  pullImage $IMG_MAILU_WEBDAV
  pullImage $IMG_MAILU_WEBMAIL
  pullImage $IMG_WAZUH_MANAGER
  pullImage $IMG_WAZUH_INDEXER
  pullImage $IMG_WAZUH_DASHBOARD
  pullImage $IMG_COLLABORA
  pullImage $IMG_NETDATA
  pullImage $IMG_NEXTCLOUD_APP
  pullImage $IMG_NEXTCLOUD_IMAGINARY
  pullImage $IMG_NEXTCLOUD_TALKHPB
  pullImage $IMG_NEXTCLOUD_TALKRECORD
  pullImage $IMG_JITSI_WEB
  pullImage $IMG_JITSI_PROSODY
  pullImage $IMG_JITSI_JICOFO
  pullImage $IMG_JITSI_JVB
  pullImage $IMG_MATRIX_SYNAPSE
  pullImage $IMG_MATRIX_ELEMENT
  pullImage $IMG_WIKIJS
  pullImage $IMG_DUPLICATI
  pullImage $IMG_MASTODON_APP
  pullImage $IMG_DOZZLE
  pullImage $IMG_SEARXNG
  pullImage $IMG_JELLYFIN
  pullImage $IMG_FILEBROWSER
  pullImage $IMG_PHOTOPRISM_APP
  pullImage $IMG_GUACAMOLE_GUACD
  pullImage $IMG_GUACAMOLE_WEB
  pullImage $IMG_GITLAB_APP
  pullImage $IMG_HOMEASSISTANT_APP
  pullImage $IMG_HOMEASSISTANT_CONFIGURATOR
  pullImage $IMG_HOMEASSISTANT_NODERED
  pullImage $IMG_HOMEASSISTANT_TASMOADMIN
  pullImage $IMG_INFLUXDB
  pullImage $IMG_ITTOOLS
  pullImage $IMG_DISCOURSE
  pullImage $IMG_SQLPAD
  pullImage $IMG_SYNCTHING
  pullImage $IMG_VAULTWARDEN_APP
  pullImage $IMG_VAULTWARDEN_LDAP
  pullImage $IMG_WORDPRESS
  pullImage $IMG_GHOST
  pullImage $IMG_PEERTUBE_APP
  pullImage $IMG_AUTHELIA
  pullImage $IMG_HEIMDALL
  pullImage $IMG_CADDY
  pullImage $IMG_UPTIMEKUMA
  pullImage $IMG_OFELIA
  pullImage $IMG_CODESERVER
  pullImage $IMG_SHLINK_APP
  pullImage $IMG_SHLINK_WEB
  pullImage $IMG_FIREFLY_APP
  pullImage $IMG_FIREFLY_IMPORTER
  pullImage $IMG_FIREFLY_CRON
  pullImage $IMG_EXCALIDRAW_WEB
  pullImage $IMG_EXCALIDRAW_SERVER
  pullImage $IMG_EXCALIDRAW_STORAGE
  pullImage $IMG_INVIDIOUS_WEB
  pullImage $IMG_INVIDIOUS_COMPANION
  pullImage $IMG_GITEA_APP
  pullImage $IMG_MEALIE
  pullImage $IMG_KASM
  pullImage $IMG_DNSMASQ
  pullImage $IMG_WIREGUARD
  pullImage $IMG_CALIBRE_SERVER
  pullImage $IMG_CALIBRE_WEB
  pullImage $IMG_LINKWARDEN
  pullImage $IMG_STIRLINGPDF
  pullImage $IMG_BARASSISTANT_APP
  pullImage $IMG_MEILISEARCH
  pullImage $IMG_BARASSISTANT_SALTRIM
  pullImage $IMG_FRESHRSS
  pullImage $IMG_KEILA
  pullImage $IMG_WALLABAG
  pullImage $IMG_JUPYTER
  pullImage $IMG_PAPERLESS_APP
  pullImage $IMG_PAPERLESS_GOTENBERG
  pullImage $IMG_PAPERLESS_TIKA
  pullImage $IMG_SPEEDTEST_TRACKER_APP
  pullImage $IMG_CHANGEDETECTION_APP
  pullImage $IMG_CHANGEDETECTION_PLAYWRIGHT_CHROME
  pullImage $IMG_HUGINN_APP
  pullImage $IMG_COTURN
  pullImage $IMG_FILEDROP
  pullImage $IMG_PIPED_FRONTEND
  pullImage $IMG_PIPED_PROXY
  pullImage $IMG_PIPED_API
  pullImage $IMG_PIPED_CRON
  pullImage $IMG_GRAMPSWEB
  pullImage $IMG_PENPOT_BACKEND
  pullImage $IMG_PENPOT_FRONTEND
  pullImage $IMG_PENPOT_EXPORTER
  pullImage $IMG_ESPOCRM_APP
  pullImage $IMG_IMMICH_DB
  pullImage $IMG_IMMICH_APP
  pullImage $IMG_IMMICH_ML
  pullImage $IMG_HOMARR_APP
  pullImage $IMG_MATOMO_APP
  pullImage $IMG_PASTEFY
  pullImage $IMG_SNIPPETBOX
  pullImage $IMG_AISTACK_MINDSDB_APP
  pullImage $IMG_AISTACK_OPENTELEMETRY
  pullImage $IMG_AISTACK_LANGFUSE
  pullImage $IMG_AISTACK_OLLAMA_SERVER
  pullImage $IMG_AISTACK_OPENWEBUI
  pullImage $IMG_PIXELFED_APP
  pullImage $IMG_YAMTRACK_APP
  pullImage $IMG_SERVARR_SONARR
  pullImage $IMG_SERVARR_RADARR
  pullImage $IMG_SERVARR_LIDARR
  pullImage $IMG_SERVARR_READARR
  pullImage $IMG_SERVARR_BAZARR
  pullImage $IMG_SERVARR_MYLAR3
  pullImage $IMG_SERVARR_PROWLARR
  pullImage $IMG_SABNZBD
  pullImage $IMG_QBITTORRENT
}

function pullImagesUpdatePB()
{
  pb_add="$1"
  pb_cur=$(($pb_cur+$pb_add))
  pb_res=$(($pb_base+$pb_cur))
  draw_progress_bar $pb_res
}

function pullBaseServicesDockerImages()
{
  pb_base=5
  pb_cur=0
  pullImage $IMG_PORTAINER
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 1
  pullImage $IMG_ADGUARD
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_OPENLDAP_SERVER
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 1
  pullImage $IMG_OPENLDAP_PHP
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_OPENLDAP_MANAGER
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 1
  pullImage $IMG_MAILU_ADMIN
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_ANTISPAM
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 1
  pullImage $IMG_MAILU_ANTIVIRUS
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_FETCHMAIL
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_FRONT
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_IMAP
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_OLETOOLS
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_SMTP
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_UNBOUND
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_WEBDAV
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_MAILU_WEBMAIL
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_DUPLICATI
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_AUTHELIA
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_REDIS
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_SYNCTHING
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_HEIMDALL
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_OFELIA
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_CADDY
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  pullImage $IMG_UPTIMEKUMA
  if [ $? -ne 0 ]; then
    return 4
  fi
  pullImagesUpdatePB 2
  rm -f $HOME/script-server.zip
  wget -q -O $HOME/script-server.zip https://github.com/bugy/script-server/releases/download/1.18.0/script-server.zip
  retVal=$?
  if [ $retVal -ne 0 ] || ! [ -f $HOME/script-server.zip ]; then
    return 4
  fi
}

function pullCommonImages()
{
  pullImage $IMG_POSTGRES
  pullImage $IMG_MYSQL
  pullImage $IMG_REDIS
  pullImage $IMG_NGINX
}

function outputEncConfigFile()
{
  cat <<EOFCF > $CONFIG_FILE
# Encrypted Configuration File
$hshqlogo

# General Info BEGIN
IS_CONFIG_INIT=true
IS_INSTALLED=false
IS_INSTALLING=false
# General Info END

# Services Info BEGIN
# Services Info END

# RelayServer Settings BEGIN
RELAYSERVER_NAME=
RELAYSERVER_SERVER_IP=A
RELAYSERVER_EXT_EMAIL_HOSTNAME=
RELAYSERVER_SUB_WG=wg
RELAYSERVER_SUB_RELAYSERVER=rs
RELAYSERVER_LE_CERT_DOMAINS=unset
RELAYSERVER_CURRENT_SSH_PORT=
RELAYSERVER_REMOTE_USERNAME=
RELAYSERVER_HSHQ_BASE_DIR=
RELAYSERVER_HSHQ_DATA_DIR=
RELAYSERVER_HSHQ_NONBACKUP_DIR=
RELAYSERVER_HSHQ_SCRIPTS_DIR=
RELAYSERVER_HSHQ_SECRETS_DIR=
RELAYSERVER_HSHQ_STACKS_DIR=
RELAYSERVER_HSHQ_SSL_DIR=
RELAYSERVER_SSH_PORT=
RELAYSERVER_SSH_PRIVATE_KEY_FILENAME=
RELAYSERVER_SSH_PRIVATE_KEY_PHRASE=
RELAYSERVER_CLIENT_DEFAULT_MTU=1372
RELAYSERVER_SERVER_DEFAULT_MTU=1372
RELAYSERVER_PERSISTENT_KEEPALIVE=20
RELAYSERVER_WG_PORTAL_PORT=8323
RELAYSERVER_WG_INTERFACE_NAME=wg0
RELAYSERVER_WG_PORT=51821
RELAYSERVER_WG_VPN_NETNAME=
RELAYSERVER_WG_INTERNET_NETNAME=
RELAYSERVER_WG_SV_PRIVATEKEY=
RELAYSERVER_WG_SV_PUBLICKEY=
RELAYSERVER_WG_SV_IP=
RELAYSERVER_WG_SV_PRESHAREDKEY=
RELAYSERVER_WG_SV_CLIENTDNS_PRIVATEKEY=
RELAYSERVER_WG_SV_CLIENTDNS_PRESHAREDKEY=
RELAYSERVER_WG_SV_CLIENTDNS_IP=
RELAYSERVER_WG_HS_PRIVATEKEY=
RELAYSERVER_WG_HS_IP=
RELAYSERVER_WG_HS_PRESHAREDKEY=
RELAYSERVER_WG_HS_CLIENTDNS_PRIVATEKEY=
RELAYSERVER_WG_HS_CLIENTDNS_PRESHAREDKEY=
RELAYSERVER_WG_HS_CLIENTDNS_IP=
RELAYSERVER_WG_INTERNET_HS_PRIVATEKEY=
RELAYSERVER_WG_INTERNET_HS_PRESHAREDKEY=
# RelayServer Settings END

# RelayServer Services BEGIN
RELAYSERVER_PORTAINER_ADMIN_USERNAME=
RELAYSERVER_PORTAINER_ADMIN_PASSWORD=
RELAYSERVER_PORTAINER_LOCAL_HTTPS_PORT=
RELAYSERVER_ADGUARD_ADMIN_USERNAME=
RELAYSERVER_ADGUARD_ADMIN_PASSWORD=
RELAYSERVER_CADDYDNS_ADMIN_USERNAME=
RELAYSERVER_CADDYDNS_ADMIN_PASSWORD=
RELAYSERVER_FILEBROWSER_ADMIN_USERNAME=
RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD=
RELAYSERVER_WGPORTAL_ADMIN_USERNAME=
RELAYSERVER_WGPORTAL_ADMIN_EMAIL=
RELAYSERVER_WGPORTAL_ADMIN_PASSWORD=
RELAYSERVER_CLIENTDNS_ADMIN_USERNAME=
RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD=
RELAYSERVER_RSPAMD_ADMIN_USERNAME=
RELAYSERVER_RSPAMD_ADMIN_PASSWORD=
RELAYSERVER_SYNCTHING_ADMIN_USERNAME=
RELAYSERVER_SYNCTHING_ADMIN_PASSWORD=
RELAYSERVER_SYNCTHING_API_KEY=
RELAYSERVER_SYNCTHING_DEVICE_ID=
RELAYSERVER_SYNCTHING_FOLDER_ID=
# RelayServer Services END

# Config File Encryption Passphrase BEGIN
CONFIG_ENCRYPTION_PASSPHRASE="$CONFIG_ENCRYPTION_PASSPHRASE"
# Config File Encryption Passphrase END

# Docker Installation Info BEGIN
XDG_RUNTIME_DIR=
TRUSTED_PROXIES="10.0.0.0/8 172.16.0.0/12 192.168.0.0/16"
# Docker Installation Info END

# Service Details BEGIN
# Portainer (Service Details) BEGIN
PORTAINER_ADMIN_USERID=
PORTAINER_DB_KEY=
# Portainer (Service Details) END

# Script-server (Service Details) BEGIN
SCRIPTSERVER_INIT_ENV=true
SCRIPTSERVER_ADMIN_USERNAME=
SCRIPTSERVER_ADMIN_PASSWORD=
# Script-server (Service Details) END

# Authelia (Service Details) BEGIN
AUTHELIA_REDIRECTION_URL=
# Authelia (Service Details) END

# SysUtils (Service Details) BEGIN
GRAFANA_ADMIN_USERNAME=
GRAFANA_ADMIN_PASSWORD=
INFLUXDB_ADMIN_USERNAME=
INFLUXDB_ADMIN_PASSWORD=
INFLUXDB_ORG=
INFLUXDB_TOKEN=
INFLUXDB_HA_BUCKET=
# SysUtils (Service Details) END

# OpenLDAP (Service Details) BEGIN
LDAP_ADMIN_USER_USERNAME=
LDAP_ADMIN_USER_PASSWORD=
LDAP_PRIMARY_USER_FULLNAME=
LDAP_PRIMARY_USER_USERNAME=
LDAP_PRIMARY_USER_PASSWORD_HASH=
LDAP_PRIMARY_USER_EMAIL_ADDRESS=
LDAP_ADMIN_BIND_DN=
LDAP_ADMIN_BIND_PASSWORD=
LDAP_READONLY_USER_USERNAME=
LDAP_READONLY_USER_BIND_DN=
LDAP_READONLY_USER_PASSWORD=
LDAP_CONFIG_PASSWORD=
LDAP_URI=
LDAPS_URI=
LDAP_BASE_DN=
LDAP_ADMIN_USER_GROUP_NAME=admins
LDAP_PRIMARY_USER_GROUP_NAME=primaryusers
LDAP_BASIC_USER_GROUP_NAME=basicusers
LDAP_EMAIL_FROM_NAME="LDAP $(getAdminEmailName)"
LDAP_ACCOUNT_REQUESTS_ENABLED=true
LDAP_ACCOUNT_REQUESTS_EMAIL=
# OpenLDAP (Service Details) END

# Mailu (Service Details) BEGIN
EMAIL_ADMIN_USERNAME=
EMAIL_ADMIN_PASSWORD=
EMAIL_SMTP_USERNAME=
EMAIL_SMTP_PASSWORD=
EMAIL_SMTP_EMAIL_ADDRESS=
SMTP_HOSTNAME=mailu-front
SMTP_HOSTPORT=25
SMTP_RELAY_HOST=
SMTP_RELAY_USERNAME=
SMTP_RELAY_PASSWORD=
MAILU_API_TOKEN=
# Mailu (Service Details) END

# Wazuh (Service Details) BEGIN
WAZUH_USERS_DASHBOARD_USERNAME=kibanaserver
WAZUH_USERS_DASHBOARD_PASSWORD=
WAZUH_API_USERNAME=
WAZUH_API_PASSWORD=
WAZUH_USERS_ADMIN_USERNAME=
WAZUH_USERS_ADMIN_PASSWORD=
WAZUH_USERS_KIBANARO_PASSWORD=
WAZUH_USERS_LOGSTASH_PASSWORD=
WAZUH_USERS_READALL_PASSWORD=
WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD=
WAZUH_MANAGER_AUTH_PASSWORD=
# Wazuh (Service Details) END

# Collabora (Service Details) BEGIN
COLLABORA_ADMIN_USERNAME=
COLLABORA_ADMIN_PASSWORD=
# Collabora (Service Details) END

# Nextcloud (Service Details) BEGIN
NEXTCLOUD_ADMIN_USERNAME=
NEXTCLOUD_ADMIN_PASSWORD=
NEXTCLOUD_ADMIN_EMAIL_ADDRESS=
NEXTCLOUD_DATABASE_NAME=
NEXTCLOUD_DATABASE_USER=
NEXTCLOUD_DATABASE_USER_PASSWORD=
NEXTCLOUD_REDIS_PASSWORD=
NEXTCLOUD_EMAIL_FROM_ADDRESS=
DEFAULT_PHONE_REGION=US
NEXTCLOUD_IMAGINARY_PORT=7557
NEXTCLOUD_PUSH_PORT=7867
NEXTCLOUD_TALKHPB_SIGNALING_SECRET=
NEXTCLOUD_TALKHPB_INTERNAL_SECRET=
NEXTCLOUD_TALKHPB_RECORDING_SECRET=
# Nextcloud (Service Details) END

# Matrix (Service Details) BEGIN
MATRIX_DATABASE_NAME=
MATRIX_DATABASE_USER=
MATRIX_DATABASE_USER_PASSWORD=
MATRIX_REDIS_PASSWORD=
MATRIX_SYNAPSE_REGISTRATION_SECRET=
MATRIX_SYNAPSE_MACAROON_SECRET=
MATRIX_SYNAPSE_FORM_SECRET=
# Matrix (Service Details) END

# Wiki.js (Service Details) BEGIN
WIKIJS_DATABASE_NAME=
WIKIJS_DATABASE_USER=
WIKIJS_DATABASE_USER_PASSWORD=
# Wiki.js (Service Details) END

# Duplicati (Service Details) BEGIN
DUPLICATI_ADMIN_PASSWORD=
DUPLICATI_SETTINGS_ENCRYPTION_KEY=
# Duplicati (Service Details) END

# Mastodon (Service Details) BEGIN
MASTODON_ADMIN_EMAIL_ADDRESS=
MASTODON_ADMIN_PASSWORD=
MASTODON_ADMIN_USERNAME=
MASTODON_DATABASE_NAME=
MASTODON_DATABASE_USER=
MASTODON_DATABASE_USER_PASSWORD=
MASTODON_REDIS_PASSWORD=
MASTODON_ELASTICSEARCH_PASSWORD=
MASTODON_ARE_DETERMINISTIC_KEY=
MASTODON_ARE_KEY_DERIVATION_SALT=
MASTODON_ARE_PRIMARY_KEY=
# Mastodon (Service Details) END

# Dozzle (Service Details) BEGIN
DOZZLE_USERNAME=
DOZZLE_PASSWORD=
# Dozzle (Service Details) END

# SearxNG (Service Details) BEGIN
SEARXNG_REDIS_PASSWORD=
SEARXNG_SECRET_KEY=
# SearxNG (Service Details) END

# Jellyfin (Service Details) BEGIN
JELLYFIN_ADMIN_USERNAME=
JELLYFIN_ADMIN_PASSWORD=
# Jellyfin (Service Details) END

# FileBrowser (Service Details) BEGIN
FILEBROWSER_USERNAME=
FILEBROWSER_PASSWORD=
# FileBrowser (Service Details) END

# PhotoPrism (Service Details) BEGIN
PHOTOPRISM_INIT_ENV=true
PHOTOPRISM_ADMIN_USERNAME=
PHOTOPRISM_ADMIN_PASSWORD=
PHOTOPRISM_DATABASE_ROOT_PASSWORD=
PHOTOPRISM_DATABASE_NAME=
PHOTOPRISM_DATABASE_USER=
PHOTOPRISM_DATABASE_USER_PASSWORD=
# PhotoPrism (Service Details) END

# Guacamole (Service Details) BEGIN
GUACAMOLE_DEFAULT_ADMIN_USERNAME=guacadmin
GUACAMOLE_DEFAULT_ADMIN_PASSWORD=guacadmin
GUACAMOLE_DATABASE_ROOT_PASSWORD=
GUACAMOLE_DATABASE_NAME=
GUACAMOLE_DATABASE_USER=
GUACAMOLE_DATABASE_USER_PASSWORD=
# Guacamole (Service Details) END

# UptimeKuma (Service Details) BEGIN
UPTIMEKUMA_USERNAME=
UPTIMEKUMA_PASSWORD=
UPTIMEKUMA_HEARTBEAT_INTERVAL=60
UPTIMEKUMA_HEARTBEAT_RETRIES=3
UPTIMEKUMA_RETRY_INTERVAL=20
UPTIMEKUMA_RESEND_NOTIFY=360
# UptimeKuma (Service Details) END

# Wordpress (Service Details) BEGIN
WORDPRESS_DATABASE_ROOT_PASSWORD=
WORDPRESS_DATABASE_NAME=
WORDPRESS_DATABASE_USER=
WORDPRESS_DATABASE_USER_PASSWORD=
# Wordpress (Service Details) END

# Ghost (Service Details) BEGIN
GHOST_DATABASE_ROOT_PASSWORD=
GHOST_DATABASE_NAME=
GHOST_DATABASE_USER=
GHOST_DATABASE_USER_PASSWORD=
# Ghost (Service Details) END

# PeerTube (Service Details) BEGIN
PEERTUBE_ADMIN_USERNAME=
PEERTUBE_ADMIN_PASSWORD=
PEERTUBE_ADMIN_EMAIL_ADDRESS=
PEERTUBE_DATABASE_NAME=
PEERTUBE_DATABASE_USER=
PEERTUBE_DATABASE_USER_PASSWORD=
# PeerTube (Service Details) END

# HomeAssistant (Service Details) BEGIN
HOMEASSISTANT_DATABASE_NAME=
HOMEASSISTANT_DATABASE_USER=
HOMEASSISTANT_DATABASE_USER_PASSWORD=
HOMEASSISTANT_TASMOADMIN_USER=
HOMEASSISTANT_TASMOADMIN_USER_PASSWORD=
HOMEASSISTANT_CONFIGURATOR_USER=
HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD=
# HomeAssistant (Service Details) END

# Gitlab (Service Details) BEGIN
GITLAB_ROOT_PASSWORD=
GITLAB_DATABASE_NAME=
GITLAB_DATABASE_USER=
GITLAB_DATABASE_USER_PASSWORD=
GITLAB_REDIS_PASSWORD=
# Gitlab (Service Details) END

# Vaultwarden (Service Details) BEGIN
VAULTWARDEN_ADMIN_TOKEN=
VAULTWARDEN_DATABASE_NAME=
VAULTWARDEN_DATABASE_USER=
VAULTWARDEN_DATABASE_USER_PASSWORD=
# Vaultwarden (Service Details) END

# Discourse (Service Details) BEGIN
DISCOURSE_ADMIN_USERNAME=
DISCOURSE_ADMIN_PASSWORD=
DISCOURSE_ADMIN_EMAIL_ADDRESS=
DISCOURSE_DATABASE_NAME=
DISCOURSE_DATABASE_USER=
DISCOURSE_DATABASE_USER_PASSWORD=
DISCOURSE_REDIS_PASSWORD=
# Discourse (Service Details) END

# Syncthing (Service Details) BEGIN
SYNCTHING_ADMIN_USERNAME=
SYNCTHING_ADMIN_PASSWORD=
SYNCTHING_API_KEY=
SYNCTHING_DEVICE_ID=
# Syncthing (Service Details) END

# CodeServer (Service Details) BEGIN
CODESERVER_ADMIN_USERNAME=
CODESERVER_ADMIN_PASSWORD=
# CodeServer (Service Details) END

# Shlink (Service Details) BEGIN
SHLINK_DATABASE_NAME=
SHLINK_DATABASE_USER=
SHLINK_DATABASE_USER_PASSWORD=
SHLINK_REDIS_PASSWORD=
SHLINK_INITIAL_API_KEY=
# Shlink (Service Details) END

# FireflyIII (Service Details) BEGIN
FIREFLY_DATABASE_NAME=
FIREFLY_DATABASE_USER=
FIREFLY_DATABASE_USER_PASSWORD=
FIREFLY_REDIS_PASSWORD=
FIREFLY_INITIAL_API_KEY=
FIREFLY_STATIC_CRON_TOKEN=
# FireflyIII (Service Details) END

# Excalidraw (Service Details) BEGIN
EXCALIDRAW_REDIS_PASSWORD=
# Excalidraw (Service Details) END

# Gitea (Service Details) BEGIN
GITEA_ADMIN_USERNAME=
GITEA_ADMIN_EMAIL_ADDRESS=
GITEA_ADMIN_PASSWORD=
GITEA_DATABASE_NAME=
GITEA_DATABASE_USER=
GITEA_DATABASE_USER_PASSWORD=
# Gitea (Service Details) END

# Invidious (Service Details) BEGIN
INVIDIOUS_DATABASE_NAME=
INVIDIOUS_DATABASE_USER=
INVIDIOUS_DATABASE_USER_PASSWORD=
# Invidious (Service Details) END

# Mealie (Service Details) BEGIN
MEALIE_ADMIN_USERNAME=
MEALIE_ADMIN_EMAIL_ADDRESS=
MEALIE_ADMIN_PASSWORD=
MEALIE_DATABASE_NAME=
MEALIE_DATABASE_USER=
MEALIE_DATABASE_USER_PASSWORD=
# Mealie (Service Details) END

# Remotely (Service Details) BEGIN
REMOTELY_INIT_ENV=true
REMOTELY_ADMIN_USERNAME=
REMOTELY_ADMIN_EMAIL_ADDRESS=
REMOTELY_ADMIN_PASSWORD=
# Remotely (Service Details) END

# SQLPad (Service Details) BEGIN
SQLPAD_ADMIN_USERNAME=
SQLPAD_ADMIN_PASSWORD=
# SQLPad (Service Details) END

# Heimdall (Service Details) BEGIN
HEIMDALL_ADMIN_USERNAME=
HEIMDALL_ADMIN_PASSWORD=
HEIMDALL_USER_USERNAME=
HEIMDALL_USER_PASSWORD=
HEIMDALL_HOMESERVERS_USERNAME=
HEIMDALL_HOMESERVERS_PASSWORD=
HEIMDALL_RELAYSERVER_USERNAME=
HEIMDALL_RELAYSERVER_PASSWORD=
HEIMDALL_WINDOW_TITLE=
# Heimdall (Service Details) END

# Caddy (Service Details) BEGIN
CADDY_CERT_RENEW_INTERVAL=1h
CADDY_CERT_INTERMEDIATE_LIFETIME=90d
CADDY_CERT_LEAF_LIFETIME=7d
CADDY_RESET_CONFIG_HOUROFDAY=4
CADDY_SNIPPET_TLS_HSHQ=tls-hshq
CADDY_SNIPPET_RIP=rip
CADDY_SNIPPET_FWDAUTH=fwd-auth
CADDY_SNIPPET_TRUSTEDPROXIES=trusted-proxy-list
CADDY_SNIPPET_SAFEHEADER=safe-header
CADDY_SNIPPET_SAFEHEADERALLOWFRAME=safe-header-allow-frame
CADDY_SNIPPET_SAFEHEADERALLOWCORS=safe-header-allow-cors
CADDY_SNIPPET_SAFEHEADERCORS=safe-header-cors
CADDY_SNIPPET_NOTHOMESUBNET=not-home-subnet
# Caddy (Service Details) END

# Calibre (Service Details) BEGIN
CALIBRE_WEB_INIT_ENV=true
CALIBRE_WEB_ADMIN_USERNAME=
CALIBRE_WEB_ADMIN_EMAIL_ADDRESS=
CALIBRE_WEB_ADMIN_PASSWORD=
# Calibre (Service Details) END

# Linkwarden (Service Details) BEGIN
LINKWARDEN_DATABASE_NAME=
LINKWARDEN_DATABASE_USER=
LINKWARDEN_DATABASE_USER_PASSWORD=
LINKWARDEN_NEXTAUTH_SECRET=
LINKWARDEN_OIDC_CLIENT_SECRET=
# Linkwarden (Service Details) END

# Bar Assistant (Service Details) BEGIN
BARASSISTANT_REDIS_PASSWORD=
BARASSISTANT_MEILISEARCH_KEY=
# Bar Assistant (Service Details) END

# FreshRSS (Service Details) BEGIN
FRESHRSS_INIT_ENV=true
FRESHRSS_ADMIN_USERNAME=
FRESHRSS_ADMIN_PASSWORD=
FRESHRSS_ADMIN_EMAIL_ADDRESS=
FRESHRSS_DATABASE_NAME=
FRESHRSS_DATABASE_USER=
FRESHRSS_DATABASE_USER_PASSWORD=
FRESHRSS_OIDC_CLIENT_SECRET=
# FreshRSS (Service Details) END

# Keila (Service Details) BEGIN
KEILA_INIT_ENV=true
KEILA_ADMIN_USERNAME=
KEILA_ADMIN_EMAIL_ADDRESS=
KEILA_ADMIN_PASSWORD=
KEILA_DATABASE_NAME=
KEILA_DATABASE_USER=
KEILA_DATABASE_USER_PASSWORD=
# Keila (Service Details) END

# Wallabag (Service Details) BEGIN
WALLABAG_INIT_ENV=true
WALLABAG_ADMIN_USERNAME=
WALLABAG_ADMIN_EMAIL_ADDRESS=
WALLABAG_ADMIN_PASSWORD=
WALLABAG_DATABASE_NAME=
WALLABAG_DATABASE_USER=
WALLABAG_DATABASE_USER_PASSWORD=
WALLABAG_ENV_SECRET=
WALLABAG_REDIS_PASSWORD=
# Wallabag (Service Details) END

# Jupyter (Service Details) BEGIN
JUPYTER_INIT_ENV=true
JUPYTER_ADMIN_PASSWORD=
# Jupyter (Service Details) END

# Paperless (Service Details) BEGIN
PAPERLESS_INIT_ENV=true
PAPERLESS_SECRET_KEY=
PAPERLESS_REDIS_PASSWORD=
PAPERLESS_ADMIN_USERNAME=
PAPERLESS_ADMIN_EMAIL_ADDRESS=
PAPERLESS_ADMIN_PASSWORD=
PAPERLESS_DATABASE_NAME=
PAPERLESS_DATABASE_USER=
PAPERLESS_DATABASE_USER_PASSWORD=
PAPERLESS_OIDC_CLIENT_SECRET=
# Paperless (Service Details) END

# SpeedtestTrackerLocal (Service Details) BEGIN
SPEEDTEST_TRACKER_LOCAL_INIT_ENV=true
SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME=
SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS=
SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD=
SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME=
SPEEDTEST_TRACKER_LOCAL_DATABASE_USER=
SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD=
# SpeedtestTrackerLocal (Service Details) END

# SpeedtestTrackerVPN (Service Details) BEGIN
SPEEDTEST_TRACKER_VPN_INIT_ENV=true
SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME=
SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS=
SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD=
SPEEDTEST_TRACKER_VPN_DATABASE_NAME=
SPEEDTEST_TRACKER_VPN_DATABASE_USER=
SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD=
# SpeedtestTrackerVPN (Service Details) END

# Change Detection (Service Details) BEGIN
CHANGEDETECTION_INIT_ENV=true
CHANGEDETECTION_ADMIN_PASSWORD=
# Change Detection (Service Details) END

# Huginn (Service Details) BEGIN
HUGINN_INIT_ENV=true
HUGINN_APP_SECRET_TOKEN=
HUGINN_ADMIN_USERNAME=
HUGINN_ADMIN_EMAIL_ADDRESS=
HUGINN_ADMIN_PASSWORD=
HUGINN_DATABASE_NAME=
HUGINN_DATABASE_USER=
HUGINN_DATABASE_USER_PASSWORD=
# Huginn (Service Details) END

# Coturn (Service Details) BEGIN
COTURN_STATIC_SECRET=
# Coturn (Service Details) END

# Piped (Service Details) BEGIN
PIPED_DATABASE_NAME=
PIPED_DATABASE_USER=
PIPED_DATABASE_USER_PASSWORD=
# Piped (Service Details) END

# GrampsWeb (Service Details) BEGIN
GRAMPSWEB_INIT_ENV=true
GRAMPSWEB_ADMIN_USERNAME=
GRAMPSWEB_ADMIN_PASSWORD=
GRAMPSWEB_ADMIN_EMAIL_ADDRESS=
GRAMPSWEB_SECRET_KEY=
GRAMPSWEB_REDIS_PASSWORD=
# GrampsWeb (Service Details) END

# Penpot (Service Details) BEGIN
PENPOT_INIT_ENV=true
PENPOT_REDIS_PASSWORD=
PENPOT_DATABASE_NAME=
PENPOT_DATABASE_USER=
PENPOT_DATABASE_USER_PASSWORD=
PENPOT_SECRET_KEY=
# Penpot (Service Details) END

# EspoCRM (Service Details) BEGIN
ESPOCRM_INIT_ENV=true
ESPOCRM_ADMIN_USERNAME=
ESPOCRM_ADMIN_PASSWORD=
ESPOCRM_DATABASE_NAME=
ESPOCRM_DATABASE_ROOT_PASSWORD=
ESPOCRM_DATABASE_USER=
ESPOCRM_DATABASE_USER_PASSWORD=
# EspoCRM (Service Details) END

# Immich (Service Details) BEGIN
IMMICH_INIT_ENV=true
IMMICH_ADMIN_USERNAME=
IMMICH_ADMIN_PASSWORD=
IMMICH_ADMIN_EMAIL_ADDRESS=
IMMICH_DATABASE_NAME=
IMMICH_DATABASE_USER=
IMMICH_DATABASE_USER_PASSWORD=
IMMICH_REDIS_PASSWORD=
IMMICH_OIDC_CLIENT_SECRET=
# Immich (Service Details) END

# Homarr (Service Details) BEGIN
HOMARR_INIT_ENV=true
HOMARR_ADMIN_USERNAME=
HOMARR_ADMIN_EMAIL_ADDRESS=
HOMARR_ADMIN_PASSWORD=
HOMARR_OIDC_CLIENT_SECRET=
# Homarr (Service Details) END

# Matomo (Service Details) BEGIN
MATOMO_INIT_ENV=true
MATOMO_ADMIN_USERNAME=
MATOMO_ADMIN_PASSWORD=
MATOMO_ADMIN_EMAIL_ADDRESS=
MATOMO_DATABASE_NAME=
MATOMO_DATABASE_ROOT_PASSWORD=
MATOMO_DATABASE_USER=
MATOMO_DATABASE_USER_PASSWORD=
# Matomo (Service Details) END

# Pastefy (Service Details) BEGIN
PASTEFY_INIT_ENV=true
PASTEFY_ADMIN_USERNAME=
PASTEFY_ADMIN_PASSWORD=
PASTEFY_ADMIN_EMAIL_ADDRESS=
PASTEFY_DATABASE_NAME=
PASTEFY_DATABASE_ROOT_PASSWORD=
PASTEFY_DATABASE_USER=
PASTEFY_DATABASE_USER_PASSWORD=
# Pastefy (Service Details) END

# AIStack (Service Details) BEGIN
AISTACK_INIT_ENV=true
AISTACK_MINDSDB_ADMIN_USERNAME=
AISTACK_MINDSDB_ADMIN_PASSWORD=
AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS=
AISTACK_MINDSDB_DATABASE_NAME=
AISTACK_MINDSDB_DATABASE_USER=
AISTACK_MINDSDB_DATABASE_USER_PASSWORD=
AISTACK_LANGFUSE_ADMIN_USERNAME=
AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS=
AISTACK_LANGFUSE_ADMIN_PASSWORD=
AISTACK_LANGFUSE_DATABASE_NAME=
AISTACK_OPENWEBUI_ADMIN_USERNAME=
AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS=
AISTACK_OPENWEBUI_ADMIN_PASSWORD=
AISTACK_OPENWEBUI_OIDC_CLIENT_ID=
AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET=
AISTACK_REDIS_PASSWORD=
# AIStack (Service Details) END

# Pixelfed (Service Details) BEGIN
PIXELFED_INIT_ENV=true
PIXELFED_DATABASE_NAME=
PIXELFED_DATABASE_ROOT_PASSWORD=
PIXELFED_DATABASE_USER=
PIXELFED_DATABASE_USER_PASSWORD=
PIXELFED_REDIS_PASSWORD=
PIXELFED_APP_KEY=
# Pixelfed (Service Details) END

# Yamtrack (Service Details) BEGIN
YAMTRACK_INIT_ENV=true
YAMTRACK_ADMIN_USERNAME=
YAMTRACK_ADMIN_PASSWORD=
YAMTRACK_REDIS_PASSWORD=
YAMTRACK_DATABASE_NAME=
YAMTRACK_DATABASE_USER=
YAMTRACK_DATABASE_USER_PASSWORD=
YAMTRACK_SECRET_KEY=
YAMTRACK_OIDC_CLIENT_ID=
YAMTRACK_OIDC_CLIENT_SECRET=
# Yamtrack (Service Details) END

# Servarr (Service Details) BEGIN
SERVARR_INIT_ENV=true
SONARR_ADMIN_USERNAME=
SONARR_ADMIN_PASSWORD=
RADARR_ADMIN_USERNAME=
RADARR_ADMIN_PASSWORD=
LIDARR_ADMIN_USERNAME=
LIDARR_ADMIN_PASSWORD=
READARR_ADMIN_USERNAME=
READARR_ADMIN_PASSWORD=
BAZARR_ADMIN_USERNAME=
BAZARR_ADMIN_PASSWORD=
MYLAR3_ADMIN_USERNAME=
MYLAR3_ADMIN_PASSWORD=
PROWLARR_ADMIN_USERNAME=
PROWLARR_ADMIN_PASSWORD=
# Servarr (Service Details) END

# SABnzbd (Service Details) BEGIN
SABNZBD_INIT_ENV=true
SABNZBD_ADMIN_USERNAME=
SABNZBD_ADMIN_PASSWORD=
# SABnzbd (Service Details) END

# qBittorrent (Service Details) BEGIN
QBITTORRENT_INIT_ENV=true
QBITTORRENT_ADMIN_USERNAME=
QBITTORRENT_ADMIN_PASSWORD=
# qBittorrent (Service Details) END

# Service Details END
EOFCF

}

function outputPlainTextRootConfig()
{
  sudo tee $HSHQ_PLAINTEXT_ROOT_CONFIG >/dev/null <<EOFPT
# Plaintext Root Configuration File
$hshqlogo

# General Info BEGIN
HSHQ_VERSION=$HSHQ_LIB_SCRIPT_VERSION
HOMESERVER_DOMAIN=
HOMESERVER_NAME=
HOMESERVER_ABBREV=
EMAIL_ADMIN_EMAIL_ADDRESS=
EXT_DOMAIN_PREFIX=
INT_DOMAIN_PREFIX=
USERID=
GROUPID=
TZ=
SSH_PORT=
CURRENT_SSH_PORT=
ADMIN_USERNAME_BASE=
PRIMARY_VPN_SETUP_TYPE=none
PRIMARY_VPN_SUBNET=
DESKTOP_ENV=
HSHQ_BASE_DIR=$HSHQ_BASE_DIR
DISABLED_SERVICES=
ADMIN_COLOR_CODE=#400
USERS_COLOR_CODE=#024
HOMESERVERS_COLOR_CODE=#8CB
RELAYSERVER_COLOR_CODE=#58A
WIREGUARD_DNS_REFRESH_RATE=5
LECERTS_REFRESH_RATE=15
DOCKER_NETWORK_RESERVED_RANGE=172.16.0.0/15
DOCKER_NETWORK_SIZE=24
DOCKER_METRICS_PORT=8323
IS_AUTO_UPDATE_NETWORK=true
NETWORK_UPDATE_INTERVAL=5
HOST_INTERNET_TRAFFIC_INTERFACE=default
# General Info END

# Certs BEGIN
CERTS_IS_CA_INIT=false
CERTS_ROOT_CA_NAME=
CERTS_EMAIL_ADDRESS=
CERTS_INTERNAL_DHPARAMS_KEYLENGTH=2048
CERTS_INTERNAL_COUNTRY=
CERTS_INTERNAL_STATE=
CERTS_INTERNAL_LOCALITY=
CERTS_INTERNAL_ORG_NAME=
CERTS_INTERNAL_OU_NAME=HomeServerHQ
CERTS_INTERNAL_ROOT_CN=
CERTS_INTERNAL_INTERMEDIATE_CN=
CERTS_INTERNAL_CA_DAYS=15330
# Certs END

# Portainer (Service Details) BEGIN
PORTAINER_ADMIN_USERNAME=
PORTAINER_ADMIN_PASSWORD=
PORTAINER_LOCAL_HTTPS_PORT=
# Portainer (Service Details) END

# Script-server (Service Details) BEGIN
SCRIPTSERVER_LOCALHOST_PORT=8008
# Script-server (Service Details) END

# Adguard (Service Details) BEGIN
ADGUARD_LOCALHOST_PORT=5443
ADGUARD_ADMIN_USERNAME=
ADGUARD_ADMIN_PASSWORD=
# Adguard (Service Details) END

# HomeAssistant (Service Details) BEGIN
HOMEASSISTANT_LOCALHOST_PORT=8123
HOMEASSISTANT_DB_LOCALHOST_PORT=8432
# HomeAssistant (Service Details) END

# Home Network BEGIN
HOMESERVER_HOST_NETWORK_INTERFACES=
HOMESERVER_HOST_PRIMARY_INTERFACE_NAME=
HOMESERVER_HOST_PRIMARY_INTERFACE_IP=
HOMENET_ADDITIONAL_IPS=
# Home Network END

EOFPT
  sudo chmod 600 $HSHQ_PLAINTEXT_ROOT_CONFIG
}

function outputPlainTextUserConfig()
{
  tee $HSHQ_PLAINTEXT_USER_CONFIG >/dev/null <<EOFPT
# Plaintext User Configuration File
$hshqlogo

# INPUT Chain Defaults BEGIN
INPUT_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT=$SCRIPTSERVER_LOCALHOST_PORT/tcp,$UPNP_PORT/both
INPUT_PRIMARY_VPN_ALLOW_PORTS_DEFAULT=
INPUT_OTHER_VPN_ALLOW_PORTS_DEFAULT=
# INPUT Chain Defaults END

# DOCKER-USER Chain Defaults BEGIN
DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT=$ADGUARD_DNS_PORT,$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,$UPNP_PORT,$PEERTUBE_RDP_PORT,$QBITTORRENT_PORT,$JELLYFIN_PORT,$JITSI_MEET_PORT,$JITSI_JVB_PORT,$JITSI_COLIBRI_PORT,$MAILU_PORT_1,$MAILU_PORT_2,$MAILU_PORT_3,$MAILU_PORT_4,$MAILU_PORT_5,$MAILU_PORT_6,$MAILU_PORT_7,$WAZUH_PORT_1,$WAZUH_PORT_2,$WAZUH_PORT_3,$WAZUH_PORT_4,$WAZUH_PORT_5,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT,$COTURN_PRIMARY_PORT,$COTURN_SECONDARY_PORT,${COTURN_COMMS_MIN_PORT}:${COTURN_COMMS_MAX_PORT}
DOCKERUSER_PRIMARY_VPN_ALLOW_PORTS_DEFAULT=$ADGUARD_DNS_PORT,$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,$JITSI_MEET_PORT,$JITSI_JVB_PORT,$JITSI_COLIBRI_PORT,$MAILU_PORT_1,$MAILU_PORT_2,$MAILU_PORT_3,$MAILU_PORT_4,$MAILU_PORT_5,$MAILU_PORT_6,$MAILU_PORT_7,$WAZUH_PORT_1,$WAZUH_PORT_2,$WAZUH_PORT_3,$WAZUH_PORT_4,$WAZUH_PORT_5,$SYNCTHING_SYNC_PORT,$SYNCTHING_DISC_PORT,$COTURN_PRIMARY_PORT,$COTURN_SECONDARY_PORT,${COTURN_COMMS_MIN_PORT}:${COTURN_COMMS_MAX_PORT}
DOCKERUSER_OTHER_VPN_ALLOW_PORTS_DEFAULT=$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,$COTURN_PRIMARY_PORT,$COTURN_SECONDARY_PORT,$JITSI_COLIBRI_PORT,$JITSI_JVB_PORT,$JITSI_MEET_PORT,${COTURN_COMMS_MIN_PORT}:${COTURN_COMMS_MAX_PORT}
# DOCKER-USER Chain Defaults END

EOFPT
  chmod 600 $HSHQ_PLAINTEXT_USER_CONFIG
}

function initServicesCredentials()
{
  if [ -z "$EMAIL_ADMIN_PASSWORD" ]; then
    EMAIL_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar EMAIL_ADMIN_PASSWORD $EMAIL_ADMIN_PASSWORD
  fi
  if [ -z "$EMAIL_ADMIN_EMAIL_ADDRESS" ]; then
    EMAIL_ADMIN_EMAIL_ADDRESS="$EMAIL_ADMIN_USERNAME@$HOMESERVER_DOMAIN"
    updatePlaintextRootConfigVar EMAIL_ADMIN_EMAIL_ADDRESS $EMAIL_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$EMAIL_SMTP_USERNAME" ]; then
    EMAIL_SMTP_USERNAME="mailsender"
    updateConfigVar EMAIL_SMTP_USERNAME $EMAIL_SMTP_USERNAME
  fi
  if [ -z "$EMAIL_SMTP_PASSWORD" ]; then
    EMAIL_SMTP_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar EMAIL_SMTP_PASSWORD $EMAIL_SMTP_PASSWORD
    rm -f $HSHQ_SECRETS_DIR/smtp_password.txt
    echo $EMAIL_SMTP_PASSWORD > $HSHQ_SECRETS_DIR/smtp_password.txt
    chmod 0400 $HSHQ_SECRETS_DIR/smtp_password.txt
  fi
  if [ -z "$EMAIL_SMTP_EMAIL_ADDRESS" ]; then
    EMAIL_SMTP_EMAIL_ADDRESS="$EMAIL_SMTP_USERNAME@$HOMESERVER_DOMAIN"
    updateConfigVar EMAIL_SMTP_EMAIL_ADDRESS $EMAIL_SMTP_EMAIL_ADDRESS
    rm -f $HSHQ_SECRETS_DIR/smtp_username.txt
    echo $EMAIL_SMTP_EMAIL_ADDRESS > $HSHQ_SECRETS_DIR/smtp_username.txt
    chmod 0400 $HSHQ_SECRETS_DIR/smtp_username.txt
  fi
  if [ -z "$MAILU_API_TOKEN" ]; then
    MAILU_API_TOKEN=$(pwgen -c -n 32 1)
    MAILU_API_TOKEN="${MAILU_API_TOKEN^^}"
    updateConfigVar MAILU_API_TOKEN $MAILU_API_TOKEN
  fi
  if [ -z "$CERTS_EMAIL_ADDRESS" ]; then
    CERTS_EMAIL_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
    updatePlaintextRootConfigVar CERTS_EMAIL_ADDRESS $CERTS_EMAIL_ADDRESS
  fi
  if [ -z "$LDAP_ACCOUNT_REQUESTS_EMAIL" ]; then
    LDAP_ACCOUNT_REQUESTS_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
    updateConfigVar LDAP_ACCOUNT_REQUESTS_EMAIL $LDAP_ACCOUNT_REQUESTS_EMAIL
  fi
  if [ -z "$NEXTCLOUD_EMAIL_FROM_ADDRESS" ]; then
    NEXTCLOUD_EMAIL_FROM_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
    updateConfigVar NEXTCLOUD_EMAIL_FROM_ADDRESS $NEXTCLOUD_EMAIL_FROM_ADDRESS
  fi
  if [ -z "$PORTAINER_ADMIN_USERNAME" ]; then
    PORTAINER_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_portainer"
    updatePlaintextRootConfigVar PORTAINER_ADMIN_USERNAME $PORTAINER_ADMIN_USERNAME
  fi
  if [ -z "$PORTAINER_ADMIN_PASSWORD" ]; then
    PORTAINER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updatePlaintextRootConfigVar PORTAINER_ADMIN_PASSWORD $PORTAINER_ADMIN_PASSWORD
  fi
  if [ -z "$ADGUARD_ADMIN_USERNAME" ]; then
    ADGUARD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_adguard"
    updatePlaintextRootConfigVar ADGUARD_ADMIN_USERNAME $ADGUARD_ADMIN_USERNAME
  fi
  if [ -z "$ADGUARD_ADMIN_PASSWORD" ]; then
    ADGUARD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updatePlaintextRootConfigVar ADGUARD_ADMIN_PASSWORD $ADGUARD_ADMIN_PASSWORD
  fi
  if [ -z "$SCRIPTSERVER_ADMIN_USERNAME" ]; then
    SCRIPTSERVER_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_scriptserver"
    updateConfigVar SCRIPTSERVER_ADMIN_USERNAME $SCRIPTSERVER_ADMIN_USERNAME
  fi
  if [ -z "$SCRIPTSERVER_ADMIN_PASSWORD" ]; then
    SCRIPTSERVER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SCRIPTSERVER_ADMIN_PASSWORD $SCRIPTSERVER_ADMIN_PASSWORD
  fi
  if [ -z "$GRAFANA_ADMIN_USERNAME" ]; then
    GRAFANA_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_grafana"
    updateConfigVar GRAFANA_ADMIN_USERNAME $GRAFANA_ADMIN_USERNAME
  fi
  if [ -z "$GRAFANA_ADMIN_PASSWORD" ]; then
    GRAFANA_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GRAFANA_ADMIN_PASSWORD $GRAFANA_ADMIN_PASSWORD
  fi
  if [ -z "$INFLUXDB_ADMIN_USERNAME" ]; then
    INFLUXDB_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_influxdb"
    updateConfigVar INFLUXDB_ADMIN_USERNAME $INFLUXDB_ADMIN_USERNAME
  fi
  if [ -z "$INFLUXDB_ADMIN_PASSWORD" ]; then
    INFLUXDB_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar INFLUXDB_ADMIN_PASSWORD $INFLUXDB_ADMIN_PASSWORD
  fi
  if [ -z "$INFLUXDB_ORG" ]; then
    INFLUXDB_ORG=$HOMESERVER_DOMAIN
    updateConfigVar INFLUXDB_ORG $INFLUXDB_ORG
  fi
  if [ -z "$INFLUXDB_TOKEN" ]; then
    INFLUXDB_TOKEN=$(pwgen -c -n 64 1)
    updateConfigVar INFLUXDB_TOKEN $INFLUXDB_TOKEN
  fi
  if [ -z "$INFLUXDB_HA_BUCKET" ]; then
    INFLUXDB_HA_BUCKET="home_assistant"
    updateConfigVar INFLUXDB_HA_BUCKET $INFLUXDB_HA_BUCKET
  fi
  if [ -z "$LDAP_BASE_DN"  ]; then
    LDAP_BASE_DN=$(echo "dc="$(echo $HOMESERVER_DOMAIN | sed 's/\./,dc=/g'))
    updateConfigVar LDAP_BASE_DN $LDAP_BASE_DN
  fi
  if [ -z "$LDAP_ADMIN_BIND_DN"  ]; then
    LDAP_ADMIN_BIND_DN="cn=admin,$LDAP_BASE_DN"
    updateConfigVar LDAP_ADMIN_BIND_DN $LDAP_ADMIN_BIND_DN
  fi
  if [ -z "$LDAP_ADMIN_BIND_PASSWORD" ]; then
    LDAP_ADMIN_BIND_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LDAP_ADMIN_BIND_PASSWORD $LDAP_ADMIN_BIND_PASSWORD
  fi
  if [ -z "$LDAP_ADMIN_USER_USERNAME" ]; then
    LDAP_ADMIN_USER_USERNAME=$ADMIN_USERNAME_BASE
    updateConfigVar LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_USERNAME
  fi
  if [ -z "$LDAP_ADMIN_USER_PASSWORD" ]; then
    LDAP_ADMIN_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LDAP_ADMIN_USER_PASSWORD $LDAP_ADMIN_USER_PASSWORD
  fi
  if [ -z "$WAZUH_API_USERNAME" ]; then
    WAZUH_API_USERNAME=$ADMIN_USERNAME_BASE"_wazuh_api"
    updateConfigVar WAZUH_API_USERNAME $WAZUH_API_USERNAME
  fi
  if [ -z "$WAZUH_API_PASSWORD" ]; then
    WAZUH_API_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_API_PASSWORD $WAZUH_API_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_DASHBOARD_PASSWORD" ]; then
    WAZUH_USERS_DASHBOARD_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_DASHBOARD_PASSWORD $WAZUH_USERS_DASHBOARD_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_ADMIN_USERNAME" ]; then
    WAZUH_USERS_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_wazuh"
    updateConfigVar WAZUH_USERS_ADMIN_USERNAME $WAZUH_USERS_ADMIN_USERNAME
  fi
  if [ -z "$WAZUH_USERS_ADMIN_PASSWORD" ]; then
    WAZUH_USERS_ADMIN_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_ADMIN_PASSWORD $WAZUH_USERS_ADMIN_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_KIBANARO_PASSWORD" ]; then
    WAZUH_USERS_KIBANARO_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_KIBANARO_PASSWORD $WAZUH_USERS_KIBANARO_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_LOGSTASH_PASSWORD" ]; then
    WAZUH_USERS_LOGSTASH_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_LOGSTASH_PASSWORD $WAZUH_USERS_LOGSTASH_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_READALL_PASSWORD" ]; then
    WAZUH_USERS_READALL_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_READALL_PASSWORD $WAZUH_USERS_READALL_PASSWORD
  fi
  if [ -z "$WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD" ]; then
    WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD $WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD
  fi
  if [ -z "$WAZUH_MANAGER_AUTH_PASSWORD" ]; then
    WAZUH_MANAGER_AUTH_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar WAZUH_MANAGER_AUTH_PASSWORD $WAZUH_MANAGER_AUTH_PASSWORD
  fi
  if [ -z "$COLLABORA_ADMIN_USERNAME" ]; then
    COLLABORA_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_collabora"
    updateConfigVar COLLABORA_ADMIN_USERNAME $COLLABORA_ADMIN_USERNAME
  fi
  if [ -z "$COLLABORA_ADMIN_PASSWORD" ]; then
    COLLABORA_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar COLLABORA_ADMIN_PASSWORD $COLLABORA_ADMIN_PASSWORD
  fi
  if [ -z "$NEXTCLOUD_ADMIN_USERNAME" ]; then
    NEXTCLOUD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_nextcloud"
    updateConfigVar NEXTCLOUD_ADMIN_USERNAME $NEXTCLOUD_ADMIN_USERNAME
  fi
  if [ -z "$NEXTCLOUD_ADMIN_EMAIL_ADDRESS" ]; then
    NEXTCLOUD_ADMIN_EMAIL_ADDRESS=$NEXTCLOUD_ADMIN_USERNAME"@"$HOMESERVER_DOMAIN
    updateConfigVar NEXTCLOUD_ADMIN_EMAIL_ADDRESS $NEXTCLOUD_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$NEXTCLOUD_ADMIN_PASSWORD" ]; then
    NEXTCLOUD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar NEXTCLOUD_ADMIN_PASSWORD $NEXTCLOUD_ADMIN_PASSWORD
  fi
  if [ -z "$NEXTCLOUD_DATABASE_NAME" ]; then
    NEXTCLOUD_DATABASE_NAME="nextclouddb"
    updateConfigVar NEXTCLOUD_DATABASE_NAME $NEXTCLOUD_DATABASE_NAME
  fi
  if [ -z "$NEXTCLOUD_DATABASE_USER" ]; then
    NEXTCLOUD_DATABASE_USER="nextcloud-user"
    updateConfigVar NEXTCLOUD_DATABASE_USER $NEXTCLOUD_DATABASE_USER
  fi
  if [ -z "$NEXTCLOUD_DATABASE_USER_PASSWORD" ]; then
    NEXTCLOUD_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar NEXTCLOUD_DATABASE_USER_PASSWORD $NEXTCLOUD_DATABASE_USER_PASSWORD
  fi
  if [ -z "$NEXTCLOUD_TALKHPB_SIGNALING_SECRET" ]; then
    NEXTCLOUD_TALKHPB_SIGNALING_SECRET=$(openssl rand --hex 32)
    updateConfigVar NEXTCLOUD_TALKHPB_SIGNALING_SECRET $NEXTCLOUD_TALKHPB_SIGNALING_SECRET
  fi
  if [ -z "$NEXTCLOUD_TALKHPB_INTERNAL_SECRET" ]; then
    NEXTCLOUD_TALKHPB_INTERNAL_SECRET=$(openssl rand --hex 32)
    updateConfigVar NEXTCLOUD_TALKHPB_INTERNAL_SECRET $NEXTCLOUD_TALKHPB_INTERNAL_SECRET
  fi
  if [ -z "$NEXTCLOUD_TALKHPB_RECORDING_SECRET" ]; then
    NEXTCLOUD_TALKHPB_RECORDING_SECRET=$(openssl rand --hex 32)
    updateConfigVar NEXTCLOUD_TALKHPB_RECORDING_SECRET $NEXTCLOUD_TALKHPB_RECORDING_SECRET
  fi
  if [ -z "$MATRIX_DATABASE_NAME" ]; then
    MATRIX_DATABASE_NAME="matrixdb"
    updateConfigVar MATRIX_DATABASE_NAME $MATRIX_DATABASE_NAME
  fi
  if [ -z "$MATRIX_DATABASE_USER" ]; then
    MATRIX_DATABASE_USER="matrix-user"
    updateConfigVar MATRIX_DATABASE_USER $MATRIX_DATABASE_USER
  fi
  if [ -z "$MATRIX_DATABASE_USER_PASSWORD" ]; then
    MATRIX_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MATRIX_DATABASE_USER_PASSWORD $MATRIX_DATABASE_USER_PASSWORD
  fi
  if [ -z "$WIKIJS_DATABASE_NAME" ]; then
    WIKIJS_DATABASE_NAME="wikijsdb"
    updateConfigVar WIKIJS_DATABASE_NAME $WIKIJS_DATABASE_NAME
  fi
  if [ -z "$WIKIJS_DATABASE_USER" ]; then
    WIKIJS_DATABASE_USER="wikijs-user"
    updateConfigVar WIKIJS_DATABASE_USER $WIKIJS_DATABASE_USER
  fi
  if [ -z "$WIKIJS_DATABASE_USER_PASSWORD" ]; then
    WIKIJS_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WIKIJS_DATABASE_USER_PASSWORD $WIKIJS_DATABASE_USER_PASSWORD
  fi
  if [ -z "$DUPLICATI_ADMIN_PASSWORD" ]; then
    DUPLICATI_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DUPLICATI_ADMIN_PASSWORD $DUPLICATI_ADMIN_PASSWORD
  fi
  if [ -z "$DUPLICATI_SETTINGS_ENCRYPTION_KEY" ]; then
    DUPLICATI_SETTINGS_ENCRYPTION_KEY=$(pwgen -c -n 32 1)
    updateConfigVar DUPLICATI_SETTINGS_ENCRYPTION_KEY $DUPLICATI_SETTINGS_ENCRYPTION_KEY
  fi
  if [ -z "$MASTODON_ADMIN_USERNAME" ]; then
    MASTODON_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_mastodon"
    updateConfigVar MASTODON_ADMIN_USERNAME $MASTODON_ADMIN_USERNAME
  fi
  if [ -z "$MASTODON_ADMIN_EMAIL_ADDRESS" ]; then
    MASTODON_ADMIN_EMAIL_ADDRESS=$MASTODON_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar MASTODON_ADMIN_EMAIL_ADDRESS $MASTODON_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$MASTODON_DATABASE_NAME" ]; then
    MASTODON_DATABASE_NAME=mastodondb
    updateConfigVar MASTODON_DATABASE_NAME $MASTODON_DATABASE_NAME
  fi
  if [ -z "$MASTODON_DATABASE_USER" ]; then
    MASTODON_DATABASE_USER=mastodon-user
    updateConfigVar MASTODON_DATABASE_USER $MASTODON_DATABASE_USER
  fi
  if [ -z "$MASTODON_DATABASE_USER_PASSWORD" ]; then
    MASTODON_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_DATABASE_USER_PASSWORD $MASTODON_DATABASE_USER_PASSWORD
  fi
  if [ -z "$MASTODON_ARE_DETERMINISTIC_KEY" ]; then
    MASTODON_ARE_DETERMINISTIC_KEY=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_ARE_DETERMINISTIC_KEY $MASTODON_ARE_DETERMINISTIC_KEY
  fi
  if [ -z "$MASTODON_ARE_KEY_DERIVATION_SALT" ]; then
    MASTODON_ARE_KEY_DERIVATION_SALT=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_ARE_KEY_DERIVATION_SALT $MASTODON_ARE_KEY_DERIVATION_SALT
  fi
  if [ -z "$MASTODON_ARE_PRIMARY_KEY" ]; then
    MASTODON_ARE_PRIMARY_KEY=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_ARE_PRIMARY_KEY $MASTODON_ARE_PRIMARY_KEY
  fi
  if [ -z "$DOZZLE_USERNAME" ]; then
    DOZZLE_USERNAME=$ADMIN_USERNAME_BASE"_dozzle"
    updateConfigVar DOZZLE_USERNAME $DOZZLE_USERNAME
  fi
  if [ -z "$DOZZLE_PASSWORD" ]; then
    DOZZLE_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DOZZLE_PASSWORD $DOZZLE_PASSWORD
  fi
  if [ -z "$JELLYFIN_ADMIN_USERNAME" ]; then
    JELLYFIN_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_jellyfin"
    updateConfigVar JELLYFIN_ADMIN_USERNAME $JELLYFIN_ADMIN_USERNAME
  fi
  if [ -z "$JELLYFIN_ADMIN_PASSWORD" ]; then
    JELLYFIN_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar JELLYFIN_ADMIN_PASSWORD $JELLYFIN_ADMIN_PASSWORD
  fi
  if [ -z "$FILEBROWSER_USERNAME" ]; then
    FILEBROWSER_USERNAME=$ADMIN_USERNAME_BASE"_filebrowser"
    updateConfigVar FILEBROWSER_USERNAME $FILEBROWSER_USERNAME
  fi
  if [ -z "$FILEBROWSER_PASSWORD" ]; then
    FILEBROWSER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar FILEBROWSER_PASSWORD $FILEBROWSER_PASSWORD
  fi
  if [ -z "$PHOTOPRISM_DATABASE_NAME" ]; then
    PHOTOPRISM_DATABASE_NAME="photoprismdb"
    updateConfigVar PHOTOPRISM_DATABASE_NAME $PHOTOPRISM_DATABASE_NAME
  fi
  if [ -z "$PHOTOPRISM_DATABASE_ROOT_PASSWORD" ]; then
    PHOTOPRISM_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PHOTOPRISM_DATABASE_ROOT_PASSWORD $PHOTOPRISM_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$PHOTOPRISM_DATABASE_USER" ]; then
    PHOTOPRISM_DATABASE_USER="photoprism-user"
    updateConfigVar PHOTOPRISM_DATABASE_USER $PHOTOPRISM_DATABASE_USER
  fi
  if [ -z "$PHOTOPRISM_DATABASE_USER_PASSWORD" ]; then
    PHOTOPRISM_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PHOTOPRISM_DATABASE_USER_PASSWORD $PHOTOPRISM_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PHOTOPRISM_ADMIN_USERNAME" ]; then
    PHOTOPRISM_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_photoprism"
    updateConfigVar PHOTOPRISM_ADMIN_USERNAME $PHOTOPRISM_ADMIN_USERNAME
  fi
  if [ -z "$PHOTOPRISM_ADMIN_PASSWORD" ]; then
    PHOTOPRISM_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PHOTOPRISM_ADMIN_PASSWORD $PHOTOPRISM_ADMIN_PASSWORD
  fi
  if [ -z "$GUACAMOLE_DATABASE_NAME" ]; then
    GUACAMOLE_DATABASE_NAME="guacamoledb"
    updateConfigVar GUACAMOLE_DATABASE_NAME $GUACAMOLE_DATABASE_NAME
  fi
  if [ -z "$GUACAMOLE_DATABASE_USER" ]; then
    GUACAMOLE_DATABASE_USER="guacamole-user"
    updateConfigVar GUACAMOLE_DATABASE_USER $GUACAMOLE_DATABASE_USER
  fi
  if [ -z "$GUACAMOLE_DATABASE_USER_PASSWORD" ]; then
    GUACAMOLE_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GUACAMOLE_DATABASE_USER_PASSWORD $GUACAMOLE_DATABASE_USER_PASSWORD
  fi
  if [ -z "$WORDPRESS_DATABASE_NAME" ]; then
    WORDPRESS_DATABASE_NAME=wordpressdb
    updateConfigVar WORDPRESS_DATABASE_NAME $WORDPRESS_DATABASE_NAME
  fi
  if [ -z "$WORDPRESS_DATABASE_ROOT_PASSWORD" ]; then
    WORDPRESS_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WORDPRESS_DATABASE_ROOT_PASSWORD $WORDPRESS_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$WORDPRESS_DATABASE_USER" ]; then
    WORDPRESS_DATABASE_USER=wordpress-user
    updateConfigVar WORDPRESS_DATABASE_USER $WORDPRESS_DATABASE_USER
  fi
  if [ -z "$WORDPRESS_DATABASE_USER_PASSWORD" ]; then
    WORDPRESS_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WORDPRESS_DATABASE_USER_PASSWORD $WORDPRESS_DATABASE_USER_PASSWORD
  fi
  if [ -z "$GHOST_DATABASE_NAME" ]; then
    GHOST_DATABASE_NAME=ghostdb
    updateConfigVar GHOST_DATABASE_NAME $GHOST_DATABASE_NAME
  fi
  if [ -z "$GHOST_DATABASE_USER" ]; then
    GHOST_DATABASE_USER=ghost-user
    updateConfigVar GHOST_DATABASE_USER $GHOST_DATABASE_USER
  fi
  if [ -z "$GHOST_DATABASE_USER_PASSWORD" ]; then
    GHOST_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GHOST_DATABASE_USER_PASSWORD $GHOST_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PEERTUBE_ADMIN_USERNAME" ]; then
    PEERTUBE_ADMIN_USERNAME="root"
    updateConfigVar PEERTUBE_ADMIN_USERNAME $PEERTUBE_ADMIN_USERNAME
  fi
  if [ -z "$PEERTUBE_ADMIN_EMAIL_ADDRESS" ]; then
    PEERTUBE_ADMIN_EMAIL_ADDRESS=$ADMIN_USERNAME_BASE"_peertube@"$HOMESERVER_DOMAIN
    updateConfigVar PEERTUBE_ADMIN_EMAIL_ADDRESS $PEERTUBE_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$PEERTUBE_ADMIN_PASSWORD" ]; then
    PEERTUBE_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PEERTUBE_ADMIN_PASSWORD $PEERTUBE_ADMIN_PASSWORD
  fi
  if [ -z "$PEERTUBE_DATABASE_NAME" ]; then
    PEERTUBE_DATABASE_NAME=peertubedb
    updateConfigVar PEERTUBE_DATABASE_NAME $PEERTUBE_DATABASE_NAME
  fi
  if [ -z "$PEERTUBE_DATABASE_USER" ]; then
    PEERTUBE_DATABASE_USER=peertube-user
    updateConfigVar PEERTUBE_DATABASE_USER $PEERTUBE_DATABASE_USER
  fi
  if [ -z "$PEERTUBE_DATABASE_USER_PASSWORD" ]; then
    PEERTUBE_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PEERTUBE_DATABASE_USER_PASSWORD $PEERTUBE_DATABASE_USER_PASSWORD
  fi
  if [ -z "$HOMEASSISTANT_DATABASE_NAME" ]; then
    HOMEASSISTANT_DATABASE_NAME=homeassistantdb
    updateConfigVar HOMEASSISTANT_DATABASE_NAME $HOMEASSISTANT_DATABASE_NAME
  fi
  if [ -z "$HOMEASSISTANT_DATABASE_USER" ]; then
    HOMEASSISTANT_DATABASE_USER=homeassistant-user
    updateConfigVar HOMEASSISTANT_DATABASE_USER $HOMEASSISTANT_DATABASE_USER
  fi
  if [ -z "$HOMEASSISTANT_DATABASE_USER_PASSWORD" ]; then
    HOMEASSISTANT_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HOMEASSISTANT_DATABASE_USER_PASSWORD $HOMEASSISTANT_DATABASE_USER_PASSWORD
  fi
  if [ -z "$HOMEASSISTANT_TASMOADMIN_USER" ]; then
    HOMEASSISTANT_TASMOADMIN_USER=hass_tasmoadmin_user
    updateConfigVar HOMEASSISTANT_TASMOADMIN_USER $HOMEASSISTANT_TASMOADMIN_USER
  fi
  if [ -z "$HOMEASSISTANT_TASMOADMIN_USER_PASSWORD" ]; then
    HOMEASSISTANT_TASMOADMIN_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HOMEASSISTANT_TASMOADMIN_USER_PASSWORD $HOMEASSISTANT_TASMOADMIN_USER_PASSWORD
  fi
  if [ -z "$HOMEASSISTANT_CONFIGURATOR_USER" ]; then
    HOMEASSISTANT_CONFIGURATOR_USER=hass_configurator_user
    updateConfigVar HOMEASSISTANT_CONFIGURATOR_USER $HOMEASSISTANT_CONFIGURATOR_USER
  fi
  if [ -z "$HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD" ]; then
    HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD
  fi
  if [ -z "$GITLAB_DATABASE_NAME" ]; then
    GITLAB_DATABASE_NAME=gitlabdb
    updateConfigVar GITLAB_DATABASE_NAME $GITLAB_DATABASE_NAME
  fi
  if [ -z "$GITLAB_DATABASE_USER" ]; then
    GITLAB_DATABASE_USER=gitlab-user
    updateConfigVar GITLAB_DATABASE_USER $GITLAB_DATABASE_USER
  fi
  if [ -z "$GITLAB_DATABASE_USER_PASSWORD" ]; then
    GITLAB_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GITLAB_DATABASE_USER_PASSWORD $GITLAB_DATABASE_USER_PASSWORD
  fi
  if [ -z "$VAULTWARDEN_ADMIN_TOKEN" ]; then
    VAULTWARDEN_ADMIN_TOKEN=$(pwgen -c -n 64 1)
    updateConfigVar VAULTWARDEN_ADMIN_TOKEN $VAULTWARDEN_ADMIN_TOKEN
  fi
  if [ -z "$VAULTWARDEN_DATABASE_NAME" ]; then
    VAULTWARDEN_DATABASE_NAME=vaultwardendb
    updateConfigVar VAULTWARDEN_DATABASE_NAME $VAULTWARDEN_DATABASE_NAME
  fi
  if [ -z "$VAULTWARDEN_DATABASE_USER" ]; then
    VAULTWARDEN_DATABASE_USER=vaultwarden-user
    updateConfigVar VAULTWARDEN_DATABASE_USER $VAULTWARDEN_DATABASE_USER
  fi
  if [ -z "$VAULTWARDEN_DATABASE_USER_PASSWORD" ]; then
    VAULTWARDEN_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar VAULTWARDEN_DATABASE_USER_PASSWORD $VAULTWARDEN_DATABASE_USER_PASSWORD
  fi
  if [ -z "$DISCOURSE_ADMIN_USERNAME" ]; then
    DISCOURSE_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_discourse"
    updateConfigVar DISCOURSE_ADMIN_USERNAME $DISCOURSE_ADMIN_USERNAME
  fi
  if [ -z "$DISCOURSE_ADMIN_EMAIL_ADDRESS" ]; then
    DISCOURSE_ADMIN_EMAIL_ADDRESS=$DISCOURSE_ADMIN_USERNAME"@"$HOMESERVER_DOMAIN
    updateConfigVar DISCOURSE_ADMIN_EMAIL_ADDRESS $DISCOURSE_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$DISCOURSE_ADMIN_PASSWORD" ]; then
    DISCOURSE_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DISCOURSE_ADMIN_PASSWORD $DISCOURSE_ADMIN_PASSWORD
  fi
  if [ -z "$DISCOURSE_DATABASE_NAME" ]; then
    DISCOURSE_DATABASE_NAME=discoursedb
    updateConfigVar DISCOURSE_DATABASE_NAME $DISCOURSE_DATABASE_NAME
  fi
  if [ -z "$DISCOURSE_DATABASE_USER" ]; then
    DISCOURSE_DATABASE_USER=discourse-user
    updateConfigVar DISCOURSE_DATABASE_USER $DISCOURSE_DATABASE_USER
  fi
  if [ -z "$DISCOURSE_DATABASE_USER_PASSWORD" ]; then
    DISCOURSE_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DISCOURSE_DATABASE_USER_PASSWORD $DISCOURSE_DATABASE_USER_PASSWORD
  fi
  if [ -z "$SYNCTHING_ADMIN_USERNAME" ]; then
    SYNCTHING_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_syncthing"
    updateConfigVar SYNCTHING_ADMIN_USERNAME $SYNCTHING_ADMIN_USERNAME
  fi
  if [ -z "$SYNCTHING_ADMIN_PASSWORD" ]; then
    SYNCTHING_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SYNCTHING_ADMIN_PASSWORD $SYNCTHING_ADMIN_PASSWORD
  fi
  if [ -z "$CODESERVER_ADMIN_USERNAME" ]; then
    CODESERVER_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_codeserver"
    updateConfigVar CODESERVER_ADMIN_USERNAME $CODESERVER_ADMIN_USERNAME
  fi
  if [ -z "$CODESERVER_ADMIN_PASSWORD" ]; then
    CODESERVER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar CODESERVER_ADMIN_PASSWORD $CODESERVER_ADMIN_PASSWORD
  fi
  if [ -z "$SHLINK_DATABASE_NAME" ]; then
    SHLINK_DATABASE_NAME=shlinkdb
    updateConfigVar SHLINK_DATABASE_NAME $SHLINK_DATABASE_NAME
  fi
  if [ -z "$SHLINK_DATABASE_USER" ]; then
    SHLINK_DATABASE_USER=shlink-user
    updateConfigVar SHLINK_DATABASE_USER $SHLINK_DATABASE_USER
  fi
  if [ -z "$SHLINK_DATABASE_USER_PASSWORD" ]; then
    SHLINK_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SHLINK_DATABASE_USER_PASSWORD $SHLINK_DATABASE_USER_PASSWORD
  fi
  if [ -z "$FIREFLY_DATABASE_NAME" ]; then
    FIREFLY_DATABASE_NAME=fireflydb
    updateConfigVar FIREFLY_DATABASE_NAME $FIREFLY_DATABASE_NAME
  fi
  if [ -z "$FIREFLY_DATABASE_USER" ]; then
    FIREFLY_DATABASE_USER=firefly-user
    updateConfigVar FIREFLY_DATABASE_USER $FIREFLY_DATABASE_USER
  fi
  if [ -z "$FIREFLY_DATABASE_USER_PASSWORD" ]; then
    FIREFLY_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar FIREFLY_DATABASE_USER_PASSWORD $FIREFLY_DATABASE_USER_PASSWORD
  fi
  if [ -z "$FIREFLY_STATIC_CRON_TOKEN" ]; then
    FIREFLY_STATIC_CRON_TOKEN=$(pwgen -c -n 32 1)
    updateConfigVar FIREFLY_STATIC_CRON_TOKEN $FIREFLY_STATIC_CRON_TOKEN
  fi
  if [ -z "$INVIDIOUS_DATABASE_NAME" ]; then
    INVIDIOUS_DATABASE_NAME=invidiousdb
    updateConfigVar INVIDIOUS_DATABASE_NAME $INVIDIOUS_DATABASE_NAME
  fi
  if [ -z "$INVIDIOUS_DATABASE_USER" ]; then
    INVIDIOUS_DATABASE_USER=invidious-user
    updateConfigVar INVIDIOUS_DATABASE_USER $INVIDIOUS_DATABASE_USER
  fi
  if [ -z "$INVIDIOUS_DATABASE_USER_PASSWORD" ]; then
    INVIDIOUS_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar INVIDIOUS_DATABASE_USER_PASSWORD $INVIDIOUS_DATABASE_USER_PASSWORD
  fi
  if [ -z "$GITEA_ADMIN_USERNAME" ]; then
    GITEA_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_gitea"
    updateConfigVar GITEA_ADMIN_USERNAME $GITEA_ADMIN_USERNAME
  fi
  if [ -z "$GITEA_ADMIN_EMAIL_ADDRESS" ]; then
    GITEA_ADMIN_EMAIL_ADDRESS=$GITEA_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar GITEA_ADMIN_EMAIL_ADDRESS $GITEA_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$GITEA_ADMIN_PASSWORD" ]; then
    GITEA_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GITEA_ADMIN_PASSWORD $GITEA_ADMIN_PASSWORD
  fi
  if [ -z "$GITEA_DATABASE_NAME" ]; then
    GITEA_DATABASE_NAME=giteadb
    updateConfigVar GITEA_DATABASE_NAME $GITEA_DATABASE_NAME
  fi
  if [ -z "$GITEA_DATABASE_USER" ]; then
    GITEA_DATABASE_USER=gitea-user
    updateConfigVar GITEA_DATABASE_USER $GITEA_DATABASE_USER
  fi
  if [ -z "$GITEA_DATABASE_USER_PASSWORD" ]; then
    GITEA_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GITEA_DATABASE_USER_PASSWORD $GITEA_DATABASE_USER_PASSWORD
  fi
  if [ -z "$SQLPAD_ADMIN_USERNAME" ]; then
    SQLPAD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_sqlpad"
    updateConfigVar SQLPAD_ADMIN_USERNAME $SQLPAD_ADMIN_USERNAME
  fi
  if [ -z "$SQLPAD_ADMIN_PASSWORD" ]; then
    SQLPAD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SQLPAD_ADMIN_PASSWORD $SQLPAD_ADMIN_PASSWORD
  fi
  if [ -z "$HEIMDALL_ADMIN_USERNAME" ]; then
    HEIMDALL_ADMIN_USERNAME="Admin"
    updateConfigVar HEIMDALL_ADMIN_USERNAME $HEIMDALL_ADMIN_USERNAME
  fi
  if [ -z "$HEIMDALL_ADMIN_PASSWORD" ]; then
    HEIMDALL_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HEIMDALL_ADMIN_PASSWORD $HEIMDALL_ADMIN_PASSWORD
  fi
  if [ -z "$HEIMDALL_USER_USERNAME" ]; then
    HEIMDALL_USER_USERNAME="Users"
    updateConfigVar HEIMDALL_USER_USERNAME $HEIMDALL_USER_USERNAME
  fi
  if [ -z "$HEIMDALL_USER_PASSWORD" ]; then
    HEIMDALL_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HEIMDALL_USER_PASSWORD $HEIMDALL_USER_PASSWORD
  fi
  if [ -z "$HEIMDALL_HOMESERVERS_USERNAME" ]; then
    HEIMDALL_HOMESERVERS_USERNAME="HomeServers"
    updateConfigVar HEIMDALL_HOMESERVERS_USERNAME $HEIMDALL_HOMESERVERS_USERNAME
  fi
  if [ -z "$HEIMDALL_HOMESERVERS_PASSWORD" ]; then
    HEIMDALL_HOMESERVERS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HEIMDALL_HOMESERVERS_PASSWORD $HEIMDALL_HOMESERVERS_PASSWORD
  fi
  if [ -z "$HEIMDALL_RELAYSERVER_USERNAME" ]; then
    HEIMDALL_RELAYSERVER_USERNAME="RelayServer"
    updateConfigVar HEIMDALL_RELAYSERVER_USERNAME $HEIMDALL_RELAYSERVER_USERNAME
  fi
  if [ -z "$HEIMDALL_RELAYSERVER_PASSWORD" ]; then
    HEIMDALL_RELAYSERVER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HEIMDALL_RELAYSERVER_PASSWORD $HEIMDALL_RELAYSERVER_PASSWORD
  fi
  if [ -z "$UPTIMEKUMA_USERNAME" ]; then
    UPTIMEKUMA_USERNAME=$ADMIN_USERNAME_BASE"_uptimekuma"
    updateConfigVar UPTIMEKUMA_USERNAME $UPTIMEKUMA_USERNAME
  fi
  if [ -z "$UPTIMEKUMA_PASSWORD" ]; then
    UPTIMEKUMA_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar UPTIMEKUMA_PASSWORD $UPTIMEKUMA_PASSWORD
  fi
  if [ -z "$MEALIE_ADMIN_USERNAME" ]; then
    MEALIE_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_mealie"
    updateConfigVar MEALIE_ADMIN_USERNAME $MEALIE_ADMIN_USERNAME
  fi
  if [ -z "$MEALIE_ADMIN_EMAIL_ADDRESS" ]; then
    MEALIE_ADMIN_EMAIL_ADDRESS=$MEALIE_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar MEALIE_ADMIN_EMAIL_ADDRESS $MEALIE_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$MEALIE_ADMIN_PASSWORD" ]; then
    MEALIE_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MEALIE_ADMIN_PASSWORD $MEALIE_ADMIN_PASSWORD
  fi
  if [ -z "$MEALIE_DATABASE_NAME" ]; then
    MEALIE_DATABASE_NAME=mealiedb
    updateConfigVar MEALIE_DATABASE_NAME $MEALIE_DATABASE_NAME
  fi
  if [ -z "$MEALIE_DATABASE_USER" ]; then
    MEALIE_DATABASE_USER=mealie-user
    updateConfigVar MEALIE_DATABASE_USER $MEALIE_DATABASE_USER
  fi
  if [ -z "$MEALIE_DATABASE_USER_PASSWORD" ]; then
    MEALIE_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MEALIE_DATABASE_USER_PASSWORD $MEALIE_DATABASE_USER_PASSWORD
  fi
  if [ -z "$REMOTELY_ADMIN_USERNAME" ]; then
    REMOTELY_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_remotely"
    updateConfigVar REMOTELY_ADMIN_USERNAME $REMOTELY_ADMIN_USERNAME
  fi
  if [ -z "$REMOTELY_ADMIN_EMAIL_ADDRESS" ]; then
    REMOTELY_ADMIN_EMAIL_ADDRESS=$REMOTELY_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar REMOTELY_ADMIN_EMAIL_ADDRESS $REMOTELY_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$REMOTELY_ADMIN_PASSWORD" ]; then
    REMOTELY_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar REMOTELY_ADMIN_PASSWORD $REMOTELY_ADMIN_PASSWORD
  fi
  if [ -z "$CALIBRE_WEB_ADMIN_USERNAME" ]; then
    CALIBRE_WEB_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_calibre"
    updateConfigVar CALIBRE_WEB_ADMIN_USERNAME $CALIBRE_WEB_ADMIN_USERNAME
  fi
  if [ -z "$CALIBRE_WEB_ADMIN_EMAIL_ADDRESS" ]; then
    CALIBRE_WEB_ADMIN_EMAIL_ADDRESS=$CALIBRE_WEB_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar CALIBRE_WEB_ADMIN_EMAIL_ADDRESS $CALIBRE_WEB_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$CALIBRE_WEB_ADMIN_PASSWORD" ]; then
    CALIBRE_WEB_ADMIN_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar CALIBRE_WEB_ADMIN_PASSWORD $CALIBRE_WEB_ADMIN_PASSWORD
  fi
  if [ -z "$LINKWARDEN_DATABASE_NAME" ]; then
    LINKWARDEN_DATABASE_NAME=linkwardendb
    updateConfigVar LINKWARDEN_DATABASE_NAME $LINKWARDEN_DATABASE_NAME
  fi
  if [ -z "$LINKWARDEN_DATABASE_USER" ]; then
    LINKWARDEN_DATABASE_USER=linkwarden-user
    updateConfigVar LINKWARDEN_DATABASE_USER $LINKWARDEN_DATABASE_USER
  fi
  if [ -z "$LINKWARDEN_DATABASE_USER_PASSWORD" ]; then
    LINKWARDEN_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LINKWARDEN_DATABASE_USER_PASSWORD $LINKWARDEN_DATABASE_USER_PASSWORD
  fi
  if [ -z "$LINKWARDEN_OIDC_CLIENT_SECRET" ]; then
    LINKWARDEN_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar LINKWARDEN_OIDC_CLIENT_SECRET $LINKWARDEN_OIDC_CLIENT_SECRET
  fi
  if [ -z "$FRESHRSS_ADMIN_USERNAME" ]; then
    FRESHRSS_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_freshrss"
    updateConfigVar FRESHRSS_ADMIN_USERNAME $FRESHRSS_ADMIN_USERNAME
  fi
  if [ -z "$FRESHRSS_ADMIN_EMAIL_ADDRESS" ]; then
    FRESHRSS_ADMIN_EMAIL_ADDRESS=$FRESHRSS_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar FRESHRSS_ADMIN_EMAIL_ADDRESS $FRESHRSS_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$FRESHRSS_ADMIN_PASSWORD" ]; then
    FRESHRSS_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar FRESHRSS_ADMIN_PASSWORD $FRESHRSS_ADMIN_PASSWORD
  fi
  if [ -z "$FRESHRSS_DATABASE_NAME" ]; then
    FRESHRSS_DATABASE_NAME=freshrssdb
    updateConfigVar FRESHRSS_DATABASE_NAME $FRESHRSS_DATABASE_NAME
  fi
  if [ -z "$FRESHRSS_DATABASE_USER" ]; then
    FRESHRSS_DATABASE_USER=freshrss-user
    updateConfigVar FRESHRSS_DATABASE_USER $FRESHRSS_DATABASE_USER
  fi
  if [ -z "$FRESHRSS_DATABASE_USER_PASSWORD" ]; then
    FRESHRSS_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar FRESHRSS_DATABASE_USER_PASSWORD $FRESHRSS_DATABASE_USER_PASSWORD
  fi
  if [ -z "$FRESHRSS_OIDC_CLIENT_SECRET" ]; then
    FRESHRSS_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar FRESHRSS_OIDC_CLIENT_SECRET $FRESHRSS_OIDC_CLIENT_SECRET
  fi
  if [ -z "$KEILA_ADMIN_USERNAME" ]; then
    KEILA_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_keila"
    updateConfigVar KEILA_ADMIN_USERNAME $KEILA_ADMIN_USERNAME
  fi
  if [ -z "$KEILA_ADMIN_EMAIL_ADDRESS" ]; then
    KEILA_ADMIN_EMAIL_ADDRESS=$KEILA_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar KEILA_ADMIN_EMAIL_ADDRESS $KEILA_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$KEILA_ADMIN_PASSWORD" ]; then
    KEILA_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar KEILA_ADMIN_PASSWORD $KEILA_ADMIN_PASSWORD
  fi
  if [ -z "$KEILA_DATABASE_NAME" ]; then
    KEILA_DATABASE_NAME=keiladb
    updateConfigVar KEILA_DATABASE_NAME $KEILA_DATABASE_NAME
  fi
  if [ -z "$KEILA_DATABASE_USER" ]; then
    KEILA_DATABASE_USER=keila-user
    updateConfigVar KEILA_DATABASE_USER $KEILA_DATABASE_USER
  fi
  if [ -z "$KEILA_DATABASE_USER_PASSWORD" ]; then
    KEILA_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar KEILA_DATABASE_USER_PASSWORD $KEILA_DATABASE_USER_PASSWORD
  fi
  if [ -z "$WALLABAG_ADMIN_USERNAME" ]; then
    WALLABAG_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_wallabag"
    updateConfigVar WALLABAG_ADMIN_USERNAME $WALLABAG_ADMIN_USERNAME
  fi
  if [ -z "$WALLABAG_ADMIN_EMAIL_ADDRESS" ]; then
    WALLABAG_ADMIN_EMAIL_ADDRESS=$WALLABAG_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar WALLABAG_ADMIN_EMAIL_ADDRESS $WALLABAG_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$WALLABAG_ADMIN_PASSWORD" ]; then
    WALLABAG_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WALLABAG_ADMIN_PASSWORD $WALLABAG_ADMIN_PASSWORD
  fi
  if [ -z "$WALLABAG_DATABASE_NAME" ]; then
    WALLABAG_DATABASE_NAME=wallabagdb
    updateConfigVar WALLABAG_DATABASE_NAME $WALLABAG_DATABASE_NAME
  fi
  if [ -z "$WALLABAG_DATABASE_USER" ]; then
    WALLABAG_DATABASE_USER=wallabag-user
    updateConfigVar WALLABAG_DATABASE_USER $WALLABAG_DATABASE_USER
  fi
  if [ -z "$WALLABAG_DATABASE_USER_PASSWORD" ]; then
    WALLABAG_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WALLABAG_DATABASE_USER_PASSWORD $WALLABAG_DATABASE_USER_PASSWORD
  fi
  if [ -z "$JUPYTER_ADMIN_PASSWORD" ]; then
    JUPYTER_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar JUPYTER_ADMIN_PASSWORD $JUPYTER_ADMIN_PASSWORD
  fi
  if [ -z "$PAPERLESS_ADMIN_USERNAME" ]; then
    PAPERLESS_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_paperless"
    updateConfigVar PAPERLESS_ADMIN_USERNAME $PAPERLESS_ADMIN_USERNAME
  fi
  if [ -z "$PAPERLESS_ADMIN_EMAIL_ADDRESS" ]; then
    PAPERLESS_ADMIN_EMAIL_ADDRESS=$PAPERLESS_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar PAPERLESS_ADMIN_EMAIL_ADDRESS $PAPERLESS_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$PAPERLESS_ADMIN_PASSWORD" ]; then
    PAPERLESS_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PAPERLESS_ADMIN_PASSWORD $PAPERLESS_ADMIN_PASSWORD
  fi
  if [ -z "$PAPERLESS_DATABASE_NAME" ]; then
    PAPERLESS_DATABASE_NAME=paperlessdb
    updateConfigVar PAPERLESS_DATABASE_NAME $PAPERLESS_DATABASE_NAME
  fi
  if [ -z "$PAPERLESS_DATABASE_USER" ]; then
    PAPERLESS_DATABASE_USER=paperless-user
    updateConfigVar PAPERLESS_DATABASE_USER $PAPERLESS_DATABASE_USER
  fi
  if [ -z "$PAPERLESS_DATABASE_USER_PASSWORD" ]; then
    PAPERLESS_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PAPERLESS_DATABASE_USER_PASSWORD $PAPERLESS_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PAPERLESS_OIDC_CLIENT_SECRET" ]; then
    PAPERLESS_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar PAPERLESS_OIDC_CLIENT_SECRET $PAPERLESS_OIDC_CLIENT_SECRET
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME" ]; then
    SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_speedtest_tracker_local"
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME $SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS" ]; then
    SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS=$SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD" ]; then
    SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD $SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME" ]; then
    SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME=speedtesttrackerlocaldb
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME $SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER" ]; then
    SPEEDTEST_TRACKER_LOCAL_DATABASE_USER=speedtest-tracker-local-user
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_DATABASE_USER $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER
  fi
  if [ -z "$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD" ]; then
    SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME" ]; then
    SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_speedtest_tracker_vpn"
    updateConfigVar SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME $SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS" ]; then
    SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS=$SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD" ]; then
    SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD $SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_DATABASE_NAME" ]; then
    SPEEDTEST_TRACKER_VPN_DATABASE_NAME=speedtesttrackervpndb
    updateConfigVar SPEEDTEST_TRACKER_VPN_DATABASE_NAME $SPEEDTEST_TRACKER_VPN_DATABASE_NAME
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_DATABASE_USER" ]; then
    SPEEDTEST_TRACKER_VPN_DATABASE_USER=speedtest-tracker-vpn-user
    updateConfigVar SPEEDTEST_TRACKER_VPN_DATABASE_USER $SPEEDTEST_TRACKER_VPN_DATABASE_USER
  fi
  if [ -z "$SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD" ]; then
    SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD $SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
  fi
  if [ -z "$CHANGEDETECTION_ADMIN_PASSWORD" ]; then
    CHANGEDETECTION_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar CHANGEDETECTION_ADMIN_PASSWORD $CHANGEDETECTION_ADMIN_PASSWORD
  fi
  if [ -z "$HUGINN_ADMIN_USERNAME" ]; then
    HUGINN_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_huginn"
    updateConfigVar HUGINN_ADMIN_USERNAME $HUGINN_ADMIN_USERNAME
  fi
  if [ -z "$HUGINN_ADMIN_EMAIL_ADDRESS" ]; then
    HUGINN_ADMIN_EMAIL_ADDRESS=$HUGINN_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar HUGINN_ADMIN_EMAIL_ADDRESS $HUGINN_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$HUGINN_ADMIN_PASSWORD" ]; then
    HUGINN_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HUGINN_ADMIN_PASSWORD $HUGINN_ADMIN_PASSWORD
  fi
  if [ -z "$HUGINN_DATABASE_NAME" ]; then
    HUGINN_DATABASE_NAME=huginndb
    updateConfigVar HUGINN_DATABASE_NAME $HUGINN_DATABASE_NAME
  fi
  if [ -z "$HUGINN_DATABASE_USER" ]; then
    HUGINN_DATABASE_USER=huginn-user
    updateConfigVar HUGINN_DATABASE_USER $HUGINN_DATABASE_USER
  fi
  if [ -z "$HUGINN_DATABASE_USER_PASSWORD" ]; then
    HUGINN_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar HUGINN_DATABASE_USER_PASSWORD $HUGINN_DATABASE_USER_PASSWORD
  fi
  if [ -z "$COTURN_STATIC_SECRET" ]; then
    COTURN_STATIC_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar COTURN_STATIC_SECRET $COTURN_STATIC_SECRET
  fi
  if [ -z "$PIPED_DATABASE_NAME" ]; then
    PIPED_DATABASE_NAME=pipeddb
    updateConfigVar PIPED_DATABASE_NAME $PIPED_DATABASE_NAME
  fi
  if [ -z "$PIPED_DATABASE_USER" ]; then
    PIPED_DATABASE_USER=piped-user
    updateConfigVar PIPED_DATABASE_USER $PIPED_DATABASE_USER
  fi
  if [ -z "$PIPED_DATABASE_USER_PASSWORD" ]; then
    PIPED_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PIPED_DATABASE_USER_PASSWORD $PIPED_DATABASE_USER_PASSWORD
  fi
  if [ -z "$GRAMPSWEB_ADMIN_USERNAME" ]; then
    GRAMPSWEB_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_grampsweb"
    updateConfigVar GRAMPSWEB_ADMIN_USERNAME $GRAMPSWEB_ADMIN_USERNAME
  fi
  if [ -z "$GRAMPSWEB_ADMIN_PASSWORD" ]; then
    GRAMPSWEB_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GRAMPSWEB_ADMIN_PASSWORD $GRAMPSWEB_ADMIN_PASSWORD
  fi
  if [ -z "$GRAMPSWEB_ADMIN_EMAIL_ADDRESS" ]; then
    GRAMPSWEB_ADMIN_EMAIL_ADDRESS=$GRAMPSWEB_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar GRAMPSWEB_ADMIN_EMAIL_ADDRESS $GRAMPSWEB_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$GRAMPSWEB_SECRET_KEY" ]; then
    GRAMPSWEB_SECRET_KEY=$(pwgen -c -n 43 1)
    updateConfigVar GRAMPSWEB_SECRET_KEY $GRAMPSWEB_SECRET_KEY
  fi
  if [ -z "$GRAMPSWEB_REDIS_PASSWORD" ]; then
    GRAMPSWEB_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GRAMPSWEB_REDIS_PASSWORD $GRAMPSWEB_REDIS_PASSWORD
  fi
  if [ -z "$PENPOT_REDIS_PASSWORD" ]; then
    PENPOT_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PENPOT_REDIS_PASSWORD $PENPOT_REDIS_PASSWORD
  fi
  if [ -z "$PENPOT_DATABASE_NAME" ]; then
    PENPOT_DATABASE_NAME=penpotdb
    updateConfigVar PENPOT_DATABASE_NAME $PENPOT_DATABASE_NAME
  fi
  if [ -z "$PENPOT_DATABASE_USER" ]; then
    PENPOT_DATABASE_USER=penpot-user
    updateConfigVar PENPOT_DATABASE_USER $PENPOT_DATABASE_USER
  fi
  if [ -z "$PENPOT_DATABASE_USER_PASSWORD" ]; then
    PENPOT_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PENPOT_DATABASE_USER_PASSWORD $PENPOT_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PENPOT_SECRET_KEY" ]; then
    PENPOT_SECRET_KEY=$(pwgen -c -n 32 1)
    updateConfigVar PENPOT_SECRET_KEY $PENPOT_SECRET_KEY
  fi
  if [ -z "$ESPOCRM_ADMIN_USERNAME" ]; then
    ESPOCRM_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_espocrm"
    updateConfigVar ESPOCRM_ADMIN_USERNAME $ESPOCRM_ADMIN_USERNAME
  fi
  if [ -z "$ESPOCRM_ADMIN_PASSWORD" ]; then
    ESPOCRM_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar ESPOCRM_ADMIN_PASSWORD $ESPOCRM_ADMIN_PASSWORD
  fi
  if [ -z "$ESPOCRM_DATABASE_NAME" ]; then
    ESPOCRM_DATABASE_NAME=espocrmdb
    updateConfigVar ESPOCRM_DATABASE_NAME $ESPOCRM_DATABASE_NAME
  fi
  if [ -z "$ESPOCRM_DATABASE_ROOT_PASSWORD" ]; then
    ESPOCRM_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar ESPOCRM_DATABASE_ROOT_PASSWORD $ESPOCRM_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$ESPOCRM_DATABASE_USER" ]; then
    ESPOCRM_DATABASE_USER=espocrm-user
    updateConfigVar ESPOCRM_DATABASE_USER $ESPOCRM_DATABASE_USER
  fi
  if [ -z "$ESPOCRM_DATABASE_USER_PASSWORD" ]; then
    ESPOCRM_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar ESPOCRM_DATABASE_USER_PASSWORD $ESPOCRM_DATABASE_USER_PASSWORD
  fi
  if [ -z "$IMMICH_ADMIN_USERNAME" ]; then
    IMMICH_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_immich"
    updateConfigVar IMMICH_ADMIN_USERNAME $IMMICH_ADMIN_USERNAME
  fi
  if [ -z "$IMMICH_ADMIN_PASSWORD" ]; then
    IMMICH_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar IMMICH_ADMIN_PASSWORD $IMMICH_ADMIN_PASSWORD
  fi
  if [ -z "$IMMICH_ADMIN_EMAIL_ADDRESS" ]; then
    IMMICH_ADMIN_EMAIL_ADDRESS=$IMMICH_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar IMMICH_ADMIN_EMAIL_ADDRESS $IMMICH_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$IMMICH_DATABASE_NAME" ]; then
    IMMICH_DATABASE_NAME=immichdb
    updateConfigVar IMMICH_DATABASE_NAME $IMMICH_DATABASE_NAME
  fi
  if [ -z "$IMMICH_DATABASE_USER" ]; then
    IMMICH_DATABASE_USER=immich-user
    updateConfigVar IMMICH_DATABASE_USER $IMMICH_DATABASE_USER
  fi
  if [ -z "$IMMICH_DATABASE_USER_PASSWORD" ]; then
    IMMICH_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar IMMICH_DATABASE_USER_PASSWORD $IMMICH_DATABASE_USER_PASSWORD
  fi
  if [ -z "$IMMICH_REDIS_PASSWORD" ]; then
    IMMICH_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar IMMICH_REDIS_PASSWORD $IMMICH_REDIS_PASSWORD
  fi
  if [ -z "$IMMICH_OIDC_CLIENT_SECRET" ]; then
    IMMICH_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar IMMICH_OIDC_CLIENT_SECRET $IMMICH_OIDC_CLIENT_SECRET
  fi
  if [ -z "$HOMARR_ADMIN_USERNAME" ]; then
    HOMARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_homarr"
    updateConfigVar HOMARR_ADMIN_USERNAME $HOMARR_ADMIN_USERNAME
  fi
  if [ -z "$HOMARR_ADMIN_EMAIL_ADDRESS" ]; then
    HOMARR_ADMIN_EMAIL_ADDRESS=$HOMARR_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar HOMARR_ADMIN_EMAIL_ADDRESS $HOMARR_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$HOMARR_ADMIN_PASSWORD" ]; then
    HOMARR_ADMIN_PASSWORD=$(getPasswordWithSymbol 32)
    updateConfigVar HOMARR_ADMIN_PASSWORD $HOMARR_ADMIN_PASSWORD
  fi
  if [ -z "$HOMARR_OIDC_CLIENT_SECRET" ]; then
    HOMARR_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar HOMARR_OIDC_CLIENT_SECRET $HOMARR_OIDC_CLIENT_SECRET
  fi
  if [ -z "$MATOMO_ADMIN_USERNAME" ]; then
    MATOMO_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_matomo"
    updateConfigVar MATOMO_ADMIN_USERNAME $MATOMO_ADMIN_USERNAME
  fi
  if [ -z "$MATOMO_ADMIN_PASSWORD" ]; then
    MATOMO_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MATOMO_ADMIN_PASSWORD $MATOMO_ADMIN_PASSWORD
  fi
  if [ -z "$MATOMO_ADMIN_EMAIL_ADDRESS" ]; then
    MATOMO_ADMIN_EMAIL_ADDRESS=$MATOMO_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar MATOMO_ADMIN_EMAIL_ADDRESS $MATOMO_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$MATOMO_DATABASE_NAME" ]; then
    MATOMO_DATABASE_NAME=matomodb
    updateConfigVar MATOMO_DATABASE_NAME $MATOMO_DATABASE_NAME
  fi
  if [ -z "$MATOMO_DATABASE_ROOT_PASSWORD" ]; then
    MATOMO_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MATOMO_DATABASE_ROOT_PASSWORD $MATOMO_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$MATOMO_DATABASE_USER" ]; then
    MATOMO_DATABASE_USER=matomo-user
    updateConfigVar MATOMO_DATABASE_USER $MATOMO_DATABASE_USER
  fi
  if [ -z "$MATOMO_DATABASE_USER_PASSWORD" ]; then
    MATOMO_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MATOMO_DATABASE_USER_PASSWORD $MATOMO_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PASTEFY_ADMIN_USERNAME" ]; then
    PASTEFY_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_pastefy"
    updateConfigVar PASTEFY_ADMIN_USERNAME $PASTEFY_ADMIN_USERNAME
  fi
  if [ -z "$PASTEFY_ADMIN_PASSWORD" ]; then
    PASTEFY_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PASTEFY_ADMIN_PASSWORD $PASTEFY_ADMIN_PASSWORD
  fi
  if [ -z "$PASTEFY_ADMIN_EMAIL_ADDRESS" ]; then
    PASTEFY_ADMIN_EMAIL_ADDRESS=$PASTEFY_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar PASTEFY_ADMIN_EMAIL_ADDRESS $PASTEFY_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$PASTEFY_DATABASE_NAME" ]; then
    PASTEFY_DATABASE_NAME=pastefydb
    updateConfigVar PASTEFY_DATABASE_NAME $PASTEFY_DATABASE_NAME
  fi
  if [ -z "$PASTEFY_DATABASE_ROOT_PASSWORD" ]; then
    PASTEFY_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PASTEFY_DATABASE_ROOT_PASSWORD $PASTEFY_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$PASTEFY_DATABASE_USER" ]; then
    PASTEFY_DATABASE_USER=pastefy-user
    updateConfigVar PASTEFY_DATABASE_USER $PASTEFY_DATABASE_USER
  fi
  if [ -z "$PASTEFY_DATABASE_USER_PASSWORD" ]; then
    PASTEFY_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PASTEFY_DATABASE_USER_PASSWORD $PASTEFY_DATABASE_USER_PASSWORD
  fi
  if [ -z "$AISTACK_MINDSDB_ADMIN_USERNAME" ]; then
    AISTACK_MINDSDB_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_aistack_mindsdb"
    updateConfigVar AISTACK_MINDSDB_ADMIN_USERNAME $AISTACK_MINDSDB_ADMIN_USERNAME
  fi
  if [ -z "$AISTACK_MINDSDB_ADMIN_PASSWORD" ]; then
    AISTACK_MINDSDB_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar AISTACK_MINDSDB_ADMIN_PASSWORD $AISTACK_MINDSDB_ADMIN_PASSWORD
  fi
  if [ -z "$AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS" ]; then
    AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS=$AISTACK_MINDSDB_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS $AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$AISTACK_MINDSDB_DATABASE_NAME" ]; then
    AISTACK_MINDSDB_DATABASE_NAME=mindsdb
    updateConfigVar AISTACK_MINDSDB_DATABASE_NAME $AISTACK_MINDSDB_DATABASE_NAME
  fi
  if [ -z "$AISTACK_MINDSDB_DATABASE_USER" ]; then
    AISTACK_MINDSDB_DATABASE_USER=mindsdb-user
    updateConfigVar AISTACK_MINDSDB_DATABASE_USER $AISTACK_MINDSDB_DATABASE_USER
  fi
  if [ -z "$AISTACK_MINDSDB_DATABASE_USER_PASSWORD" ]; then
    AISTACK_MINDSDB_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar AISTACK_MINDSDB_DATABASE_USER_PASSWORD $AISTACK_MINDSDB_DATABASE_USER_PASSWORD
  fi
  if [ -z "$AISTACK_LANGFUSE_ADMIN_USERNAME" ]; then
    AISTACK_LANGFUSE_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_aistack_langfuse"
    updateConfigVar AISTACK_LANGFUSE_ADMIN_USERNAME $AISTACK_LANGFUSE_ADMIN_USERNAME
  fi
  if [ -z "$AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS" ]; then
    AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS=$AISTACK_LANGFUSE_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS $AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$AISTACK_LANGFUSE_ADMIN_PASSWORD" ]; then
    AISTACK_LANGFUSE_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar AISTACK_LANGFUSE_ADMIN_PASSWORD $AISTACK_LANGFUSE_ADMIN_PASSWORD
  fi
  if [ -z "$AISTACK_LANGFUSE_DATABASE_NAME" ]; then
    AISTACK_LANGFUSE_DATABASE_NAME=langfuse
    updateConfigVar AISTACK_LANGFUSE_DATABASE_NAME $AISTACK_LANGFUSE_DATABASE_NAME
  fi
  if [ -z "$AISTACK_OPENWEBUI_ADMIN_USERNAME" ]; then
    AISTACK_OPENWEBUI_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_aistack_openwebui"
    updateConfigVar AISTACK_OPENWEBUI_ADMIN_USERNAME $AISTACK_OPENWEBUI_ADMIN_USERNAME
  fi
  if [ -z "$AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS" ]; then
    AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS=$AISTACK_OPENWEBUI_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    updateConfigVar AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS $AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS
  fi
  if [ -z "$AISTACK_OPENWEBUI_ADMIN_PASSWORD" ]; then
    AISTACK_OPENWEBUI_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar AISTACK_OPENWEBUI_ADMIN_PASSWORD $AISTACK_OPENWEBUI_ADMIN_PASSWORD
  fi
  if [ -z "$AISTACK_OPENWEBUI_OIDC_CLIENT_ID" ]; then
    AISTACK_OPENWEBUI_OIDC_CLIENT_ID=aistack-openwebui
    updateConfigVar AISTACK_OPENWEBUI_OIDC_CLIENT_ID $AISTACK_OPENWEBUI_OIDC_CLIENT_ID
  fi
  if [ -z "$AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET" ]; then
    AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET $AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET
  fi
  if [ -z "$AISTACK_REDIS_PASSWORD" ]; then
    AISTACK_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar AISTACK_REDIS_PASSWORD $AISTACK_REDIS_PASSWORD
  fi
  if [ -z "$PIXELFED_DATABASE_NAME" ]; then
    PIXELFED_DATABASE_NAME=pixelfeddb
    updateConfigVar PIXELFED_DATABASE_NAME $PIXELFED_DATABASE_NAME
  fi
  if [ -z "$PIXELFED_DATABASE_ROOT_PASSWORD" ]; then
    PIXELFED_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PIXELFED_DATABASE_ROOT_PASSWORD $PIXELFED_DATABASE_ROOT_PASSWORD
  fi
  if [ -z "$PIXELFED_DATABASE_USER" ]; then
    PIXELFED_DATABASE_USER=pixelfed-user
    updateConfigVar PIXELFED_DATABASE_USER $PIXELFED_DATABASE_USER
  fi
  if [ -z "$PIXELFED_DATABASE_USER_PASSWORD" ]; then
    PIXELFED_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PIXELFED_DATABASE_USER_PASSWORD $PIXELFED_DATABASE_USER_PASSWORD
  fi
  if [ -z "$PIXELFED_REDIS_PASSWORD" ]; then
    PIXELFED_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PIXELFED_REDIS_PASSWORD $PIXELFED_REDIS_PASSWORD
  fi
  if [ -z "$PIXELFED_APP_KEY" ]; then
    PIXELFED_APP_KEY=$(pwgen -c -n 32 1)
    updateConfigVar PIXELFED_APP_KEY $PIXELFED_APP_KEY
  fi
  if [ -z "$YAMTRACK_ADMIN_USERNAME" ]; then
    YAMTRACK_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_yamtrack"
    updateConfigVar YAMTRACK_ADMIN_USERNAME $YAMTRACK_ADMIN_USERNAME
  fi
  if [ -z "$YAMTRACK_ADMIN_PASSWORD" ]; then
    YAMTRACK_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar YAMTRACK_ADMIN_PASSWORD $YAMTRACK_ADMIN_PASSWORD
  fi
  if [ -z "$YAMTRACK_REDIS_PASSWORD" ]; then
    YAMTRACK_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar YAMTRACK_REDIS_PASSWORD $YAMTRACK_REDIS_PASSWORD
  fi
  if [ -z "$YAMTRACK_DATABASE_NAME" ]; then
    YAMTRACK_DATABASE_NAME=yamtrackdb
    updateConfigVar YAMTRACK_DATABASE_NAME $YAMTRACK_DATABASE_NAME
  fi
  if [ -z "$YAMTRACK_DATABASE_USER" ]; then
    YAMTRACK_DATABASE_USER=yamtrack-user
    updateConfigVar YAMTRACK_DATABASE_USER $YAMTRACK_DATABASE_USER
  fi
  if [ -z "$YAMTRACK_DATABASE_USER_PASSWORD" ]; then
    YAMTRACK_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar YAMTRACK_DATABASE_USER_PASSWORD $YAMTRACK_DATABASE_USER_PASSWORD
  fi
  if [ -z "$YAMTRACK_SECRET_KEY" ]; then
    YAMTRACK_SECRET_KEY=$(openssl rand -hex 25)
    updateConfigVar YAMTRACK_SECRET_KEY $YAMTRACK_SECRET_KEY
  fi
  if [ -z "$YAMTRACK_OIDC_CLIENT_ID" ]; then
    YAMTRACK_OIDC_CLIENT_ID=yamtrack
    updateConfigVar YAMTRACK_OIDC_CLIENT_ID $YAMTRACK_OIDC_CLIENT_ID
  fi
  if [ -z "$YAMTRACK_OIDC_CLIENT_SECRET" ]; then
    YAMTRACK_OIDC_CLIENT_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar YAMTRACK_OIDC_CLIENT_SECRET $YAMTRACK_OIDC_CLIENT_SECRET
  fi
  if [ -z "$SONARR_ADMIN_USERNAME" ]; then
    SONARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_sonarr"
    updateConfigVar SONARR_ADMIN_USERNAME $SONARR_ADMIN_USERNAME
  fi
  if [ -z "$SONARR_ADMIN_PASSWORD" ]; then
    SONARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SONARR_ADMIN_PASSWORD $SONARR_ADMIN_PASSWORD
  fi
  if [ -z "$RADARR_ADMIN_USERNAME" ]; then
    RADARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_radarr"
    updateConfigVar RADARR_ADMIN_USERNAME $RADARR_ADMIN_USERNAME
  fi
  if [ -z "$RADARR_ADMIN_PASSWORD" ]; then
    RADARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar RADARR_ADMIN_PASSWORD $RADARR_ADMIN_PASSWORD
  fi
  if [ -z "$LIDARR_ADMIN_USERNAME" ]; then
    LIDARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_lidarr"
    updateConfigVar LIDARR_ADMIN_USERNAME $LIDARR_ADMIN_USERNAME
  fi
  if [ -z "$LIDARR_ADMIN_PASSWORD" ]; then
    LIDARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LIDARR_ADMIN_PASSWORD $LIDARR_ADMIN_PASSWORD
  fi
  if [ -z "$READARR_ADMIN_USERNAME" ]; then
    READARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_readarr"
    updateConfigVar READARR_ADMIN_USERNAME $READARR_ADMIN_USERNAME
  fi
  if [ -z "$READARR_ADMIN_PASSWORD" ]; then
    READARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar READARR_ADMIN_PASSWORD $READARR_ADMIN_PASSWORD
  fi
  if [ -z "$BAZARR_ADMIN_USERNAME" ]; then
    BAZARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_bazarr"
    updateConfigVar BAZARR_ADMIN_USERNAME $BAZARR_ADMIN_USERNAME
  fi
  if [ -z "$BAZARR_ADMIN_PASSWORD" ]; then
    BAZARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar BAZARR_ADMIN_PASSWORD $BAZARR_ADMIN_PASSWORD
  fi
  if [ -z "$MYLAR3_ADMIN_USERNAME" ]; then
    MYLAR3_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_mylar3"
    updateConfigVar MYLAR3_ADMIN_USERNAME $MYLAR3_ADMIN_USERNAME
  fi
  if [ -z "$MYLAR3_ADMIN_PASSWORD" ]; then
    MYLAR3_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MYLAR3_ADMIN_PASSWORD $MYLAR3_ADMIN_PASSWORD
  fi
  if [ -z "$PROWLARR_ADMIN_USERNAME" ]; then
    PROWLARR_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_prowlarr"
    updateConfigVar PROWLARR_ADMIN_USERNAME $PROWLARR_ADMIN_USERNAME
  fi
  if [ -z "$PROWLARR_ADMIN_PASSWORD" ]; then
    PROWLARR_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PROWLARR_ADMIN_PASSWORD $PROWLARR_ADMIN_PASSWORD
  fi
  if [ -z "$SABNZBD_ADMIN_USERNAME" ]; then
    SABNZBD_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_sabnzbd"
    updateConfigVar SABNZBD_ADMIN_USERNAME $SABNZBD_ADMIN_USERNAME
  fi
  if [ -z "$SABNZBD_ADMIN_PASSWORD" ]; then
    SABNZBD_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SABNZBD_ADMIN_PASSWORD $SABNZBD_ADMIN_PASSWORD
  fi
  if [ -z "$QBITTORRENT_ADMIN_USERNAME" ]; then
    QBITTORRENT_ADMIN_USERNAME=$ADMIN_USERNAME_BASE"_qbittorrent"
    updateConfigVar QBITTORRENT_ADMIN_USERNAME $QBITTORRENT_ADMIN_USERNAME
  fi
  if [ -z "$QBITTORRENT_ADMIN_PASSWORD" ]; then
    QBITTORRENT_ADMIN_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar QBITTORRENT_ADMIN_PASSWORD $QBITTORRENT_ADMIN_PASSWORD
  fi
}

function checkCreateNonbackupDirs()
{
  mkdir -p $HSHQ_NONBACKUP_DIR
  mkdir -p $HSHQ_BUILD_DIR
  mkdir -p $HSHQ_NONBACKUP_DIR/adguard/work
  mkdir -p $HSHQ_NONBACKUP_DIR/sysutils/prometheus
  mkdir -p $HSHQ_NONBACKUP_DIR/wazuh/volumes
  mkdir -p $HSHQ_NONBACKUP_DIR/wazuh/volumes/queue
  mkdir -p $HSHQ_NONBACKUP_DIR/wazuh/volumes/logs
  mkdir -p $HSHQ_NONBACKUP_DIR/wazuh/volumes/indexer-data
  mkdir -p $HSHQ_NONBACKUP_DIR/duplicati/restore
  mkdir -p $HSHQ_NONBACKUP_DIR/mastodon/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/mastodon/static
  mkdir -p $HSHQ_NONBACKUP_DIR/searxng/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/peertube/assets
  mkdir -p $HSHQ_NONBACKUP_DIR/peertube/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/gitlab/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/discourse/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/shlink/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/firefly/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/kasm/data
  mkdir -p $HSHQ_NONBACKUP_DIR/netdata/cache
  mkdir -p $HSHQ_NONBACKUP_DIR/stirlingpdf/logs
  mkdir -p $HSHQ_NONBACKUP_DIR/stirlingpdf/traindata
  mkdir -p $HSHQ_NONBACKUP_DIR/bar-assistant/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/wallabag/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/paperless/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/piped/proxy
  mkdir -p $HSHQ_NONBACKUP_DIR/penpot/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/immich/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/immich/cache
  mkdir -p $HSHQ_NONBACKUP_DIR/aistack/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/pixelfed/redis
  mkdir -p $HSHQ_NONBACKUP_DIR/yamtrack/redis
}

function installBaseStacks()
{
  initCaddyCommon
  installPortainer
  draw_progress_bar 57
  installStackByName adguard
  draw_progress_bar 59
  installStackByName openldap
  draw_progress_bar 61
  installStackByName mailu
  draw_progress_bar 63
  installStackByName duplicati
  draw_progress_bar 65
  installStackByName authelia
  draw_progress_bar 67
  installStackByName syncthing
  draw_progress_bar 69
  installStackByName heimdall
  draw_progress_bar 71
  installStackByName ofelia
  draw_progress_bar 73
  installHostInterfaceCaddy $HOMESERVER_HOST_PRIMARY_INTERFACE_NAME $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
  draw_progress_bar 75
  installStackByName uptimekuma
  draw_progress_bar 77
  installStackByName script-server
  draw_progress_bar 79
}

function initServiceVars()
{
  set +e
  checkAddSvc "SVCD_ADGUARD=adguard,adguard,primary,admin,AdguardHome,adguard,hshq"
  checkAddSvc "SVCD_AISTACK_MINDSDB_APP=aistack,mindsdb,primary,admin,MindsDB,mindsdb,hshq"
  checkAddSvc "SVCD_AISTACK_LANGFUSE=aistack,langfuse,primary,admin,Langfuse,langfuse,hshq"
  checkAddSvc "SVCD_AISTACK_OPENWEBUI=aistack,openwebui,primary,user,OpenWebUI,openwebui,hshq"
  checkAddSvc "SVCD_AUTHELIA=authelia,authelia,other,user,Authelia,authelia,hshq"
  checkAddSvc "SVCD_BARASSISTANT=bar-assistant,bar-assistant,primary,user,Bar Assistant,bar-assistant,hshq"
  checkAddSvc "SVCD_BIND_IP=bind-ip,bind-ip,other,user,BindIP,bind-ip,hshq"
  checkAddSvc "SVCD_CADDY=caddy,caddy,primary,admin,Caddy,caddy,hshq"
  checkAddSvc "SVCD_CADDYDNS=caddy,caddy-dns,primary,admin,CaddyDNS,caddy-dns,hshq"
  checkAddSvc "SVCD_CALIBRE_SERVER=calibre,calibre-server,primary,admin,Calibre-Server,calibre-server,hshq"
  checkAddSvc "SVCD_CALIBRE_WEB=calibre,calibre-web,other,user,Calibre-Web,calibre-web,le"
  checkAddSvc "SVCD_CHANGEDETECTION=changedetection,changedetection,primary,user,Change Detection,changedetection,hshq"
  checkAddSvc "SVCD_CLIENTDNS=clientdns,clientdns,primary,admin,ClientDNS,clientdns,hshq"
  checkAddSvc "SVCD_CODESERVER=codeserver,codeserver,primary,admin,CodeServer,codeserver,hshq"
  checkAddSvc "SVCD_COLLABORA=collabora,collabora,other,user,Collabora,collabora,hshq"
  checkAddSvc "SVCD_COTURN=coturn,coturn,other,user,Coturn,coturn,hshq"
  checkAddSvc "SVCD_DISCOURSE=discourse,discourse,other,user,Discourse,discourse,hshq"
  checkAddSvc "SVCD_DOZZLE=dozzle,dozzle,primary,admin,Dozzle,dozzle,hshq"
  checkAddSvc "SVCD_DRAWIO_WEB=drawio,drawio,primary,user,Draw.io,drawio,hshq"
  checkAddSvc "SVCD_DUPLICATI=duplicati,duplicati,home,admin,Duplicati,duplicati,hshq"
  checkAddSvc "SVCD_ESPOCRM=espocrm,espocrm,primary,user,EspoCRM,espocrm,hshq"
  checkAddSvc "SVCD_EXCALIDRAW_WEB=excalidraw,excalidraw,primary,user,Excalidraw,excalidraw,hshq"
  checkAddSvc "SVCD_EXCALIDRAW_SERVER=excalidraw,excalidraw-server,primary,user,Excalidraw Server,excalidraw-server,hshq"
  checkAddSvc "SVCD_EXCALIDRAW_STORAGE=excalidraw,excalidraw-storage,primary,user,Excalidraw Storage,excalidraw-storage,hshq"
  checkAddSvc "SVCD_FILEBROWSER=filebrowser,filebrowser,other,user,FileBrowser,filebrowser,hshq"
  checkAddSvc "SVCD_FILEDROP=filedrop,filedrop,other,user,FileDrop,filedrop,hshq"
  checkAddSvc "SVCD_FILES=files,files,other,user,Files,files,hshq"
  sed -i "s/SVCD_FIREFLY=/SVCD_FIREFLY_APP=/" $CONFIG_FILE
  checkAddSvc "SVCD_FIREFLY_APP=firefly,firefly,home,admin,Firefly III,fireflyiii,hshq"
  checkAddSvc "SVCD_FIREFLY_IMPORTER=firefly,firefly-importer,home,admin,Firefly III-Importer,fireflyiii-importer,hshq"
  checkAddSvc "SVCD_FRESHRSS=freshrss,freshrss,primary,user,FreshRSS,freshrss,le"
  checkAddSvc "SVCD_GHOST=ghost,ghost,other,user,Ghost,ghost,hshq"
  checkAddSvc "SVCD_GITEA=gitea,gitea,primary,user,Gitea,gitea,le"
  checkAddSvc "SVCD_GITLAB=gitlab,gitlab,primary,user,Gitlab,gitlab,hshq"
  checkAddSvc "SVCD_GRAFANA=sysutils,grafana,primary,admin,Grafana,grafana,hshq"
  checkAddSvc "SVCD_GRAMPSWEB=grampsweb,grampsweb,primary,user,GrampsWeb,grampsweb,le"
  checkAddSvc "SVCD_GUACAMOLE=guacamole,guacamole,primary,admin,Guacamole,guacamole,hshq"
  checkAddSvc "SVCD_HEIMDALL=heimdall,heimdall,other,user,Heimdall,heimdall,hshq"
  checkAddSvc "SVCD_HOMARR=homarr,homarr,other,user,Homarr,homarr,hshq"
  checkAddSvc "SVCD_HOMEASSISTANT_APP=homeassistant,homeassistant,primary,admin,HomeAssistant,homeassistant,hshq"
  checkAddSvc "SVCD_HOMEASSISTANT_CONFIGURATOR=homeassistant,hass-configurator,primary,admin,HomeAssistant-Configurator,hass-configurator,hshq"
  checkAddSvc "SVCD_HOMEASSISTANT_NODERED=homeassistant,hass-nodered,primary,admin,HomeAssistant-NodeRed,hass-nodered,hshq"
  checkAddSvc "SVCD_HOMEASSISTANT_TASMOADMIN=homeassistant,hass-tasmoadmin,primary,admin,HomeAssistant-Tasmoadmin,hass-tasmoadmin,hshq"
  checkAddSvc "SVCD_HSHQHOME=home,home,other,user,Home,home,hshq"
  checkAddSvc "SVCD_HSHQSTATUS=hshqstatus,hshqstatus,other,user,HSHQStatus,hshqstatus,hshq"
  checkAddSvc "SVCD_SCRIPTSERVER=script-server,script-server,primary,admin,Script-server,script-server,hshq"
  checkAddSvc "SVCD_HUGINN=huginn,huginn,primary,user,Huginn,huginn,hshq"
  checkAddSvc "SVCD_IMAGES=images,images,other,user,Images,images,hshq"
  checkAddSvc "SVCD_IMMICH=immich,immich,other,user,Immich,immich,le"
  checkAddSvc "SVCD_INFLUXDB=sysutils,influxdb,primary,admin,InfluxDB,influxdb,hshq"
  checkAddSvc "SVCD_INVIDIOUS=invidious,invidious,primary,user,Invidious,invidious,hshq"
  checkAddSvc "SVCD_ITTOOLS=ittools,ittools,primary,admin,IT Tools,ittools,hshq"
  checkAddSvc "SVCD_JELLYFIN=jellyfin,jellyfin,primary,user,Jellyfin,jellyfin,le"
  checkAddSvc "SVCD_JITSI=jitsi,jitsi,other,user,Jitsi,jitsi,le"
  checkAddSvc "SVCD_JUPYTER=jupyter,jupyter,primary,admin,Jupyter,jupyter,hshq"
  checkAddSvc "SVCD_LINKWARDEN=linkwarden,linkwarden,primary,user,Linkwarden,linkwarden,hshq"
  checkAddSvc "SVCD_KASM=kasm,kasm,primary,user,Kasm,kasm,hshq"
  checkAddSvc "SVCD_KASM_WIZARD=kasm,kasm-wizard,home,admin,Kasm Wizard,kasm-wizard,hshq"
  checkAddSvc "SVCD_KEILA=keila,keila,primary,user,Keila,keila,hshq"
  checkAddSvc "SVCD_MAILU=mailu,mailu,primary,user,Mailu,mailu,hshq"
  checkAddSvc "SVCD_MASTODON=mastodon,mastodon,other,user,Mastodon,mastodon,le"
  checkAddSvc "SVCD_MATRIX_ELEMENT_PRIVATE=matrix,element-private,other,user,Matrix Element (Private Jitsi),element-private,hshq"
  checkAddSvc "SVCD_MATRIX_ELEMENT_PUBLIC=matrix,element-public,other,user,Matrix Element (Public Jitsi),element-public,hshq"
  checkAddSvc "SVCD_MATRIX_SYNAPSE=matrix,synapse,other,user,Synapse,synapse,le"
  checkAddSvc "SVCD_MATOMO=matomo,matomo,primary,admin,Matomo,matomo,hshq"
  checkAddSvc "SVCD_MEALIE=mealie,mealie,other,user,Mealie,mealie,hshq"
  checkAddSvc "SVCD_NETDATA=netdata,netdata,primary,admin,Netdata,netdata,hshq"
  checkAddSvc "SVCD_NEXTCLOUD=nextcloud,nextcloud,other,user,Nextcloud,nextcloud,hshq"
  checkAddSvc "SVCD_NCTALKHPB=nextcloud,spreed,other,user,Nextcloud Talk HPB,spreed,hshq"
  checkAddSvc "SVCD_NCTALKRECORD=nextcloud,nctalk-record,other,user,Nextcloud Talk Recording,nctalk-record,hshq"
  checkAddSvc "SVCD_NTFY=ntfy,ntfy,primary,admin,NTFY,ntfy,hshq"
  checkAddSvc "SVCD_OPENLDAP_MANAGER=openldap,usermanager,other,user,User Manager,usermanager,hshq"
  checkAddSvc "SVCD_OPENLDAP_PHP=openldap,ldapphp,primary,admin,LDAP PHP,ldapphp,hshq"
  checkAddSvc "SVCD_PAPERLESS=paperless,paperless,primary,user,Paperless-ngx,paperless,hshq"
  checkAddSvc "SVCD_PASTEFY=pastefy,pastefy,primary,user,Pastefy,pastefy,hshq"
  checkAddSvc "SVCD_PEERTUBE=peertube,peertube,other,user,PeerTube,peertube,hshq"
  checkAddSvc "SVCD_PENPOT=penpot,penpot,other,user,Penpot,penpot,hshq"
  checkAddSvc "SVCD_PHOTOPRISM=photoprism,photoprism,other,user,PhotoPrism,photoprism,hshq"
  checkAddSvc "SVCD_PIPED_FRONTEND=piped,piped,primary,user,Piped,piped,hshq"
  checkAddSvc "SVCD_PIPED_PROXY=piped,piped-proxy,primary,user,Piped,piped-proxy,hshq"
  checkAddSvc "SVCD_PIPED_API=piped,piped-api,primary,user,Piped,piped-api,hshq"
  checkAddSvc "SVCD_PIXELFED=pixelfed,pixelfed,other,user,Pixelfed,pixelfed,hshq"
  checkAddSvc "SVCD_PORTAINER=portainer,portainer,primary,admin,Portainer,portainer,hshq"
  checkAddSvc "SVCD_POSTFIX=mail-relay,mail,primary,admin,Mail,mail,hshq"
  checkAddSvc "SVCD_PROMETHEUS=sysutils,prometheus,primary,admin,Prometheus,prometheus,hshq"
  checkAddSvc "SVCD_QBITTORRENT=qbittorrent,qbittorrent,primary,admin,qBittorrent,qbittorrent,hshq"
  checkAddSvc "SVCD_REMOTELY=remotely,remotely,primary,admin,Remotely,remotely,hshq"
  checkAddSvc "SVCD_RSPAMD=mail-relay,rspamd,primary,admin,Rspamd,rspamd,hshq"
  checkAddSvc "SVCD_SABNZBD=sabnzbd,sabnzbd,primary,admin,SABnzbd,sabnzbd,hshq"
  checkAddSvc "SVCD_SEARXNG=searxng,searxng,primary,user,SearxNG,searxng,hshq"
  checkAddSvc "SVCD_SERVARR_SONARR=servarr,sonarr,primary,admin,Sonarr,sonarr,hshq"
  checkAddSvc "SVCD_SERVARR_RADARR=servarr,radarr,primary,admin,Radarr,radarr,hshq"
  checkAddSvc "SVCD_SERVARR_LIDARR=servarr,lidarr,primary,admin,Lidarr,lidarr,hshq"
  checkAddSvc "SVCD_SERVARR_READARR=servarr,readarr,primary,admin,Readarr,readarr,hshq"
  checkAddSvc "SVCD_SERVARR_BAZARR=servarr,bazarr,primary,admin,Bazarr,bazarr,hshq"
  checkAddSvc "SVCD_SERVARR_MYLAR3=servarr,mylar3,primary,admin,Mylar3,mylar3,hshq"
  checkAddSvc "SVCD_SERVARR_PROWLARR=servarr,prowlarr,primary,admin,Prowlarr,prowlarr,hshq"
  checkAddSvc "SVCD_SHLINK_APP=shlink,shlink-app,other,user,Shlink App,links,hshq"
  checkAddSvc "SVCD_SHLINK_WEB=shlink,shlink-web,primary,admin,Shlink,shlink,hshq"
  checkAddSvc "SVCD_SNIPPETBOX=snippetbox,snippetbox,primary,user,SnippetBox,snippetbox,hshq"
  checkAddSvc "SVCD_SPEEDTEST_TRACKER_LOCAL=speedtest-tracker-local,speedtest-tracker-local,primary,admin,Speedtest Tracker Local,speedtest-tracker-local,hshq"
  checkAddSvc "SVCD_SPEEDTEST_TRACKER_VPN=speedtest-tracker-vpn,speedtest-tracker-vpn,primary,admin,Speedtest Tracker VPN,speedtest-tracker-vpn,hshq"
  checkAddSvc "SVCD_SQLPAD=sqlpad,sqlpad,primary,admin,SQLPad,sqlpad,hshq"
  checkAddSvc "SVCD_STIRLINGPDF=stirlingpdf,stirlingpdf,primary,user,Stirling PDF,stirlingpdf,hshq"
  checkAddSvc "SVCD_SYNCTHING=syncthing,syncthing,primary,admin,Syncthing,syncthing,hshq"
  checkAddSvc "SVCD_SYSUTILS=sysutils,sysutils,primary,admin,SysUtils,sysutils,hshq"
  checkAddSvc "SVCD_UPTIMEKUMA=uptimekuma,uptimekuma,primary,admin,UptimeKuma,uptimekuma,hshq"
  checkAddSvc "SVCD_VAULTWARDEN=vaultwarden,vaultwarden,primary,user,Vaultwarden,vaultwarden,hshq"
  checkAddSvc "SVCD_WALLABAG=wallabag,wallabag,primary,user,Wallabag,wallabag,le"
  checkAddSvc "SVCD_WAZUH=wazuh,wazuh,primary,admin,Wazuh,wazuh,hshq"
  checkAddSvc "SVCD_WGPORTAL=wgportal,wgportal,primary,admin,WG Portal,wgportal,hshq"
  checkAddSvc "SVCD_WIKIJS=wikijs,wikijs,other,user,Wiki.js,wikijs,hshq"
  checkAddSvc "SVCD_WORDPRESS=wordpress,wordpress,other,user,WordPress,wordpress,hshq"
  checkAddSvc "SVCD_YAMTRACK=yamtrack,yamtrack,other,user,Yamtrack,yamtrack,hshq"
  set -e
}

function installStackByName()
{
  stack_name=$1
  is_integrate=$2
  cd ~
  echo "------------------------------------------"
  echo "  Installing stack: $stack_name"
  echo "------------------------------------------"
  echo "Current date/time: $(date '+%Y-%m-%d %H:%M:%S')"
  case "$stack_name" in
    adguard)
      installAdGuard $is_integrate ;;
    sysutils)
      installSysUtils $is_integrate ;;
    openldap)
      installOpenLDAP $is_integrate ;;
    mailu)
      installMailu $is_integrate ;;
    wazuh)
      installWazuh $is_integrate ;;
    collabora)
      installCollabora $is_integrate ;;
    nextcloud)
      installNextcloud $is_integrate ;;
    jitsi)
      installJitsi $is_integrate ;;
    matrix)
      installMatrix $is_integrate ;;
    wikijs)
      installWikijs $is_integrate ;;
    duplicati)
      installDuplicati $is_integrate ;;
    mastodon)
      installMastodon $is_integrate ;;
    dozzle)
      installDozzle $is_integrate ;;
    searxng)
      installSearxNG $is_integrate ;;
    jellyfin)
      installJellyfin $is_integrate ;;
    filebrowser)
      installFileBrowser $is_integrate ;;
    photoprism)
      installPhotoPrism $is_integrate ;;
    guacamole)
      installGuacamole $is_integrate ;;
    authelia)
      installAuthelia $is_integrate ;;
    wordpress)
      installWordPress $is_integrate ;;
    ghost)
      installGhost $is_integrate ;;
    peertube)
      installPeerTube $is_integrate ;;
    homeassistant)
      installHomeAssistant $is_integrate ;;
    gitlab)
      installGitlab $is_integrate ;;
    vaultwarden)
      installVaultwarden $is_integrate ;;
    discourse)
      installDiscourse $is_integrate ;;
    syncthing)
      installSyncthing $is_integrate ;;
    codeserver)
      installCodeServer $is_integrate ;;
    shlink)
      installShlink $is_integrate ;;
    firefly)
      installFirefly $is_integrate ;;
    excalidraw)
      installExcalidraw $is_integrate ;;
    drawio)
      installDrawIO $is_integrate ;;
    invidious)
      installInvidious $is_integrate ;;
    ittools)
      installITTools $is_integrate ;;
    gitea)
      installGitea $is_integrate ;;
    mealie)
      installMealie $is_integrate ;;
    kasm)
      installKasm $is_integrate ;;
    ntfy)
      installNTFY $is_integrate ;;
    remotely)
      installRemotely $is_integrate ;;
    calibre)
      installCalibre $is_integrate ;;
    netdata)
      installNetdata $is_integrate ;;
    linkwarden)
      installLinkwarden $is_integrate ;;
    stirlingpdf)
      installStirlingPDF $is_integrate ;;
    bar-assistant)
      installBarAssistant $is_integrate ;;
    freshrss)
      installFreshRSS $is_integrate ;;
    keila)
      installKeila $is_integrate ;;
    wallabag)
      installWallabag $is_integrate ;;
    jupyter)
      installJupyter $is_integrate ;;
    paperless)
      installPaperless $is_integrate ;;
    speedtest-tracker-local)
      installSpeedtestTrackerLocal $is_integrate ;;
    speedtest-tracker-vpn)
      installSpeedtestTrackerVPN $is_integrate ;;
    changedetection)
      installChangeDetection $is_integrate ;;
    huginn)
      installHuginn $is_integrate ;;
    coturn)
      installCoturn $is_integrate ;;
    filedrop)
      installFileDrop $is_integrate ;;
    piped)
      installPiped $is_integrate ;;
    grampsweb)
      installGrampsWeb $is_integrate ;;
    penpot)
      installPenpot $is_integrate ;;
    espocrm)
      installEspoCRM $is_integrate ;;
    immich)
      installImmich $is_integrate ;;
    homarr)
      installHomarr $is_integrate ;;
    matomo)
      installMatomo $is_integrate ;;
    pastefy)
      installPastefy $is_integrate ;;
    snippetbox)
      installSnippetBox $is_integrate ;;
    aistack)
      installAIStack $is_integrate ;;
    pixelfed)
      installPixelfed $is_integrate ;;
    yamtrack)
      installYamtrack $is_integrate ;;
    servarr)
      installServarr $is_integrate ;;
    sabnzbd)
      installSABnzbd $is_integrate ;;
    qbittorrent)
      installqBittorrent $is_integrate ;;
    heimdall)
      installHeimdall $is_integrate ;;
    ofelia)
      installOfelia $is_integrate ;;
    script-server)
      installScriptServer $is_integrate ;;
    sqlpad)
      installSQLPad $is_integrate ;;
    uptimekuma)
      installUptimeKuma $is_integrate ;;
  esac
  stack_install_retval=$?
  if [ $stack_install_retval -ne 0 ]; then
    notifyStackInstallFailure "$stack_name"
    if [ "$IS_INSTALLING" = "true" ]; then
      logHSHQEvent error "Error installing stack ($stack_name), exiting..."
      exit 1
    fi
  fi
}

function performUpdateStackByName()
{
  stack_name=$1
  portainerToken="$2"
  case "$stack_name" in
    portainer)
      performUpdatePortainer ;;
    adguard)
      performUpdateAdGuard "$portainerToken" ;;
    sysutils)
      performUpdateSysUtils "$portainerToken" ;;
    openldap)
      performUpdateOpenLDAP "$portainerToken" ;;
    mailu)
      performUpdateMailu "$portainerToken" ;;
    wazuh)
      performUpdateWazuh "$portainerToken" ;;
    collabora)
      performUpdateCollabora "$portainerToken" ;;
    nextcloud)
      performUpdateNextcloud "$portainerToken" ;;
    jitsi)
      performUpdateJitsi "$portainerToken" ;;
    matrix)
      performUpdateMatrix "$portainerToken" ;;
    wikijs)
      performUpdateWikijs "$portainerToken" ;;
    duplicati)
      performUpdateDuplicati "$portainerToken" ;;
    mastodon)
      performUpdateMastodon "$portainerToken" ;;
    dozzle)
      performUpdateDozzle "$portainerToken" ;;
    searxng)
      performUpdateSearxNG "$portainerToken" ;;
    jellyfin)
      performUpdateJellyfin "$portainerToken" ;;
    filebrowser)
      performUpdateFileBrowser "$portainerToken" ;;
    photoprism)
      performUpdatePhotoPrism "$portainerToken" ;;
    guacamole)
      performUpdateGuacamole "$portainerToken" ;;
    authelia)
      performUpdateAuthelia "$portainerToken" ;;
    wordpress)
      performUpdateWordPress "$portainerToken" ;;
    ghost)
      performUpdateGhost "$portainerToken" ;;
    peertube)
      performUpdatePeerTube "$portainerToken" ;;
    homeassistant)
      performUpdateHomeAssistant "$portainerToken" ;;
    gitlab)
      performUpdateGitlab "$portainerToken" ;;
    vaultwarden)
      performUpdateVaultwarden "$portainerToken" ;;
    discourse)
      performUpdateDiscourse "$portainerToken" ;;
    syncthing)
      performUpdateSyncthing "$portainerToken" ;;
    codeserver)
      performUpdateCodeServer "$portainerToken" ;;
    shlink)
      performUpdateShlink "$portainerToken" ;;
    firefly)
      performUpdateFirefly "$portainerToken" ;;
    excalidraw)
      performUpdateExcalidraw "$portainerToken" ;;
    drawio)
      performUpdateDrawIO "$portainerToken" ;;
    invidious)
      performUpdateInvidious "$portainerToken" ;;
    ittools)
      performUpdateITTools "$portainerToken" ;;
    gitea)
      performUpdateGitea "$portainerToken" ;;
    mealie)
      performUpdateMealie "$portainerToken" ;;
    kasm)
      performUpdateKasm "$portainerToken" ;;
    ntfy)
      performUpdateNTFY "$portainerToken" ;;
    remotely)
      performUpdateRemotely "$portainerToken" ;;
    calibre)
      performUpdateCalibre "$portainerToken" ;;
    netdata)
      performUpdateNetdata "$portainerToken" ;;
    linkwarden)
      performUpdateLinkwarden "$portainerToken" ;;
    stirlingpdf)
      performUpdateStirlingPDF "$portainerToken" ;;
    bar-assistant)
      performUpdateBarAssistant "$portainerToken" ;;
    freshrss)
      performUpdateFreshRSS "$portainerToken" ;;
    keila)
      performUpdateKeila "$portainerToken" ;;
    wallabag)
      performUpdateWallabag "$portainerToken" ;;
    jupyter)
      performUpdateJupyter "$portainerToken" ;;
    paperless)
      performUpdatePaperless "$portainerToken" ;;
    speedtest-tracker-local)
      performUpdateSpeedtestTrackerLocal "$portainerToken" ;;
    speedtest-tracker-vpn)
      performUpdateSpeedtestTrackerVPN "$portainerToken" ;;
    changedetection)
      performUpdateChangeDetection "$portainerToken" ;;
    huginn)
      performUpdateHuginn "$portainerToken" ;;
    coturn)
      performUpdateCoturn "$portainerToken" ;;
    filedrop)
      performUpdateFileDrop "$portainerToken" ;;
    piped)
      performUpdatePiped "$portainerToken" ;;
    grampsweb)
      performUpdateGrampsWeb "$portainerToken" ;;
    penpot)
      performUpdatePenpot "$portainerToken" ;;
    espocrm)
      performUpdateEspoCRM "$portainerToken" ;;
    immich)
      performUpdateImmich "$portainerToken" ;;
    homarr)
      performUpdateHomarr "$portainerToken" ;;
    matomo)
      performUpdateMatomo "$portainerToken" ;;
    pastefy)
      performUpdatePastefy "$portainerToken" ;;
    snippetbox)
      performUpdateSnippetBox "$portainerToken" ;;
    aistack)
      performUpdateAIStack "$portainerToken" ;;
    pixelfed)
      performUpdatePixelfed "$portainerToken" ;;
    yamtrack)
      performUpdateYamtrack "$portainerToken" ;;
    servarr)
      performUpdateServarr "$portainerToken" ;;
    sabnzbd)
      performUpdateSABnzbd "$portainerToken" ;;
    qbittorrent)
      performUpdateqBittorrent "$portainerToken" ;;
    heimdall)
      performUpdateHeimdall "$portainerToken" ;;
    ofelia)
      performUpdateOfelia "$portainerToken" ;;
    script-server)
      performUpdateScriptServer "$portainerToken" ;;
    sqlpad)
      performUpdateSQLPad "$portainerToken" ;;
    uptimekuma)
      performUpdateUptimeKuma "$portainerToken" ;;
    caddy-*)
      performUpdateCaddy "$portainerToken" "$stack_name" ;;
    clientdns-*)
      performUpdateClientDNS "$portainerToken" "$stack_name" ;;
  esac
}

function getAutheliaBlock()
{
  retval=""
  retval="${retval}access_control:\n"
  retval="${retval}  default_policy: deny\n"
  retval="${retval}  rules:\n"
  retval="${retval}    - domain:\n"
  retval="${retval}# Authelia bypass BEGIN\n"
  retval="${retval}        - $SUB_AUTHELIA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_COLLABORA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_DRAWIO_WEB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_ESPOCRM.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_EXCALIDRAW_WEB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_EXCALIDRAW_SERVER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_EXCALIDRAW_STORAGE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_FILEBROWSER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_FILEDROP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_FRESHRSS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GITEA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GRAMPSWEB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HEIMDALL.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HOMARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HSHQHOME.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HSHQSTATUS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HOMEASSISTANT_CONFIGURATOR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HOMEASSISTANT_NODERED.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_IMAGES.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_IMMICH.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_JELLYFIN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_JITSI.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_KASM.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_KEILA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MAILU.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MASTODON.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MEALIE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_NCTALKHPB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_NCTALKRECORD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_NTFY.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PEERTUBE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PENPOT.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PIPED_PROXY.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PIPED_API.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PIXELFED.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_REMOTELY.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SHLINK_APP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_VAULTWARDEN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_WALLABAG.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_YAMTRACK.$HOMESERVER_DOMAIN\n"
  retval="${retval}# Authelia bypass END\n"
  retval="${retval}      policy: bypass\n"
  retval="${retval}    - domain:\n"
  retval="${retval}# Authelia $LDAP_BASIC_USER_GROUP_NAME BEGIN\n"
  retval="${retval}        - $SUB_DISCOURSE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PHOTOPRISM.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_INVIDIOUS.$HOMESERVER_DOMAIN\n"
  retval="${retval}# Authelia $LDAP_BASIC_USER_GROUP_NAME END\n"
  retval="${retval}      policy: one_factor\n"
  retval="${retval}      subject:\n"
  retval="${retval}        - \"group:$LDAP_BASIC_USER_GROUP_NAME\"\n"
  retval="${retval}    - domain:\n"
  retval="${retval}# Authelia ${LDAP_PRIMARY_USER_GROUP_NAME} BEGIN\n"
  retval="${retval}        - $SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_BARASSISTANT.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_HUGINN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_LINKWARDEN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GITLAB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PAPERLESS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PASTEFY.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SNIPPETBOX.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_STIRLINGPDF.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SEARXNG.$HOMESERVER_DOMAIN\n"
  retval="${retval}# Authelia ${LDAP_PRIMARY_USER_GROUP_NAME} END\n"
  retval="${retval}      policy: one_factor\n"
  retval="${retval}      subject:\n"
  retval="${retval}        - \"group:$LDAP_PRIMARY_USER_GROUP_NAME\"\n"
  retval="${retval}    - domain:\n"
  retval="${retval}# Authelia ${LDAP_ADMIN_USER_GROUP_NAME} BEGIN\n"
  retval="${retval}        - $SUB_ADGUARD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_CALIBRE_SERVER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - ${SUB_CLIENTDNS}-user1.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_CODESERVER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_DOZZLE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_DUPLICATI.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_FIREFLY_APP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GHOST.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GRAFANA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_GUACAMOLE.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_INFLUXDB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_ITTOOLS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_JUPYTER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_KASM_WIZARD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_MATOMO.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_NETDATA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PORTAINER.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_PROMETHEUS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_QBITTORRENT.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SABNZBD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_READARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SHLINK_WEB.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SQLPAD.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_SYNCTHING.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_WAZUH.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_WIKIJS.$HOMESERVER_DOMAIN\n"
  retval="${retval}        - $SUB_WORDPRESS.$HOMESERVER_DOMAIN\n"
  retval="${retval}# Authelia ${LDAP_ADMIN_USER_GROUP_NAME} END\n"
  retval="${retval}      policy: one_factor\n"
  retval="${retval}      subject:\n"
  retval="${retval}        - \"group:$LDAP_ADMIN_USER_GROUP_NAME\"\n"
  echo "$retval"
}

function emailVaultwardenCredentials()
{
  is_relay_only=$1
  strOutput="_________________________________________________________________________\n\n"
  strOutput=$strOutput"folder,favorite,type,name,notes,fields,reprompt,login_uri,login_username,login_password,login_totp\n"
  if ! [ "$is_relay_only" = "true" ]; then
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_PORTAINER" "\"https://$SUB_PORTAINER.$HOMESERVER_DOMAIN/#!/auth,https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT/#!/auth\"" $HOMESERVER_ABBREV $PORTAINER_ADMIN_USERNAME $PORTAINER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_ADGUARD" https://$SUB_ADGUARD.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV $ADGUARD_ADMIN_USERNAME $ADGUARD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_SCRIPTSERVER" "\"https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN/login.html,https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT/login.html\"" $HOMESERVER_ABBREV $SCRIPTSERVER_ADMIN_USERNAME $SCRIPTSERVER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_OPENLDAP_PHP" https://$SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV \"$LDAP_ADMIN_BIND_DN\" $LDAP_ADMIN_BIND_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_AUTHELIA" https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_WAZUH" https://$SUB_WAZUH.$HOMESERVER_DOMAIN/app/login $HOMESERVER_ABBREV $WAZUH_USERS_ADMIN_USERNAME $WAZUH_USERS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_GRAFANA" https://$SUB_GRAFANA.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $GRAFANA_ADMIN_USERNAME $GRAFANA_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_INFLUXDB" https://$SUB_INFLUXDB.$HOMESERVER_DOMAIN/signin $HOMESERVER_ABBREV $INFLUXDB_ADMIN_USERNAME $INFLUXDB_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_DOZZLE" https://$SUB_DOZZLE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $DOZZLE_USERNAME $DOZZLE_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_JELLYFIN}-Admin" "\"https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/login.html,https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/wizarduser.html\"" $HOMESERVER_ABBREV $JELLYFIN_ADMIN_USERNAME $JELLYFIN_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_JELLYFIN}-User" https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/login.html $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PHOTOPRISM}-Admin" https://$SUB_PHOTOPRISM.$HOMESERVER_DOMAIN/library/login $HOMESERVER_ABBREV $PHOTOPRISM_ADMIN_USERNAME $PHOTOPRISM_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_GUACAMOLE" https://$SUB_GUACAMOLE.$HOMESERVER_DOMAIN/guacamole/ $HOMESERVER_ABBREV $GUACAMOLE_DEFAULT_ADMIN_USERNAME $GUACAMOLE_DEFAULT_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_UPTIMEKUMA" https://$SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN/dashboard $HOMESERVER_ABBREV $UPTIMEKUMA_USERNAME $UPTIMEKUMA_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_SQLPAD" https://$SUB_SQLPAD.$HOMESERVER_DOMAIN/signin $HOMESERVER_ABBREV $SQLPAD_ADMIN_USERNAME $SQLPAD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_SYNCTHING" https://$SUB_SYNCTHING.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $SYNCTHING_ADMIN_USERNAME $SYNCTHING_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_CODESERVER" https://$SUB_CODESERVER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $CODESERVER_ADMIN_USERNAME $CODESERVER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_HOMEASSISTANT_TASMOADMIN" "\"https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN/tasmoadmin,https://$SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN/login\"" $HOMESERVER_ABBREV $HOMEASSISTANT_TASMOADMIN_USER $HOMEASSISTANT_TASMOADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_HOMEASSISTANT_CONFIGURATOR" "\"https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN/configurator,https://$SUB_HOMEASSISTANT_CONFIGURATOR.$HOMESERVER_DOMAIN/\"" $HOMESERVER_ABBREV $HOMEASSISTANT_CONFIGURATOR_USER $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HEIMDALL}-Admin" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_ADMIN_USERNAME $HEIMDALL_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HEIMDALL}-Users" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_USER_USERNAME $HEIMDALL_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HEIMDALL}-HomeServers" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_HOMESERVERS_USERNAME $HEIMDALL_HOMESERVERS_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HEIMDALL}-RelayServer" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_RELAYSERVER_USERNAME $HEIMDALL_RELAYSERVER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_GITEA}-Admin" https://$SUB_GITEA.$HOMESERVER_DOMAIN/user/login $HOMESERVER_ABBREV $GITEA_ADMIN_USERNAME $GITEA_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_GITEA}-User" https://$SUB_GITEA.$HOMESERVER_DOMAIN/user/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_GITLAB" https://$SUB_GITLAB.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_OPENLDAP_MANAGER" https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN/log_in/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MAILU}-Admin" https://$SUB_MAILU.$HOMESERVER_DOMAIN/sso/login $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $EMAIL_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_MATRIX_ELEMENT_PRIVATE" https://$SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN/#/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_MATRIX_ELEMENT_PUBLIC" https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN/#/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MEALIE}-Admin" https://$SUB_MEALIE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $MEALIE_ADMIN_USERNAME $MEALIE_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MEALIE}-User" https://$SUB_MEALIE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_REMOTELY" "\"https://$SUB_REMOTELY.$HOMESERVER_DOMAIN/Account/Register,https://$SUB_REMOTELY.$HOMESERVER_DOMAIN/Account/Login\"" $HOMESERVER_ABBREV $REMOTELY_ADMIN_EMAIL_ADDRESS $REMOTELY_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_DUPLICATI" https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV "NA" $DUPLICATI_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "$FMLNAME_FILEBROWSER" https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $FILEBROWSER_USERNAME $FILEBROWSER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MASTODON}-Admin" https://$SUB_MASTODON.$HOMESERVER_DOMAIN/auth/sign_in $HOMESERVER_ABBREV $MASTODON_ADMIN_EMAIL_ADDRESS $MASTODON_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MASTODON}-User" https://$SUB_MASTODON.$HOMESERVER_DOMAIN/auth/sign_in $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PEERTUBE}-Admin" https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $PEERTUBE_ADMIN_USERNAME $PEERTUBE_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PEERTUBE}-User" https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_COLLABORA}-Admin" https://$SUB_COLLABORA.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $COLLABORA_ADMIN_USERNAME $COLLABORA_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_NEXTCLOUD}-Admin" https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $NEXTCLOUD_ADMIN_USERNAME $NEXTCLOUD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_NEXTCLOUD}-User" https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_DISCOURSE}-Admin" https://$SUB_DISCOURSE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $DISCOURSE_ADMIN_USERNAME $DISCOURSE_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_VAULTWARDEN}-Admin" https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN/admin $HOMESERVER_ABBREV admin $VAULTWARDEN_ADMIN_TOKEN)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CALIBRE_WEB}-Admin" https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $CALIBRE_WEB_ADMIN_USERNAME $CALIBRE_WEB_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CALIBRE_WEB}-User" https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_FRESHRSS}-Admin" https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $FRESHRSS_ADMIN_USERNAME $FRESHRSS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_KEILA}-Admin" https://$SUB_KEILA.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $KEILA_ADMIN_EMAIL_ADDRESS $KEILA_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_WALLABAG}-Admin" https://$SUB_WALLABAG.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $WALLABAG_ADMIN_USERNAME $WALLABAG_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_JUPYTER}-Admin" https://$SUB_JUPYTER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV admin $JUPYTER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PAPERLESS}-Admin" https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN/accounts/login/ $HOMESERVER_ABBREV $PAPERLESS_ADMIN_USERNAME $PAPERLESS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SPEEDTEST_TRACKER_LOCAL}-Admin" https://$SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN/admin/login $HOMESERVER_ABBREV $SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SPEEDTEST_TRACKER_VPN}-Admin" https://$SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN/admin/login $HOMESERVER_ABBREV $SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CHANGEDETECTION}-Admin" https://$SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV admin $CHANGEDETECTION_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HUGINN}-Admin" https://$SUB_HUGINN.$HOMESERVER_DOMAIN/users/sign_in $HOMESERVER_ABBREV $HUGINN_ADMIN_USERNAME $HUGINN_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_GRAMPSWEB}-Admin" https://$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $GRAMPSWEB_ADMIN_USERNAME $GRAMPSWEB_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PENPOT}-User" https://$SUB_PENPOT.$HOMESERVER_DOMAIN/#/auth/login $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_ESPOCRM}-Admin" https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $ESPOCRM_ADMIN_USERNAME $ESPOCRM_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_IMMICH}-Admin" https://$SUB_IMMICH.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $IMMICH_ADMIN_EMAIL_ADDRESS $IMMICH_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_HOMARR}-Admin" https://$SUB_HOMARR.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $HOMARR_ADMIN_USERNAME $HOMARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_MATOMO}-Admin" https://$SUB_MATOMO.$HOMESERVER_DOMAIN/index.php $HOMESERVER_ABBREV $MATOMO_ADMIN_USERNAME $MATOMO_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PASTEFY}-Admin" https://$SUB_PASTEFY.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $PASTEFY_ADMIN_USERNAME $PASTEFY_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_AISTACK_MINDSDB_APP}-Admin" https://$SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $AISTACK_MINDSDB_ADMIN_USERNAME $AISTACK_MINDSDB_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_AISTACK_LANGFUSE}-Admin" https://$SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN/auth/sign-in $HOMESERVER_ABBREV $AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS $AISTACK_LANGFUSE_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_AISTACK_OPENWEBUI}-Admin" https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN/auth $HOMESERVER_ABBREV $AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS $AISTACK_OPENWEBUI_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PIXELFED}-Admin" "\"https://$SUB_PIXELFED.$HOMESERVER_DOMAIN/login,https://$SUB_PIXELFED.$HOMESERVER_DOMAIN/i/auth/sudo\"" $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $LDAP_ADMIN_USER_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_YAMTRACK}-Admin" https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN/accounts/login $HOMESERVER_ABBREV $YAMTRACK_ADMIN_USERNAME $YAMTRACK_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_SONARR}-Admin" https://$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $SONARR_ADMIN_USERNAME $SONARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_RADARR}-Admin" https://$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $RADARR_ADMIN_USERNAME $RADARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_LIDARR}-Admin" https://$SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LIDARR_ADMIN_USERNAME $LIDARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_READARR}-Admin" https://$SUB_SERVARR_READARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $READARR_ADMIN_USERNAME $READARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_BAZARR}-Admin" https://$SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $BAZARR_ADMIN_USERNAME $BAZARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_MYLAR3}-Admin" https://$SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $MYLAR3_ADMIN_USERNAME $MYLAR3_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SERVARR_PROWLARR}-Admin" https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $PROWLARR_ADMIN_USERNAME $PROWLARR_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SABNZBD}-Admin" https://$SUB_SABNZBD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $SABNZBD_ADMIN_USERNAME $SABNZBD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_QBITTORRENT}-Admin" https://$SUB_QBITTORRENT.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $QBITTORRENT_ADMIN_USERNAME $QBITTORRENT_ADMIN_PASSWORD)"\n"
  fi
  # RelayServer
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ] || [ "$is_relay_only" = "true" ]; then
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CLIENTDNS}-user1" https://${SUB_CLIENTDNS}-user1.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $CLIENTDNS_USER1_ADMIN_USERNAME $CLIENTDNS_USER1_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_ADGUARD}-RelayServer" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV $RELAYSERVER_ADGUARD_ADMIN_USERNAME $RELAYSERVER_ADGUARD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CLIENTDNS}-RelayServer" https://$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_CLIENTDNS_ADMIN_USERNAME $RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_PORTAINER}-RelayServer" https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/#!/auth $HOMESERVER_ABBREV $RELAYSERVER_PORTAINER_ADMIN_USERNAME $RELAYSERVER_PORTAINER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_RSPAMD}-RelayServer" https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_RSPAMD_ADMIN_USERNAME $RELAYSERVER_RSPAMD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_SYNCTHING}-RelayServer" https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_SYNCTHING_ADMIN_USERNAME $RELAYSERVER_SYNCTHING_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_FILEBROWSER}-RelayServer" https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_FILEBROWSER_ADMIN_USERNAME $RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_CADDYDNS}-RelayServer" https://$SUB_CADDYDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_CADDYDNS_ADMIN_USERNAME $RELAYSERVER_CADDYDNS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getSvcCredentialsVW "${FMLNAME_WGPORTAL}-RelayServer" https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $RELAYSERVER_WGPORTAL_ADMIN_EMAIL $RELAYSERVER_WGPORTAL_ADMIN_PASSWORD)"\n"
  fi
  strOutput=${strOutput}"\n\n\n\n"
  strInstructions="Vaultwarden Import Instructions - !!! READ ALL STEPS !!!\n_________________________________________________________________________\n\n"
  strInstructions=$strInstructions"1. Vaultwarden is only accessible on your private network, so any devices that you wish to access this service with must be correctly added. \n\n2. Upon installation, you should receive a seperate 'Join Vaultwarden' email from the Vaultwarden service. Click the provided 'Join Organization Now' button and create an account. \n\n3. After creating your account, log in through the same web interface. \n\n4. Select Tools on top of page, then Import Data on left side. For File format, select Bitwarden(csv) from the drop down.  Then copy all of the data AFTER the line below (including field headers) and paste it into the provided empty text box. Then click Import Data. \n\n5. Download and install Bitwarden plugin/extension for your browser (https://bitwarden.com/download/). \n\n6. In the browser plugin, select Self-hosted for Region. Then enter https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN in both Server URL and Web vault server URL fields, and Save. \n\n7. Log in with email and master password. Go to Settings (bottom right), then Auto-fill, then under Default URI match detection, select Starts with. (You can also check the Auto-fill on page load option, but ensure you know how it works and the risks)\n\n8. Delete this email (and empty it from Trash) once you have imported the passwords into Vaultwarden. There is an option within Script-server or the console UI to send yourself another copy if need be (01 Misc Utils -> 08 Email Vaultwarden Credentials).\n\n9. All of these passwords are randomly generated during install and stored in your configuration file, which is encrypted at rest (thus the need to enter your config decrypt password for nearly every operation). Nota Bene: If you change any of these generated passwords it will not sync back to this source. If you change the Portainer, AdguardHome, or WG Portal admin passwords without also changing them in the configuration file, then you will break any of the script functions that use these utilities (they use API calls that require authorization). There could also be consequences for a few others as well. For more information, ask on the forum (https://forum.homeserverhq.com). To view/edit the configuration file, run the console UI (enter 'bash hshq.sh' on your HomeServer), then go to System Utils -> 1 Edit Encrypted Config File. BE VERY CAREFUL editing anything in this config file, you could break things!!!\n\n10. After any operation that requires the config decrypt password, whether via the console UI or Script-server web interface, you should ALWAYS see a confirmation that the configuration file has been encrypted. If a script function terminates abnormally, ensure to re-run another simple function, for example (01 Misc Utils -> 09 Email Root CA) just to ensure the configuration file is back to an encrypted state."
  sendEmail -s "Vaultwarden Login Import !!! READ ALL STEPS !!!" -b "$strInstructions\n\n$strOutput" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -t $EMAIL_ADMIN_EMAIL_ADDRESS
}

function emailUserVaultwardenCredentials()
{
  vw_username=$1
  vw_email=$2
  strOutput="________________________________________________________________________\n\n"
  strOutput=$strOutput"folder,favorite,type,name,notes,fields,reprompt,login_uri,login_username,login_password,login_totp\n"
  strOutput=${strOutput}$(getSvcCredentialsVW "LDAP Services - Username" "\"https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/,https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN/login,https://$SUB_GITEA.$HOMESERVER_DOMAIN/user/login,https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/login.html,https://$SUB_MASTODON.$HOMESERVER_DOMAIN/auth/sign_in,https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN/#/login,https://$SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN/#/login,https://$SUB_MEALIE.$HOMESERVER_DOMAIN/login,https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/login,https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN/log_in/,https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN/login,https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN/\"" $HOMESERVER_ABBREV $vw_username abcdefg)"\n"
  strOutput=${strOutput}$(getSvcCredentialsVW "LDAP Services - Email" "\"https://$SUB_PENPOT.$HOMESERVER_DOMAIN/#/auth/login,https://$SUB_PIXELFED.$HOMESERVER_DOMAIN/login\"" $HOMESERVER_ABBREV ${vw_username}@$HOMESERVER_DOMAIN abcdefg)"\n"
  strOutput=${strOutput}$(getSvcCredentialsVW "Mailu-User" "https://$SUB_MAILU.$HOMESERVER_DOMAIN/sso/login" $HOMESERVER_ABBREV ${vw_username}@$HOMESERVER_DOMAIN abcdefg)"\n"
  strOutput=${strOutput}"\n\n"
  strInstructions="Vaultwarden User Import Instructions:\n\n"
  strInstructions=$strInstructions"For convenience, import the text BELOW the following solid line into Vaultwarden. Then simply change the password (abcdefg) to your correct password. It will be reflected for all LDAP-based services. If you change your password in the future, then you only need to update this one entry within the Vaultwarden password manager. An additional entry, Penpot has been added. It uses LDAP as well, but requires the email address to be entered rather than the ldap username, so it requires a separate entry."
  sendEmail -s "Vaultwarden User Login Import" -b "$strInstructions\n\n$strOutput" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -t $vw_email
}

function emailFormattedCredentials()
{
  strOutput=""
  strOutput=$strOutput"                        All Services Login Info                         "
  strOutput=$strOutput"========================================================================\n"
  strOutput=$strOutput"Be careful keeping this in your mailbox, it contains all of your Admin passwords in plain text! If you intend to install and use Vaultwarden, then you will receive an email once it is installed, and it will contain this information in a format that you can easily import into your vault. You can also resend yourself this email later from within Script-server, i.e. 01 Misc Utils -> 11 Email All Credentials\n\n\n\n"
  strOutput=$strOutput"Service Name, Username, Password, URL(s)\n"
  strOutput=$strOutput"________________________________________________________________________\n\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_PORTAINER" "\"https://$SUB_PORTAINER.$HOMESERVER_DOMAIN/#!/auth https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT/#!/auth\"" $HOMESERVER_ABBREV $PORTAINER_ADMIN_USERNAME $PORTAINER_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_ADGUARD" https://$SUB_ADGUARD.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV $ADGUARD_ADMIN_USERNAME $ADGUARD_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_SCRIPTSERVER" "\"https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN/login.html https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT/login.html\"" $HOMESERVER_ABBREV $SCRIPTSERVER_ADMIN_USERNAME $SCRIPTSERVER_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_OPENLDAP_PHP" https://$SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV \"$LDAP_ADMIN_BIND_DN\" $LDAP_ADMIN_BIND_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_AUTHELIA" https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_WAZUH" https://$SUB_WAZUH.$HOMESERVER_DOMAIN/app/login $HOMESERVER_ABBREV $WAZUH_USERS_ADMIN_USERNAME $WAZUH_USERS_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_GRAFANA" https://$SUB_GRAFANA.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $GRAFANA_ADMIN_USERNAME $GRAFANA_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_INFLUXDB" https://$SUB_INFLUXDB.$HOMESERVER_DOMAIN/signin $HOMESERVER_ABBREV $INFLUXDB_ADMIN_USERNAME $INFLUXDB_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_DOZZLE" https://$SUB_DOZZLE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $DOZZLE_USERNAME $DOZZLE_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_JELLYFIN}-Admin" https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/login.html $HOMESERVER_ABBREV $JELLYFIN_ADMIN_USERNAME $JELLYFIN_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_JELLYFIN}-User" https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN/web/#/login.html $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_GUACAMOLE" https://$SUB_GUACAMOLE.$HOMESERVER_DOMAIN/guacamole/ $HOMESERVER_ABBREV $GUACAMOLE_DEFAULT_ADMIN_USERNAME $GUACAMOLE_DEFAULT_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_UPTIMEKUMA" https://$SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN/dashboard $HOMESERVER_ABBREV $UPTIMEKUMA_USERNAME $UPTIMEKUMA_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_SQLPAD" https://$SUB_SQLPAD.$HOMESERVER_DOMAIN/signin $HOMESERVER_ABBREV $SQLPAD_ADMIN_USERNAME $SQLPAD_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_SYNCTHING" https://$SUB_SYNCTHING.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $SYNCTHING_ADMIN_USERNAME $SYNCTHING_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_CODESERVER" https://$SUB_CODESERVER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $CODESERVER_ADMIN_USERNAME $CODESERVER_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_HOMEASSISTANT_TASMOADMIN" https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN/tasmoadmin $HOMESERVER_ABBREV $HOMEASSISTANT_TASMOADMIN_USER $HOMEASSISTANT_TASMOADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_HOMEASSISTANT_CONFIGURATOR" https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN/configurator $HOMESERVER_ABBREV $HOMEASSISTANT_CONFIGURATOR_USER $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HEIMDALL}-Admin" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_ADMIN_USERNAME $HEIMDALL_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HEIMDALL}-Users" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_USER_USERNAME $HEIMDALL_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HEIMDALL}-HomeServers" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_HOMESERVERS_USERNAME $HEIMDALL_HOMESERVERS_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HEIMDALL}-RelayServer" https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $HEIMDALL_RELAYSERVER_USERNAME $HEIMDALL_RELAYSERVER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_GITEA}-Admin" https://$SUB_GITEA.$HOMESERVER_DOMAIN/user/login $HOMESERVER_ABBREV $GITEA_ADMIN_USERNAME $GITEA_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_GITEA}-User" https://$SUB_GITEA.$HOMESERVER_DOMAIN/user/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_GITLAB" https://$SUB_GITLAB.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_OPENLDAP_MANAGER" https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN/log_in/ $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MAILU}-Admin" https://$SUB_MAILU.$HOMESERVER_DOMAIN/sso/login $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $EMAIL_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_MATRIX_ELEMENT_PRIVATE" https://$SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN/#/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_MATRIX_ELEMENT_PUBLIC" https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN/#/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MEALIE}-Admin" https://$SUB_MEALIE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $MEALIE_ADMIN_USERNAME $MEALIE_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MEALIE}-User" https://$SUB_MEALIE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_REMOTELY" "\"https://$SUB_REMOTELY.$HOMESERVER_DOMAIN/Account/Register https://$SUB_REMOTELY.$HOMESERVER_DOMAIN/Account/Login\"" $HOMESERVER_ABBREV $REMOTELY_ADMIN_EMAIL_ADDRESS $REMOTELY_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_DUPLICATI" https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV "NA" $DUPLICATI_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "$FMLNAME_FILEBROWSER" https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $FILEBROWSER_USERNAME $FILEBROWSER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MASTODON}-Admin" https://$SUB_MASTODON.$HOMESERVER_DOMAIN/auth/sign_in $HOMESERVER_ABBREV $MASTODON_ADMIN_EMAIL_ADDRESS $MASTODON_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MASTODON}-User" https://$SUB_MASTODON.$HOMESERVER_DOMAIN/auth/sign_in $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PEERTUBE}-Admin" https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $PEERTUBE_ADMIN_USERNAME $PEERTUBE_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PEERTUBE}-User" https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_COLLABORA}-Admin" https://$SUB_COLLABORA.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $COLLABORA_ADMIN_USERNAME $COLLABORA_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_NEXTCLOUD}-Admin" https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $NEXTCLOUD_ADMIN_USERNAME $NEXTCLOUD_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_NEXTCLOUD}-User" https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_DISCOURSE}-Admin" https://$SUB_DISCOURSE.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $DISCOURSE_ADMIN_USERNAME $DISCOURSE_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_VAULTWARDEN}-Admin" https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN/admin $HOMESERVER_ABBREV admin $VAULTWARDEN_ADMIN_TOKEN)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CALIBRE_WEB}-Admin" https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $CALIBRE_WEB_ADMIN_USERNAME $CALIBRE_WEB_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CALIBRE_WEB}-User" https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LDAP_ADMIN_USER_USERNAME $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_FRESHRSS}-Admin" https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $FRESHRSS_ADMIN_USERNAME $FRESHRSS_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_KEILA}-Admin" https://$SUB_KEILA.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $KEILA_ADMIN_EMAIL_ADDRESS $KEILA_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_WALLABAG}-Admin" https://$SUB_WALLABAG.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $WALLABAG_ADMIN_USERNAME $WALLABAG_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_JUPYTER}-Admin" https://$SUB_JUPYTER.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV admin $JUPYTER_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PAPERLESS}-Admin" https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN/accounts/login/ $HOMESERVER_ABBREV $PAPERLESS_ADMIN_USERNAME $PAPERLESS_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SPEEDTEST_TRACKER_LOCAL}-Admin" https://$SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN/admin/login $HOMESERVER_ABBREV $SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SPEEDTEST_TRACKER_VPN}-Admin" https://$SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN/admin/login $HOMESERVER_ABBREV $SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS $SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CHANGEDETECTION}-Admin" https://$SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV admin $CHANGEDETECTION_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HUGINN}-Admin" https://$SUB_HUGINN.$HOMESERVER_DOMAIN/users/sign_in $HOMESERVER_ABBREV $HUGINN_ADMIN_USERNAME $HUGINN_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_GRAMPSWEB}-Admin" https://$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $GRAMPSWEB_ADMIN_USERNAME $GRAMPSWEB_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PENPOT}-User" https://$SUB_PENPOT.$HOMESERVER_DOMAIN/#/auth/login $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_ESPOCRM}-Admin" https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $ESPOCRM_ADMIN_USERNAME $ESPOCRM_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_IMMICH}-Admin" https://$SUB_IMMICH.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $IMMICH_ADMIN_USERNAME $IMMICH_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_HOMARR}-Admin" https://$SUB_HOMARR.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $HOMARR_ADMIN_USERNAME $HOMARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_MATOMO}-Admin" https://$SUB_MATOMO.$HOMESERVER_DOMAIN/index.php $HOMESERVER_ABBREV $MATOMO_ADMIN_USERNAME $MATOMO_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PASTEFY}-Admin" https://$SUB_PASTEFY.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $PASTEFY_ADMIN_USERNAME $PASTEFY_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_AISTACK_MINDSDB_APP}-Admin" https://$SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $AISTACK_MINDSDB_ADMIN_USERNAME $AISTACK_MINDSDB_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_AISTACK_LANGFUSE}-Admin" https://$SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS $AISTACK_LANGFUSE_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_AISTACK_OPENWEBUI}-Admin" https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS $AISTACK_OPENWEBUI_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PIXELFED}-Admin" "\"https://$SUB_PIXELFED.$HOMESERVER_DOMAIN/login https://$SUB_PIXELFED.$HOMESERVER_DOMAIN/i/auth/sudo\"" $HOMESERVER_ABBREV $EMAIL_ADMIN_EMAIL_ADDRESS $LDAP_ADMIN_USER_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_YAMTRACK}-Admin" https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN $HOMESERVER_ABBREV $YAMTRACK_ADMIN_USERNAME $YAMTRACK_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_SONARR}-Admin" https://$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $SONARR_ADMIN_USERNAME $SONARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_RADARR}-Admin" https://$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $RADARR_ADMIN_USERNAME $RADARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_LIDARR}-Admin" https://$SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $LIDARR_ADMIN_USERNAME $LIDARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_READARR}-Admin" https://$SUB_SERVARR_READARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $READARR_ADMIN_USERNAME $READARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_BAZARR}-Admin" https://$SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $BAZARR_ADMIN_USERNAME $BAZARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_MYLAR3}-Admin" https://$SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $MYLAR3_ADMIN_USERNAME $MYLAR3_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SERVARR_PROWLARR}-Admin" https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $PROWLARR_ADMIN_USERNAME $PROWLARR_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SABNZBD}-Admin" https://$SUB_SABNZBD.$HOMESERVER_DOMAIN/login $HOMESERVER_ABBREV $SABNZBD_ADMIN_USERNAME $SABNZBD_ADMIN_PASSWORD)"\n"
  strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_QBITTORRENT}-Admin" https://$SUB_QBITTORRENT.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $QBITTORRENT_ADMIN_USERNAME $QBITTORRENT_ADMIN_PASSWORD)"\n"
  # RelayServer
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CLIENTDNS}-user1" https://${SUB_CLIENTDNS}-user1.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $CLIENTDNS_USER1_ADMIN_USERNAME $CLIENTDNS_USER1_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_ADGUARD}-RelayServer" https://$SUB_ADGUARD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/login.html $HOMESERVER_ABBREV $RELAYSERVER_ADGUARD_ADMIN_USERNAME $RELAYSERVER_ADGUARD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CLIENTDNS}-RelayServer" https://$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_CLIENTDNS_ADMIN_USERNAME $RELAYSERVER_CLIENTDNS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_PORTAINER}-RelayServer" https://$SUB_PORTAINER.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/#!/auth $HOMESERVER_ABBREV $RELAYSERVER_PORTAINER_ADMIN_USERNAME $RELAYSERVER_PORTAINER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_RSPAMD}-RelayServer" https://$SUB_RSPAMD.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_RSPAMD_ADMIN_USERNAME $RELAYSERVER_RSPAMD_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_SYNCTHING}-RelayServer" https://$SUB_SYNCTHING.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_SYNCTHING_ADMIN_USERNAME $RELAYSERVER_SYNCTHING_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_FILEBROWSER}-RelayServer" https://$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_FILEBROWSER_ADMIN_USERNAME $RELAYSERVER_FILEBROWSER_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_CADDYDNS}-RelayServer" https://$SUB_CADDYDNS.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/ $HOMESERVER_ABBREV $RELAYSERVER_CADDYDNS_ADMIN_USERNAME $RELAYSERVER_CADDYDNS_ADMIN_PASSWORD)"\n"
    strOutput=${strOutput}$(getFmtCredentials "${FMLNAME_WGPORTAL}-RelayServer" https://$SUB_WGPORTAL.$INT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN/auth/login $HOMESERVER_ABBREV $RELAYSERVER_WGPORTAL_ADMIN_EMAIL $RELAYSERVER_WGPORTAL_ADMIN_PASSWORD)"\n"
  fi
  strOutput=${strOutput}"\n\n"
  sendEmail -s "All Services Login Info" -b "$strOutput" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>" -t $EMAIL_ADMIN_EMAIL_ADDRESS
}

function insertServicesHeimdall()
{
  curdt=$(getCurrentDate)
  cur_id=1
  # Admin Tab
  insertIntoHeimdallDB "$FMLNAME_SCRIPTSERVER" $USERTYPE_SCRIPTSERVER "https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN" 1 "script-server.png" "$(getHeimdallOrderFromSub $SUB_SCRIPTSERVER $USERTYPE_SCRIPTSERVER)"
  insertIntoHeimdallDB "$FMLNAME_SCRIPTSERVER (IP)" $USERTYPE_SCRIPTSERVER "https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT" 1 "script-server.png" "$(getHeimdallOrderFromSub $SUB_SCRIPTSERVER $USERTYPE_SCRIPTSERVER)"
  insertIntoHeimdallDB "$FMLNAME_PORTAINER" $USERTYPE_PORTAINER "https://$SUB_PORTAINER.$HOMESERVER_DOMAIN" 1 "portainer.png" "$(getHeimdallOrderFromSub $SUB_PORTAINER $USERTYPE_PORTAINER)"
  insertIntoHeimdallDB "$FMLNAME_PORTAINER (IP)" $USERTYPE_PORTAINER "https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$PORTAINER_LOCAL_HTTPS_PORT" 1 "portainer.png" "$(getHeimdallOrderFromSub $SUB_PORTAINER $USERTYPE_PORTAINER)"
  insertIntoHeimdallDB "$FMLNAME_ADGUARD" $USERTYPE_ADGUARD "https://$SUB_ADGUARD.$HOMESERVER_DOMAIN" 1 "adguardhome.png" "$(getHeimdallOrderFromSub $SUB_ADGUARD $USERTYPE_ADGUARD)"
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    insertIntoHeimdallDB "${FMLNAME_CLIENTDNS}-user1" $USERTYPE_CLIENTDNS "https://${SUB_CLIENTDNS}-user1.$HOMESERVER_DOMAIN" 1 "dnsmasq.png" "$(getHeimdallOrderFromSub $SUB_CLIENTDNS $USERTYPE_CLIENTDNS)"
  fi
  insertIntoHeimdallDB "$FMLNAME_OPENLDAP_PHP" $USERTYPE_OPENLDAP_PHP "https://$SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN" 1 "ldapphp.png" "$(getHeimdallOrderFromSub $SUB_OPENLDAP_PHP $USERTYPE_OPENLDAP_PHP)"
  insertIntoHeimdallDB "$FMLNAME_UPTIMEKUMA" $USERTYPE_UPTIMEKUMA "https://$SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN" 1 "uptimekuma.png" "$(getHeimdallOrderFromSub $SUB_UPTIMEKUMA $USERTYPE_UPTIMEKUMA)"
  insertIntoHeimdallDB "$FMLNAME_DUPLICATI" $USERTYPE_DUPLICATI "https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN" 1 "duplicati.png" "$(getHeimdallOrderFromSub $SUB_DUPLICATI $USERTYPE_DUPLICATI)"
  insertIntoHeimdallDB "$FMLNAME_SYNCTHING" $USERTYPE_SYNCTHING "https://$SUB_SYNCTHING.$HOMESERVER_DOMAIN" 1 "syncthing.png" "$(getHeimdallOrderFromSub $SUB_SYNCTHING $USERTYPE_SYNCTHING)"
  insertIntoHeimdallDB "Logout $FMLNAME_AUTHELIA" admin "https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/logout" 1 "authelia.png" "$(getHeimdallOrderFromSub $SUB_AUTHELIA admin)"
  # Users Tab
  insertIntoHeimdallDB "HomeServerHQ" $USERTYPE_AUTHELIA "https://www.homeserverhq.com" 1 "homeserverhq.png" "1"
  insertIntoHeimdallDB "$FMLNAME_OPENLDAP_MANAGER" $USERTYPE_OPENLDAP_MANAGER "https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN" 1 "ldapmanager.png" "$(getHeimdallOrderFromSub $SUB_OPENLDAP_MANAGER $USERTYPE_OPENLDAP_MANAGER)"
  insertIntoHeimdallDB "$FMLNAME_MAILU" $USERTYPE_MAILU "https://$SUB_MAILU.$HOMESERVER_DOMAIN" 1 "mailu.png" "$(getHeimdallOrderFromSub $SUB_MAILU $USERTYPE_MAILU)"
  insertIntoHeimdallDB "Logout $FMLNAME_AUTHELIA" $USERTYPE_AUTHELIA "https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/logout" 1 "authelia.png" "$(getHeimdallOrderFromSub $SUB_AUTHELIA $USERTYPE_AUTHELIA)"
  # HomeServers Tab
  insertIntoHeimdallDB "$HOMESERVER_NAME" homeservers "https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN" 1 "hs1.png" "$(getHeimdallOrderFromSub $SUB_HSHQHOME homeservers)"
}

function insertServicesUptimeKuma()
{
  curdt=$(getCurrentDate)
  insertServiceUptimeKuma "$FMLNAME_AUTHELIA" $USERTYPE_AUTHELIA "https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_PORTAINER" $USERTYPE_PORTAINER "https://$SUB_PORTAINER.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_ADGUARD" $USERTYPE_ADGUARD "https://$SUB_ADGUARD.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_OPENLDAP_MANAGER" $USERTYPE_OPENLDAP_MANAGER "https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_OPENLDAP_PHP" $USERTYPE_OPENLDAP_PHP "https://$SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_MAILU" $USERTYPE_MAILU "https://$SUB_MAILU.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_SCRIPTSERVER" $USERTYPE_SCRIPTSERVER "https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_HEIMDALL" $USERTYPE_HEIMDALL "https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_DUPLICATI" $USERTYPE_DUPLICATI "https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$FMLNAME_SYNCTHING" $USERTYPE_SYNCTHING "https://$SUB_SYNCTHING.$HOMESERVER_DOMAIN" 1
  insertServiceUptimeKuma "$HOMESERVER_NAME" homeservers "https://$SUB_HSHQSTATUS.$HOMESERVER_DOMAIN" 1
}

function getHeimdallOrderFromSub()
{
  ord_subdom="$1"
  ord_usertype="$2"
  order_num=999
  order_uid=$(getHeimdallUserIDFromType $ord_usertype)
  case "$ord_subdom" in
    "$SUB_ADGUARD")
      order_num=4
      ;;
    "$SUB_ADGUARD.$INT_DOMAIN_PREFIX")
      order_num=100
      ;;
    "$SUB_AISTACK_LANGFUSE")
      order_num=35
      ;;
    "$SUB_AISTACK_MINDSDB_APP")
      order_num=34
      ;;
    "$SUB_AISTACK_OPENWEBUI")
      order_num=81
      ;;
    "$SUB_AUTHELIA")
      order_num=1001
      ;;
    "$SUB_BARASSISTANT")
      order_num=61
      ;;
    "$SUB_CADDYDNS.$INT_DOMAIN_PREFIX")
      order_num=105
      ;;
    "$SUB_CALIBRE_SERVER")
      order_num=28
      ;;
    "$SUB_CALIBRE_WEB")
      order_num=63
      ;;
    "$SUB_CHANGEDETECTION")
      order_num=70
      ;;
    "$SUB_CLIENTDNS")
      order_num=5
      ;;
    "$SUB_CLIENTDNS.$INT_DOMAIN_PREFIX")
      order_num=101
      ;;
    "$SUB_CODESERVER")
      order_num=16
      ;;
    "$SUB_COLLABORA")
      order_num=24
      ;;
    "$SUB_DISCOURSE")
      order_num=55
      ;;
    "$SUB_DOZZLE")
      order_num=11
      ;;
    "$SUB_DRAWIO_WEB")
      order_num=59
      ;;
    "$SUB_DUPLICATI")
      order_num=14
      ;;
    "$SUB_ESPOCRM")
      order_num=76
      ;;
    "$SUB_EXAMPLESERVICE")
      order_num=999
      ;;
    "$SUB_EXCALIDRAW_WEB")
      order_num=58
      ;;
    "$SUB_FILEBROWSER")
      order_num=52
      ;;
    "$SUB_FILEBROWSER.$EXT_DOMAIN_PREFIX")
      order_num=107
      ;;
    "$SUB_FILEDROP")
      order_num=72
      ;;
    "$SUB_FIREFLY_APP")
      order_num=20
      ;;
    "$SUB_FIREFLY_IMPORTER")
      order_num=21
      ;;
    "$SUB_FRESHRSS")
      order_num=66
      ;;
    "$SUB_GHOST")
      order_num=50
      ;;
    "$SUB_GITEA")
      order_num=56
      ;;
    "$SUB_GITLAB")
      order_num=53
      ;;
    "$SUB_GRAFANA")
      order_num=8
      ;;
    "$SUB_GRAMPSWEB")
      order_num=74
      ;;
    "$SUB_GUACAMOLE")
      order_num=12
      ;;
    "$SUB_HOMARR")
      order_num=78
      ;;
    "$SUB_HOMEASSISTANT_APP")
      order_num=18
      ;;
    "$SUB_HSHQHOME")
      order_num=85
      ;;
    "$SUB_HUGINN")
      order_num=71
      ;;
    "$SUB_IMMICH")
      order_num=77
      ;;
    "$SUB_INFLUXDB")
      order_num=10
      ;;
    "$SUB_INVIDIOUS")
      order_num=57
      ;;
    "$SUB_ITTOOLS")
      order_num=26
      ;;
    "$SUB_JELLYFIN")
      order_num=51
      ;;
    "$SUB_JITSI")
      order_num=41
      ;;
    "$SUB_JUPYTER")
      order_num=30
      ;;
    "$SUB_KASM")
      order_num=62
      ;;
    "$SUB_KASM_WIZARD")
      order_num=22
      ;;
    "$SUB_KEILA")
      order_num=67
      ;;
    "$SUB_LINKWARDEN")
      order_num=64
      ;;
    "$SUB_MAILU")
      order_num=39
      ;;
    "$SUB_MASTODON")
      order_num=44
      ;;
    "$SUB_MATOMO")
      order_num=33
      ;;
    "$SUB_MATRIX_ELEMENT_PRIVATE")
      order_num=42
      ;;
    "$SUB_MATRIX_ELEMENT_PUBLIC")
      order_num=43
      ;;
    "$SUB_MEALIE")
      order_num=60
      ;;
    "$SUB_NETDATA")
      order_num=29
      ;;
    "$SUB_NEXTCLOUD")
      order_num=40
      ;;
    "$SUB_NTFY")
      order_num=25
      ;;
    "$SUB_OPENLDAP_MANAGER")
      order_num=38
      ;;
    "$SUB_OPENLDAP_PHP")
      order_num=6
      ;;
    "$SUB_PAPERLESS")
      order_num=69
      ;;
    "$SUB_PASTEFY")
      order_num=79
      ;;
    "$SUB_PEERTUBE")
      order_num=45
      ;;
    "$SUB_PENPOT")
      order_num=75
      ;;
    "$SUB_PHOTOPRISM")
      order_num=47
      ;;
    "$SUB_PIPED_FRONTEND")
      order_num=73
      ;;
    "$SUB_PIXELFED")
      order_num=82
      ;;
    "$SUB_PORTAINER")
      order_num=3
      ;;
    "$SUB_PORTAINER.$INT_DOMAIN_PREFIX")
      order_num=102
      ;;
    "$SUB_PROMETHEUS")
      order_num=9
      ;;
    "$SUB_REMOTELY")
      order_num=27
      ;;
    "$SUB_RSPAMD.$INT_DOMAIN_PREFIX")
      order_num=103
      ;;
    "$SUB_SCRIPTSERVER")
      order_num=1
      ;;
    "$SUB_SEARXNG")
      order_num=46
      ;;
    "$SUB_SHLINK_WEB")
      order_num=19
      ;;
    "$SUB_SNIPPETBOX")
      order_num=80
      ;;
    "$SUB_SPEEDTEST_TRACKER_LOCAL")
      order_num=31
      ;;
    "$SUB_SPEEDTEST_TRACKER_VPN")
      order_num=32
      ;;
    "$SUB_SQLPAD")
      order_num=17
      ;;
    "$SUB_STIRLINGPDF")
      order_num=65
      ;;
    "$SUB_SYNCTHING")
      order_num=15
      ;;
    "$SUB_SYNCTHING.$INT_DOMAIN_PREFIX")
      order_num=104
      ;;
    "$SUB_UPTIMEKUMA")
      order_num=13
      ;;
    "$SUB_VAULTWARDEN")
      if [ "$order_uid" = "1" ]; then
        order_num=23
      elif [ "$order_uid" = "2" ]; then
        order_num=54
      fi
      ;;
    "$SUB_WALLABAG")
      order_num=68
      ;;
    "$SUB_WAZUH")
      order_num=7
      ;;
    "$SUB_WGPORTAL.$INT_DOMAIN_PREFIX")
      order_num=106
      ;;
    "$SUB_WIKIJS")
      order_num=48
      ;;
    "$SUB_WORDPRESS")
      order_num=49
      ;;
    "$SUB_YAMTRACK")
      order_num=83
      ;;
    "$SUB_SERVARR_SONARR")
      order_num=84
      ;;
    "$SUB_SERVARR_RADARR")
      order_num=85
      ;;
    "$SUB_SERVARR_LIDARR")
      order_num=86
      ;;
    "$SUB_SERVARR_READARR")
      order_num=87
      ;;
    "$SUB_SERVARR_BAZARR")
      order_num=88
      ;;
    "$SUB_SERVARR_MYLAR3")
      order_num=89
      ;;
    "$SUB_SERVARR_PROWLARR")
      order_num=90
      ;;
    "$SUB_SABNZBD")
      order_num=91
      ;;
    "$SUB_QBITTORRENT")
      order_num=92
      ;;
    *)
      ;;
  esac
  echo "$order_num"
}

function getLetsEncryptCertsDefault()
{
  echo "$SUB_JITSI.$HOMESERVER_DOMAIN,$SUB_MASTODON.$HOMESERVER_DOMAIN,$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN,$SUB_JELLYFIN.$HOMESERVER_DOMAIN,$SUB_GITEA.$HOMESERVER_DOMAIN,$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN,$SUB_FRESHRSS.$HOMESERVER_DOMAIN,$SUB_WALLABAG.$HOMESERVER_DOMAIN,$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN,$SUB_IMMICH.$HOMESERVER_DOMAIN"
}

function initServiceDefaults()
{
  HSHQ_REQUIRED_STACKS="adguard,authelia,duplicati,heimdall,mailu,openldap,portainer,syncthing,ofelia,uptimekuma"
  HSHQ_OPTIONAL_STACKS="vaultwarden,sysutils,wazuh,jitsi,collabora,nextcloud,matrix,mastodon,dozzle,searxng,jellyfin,filebrowser,photoprism,guacamole,codeserver,ghost,wikijs,wordpress,peertube,homeassistant,gitlab,discourse,shlink,firefly,excalidraw,drawio,invidious,gitea,mealie,kasm,ntfy,ittools,remotely,calibre,netdata,linkwarden,stirlingpdf,bar-assistant,freshrss,keila,wallabag,jupyter,paperless,speedtest-tracker-local,speedtest-tracker-vpn,changedetection,huginn,coturn,filedrop,piped,grampsweb,penpot,espocrm,immich,homarr,matomo,pastefy,snippetbox,aistack,pixelfed,yamtrack,servarr,sabnzbd,qbittorrent,sqlpad"
  DS_MEM_LOW=minimal
  DS_MEM_12=gitlab,discouse,netdata,jupyter,paperless,speedtest-tracker-local,speedtest-tracker-vpn,huginn,grampsweb,drawio,firefly,shlink,homeassistant,wordpress,ghost,wikijs,guacamole,searxng,excalidraw,invidious,jitsi,jellyfin,peertube,photoprism,sysutils,wazuh,mealie,kasm,bar-assistant,calibre,linkwarden,stirlingpdf,freshrss,keila,wallabag,changedetection,piped,penpot,espocrm,immich,homarr,matomo,pastefy,aistack,pixelfed,yamtrack,servarr,sabnzbd,qbittorrent
  DS_MEM_16=gitlab,discourse,netdata,jupyter,paperless,speedtest-tracker-local,speedtest-tracker-vpn,huginn,grampsweb,drawio,firefly,shlink,homeassistant,wordpress,ghost,wikijs,guacamole,searxng,excalidraw,invidious,photoprism,mealie,kasm,bar-assistant,calibre,linkwarden,stirlingpdf,freshrss,keila,wallabag,changedetection,piped,penpot,espocrm,immich,homarr,matomo,pastefy,aistack,pixelfed,yamtrack,servarr,sabnzbd,qbittorrent
  DS_MEM_22=gitlab,discourse,netdata,jupyter,paperless,speedtest-tracker-local,speedtest-tracker-vpn,huginn,grampsweb,drawio,firefly,shlink,wordpress,ghost,wikijs,guacamole,searxng,photoprism,kasm,calibre,stirlingpdf,keila,piped,penpot,espocrm,matomo,pastefy,aistack,pixelfed,yamtrack,servarr,sabnzbd,qbittorrent
  DS_MEM_28=gitlab,discourse,netdata,jupyter,huginn,grampsweb,drawio,photoprism,kasm,penpot,aistack,servarr,sabnzbd,qbittorrent
  DS_MEM_HIGH=netdata,photoprism,aistack,servarr,sabnzbd,qbittorrent
}

function getScriptImageByContainerName()
{
  case "$1" in
    "portainer")
      container_image=$IMG_PORTAINER
      ;;
    "adguard")
      container_image=$IMG_ADGUARD
      ;;
    "grafana")
      container_image=$IMG_GRAFANA
      ;;
    "prometheus")
      container_image=$IMG_PROMETHEUS
      ;;
    "node-exporter")
      container_image=$IMG_NODE_EXPORTER
      ;;
    "influxdb")
      container_image=$IMG_INFLUXDB
      ;;
    "ldapserver")
      container_image=$IMG_OPENLDAP_SERVER
      ;;
    "ldapphp")
      container_image=$IMG_OPENLDAP_PHP
      ;;
    "ldapmanager")
      container_image=$IMG_OPENLDAP_MANAGER
      ;;
    "$SMTP_HOSTNAME")
      container_image=$IMG_MAILU_FRONT
      ;;
    "mailu-unbound")
      container_image=$IMG_MAILU_UNBOUND
      ;;
    "mailu-redis")
      container_image=$IMG_REDIS
      ;;
    "mailu-admin")
      container_image=$IMG_MAILU_ADMIN
      ;;
    "mailu-imap")
      container_image=$IMG_MAILU_IMAP
      ;;
    "mailu-smtp")
      container_image=$IMG_MAILU_SMTP
      ;;
    "mailu-oletools")
      container_image=$IMG_MAILU_OLETOOLS
      ;;
    "mailu-tika")
      container_image=$IMG_MAILU_TIKA
      ;;
    "mailu-antispam")
      container_image=$IMG_MAILU_ANTISPAM
      ;;
    "mailu-antivirus")
      container_image=$IMG_MAILU_ANTIVIRUS
      ;;
    "mailu-webdav")
      container_image=$IMG_MAILU_WEBDAV
      ;;
    "mailu-fetchmail")
      container_image=$IMG_MAILU_FETCHMAIL
      ;;
    "mailu-webmail")
      container_image=$IMG_MAILU_WEBMAIL
      ;;
    "wazuh.manager")
      container_image=$IMG_WAZUH_MANAGER
      ;;
    "wazuh.indexer")
      container_image=$IMG_WAZUH_INDEXER
      ;;
    "wazuh.dashboard")
      container_image=$IMG_WAZUH_DASHBOARD
      ;;
    "collabora")
      container_image=$IMG_COLLABORA
      ;;
    "nextcloud-db")
      container_image=$IMG_POSTGRES
      ;;
    "nextcloud-redis")
      container_image=$IMG_REDIS
      ;;
    "nextcloud-app")
      container_image=$IMG_NEXTCLOUD_APP
      ;;
    "nextcloud-cron")
      container_image=$IMG_NEXTCLOUD_APP
      ;;
    "nextcloud-push")
      container_image=$IMG_NEXTCLOUD_APP
      ;;
    "nextcloud-imaginary")
      container_image=$IMG_NEXTCLOUD_IMAGINARY
      ;;
    "nextcloud-web")
      container_image=$IMG_NGINX
      ;;
    "nextcloud-talkhpb")
      container_image=$IMG_NEXTCLOUD_TALKHPB
      ;;
    "nextcloud-talkrecord")
      container_image=$IMG_NEXTCLOUD_TALKRECORD
      ;;
    "jitsi-web")
      container_image=$IMG_JITSI_WEB
      ;;
    "jitsi-prosody")
      container_image=$IMG_JITSI_PROSODY
      ;;
    "jitsi-jicofo")
      container_image=$IMG_JITSI_JICOFO
      ;;
    "jitsi-jvb")
      container_image=$IMG_JITSI_JVB
      ;;
    "matrix-db")
      container_image=$IMG_POSTGRES
      ;;
    "matrix-synapse")
      container_image=$IMG_MATRIX_SYNAPSE
      ;;
    "matrix-redis")
      container_image=$IMG_REDIS
      ;;
    "matrix-element-private")
      container_image=$IMG_MATRIX_ELEMENT
      ;;
    "matrix-element-public")
      container_image=$IMG_MATRIX_ELEMENT
      ;;
    "wikijs-db")
      container_image=$IMG_POSTGRES
      ;;
    "wikijs-web")
      container_image=$IMG_WIKIJS
      ;;
    "duplicati")
      container_image=$IMG_DUPLICATI
      ;;
    "mastodon-db")
      container_image=$IMG_POSTGRES
      ;;
    "mastodon-redis")
      container_image=$IMG_REDIS
      ;;
    "mastodon-redis-cache")
      container_image=$IMG_REDIS
      ;;
    "mastodon-app")
      container_image=$IMG_MASTODON_APP
      ;;
    "mastodon-streaming")
      container_image=$IMG_MASTODON_STREAMING
      ;;
    "mastodon-sidekiq")
      container_image=$IMG_MASTODON_APP
      ;;
    "mastodon-web")
      container_image=$IMG_NGINX
      ;;
    "mastodon-elasticsearch")
      container_image=$IMG_MASTODON_ELASTICSEARCH
      ;;
    "dozzle")
      container_image=$IMG_DOZZLE
      ;;
    "searxng-caddy")
      container_image=$IMG_CADDY
      ;;
    "searxng-app")
      container_image=$IMG_SEARXNG
      ;;
    "searxng-redis")
      container_image=$IMG_REDIS
      ;;
    "jellyfin")
      container_image=$IMG_JELLYFIN
      ;;
    "filebrowser")
      container_image=$IMG_FILEBROWSER
      ;;
    "photoprism-db")
      container_image=$IMG_MYSQL
      ;;
    "photoprism-app")
      container_image=$IMG_PHOTOPRISM_APP
      ;;
    "guacamole-db")
      container_image=$IMG_MYSQL
      ;;
    "guacamole-daemon")
      container_image=$IMG_GUACAMOLE_GUACD
      ;;
    "guacamole-web")
      container_image=$IMG_GUACAMOLE_WEB
      ;;
    "authelia")
      container_image=$IMG_AUTHELIA
      ;;
    "authelia-redis")
      container_image=$IMG_REDIS
      ;;
    "wordpress-db")
      container_image=$IMG_MYSQL
      ;;
    "wordpress-web")
      container_image=$IMG_WORDPRESS
      ;;
    "ghost-db")
      container_image=$IMG_MYSQL
      ;;
    "ghost-web")
      container_image=$IMG_GHOST
      ;;
    "peertube-db")
      container_image=$IMG_POSTGRES
      ;;
    "peertube-app")
      container_image=$IMG_PEERTUBE_APP
      ;;
    "peertube-redis")
      container_image=$IMG_REDIS
      ;;
    "homeassistant-db")
      container_image=$IMG_POSTGRES
      ;;
    "homeassistant-app")
      container_image=$IMG_HOMEASSISTANT_APP
      ;;
    "homeassistant-nodered")
      container_image=$IMG_HOMEASSISTANT_NODERED
      ;;
    "homeassistant-configurator")
      container_image=$IMG_HOMEASSISTANT_CONFIGURATOR
      ;;
    "homeassistant-tasmoadmin")
      container_image=$IMG_HOMEASSISTANT_TASMOADMIN
      ;;
    "gitlab-db")
      container_image=$IMG_POSTGRES
      ;;
    "gitlab-app")
      container_image=$IMG_GITLAB_APP
      ;;
    "gitlab-redis")
      container_image=$IMG_REDIS
      ;;
    "vaultwarden-db")
      container_image=$IMG_POSTGRES
      ;;
    "vaultwarden-app")
      container_image=$IMG_VAULTWARDEN_APP
      ;;
    "vaultwarden-ldap")
      container_image=$IMG_VAULTWARDEN_LDAP
      ;;
    "discourse-db")
      container_image=$IMG_POSTGRES
      ;;
    "discourse-app")
      container_image=$IMG_DISCOURSE
      ;;
    "discourse-sidekiq")
      container_image=$IMG_DISCOURSE
      ;;
    "discourse-redis")
      container_image=$IMG_REDIS
      ;;
    "syncthing")
      container_image=$IMG_SYNCTHING
      ;;
    "codeserver")
      container_image=$IMG_CODESERVER
      ;;
    "shlink-db")
      container_image=$IMG_POSTGRES
      ;;
    "shlink-app")
      container_image=$IMG_SHLINK_APP
      ;;
    "shlink-web")
      container_image=$IMG_SHLINK_WEB
      ;;
    "shlink-redis")
      container_image=$IMG_REDIS
      ;;
    "firefly-db")
      container_image=$IMG_POSTGRES
      ;;
    "firefly-app")
      container_image=$IMG_FIREFLY_APP
      ;;
    "firefly-importer")
      container_image=$IMG_FIREFLY_IMPORTER
      ;;
    "firefly-cron")
      container_image=$IMG_FIREFLY_CRON
      ;;
    "firefly-redis")
      container_image=$IMG_REDIS
      ;;
    "excalidraw-storage")
      container_image=$IMG_EXCALIDRAW_STORAGE
      ;;
    "excalidraw-server")
      container_image=$IMG_EXCALIDRAW_SERVER
      ;;
    "excalidraw-web")
      container_image=$IMG_EXCALIDRAW_WEB
      ;;
    "excalidraw-redis")
      container_image=$IMG_REDIS
      ;;
    "drawio-plantuml")
      container_image=$IMG_DRAWIO_PLANTUML
      ;;
    "drawio-export")
      container_image=$IMG_DRAWIO_EXPORT
      ;;
    "drawio-web")
      container_image=$IMG_DRAWIO_WEB
      ;;
    "invidious-db")
      container_image=$IMG_POSTGRES
      ;;
    "invidious-web")
      container_image=$IMG_INVIDIOUS_WEB
      ;;
    "invidious-companion")
      container_image=$IMG_INVIDIOUS_COMPANION
      ;;
    "gitea-db")
      container_image=$IMG_POSTGRES
      ;;
    "gitea-app")
      container_image=$IMG_GITEA_APP
      ;;
    "mealie-db")
      container_image=$IMG_POSTGRES
      ;;
    "mealie-app")
      container_image=$IMG_MEALIE
      ;;
    "kasm")
      container_image=$IMG_KASM
      ;;
    "ntfy")
      container_image=$IMG_NTFY
      ;;
    "ittools")
      container_image=$IMG_ITTOOLS
      ;;
    "remotely")
      container_image=$IMG_REMOTELY
      ;;
    "calibre-server")
      container_image=$IMG_CALIBRE_SERVER
      ;;
    "calibre-web")
      container_image=$IMG_CALIBRE_WEB
      ;;
    "netdata")
      container_image=$IMG_NETDATA
      ;;
    "linkwarden-db")
      container_image=$IMG_POSTGRES
      ;;
    "linkwarden-app")
      container_image=$IMG_LINKWARDEN
      ;;
    "stirlingpdf")
      container_image=$IMG_STIRLINGPDF
      ;;
    "bar-assistant-app")
      container_image=$IMG_BARASSISTANT_APP
      ;;
    "bar-assistant-meilisearch")
      container_image=$IMG_MEILISEARCH
      ;;
    "bar-assistant-redis")
      container_image=$IMG_REDIS
      ;;
    "bar-assistant-saltrim")
      container_image=$IMG_BARASSISTANT_SALTRIM
      ;;
    "bar-assistant-web")
      container_image=$IMG_NGINX
      ;;
    "freshrss-db")
      container_image=$IMG_POSTGRES
      ;;
    "freshrss-app")
      container_image=$IMG_FRESHRSS
      ;;
    "keila-db")
      container_image=$IMG_POSTGRES
      ;;
    "keila-app")
      container_image=$IMG_KEILA
      ;;
    "wallabag-db")
      container_image=$IMG_POSTGRES
      ;;
    "wallabag-redis")
      container_image=$IMG_REDIS
      ;;
    "wallabag-app")
      container_image=$IMG_WALLABAG
      ;;
    "jupyter")
      container_image=$IMG_JUPYTER
      ;;
    "paperless-db")
      container_image=$IMG_POSTGRES
      ;;
    "paperless-redis")
      container_image=$IMG_REDIS
      ;;
    "paperless-app")
      container_image=$IMG_PAPERLESS_APP
      ;;
    "paperless-gotenberg")
      container_image=$IMG_PAPERLESS_GOTENBERG
      ;;
    "paperless-tika")
      container_image=$IMG_PAPERLESS_TIKA
      ;;
    "speedtest-tracker-local-db")
      container_image=$IMG_POSTGRES
      ;;
    "speedtest-tracker-local-app")
      container_image=$IMG_SPEEDTEST_TRACKER_APP
      ;;
    "speedtest-tracker-vpn-db")
      container_image=$IMG_POSTGRES
      ;;
    "speedtest-tracker-vpn-app")
      container_image=$IMG_SPEEDTEST_TRACKER_APP
      ;;
    "changedetection-app")
      container_image=$IMG_CHANGEDETECTION_APP
      ;;
    "changedetection-playwright-chrome")
      container_image=$IMG_CHANGEDETECTION_PLAYWRIGHT_CHROME
      ;;
    "huginn-db")
      container_image=$IMG_POSTGRES
      ;;
    "huginn-app")
      container_image=$IMG_HUGINN_APP
      ;;
    "coturn")
      container_image=$IMG_COTURN
      ;;
    "filedrop")
      container_image=$IMG_FILEDROP
      ;;
    "piped-db")
      container_image=$IMG_POSTGRES
      ;;
    "piped-frontend")
      container_image=$IMG_PIPED_FRONTEND
      ;;
    "piped-proxy")
      container_image=$IMG_PIPED_PROXY
      ;;
    "piped-api")
      container_image=$IMG_PIPED_API
      ;;
    "piped-cron")
      container_image=$IMG_PIPED_CRON
      ;;
    "piped-web")
      container_image=$IMG_NGINX
      ;;
    "sqlpad")
      container_image=$IMG_SQLPAD
      ;;
    "heimdall")
      container_image=$IMG_HEIMDALL
      ;;
    "ofelia")
      container_image=$IMG_OFELIA
      ;;
    "uptimekuma")
      container_image=$IMG_UPTIMEKUMA
      ;;
    "grampsweb-app")
      container_image=$IMG_GRAMPSWEB
      ;;
    "grampsweb-redis")
      container_image=$IMG_REDIS
      ;;
    "penpot-db")
      container_image=$IMG_POSTGRES
      ;;
    "penpot-redis")
      container_image=$IMG_REDIS
      ;;
    "penpot-backend")
      container_image=$IMG_PENPOT_BACKEND
      ;;
    "penpot-frontend")
      container_image=$IMG_PENPOT_FRONTEND
      ;;
    "penpot-exporter")
      container_image=$IMG_PENPOT_EXPORTER
      ;;
    "espocrm-db")
      container_image=$IMG_MYSQL
      ;;
    "espocrm-app")
      container_image=$IMG_ESPOCRM_APP
      ;;
    "espocrm-daemon")
      container_image=$IMG_ESPOCRM_APP
      ;;
    "espocrm-websocket")
      container_image=$IMG_ESPOCRM_APP
      ;;
    "immich-db")
      container_image=$IMG_IMMICH_DB
      ;;
    "immich-app")
      container_image=$IMG_IMMICH_APP
      ;;
    "immich-ml")
      container_image=$IMG_IMMICH_ML
      ;;
    "immich-redis")
      container_image=$IMG_REDIS
      ;;
    "homarr-app")
      container_image=$IMG_HOMARR_APP
      ;;
    "matomo-db")
      container_image=$IMG_MYSQL
      ;;
    "matomo-app")
      container_image=$IMG_MATOMO_APP
      ;;
    "matomo-web")
      container_image=$IMG_NGINX
      ;;
    "pastefy-db")
      container_image=$IMG_MYSQL
      ;;
    "pastefy-app")
      container_image=$IMG_PASTEFY
      ;;
    "snippetbox")
      container_image=$IMG_SNIPPETBOX
      ;;
    "aistack-mindsdb-app")
      container_image=$IMG_AISTACK_MINDSDB_APP
      ;;
    "aistack-mindsdb-mod-app")
      container_image=$IMG_AISTACK_MINDSDB_MOD_APP
      ;;
    "aistack-mindsdb-db")
      container_image=$IMG_POSTGRES
      ;;
    "aistack-otel")
      container_image=$IMG_AISTACK_OPENTELEMETRY
      ;;
    "aistack-langfuse")
      container_image=$IMG_AISTACK_LANGFUSE
      ;;
    "aistack-ollama-server")
      container_image=$IMG_AISTACK_OLLAMA_SERVER
      ;;
    "aistack-openwebui")
      container_image=$IMG_AISTACK_OPENWEBUI
      ;;
    "aistack-redis")
      container_image=$IMG_REDIS
      ;;
    "pixelfed-db")
      container_image=$IMG_MYSQL
      ;;
    "pixelfed-app")
      container_image=$IMG_PIXELFED_MOD_APP
      ;;
    "pixelfed-worker")
      container_image=$IMG_PIXELFED_MOD_APP
      ;;
    "pixelfed-redis")
      container_image=$IMG_REDIS
      ;;
    "yamtrack-db")
      container_image=$IMG_POSTGRES
      ;;
    "yamtrack-app")
      container_image=$IMG_YAMTRACK_APP
      ;;
    "yamtrack-redis")
      container_image=$IMG_REDIS
      ;;
    "servarr-sonarr")
      container_image=$IMG_SERVARR_SONARR
      ;;
    "servarr-radarr")
      container_image=$IMG_SERVARR_RADARR
      ;;
    "servarr-lidarr")
      container_image=$IMG_SERVARR_LIDARR
      ;;
    "servarr-readarr")
      container_image=$IMG_SERVARR_READARR
      ;;
    "servarr-bazarr")
      container_image=$IMG_SERVARR_BAZARR
      ;;
    "servarr-mylar3")
      container_image=$IMG_SERVARR_MYLAR3
      ;;
    "servarr-prowlarr")
      container_image=$IMG_SERVARR_PROWLARR
      ;;
    "sabnzbd")
      container_image=$IMG_SABNZBD
      ;;
    "qbittorrent")
      container_image=$IMG_QBITTORRENT
      ;;
    *)
      ;;
  esac
  echo "$container_image"
}

function performPostStackRemoval()
{
  case "$1" in
    "wazuh")
      removeWazuhAgent
      ;;
    *)
      ;;
  esac
}

function checkAddAllNewSvcs()
{
  checkAddServiceToConfig "Collabora" "COLLABORA_ADMIN_USERNAME=,COLLABORA_ADMIN_PASSWORD="
  checkAddServiceToConfig "Invidious" "INVIDIOUS_DATABASE_NAME=,INVIDIOUS_DATABASE_USER=,INVIDIOUS_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Mealie" "MEALIE_ADMIN_USERNAME=,MEALIE_ADMIN_EMAIL_ADDRESS=,MEALIE_ADMIN_PASSWORD=,MEALIE_DATABASE_NAME=,MEALIE_DATABASE_USER=,MEALIE_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Remotely" "REMOTELY_INIT_ENV=false,REMOTELY_ADMIN_USERNAME=,REMOTELY_ADMIN_EMAIL_ADDRESS=,REMOTELY_ADMIN_PASSWORD="
  checkAddServiceToConfig "Calibre" "CALIBRE_WEB_INIT_ENV=false,CALIBRE_WEB_ADMIN_USERNAME=,CALIBRE_WEB_ADMIN_EMAIL_ADDRESS=,CALIBRE_WEB_ADMIN_PASSWORD="
  checkAddServiceToConfig "Linkwarden" "LINKWARDEN_DATABASE_NAME=,LINKWARDEN_DATABASE_USER=,LINKWARDEN_DATABASE_USER_PASSWORD=,LINKWARDEN_NEXTAUTH_SECRET=,LINKWARDEN_OIDC_CLIENT_SECRET="
  checkAddServiceToConfig "FreshRSS" "FRESHRSS_INIT_ENV=false,FRESHRSS_ADMIN_USERNAME=,FRESHRSS_ADMIN_PASSWORD=,FRESHRSS_ADMIN_EMAIL_ADDRESS=,FRESHRSS_DATABASE_NAME=,FRESHRSS_DATABASE_USER=,FRESHRSS_DATABASE_USER_PASSWORD=,FRESHRSS_OIDC_CLIENT_SECRET="
  checkAddServiceToConfig "Bar Assistant" "BARASSISTANT_REDIS_PASSWORD=,BARASSISTANT_MEILISEARCH_KEY="
  checkAddServiceToConfig "Keila" "KEILA_INIT_ENV=false,KEILA_ADMIN_USERNAME=,KEILA_ADMIN_EMAIL_ADDRESS=,KEILA_ADMIN_PASSWORD=,KEILA_DATABASE_NAME=,KEILA_DATABASE_USER=,KEILA_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Wallabag" "WALLABAG_INIT_ENV=false,WALLABAG_ADMIN_USERNAME=,WALLABAG_ADMIN_EMAIL_ADDRESS=,WALLABAG_ADMIN_PASSWORD=,WALLABAG_DATABASE_NAME=,WALLABAG_DATABASE_USER=,WALLABAG_DATABASE_USER_PASSWORD=,WALLABAG_ENV_SECRET=,WALLABAG_REDIS_PASSWORD="
  checkAddServiceToConfig "Jupyter" "JUPYTER_INIT_ENV=false,JUPYTER_ADMIN_PASSWORD="
  checkAddServiceToConfig "Paperless" "PAPERLESS_INIT_ENV=false,PAPERLESS_SECRET_KEY=,PAPERLESS_CLIENT_SECRET=,PAPERLESS_REDIS_PASSWORD=,PAPERLESS_ADMIN_USERNAME=,PAPERLESS_ADMIN_EMAIL_ADDRESS=,PAPERLESS_ADMIN_PASSWORD=,PAPERLESS_DATABASE_NAME=,PAPERLESS_DATABASE_USER=,PAPERLESS_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "SpeedtestTrackerLocal" "SPEEDTEST_TRACKER_LOCAL_INIT_ENV=false,SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME=,SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS=,SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD=,SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME=,SPEEDTEST_TRACKER_LOCAL_DATABASE_USER=,SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "SpeedtestTrackerVPN" "SPEEDTEST_TRACKER_VPN_INIT_ENV=false,SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME=,SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS=,SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD=,SPEEDTEST_TRACKER_VPN_DATABASE_NAME=,SPEEDTEST_TRACKER_VPN_DATABASE_USER=,SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Change Detection" "CHANGEDETECTION_INIT_ENV=false,CHANGEDETECTION_ADMIN_PASSWORD="
  checkAddServiceToConfig "Script-server" "SCRIPTSERVER_INIT_ENV=false,SCRIPTSERVER_LOCALHOST_PORT=8008,SCRIPTSERVER_ADMIN_USERNAME=,SCRIPTSERVER_ADMIN_PASSWORD="
  checkAddServiceToConfig "Huginn" "HUGINN_INIT_ENV=false,HUGINN_APP_SECRET_TOKEN=,HUGINN_ADMIN_USERNAME=,HUGINN_ADMIN_EMAIL_ADDRESS=,HUGINN_ADMIN_PASSWORD=,HUGINN_DATABASE_NAME=,HUGINN_DATABASE_USER=,HUGINN_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Coturn" "COTURN_STATIC_SECRET="
  checkAddServiceToConfig "Piped" "PIPED_DATABASE_NAME=,PIPED_DATABASE_USER=,PIPED_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "GrampsWeb" "GRAMPSWEB_INIT_ENV=false,GRAMPSWEB_ADMIN_USERNAME=,GRAMPSWEB_ADMIN_PASSWORD=,GRAMPSWEB_ADMIN_EMAIL_ADDRESS=,GRAMPSWEB_SECRET_KEY=,GRAMPSWEB_REDIS_PASSWORD="
  checkAddServiceToConfig "Penpot" "PENPOT_INIT_ENV=false,PENPOT_REDIS_PASSWORD=,PENPOT_DATABASE_NAME=,PENPOT_DATABASE_USER=,PENPOT_DATABASE_USER_PASSWORD=,PENPOT_SECRET_KEY="
  checkAddServiceToConfig "EspoCRM" "ESPOCRM_INIT_ENV=false,ESPOCRM_ADMIN_USERNAME=,ESPOCRM_ADMIN_PASSWORD=,ESPOCRM_DATABASE_NAME=,ESPOCRM_DATABASE_ROOT_PASSWORD=,ESPOCRM_DATABASE_USER=,ESPOCRM_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Immich" "IMMICH_INIT_ENV=false,IMMICH_ADMIN_USERNAME=,IMMICH_ADMIN_PASSWORD=,IMMICH_ADMIN_EMAIL_ADDRESS=,IMMICH_DATABASE_NAME=,IMMICH_DATABASE_USER=,IMMICH_DATABASE_USER_PASSWORD=,IMMICH_REDIS_PASSWORD=,IMMICH_OIDC_CLIENT_SECRET="
  checkAddServiceToConfig "Homarr" "HOMARR_INIT_ENV=false,HOMARR_ADMIN_USERNAME=,HOMARR_ADMIN_EMAIL_ADDRESS=,HOMARR_ADMIN_PASSWORD=,HOMARR_OIDC_CLIENT_SECRET="
  checkAddServiceToConfig "Matomo" "MATOMO_INIT_ENV=false,MATOMO_ADMIN_USERNAME=,MATOMO_ADMIN_PASSWORD=,MATOMO_ADMIN_EMAIL_ADDRESS=,MATOMO_DATABASE_NAME=,MATOMO_DATABASE_ROOT_PASSWORD=,MATOMO_DATABASE_USER=,MATOMO_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "Pastefy" "PASTEFY_INIT_ENV=false,PASTEFY_ADMIN_USERNAME=,PASTEFY_ADMIN_PASSWORD=,PASTEFY_ADMIN_EMAIL_ADDRESS=,PASTEFY_DATABASE_NAME=,PASTEFY_DATABASE_ROOT_PASSWORD=,PASTEFY_DATABASE_USER=,PASTEFY_DATABASE_USER_PASSWORD="
  checkAddServiceToConfig "AIStack" "AISTACK_INIT_ENV=false,AISTACK_MINDSDB_ADMIN_USERNAME=,AISTACK_MINDSDB_ADMIN_PASSWORD=,AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS=,AISTACK_MINDSDB_DATABASE_NAME=,AISTACK_MINDSDB_DATABASE_USER=,AISTACK_MINDSDB_DATABASE_USER_PASSWORD=,AISTACK_LANGFUSE_ADMIN_USERNAME=,AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS=,AISTACK_LANGFUSE_ADMIN_PASSWORD=,AISTACK_LANGFUSE_DATABASE_NAME=,AISTACK_OPENWEBUI_ADMIN_USERNAME=,AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS=,AISTACK_OPENWEBUI_ADMIN_PASSWORD=,AISTACK_OPENWEBUI_OIDC_CLIENT_ID=,AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET=,AISTACK_REDIS_PASSWORD="
  checkAddServiceToConfig "Pixelfed" "PIXELFED_INIT_ENV=false,PIXELFED_DATABASE_NAME=,PIXELFED_DATABASE_ROOT_PASSWORD=,PIXELFED_DATABASE_USER=,PIXELFED_DATABASE_USER_PASSWORD=,PIXELFED_REDIS_PASSWORD=,PIXELFED_APP_KEY="
  checkAddServiceToConfig "Yamtrack" "YAMTRACK_INIT_ENV=false,YAMTRACK_ADMIN_USERNAME=,YAMTRACK_ADMIN_PASSWORD=,YAMTRACK_REDIS_PASSWORD=,YAMTRACK_DATABASE_NAME=,YAMTRACK_DATABASE_USER=,YAMTRACK_DATABASE_USER_PASSWORD=,YAMTRACK_SECRET_KEY=,YAMTRACK_OIDC_CLIENT_ID=,YAMTRACK_OIDC_CLIENT_SECRET="
  checkAddServiceToConfig "Servarr" "SERVARR_INIT_ENV=false,SONARR_ADMIN_USERNAME=,SONARR_ADMIN_PASSWORD=,RADARR_ADMIN_USERNAME=,RADARR_ADMIN_PASSWORD=,LIDARR_ADMIN_USERNAME=,LIDARR_ADMIN_PASSWORD=,READARR_ADMIN_USERNAME=,READARR_ADMIN_PASSWORD=,BAZARR_ADMIN_USERNAME=,BAZARR_ADMIN_PASSWORD=,MYLAR3_ADMIN_USERNAME=,MYLAR3_ADMIN_PASSWORD=,PROWLARR_ADMIN_USERNAME=,PROWLARR_ADMIN_PASSWORD="
  checkAddServiceToConfig "SABnzbd" "SABNZBD_INIT_ENV=false,SABNZBD_ADMIN_USERNAME=,SABNZBD_ADMIN_PASSWORD="
  checkAddServiceToConfig "qBittorrent" "QBITTORRENT_INIT_ENV=false,QBITTORRENT_ADMIN_USERNAME=,QBITTORRENT_ADMIN_PASSWORD="
  checkAddVarsToServiceConfig "Mailu" "MAILU_API_TOKEN="
  checkAddVarsToServiceConfig "PhotoPrism" "PHOTOPRISM_INIT_ENV=false"
  checkAddVarsToServiceConfig "PhotoPrism" "PHOTOPRISM_ADMIN_USERNAME="
  checkAddVarsToServiceConfig "PhotoPrism" "PHOTOPRISM_ADMIN_PASSWORD="
  checkAddVarsToServiceConfig "Mastodon" "MASTODON_ARE_DETERMINISTIC_KEY="
  checkAddVarsToServiceConfig "Mastodon" "MASTODON_ARE_KEY_DERIVATION_SALT="
  checkAddVarsToServiceConfig "Mastodon" "MASTODON_ARE_PRIMARY_KEY="
  checkAddVarsToServiceConfig "HomeAssistant" "HOMEASSISTANT_CONFIGURATOR_USER=,HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD="
  checkAddVarsToServiceConfig "Mealie" "MEALIE_DATABASE_NAME=,MEALIE_DATABASE_USER=,MEALIE_DATABASE_USER_PASSWORD="
  checkAddVarsToServiceConfig "Remotely" "REMOTELY_INIT_ENV=false"
  checkAddVarsToServiceConfig "Calibre" "CALIBRE_WEB_INIT_ENV=false"
  checkAddVarsToServiceConfig "FreshRSS" "FRESHRSS_INIT_ENV=false"
  checkAddVarsToServiceConfig "Keila" "KEILA_INIT_ENV=false"
  checkAddVarsToServiceConfig "Wazuh" "WAZUH_MANAGER_AUTH_PASSWORD="
  checkAddVarsToServiceConfig "Paperless" "PAPERLESS_OIDC_CLIENT_SECRET="
  checkAddVarsToServiceConfig "Linkwarden" "LINKWARDEN_OIDC_CLIENT_SECRET="
  checkAddVarsToServiceConfig "FreshRSS" "FRESHRSS_OIDC_CLIENT_SECRET="
  checkAddVarsToServiceConfig "OpenLDAP" "LDAP_PRIMARY_USER_FULLNAME=${LDAP_PRIMARY_USER_USERNAME^}"
  checkAddVarsToServiceConfig "Duplicati" "DUPLICATI_SETTINGS_ENCRYPTION_KEY="
  checkAddVarsToServiceConfig "FireflyIII" "FIREFLY_STATIC_CRON_TOKEN="
  checkAddVarsToServiceConfig "Homarr" "HOMARR_ADMIN_EMAIL_ADDRESS="
  checkAddVarsToServiceConfig "Nextcloud" "NEXTCLOUD_TALKHPB_SIGNALING_SECRET=,NEXTCLOUD_TALKHPB_INTERNAL_SECRET=,NEXTCLOUD_TALKHPB_RECORDING_SECRET="
}

function importDBs()
{
  # This function is just here as a reminder to add any
  # DB connection info to SQLPad and/or the AIStack
  return
}

function getHomeServerPortsList()
{
  portsList="$ADGUARD_DNS_PORT,$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,$COTURN_PRIMARY_PORT,$COTURN_SECONDARY_PORT,$COTURN_COMMS_MIN_PORT:$COTURN_COMMS_MAX_PORT,$JELLYFIN_PORT,$JITSI_COLIBRI_PORT,$JITSI_JVB_PORT,$JITSI_MEET_PORT,$MAILU_PORT_1,$MAILU_PORT_2,$MAILU_PORT_3,$MAILU_PORT_4,$MAILU_PORT_5,$MAILU_PORT_6,$MAILU_PORT_7,$PEERTUBE_RDP_PORT,$QBITTORRENT_PORT,$SYNCTHING_DISC_PORT,$SYNCTHING_SYNC_PORT,$UPNP_PORT,$VNC_SERVER_PORT,$WAZUH_PORT_1,$WAZUH_PORT_2,$WAZUH_PORT_3,$WAZUH_PORT_4,$WAZUH_PORT_5"
  echo "$portsList"
}

# Stacks Installation/Update Functions

# Portainer
function installPortainer()
{
  set +e
  is_containers=$(docker ps -q)
  if [ ${#is_containers} -gt 0 ]; then
    showMessageBox "Docker Containers Running" "There are docker containers running. Please stop these containers before continuing. Exiting..."
    exit 1
  fi
  # Don't install if directory exists
  checkDeleteStackAndDirectory portainer "Portainer" false
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  set -e
  createDockerNetworks

  mkdir $HSHQ_STACKS_DIR/portainer
  mkdir $HSHQ_STACKS_DIR/portainer/certs

  initServicesCredentials
  outputConfigPortainer
  generateCert portainer portainer "127.0.0.1,$HOMESERVER_HOST_PRIMARY_INTERFACE_IP"
  if [ -z "$PORTAINER_DB_KEY" ]; then
    PORTAINER_DB_KEY=$(pwgen -c -n 64 1)
    updateConfigVar PORTAINER_DB_KEY $PORTAINER_DB_KEY
    rm -f $HSHQ_SECRETS_DIR/portainer_key.txt
    echo $PORTAINER_DB_KEY > $HSHQ_SECRETS_DIR/portainer_key.txt
    chmod 0400 $HSHQ_SECRETS_DIR/portainer_key.txt
  elif ! [ -f $HSHQ_SECRETS_DIR/portainer_key.txt ]; then
    echo $PORTAINER_DB_KEY > $HSHQ_SECRETS_DIR/portainer_key.txt
    chmod 0400 $HSHQ_SECRETS_DIR/portainer_key.txt
  fi
  # Version 74 Update - see note at very top inside of init() function.
  cd ~
  sudo docker compose -f $HSHQ_STACKS_DIR/portainer/docker-compose.yml up -d
  search="starting HTTPS server"
  isFound=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs portainer 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=$i seconds..."
    sleep 1
    i=$((i+1))
  done
  set -e
  if ! [ "$isFound" = "true" ]; then
    echo "Portainer did not start up correctly..."
    exit 1
  fi

  echo "Portainer has been loaded and started..."
  echo "Sleeping 10 seconds to ensure Portainer has loaded completely."
  sleep 10

  PORTAINER_ADMIN_USERID=$(http --verify=no --print="b" POST https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/users/admin/init Username="$PORTAINER_ADMIN_USERNAME" Password="$PORTAINER_ADMIN_PASSWORD"  | jq -r .Id)
  updateConfigVar PORTAINER_ADMIN_USERID $PORTAINER_ADMIN_USERID
  PORTAINER_TOKEN="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  http -f --verify=no --timeout=300 --print="b" POST https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/endpoints "Authorization: Bearer $PORTAINER_TOKEN" Name="$HOMESERVER_NAME" EndpointCreationType=1 >/dev/null

  # Enable dark mode because it looks better
  echo "{\"theme\":{\"color\":\"dark\"}}" > $HOME/portainer-json.tmp
  http --verify=no --timeout=300 PUT https://127.0.0.1:$PORTAINER_LOCAL_HTTPS_PORT/api/users/$PORTAINER_ADMIN_USERID "Authorization: Bearer $PORTAINER_TOKEN" @$HOME/portainer-json.tmp > /dev/null
  rm $HOME/portainer-json.tmp

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PORTAINER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://portainer:9443 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PORTAINER $MANAGETLS_PORTAINER "$is_integrate_hshq" $NETDEFAULT_PORTAINER "$inner_block"
}

function outputConfigPortainer()
{
  DOCKER_SOCKET="/var/run/docker.sock"
  if ! [ "$(checkIsIPPrivate $HOMESERVER_HOST_PRIMARY_INTERFACE_IP)" = "true" ]; then
    pdocknet=dock-ext
  else
    pdocknet=dock-privateip
  fi

  cat <<EOFPC > $HSHQ_STACKS_DIR/portainer/docker-compose.yml
$STACK_VERSION_PREFIX portainer $(getScriptStackVersion portainer)

services:
  portainer:
    image: $(getScriptImageByContainerName portainer)
    container_name: portainer
    hostname: portainer
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    env_file: portainer.env
    networks:
      - dock-proxy-net
      - ${pdocknet}-net
    ports:
      - "$PORTAINER_LOCAL_HTTPS_PORT:9443"
    command:
      --sslcert /data/certs/portainer.crt
      --sslkey /data/certs/portainer.key
      --http-disabled
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${DOCKER_SOCKET}:/var/run/docker.sock
      - ${HSHQ_STACKS_DIR}/portainer:/data
      - ${HSHQ_SSL_DIR}/portainer.crt:/data/certs/portainer.crt:ro
      - ${HSHQ_SSL_DIR}/portainer.key:/data/certs/portainer.key:ro
      - ${HSHQ_SECRETS_DIR}/portainer_key.txt:/run/secrets/portainer

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  ${pdocknet}-net:
    name: ${pdocknet}
    external: true
EOFPC

  outputEnvPortainer
}

function outputEnvPortainer()
{
  rm -f $HSHQ_STACKS_DIR/portainer/portainer.env
  tee $HSHQ_STACKS_DIR/portainer/portainer.env >/dev/null <<EOFPC
HSHQ_BASE_DIR=$HSHQ_BASE_DIR
HSHQ_DATA_DIR=$HSHQ_DATA_DIR
HSHQ_BACKUP_DIR=$HSHQ_BACKUP_DIR
HSHQ_NONBACKUP_DIR=$HSHQ_NONBACKUP_DIR
HSHQ_ASSETS_DIR=$HSHQ_ASSETS_DIR
HSHQ_BUILD_DIR=$HSHQ_BUILD_DIR
HSHQ_CONFIG_DIR=$HSHQ_CONFIG_DIR
HSHQ_LIB_DIR=$HSHQ_LIB_DIR
HSHQ_RELAYSERVER_DIR=$HSHQ_RELAYSERVER_DIR
HSHQ_SCRIPTS_DIR=$HSHQ_SCRIPTS_DIR
HSHQ_SECRETS_DIR=$HSHQ_SECRETS_DIR
HSHQ_SSL_DIR=$HSHQ_SSL_DIR
HSHQ_STACKS_DIR=$HSHQ_STACKS_DIR
HSHQ_WIREGUARD_DIR=$HSHQ_WIREGUARD_DIR
TZ=$TZ
UID=$USERID
GID=$GROUPID
EOFPC
  chmod 600 $HSHQ_STACKS_DIR/portainer/portainer.env
  echo "HOMESERVER_HOST_PRIMARY_INTERFACE_IP=${HOMESERVER_HOST_PRIMARY_INTERFACE_IP}" | tee -a $HSHQ_STACKS_DIR/portainer/portainer.env >/dev/null
  ALL_INTERFACE_IPS="$(getAllInterfaceIPs)"
  ifListDBID=($(sqlite3 $HSHQ_DB "select ID from connections where NetworkType = 'home_network';"))
  for curID in "${ifListDBID[@]}"
  do
    curIF_Interface=$(sqlite3 $HSHQ_DB "select InterfaceName from connections where ID = $curID;")
    curIF_IP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID = $curID;")
    curIF_Subnet=$(sqlite3 $HSHQ_DB "select Network_Subnet from connections where ID = $curID;")
    curIF_IPVar=$(getHSHostIPVarName $curIF_Interface)
    curIF_SubnetVar=$(getHSHostSubnetVarName $curIF_Interface)
    if ! [ -z "$curIF_IP" ] && [ "$(checkValidIPAddress $curIF_IP)" = "true" ] && ! [ "$curIF_IP" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
      echo "${curIF_IPVar}=${curIF_IP}" | tee -a $HSHQ_STACKS_DIR/portainer/portainer.env >/dev/null
      echo "${curIF_SubnetVar}=${curIF_Subnet}" | tee -a $HSHQ_STACKS_DIR/portainer/portainer.env >/dev/null
    fi
  done
  echo "ALL_INTERFACE_IPS=${ALL_INTERFACE_IPS}" | tee -a $HSHQ_STACKS_DIR/portainer/portainer.env >/dev/null
  chown $USERID:$GROUPID $HSHQ_STACKS_DIR/portainer/portainer.env
}

function getAllInterfaceIPs()
{
  all_iface_ips=""
  ifListDBID=($(sqlite3 $HSHQ_DB "select ID from connections where NetworkType = 'home_network';"))
  for curID in "${ifListDBID[@]}"
  do
    curIF_IP=$(sqlite3 $HSHQ_DB "select IPAddress from connections where ID = $curID;")
    if ! [ -z "$curIF_IP" ] && [ "$(checkValidIPAddress $curIF_IP)" = "true" ] && ! [ "$curIF_IP" = "$DEFAULT_UNFOUND_IP_ADDRESS" ]; then
      if ! [ "$curIF_IP" = "127.0.0.1" ]; then
        if [ -z "$all_iface_ips" ]; then
          all_iface_ips="${curIF_IP}"
        else
          all_iface_ips="$all_iface_ips","${curIF_IP}"
        fi
      fi
    fi
  done
  ipListArr=($(sqlite3 $HSHQ_DB "select IPAddress from connections where ConnectionType='homeserver_vpn' and NetworkType in ('primary','other');"))
  for curIP in "${ipListArr[@]}"
  do
    if [ -z "$all_iface_ips" ]; then
      all_iface_ips="${curIP}"
    else
      all_iface_ips="$all_iface_ips,${curIP}"
    fi
  done
  echo "$all_iface_ips"
}

function performUpdatePortainer()
{
  # This is a special case and has not been tested. Ensure to test on next image release.
  perform_stack_name=portainer
  # This function modifies the variable perform_update_report
  # with the results of the update process. It is up to the 
  # caller to do something with it.
  perform_update_report=""
  portainerToken="$1"
  perform_compose=$HSHQ_STACKS_DIR/portainer/docker-compose.yml
  perform_stack_firstline=$(sudo sed -n 1p $perform_compose)
  perform_stack_ver=$(getVersionFromComposeLine "$perform_stack_firstline")
  unset image_update_map
  image_update_map=""
  oldVer=v"$perform_stack_ver"
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=portainer/portainer-ce:2.19.3-alpine
      image_update_map[0]="portainer/portainer-ce:2.19.3-alpine,portainer/portainer-ce:2.21.4-alpine"
    ;;
    2)
      newVer=v3
      curImageList=portainer/portainer-ce:2.19.4-alpine
      image_update_map[0]="portainer/portainer-ce:2.19.4-alpine,portainer/portainer-ce:2.21.4-alpine"
    ;;
    3)
      newVer=v3
      curImageList=portainer/portainer-ce:2.21.4-alpine
      image_update_map[0]="portainer/portainer-ce:2.21.4-alpine,portainer/portainer-ce:2.21.4-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "0" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function restartPortainer()
{
  stopPortainer
  sleep 3
  startPortainer
  if ! [ -z "$PORTAINER_ADMIN_USERNAME" ] && ! [ -z "$PORTAINER_ADMIN_PASSWORD" ]; then
    portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  fi
}

function stopPortainer()
{
  cd ~
  docker compose -f $HSHQ_STACKS_DIR/portainer/docker-compose.yml down > /dev/null 2>&1
}

function startPortainer()
{
  stpo_curE=${-//[^e]/}
  set +e
  cd ~
  docker compose -f $HSHQ_STACKS_DIR/portainer/docker-compose.yml up -d > /dev/null 2>&1
  search="starting HTTPS server"
  isFound="F"
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs portainer 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound="T"
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=$i seconds..."
    sleep 1
    i=$((i+1))
  done
  if ! [ -z "$stpo_curE" ]; then
    set -e
  fi
  sleep 3
}

function updatePortainerEnv()
{
  stopPortainer
  outputEnvPortainer
  startPortainer
}

# Adguard
function installAdGuard()
{
  set +e
  is_integrate_hshq=$1
  # Remove directory if it exists
  checkDeleteStackAndDirectory adguard "Adguard"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: AdGuard directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName adguard)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain AdGuard docker image"
    exit 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/adguard
  mkdir $HSHQ_STACKS_DIR/adguard/conf
  mkdir $HSHQ_NONBACKUP_DIR/adguard
  mkdir $HSHQ_NONBACKUP_DIR/adguard/work
  initServicesCredentials
  outputConfigAdGuard
  generateCert adguard adguard
  prepAdguardInstallation
  installStack adguard adguard "entering listener loop proto=tls" $HOME/adguard.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing AdGuard"
    exit $retval
  fi
  isSuccess=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    checkDNS=$(dig +short api.ipify.org | head -n 1)
    if ! [ -z "$checkDNS" ] && [ "$(checkValidIPAddress $checkDNS)" = "true" ]; then
      isSuccess=true
      break
    fi
    echo "Adguard not ready, sleeping 3 seconds, total wait=$i seconds..."
    sleep 3
    i=$((i+3))
  done
  if ! [ "$isSuccess" = "true" ]; then
    echo "Adguard did not install correctly, exiting..."
    exit 1
  fi
  inner_block=""
  inner_block=$inner_block">>https://$SUB_ADGUARD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://adguard {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_ADGUARD $MANAGETLS_ADGUARD "$is_integrate_hshq" $NETDEFAULT_ADGUARD "$inner_block"
}

function outputConfigAdGuard()
{
  ADGUARD_ADMIN_PASSWORD_HASH=$(htpasswd -B -n -b $ADGUARD_ADMIN_USERNAME $ADGUARD_ADMIN_PASSWORD | cut -d":" -f2-)
  cat <<EOFAC > $HOME/adguard-compose.yml
$STACK_VERSION_PREFIX adguard $(getScriptStackVersion adguard)

services:
  adguard:
    image: $(getScriptImageByContainerName adguard)
    container_name: adguard
    hostname: adguard
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    security_opt:
      - no-new-privileges:true
    networks:
      dock-proxy-net:
      dock-ext-net:
        ipv4_address: \${NET_EXTERNAL_SUBNET_PREFIX}.253
    ports:
      - "$ADGUARD_DNS_PORT:${ADGUARD_DNS_PORT}/tcp"
      - "$ADGUARD_DNS_PORT:${ADGUARD_DNS_PORT}/udp"
      - "127.0.0.1:$ADGUARD_LOCALHOST_PORT:443"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/adguard/conf:/opt/adguardhome/conf
      - \${HSHQ_NONBACKUP_DIR}/adguard/work:/opt/adguardhome/work
      - \${HSHQ_SSL_DIR}/adguard.crt:/opt/adguardhome/conf/cert.pem
      - \${HSHQ_SSL_DIR}/adguard.key:/opt/adguardhome/conf/key.pem

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFAC

  cat <<EOFAD > $HOME/adguard.env
NET_EXTERNAL_SUBNET_PREFIX=$NET_EXTERNAL_SUBNET_PREFIX
GODEBUG=tlskyber=0
EOFAD

  cat <<EOFAD > $HSHQ_STACKS_DIR/adguard/conf/AdGuardHome.yaml
http:
  pprof:
    port: 6060
    enabled: false
  address: 0.0.0.0:3000
  session_ttl: 720h
users:
  - name: $ADGUARD_ADMIN_USERNAME
    password: $ADGUARD_ADMIN_PASSWORD_HASH
auth_attempts: 5
block_auth_min: 15
http_proxy: ""
language: en
theme: dark
dns:
  bind_hosts:
    - 0.0.0.0
  port: $ADGUARD_DNS_PORT
  anonymize_client_ip: false
  ratelimit: 0
  ratelimit_subnet_len_ipv4: 24
  ratelimit_subnet_len_ipv6: 56
  ratelimit_whitelist: []
  refuse_any: true
  upstream_dns:
    - https://dns.quad9.net/dns-query
    - https://anycast.dns.nextdns.io/dns-query
    - quic://dns-unfiltered.adguard.com:784
    - https://dns.nextdns.io/dns-query
  upstream_dns_file: ""
  bootstrap_dns:
    - 9.9.9.9
    - 149.112.112.112
  fallback_dns:
    - 9.9.9.10
    - 149.112.112.10
    - 94.140.14.14
    - 94.140.15.15
  upstream_mode: parallel
  fastest_timeout: 1s
  allowed_clients:
    - 127.0.0.0/8
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  disallowed_clients: []
  blocked_hosts:
    - version.bind
    - id.server
    - hostname.bind
  trusted_proxies:
    - 127.0.0.0/8
    - ::1/128
  cache_size: 41943040
  cache_ttl_min: 0
  cache_ttl_max: 0
  cache_optimistic: true
  bogus_nxdomain: []
  aaaa_disabled: true
  enable_dnssec: true
  edns_client_subnet:
    custom_ip: ""
    enabled: false
    use_custom: false
  max_goroutines: 300
  handle_ddr: true
  ipset: []
  ipset_file: ""
  bootstrap_prefer_ipv6: false
  upstream_timeout: 3s
  private_networks: []
  use_private_ptr_resolvers: true
  local_ptr_upstreams: []
  use_dns64: false
  dns64_prefixes: []
  serve_http3: false
  use_http3_upstreams: false
  serve_plain_dns: true
  hostsfile_enabled: true
tls:
  enabled: true
  server_name: adguard
  force_https: true
  port_https: 443
  port_dns_over_tls: 853
  port_dns_over_quic: 853
  port_dnscrypt: 0
  dnscrypt_config_file: ""
  allow_unencrypted_doh: false
  certificate_chain: ""
  private_key: ""
  certificate_path: /opt/adguardhome/conf/cert.pem
  private_key_path: /opt/adguardhome/conf/key.pem
  strict_sni_check: false
querylog:
  dir_path: ""
  ignored:
    - $HOMESERVER_DOMAIN
    - '*.$HOMESERVER_DOMAIN'
  interval: 720h
  size_memory: 1000
  enabled: true
  file_enabled: true
statistics:
  dir_path: ""
  ignored:
    - $HOMESERVER_DOMAIN
    - '*.$HOMESERVER_DOMAIN'
  interval: 720h
  enabled: true
filters:
  - enabled: true
    url: https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt
    name: AdGuard DNS filter
    id: 1
  - enabled: true
    url: https://adaway.org/hosts.txt
    name: AdAway Default Blocklist
    id: 2
  - enabled: false
    url: https://someonewhocares.org/hosts/zero/hosts
    name: Dan Pollock's List
    id: 1657273139
  - enabled: false
    url: https://raw.githubusercontent.com/Perflyst/PiHoleBlocklist/master/SmartTV-AGH.txt
    name: Perflyst and Dandelion Sprout's Smart-TV Blocklist
    id: 1657273140
  - enabled: false
    url: https://raw.githubusercontent.com/crazy-max/WindowsSpyBlocker/master/data/hosts/spy.txt
    name: WindowsSpyBlocker - Hosts spy rules
    id: 1657273141
  - enabled: false
    url: https://raw.githubusercontent.com/DandelionSprout/adfilt/master/Alternate%20versions%20Anti-Malware%20List/AntiMalwareAdGuardHome.txt
    name: Dandelion Sprout's Anti-Malware List
    id: 1657273142
  - enabled: false
    url: https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt
    name: NoCoin Filter List
    id: 1657273143
  - enabled: false
    url: https://raw.githubusercontent.com/durablenapkin/scamblocklist/master/adguard.txt
    name: Scam Blocklist by DurableNapkin
    id: 1657273144
  - enabled: false
    url: https://raw.githubusercontent.com/mitchellkrogza/The-Big-List-of-Hacked-Malware-Web-Sites/master/hosts
    name: The Big List of Hacked Malware Web Sites
    id: 1657273145
  - enabled: false
    url: https://malware-filter.gitlab.io/malware-filter/urlhaus-filter-agh-online.txt
    name: Online Malicious URL Blocklist
    id: 1657273146
  - enabled: true
    url: https://pgl.yoyo.org/adservers/serverlist.php?hostformat=adblockplus&showintro=1&mimetype=plaintext
    name: Peter Lowe's List
    id: 1657273147
whitelist_filters: []
user_rules:
  - '@@||api.ipify.org^'
  - '@@||$HOMESERVER_DOMAIN^'
dhcp:
  enabled: false
  interface_name: ""
  local_domain_name: lan
  dhcpv4:
    gateway_ip: ""
    subnet_mask: ""
    range_start: ""
    range_end: ""
    lease_duration: 86400
    icmp_timeout_msec: 1000
    options: []
  dhcpv6:
    range_start: ""
    lease_duration: 86400
    ra_slaac_only: false
    ra_allow_slaac: false
filtering:
  blocking_ipv4: ""
  blocking_ipv6: ""
  blocked_services:
    schedule:
      time_zone: Local
    ids: []
  protection_disabled_until: null
  safe_search:
    enabled: false
    bing: true
    duckduckgo: true
    ecosia: true
    google: true
    pixabay: true
    yandex: true
    youtube: true
  blocking_mode: default
  parental_block_host: family-block.dns.adguard.com
  safebrowsing_block_host: standard-block.dns.adguard.com
  rewrites:
    - domain: '$HOMESERVER_DOMAIN'
      answer: $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
    - domain: '*.$HOMESERVER_DOMAIN'
      answer: $HOMESERVER_HOST_PRIMARY_INTERFACE_IP
    - domain: '*.$EXT_DOMAIN_PREFIX.$HOMESERVER_DOMAIN'
      answer: $RELAYSERVER_SERVER_IP
  safe_fs_patterns:
    - /opt/adguardhome/work/data/userfilters/*
  safebrowsing_cache_size: 10485760
  safesearch_cache_size: 10485760
  parental_cache_size: 10485760
  cache_time: 30
  filters_update_interval: 24
  blocked_response_ttl: 10
  filtering_enabled: true
  parental_enabled: false
  safebrowsing_enabled: false
  protection_enabled: true
clients:
  runtime_sources:
    whois: true
    arp: true
    rdns: true
    dhcp: true
    hosts: true
  persistent: []
log:
  enabled: true
  file: ""
  max_backups: 0
  max_size: 100
  max_age: 3
  compress: false
  local_time: false
  verbose: false
os:
  group: ""
  user: ""
  rlimit_nofile: 0
schema_version: 29
EOFAD
}

function modFunAdguardFixMSS()
{
  set +e
  grep "GODEBUG=tlskyber" $HOME/adguard.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "GODEBUG=tlskyber=0" >> $HOME/adguard.env
  else
    return 2
  fi
}

function performUpdateAdGuard()
{
  perform_stack_name=adguard
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.41
      image_update_map[0]="adguard/adguardhome:v0.107.41,adguard/adguardhome:v0.107.59"
    ;;
    2)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.43
      image_update_map[0]="adguard/adguardhome:v0.107.43,adguard/adguardhome:v0.107.59"
    ;;
    3)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.45
      image_update_map[0]="adguard/adguardhome:v0.107.45,adguard/adguardhome:v0.107.59"
    ;;
    4)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.52
      image_update_map[0]="adguard/adguardhome:v0.107.52,adguard/adguardhome:v0.107.59"
    ;;
    5)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.53
      image_update_map[0]="adguard/adguardhome:v0.107.53,adguard/adguardhome:v0.107.59"
    ;;
    6)
      newVer=v6
      curImageList=adguard/adguardhome:v0.107.59
      image_update_map[0]="adguard/adguardhome:v0.107.59,adguard/adguardhome:v0.107.59"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function prepAdguardInstallation()
{
  pai_curE=${-//[^e]/}
  set +e
  sudo systemctl stop systemd-resolved > /dev/null 2>&1
  sudo systemctl disable systemd-resolved > /dev/null 2>&1
  if [ -f /etc/dhcp/dhclient.conf ]; then
    sudo sed -i '/supersede domain-name-servers/d' /etc/dhcp/dhclient.conf
    sudo sed -i -e '$a\' /etc/dhcp/dhclient.conf
    echo "supersede domain-name-servers 127.0.0.1;" | sudo tee -a /etc/dhcp/dhclient.conf > /dev/null 2>&1
  fi
  sudo rm -f /etc/resolv.conf > /dev/null 2>&1
  sudo tee /etc/resolv.conf >/dev/null <<EOFR
nameserver 127.0.0.1
EOFR
  if sudo test -d /etc/netplan; then
    sudo find /etc/netplan -type f -print0 | while read -d '' cur_np
    do
      sudo sed -i "s|8.8.8.8|9.9.9.9|g" $cur_np
      sudo sed -i "s|8.8.4.4|149.112.112.112|g" $cur_np
    done
  fi
  if ! [ -z "$pai_curE" ]; then
    set -e
  fi
}

# SysUtils
function installSysUtils()
{
  set +e
  is_integrate_hshq=$1
  # Don't install if directory exists
  checkDeleteStackAndDirectory sysutils "SystemUtils"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName grafana)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName prometheus)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName node-exporter)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName influxdb)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/sysutils
  mkdir $HSHQ_STACKS_DIR/sysutils/grafana
  mkdir $HSHQ_STACKS_DIR/sysutils/influxdb
  mkdir $HSHQ_STACKS_DIR/sysutils/influxdb/etc
  mkdir $HSHQ_STACKS_DIR/sysutils/influxdb/var
  mkdir $HSHQ_STACKS_DIR/sysutils/prometheus
  mkdir $HSHQ_NONBACKUP_DIR/sysutils
  mkdir $HSHQ_NONBACKUP_DIR/sysutils/prometheus
  initServicesCredentials
  generateCert influxdb influxdb
  gf_dataset_uid=$(pwgen -c -n 9 1)
  gf_dashboard_uid=$(pwgen -c -n 9 1)
  # Have had 2 abrupt exits randomly around this point,
  # with the error: "getwd: no such file or directory".
  # So adding some debug statements and potential solutions.
  echo "Sysutils - Output config"
  outputConfigSysUtils
  # This may seem silly, but Since gfdashboard.json is
  # very large, there could be a strange race condition.
  while ! [ -f $HOME/gfdashboard.json ]
  do
    echo "Waiting for json dashboard file..."
    sleep 1
  done
  cd ~
  echo "Sysutils - Starting stack"
  sleep 3
  cd ~
  docker compose -f $HOME/sysutils-compose-tmp.yml up -d
  search="HTTP Server Listen"
  isFound=false
  i=0
  set +e
  while [ $i -le 120 ]
  do
    findtext=$(docker logs grafana 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 5 seconds, total wait=$i seconds..."
    sleep 5
    i=$((i+5))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "System Utils did not start up correctly..."
    cd ~
    docker compose -f $HOME/sysutils-compose-tmp.yml down -v
    return 1
  fi
  search="service=tcp-listener transport=https"
  isFound=false
  i=0
  while [ $i -le 60 ]
  do
    findtext=$(docker logs influxdb 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 1 second, total wait=$i seconds..."
    sleep 1
    i=$((i+1))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "System Utils did not start up correctly..."
    cd ~
    docker compose -f $HOME/sysutils-compose-tmp.yml down -v
    return 1
  fi
  sleep 5
  datasource_json=$(jq -n --arg gfid "$gf_dataset_uid" '{name: "Prometheus", uid: $gfid, type: "prometheus", url: "http://prometheus:9090", access: "proxy", basicAuth: false}')
  num_tries=1
  total_tries=5
  isSuccess=false
  while [ "$isSuccess" = "false" ] && [ $num_tries -lt $total_tries ]
  do
    echo $datasource_json | http POST http://$GRAFANA_ADMIN_USERNAME:$GRAFANA_ADMIN_PASSWORD@127.0.0.1:6565/api/datasources > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      isSuccess=true
      break
    fi
    echo "ERROR: Grafana datasource import failed, retrying in 5 seconds..."
    sleep 5
    ((num_tries++))
  done
  if [ "$isSuccess" = "false" ]; then
    echo "ERROR: Could not import datasource into Grafana."
  else
    sleep 3
    isSuccess=false
    num_tries=1
    while [ "$isSuccess" = "false" ] && [ $num_tries -lt $total_tries ]
    do
      cat $HOME/gfdashboard.json | http POST http://$GRAFANA_ADMIN_USERNAME:$GRAFANA_ADMIN_PASSWORD@127.0.0.1:6565/api/dashboards/db > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        isSuccess=true
        break
      fi
      echo "ERROR: Grafana dashboard import failed, retrying in 5 seconds..."
      sleep 5
      ((num_tries++))
    done
    if [ "$isSuccess" = "false" ]; then
      echo "ERROR: Could not import dashboard into Grafana."
    fi
  fi
  set -e
  pref_string=$(jq -n --arg gfid "$gf_dashboard_uid" --arg tz "$TZ" '{theme: "dark", homeDashboardUID: $gfid, timezone: $tz}')
  echo $pref_string | http PATCH http://$GRAFANA_ADMIN_USERNAME:$GRAFANA_ADMIN_PASSWORD@127.0.0.1:6565/api/org/preferences > /dev/null 2>&1

  sleep 2
  cd ~
  docker compose -f $HOME/sysutils-compose-tmp.yml down -v
  sleep 2
  installStack sysutils grafana "HTTP Server Listen" $HOME/sysutils.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  rm -f $HOME/sysutils-compose-tmp.yml
  rm -f $HOME/gfdashboard.json

  inner_block=""
  inner_block=$inner_block">>https://$SUB_GRAFANA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://grafana:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GRAFANA $MANAGETLS_GRAFANA "$is_integrate_hshq" $NETDEFAULT_GRAFANA "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PROMETHEUS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://prometheus:9090 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PROMETHEUS $MANAGETLS_PROMETHEUS "$is_integrate_hshq" $NETDEFAULT_PROMETHEUS "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_INFLUXDB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://influxdb:8086 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_INFLUXDB $MANAGETLS_INFLUXDB "$is_integrate_hshq" $NETDEFAULT_INFLUXDB "$inner_block"

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll sysutils "$FMLNAME_GRAFANA" $USERTYPE_GRAFANA "https://$SUB_GRAFANA.$HOMESERVER_DOMAIN" "grafana.png" "$(getHeimdallOrderFromSub $SUB_GRAFANA $USERTYPE_GRAFANA)"
    insertEnableSvcAll sysutils "$FMLNAME_PROMETHEUS" $USERTYPE_PROMETHEUS "https://$SUB_PROMETHEUS.$HOMESERVER_DOMAIN" "prometheus.png" "$(getHeimdallOrderFromSub $SUB_PROMETHEUS $USERTYPE_PROMETHEUS)"
    insertEnableSvcAll sysutils "$FMLNAME_INFLUXDB" $USERTYPE_INFLUXDB "https://$SUB_INFLUXDB.$HOMESERVER_DOMAIN" "influxdb.png" "$(getHeimdallOrderFromSub $SUB_INFLUXDB $USERTYPE_INFLUXDB)"
    restartAllCaddyContainers
  fi
}

function outputConfigSysUtils()
{
  cat <<EOFGF > $HOME/sysutils-compose-tmp.yml

services:
  grafana:
    image: $(getScriptImageByContainerName grafana)
    container_name: grafana
    hostname: grafana
    user: "$UID"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-sysutils-net
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "127.0.0.1:6565:3000"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-sysutils-grafana:/var/lib/grafana
    environment:
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SECURITY_ADMIN_USER=$GRAFANA_ADMIN_USERNAME
      - GF_SECURITY_ADMIN_PASSWORD=$GRAFANA_ADMIN_PASSWORD
      - GF_INSTALL_PLUGINS=grafana-piechart-panel,grafana-clock-panel,grafana-simple-json-datasource

  prometheus:
    image: $(getScriptImageByContainerName prometheus)
    container_name: prometheus
    hostname: prometheus
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - int-sysutils-net
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${HSHQ_STACKS_DIR}/sysutils/prometheus:/etc/prometheus
      - v-sysutils-prometheus:/prometheus
      
  node-exporter:
    image: $(getScriptImageByContainerName node-exporter)
    container_name: node-exporter
    hostname: node-exporter
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    user: "0:0"
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|var/lib/docker/(containers|devicemapper|volumes)/.+)(\$\$|/)'
    networks:
      - int-sysutils-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

  influxdb:
    image: $(getScriptImageByContainerName influxdb)
    container_name: influxdb
    hostname: influxdb
    user: "$USERID"
    restart: unless-stopped
    command:
      - '--reporting-disabled'
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_SSL_DIR}/influxdb.crt:/certs/influxdb.crt
      - ${HSHQ_SSL_DIR}/influxdb.key:/certs/influxdb.key
      - ${HSHQ_STACKS_DIR}/sysutils/influxdb/etc:/etc/influxdb2
      - ${HSHQ_STACKS_DIR}/sysutils/influxdb/var:/var/lib/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=$INFLUXDB_ADMIN_USERNAME
      - DOCKER_INFLUXDB_INIT_PASSWORD=$INFLUXDB_ADMIN_PASSWORD
      - DOCKER_INFLUXDB_INIT_ORG=$INFLUXDB_ORG
      - DOCKER_INFLUXDB_INIT_BUCKET=$INFLUXDB_HA_BUCKET
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=$INFLUXDB_TOKEN
      - INFLUXD_TLS_CERT=/certs/influxdb.crt
      - INFLUXD_TLS_KEY=/certs/influxdb.key

volumes:
  v-sysutils-grafana:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_STACKS_DIR}/sysutils/grafana
  v-sysutils-prometheus:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_NONBACKUP_DIR}/sysutils/prometheus

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  int-sysutils-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFGF

  cat <<EOFGF > $HOME/sysutils-compose.yml
$STACK_VERSION_PREFIX sysutils $(getScriptStackVersion sysutils)

services:
  grafana:
    image: $(getScriptImageByContainerName grafana)
    container_name: grafana
    hostname: grafana
    user: "\${UID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-sysutils-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-sysutils-grafana:/var/lib/grafana

  prometheus:
    image: $(getScriptImageByContainerName prometheus)
    container_name: prometheus
    hostname: prometheus
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - int-sysutils-net
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/sysutils/prometheus:/etc/prometheus
      - v-sysutils-prometheus:/prometheus
      
  node-exporter:
    image: $(getScriptImageByContainerName node-exporter)
    container_name: node-exporter
    hostname: node-exporter
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    user: "0:0"
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|var/lib/docker/(containers|devicemapper|volumes)/.+)(\$\$|/)'
    networks:
      - int-sysutils-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

  influxdb:
    image: $(getScriptImageByContainerName influxdb)
    container_name: influxdb
    hostname: influxdb
    user: "\${UID}"
    restart: unless-stopped
    env_file: stack.env
    command:
      - '--reporting-disabled'
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/influxdb.crt:/certs/influxdb.crt
      - \${HSHQ_SSL_DIR}/influxdb.key:/certs/influxdb.key
      - \${HSHQ_STACKS_DIR}/sysutils/influxdb/etc:/etc/influxdb2
      - \${HSHQ_STACKS_DIR}/sysutils/influxdb/var:/var/lib/influxdb2

volumes:
  v-sysutils-grafana:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/sysutils/grafana
  v-sysutils-prometheus:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/sysutils/prometheus

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  int-sysutils-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFGF

  cat <<EOFGF > $HOME/sysutils.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
INFLUXD_TLS_CERT=/certs/influxdb.crt
INFLUXD_TLS_KEY=/certs/influxdb.key
EOFGF

  cat <<EOFPM > $HSHQ_STACKS_DIR/sysutils/prometheus/prometheus.yml
global:
  scrape_interval: 15s
scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
  - job_name: docker
    static_configs:
      - targets: ["host.docker.internal:$DOCKER_METRICS_PORT"]
EOFPM

  cat <<EOFJS > $HOME/gfdashboard.json
{
	"dashboard": {
		"annotations": {
			"list": [
				{
					"builtIn": 1,
					"datasource": "-- Grafana --",
					"enable": true,
					"hide": true,
					"iconColor": "rgba(0, 211, 255, 1)",
					"name": "Annotations & Alerts",
					"target": {
						"limit": 100,
						"matchAny": false,
						"tags": [],
						"type": "dashboard"
					},
					"type": "dashboard"
				}
			]
		},
		"description": "CPU/Memory/Disk IO/Network/Temperature and other monitoring indicators.",
		"editable": true,
		"fiscalYearStartMonth": 0,
		"gnetId": 9893,
		"graphTooltip": 0,
		"id": null,
		"iteration": 1645129641574,
		"links": [],
		"liveNow": false,
		"panels": [
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"decimals": 1,
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "green",
									"value": null
								},
								{
									"color": "red",
									"value": 80
								}
							]
						},
						"unit": "s"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 2,
					"x": 0,
					"y": 1
				},
				"hideTimeOverride": true,
				"id": 15,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"colorMode": "none",
					"graphMode": "none",
					"justifyMode": "auto",
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"textMode": "auto"
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "time() - node_boot_time_seconds{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": false,
						"instant": true,
						"intervalFactor": 2,
						"refId": "A",
						"step": 40
					}
				],
				"title": "Uptime",
				"type": "stat"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "green",
									"value": null
								},
								{
									"color": "red",
									"value": 80
								}
							]
						},
						"unit": "short"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 2,
					"w": 2,
					"x": 2,
					"y": 1
				},
				"id": 14,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"colorMode": "none",
					"graphMode": "none",
					"justifyMode": "auto",
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"textMode": "auto"
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "count(count(node_cpu_seconds_total{instance=~\"\$node\", mode='system'}) by (cpu))",
						"format": "time_series",
						"instant": true,
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "A",
						"step": 20
					}
				],
				"title": "CPU Count",
				"type": "stat"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"decimals": 2,
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"max": 100,
						"min": 0,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 50
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 80
								}
							]
						},
						"unit": "percent"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 3,
					"x": 4,
					"y": 1
				},
				"id": 167,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "100 - (avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"idle\"}[5m])) * 100)",
						"format": "time_series",
						"hide": false,
						"interval": "",
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "A",
						"step": 20
					}
				],
				"title": "CPU Usage（5m）",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"decimals": 2,
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"max": 100,
						"min": 0,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 20
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 50
								}
							]
						},
						"unit": "percent"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 3,
					"x": 7,
					"y": 1
				},
				"id": 20,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"iowait\"}[5m])) * 100",
						"format": "time_series",
						"hide": false,
						"interval": "",
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "A",
						"step": 20
					}
				],
				"title": "CPU IO Wait（5m）",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"decimals": 0,
						"mappings": [],
						"max": 100,
						"min": 0,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 80
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 90
								}
							]
						},
						"unit": "percent"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 3,
					"x": 10,
					"y": 1
				},
				"hideTimeOverride": false,
				"id": 172,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "(1 - (node_memory_MemAvailable_bytes{instance=~\"\$node\"} / (node_memory_MemTotal_bytes{instance=~\"\$node\"})))* 100",
						"format": "time_series",
						"hide": false,
						"interval": "10s",
						"intervalFactor": 1,
						"refId": "A",
						"step": 20
					}
				],
				"title": "Memory Usage",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"decimals": 2,
						"mappings": [],
						"min": 0,
						"max": 100000,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 60000
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 80000
								}
							]
						},
						"unit": "short"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 3,
					"x": 13,
					"y": 1
				},
				"hideTimeOverride": false,
				"id": 16,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "node_filefd_allocated{instance=~\"\$node\"}",
						"format": "time_series",
						"instant": false,
						"interval": "10s",
						"intervalFactor": 1,
						"refId": "B"
					}
				],
				"title": "Open File Descriptors",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"max": 100,
						"min": 0,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 70
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 90
								}
							]
						},
						"unit": "percent"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 4,
					"x": 16,
					"y": 1
				},
				"id": 166,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"repeatDirection": "h",
				"targets": [
					{
						"expr": "100 - ((node_filesystem_avail_bytes{instance=~\"\$node\",mountpoint=\"/\",fstype=~\"ext4|xfs\"} * 100) / node_filesystem_size_bytes {instance=~\"\$node\",mountpoint=\"/\",fstype=~\"ext4|xfs\"})",
						"format": "time_series",
						"interval": "10s",
						"intervalFactor": 1,
						"refId": "A",
						"step": 20
					}
				],
				"title": "Root Partition Usage",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "Get the largest partition by the variable maxmount. ",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"max": 100,
						"min": 0,
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "rgba(50, 172, 45, 0.97)",
									"value": null
								},
								{
									"color": "rgba(237, 129, 40, 0.89)",
									"value": 70
								},
								{
									"color": "rgba(245, 54, 54, 0.9)",
									"value": 90
								}
							]
						},
						"unit": "percent"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 5,
					"w": 4,
					"x": 20,
					"y": 1
				},
				"id": 154,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"showThresholdLabels": false,
					"showThresholdMarkers": true
				},
				"pluginVersion": "8.3.4",
				"repeatDirection": "h",
				"targets": [
					{
						"expr": "100 - ((node_filesystem_avail_bytes{instance=~\"\$node\",mountpoint=\"\$maxmount\",fstype=~\"ext4|xfs\"} * 100) / node_filesystem_size_bytes {instance=~\"\$node\",mountpoint=\"\$maxmount\",fstype=~\"ext4|xfs\"})",
						"format": "time_series",
						"interval": "10s",
						"intervalFactor": 1,
						"refId": "A",
						"step": 20
					}
				],
				"title": "Maximum Partition (\$maxmount) Usage",
				"type": "gauge"
			},
			{
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "",
				"fieldConfig": {
					"defaults": {
						"color": {
							"mode": "thresholds"
						},
						"mappings": [
							{
								"options": {
									"match": "null",
									"result": {
										"text": "N/A"
									}
								},
								"type": "special"
							}
						],
						"thresholds": {
							"mode": "absolute",
							"steps": [
								{
									"color": "green",
									"value": null
								},
								{
									"color": "red",
									"value": 80
								}
							]
						},
						"unit": "bytes"
					},
					"overrides": []
				},
				"gridPos": {
					"h": 3,
					"w": 2,
					"x": 2,
					"y": 3
				},
				"id": 75,
				"links": [],
				"maxDataPoints": 100,
				"options": {
					"colorMode": "none",
					"graphMode": "none",
					"justifyMode": "auto",
					"orientation": "horizontal",
					"reduceOptions": {
						"calcs": [
							"lastNotNull"
						],
						"fields": "",
						"values": false
					},
					"textMode": "auto"
				},
				"pluginVersion": "8.3.4",
				"targets": [
					{
						"expr": "node_memory_MemTotal_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"instant": true,
						"intervalFactor": 1,
						"legendFormat": "{{instance}}",
						"refId": "A",
						"step": 20
					}
				],
				"title": "Total RAM",
				"type": "stat"
			},
			{
				"aliasColors": {
					"1 minute": "#BF1B00",
					"15 minutes": "#6ED0E0",
					"5 minutes": "#CCA300"
				},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"editable": true,
				"error": false,
				"fill": 1,
				"fillGradient": 0,
				"grid": {},
				"gridPos": {
					"h": 6,
					"w": 11,
					"x": 0,
					"y": 6
				},
				"height": "300",
				"hiddenSeries": false,
				"id": 13,
				"legend": {
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"max": true,
					"min": false,
					"rightSide": true,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 2,
				"links": [],
				"maxPerRow": 6,
				"nullPointMode": "null as zero",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "node_load1{instance=~\"\$node\"}",
						"format": "time_series",
						"instant": false,
						"interval": "10s",
						"intervalFactor": 2,
						"legendFormat": "1m",
						"metric": "",
						"refId": "A",
						"step": 20,
						"target": ""
					},
					{
						"expr": "node_load5{instance=~\"\$node\"}",
						"format": "time_series",
						"instant": false,
						"interval": "10s",
						"intervalFactor": 2,
						"legendFormat": "5m",
						"refId": "B",
						"step": 20
					},
					{
						"expr": "node_load15{instance=~\"\$node\"}",
						"format": "time_series",
						"instant": false,
						"interval": "10s",
						"intervalFactor": 2,
						"legendFormat": "15m",
						"refId": "C",
						"step": 20
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Average System Load",
				"tooltip": {
					"msResolution": false,
					"shared": true,
					"sort": 0,
					"value_type": "cumulative"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "short",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": true
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"/": "#eab839",
					"/boot": "#bf1b00",
					"/data": "#1f78c1"
				},
				"breakPoint": "100%",
				"combine": {
					"label": "Others",
					"threshold": ""
				},
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"decimals": 1,
				"fontSize": "50%",
				"format": "bytes",
				"gridPos": {
					"h": 6,
					"w": 5,
					"x": 11,
					"y": 6
				},
				"hideTimeOverride": false,
				"id": 171,
				"legend": {
					"header": "",
					"percentage": false,
					"percentageDecimals": 0,
					"show": true,
					"sideWidth": 142,
					"values": true
				},
				"legendType": "Right side",
				"links": [],
				"maxDataPoints": 3,
				"nullPointMode": "connected",
				"pieType": "pie",
				"strokeWidth": "2",
				"targets": [
					{
						"expr": "node_filesystem_size_bytes {instance=~\"\$node\",fstype=~\"ext4|xfs\"}",
						"format": "time_series",
						"instant": true,
						"interval": "10s",
						"intervalFactor": 1,
						"legendFormat": "{{mountpoint}}",
						"refId": "A"
					}
				],
				"title": "Total Disk Space",
				"type": "grafana-piechart-panel",
				"valueName": "current"
			},
			{
				"columns": [],
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"fontSize": "120%",
				"gridPos": {
					"h": 6,
					"w": 8,
					"x": 16,
					"y": 6
				},
				"id": 164,
				"links": [],
				"scroll": true,
				"showHeader": true,
				"sort": {
					"col": 11,
					"desc": true
				},
				"styles": [
					{
						"alias": "Time",
						"align": "auto",
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"pattern": "Time",
						"type": "hidden"
					},
					{
						"alias": "Partition",
						"align": "auto",
						"colors": [
							"rgba(50, 172, 45, 0.97)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(245, 54, 54, 0.9)"
						],
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"decimals": 2,
						"mappingType": 1,
						"pattern": "mountpoint",
						"thresholds": [
							""
						],
						"type": "string",
						"unit": "bytes"
					},
					{
						"alias": "Available space",
						"align": "auto",
						"colorMode": "value",
						"colors": [
							"rgba(245, 54, 54, 0.9)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(50, 172, 45, 0.97)"
						],
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"decimals": 2,
						"mappingType": 1,
						"pattern": "Value #A",
						"thresholds": [
							"10000000000",
							"20000000000"
						],
						"type": "number",
						"unit": "bytes"
					},
					{
						"alias": "Usage rate",
						"align": "auto",
						"colorMode": "cell",
						"colors": [
							"rgba(50, 172, 45, 0.97)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(245, 54, 54, 0.9)"
						],
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"decimals": 2,
						"mappingType": 1,
						"pattern": "Value #B",
						"thresholds": [
							"70",
							"90"
						],
						"type": "number",
						"unit": "percentunit"
					},
					{
						"alias": "Total space",
						"align": "auto",
						"colors": [
							"rgba(245, 54, 54, 0.9)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(50, 172, 45, 0.97)"
						],
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"decimals": 1,
						"link": false,
						"mappingType": 1,
						"pattern": "Value #C",
						"thresholds": [],
						"type": "number",
						"unit": "bytes"
					},
					{
						"alias": "File system",
						"align": "auto",
						"colors": [
							"rgba(245, 54, 54, 0.9)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(50, 172, 45, 0.97)"
						],
						"dateFormat": "YYYY-MM-DD HH:mm:ss",
						"decimals": 2,
						"link": false,
						"mappingType": 1,
						"pattern": "fstype",
						"thresholds": [],
						"type": "number",
						"unit": "short"
					},
					{
						"alias": "",
						"align": "auto",
						"colors": [
							"rgba(245, 54, 54, 0.9)",
							"rgba(237, 129, 40, 0.89)",
							"rgba(50, 172, 45, 0.97)"
						],
						"decimals": 2,
						"pattern": "/.*/",
						"preserveFormat": true,
						"sanitize": false,
						"thresholds": [],
						"type": "hidden",
						"unit": "short"
					}
				],
				"targets": [
					{
						"expr": "node_filesystem_size_bytes{instance=~'\$node',fstype=~\"ext4|xfs\"}",
						"format": "table",
						"hide": true,
						"instant": true,
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "C"
					},
					{
						"expr": "node_filesystem_avail_bytes {instance=~'\$node',fstype=~\"ext4|xfs\"}",
						"format": "table",
						"hide": false,
						"instant": true,
						"interval": "10s",
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "A"
					},
					{
						"expr": "1-(node_filesystem_free_bytes{instance=~'\$node',fstype=~\"ext4|xfs\"} / node_filesystem_size_bytes{instance=~'\$node',fstype=~\"ext4|xfs\"})",
						"format": "table",
						"hide": false,
						"instant": true,
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "B"
					},
					{
						"expr": "",
						"format": "table",
						"interval": "10s",
						"intervalFactor": 1,
						"legendFormat": "",
						"refId": "D"
					}
				],
				"title": "Free Space by Partition",
				"transform": "table",
				"type": "table-old"
			},
			{
				"aliasColors": {
					"Disk consumption in I/O operations": "#ba43a9",
					"Idle - Waiting for something to happen": "#052B51",
					"guest": "#9AC48A",
					"idle": "#052B51",
					"iowait": "#EAB839",
					"irq": "#BF1B00",
					"nice": "#C15C17",
					"sdb_% I/O operations per second": "#d683ce",
					"softirq": "#E24D42",
					"steal": "#FCE2DE",
					"system": "#508642",
					"user": "#5195CE"
				},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"decimals": 2,
				"description": "node_disk_io_time_seconds_total：\nThe number of milliseconds the disk spends on input/output operations. This value is the accumulated value.（Milliseconds Spent Doing I/Os）\n\nirate(node_disk_io_time_seconds_total[1m])：\nCalculate the rate per second: (last value - last previous value) / timestamp difference, that is, the percentage of time that the disk spends on I/O operations in 1 second.",
				"fill": 1,
				"fillGradient": 0,
				"gridPos": {
					"h": 7,
					"w": 16,
					"x": 0,
					"y": 12
				},
				"hiddenSeries": false,
				"id": 7,
				"legend": {
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": true,
					"min": false,
					"rightSide": true,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 1,
				"links": [],
				"maxPerRow": 6,
				"nullPointMode": "null",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"system\"}[1m]))",
						"format": "time_series",
						"interval": "",
						"intervalFactor": 2,
						"legendFormat": "System",
						"refId": "A",
						"step": 20
					},
					{
						"expr": "avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"user\"}[1m]))",
						"format": "time_series",
						"intervalFactor": 2,
						"legendFormat": "User",
						"refId": "B",
						"step": 240
					},
					{
						"expr": "avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"idle\"}[1m]))",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 2,
						"legendFormat": "Idle",
						"refId": "F",
						"step": 240
					},
					{
						"expr": "avg(irate(node_cpu_seconds_total{instance=~\"\$node\",mode=\"iowait\"}[1m]))",
						"format": "time_series",
						"intervalFactor": 2,
						"legendFormat": "Iowait",
						"refId": "D",
						"step": 240
					},
					{
						"expr": "irate(node_disk_io_time_seconds_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "{{device}}_% of I/O operations per second",
						"refId": "C"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "CPU Usage, Disk I/O Operations Per Second （%）",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "percentunit",
						"label": "",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": false
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"Available": "#9ac48a",
					"Memory_Avaliable": "#6ED0E0",
					"Memory_Cached": "#EF843C",
					"Memory_Free": "#629E51",
					"Memory_Total": "#6d1f62",
					"Memory_Used": "#eab839",
					"Total memory": "#bf1b00"
				},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"decimals": 2,
				"fill": 6,
				"fillGradient": 0,
				"gridPos": {
					"h": 7,
					"w": 8,
					"x": 16,
					"y": 12
				},
				"height": "300",
				"hiddenSeries": false,
				"id": 156,
				"legend": {
					"alignAsTable": false,
					"avg": false,
					"current": true,
					"max": false,
					"min": false,
					"rightSide": false,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 3,
				"links": [],
				"nullPointMode": "null",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "node_memory_MemTotal_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": false,
						"instant": false,
						"intervalFactor": 2,
						"legendFormat": "Total memory",
						"refId": "A",
						"step": 4
					},
					{
						"expr": "node_memory_MemTotal_bytes{instance=~\"\$node\"} - node_memory_MemAvailable_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": false,
						"intervalFactor": 2,
						"legendFormat": "used",
						"refId": "B",
						"step": 4
					},
					{
						"expr": "node_memory_MemFree_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 2,
						"legendFormat": "Memory_Free",
						"refId": "C",
						"step": 4
					},
					{
						"expr": "node_memory_Buffers_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 2,
						"legendFormat": "Memory_Buffers",
						"refId": "D",
						"step": 4
					},
					{
						"expr": "node_memory_Cached_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 2,
						"legendFormat": "Memory_Cached",
						"refId": "E",
						"step": 4
					},
					{
						"expr": "node_memory_MemAvailable_bytes{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": false,
						"interval": "",
						"intervalFactor": 2,
						"legendFormat": "Available",
						"refId": "F",
						"step": 4
					},
					{
						"expr": "node_memory_MemTotal_bytes{instance=~\"\$node\"} - (node_memory_Cached_bytes{instance=~\"\$node\"} + node_memory_Buffers_bytes{instance=~\"\$node\"} + node_memory_MemFree_bytes{instance=~\"\$node\"})",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 1,
						"refId": "G"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Memory information",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "bytes",
						"logBase": 1,
						"min": "0",
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": true
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"vda_write": "#6ED0E0"
				},
				"bars": true,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "Reads completed: Reads per second per disk partition\n\nWrites completed: Number of writes per second per disk partition\n\nIO now Number of input/output requests being processed per disk partition per second",
				"fill": 2,
				"fillGradient": 0,
				"gridPos": {
					"h": 8,
					"w": 8,
					"x": 0,
					"y": 19
				},
				"height": "300",
				"hiddenSeries": false,
				"id": 161,
				"legend": {
					"alignAsTable": false,
					"avg": false,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": true,
					"min": false,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": false,
				"linewidth": 1,
				"links": [],
				"nullPointMode": "null",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [
					{
						"alias": "/.*_read \$/",
						"transform": "negative-Y"
					}
				],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "irate(node_disk_reads_completed_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": false,
						"interval": "",
						"intervalFactor": 2,
						"legendFormat": "{{device}}_read",
						"refId": "A",
						"step": 10
					},
					{
						"expr": "irate(node_disk_writes_completed_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": false,
						"intervalFactor": 2,
						"legendFormat": "{{device}}_write",
						"refId": "B",
						"step": 10
					},
					{
						"expr": "node_disk_io_now{instance=~\"\$node\"}",
						"format": "time_series",
						"hide": true,
						"interval": "",
						"intervalFactor": 1,
						"legendFormat": "{{device}}",
						"refId": "C"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Disk Read and Write Rate （IOPS）",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "iops",
						"label": "Read (-) / write（+）I/O ops/sec",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": true
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"vda_write": "#6ED0E0"
				},
				"bars": true,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "Read bytes The number of bits read per second per disk partition\nWritten bytes The number of bits written per second per disk partition",
				"fill": 2,
				"fillGradient": 0,
				"gridPos": {
					"h": 8,
					"w": 8,
					"x": 8,
					"y": 19
				},
				"height": "300",
				"hiddenSeries": false,
				"id": 168,
				"legend": {
					"alignAsTable": false,
					"avg": false,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": true,
					"min": false,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": false,
				"linewidth": 1,
				"links": [],
				"nullPointMode": "null",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [
					{
						"alias": "/.*_read \$/",
						"transform": "negative-Y"
					}
				],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "irate(node_disk_read_bytes_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"interval": "",
						"intervalFactor": 2,
						"legendFormat": "{{device}}_read",
						"refId": "A",
						"step": 10
					},
					{
						"expr": "irate(node_disk_written_bytes_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": false,
						"intervalFactor": 2,
						"legendFormat": "{{device}}_write",
						"refId": "B",
						"step": 10
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Disk Read and Write Capacity",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "Bps",
						"label": "Read (-) / write (+)",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": false
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"vda": "#6ED0E0"
				},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "Read time ms Number of seconds per disk partition read operation\n\nWrite time ms Number of seconds spent per disk partition write operation\n\nIO time ms Number of seconds spent per disk partition input/output operation\n\n IO time weighted Weighted seconds spent per disk partition input/output operation",
				"fill": 3,
				"fillGradient": 0,
				"gridPos": {
					"h": 8,
					"w": 8,
					"x": 16,
					"y": 19
				},
				"height": "300",
				"hiddenSeries": false,
				"id": 160,
				"legend": {
					"alignAsTable": false,
					"avg": false,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": true,
					"min": false,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 1,
				"links": [],
				"nullPointMode": "null",
				"options": {
					"alertThreshold": true
				},
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [
					{
						"alias": "/,*_read \$/",
						"transform": "negative-Y"
					}
				],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "irate(node_disk_io_time_seconds_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": true,
						"interval": "",
						"intervalFactor": 2,
						"legendFormat": "{{device}}",
						"refId": "A",
						"step": 10
					},
					{
						"expr": "irate(node_disk_io_time_weighted_seconds_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": true,
						"intervalFactor": 1,
						"legendFormat": "{{device}}_weighted",
						"refId": "D"
					},
					{
						"expr": "irate(node_disk_read_time_seconds_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": false,
						"interval": "",
						"intervalFactor": 1,
						"legendFormat": "{{device}}_read",
						"refId": "B"
					},
					{
						"expr": "irate(node_disk_write_time_seconds_total{instance=~\"\$node\"}[1m])",
						"format": "time_series",
						"hide": false,
						"intervalFactor": 1,
						"legendFormat": "{{device}}_write",
						"refId": "C"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Disk IO Read and Write Time",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "s",
						"label": "Read (-) / write (+) ",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": false
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"fill": 1,
				"gridPos": {
					"h": 8,
					"w": 12,
					"x": 0,
					"y": 27
				},
				"height": "300",
				"id": 157,
				"legend": {
					"alignAsTable": false,
					"avg": false,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": false,
					"min": false,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 2,
				"links": [],
				"nullPointMode": "null",
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [
					{
						"alias": "/.*_out upload \$/",
						"transform": "negative-Y"
					}
				],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "irate(node_network_receive_bytes_total{instance=~'\$node',device!~'tap.*'}[5m])*8",
						"format": "time_series",
						"intervalFactor": 2,
						"legendFormat": "{{device}}_in download",
						"refId": "A",
						"step": 4
					},
					{
						"expr": "irate(node_network_transmit_bytes_total{instance=~'\$node',device!~'tap.*'}[5m])*8",
						"format": "time_series",
						"intervalFactor": 2,
						"legendFormat": "{{device}}_out upload",
						"refId": "B",
						"step": 4
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Network Traffic",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "bps",
						"label": "Upload (-) / Download（+）",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": false
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {
					"TCP": "#6ED0E0"
				},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"description": "CurrEstab - TCP connections with current state ESTABLISHED or CLOSE-WAIT\n\nActiveOpens - TCP average connections that have been converted from CLOSED state to SYN-SENT state (within 1 minute)\n\nPassiveOpens - Directly from LISTEN state The average number of TCP connections to SYN-RCVD state (within 1 minute)\n\nTCP_all oc - the number of TCP sockets allocated (established, applied to sk_buff)\n\nTCP_inuse - in use (listening The number of TCP sockets \n\nTCP_tw - the number of TCP connections waiting to be closed",
				"fill": 0,
				"gridPos": {
					"h": 8,
					"w": 12,
					"x": 12,
					"y": 27
				},
				"height": "300",
				"id": 158,
				"legend": {
					"alignAsTable": true,
					"avg": false,
					"current": true,
					"max": true,
					"min": false,
					"rightSide": true,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 1,
				"links": [],
				"nullPointMode": "null",
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "node_netstat_Tcp_CurrEstab{instance=~'\$node'}",
						"format": "time_series",
						"hide": false,
						"interval": "10s",
						"intervalFactor": 1,
						"legendFormat": "ESTABLISHED",
						"refId": "A",
						"step": 20
					},
					{
						"expr": "node_sockstat_TCP_tw{instance=~'\$node'}",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "TCP_tw",
						"refId": "D"
					},
					{
						"expr": "irate(node_netstat_Tcp_ActiveOpens{instance=~'\$node'}[1m])",
						"format": "time_series",
						"hide": false,
						"intervalFactor": 1,
						"legendFormat": "ActiveOpens",
						"refId": "B"
					},
					{
						"expr": "irate(node_netstat_Tcp_PassiveOpens{instance=~'\$node'}[1m])",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "PassiveOpens",
						"refId": "C"
					},
					{
						"expr": "node_sockstat_TCP_alloc{instance=~'\$node'}",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "TCP_alloc",
						"refId": "E"
					},
					{
						"expr": "node_sockstat_TCP_inuse{instance=~'\$node'}",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "TCP_inuse",
						"refId": "F"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "TCP Connections",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "short",
						"logBase": 1,
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"show": true
					}
				],
				"yaxis": {
					"align": false
				}
			},
			{
				"aliasColors": {},
				"bars": false,
				"dashLength": 10,
				"dashes": false,
				"datasource": {
					"type": "prometheus",
					"uid": "$gf_dataset_uid"
				},
				"fill": 0,
				"gridPos": {
					"h": 10,
					"w": 24,
					"x": 0,
					"y": 35
				},
				"id": 169,
				"legend": {
					"alignAsTable": true,
					"avg": true,
					"current": true,
					"hideEmpty": true,
					"hideZero": true,
					"max": true,
					"min": false,
					"rightSide": true,
					"show": true,
					"total": false,
					"values": true
				},
				"lines": true,
				"linewidth": 1,
				"links": [],
				"nullPointMode": "null as zero",
				"percentage": false,
				"pluginVersion": "8.3.4",
				"pointradius": 0.5,
				"points": false,
				"renderer": "flot",
				"seriesOverrides": [],
				"spaceLength": 10,
				"stack": false,
				"steppedLine": false,
				"targets": [
					{
						"expr": "node_hwmon_temp_celsius{instance=\"\$node\"}",
						"format": "time_series",
						"intervalFactor": 1,
						"legendFormat": "{{chip}} {{sensor}}",
						"refId": "A"
					}
				],
				"thresholds": [],
				"timeRegions": [],
				"title": "Hardware Temperature",
				"tooltip": {
					"shared": true,
					"sort": 0,
					"value_type": "individual"
				},
				"type": "graph",
				"xaxis": {
					"mode": "time",
					"show": true,
					"values": []
				},
				"yaxes": [
					{
						"format": "celsius",
						"logBase": 1,
						"min": "0",
						"show": true
					},
					{
						"format": "short",
						"logBase": 1,
						"min": "0",
						"show": true
					}
				],
				"yaxis": {
					"align": false
				}
			}
		],
		"refresh": "5s",
		"schemaVersion": 34,
		"style": "dark",
		"tags": [
			"StarsL",
			"Prometheus"
		],
		"templating": {
			"list": [
				{
					"auto": true,
					"auto_count": 30,
					"auto_min": "10s",
					"current": {
						"selected": false,
						"text": "auto",
						"value": "\$__auto_interval_interval"
					},
					"hide": 0,
					"label": "interval",
					"name": "interval",
					"options": [
						{
							"selected": true,
							"text": "auto",
							"value": "\$__auto_interval_interval"
						},
						{
							"selected": false,
							"text": "1m",
							"value": "1m"
						},
						{
							"selected": false,
							"text": "10m",
							"value": "10m"
						},
						{
							"selected": false,
							"text": "30m",
							"value": "30m"
						},
						{
							"selected": false,
							"text": "1h",
							"value": "1h"
						},
						{
							"selected": false,
							"text": "6h",
							"value": "6h"
						},
						{
							"selected": false,
							"text": "12h",
							"value": "12h"
						},
						{
							"selected": false,
							"text": "1d",
							"value": "1d"
						},
						{
							"selected": false,
							"text": "7d",
							"value": "7d"
						},
						{
							"selected": false,
							"text": "14d",
							"value": "14d"
						},
						{
							"selected": false,
							"text": "30d",
							"value": "30d"
						}
					],
					"query": "1m,10m,30m,1h,6h,12h,1d,7d,14d,30d",
					"refresh": 2,
					"skipUrlSync": false,
					"type": "interval"
				},
				{
					"allFormat": "glob",
					"current": {},
					"datasource": {
						"type": "prometheus",
						"uid": "$gf_dataset_uid"
					},
					"definition": "",
					"hide": 0,
					"includeAll": false,
					"label": "surroundings",
					"multi": false,
					"multiFormat": "regex values",
					"name": "env",
					"options": [],
					"query": {
						"query": "label_values(node_exporter_build_info,env)",
						"refId": "Prometheus-env-Variable-Query"
					},
					"refresh": 1,
					"regex": "",
					"skipUrlSync": false,
					"sort": 1,
					"tagValuesQuery": "",
					"tagsQuery": "",
					"type": "query",
					"useTags": false
				},
				{
					"allFormat": "glob",
					"current": {},
					"datasource": {
						"type": "prometheus",
						"uid": "$gf_dataset_uid"
					},
					"definition": "",
					"hide": 0,
					"includeAll": false,
					"label": "CPU name",
					"multi": false,
					"multiFormat": "regex values",
					"name": "name",
					"options": [],
					"query": {
						"query": "label_values(node_exporter_build_info{env='\$env'},name)",
						"refId": "Prometheus-name-Variable-Query"
					},
					"refresh": 1,
					"regex": "",
					"skipUrlSync": false,
					"sort": 1,
					"tagValuesQuery": "",
					"tagsQuery": "",
					"type": "query",
					"useTags": false
				},
				{
					"allFormat": "glob",
					"current": {},
					"datasource": {
						"type": "prometheus",
						"uid": "$gf_dataset_uid"
					},
					"definition": "",
					"hide": 0,
					"includeAll": false,
					"label": "node",
					"multi": false,
					"multiFormat": "regex values",
					"name": "node",
					"options": [],
					"query": {
						"query": "label_values(node_exporter_build_info{name='\$name'},instance)",
						"refId": "Prometheus-node-Variable-Query"
					},
					"refresh": 1,
					"regex": "",
					"skipUrlSync": false,
					"sort": 1,
					"tagValuesQuery": "",
					"tagsQuery": "",
					"type": "query",
					"useTags": false
				},
				{
					"current": {},
					"datasource": {
						"type": "prometheus",
						"uid": "$gf_dataset_uid"
					},
					"definition": "",
					"hide": 2,
					"includeAll": false,
					"label": "",
					"multi": false,
					"name": "maxmount",
					"options": [],
					"query": {
						"query": "query_result(topk(1,sort_desc (max(node_filesystem_size_bytes{instance=~'\$node',fstype=~\"ext4|xfs\"}) by (mountpoint))))",
						"refId": "Prometheus-maxmount-Variable-Query"
					},
					"refresh": 1,
					"regex": "/.*\\\\\\"(.*)\\\\\\".*/",
					"skipUrlSync": false,
					"sort": 0,
					"tagValuesQuery": "",
					"tagsQuery": "",
					"type": "query",
					"useTags": false
				}
			]
		},
		"time": {
			"from": "now-1h",
			"to": "now"
		},
		"timepicker": {
			"now": true,
			"refresh_intervals": [
				"5s",
				"10s",
				"30s",
				"1m",
				"5m",
				"15m",
				"30m",
				"1h",
				"2h",
				"1d"
			],
			"time_options": [
				"5m",
				"15m",
				"1h",
				"6h",
				"12h",
				"24h",
				"2d",
				"7d",
				"30d"
			]
		},
		"timezone": "browser",
		"title": "System Metrics",
		"uid": "$gf_dashboard_uid",
		"version": 1,
		"weekStart": ""
	}
}
EOFJS
}

function performUpdateSysUtils()
{
  perform_stack_name=sysutils
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=grafana/grafana-oss:9.5.8,prom/prometheus:v2.46.0,prom/node-exporter:v1.6.1,influxdb:2.7.1-alpine
      image_update_map[0]="grafana/grafana-oss:9.5.8,grafana/grafana-oss:10.3.4"
      image_update_map[1]="prom/prometheus:v2.46.0,prom/prometheus:v2.50.1"
      image_update_map[2]="prom/node-exporter:v1.6.1,prom/node-exporter:v1.7.0"
      image_update_map[3]="influxdb:2.7.1-alpine,influxdb:2.7.5-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAddPrometheusWeb false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v4
      curImageList=grafana/grafana-oss:9.5.15,prom/prometheus:v2.48.1,prom/node-exporter:v1.7.0,influxdb:2.7.4-alpine
      image_update_map[0]="grafana/grafana-oss:9.5.15,grafana/grafana-oss:10.3.4"
      image_update_map[1]="prom/prometheus:v2.48.1,prom/prometheus:v2.50.1"
      image_update_map[2]="prom/node-exporter:v1.7.0,prom/node-exporter:v1.7.0"
      image_update_map[3]="influxdb:2.7.4-alpine,influxdb:2.7.5-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAddPrometheusWeb false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v4
      curImageList=grafana/grafana-oss:10.3.1,prom/prometheus:v2.49.1,prom/node-exporter:v1.7.0,influxdb:2.7.5-alpine
      image_update_map[0]="grafana/grafana-oss:10.3.1,grafana/grafana-oss:10.3.4"
      image_update_map[1]="prom/prometheus:v2.49.1,prom/prometheus:v2.50.1"
      image_update_map[2]="prom/node-exporter:v1.7.0,prom/node-exporter:v1.7.0"
      image_update_map[3]="influxdb:2.7.5-alpine,influxdb:2.7.5-alpine"
    ;;
    4)
      # Let's increment the upgrade to v5, i.e. v1-v3 upgrades to v4, then v4 to v5.
      newVer=v6
      curImageList=grafana/grafana-oss:10.3.4,prom/prometheus:v2.50.1,prom/node-exporter:v1.7.0,influxdb:2.7.5-alpine
      image_update_map[0]="grafana/grafana-oss:10.3.4,grafana/grafana-oss:11.3.0"
      image_update_map[1]="prom/prometheus:v2.50.1,prom/prometheus:v2.55.0"
      image_update_map[2]="prom/node-exporter:v1.7.0,prom/node-exporter:v1.8.2"
      image_update_map[3]="influxdb:2.7.5-alpine,influxdb:2.7.10-alpine"
    ;;
    5)
      newVer=v6
      curImageList=grafana/grafana-oss:11.1.3,prom/prometheus:v2.53.1,prom/node-exporter:v1.8.2,influxdb:2.7.8-alpine
      image_update_map[0]="grafana/grafana-oss:11.1.3,grafana/grafana-oss:11.3.0"
      image_update_map[1]="prom/prometheus:v2.53.1,prom/prometheus:v2.55.0"
      image_update_map[2]="prom/node-exporter:v1.8.2,prom/node-exporter:v1.8.2"
      image_update_map[3]="influxdb:2.7.8-alpine,influxdb:2.7.10-alpine"
    ;;
    6)
      newVer=v7
      curImageList=grafana/grafana-oss:11.3.0,prom/prometheus:v2.55.0,prom/node-exporter:v1.8.2,influxdb:2.7.10-alpine
      image_update_map[0]="grafana/grafana-oss:11.3.0,grafana/grafana-oss:11.6.0"
      image_update_map[1]="prom/prometheus:v2.55.0,prom/prometheus:v3.2.1"
      image_update_map[2]="prom/node-exporter:v1.8.2,prom/node-exporter:v1.9.1"
      image_update_map[3]="influxdb:2.7.10-alpine,influxdb:2.7.11-alpine"
    ;;
    7)
      newVer=v7
      curImageList=grafana/grafana-oss:11.6.0,prom/prometheus:v3.2.1,prom/node-exporter:v1.9.1,influxdb:2.7.11-alpine
      image_update_map[0]="grafana/grafana-oss:11.6.0,grafana/grafana-oss:11.6.0"
      image_update_map[1]="prom/prometheus:v3.2.1,prom/prometheus:v3.2.1"
      image_update_map[2]="prom/node-exporter:v1.9.1,prom/node-exporter:v1.9.1"
      image_update_map[3]="influxdb:2.7.11-alpine,influxdb:2.7.11-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfAddPrometheusWeb()
{
  inner_block=""
  inner_block=$inner_block">>https://$SUB_PROMETHEUS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://prometheus:9090 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PROMETHEUS $MANAGETLS_PROMETHEUS true $NETDEFAULT_PROMETHEUS "$inner_block"
  insertEnableSvcAll sysutils "$FMLNAME_PROMETHEUS" $USERTYPE_PROMETHEUS "https://$SUB_PROMETHEUS.$HOMESERVER_DOMAIN" "prometheus.png" "$(getHeimdallOrderFromSub $SUB_PROMETHEUS $USERTYPE_PROMETHEUS)"
  restartAllCaddyContainers
  grep "job_name: docker" $HSHQ_STACKS_DIR/sysutils/prometheus/prometheus.yml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    tee -a $HSHQ_STACKS_DIR/sysutils/prometheus/prometheus.yml >/dev/null <<EOFPR
  - job_name: docker
    static_configs:
      - targets: ["host.docker.internal:$DOCKER_METRICS_PORT"]
EOFPR
  fi

  cat <<EOFGF > $HOME/sysutils-compose.yml
$STACK_VERSION_PREFIX sysutils $(getScriptStackVersion sysutils)

services:
  grafana:
    image: $(getScriptImageByContainerName grafana)
    container_name: grafana
    hostname: grafana
    user: "\${UID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-sysutils-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-sysutils-grafana:/var/lib/grafana

  prometheus:
    image: $(getScriptImageByContainerName prometheus)
    container_name: prometheus
    hostname: prometheus
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    networks:
      - int-sysutils-net
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/sysutils/prometheus:/etc/prometheus
      - v-sysutils-prometheus:/prometheus
      
  node-exporter:
    image: $(getScriptImageByContainerName node-exporter)
    container_name: node-exporter
    hostname: node-exporter
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    user: "0:0"
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|var/lib/docker/(containers|devicemapper|volumes)/.+)(\$\$|/)'
    networks:
      - int-sysutils-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro

  influxdb:
    image: $(getScriptImageByContainerName influxdb)
    container_name: influxdb
    hostname: influxdb
    user: "\${UID}"
    restart: unless-stopped
    env_file: stack.env
    command:
      - '--reporting-disabled'
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/influxdb.crt:/certs/influxdb.crt
      - \${HSHQ_SSL_DIR}/influxdb.key:/certs/influxdb.key
      - \${HSHQ_STACKS_DIR}/sysutils/influxdb/etc:/etc/influxdb2
      - \${HSHQ_STACKS_DIR}/sysutils/influxdb/var:/var/lib/influxdb2

volumes:
  v-sysutils-grafana:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/sysutils/grafana
  v-sysutils-prometheus:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/sysutils/prometheus

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  int-sysutils-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFGF

  # Too many edits to the compose file, just replace the whole darn thing...
  chmod 600 $HOME/sysutils-compose.yml
  sudo chown root:root $HOME/sysutils-compose.yml
  sudo mv $HOME/sysutils-compose.yml $upgrade_compose_file
}

# OpenLDAP
function installOpenLDAP()
{
  set +e
  is_integrate_hshq=$1
  # Only install if directory does not exist
  checkDeleteStackAndDirectory openldap "OpenLDAP"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: OpenLDAP directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName ldapserver)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain OpenLDAP Server docker image"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName ldapphp)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain OpenLDAP Manager docker image"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName ldapmanager)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain OpenLDAP PHP docker image"
    exit 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/openldap
  mkdir $HSHQ_STACKS_DIR/openldap/certs
  mkdir $HSHQ_STACKS_DIR/openldap/ldapserver
  mkdir $HSHQ_STACKS_DIR/openldap/ldapphp
  mkdir $HSHQ_STACKS_DIR/openldap/ldapmanager
  mkdir $HSHQ_STACKS_DIR/openldap/ldapserver/initconfig

  initServicesCredentials

  LDAP_URI="ldap://ldapserver:389"
  updateConfigVar LDAP_URI $LDAP_URI
  LDAPS_URI="ldaps://ldapserver:636"
  updateConfigVar LDAPS_URI $LDAPS_URI

  rm -f $HSHQ_SECRETS_DIR/ldap_admin_bind_dn.txt
  echo "$LDAP_ADMIN_BIND_DN" > $HSHQ_SECRETS_DIR/ldap_admin_bind_dn.txt
  chmod 0400 $HSHQ_SECRETS_DIR/ldap_admin_bind_dn.txt

  rm -f $HSHQ_SECRETS_DIR/ldap_admin_bind_password.txt
  echo "$LDAP_ADMIN_BIND_PASSWORD" > $HSHQ_SECRETS_DIR/ldap_admin_bind_password.txt
  chmod 0400 $HSHQ_SECRETS_DIR/ldap_admin_bind_password.txt

  if [ -z "$LDAP_READONLY_USER_USERNAME" ]; then
    LDAP_READONLY_USER_USERNAME=$ADMIN_USERNAME_BASE"_openldap_readonly"
    updateConfigVar LDAP_READONLY_USER_USERNAME $LDAP_READONLY_USER_USERNAME
  fi

  if [ -z "$LDAP_READONLY_USER_PASSWORD" ]; then
    LDAP_READONLY_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LDAP_READONLY_USER_PASSWORD $LDAP_READONLY_USER_PASSWORD
  fi
  rm -f $HSHQ_SECRETS_DIR/ldap_readonly_user_password.txt
  echo "$LDAP_READONLY_USER_PASSWORD" > $HSHQ_SECRETS_DIR/ldap_readonly_user_password.txt
  chmod 0400 $HSHQ_SECRETS_DIR/ldap_readonly_user_password.txt

  if [ -z "$LDAP_CONFIG_PASSWORD" ]; then
    LDAP_CONFIG_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar LDAP_CONFIG_PASSWORD $LDAP_CONFIG_PASSWORD
  fi
  rm -f $HSHQ_SECRETS_DIR/ldap_config_password.txt
  echo "$LDAP_CONFIG_PASSWORD" > $HSHQ_SECRETS_DIR/ldap_config_password.txt
  chmod 0400 $HSHQ_SECRETS_DIR/ldap_config_password.txt

  LDAP_READONLY_USER_BIND_DN="cn=$LDAP_READONLY_USER_USERNAME,$LDAP_BASE_DN"
  updateConfigVar LDAP_READONLY_USER_BIND_DN $LDAP_READONLY_USER_BIND_DN
  ADMIN_PASSWORD_CRYPT=$(openssl passwd -6 $LDAP_ADMIN_USER_PASSWORD)

  outputConfigOpenLDAP

  generateCert ldapserver ldapserver
  generateCert ldapphp ldapphp
  generateCert ldapmanager ldapmanager

  cp $HSHQ_SSL_DIR/dhparam.pem $HSHQ_STACKS_DIR/openldap/certs/dhparam.pem
  cp $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt $HSHQ_STACKS_DIR/openldap/certs/${CERTS_ROOT_CA_NAME}.crt
  installStack openldap ldapserver "slapd starting" $HOME/openldap.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing OpenLDAP"
    exit $retval
  fi

  docker exec ldapserver chmod +x /tmp/initconfig/initdbscript.sh
  docker exec ldapserver sh /tmp/initconfig/initdbscript.sh > /dev/null 2>&1
  rm -f $HSHQ_STACKS_DIR/openldap/ldapserver/initconfig/*
  chmod 644 $HSHQ_SSL_DIR/dhparam.pem

  inner_block=""
  inner_block=$inner_block">>https://$SUB_OPENLDAP_PHP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://ldapphp {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_OPENLDAP_PHP $MANAGETLS_OPENLDAP_PHP "$is_integrate_hshq" $NETDEFAULT_OPENLDAP_PHP "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://ldapmanager {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_OPENLDAP_MANAGER $MANAGETLS_OPENLDAP_MANAGER "$is_integrate_hshq" $NETDEFAULT_OPENLDAP_MANAGER "$inner_block"
}

function outputConfigOpenLDAP()
{
  cat <<EOFLC > $HOME/openldap-compose.yml
$STACK_VERSION_PREFIX openldap $(getScriptStackVersion openldap)

services:
  ldapserver:
    image: $(getScriptImageByContainerName ldapserver)
    container_name: ldapserver
    hostname: ldapserver
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/ldapserver.crt:/container/service/slapd/assets/certs/ldapserver.crt
      - \${HSHQ_SSL_DIR}/ldapserver.key:/container/service/slapd/assets/certs/ldapserver.key
      - \${HSHQ_STACKS_DIR}/openldap/certs/${CERTS_ROOT_CA_NAME}.crt:/container/service/slapd/assets/certs/${CERTS_ROOT_CA_NAME}.crt
      - \${HSHQ_STACKS_DIR}/openldap/certs/dhparam.pem:/container/service/slapd/assets/certs/dhparam.pem
      - \${HSHQ_STACKS_DIR}/openldap/ldapserver/initconfig:/tmp/initconfig
      - \${HSHQ_STACKS_DIR}/openldap/ldapserver/db:/var/lib/ldap
      - \${HSHQ_STACKS_DIR}/openldap/ldapserver/slapd:/etc/ldap/slapd.d
    secrets:
      - ldap_admin_bind_password
      - ldap_config_password
      - ldap_readonly_user_password

  ldapphp:
    image: $(getScriptImageByContainerName ldapphp)
    container_name: ldapphp
    hostname: ldapphp
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ldap-net
      - dock-proxy-net
    depends_on:
      - ldapserver
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/openldap/ldapphp/www:/var/www/phpldapadmin
      - \${HSHQ_SSL_DIR}/ldapphp.crt:/container/service/phpldapadmin/assets/apache2/certs/ldapphp.crt
      - \${HSHQ_SSL_DIR}/ldapphp.key:/container/service/phpldapadmin/assets/apache2/certs/ldapphp.key
      - \${HSHQ_STACKS_DIR}/openldap/certs/${CERTS_ROOT_CA_NAME}.crt:/container/service/phpldapadmin/assets/apache2/certs/${CERTS_ROOT_CA_NAME}.crt
      - \${HSHQ_SSL_DIR}/ldapphp.crt:/container/service/ldap-client/assets/certs/ldapphp.crt
      - \${HSHQ_SSL_DIR}/ldapphp.key:/container/service/ldap-client/assets/certs/ldapphp.key
      - \${HSHQ_STACKS_DIR}/openldap/certs/${CERTS_ROOT_CA_NAME}.crt:/container/service/ldap-client/assets/certs/${CERTS_ROOT_CA_NAME}.crt
    environment:
      - "PHPLDAPADMIN_LDAP_HOSTS=#PYTHON2BASH:[{'ldapserver': [{'server': [{'tls': True}]}]}]"

  ldapmanager:
    image: $(getScriptImageByContainerName ldapmanager)
    container_name: ldapmanager
    hostname: ldapmanager
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ldap-net
      - dock-proxy-net
      - dock-internalmail-net
    depends_on:
      - ldapserver
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/ldapmanager.crt:/opt/ssl/ldapmanager.crt:ro
      - \${HSHQ_SSL_DIR}/ldapmanager.key:/opt/ssl/ldapmanager.key:ro
      - \${HSHQ_STACKS_DIR}/openldap/certs/${CERTS_ROOT_CA_NAME}.crt:/opt/ssl/${CERTS_ROOT_CA_NAME}.crt:ro
      - \${HSHQ_STACKS_DIR}/openldap/ldapmanager/ldap.conf:/etc/ldap/ldap.conf
    secrets:
      - ldap_admin_bind_dn
      - ldap_admin_bind_password
      - ldap_config_password
      - ldap_readonly_user_password

secrets:
  ldap_admin_bind_dn:
    file: \${HSHQ_SECRETS_DIR}/ldap_admin_bind_dn.txt
  ldap_admin_bind_password:
    file: \${HSHQ_SECRETS_DIR}/ldap_admin_bind_password.txt
  ldap_config_password:
    file: \${HSHQ_SECRETS_DIR}/ldap_config_password.txt
  ldap_readonly_user_password:
    file: \${HSHQ_SECRETS_DIR}/ldap_readonly_user_password.txt

networks:
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true

EOFLC

  cat <<EOFLD > $HOME/openldap.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
LDAP_OPENLDAP_UID=$USERID
LDAP_OPENLDAP_GID=$GROUPID
LDAP_ORGANISATION=$HOMESERVER_NAME
LDAP_DOMAIN=$HOMESERVER_DOMAIN
LDAP_BASE_DN=$LDAP_BASE_DN
LDAP_READONLY_USER_USERNAME=$LDAP_READONLY_USER_USERNAME
LDAP_TLS_VERIFY_CLIENT=try
LDAP_READONLY_USER=true
LDAP_RFC2307BIS_SCHEMA=true
LDAP_TLS=true
LDAP_TLS_ENFORCE=true
LDAP_TLS_CRT_FILENAME=ldapserver.crt
LDAP_TLS_KEY_FILENAME=ldapserver.key
LDAP_TLS_CA_CRT_FILENAME=${CERTS_ROOT_CA_NAME}.crt
LDAP_TLS_DH_PARAM_FILENAME=dhparam.pem
LDAP_ADMIN_PASSWORD_FILE=/run/secrets/ldap_admin_bind_password
LDAP_CONFIG_PASSWORD_FILE=/run/secrets/ldap_config_password
LDAP_READONLY_USER_PASSWORD_FILE=/run/secrets/ldap_readonly_user_password
PHPLDAPADMIN_HTTPS=true
PHPLDAPADMIN_LDAP_CLIENT_TLS=true
PHPLDAPADMIN_LDAP_CLIENT_TLS_REQCERT=demand
PHPLDAPADMIN_HTTPS_CA_CRT_FILENAME=${CERTS_ROOT_CA_NAME}.crt
PHPLDAPADMIN_HTTPS_CRT_FILENAME=ldapphp.crt
PHPLDAPADMIN_HTTPS_KEY_FILENAME=ldapphp.key
PHPLDAPADMIN_LDAP_CLIENT_TLS_CRT_FILENAME=ldapphp.crt
PHPLDAPADMIN_LDAP_CLIENT_TLS_KEY_FILENAME=ldapphp.key
PHPLDAPADMIN_LDAP_CLIENT_TLS_CA_CRT_FILENAME=${CERTS_ROOT_CA_NAME}.crt
SERVER_HOSTNAME=$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN
LDAP_URI=$LDAP_URI
EMAIL_DOMAIN=$HOMESERVER_DOMAIN
SMTP_HOSTNAME=$SMTP_HOSTNAME
SMTP_HOST_PORT=$SMTP_HOSTPORT
EMAIL_FROM_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
EMAIL_FROM_NAME=$LDAP_EMAIL_FROM_NAME
ACCOUNT_REQUESTS_ENABLED=$LDAP_ACCOUNT_REQUESTS_ENABLED
ACCOUNT_REQUESTS_EMAIL=$LDAP_ACCOUNT_REQUESTS_EMAIL
LDAP_ACCOUNT_ADDITIONAL_ATTRIBUTES=jpegphoto^:Photograph
ORGANISATION_NAME=$HOMESERVER_NAME
SITE_NAME=$HOMESERVER_NAME User Manager
LDAP_REQUIRE_STARTTLS=true
LDAP_ADMINS_GROUP=$LDAP_ADMIN_USER_GROUP_NAME
NO_HTTPS=false
LDAP_IGNORE_CERT_ERRORS=false
DEFAULT_USER_SHELL=/sbin/nologin
USERNAME_FORMAT={first_name}
ENFORCE_SAFE_SYSTEM_NAMES=true
SMTP_USE_TLS=true
SERVER_CERT_FILENAME=ldapmanager.crt
SERVER_KEY_FILENAME=ldapmanager.key
CA_CERT_FILENAME=${CERTS_ROOT_CA_NAME}.crt
LDAP_TLS_CACERT_FILE=/opt/ssl/${CERTS_ROOT_CA_NAME}.crt
LDAP_ADMIN_BIND_DN_FILE=/run/secrets/ldap_admin_bind_dn
LDAP_ADMIN_BIND_PWD_FILE=/run/secrets/ldap_admin_bind_password
SMTP_USERNAME_FILE=/run/secrets/smtp_username
SMTP_PASSWORD_FILE=/run/secrets/smtp_password
NEW_ACCOUNT_EMAIL_BODY=<h1>New Account Created</h1><p>You've been set up with an account for {organisation}.  Your credentials are:</p><p></p><p>Login: {login}<br>Password: {password}</p><p></p><p>You should log into <a href={change_password_url}>{change_password_url}</a> and change the password as soon as possible.</p>

EOFLD

  cat <<EOFLD > $HSHQ_STACKS_DIR/openldap/ldapmanager/ldap.conf
TLS_CERT /opt/ssl/ldapmanager.crt
TLS_KEY /opt/ssl/ldapmanager.key
TLS_CACERT /opt/ssl/${CERTS_ROOT_CA_NAME}.crt
TLS_REQCERT demand
TLS_REQSAN demand
EOFLD

  cat <<EOFLI > $HSHQ_STACKS_DIR/openldap/ldapserver/initconfig/initdbscript.sh
#!/bin/sh

ldapadd -f /tmp/initconfig/initdb.ldif -D $LDAP_ADMIN_BIND_DN -Z -w $LDAP_ADMIN_BIND_PASSWORD
EOFLI

  firstname="$(echo "$LDAP_PRIMARY_USER_FULLNAME" | rev | cut -d" " -f2- | rev)"
  surname="$(echo "$LDAP_PRIMARY_USER_FULLNAME" | rev | cut -d" " -f1 | rev)"
  cat <<EOFLB > $HSHQ_STACKS_DIR/openldap/ldapserver/initconfig/initdb.ldif
# People
dn: ou=people,${LDAP_BASE_DN}
objectClass: organizationalUnit
ou: people

# Groups
dn: ou=groups,${LDAP_BASE_DN}
objectClass: organizationalUnit
ou: groups

# Admin User
dn: uid=${LDAP_ADMIN_USER_USERNAME},ou=people,${LDAP_BASE_DN}
givenName:: $(echo -n "${HOMESERVER_ABBREV^^} " | base64)
sn: Admin
uid: ${LDAP_ADMIN_USER_USERNAME}
mail: ${EMAIL_ADMIN_EMAIL_ADDRESS}
objectClass: person
objectClass: inetOrgPerson
objectClass: posixAccount
uidNumber: 2001
gidNumber: 2001
loginShell: /sbin/nologin
homeDirectory: /home/${LDAP_ADMIN_USER_USERNAME}
cn: ${HOMESERVER_ABBREV^^} Admin
userPassword: {CRYPT}${ADMIN_PASSWORD_CRYPT}

# Basic User
dn: uid=${LDAP_PRIMARY_USER_USERNAME},ou=people,${LDAP_BASE_DN}
givenName:: $(echo -n "$firstname " | base64)
sn:: $(echo -n "$surname" | base64)
uid: ${LDAP_PRIMARY_USER_USERNAME}
mail: ${LDAP_PRIMARY_USER_EMAIL_ADDRESS}
objectClass: person
objectClass: inetOrgPerson
objectClass: posixAccount
uidNumber: 2002
gidNumber: 2001
loginShell: /sbin/nologin
homeDirectory: /home/${LDAP_PRIMARY_USER_USERNAME}
cn:: $(echo -n "${LDAP_PRIMARY_USER_FULLNAME}" | base64)
userPassword: {CRYPT}${LDAP_PRIMARY_USER_PASSWORD_HASH}

# Last UID
dn: cn=lastUID,${LDAP_BASE_DN}
objectClass: device
objectClass: top
description: Records the last UID used to create a Posix account. This prevents the re-use of a UID from a deleted account.
cn: lastUID
serialNumber: 2002

# Last GID
dn: cn=lastGID,${LDAP_BASE_DN}
objectClass: device
objectClass: top
description: Records the last GID used to create a Posix group. This prevents the re-use of a GID from a deleted group.
cn: lastGID
serialNumber: 2004

# Group Everybody
dn: cn=everybody,ou=groups,${LDAP_BASE_DN}
objectClass: top
objectClass: posixGroup
objectClass: groupOfUniqueNames
cn: everybody
uniqueMember: uid=${LDAP_ADMIN_USER_USERNAME},ou=people,${LDAP_BASE_DN}
uniqueMember: uid=${LDAP_PRIMARY_USER_USERNAME},ou=people,${LDAP_BASE_DN}
gidNumber: 2001

# Group Admins
dn: cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,${LDAP_BASE_DN}
objectClass: top
objectClass: posixGroup
objectClass: groupOfUniqueNames
cn: $LDAP_ADMIN_USER_GROUP_NAME
uniqueMember: uid=${LDAP_ADMIN_USER_USERNAME},ou=people,${LDAP_BASE_DN}
gidNumber: 2002

# Group Primary Users
dn: cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,${LDAP_BASE_DN}
objectClass: top
objectClass: posixGroup
objectClass: groupOfUniqueNames
cn: $LDAP_PRIMARY_USER_GROUP_NAME
uniqueMember: uid=${LDAP_ADMIN_USER_USERNAME},ou=people,${LDAP_BASE_DN}
uniqueMember: uid=${LDAP_PRIMARY_USER_USERNAME},ou=people,${LDAP_BASE_DN}
gidNumber: 2003

# Group Basic Users
dn: cn=$LDAP_BASIC_USER_GROUP_NAME,ou=groups,${LDAP_BASE_DN}
objectClass: top
objectClass: posixGroup
objectClass: groupOfUniqueNames
cn: $LDAP_BASIC_USER_GROUP_NAME
uniqueMember: uid=${LDAP_ADMIN_USER_USERNAME},ou=people,${LDAP_BASE_DN}
uniqueMember: uid=${LDAP_PRIMARY_USER_USERNAME},ou=people,${LDAP_BASE_DN}
gidNumber: 2004
EOFLB

}

function performUpdateOpenLDAP()
{
  perform_stack_name=openldap
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=osixia/openldap:1.5.0,osixia/phpldapadmin:stable,wheelybird/ldap-user-manager:v1.11
      image_update_map[0]="osixia/openldap:1.5.0,osixia/openldap:1.5.0"
      image_update_map[1]="osixia/phpldapadmin:stable,osixia/phpldapadmin:stable"
      image_update_map[2]="wheelybird/ldap-user-manager:v1.11,wheelybird/ldap-user-manager:v1.11"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Mailu
function installMailu()
{
  set +e
  is_integrate_hshq=$1
  # Unless directory doesn't exist, don't proceed
  checkDeleteStackAndDirectory mailu "Mailu"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Mailu directory exists"
    exit 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/mailu
  mkdir $HSHQ_STACKS_DIR/mailu/certs
  mkdir $HSHQ_STACKS_DIR/mailu/redis
  mkdir $HSHQ_STACKS_DIR/mailu/clamav
  mkdir $HSHQ_STACKS_DIR/mailu/initconfig
  sudo chown 1000:1000 $HSHQ_STACKS_DIR/mailu/clamav

  # Generate email certificate if not joining another VPN
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
    generateCert mail "$SMTP_HOSTNAME,$SUB_POSTFIX.$HOMESERVER_DOMAIN"
  fi
  if [ -z "$SMTP_RELAY_HOST" ] || [ -z "$SMTP_RELAY_USERNAME" ]; then
    # Set these to something
    SMTP_RELAY_HOST="[$SUB_POSTFIX.internal.$HOMESERVER_DOMAIN]:$MAILU_PORT_5"
    SMTP_RELAY_USERNAME=$HOMESERVER_DOMAIN
    SMTP_RELAY_PASSWORD=$(pwgen -c -n 32 1)
  fi
  outputConfigMailu
  outputMailuComposeTmp
  installStack mailu mailu-admin "Listening at: http://0.0.0.0:8080" $HOME/mailu.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Mailu"
    exit $retval
  fi
  echo "Installed Mailu stack, sleeping 5 seconds..."
  sleep 5
  echo "Adding initial users..."
  docker exec mailu-admin flask mailu config-import /initconfig/mail-config.yaml > /dev/null 2>&1
  sleep 2
  startStopStack mailu stop
  rm -f $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
  sudo mv $HSHQ_STACKS_DIR/mailu/postfix-override.cf $HSHQ_STACKS_DIR/mailu/overrides/postfix/postfix.cf
  sudo mv $HSHQ_STACKS_DIR/mailu/dovecot-override.conf $HSHQ_STACKS_DIR/mailu/overrides/dovecot/dovecot.conf
  sudo mv $HSHQ_STACKS_DIR/mailu/custom.inc.php $HSHQ_STACKS_DIR/mailu/overrides/roundcube/custom.inc.php
  sudo mv $HSHQ_STACKS_DIR/mailu/external_relay.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/
  sudo mv $HSHQ_STACKS_DIR/mailu/ip_whitelist.map $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/ip_whitelist.map
  sudo chmod 644 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/ip_whitelist.map
  sudo mv $HSHQ_STACKS_DIR/mailu/ip_blacklist.map $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/ip_blacklist.map
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/ip_blacklist.map
  sudo chmod 644 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/ip_blacklist.map
  sudo touch $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_whitelist.map
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_whitelist.map
  sudo chmod 644 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_whitelist.map
  sudo touch $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_blacklist.map
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_blacklist.map
  sudo chmod 644 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/domain_blacklist.map
  sudo mv $HSHQ_STACKS_DIR/mailu/multimap.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/multimap.conf
  sudo mv $HSHQ_STACKS_DIR/mailu/groups.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override/groups.conf
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override/groups.conf
  sudo chmod 664 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override/groups.conf
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override/groups.conf
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override
  sudo rm -fr $HSHQ_STACKS_DIR/mailu/filter/*
  sudo rm -fr $HSHQ_STACKS_DIR/mailu/clamav/*
  sleep 5
  echo "Restarting mailu stack..."
  updateStackEnv mailu modFunMailuPostInstall
  inner_block=""
  inner_block=$inner_block">>https://$SUB_MAILU.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://$SMTP_HOSTNAME {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MAILU $MANAGETLS_MAILU "$is_integrate_hshq" $NETDEFAULT_MAILU "$inner_block"
}

function outputConfigMailu()
{
  is_antivirus_commented_out=""
  is_antivirus_env="clamav"
  if [ "$(isServiceDisabled clamav)" = "true" ]; then
    is_antivirus_commented_out="#"
    is_antivirus_env="none"
  fi
  set -e
  outputMailuCompose
  cat <<EOFMC > $HOME/mailu.env
TZ=\${TZ}
SECRET_KEY=$(pwgen -c -n 16 1)
SUBNET=$NET_MAILU_EXT_SUBNET
SUBNET_PREFIX=$NET_MAILU_EXT_SUBNET_PREFIX
DOMAIN=$HOMESERVER_DOMAIN
HOSTNAMES=$SUB_POSTFIX.$HOMESERVER_DOMAIN
POSTMASTER=$EMAIL_ADMIN_USERNAME
TLS_FLAVOR=cert
TLS_CERT_FILENAME=mail.crt
TLS_KEYPAIR_FILENAME=mail.key
OUTBOUND_TLS_LEVEL=encrypt
INBOUND_TLS_ENFORCE=false
AUTH_RATELIMIT_IP=60/hour
AUTH_RATELIMIT_USER=100/day
DISABLE_STATISTICS=True
ADMIN=true
WEBMAIL=roundcube
WEBDAV=radicale
ANTIVIRUS=$is_antivirus_env
SCAN_MACROS=True
MESSAGE_SIZE_LIMIT=50000000
MESSAGE_RATELIMIT=200/day
RELAYHOST=$SMTP_RELAY_HOST
RELAYUSER=$SMTP_RELAY_USERNAME
RELAYPASSWORD=$SMTP_RELAY_PASSWORD
FETCHMAIL_DELAY=600
FETCHMAIL_ENABLED=true
RECIPIENT_DELIMITER=+
DMARC_RUA=$EMAIL_ADMIN_USERNAME
DMARC_RUF=$EMAIL_ADMIN_USERNAME
WELCOME=true
WELCOME_SUBJECT=Welcome to your new email account
WELCOME_BODY=Welcome to your new email account, if you can read this, then it is configured properly!
COMPRESSION=gz
COMPRESSION_LEVEL=5
WEBROOT_REDIRECT=/webmail
WEB_ADMIN=/admin
WEB_WEBMAIL=/webmail
SITENAME=Mailu
WEBSITE=https://mailu.io
COMPOSE_PROJECT_NAME=mailu
CREDENTIAL_ROUNDS=12
REJECT_UNLISTED_RECIPIENT=yes
LOG_LEVEL=INFO
DB_FLAVOR=sqlite
FULL_TEXT_SEARCH=en
API=true
WEB_API=/api
API_TOKEN=$MAILU_API_TOKEN
PORTS=$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,4190,$MAILU_PORT_1,$MAILU_PORT_2,$MAILU_PORT_3,$MAILU_PORT_4,$MAILU_PORT_5,$MAILU_PORT_6,$MAILU_PORT_7
FULL_TEXT_SEARCH_ATTACHMENTS=false
EOFMC

  cat <<EOFMO > $HSHQ_STACKS_DIR/mailu/postfix-override.cf
smtp_tls_cert_file=/certs/mail.crt
smtp_tls_key_file=/certs/mail.key
mynetworks = 127.0.0.1/32 $NET_MAILU_EXT_SUBNET $NET_INTERNALMAIL_SUBNET
EOFMO

  cat <<EOFMD > $HSHQ_STACKS_DIR/mailu/dovecot-override.conf
listen = *
EOFMD

  cat <<EOFSP > $HSHQ_STACKS_DIR/mailu/external_relay.conf
enabled = true;
rules {
  EXTERNAL_RELAY_AUTHENTICATED {
    strategy = "count";
    count = 3;
  }
}
EOFSP

  cat <<EOFRS > $HSHQ_STACKS_DIR/mailu/ip_whitelist.map
$NET_INTERNALMAIL_SUBNET
EOFRS

  touch $HSHQ_STACKS_DIR/mailu/ip_blacklist.map
  cat <<EOFRO > $HSHQ_STACKS_DIR/mailu/custom.inc.php
<?php
\$config['show_images'] = 3;
\$config['timezone'] = '$TZ';
\$config['reply_mode'] = 1;
?>
EOFRO

  sudo chown root:root $HSHQ_STACKS_DIR/mailu/custom.inc.php
  outputMailuMultimap

  cat <<EOFRS > $HSHQ_STACKS_DIR/mailu/groups.conf
group "dkim" {
  symbols = {
    "R_DKIM_ALLOW" = {
      weight = -6.0;
    }
  }
}

EOFRS

  cat <<EOFMC > $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
domain:
  - name: $HOMESERVER_DOMAIN

user:
  - email: $EMAIL_ADMIN_USERNAME@$HOMESERVER_DOMAIN
    password: '$(openssl passwd -6 $EMAIL_ADMIN_PASSWORD)'
    hash_password: false
    global_admin: true
    displayed_name: '${HOMESERVER_ABBREV^^} Admin'
  - email: $EMAIL_SMTP_USERNAME@$HOMESERVER_DOMAIN
    password: '$(openssl passwd -6 $EMAIL_SMTP_PASSWORD)'
    hash_password: false
    displayed_name: '${HOMESERVER_ABBREV^^} SMTP Sender'
  - email: $LDAP_PRIMARY_USER_USERNAME@$HOMESERVER_DOMAIN
    password: '$LDAP_PRIMARY_USER_PASSWORD_HASH'
    hash_password: false
    displayed_name: '$(echo "$LDAP_PRIMARY_USER_FULLNAME" | rev | cut -d" " -f2- | rev)'

EOFMC
  if ! [ -z "$RELAYSERVER_WGPORTAL_ADMIN_EMAIL" ]; then
    echo -e "alias:" >> $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
    echo -e "  - email: $RELAYSERVER_WGPORTAL_ADMIN_USERNAME@$HOMESERVER_DOMAIN" >> $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
    echo -e "    destination:" >> $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
    echo -e "      - $EMAIL_ADMIN_EMAIL_ADDRESS\n" >> $HSHQ_STACKS_DIR/mailu/initconfig/mail-config.yaml
  fi
}

function outputMailuComposeTmp()
{
  # This compose is only different from outputMailuCompose by one
  # line - in the admin container, the DNS server is set to the 
  # mailu-unbound container rather than the default (Adguard).
  # This bandaid fix will avoid an installation failure when
  # adguard is not working correctly out of the gate.
  rm -f $HOME/mailu-compose.yml
  cat <<EOFMC > $HOME/mailu-compose.yml
$STACK_VERSION_PREFIX mailu $(getScriptStackVersion mailu)

services:
  front:
    image: $(getScriptImageByContainerName $SMTP_HOSTNAME)
    container_name: $SMTP_HOSTNAME
    hostname: $SMTP_HOSTNAME
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
      - dock-internalmail-net
      - dock-proxy-net
    ports:
      - "$MAILU_PORT_1:$MAILU_PORT_1"
      - "$MAILU_PORT_2:$MAILU_PORT_2"
      - "$MAILU_PORT_3:$MAILU_PORT_3"
      - "$MAILU_PORT_4:$MAILU_PORT_4"
      - "$MAILU_PORT_5:$MAILU_PORT_5"
      - "$MAILU_PORT_6:$MAILU_PORT_6"
      - "$MAILU_PORT_7:$MAILU_PORT_7"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/nginx:/overrides:ro

  resolver:
    image: $(getScriptImageByContainerName mailu-unbound)
    container_name: mailu-unbound
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-mailu-ext-net:
        ipv4_address: \${SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  redis:
    image: $(getScriptImageByContainerName mailu-redis)
    container_name: mailu-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mailu-redis:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

  admin:
    image: $(getScriptImageByContainerName mailu-admin)
    container_name: mailu-admin
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    dns:
      - \${SUBNET_PREFIX}.253
    depends_on:
      - redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/initconfig:/initconfig
      - \${HSHQ_STACKS_DIR}/mailu/data:/data
      - \${HSHQ_STACKS_DIR}/mailu/dkim:/dkim

  imap:
    image: $(getScriptImageByContainerName mailu-imap)
    container_name: mailu-imap
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mail:/mail
      - \${HSHQ_STACKS_DIR}/mailu/overrides/dovecot:/overrides:ro

  smtp:
    image: $(getScriptImageByContainerName mailu-smtp)
    container_name: mailu-smtp
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mailqueue:/queue
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/postfix:/overrides:ro

  oletools:
    image: $(getScriptImageByContainerName mailu-oletools)
    container_name: mailu-oletools
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

#  fts_attachments:
#    image: $(getScriptImageByContainerName mailu-tika)
#    container_name: mailu-tika
#    hostname: tika
#    restart: unless-stopped
#    env_file: stack.env
#    security_opt:
#      - no-new-privileges:true
#    networks:
#      - dock-mailu-int-net
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - /etc/timezone:/etc/timezone:ro

  antispam:
    image: $(getScriptImageByContainerName mailu-antispam)
    container_name: mailu-antispam
    hostname: antispam
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
      - dock-mailu-ext-net
      - dock-proxy-net
    dns:
      - \${SUBNET_PREFIX}.253
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/filter:/var/lib/rspamd
      - \${HSHQ_STACKS_DIR}/mailu/overrides/rspamd/local:/overrides
      - \${HSHQ_STACKS_DIR}/mailu/overrides/rspamd/override:/etc/rspamd/override.d

$is_antivirus_commented_out  antivirus:
$is_antivirus_commented_out    image: $(getScriptImageByContainerName mailu-antivirus)
$is_antivirus_commented_out    container_name: mailu-antivirus
$is_antivirus_commented_out    restart: unless-stopped
$is_antivirus_commented_out    env_file: stack.env
$is_antivirus_commented_out    security_opt:
$is_antivirus_commented_out      - no-new-privileges:true
$is_antivirus_commented_out    networks:
$is_antivirus_commented_out      - dock-mailu-ext-net
$is_antivirus_commented_out      - dock-proxy-net
$is_antivirus_commented_out    volumes:
$is_antivirus_commented_out      - /etc/localtime:/etc/localtime:ro
$is_antivirus_commented_out      - /etc/timezone:/etc/timezone:ro
$is_antivirus_commented_out      - \${HSHQ_STACKS_DIR}/mailu/clamav:/var/lib/clamav

  webdav:
    image: $(getScriptImageByContainerName mailu-webdav)
    container_name: mailu-webdav
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/dav:/data

  fetchmail:
    image: $(getScriptImageByContainerName mailu-fetchmail)
    container_name: mailu-fetchmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/data/fetchmail:/data

  webmail:
    image: $(getScriptImageByContainerName mailu-webmail)
    container_name: mailu-webmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - imap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/webmail:/data
      - \${HSHQ_STACKS_DIR}/mailu/overrides/roundcube:/overrides:ro

volumes:
  v-mailu-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/mailu/redis

networks:
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-mailu-int-net:
    name: dock-mailu-int
    external: true
  dock-mailu-ext-net:
    name: dock-mailu-ext
    external: true

EOFMC
}

function outputMailuCompose()
{
  rm -f $HOME/mailu-compose.yml
  cat <<EOFMC > $HOME/mailu-compose.yml
$STACK_VERSION_PREFIX mailu $(getScriptStackVersion mailu)

services:
  front:
    image: $(getScriptImageByContainerName $SMTP_HOSTNAME)
    container_name: $SMTP_HOSTNAME
    hostname: $SMTP_HOSTNAME
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
      - dock-internalmail-net
      - dock-proxy-net
    ports:
      - "$MAILU_PORT_1:$MAILU_PORT_1"
      - "$MAILU_PORT_2:$MAILU_PORT_2"
      - "$MAILU_PORT_3:$MAILU_PORT_3"
      - "$MAILU_PORT_4:$MAILU_PORT_4"
      - "$MAILU_PORT_5:$MAILU_PORT_5"
      - "$MAILU_PORT_6:$MAILU_PORT_6"
      - "$MAILU_PORT_7:$MAILU_PORT_7"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/nginx:/overrides:ro

  resolver:
    image: $(getScriptImageByContainerName mailu-unbound)
    container_name: mailu-unbound
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-mailu-ext-net:
        ipv4_address: \${SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  redis:
    image: $(getScriptImageByContainerName mailu-redis)
    container_name: mailu-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mailu-redis:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

  admin:
    image: $(getScriptImageByContainerName mailu-admin)
    container_name: mailu-admin
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/initconfig:/initconfig
      - \${HSHQ_STACKS_DIR}/mailu/data:/data
      - \${HSHQ_STACKS_DIR}/mailu/dkim:/dkim

  imap:
    image: $(getScriptImageByContainerName mailu-imap)
    container_name: mailu-imap
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mail:/mail
      - \${HSHQ_STACKS_DIR}/mailu/overrides/dovecot:/overrides:ro

  smtp:
    image: $(getScriptImageByContainerName mailu-smtp)
    container_name: mailu-smtp
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/mailqueue:/queue
      - \${HSHQ_STACKS_DIR}/mailu/certs:/certs
      - \${HSHQ_SSL_DIR}/mail.crt:/certs/mail.crt:ro
      - \${HSHQ_SSL_DIR}/mail.key:/certs/mail.key:ro
      - \${HSHQ_STACKS_DIR}/mailu/overrides/postfix:/overrides:ro

  oletools:
    image: $(getScriptImageByContainerName mailu-oletools)
    container_name: mailu-oletools
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

#  fts_attachments:
#    image: $(getScriptImageByContainerName mailu-tika)
#    container_name: mailu-tika
#    hostname: tika
#    restart: unless-stopped
#    env_file: stack.env
#    security_opt:
#      - no-new-privileges:true
#    networks:
#      - dock-mailu-int-net
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - /etc/timezone:/etc/timezone:ro

  antispam:
    image: $(getScriptImageByContainerName mailu-antispam)
    container_name: mailu-antispam
    hostname: antispam
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-int-net
      - dock-mailu-ext-net
      - dock-proxy-net
    dns:
      - \${SUBNET_PREFIX}.253
    depends_on:
      - front
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/filter:/var/lib/rspamd
      - \${HSHQ_STACKS_DIR}/mailu/overrides/rspamd/local:/overrides
      - \${HSHQ_STACKS_DIR}/mailu/overrides/rspamd/override:/etc/rspamd/override.d

$is_antivirus_commented_out  antivirus:
$is_antivirus_commented_out    image: $(getScriptImageByContainerName mailu-antivirus)
$is_antivirus_commented_out    container_name: mailu-antivirus
$is_antivirus_commented_out    restart: unless-stopped
$is_antivirus_commented_out    env_file: stack.env
$is_antivirus_commented_out    security_opt:
$is_antivirus_commented_out      - no-new-privileges:true
$is_antivirus_commented_out    networks:
$is_antivirus_commented_out      - dock-mailu-ext-net
$is_antivirus_commented_out      - dock-proxy-net
$is_antivirus_commented_out    volumes:
$is_antivirus_commented_out      - /etc/localtime:/etc/localtime:ro
$is_antivirus_commented_out      - /etc/timezone:/etc/timezone:ro
$is_antivirus_commented_out      - \${HSHQ_STACKS_DIR}/mailu/clamav:/var/lib/clamav

  webdav:
    image: $(getScriptImageByContainerName mailu-webdav)
    container_name: mailu-webdav
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/dav:/data

  fetchmail:
    image: $(getScriptImageByContainerName mailu-fetchmail)
    container_name: mailu-fetchmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/data/fetchmail:/data

  webmail:
    image: $(getScriptImageByContainerName mailu-webmail)
    container_name: mailu-webmail
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-mailu-ext-net
    depends_on:
      - imap
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mailu/webmail:/data
      - \${HSHQ_STACKS_DIR}/mailu/overrides/roundcube:/overrides:ro

volumes:
  v-mailu-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/mailu/redis

networks:
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-mailu-int-net:
    name: dock-mailu-int
    external: true
  dock-mailu-ext-net:
    name: dock-mailu-ext
    external: true

EOFMC
}

function modFunMailuPostInstall()
{
  outputMailuCompose
}

function outputMailuMultimap()
{
  cat <<EOFRS > $HSHQ_STACKS_DIR/mailu/multimap.conf
IP_WHITELIST {
  type = "ip";
  prefilter = true;
  map = "/overrides/ip_whitelist.map";
  action = "accept";
}

IP_BLACKLIST {
  type = "ip";
  prefilter = true;
  map = "/overrides/ip_blacklist.map";
  action = "reject";
}

DOMAIN_WHITELIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "/overrides/domain_whitelist.map";
  score = -100.0;
  action = "accept";
}

DOMAIN_BLACKLIST {
  regexp = true;
  type = "from";
  filter = "email:domain";
  map = "/overrides/domain_blacklist.map";
  score = 100.0;
  action = "reject";
}

EOFRS

}

function performUpdateMailu()
{
  perform_stack_name=mailu
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2.0,ghcr.io/mailu/rspamd:2.0,ghcr.io/mailu/clamav:2.0,ghcr.io/mailu/fetchmail:2.0,ghcr.io/mailu/nginx:2.0,ghcr.io/mailu/dovecot:2.0,ghcr.io/mailu/oletools:2.0,ghcr.io/mailu/postfix:2.0,ghcr.io/mailu/unbound:2.0,ghcr.io/mailu/radicale:2.0,ghcr.io/mailu/webmail:2.0
      image_update_map[0]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[1]="ghcr.io/mailu/admin:2.0,ghcr.io/mailu/admin:2.0.39"
      image_update_map[2]="ghcr.io/mailu/rspamd:2.0,ghcr.io/mailu/rspamd:2.0.39"
      image_update_map[3]="ghcr.io/mailu/clamav:2.0,ghcr.io/mailu/clamav:2.0.39"
      image_update_map[4]="ghcr.io/mailu/fetchmail:2.0,ghcr.io/mailu/fetchmail:2.0.39"
      image_update_map[5]="ghcr.io/mailu/nginx:2.0,ghcr.io/mailu/nginx:2.0.39"
      image_update_map[6]="ghcr.io/mailu/dovecot:2.0,ghcr.io/mailu/dovecot:2.0.39"
      image_update_map[7]="ghcr.io/mailu/oletools:2.0,ghcr.io/mailu/oletools:2.0.39"
      image_update_map[8]="ghcr.io/mailu/postfix:2.0,ghcr.io/mailu/postfix:2.0.39"
      image_update_map[9]="ghcr.io/mailu/unbound:2.0,ghcr.io/mailu/unbound:2.0.39"
      image_update_map[10]="ghcr.io/mailu/radicale:2.0,ghcr.io/mailu/radicale:2.0.39"
      image_update_map[11]="ghcr.io/mailu/webmail:2.0,ghcr.io/mailu/webmail:2.0.39"
    ;;
    2)
      newVer=v3
      curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2.0.37,ghcr.io/mailu/rspamd:2.0.37,ghcr.io/mailu/clamav:2.0.37,ghcr.io/mailu/fetchmail:2.0.37,ghcr.io/mailu/nginx:2.0.37,ghcr.io/mailu/dovecot:2.0.37,ghcr.io/mailu/oletools:2.0.37,ghcr.io/mailu/postfix:2.0.37,ghcr.io/mailu/unbound:2.0.37,ghcr.io/mailu/radicale:2.0.37,ghcr.io/mailu/webmail:2.0.37
      image_update_map[0]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[1]="ghcr.io/mailu/admin:2.0.37,ghcr.io/mailu/admin:2.0.39"
      image_update_map[2]="ghcr.io/mailu/rspamd:2.0.37,ghcr.io/mailu/rspamd:2.0.39"
      image_update_map[3]="ghcr.io/mailu/clamav:2.0.37,ghcr.io/mailu/clamav:2.0.39"
      image_update_map[4]="ghcr.io/mailu/fetchmail:2.0.37,ghcr.io/mailu/fetchmail:2.0.39"
      image_update_map[5]="ghcr.io/mailu/nginx:2.0.37,ghcr.io/mailu/nginx:2.0.39"
      image_update_map[6]="ghcr.io/mailu/dovecot:2.0.37,ghcr.io/mailu/dovecot:2.0.39"
      image_update_map[7]="ghcr.io/mailu/oletools:2.0.37,ghcr.io/mailu/oletools:2.0.39"
      image_update_map[8]="ghcr.io/mailu/postfix:2.0.37,ghcr.io/mailu/postfix:2.0.39"
      image_update_map[9]="ghcr.io/mailu/unbound:2.0.37,ghcr.io/mailu/unbound:2.0.39"
      image_update_map[10]="ghcr.io/mailu/radicale:2.0.37,ghcr.io/mailu/radicale:2.0.39"
      image_update_map[11]="ghcr.io/mailu/webmail:2.0.37,ghcr.io/mailu/webmail:2.0.39"
    ;;
    3)
      newVer=v4
      curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2.0.39,ghcr.io/mailu/rspamd:2.0.39,ghcr.io/mailu/clamav:2.0.39,ghcr.io/mailu/fetchmail:2.0.39,ghcr.io/mailu/nginx:2.0.39,ghcr.io/mailu/dovecot:2.0.39,ghcr.io/mailu/oletools:2.0.39,ghcr.io/mailu/postfix:2.0.39,ghcr.io/mailu/unbound:2.0.39,ghcr.io/mailu/radicale:2.0.39,ghcr.io/mailu/webmail:2.0.39
      image_update_map[0]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[1]="ghcr.io/mailu/admin:2.0.39,ghcr.io/mailu/admin:2024.06.24"
      image_update_map[2]="ghcr.io/mailu/rspamd:2.0.39,ghcr.io/mailu/rspamd:2024.06.24"
      image_update_map[3]="ghcr.io/mailu/clamav:2.0.39,clamav/clamav-debian:1.2.3-45"
      image_update_map[4]="ghcr.io/mailu/fetchmail:2.0.39,ghcr.io/mailu/fetchmail:2024.06.24"
      image_update_map[5]="ghcr.io/mailu/nginx:2.0.39,ghcr.io/mailu/nginx:2024.06.24"
      image_update_map[6]="ghcr.io/mailu/dovecot:2.0.39,ghcr.io/mailu/dovecot:2024.06.24"
      image_update_map[7]="ghcr.io/mailu/oletools:2.0.39,ghcr.io/mailu/oletools:2024.06.24"
      image_update_map[8]="ghcr.io/mailu/postfix:2.0.39,ghcr.io/mailu/postfix:2024.06.24"
      image_update_map[9]="ghcr.io/mailu/unbound:2.0.39,ghcr.io/mailu/unbound:2024.06.24"
      image_update_map[10]="ghcr.io/mailu/radicale:2.0.39,ghcr.io/mailu/radicale:2024.06.24"
      image_update_map[11]="ghcr.io/mailu/webmail:2.0.39,ghcr.io/mailu/webmail:2024.06.24"
      image_update_map[12]="apache/tika:2.9.2.1-full,apache/tika:2.9.2.1-full"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfMailuV4Update
      mfMailuV4PostUpdate
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    4)
      newVer=v5
      curImageList=bitnami/redis:7.0.5,ghcr.io/mailu/admin:2024.06.24,ghcr.io/mailu/rspamd:2024.06.24,clamav/clamav-debian:1.2.3-45,ghcr.io/mailu/fetchmail:2024.06.24,ghcr.io/mailu/nginx:2024.06.24,ghcr.io/mailu/dovecot:2024.06.24,ghcr.io/mailu/oletools:2024.06.24,ghcr.io/mailu/postfix:2024.06.24,ghcr.io/mailu/unbound:2024.06.24,ghcr.io/mailu/radicale:2024.06.24,ghcr.io/mailu/webmail:2024.06.24,apache/tika:2.9.2.1-full
      image_update_map[0]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[1]="ghcr.io/mailu/admin:2024.06.24,ghcr.io/mailu/admin:2024.06.36"
      image_update_map[2]="ghcr.io/mailu/rspamd:2024.06.24,ghcr.io/mailu/rspamd:2024.06.36"
      image_update_map[3]="clamav/clamav-debian:1.2.3-45,clamav/clamav-debian:1.4.2"
      image_update_map[4]="ghcr.io/mailu/fetchmail:2024.06.24,ghcr.io/mailu/fetchmail:2024.06.36"
      image_update_map[5]="ghcr.io/mailu/nginx:2024.06.24,ghcr.io/mailu/nginx:2024.06.36"
      image_update_map[6]="ghcr.io/mailu/dovecot:2024.06.24,ghcr.io/mailu/dovecot:2024.06.36"
      image_update_map[7]="ghcr.io/mailu/oletools:2024.06.24,ghcr.io/mailu/oletools:2024.06.36"
      image_update_map[8]="ghcr.io/mailu/postfix:2024.06.24,ghcr.io/mailu/postfix:2024.06.36"
      image_update_map[9]="ghcr.io/mailu/unbound:2024.06.24,ghcr.io/mailu/unbound:2024.06.36"
      image_update_map[10]="ghcr.io/mailu/radicale:2024.06.24,ghcr.io/mailu/radicale:2024.06.36"
      image_update_map[11]="ghcr.io/mailu/webmail:2024.06.24,ghcr.io/mailu/webmail:2024.06.36"
      image_update_map[12]="apache/tika:2.9.2.1-full,apache/tika:3.1.0.0-full"
    ;;
    5)
      newVer=v5
      curImageList=bitnami/redis:7.4.2,ghcr.io/mailu/admin:2024.06.36,ghcr.io/mailu/rspamd:2024.06.36,clamav/clamav-debian:1.4.2,ghcr.io/mailu/fetchmail:2024.06.36,ghcr.io/mailu/nginx:2024.06.36,ghcr.io/mailu/dovecot:2024.06.36,ghcr.io/mailu/oletools:2024.06.36,ghcr.io/mailu/postfix:2024.06.36,ghcr.io/mailu/unbound:2024.06.36,ghcr.io/mailu/radicale:2024.06.36,ghcr.io/mailu/webmail:2024.06.36,apache/tika:3.1.0.0-full
      image_update_map[0]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[1]="ghcr.io/mailu/admin:2024.06.36,ghcr.io/mailu/admin:2024.06.36"
      image_update_map[2]="ghcr.io/mailu/rspamd:2024.06.36,ghcr.io/mailu/rspamd:2024.06.36"
      image_update_map[3]="clamav/clamav-debian:1.4.2,clamav/clamav-debian:1.4.2"
      image_update_map[4]="ghcr.io/mailu/fetchmail:2024.06.36,ghcr.io/mailu/fetchmail:2024.06.36"
      image_update_map[5]="ghcr.io/mailu/nginx:2024.06.36,ghcr.io/mailu/nginx:2024.06.36"
      image_update_map[6]="ghcr.io/mailu/dovecot:2024.06.36,ghcr.io/mailu/dovecot:2024.06.36"
      image_update_map[7]="ghcr.io/mailu/oletools:2024.06.36,ghcr.io/mailu/oletools:2024.06.36"
      image_update_map[8]="ghcr.io/mailu/postfix:2024.06.36,ghcr.io/mailu/postfix:2024.06.36"
      image_update_map[9]="ghcr.io/mailu/unbound:2024.06.36,ghcr.io/mailu/unbound:2024.06.36"
      image_update_map[10]="ghcr.io/mailu/radicale:2024.06.36,ghcr.io/mailu/radicale:2024.06.36"
      image_update_map[11]="ghcr.io/mailu/webmail:2024.06.36,ghcr.io/mailu/webmail:2024.06.36"
      image_update_map[12]="apache/tika:3.1.0.0-full,apache/tika:3.1.0.0-full"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function addUserMailu()
{
  set +e
  add_type=$1
  username=$2
  domain=$3
  password=$4
  total_tries=5
  num_tries=1
  is_added=false
  while [ $num_tries -le $total_tries ]
  do
    docker exec mailu-admin flask mailu $add_type $username $domain $password
    if [ $? -eq 0 ]; then
      is_added=true
      echo "[Mailu] Added $username"
      break
    fi
    sleep 1
    ((num_tries++))
    echo "[Mailu] Error Adding $username, retry $num_tries of $total_tries"
  done
  if [ "$is_added" = "false" ]; then
    echo "[Mailu] Error adding $username, exiting..."
    # Sleep here to ensure error gets logged
    sleep 3
    exit 1
  fi
  sleep 5
  set -e
}

function mfMailuV4Update()
{
  rm -f $HOME/mailu-compose.yml
  outputMailuCompose
  outputMailuMultimap
  mkdir $HSHQ_STACKS_DIR/mailu/tmpdir
  sudo mv $HSHQ_STACKS_DIR/mailu/overrides/rspamd/* $HSHQ_STACKS_DIR/mailu/tmpdir/
  sudo mkdir -p $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local
  sudo mkdir -p $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local
  sudo chown 101:101 $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override
  sudo rm -f $HSHQ_STACKS_DIR/mailu/tmpdir/multimap.conf
  sudo mv $HSHQ_STACKS_DIR/mailu/tmpdir/groups.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/override/
  sudo mv $HSHQ_STACKS_DIR/mailu/tmpdir/* $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/
  sudo rm -fr $HSHQ_STACKS_DIR/mailu/tmpdir
  sudo mv $HSHQ_STACKS_DIR/mailu/multimap.conf $HSHQ_STACKS_DIR/mailu/overrides/rspamd/local/multimap.conf
  sudo rm -f $HSHQ_STACKS_DIR/mailu/filter/bytecode.cld $HSHQ_STACKS_DIR/mailu/filter/bytecode.cvd $HSHQ_STACKS_DIR/mailu/filter/daily.cld $HSHQ_STACKS_DIR/mailu/filter/freshclam.dat $HSHQ_STACKS_DIR/mailu/filter/main.cvd
  mkdir $HSHQ_STACKS_DIR/mailu/clamav
  sudo chown 1000:1000 $HSHQ_STACKS_DIR/mailu/clamav
  sed -i "s|^LOG_LEVEL=.*|LOG_LEVEL=INFO|g" $HOME/mailu.env
  echo "FULL_TEXT_SEARCH=en" >> $HOME/mailu.env
  echo "API=true" >> $HOME/mailu.env
  echo "WEB_API=/api" >> $HOME/mailu.env
  echo "API_TOKEN=$MAILU_API_TOKEN" >> $HOME/mailu.env
  echo "PORTS=$CADDY_HTTP_PORT,$CADDY_HTTPS_PORT,4190,$MAILU_PORT_1,$MAILU_PORT_2,$MAILU_PORT_3,$MAILU_PORT_4,$MAILU_PORT_5,$MAILU_PORT_6,$MAILU_PORT_7" >> $HOME/mailu.env
  echo "FULL_TEXT_SEARCH_ATTACHMENTS=false" >> $HOME/mailu.env
}

function mfMailuV4PostUpdate()
{
  waitForStack "Listening at: http://0.0.0.0:8080" mailu-admin
  docker exec mailu-imap doveadm fts rescan -A > /dev/null 2>&1
  docker exec mailu-imap doveadm user '*'|while read u; do echo "re-indexing $u";docker exec mailu-imap doveadm index -u $u '*'; done > /dev/null 2>&1
}

function mailuV111Bugfix()
{
  # See https://github.com/Mailu/Mailu/issues/3673
  if sudo test -d ${HSHQ_STACKS_DIR}/mailu/clamav; then
    return
  fi
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  mailu_stack_id=$(getStackID mailu "$portainerToken")
  mailu_compose=$HSHQ_STACKS_DIR/portainer/compose/$mailu_stack_id/docker-compose.yml
  mailu_stack_firstline=$(sudo sed -n 1p $mailu_compose)
  mailu_stack_ver=$(getVersionFromComposeLine "$mailu_stack_firstline")
  if [ "$mailu_stack_ver" = "1" ] || [ "$mailu_stack_ver" = "2" ] || [ "$mailu_stack_ver" = "3" ]; then
    return
  fi
  startStopStack mailu stop "$portainerToken"
  updateStackEnv mailu mfMailuV111Bugfix "$portainerToken"
}

function mfMailuV111Bugfix()
{
  rm -f $HOME/mailu-compose.yml
  outputMailuCompose
  if sudo test -d $HSHQ_STACKS_DIR/mailu/filter/clamav; then
    sudo mv $HSHQ_STACKS_DIR/mailu/filter/clamav $HSHQ_STACKS_DIR/mailu/clamav
  else
    mkdir $HSHQ_STACKS_DIR/mailu/clamav
  fi
  sudo chown -R 1000:1000 $HSHQ_STACKS_DIR/mailu/clamav
  sudo rm -fr $HSHQ_STACKS_DIR/mailu/clamav/tmp*
}

# Wazuh
function installWazuh()
{
  set +e
  is_integrate_hshq=$1
  # Get/check contents of wazuh directory
  checkDeleteStackAndDirectory wazuh "Wazuh"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wazuh.dashboard)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wazuh.indexer)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wazuh.manager)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/wazuh
  mkdir $HSHQ_STACKS_DIR/wazuh/wazuh-cluster
  mkdir $HSHQ_STACKS_DIR/wazuh/wazuh-indexer
  mkdir $HSHQ_STACKS_DIR/wazuh/wazuh-dashboard
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/api-configuration
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/etc
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/var-multigroups
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/integrations
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/active-response
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/agentless
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/wodles
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/filebeat-etc
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/filebeat-var
  mkdir $HSHQ_STACKS_DIR/wazuh/volumes/indexer-data
  mkdir $HSHQ_NONBACKUP_DIR/wazuh
  mkdir $HSHQ_NONBACKUP_DIR/wazuh/volumes
  mkdir $HSHQ_NONBACKUP_DIR/wazuh/volumes/queue
  mkdir $HSHQ_NONBACKUP_DIR/wazuh/volumes/logs
  mkdir $HSHQ_NONBACKUP_DIR/wazuh/volumes/indexer-data

  initServicesCredentials
  outputConfigWazuh
  generateCert wazuh.manager "wazuh.manager"
  generateCert wazuh.indexer "wazuh.indexer"
  generateCert wazuh.admin "wazuh.admin"
  generateCert wazuh.dashboard "wazuh.dashboard"

  installStack wazuh wazuh.manager " " $HOME/wazuh.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Wazuh manager installed..."
  error_text="Fatal glibc error"
  maxACount=300
  curACount=1
  set +e
  while [ $curACount -lt $maxACount ]
  do
    if sudo test -f $HSHQ_STACKS_DIR/wazuh/volumes/etc/shared/default/agent.conf; then
      break
    fi
    finderror=$(docker logs wazuh.manager 2>&1 | grep "$error_text")
    if ! [ -z "$finderror" ]; then
      echo "This CPU does not support x86-64-v2, Wazuh cannot be installed, exiting..."
      checkDeleteStackAndDirectory wazuh "Wazuh" true true
      return 3
    fi
    echo "Waiting for agent.conf to initialize ($curACount seconds)..."
    sleep 1
    ((curACount++))
  done
  sudo sed -i "s/.*Shared agent configuration here.*/\  <rootcheck>\n    <ignore>\/var\/lib\/docker\/overlay2<\/ignore>\n  <\/rootcheck>/" $HSHQ_STACKS_DIR/wazuh/volumes/etc/shared/default/agent.conf
  sudo tee -a $HSHQ_STACKS_DIR/wazuh/volumes/etc/rules/local_rules.xml >/dev/null <<EOFRU

<group name="ossec,">
  <rule id="651" level="13" overwrite="yes">
    <if_sid>650</if_sid>
    <options>alert_by_email</options>
    <field name="parameters.program">firewall-drop</field>
    <field name="command">add</field>
    <description>Host Blocked by firewall-drop Active Response</description>
    <group>active_response,pci_dss_11.4,gpg13_4.13,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,tsc_CC7.4,</group>
  </rule>
</group>

EOFRU

  sudo tee $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
  sudo chmod 640 $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass
  sudo chown root:999 $HSHQ_STACKS_DIR/wazuh/volumes/etc/authd.pass
  sudo sed -i "s/<use_password>no<\/use_password>/<use_password>yes<\/use_password>/" $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf

  docker container restart wazuh.manager > /dev/null 2>&1
  installWazuhAgent
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_WAZUH.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://wazuh.dashboard:5601 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_WAZUH $MANAGETLS_WAZUH "$is_integrate_hshq" $NETDEFAULT_WAZUH "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll wazuh "$FMLNAME_WAZUH" $USERTYPE_WAZUH "https://$SUB_WAZUH.$HOMESERVER_DOMAIN" "wazuh.png" "$(getHeimdallOrderFromSub $SUB_WAZUH $USERTYPE_WAZUH)"
    restartAllCaddyContainers
  fi
}

function outputConfigWazuh()
{
  cat <<EOFWZ > $HOME/wazuh-compose.yml
$STACK_VERSION_PREFIX wazuh $(getScriptStackVersion wazuh)

services:
  wazuh.manager:
    image: $(getScriptImageByContainerName wazuh.manager)
    container_name: wazuh.manager
    hostname: wazuh.manager
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    networks:
      - int-wazuh-net
      - dock-ext-net
      - dock-internalmail-net
    ports:
      - "$WAZUH_PORT_1:$WAZUH_PORT_1"
      - "$WAZUH_PORT_2:$WAZUH_PORT_2"
      - "$WAZUH_PORT_3:$WAZUH_PORT_3"
      - "$WAZUH_PORT_4:$WAZUH_PORT_4"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/etc/ssl/root-ca.pem:ro
      - \${HSHQ_SSL_DIR}/wazuh.manager.crt:/etc/ssl/filebeat.pem
      - \${HSHQ_SSL_DIR}/wazuh.manager.key:/etc/ssl/filebeat.key
      - \${HSHQ_STACKS_DIR}/wazuh/wazuh-cluster/wazuh_manager.conf:/wazuh-config-mount/etc/ossec.conf
      - v-wazuh-api-configuration:/var/ossec/api/configuration
      - v-wazuh-etc:/var/ossec/etc
      - v-wazuh-logs:/var/ossec/logs
      - v-wazuh-queue:/var/ossec/queue
      - v-wazuh-var-multigroups:/var/ossec/var/multigroups
      - v-wazuh-integrations:/var/ossec/integrations
      - v-wazuh-active-response:/var/ossec/active-response/bin
      - v-wazuh-agentless:/var/ossec/agentless
      - v-wazuh-wodles:/var/ossec/wodles
      - v-wazuh-filebeat-etc:/etc/filebeat
      - v-wazuh-filebeat-var:/var/lib/filebeat

  wazuh.indexer:
    image: $(getScriptImageByContainerName wazuh.indexer)
    container_name: wazuh.indexer
    hostname: wazuh.indexer
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-wazuh-net
      - dock-ext-net
    ports:
      - "$WAZUH_PORT_5:$WAZUH_PORT_5"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/usr/share/wazuh-indexer/certs/root-ca.pem:ro
      - \${HSHQ_SSL_DIR}/wazuh.indexer.crt:/usr/share/wazuh-indexer/certs/wazuh.indexer.pem
      - \${HSHQ_SSL_DIR}/wazuh.indexer.key:/usr/share/wazuh-indexer/certs/wazuh.indexer.key
      - \${HSHQ_SSL_DIR}/wazuh.admin.crt:/usr/share/wazuh-indexer/certs/admin.pem
      - \${HSHQ_SSL_DIR}/wazuh.admin.key:/usr/share/wazuh-indexer/certs/admin-key.pem
      - \${HSHQ_STACKS_DIR}/wazuh/wazuh-indexer/wazuh_indexer.yml:/usr/share/wazuh-indexer/opensearch.yml
      - \${HSHQ_STACKS_DIR}/wazuh/wazuh-indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml
      - v-wazuh-indexer-data:/var/lib/wazuh-indexer

  wazuh.dashboard:
    image: $(getScriptImageByContainerName wazuh.dashboard)
    container_name: wazuh.dashboard
    hostname: wazuh.dashboard
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - wazuh.indexer
    networks:
      - int-wazuh-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/usr/share/wazuh-dashboard/certs/root-ca.pem:ro
      - \${HSHQ_SSL_DIR}/wazuh.dashboard.crt:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - \${HSHQ_SSL_DIR}/wazuh.dashboard.key:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - \${HSHQ_STACKS_DIR}/wazuh/wazuh-dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - \${HSHQ_STACKS_DIR}/wazuh/wazuh-dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml

volumes:
  v-wazuh-api-configuration:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/api-configuration
  v-wazuh-etc:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/etc
  v-wazuh-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/wazuh/volumes/logs
  v-wazuh-queue:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/wazuh/volumes/queue
  v-wazuh-var-multigroups:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/var-multigroups
  v-wazuh-integrations:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/integrations
  v-wazuh-active-response:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/active-response
  v-wazuh-agentless:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/agentless
  v-wazuh-wodles:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/wodles
  v-wazuh-filebeat-etc:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/filebeat-etc
  v-wazuh-filebeat-var:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wazuh/volumes/filebeat-var
  v-wazuh-indexer-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/wazuh/volumes/indexer-data

networks:
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-wazuh-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFWZ

  cat <<EOFWZ > $HOME/wazuh.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
INDEXER_URL=https://wazuh.indexer:9200
INDEXER_USERNAME=$WAZUH_USERS_ADMIN_USERNAME
INDEXER_PASSWORD=$WAZUH_USERS_ADMIN_PASSWORD
FILEBEAT_SSL_VERIFICATION_MODE=full
SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
SSL_CERTIFICATE=/etc/ssl/filebeat.pem
SSL_KEY=/etc/ssl/filebeat.key
API_USERNAME=$WAZUH_API_USERNAME
API_PASSWORD=$WAZUH_API_PASSWORD
OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx2g
WAZUH_API_URL=https://wazuh.manager
DASHBOARD_USERNAME=$WAZUH_USERS_DASHBOARD_USERNAME
DASHBOARD_PASSWORD=$WAZUH_USERS_DASHBOARD_PASSWORD
EOFWZ

  cat <<EOFWZ > $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf
<ossec_config>
  <global>
    <jsonout_output>yes</jsonout_output>
    <alerts_log>yes</alerts_log>
    <logall>no</logall>
    <logall_json>no</logall_json>
    <email_notification>yes</email_notification>
    <smtp_server>$SMTP_HOSTNAME</smtp_server>
    <email_from>$EMAIL_ADMIN_EMAIL_ADDRESS</email_from>
    <email_to>$EMAIL_ADMIN_EMAIL_ADDRESS</email_to>
    <email_maxperhour>12</email_maxperhour>
    <email_log_source>alerts.log</email_log_source>
    <agents_disconnection_time>10m</agents_disconnection_time>
    <agents_disconnection_alert_time>0</agents_disconnection_alert_time>
  </global>

  <alerts>
    <log_alert_level>3</log_alert_level>
    <email_alert_level>12</email_alert_level>
  </alerts>

  <!-- Choose between "plain", "json", or "plain,json" for the format of internal logs -->
  <logging>
    <log_format>plain</log_format>
  </logging>

  <remote>
    <connection>secure</connection>
    <port>$WAZUH_PORT_1</port>
    <protocol>tcp</protocol>
    <queue_size>131072</queue_size>
  </remote>

  <!-- Policy monitoring -->
  <rootcheck>
    <disabled>no</disabled>
    <check_files>yes</check_files>
    <check_trojans>yes</check_trojans>
    <check_dev>yes</check_dev>
    <check_sys>yes</check_sys>
    <check_pids>yes</check_pids>
    <check_ports>yes</check_ports>
    <check_if>yes</check_if>

    <!-- Frequency that rootcheck is executed - every 12 hours -->
    <frequency>43200</frequency>

    <rootkit_files>etc/rootcheck/rootkit_files.txt</rootkit_files>
    <rootkit_trojans>etc/rootcheck/rootkit_trojans.txt</rootkit_trojans>

    <skip_nfs>yes</skip_nfs>
  </rootcheck>

  <wodle name="cis-cat">
    <disabled>no</disabled>
    <timeout>1800</timeout>
    <interval>1d</interval>
    <scan-on-start>yes</scan-on-start>
    <java_path>wodles/java</java_path>
    <ciscat_path>wodles/ciscat</ciscat_path>
  </wodle>

  <wodle name="docker-listener">
    <interval>1m</interval>
    <attempts>5</attempts>
    <run_on_start>yes</run_on_start>
    <disabled>no</disabled>
  </wodle>

  <!-- Osquery integration -->
  <wodle name="osquery">
    <disabled>yes</disabled>
    <run_daemon>yes</run_daemon>
    <log_path>/var/log/osquery/osqueryd.results.log</log_path>
    <config_path>/etc/osquery/osquery.conf</config_path>
    <add_labels>yes</add_labels>
  </wodle>

  <!-- System inventory -->
  <wodle name="syscollector">
    <disabled>no</disabled>
    <interval>1h</interval>
    <scan_on_start>yes</scan_on_start>
    <hardware>yes</hardware>
    <os>yes</os>
    <network>yes</network>
    <packages>yes</packages>
    <ports all="no">yes</ports>
    <processes>yes</processes>

    <!-- Database synchronization settings -->
    <synchronization>
      <max_eps>10</max_eps>
    </synchronization>
  </wodle>

  <sca>
    <enabled>yes</enabled>
    <scan_on_start>yes</scan_on_start>
    <interval>12h</interval>
    <skip_nfs>yes</skip_nfs>
  </sca>

  <vulnerability-detection>
    <enabled>yes</enabled>
    <index-status>yes</index-status>
    <feed-update-interval>60m</feed-update-interval>
  </vulnerability-detection>

  <indexer>
    <enabled>yes</enabled>
    <hosts>
      <host>https://wazuh.indexer:9200</host>
    </hosts>
    <ssl>
      <certificate_authorities>
        <ca>/etc/ssl/root-ca.pem</ca>
      </certificate_authorities>
      <certificate>/etc/ssl/filebeat.pem</certificate>
      <key>/etc/ssl/filebeat.key</key>
    </ssl>
  </indexer>

  <!-- File integrity monitoring -->
  <syscheck>
    <disabled>no</disabled>

    <!-- Frequency that syscheck is executed default every 12 hours -->
    <frequency>43200</frequency>

    <scan_on_start>yes</scan_on_start>

    <!-- Generate alert when new file detected -->
    <alert_new_files>yes</alert_new_files>

    <!-- Don't ignore files that change more than 'frequency' times -->
    <auto_ignore frequency="10" timeframe="3600">no</auto_ignore>

    <!-- Directories to check  (perform all possible verifications) -->
    <directories>/etc,/usr/bin,/usr/sbin</directories>
    <directories>/bin,/sbin,/boot</directories>
    <directories>/home</directories>

    <!-- Files/directories to ignore -->
    <ignore>/etc/mtab</ignore>
    <ignore>/etc/hosts.deny</ignore>
    <ignore>/etc/mail/statistics</ignore>
    <ignore>/etc/random-seed</ignore>
    <ignore>/etc/random.seed</ignore>
    <ignore>/etc/adjtime</ignore>
    <ignore>/etc/httpd/logs</ignore>
    <ignore>/etc/utmpx</ignore>
    <ignore>/etc/wtmpx</ignore>
    <ignore>/etc/cups/certs</ignore>
    <ignore>/etc/dumpdates</ignore>
    <ignore>/etc/svc/volatile</ignore>

    <!-- File types to ignore -->
    <ignore type="sregex">.log\$|.swp\$</ignore>

    <!-- Check the file, but never compute the diff -->
    <nodiff>/etc/ssl/private.key</nodiff>

    <skip_nfs>yes</skip_nfs>
    <skip_dev>yes</skip_dev>
    <skip_proc>yes</skip_proc>
    <skip_sys>yes</skip_sys>

    <!-- Nice value for Syscheck process -->
    <process_priority>10</process_priority>

    <!-- Maximum output throughput -->
    <max_eps>100</max_eps>

    <!-- Database synchronization settings -->
    <synchronization>
      <enabled>yes</enabled>
      <interval>5m</interval>
      <max_interval>1h</max_interval>
      <max_eps>10</max_eps>
    </synchronization>
  </syscheck>

  <!-- Active response -->
  <global>
    <white_list>127.0.0.1</white_list>
    <white_list>^localhost.localdomain\$</white_list>
  </global>

  <command>
    <name>disable-account</name>
    <executable>disable-account</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <command>
    <name>restart-wazuh</name>
    <executable>restart-wazuh</executable>
  </command>

  <command>
    <name>firewall-drop</name>
    <executable>firewall-drop</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <command>
    <name>host-deny</name>
    <executable>host-deny</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <command>
    <name>route-null</name>
    <executable>route-null</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <command>
    <name>win_route-null</name>
    <executable>route-null.exe</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <command>
    <name>netsh</name>
    <executable>netsh.exe</executable>
    <timeout_allowed>yes</timeout_allowed>
  </command>

  <!-- Log analysis -->
  <localfile>
    <log_format>command</log_format>
    <command>df -P</command>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>netstat -tulpn | sed 's/\([[:alnum:]]\+\)\ \+[[:digit:]]\+\ \+[[:digit:]]\+\ \+\(.*\):\([[:digit:]]*\)\ \+\([0-9\.\:\*]\+\).\+\ \([[:digit:]]*\/[[:alnum:]\-]*\).*/\1 \2 == \3 == \4 \5/' | sort -k 4 -g | sed 's/ == \(.*\) ==/:\1/' | sed 1,2d</command>
    <alias>netstat listening ports</alias>
    <frequency>360</frequency>
  </localfile>

  <localfile>
    <log_format>full_command</log_format>
    <command>last -n 20</command>
    <frequency>360</frequency>
  </localfile>

  <ruleset>
    <!-- Default ruleset -->
    <decoder_dir>ruleset/decoders</decoder_dir>
    <rule_dir>ruleset/rules</rule_dir>
    <rule_exclude>0215-policy_rules.xml</rule_exclude>
    <list>etc/lists/audit-keys</list>
    <list>etc/lists/amazon/aws-eventnames</list>
    <list>etc/lists/security-eventchannel</list>

    <!-- User-defined ruleset -->
    <decoder_dir>etc/decoders</decoder_dir>
    <rule_dir>etc/rules</rule_dir>
  </ruleset>

  <rule_test>
    <enabled>yes</enabled>
    <threads>1</threads>
    <max_sessions>64</max_sessions>
    <session_timeout>15m</session_timeout>
  </rule_test>

  <!-- Configuration for wazuh-authd -->
  <auth>
    <disabled>no</disabled>
    <port>$WAZUH_PORT_2</port>
    <use_source_ip>no</use_source_ip>
    <purge>yes</purge>
    <use_password>no</use_password>
    <ciphers>HIGH:!ADH:!EXP:!MD5:!RC4:!3DES:!CAMELLIA:@STRENGTH</ciphers>
    <!-- <ssl_agent_ca></ssl_agent_ca> -->
    <ssl_verify_host>no</ssl_verify_host>
    <ssl_manager_cert>etc/sslmanager.cert</ssl_manager_cert>
    <ssl_manager_key>etc/sslmanager.key</ssl_manager_key>
    <ssl_auto_negotiate>no</ssl_auto_negotiate>
  </auth>

  <cluster>
    <name>wazuh</name>
    <node_name>node01</node_name>
    <node_type>master</node_type>
    <key></key>
    <port>1516</port>
    <bind_addr>0.0.0.0</bind_addr>
    <nodes>
        <node>NODE_IP</node>
    </nodes>
    <hidden>no</hidden>
    <disabled>yes</disabled>
  </cluster>

  <localfile>
    <log_format>syslog</log_format>
    <location>/var/ossec/logs/active-responses.log</location>
  </localfile>

</ossec_config>

<ossec_config>
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>5763</rules_id>
    <timeout>300</timeout>
  </active-response>
</ossec_config>

EOFWZ

  cat <<EOFWZ > $HSHQ_STACKS_DIR/wazuh/wazuh-indexer/wazuh_indexer.yml
network.host: "0.0.0.0"
node.name: "wazuh.indexer"
path.data: /var/lib/wazuh-indexer
path.logs: /var/log/wazuh-indexer
discovery.type: single-node
compatibility.override_main_response_version: true
plugins.security.ssl.http.pemcert_filepath: \${OPENSEARCH_PATH_CONF}/certs/wazuh.indexer.pem
plugins.security.ssl.http.pemkey_filepath: \${OPENSEARCH_PATH_CONF}/certs/wazuh.indexer.key
plugins.security.ssl.http.pemtrustedcas_filepath: \${OPENSEARCH_PATH_CONF}/certs/root-ca.pem
plugins.security.ssl.transport.pemcert_filepath: \${OPENSEARCH_PATH_CONF}/certs/wazuh.indexer.pem
plugins.security.ssl.transport.pemkey_filepath: \${OPENSEARCH_PATH_CONF}/certs/wazuh.indexer.key
plugins.security.ssl.transport.pemtrustedcas_filepath: \${OPENSEARCH_PATH_CONF}/certs/root-ca.pem
plugins.security.ssl.http.enabled: true
plugins.security.ssl.transport.enforce_hostname_verification: false
plugins.security.ssl.transport.resolve_hostname: false
plugins.security.authcz.admin_dn:
- "CN=wazuh.admin,OU=$CERTS_INTERNAL_OU_NAME,O=$CERTS_INTERNAL_OU_NAME,L=$CERTS_INTERNAL_LOCALITY,ST=$CERTS_INTERNAL_STATE,C=$CERTS_INTERNAL_COUNTRY"
plugins.security.check_snapshot_restore_write_privileges: true
plugins.security.enable_snapshot_restore_privilege: true
plugins.security.nodes_dn:
- "CN=wazuh.indexer,OU=$CERTS_INTERNAL_OU_NAME,O=$CERTS_INTERNAL_OU_NAME,L=$CERTS_INTERNAL_LOCALITY,ST=$CERTS_INTERNAL_STATE,C=$CERTS_INTERNAL_COUNTRY"
plugins.security.restapi.roles_enabled:
- "all_access"
- "security_rest_api_access"
plugins.security.system_indices.enabled: true
plugins.security.system_indices.indices: [".opendistro-alerting-config", ".opendistro-alerting-alert*", ".opendistro-anomaly-results*", ".opendistro-anomaly-detector*", ".opendistro-anomaly-checkpoints", ".opendistro-anomaly-detection-state", ".opendistro-reports-*", ".opendistro-notifications-*", ".opendistro-notebooks", ".opensearch-observability", ".opendistro-asynchronous-search-response*", ".replication-metadata-store"]
plugins.security.allow_default_init_securityindex: true
cluster.routing.allocation.disk.threshold_enabled: false
EOFWZ

  WAZUH_USERS_ADMIN_PASSWORD_HASH=$(htpasswd -B -n -b $WAZUH_USERS_ADMIN_USERNAME $WAZUH_USERS_ADMIN_PASSWORD | cut -d":" -f2-)
  WAZUH_USERS_DASHBOARD_PASSWORD_HASH=$(htpasswd -B -n -b kibanaserver $WAZUH_USERS_DASHBOARD_PASSWORD | cut -d":" -f2-)
  WAZUH_USERS_KIBANARO_PASSWORD_HASH=$(htpasswd -B -n -b kibanaro $WAZUH_USERS_KIBANARO_PASSWORD | cut -d":" -f2-)
  WAZUH_USERS_LOGSTASH_PASSWORD_HASH=$(htpasswd -B -n -b logstash $WAZUH_USERS_LOGSTASH_PASSWORD | cut -d":" -f2-)
  WAZUH_USERS_READALL_PASSWORD_HASH=$(htpasswd -B -n -b readall $WAZUH_USERS_READALL_PASSWORD | cut -d":" -f2-)
  WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD_HASH=$(htpasswd -B -n -b snapshotrestore $WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD | cut -d":" -f2-)

  cat <<EOFWZ > $HSHQ_STACKS_DIR/wazuh/wazuh-indexer/internal_users.yml
---
# This is the internal user database
# The hash value is a bcrypt hash and can be generated with plugin/tools/hash.sh

_meta:
  type: "internalusers"
  config_version: 2

# Define your internal users here

## Demo users

$WAZUH_USERS_ADMIN_USERNAME:
  hash: "$WAZUH_USERS_ADMIN_PASSWORD_HASH"
  reserved: true
  backend_roles:
  - "admin"
  description: "Demo admin user"

kibanaserver:
  hash: "$WAZUH_USERS_DASHBOARD_PASSWORD_HASH"
  reserved: true
  description: "Demo kibanaserver user"

kibanaro:
  hash: "$WAZUH_USERS_KIBANARO_PASSWORD_HASH"
  reserved: false
  backend_roles:
  - "kibanauser"
  - "readall"
  attributes:
    attribute1: "value1"
    attribute2: "value2"
    attribute3: "value3"
  description: "Demo kibanaro user"

logstash:
  hash: "$WAZUH_USERS_LOGSTASH_PASSWORD_HASH"
  reserved: false
  backend_roles:
  - "logstash"
  description: "Demo logstash user"

readall:
  hash: "$WAZUH_USERS_READALL_PASSWORD_HASH"
  reserved: false
  backend_roles:
  - "readall"
  description: "Demo readall user"

snapshotrestore:
  hash: "$WAZUH_USERS_SNAPSHOTRESTORE_PASSWORD_HASH"
  reserved: false
  backend_roles:
  - "snapshotrestore"
  description: "Demo snapshotrestore user"
EOFWZ

  outputWazuhDashboardConfig
  touch $HSHQ_STACKS_DIR/wazuh/wazuh-dashboard/wazuh.yml
}

function outputWazuhDashboardConfig()
{
  rm -f $HSHQ_STACKS_DIR/wazuh/wazuh-dashboard/opensearch_dashboards.yml
  cat <<EOFWZ > $HSHQ_STACKS_DIR/wazuh/wazuh-dashboard/opensearch_dashboards.yml
server.host: 0.0.0.0
server.port: 5601
opensearch.hosts: https://wazuh.indexer:9200
opensearch.ssl.verificationMode: certificate
opensearch.requestHeadersWhitelist: ["securitytenant","Authorization"]
opensearch_security.multitenancy.enabled: false
opensearch_security.readonly_mode.roles: ["kibana_read_only"]
server.ssl.enabled: true
server.ssl.key: "/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem"
server.ssl.certificate: "/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem"
opensearch.ssl.certificateAuthorities: ["/usr/share/wazuh-dashboard/certs/root-ca.pem"]
uiSettings.overrides.defaultRoute: /app/wz-home
EOFWZ
}

function performUpdateWazuh()
{
  perform_stack_name=wazuh
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=wazuh/wazuh-manager:4.6.0,wazuh/wazuh-indexer:4.6.0,wazuh/wazuh-dashboard:4.6.0
      image_update_map[0]="wazuh/wazuh-manager:4.6.0,wazuh/wazuh-manager:4.7.3"
      image_update_map[1]="wazuh/wazuh-indexer:4.6.0,wazuh/wazuh-indexer:4.7.3"
      image_update_map[2]="wazuh/wazuh-dashboard:4.6.0,wazuh/wazuh-dashboard:4.7.3"
    ;;
    2)
      newVer=v4
      curImageList=wazuh/wazuh-manager:4.7.1,wazuh/wazuh-indexer:4.7.1,wazuh/wazuh-dashboard:4.7.1
      image_update_map[0]="wazuh/wazuh-manager:4.7.1,wazuh/wazuh-manager:4.7.3"
      image_update_map[1]="wazuh/wazuh-indexer:4.7.1,wazuh/wazuh-indexer:4.7.3"
      image_update_map[2]="wazuh/wazuh-dashboard:4.7.1,wazuh/wazuh-dashboard:4.7.3"
    ;;
    3)
      newVer=v4
      curImageList=wazuh/wazuh-manager:4.7.2,wazuh/wazuh-indexer:4.7.2,wazuh/wazuh-dashboard:4.7.2
      image_update_map[0]="wazuh/wazuh-manager:4.7.2,wazuh/wazuh-manager:4.7.3"
      image_update_map[1]="wazuh/wazuh-indexer:4.7.2,wazuh/wazuh-indexer:4.7.3"
      image_update_map[2]="wazuh/wazuh-dashboard:4.7.2,wazuh/wazuh-dashboard:4.7.3"
    ;;
    4)
      # The only purpose of this stack upgrade is to implement the increased Java memory fix
      newVer=v5
      curImageList=wazuh/wazuh-manager:4.7.3,wazuh/wazuh-indexer:4.7.3,wazuh/wazuh-dashboard:4.7.3
      image_update_map[0]="wazuh/wazuh-manager:4.7.3,wazuh/wazuh-manager:4.7.3"
      image_update_map[1]="wazuh/wazuh-indexer:4.7.3,wazuh/wazuh-indexer:4.7.3"
      image_update_map[2]="wazuh/wazuh-dashboard:4.7.3,wazuh/wazuh-dashboard:4.7.3"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfUpdateWazuhStackJavaMem
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    5)
      newVer=v6
      curImageList=wazuh/wazuh-manager:4.7.3,wazuh/wazuh-indexer:4.7.3,wazuh/wazuh-dashboard:4.7.3
      image_update_map[0]="wazuh/wazuh-manager:4.7.3,wazuh/wazuh-manager:4.9.1"
      image_update_map[1]="wazuh/wazuh-indexer:4.7.3,wazuh/wazuh-indexer:4.9.1"
      image_update_map[2]="wazuh/wazuh-dashboard:4.7.3,wazuh/wazuh-dashboard:4.9.1"
      updateWazuhAgents "4.9.1-1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" outputWazuhDashboardConfig false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    6)
      newVer=v7
      curImageList=wazuh/wazuh-manager:4.9.1,wazuh/wazuh-indexer:4.9.1,wazuh/wazuh-dashboard:4.9.1
      image_update_map[0]="wazuh/wazuh-manager:4.9.1,wazuh/wazuh-manager:4.11.2"
      image_update_map[1]="wazuh/wazuh-indexer:4.9.1,wazuh/wazuh-indexer:4.11.2"
      image_update_map[2]="wazuh/wazuh-dashboard:4.9.1,wazuh/wazuh-dashboard:4.11.2"
      updateWazuhAgents "4.11.2-1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    7)
      newVer=v7
      curImageList=wazuh/wazuh-manager:4.11.2,wazuh/wazuh-indexer:4.11.2,wazuh/wazuh-dashboard:4.11.2
      image_update_map[0]="wazuh/wazuh-manager:4.11.2,wazuh/wazuh-manager:4.11.2"
      image_update_map[1]="wazuh/wazuh-indexer:4.11.2,wazuh/wazuh-indexer:4.11.2"
      image_update_map[2]="wazuh/wazuh-dashboard:4.11.2,wazuh/wazuh-dashboard:4.11.2"
      updateWazuhAgents "4.11.2-1"
      # Don't forget to test version412WazuhUpdate
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" version412WazuhUpdate false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfUpdateWazuhStackJavaMem()
{
  sed -i "s|OPENSEARCH_JAVA_OPTS=.*|OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx2g|" $HOME/wazuh.env
}

function installWazuhAgent()
{
  if [ -z "$SUB_WAZUH" ] || [ -z "$HOMESERVER_DOMAIN" ] || [ -z "$WAZUH_AGENT_VERSION" ] || [ -z "$WAZUH_MANAGER_AUTH_PASSWORD" ]; then
    echo "Fatal error: SUB_WAZUH: $SUB_WAZUH, HOMESERVER_DOMAIN: $HOMESERVER_DOMAIN, WAZUH_AGENT_VERSION: $WAZUH_AGENT_VERSION"
    exit 2
  fi
  curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | sudo gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import && sudo chmod 644 /usr/share/keyrings/wazuh.gpg
  echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" | sudo tee /etc/apt/sources.list.d/wazuh.list
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo WAZUH_MANAGER="$SUB_WAZUH.$HOMESERVER_DOMAIN" DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wazuh-agent=$WAZUH_AGENT_VERSION
  sudo apt-mark hold wazuh-agent
  sudo systemctl daemon-reload
  set +e
  sudo grep "/var/log/docker/" /var/ossec/etc/ossec.conf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo sed -i "/<\/ossec_config>/{s//  <localfile>\n    <log_format>syslog<\/log_format>\n    <location>\/var\/log\/docker\/*<\/location>\n  <\/localfile>\n\n<\/ossec_config>/;:p;n;bp}" /var/ossec/etc/ossec.conf
  fi
  sudo tee /var/ossec/etc/authd.pass >/dev/null <<EOFWZ
$WAZUH_MANAGER_AUTH_PASSWORD
EOFWZ
  sudo chmod 640 /var/ossec/etc/authd.pass
  sudo chown root:wazuh /var/ossec/etc/authd.pass
  set -e
  sudo systemctl enable wazuh-agent
  sudo systemctl start wazuh-agent
}

function updateWazuhAgents()
{
  agent_ver="$1"
  if [ -z "$agent_ver" ]; then
    agent_ver=$WAZUH_AGENT_VERSION
  fi
  sudo apt-mark unhold wazuh-agent
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo systemctl daemon-reload > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wazuh-agent=$agent_ver
  sudo apt-mark hold wazuh-agent
  if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    rm -f $HOME/rsUpdateScript.sh
    cat <<EOFLO > $HOME/rsUpdateScript.sh
#!/bin/bash

set +e
function main()
{
  read -r -s -p "" rspw
  echo "\$rspw" | sudo -S -v -p "" > /dev/null 2>&1
  sudo apt-mark unhold wazuh-agent
  sudo DEBIAN_FRONTEND=noninteractive apt update
  sudo DEBIAN_FRONTEND=noninteractive apt install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' wazuh-agent=$agent_ver
  sudo apt-mark hold wazuh-agent
}
main "\$@"
EOFLO
    updateRelayServerWithScript
  fi
}

function removeWazuhAgent()
{
  echo "Removing any prior wazuh agent installation..."
  sudo systemctl daemon-reload > /dev/null 2>&1
  sudo systemctl stop wazuh-agent > /dev/null 2>&1
  sudo systemctl disable wazuh-agent > /dev/null 2>&1
  sudo DEBIAN_FRONTEND=noninteractive apt remove --purge wazuh-agent -y --allow-change-held-packages > /dev/null 2>&1
  sudo apt-mark unhold wazuh-agent > /dev/null 2>&1
  sudo systemctl daemon-reload > /dev/null 2>&1
}

function version91WazuhUpdate()
{
  vnwu_curE=${-//[^e]/}
  set +e
  grep "<rules_id>5763</rules_id>" $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo tee -a $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf >/dev/null <<EOFWZ

<ossec_config>
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>5763</rules_id>
    <timeout>300</timeout>
  </active-response>
</ossec_config>

EOFWZ
  fi

  grep "<rules_id>5763</rules_id>" $HSHQ_STACKS_DIR/wazuh/volumes/etc/ossec.conf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo tee -a $HSHQ_STACKS_DIR/wazuh/volumes/etc/ossec.conf >/dev/null <<EOFWZ

<ossec_config>
  <active-response>
    <command>firewall-drop</command>
    <location>local</location>
    <rules_id>5763</rules_id>
    <timeout>300</timeout>
  </active-response>
</ossec_config>

EOFWZ
  fi

  grep "firewall-drop" $HSHQ_STACKS_DIR/wazuh/volumes/etc/rules/local_rules.xml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sudo tee -a $HSHQ_STACKS_DIR/wazuh/volumes/etc/rules/local_rules.xml >/dev/null <<EOFRU

<group name="ossec,">
  <rule id="651" level="13" overwrite="yes">
    <if_sid>650</if_sid>
    <options>alert_by_email</options>
    <field name="parameters.program">firewall-drop</field>
    <field name="command">add</field>
    <description>Host Blocked by firewall-drop Active Response</description>
    <group>active_response,pci_dss_11.4,gpg13_4.13,gdpr_IV_35.7.d,nist_800_53_SI.4,tsc_CC6.1,tsc_CC6.8,tsc_CC7.2,tsc_CC7.3,tsc_CC7.4,</group>
  </rule>
</group>

EOFRU
  fi
  echo "Restarting Wazuh manager, please wait..."
  docker exec -it wazuh.manager service wazuh-manager restart > /dev/null 2>&1
  set +e
  if ! [ -z "$vnwu_curE" ]; then
    set -e
  fi
}

function version412WazuhUpdate()
{
  set +e
  grep "<indexer>" $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    wazblock=$(
    cat <<EOFWZ
</vulnerability-detection>

  <indexer>
    <enabled>yes</enabled>
    <hosts>
      <host>https://wazuh.indexer:9200</host>
    </hosts>
    <ssl>
      <certificate_authorities>
        <ca>/etc/ssl/root-ca.pem</ca>
      </certificate_authorities>
      <certificate>/etc/ssl/filebeat.pem</certificate>
      <key>/etc/ssl/filebeat.key</key>
    </ssl>
  </indexer>
EOFWZ
    )
    all_text="$(cat $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf)"
    block_match="</vulnerability-detection>"
    echo -e "${all_text%%$block_match*}${wazblock}${all_text##*$block_match}" | sudo tee $HSHQ_STACKS_DIR/wazuh/wazuh-cluster/wazuh_manager.conf
  fi
}

# Collabora
function installCollabora()
{
  set +e
  is_integrate_hshq=$1
  # And don't forget to check if directory exists
  checkDeleteStackAndDirectory collabora "Collabora"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  mkdir $HSHQ_STACKS_DIR/collabora
  pullImage $(getScriptImageByContainerName collabora)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  initServicesCredentials
  outputConfigCollabora
  installStack collabora collabora " " $HOME/collabora.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  inner_block=""
  inner_block=$inner_block">>https://$SUB_COLLABORA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>encode gzip\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://collabora:9980 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_COLLABORA $MANAGETLS_COLLABORA "$is_integrate_hshq" $NETDEFAULT_COLLABORA "$inner_block"

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcUptimeKuma collabora "$FMLNAME_COLLABORA" $USERTYPE_COLLABORA "https://$SUB_COLLABORA.$HOMESERVER_DOMAIN" true
    insertEnableSvcHeimdall collabora "$FMLNAME_COLLABORA Admin" admin "https://$SUB_COLLABORA.$HOMESERVER_DOMAIN/browser/dist/admin/admin.html" "collabora.png" true "$(getHeimdallOrderFromSub $SUB_COLLABORA admin)"
    restartAllCaddyContainers
  fi
}

function outputConfigCollabora()
{
  cat <<EOFCO > $HOME/collabora-compose.yml
$STACK_VERSION_PREFIX collabora $(getScriptStackVersion collabora)

services:
  collabora:
    image: $(getScriptImageByContainerName collabora)
    container_name: collabora
    hostname: collabora
    restart: unless-stopped
    env_file: stack.env
    cap_add:
      - MKNOD
      - SYS_ADMIN
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFCO

  cat <<EOFCO > $HOME/collabora.env
username=$COLLABORA_ADMIN_USERNAME
password=$COLLABORA_ADMIN_PASSWORD
aliasgroup1=https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN:443
extra_params=--o:ssl.enable=false --o:ssl.termination=true --o:net.frame_ancestors=*
EOFCO
}

function performUpdateCollabora()
{
  perform_stack_name=collabora
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v7
      curImageList=collabora/code:23.05.5.3.1
      image_update_map[0]="collabora/code:23.05.5.3.1,collabora/code:24.04.13.2.1"
    ;;
    2)
      newVer=v7
      curImageList=collabora/code:23.05.6.4.1
      image_update_map[0]="collabora/code:23.05.6.4.1,collabora/code:24.04.13.2.1"
    ;;
    3)
      newVer=v7
      curImageList=collabora/code:23.05.8.2.1
      image_update_map[0]="collabora/code:23.05.8.2.1,collabora/code:24.04.13.2.1"
    ;;
    4)
      newVer=v7
      curImageList=collabora/code:23.05.9.4.1
      image_update_map[0]="collabora/code:23.05.9.4.1,collabora/code:24.04.13.2.1"
    ;;
    5)
      newVer=v7
      curImageList=collabora/code:24.04.5.2.1
      image_update_map[0]="collabora/code:24.04.5.2.1,collabora/code:24.04.13.2.1"
    ;;
    6)
      newVer=v7
      curImageList=collabora/code:24.04.9.1.1
      image_update_map[0]="collabora/code:24.04.9.1.1,collabora/code:24.04.13.2.1"
    ;;
    7)
      newVer=v7
      curImageList=collabora/code:24.04.13.2.1
      image_update_map[0]="collabora/code:24.04.13.2.1,collabora/code:24.04.13.2.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Nextcloud
function installNextcloud()
{
  set +e
  is_integrate_hshq=$1
  # With great power comes great responsibility
  checkDeleteStackAndDirectory nextcloud "Nextcloud"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-imaginary)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-push)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-talkhpb)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName nextcloud-talkrecord)
  if [ $? -ne 0 ]; then
    return 1
  fi
  if ! [ -d $HSHQ_STACKS_DIR/coturn ]; then
    echo "Missing coturn, installing..."
    installCoturn
    retval=$?
    if [ $retval -ne 0 ]; then
      notifyStackInstallFailure coturn
    fi
  fi
  stack_name=nextcloud
  set -e
  initServicesCredentials
  if [ -z "$NEXTCLOUD_REDIS_PASSWORD" ]; then
    NEXTCLOUD_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar NEXTCLOUD_REDIS_PASSWORD $NEXTCLOUD_REDIS_PASSWORD
  fi
  set +e
  docker exec mailu-admin flask mailu alias-delete $NEXTCLOUD_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $NEXTCLOUD_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  generateCert nextcloud-app nextcloud-app
  generateCert nextcloud-cron nextcloud-cron
  generateCert nextcloud-web nextcloud-web
  generateCert nextcloud-push nextcloud-push

  numTries=5
  curTries=1
  while [ $curTries -le $numTries ]
  do
    mkdir $HSHQ_STACKS_DIR/nextcloud
    mkdir $HSHQ_STACKS_DIR/nextcloud/app
    mkdir $HSHQ_STACKS_DIR/nextcloud/db
    mkdir $HSHQ_STACKS_DIR/nextcloud/dbexport
    mkdir $HSHQ_STACKS_DIR/nextcloud/web
    mkdir $HSHQ_STACKS_DIR/nextcloud/ssl
    mkdir $HSHQ_STACKS_DIR/nextcloud/record
    chmod 777 $HSHQ_STACKS_DIR/nextcloud/dbexport
    outputConfigNextcloud
    cd ~
    docker compose -f $HOME/nextcloud-compose-tmp.yml up -d
    search="ready to handle connections"
    error_text="rsync error"
    isFound=false
    isError=false
    i=0
    set +e
    while [ $i -le 300 ]
    do
      findtext=$(docker logs nextcloud-app 2>&1 | grep "$search")
      finderror=$(docker logs nextcloud-app 2>&1 | grep "$error_text")
      if ! [ -z "$finderror" ]; then
        isError=true
        break
      fi
      if ! [ -z "$findtext" ]; then
        isFound=true
        break
      fi
      echo "Container not ready, sleeping 5 seconds, total wait=$i seconds..."
      sleep 5
      i=$((i+5))
    done
    if [ "$isFound" = "true" ] && [ "$isError" = "false" ]; then
      break
    fi
    if [ "$isError" = "true" ]; then
      echo "(Attempt $curTries of $numTries) Error starting Nextcloud stack, restarting..."
    fi
    cd ~
    docker compose -f $HOME/nextcloud-compose-tmp.yml down -v
    sudo rm -fr $HSHQ_STACKS_DIR/nextcloud
    ((curTries++))
  done
  if ! [ "$isFound" = "true" ]; then
    cd ~
    docker compose -f $HOME/nextcloud-compose-tmp.yml down -v
    performNextcloudInstallFailCleanup
    echo "ERROR: Nextcloud unknown installation error, exiting..."
    return 2
  fi

  # Regarding the next section, see the following:
  #   https://github.com/nextcloud/server/issues/14482
  #   https://github.com/nextcloud/server/issues/14926
  #   https://github.com/nextcloud/server/issues/40082
  #   https://github.com/nextcloud/server/issues/45162
  # These are just a few, but there are more related.
  # It doesn't appear as if they will ever fix this,
  # so certain measures have been put in place to
  # increase the success rate of installation.
  if sudo test -f $HSHQ_STACKS_DIR/nextcloud/app/lib/private/App/AppStore/Fetcher/Fetcher.php; then
    sudo sed -i "s/'timeout' => 60/'timeout' => 600/g" $HSHQ_STACKS_DIR/nextcloud/app/lib/private/App/AppStore/Fetcher/Fetcher.php > /dev/null 2>&1
  fi
  echo "Sleeping 10 seconds..."
  sleep 10
  set +e
  # Check to see if apps.json has downloaded
  numTries=30
  curTries=1
  isFound=false
  while [ $curTries -le $numTries ]
  do
    sudo find $HSHQ_STACKS_DIR/nextcloud/app/data -name apps.json | grep . > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      isFound=true
      break
    fi
    if [ $curTries -eq 1 ]; then
      echo "Issue with apps.json manifest, restarting nextcloud-app and nextcloud-cron containers..."
      docker container restart nextcloud-app > /dev/null 2>&1
      docker container restart nextcloud-cron > /dev/null 2>&1
      sleep 10
      echo "Calling occ app:update --all, this may take a few minutes, please be patient..."
      docker exec -u www-data nextcloud-app php occ app:update --all > /dev/null 2>&1
    fi
    echo "Nextcloud apps.json manifest not present, attempt ($curTries of $numTries) retrying in 10 seconds..."
    sleep 10
    ((curTries++))
  done
  if [ "$isFound" = "false" ]; then
    cd ~
    docker compose -f $HOME/nextcloud-compose-tmp.yml down -v
    performNextcloudInstallFailCleanup
    echo "ERROR: Nextcloud could not obtain apps manifest, exiting..."
    return 3
  fi

  ls /usr/local/share/ca-certificates/ | while read cert
  do
    docker exec -u www-data nextcloud-app php occ --no-warnings security:certificates:import /usr/local/share/ca-certificates/$cert
  done
  docker exec -u www-data nextcloud-app php occ --no-warnings config:system:set default_phone_region --type string --value="$DEFAULT_PHONE_REGION"
  docker exec -u www-data nextcloud-app php occ --no-warnings config:system:set allow_local_remote_servers --value=true
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install calendar
  # Sometimes there are issues with apps, check the first one to see if there is an error.
  if [ $? -ne 0 ]; then
    cd ~
    docker compose -f $HOME/nextcloud-compose-tmp.yml down -v
    performNextcloudInstallFailCleanup
    echo "ERROR: Nextcloud apps did not install correctly, exiting..."
    return 4
  fi
  docker exec -u www-data nextcloud-app php occ user:setting $NEXTCLOUD_ADMIN_USERNAME settings email "$NEXTCLOUD_ADMIN_EMAIL_ADDRESS"
  docker exec -u www-data nextcloud-app php occ user:setting $NEXTCLOUD_ADMIN_USERNAME settings display_name "${HOMESERVER_ABBREV^^} Nextcloud Admin"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install bruteforcesettings
  docker exec -u www-data nextcloud-app php occ --no-warnings app:enable bruteforcesettings
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install contacts
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install groupfolders
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install tasks
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install deck
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install forms
  docker exec -u www-data nextcloud-app php occ --no-warnings app:enable user_ldap
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install mail
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install maps
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install notes
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install spreed
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install integration_excalidraw
  docker exec -u www-data nextcloud-app php occ config:app:set integration_excalidraw base_url --value="https://$SUB_EXCALIDRAW_WEB.$HOMESERVER_DOMAIN"
  docker exec -u www-data nextcloud-app php occ config:app:set integration_excalidraw enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install integration_mastodon
  docker exec -u www-data nextcloud-app php occ config:app:set integration_mastodon use_popup --value="1"
  docker exec -u www-data nextcloud-app php occ config:app:set integration_mastodon oauth_instance_url --value="https://$SUB_MASTODON.$HOMESERVER_DOMAIN"
  docker exec -u www-data nextcloud-app php occ config:app:set integration_mastodon enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install riotchat
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install previewgenerator
  docker exec -u www-data nextcloud-app php occ config:app:set riotchat custom_json --value="{\"disable_guests\":true,\"piwik\":false,\"settingDefaults\":{\"language\":\"en\"},\"disable_custom_urls\":true,\"disable_login_language_selector\":true,\"disable_3pid_login\": true,\"default_server_config\":{\"m.homeserver\":{\"base_url\":\"https:\/\/$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN\",\"server_name\":\"$HOMESERVER_DOMAIN\"}},\"brand\":\"Nextcloud\",\"branding\":{\"authHeaderLogoUrl\":\"\/core\/img\/logo\/logo.svg?v=0\"},\"showLabsSettings\":true,\"sso_immediate_redirect\":false,\"jitsi\": {\"preferred_domain\": \"$SUB_JITSI.$HOMESERVER_DOMAIN\"},\"roomDirectory\": {\"servers\": [\"$HOMESERVER_DOMAIN\"]},\"default_theme\": \"dark\"}"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install jitsi
  docker exec -u www-data nextcloud-app php occ config:app:set jitsi display_join_using_the_jitsi_app --value=1
  docker exec -u www-data nextcloud-app php occ config:app:set jitsi jitsi_server_url --value="https://$SUB_JITSI.$HOMESERVER_DOMAIN"
  docker exec -u www-data nextcloud-app php occ config:app:set jitsi enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ config:app:set spreed turn_servers --value="[{\"schemes\":\"turn\",\"server\":\"$SUB_COTURN.$HOMESERVER_DOMAIN:$COTURN_PRIMARY_PORT\",\"secret\":\"$COTURN_STATIC_SECRET\",\"protocols\":\"udp,tcp\"}]" > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ config:app:set spreed signaling_servers --value="{\"servers\":[{\"server\":\"https:\/\/$SUB_NCTALKHPB.$HOMESERVER_DOMAIN\/standalone-signaling\",\"verify\":true}],\"secret\":\"$NEXTCLOUD_TALKHPB_SIGNALING_SECRET\"}" > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ config:app:set spreed recording_servers --value="{\"servers\":[{\"server\":\"https:\/\/$SUB_NCTALKRECORD.$HOMESERVER_DOMAIN\",\"verify\":true}],\"secret\":\"$NEXTCLOUD_TALKHPB_RECORDING_SECRET\"}" > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ config:app:set spreed enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install richdocuments
  docker exec -u www-data nextcloud-app php occ config:app:set richdocuments wopi_allowlist --value="10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 127.0.0.0/8"
  docker exec -u www-data nextcloud-app php occ config:app:set richdocuments public_wopi_url --value="https://$SUB_COLLABORA.$HOMESERVER_DOMAIN"
  docker exec -u www-data nextcloud-app php occ config:app:set richdocuments wopi_url --value="https://$SUB_COLLABORA.$HOMESERVER_DOMAIN:443"
  docker exec -u www-data nextcloud-app php occ config:app:set richdocuments federation_use_trusted_domains --value="yes"
  docker exec -u www-data nextcloud-app php occ config:app:set richdocuments enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install files_mindmap
  docker exec -u www-data nextcloud-app php occ ldap:create-empty-config
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapAgentName "$LDAP_ADMIN_BIND_DN"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapAgentPassword "$LDAP_ADMIN_BIND_PASSWORD" > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapBase "$LDAP_BASE_DN"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapBaseGroups "$LDAP_BASE_DN"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapBaseUsers "$LDAP_BASE_DN"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapExpertUsernameAttr "uid"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapGroupFilter "(&(|(objectclass=groupOfUniqueNames)(objectclass=posixGroup)(objectclass=top))(|(cn=$LDAP_ADMIN_USER_GROUP_NAME)(cn=$LDAP_PRIMARY_USER_GROUP_NAME)))"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapGroupFilterGroups "$LDAP_ADMIN_USER_GROUP_NAME;$LDAP_PRIMARY_USER_GROUP_NAME"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapGroupFilterObjectclass "groupOfUniqueNames;posixGroup;top"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapGroupMemberAssocAttr "uniqueMember"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapHost "ldaps://ldapserver"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapPort "636"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapLoginFilter "(&(&(|(objectclass=inetOrgPerson)(objectclass=person)(objectclass=posixAccount))(|(memberof=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)(memberof=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)))(uid=%uid))"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapUserFilter "(&(|(objectclass=inetOrgPerson)(objectclass=person)(objectclass=posixAccount))(|(memberof=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)(memberof=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)))"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapUserFilterGroups "$LDAP_ADMIN_USER_GROUP_NAME;$LDAP_PRIMARY_USER_GROUP_NAME"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapUserFilterObjectclass "inetOrgPerson;person;posixAccount"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 turnOnPasswordChange "1"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 useMemberOfToDetectMembership "1"
  docker exec -u www-data nextcloud-app php occ ldap:set-config s01 ldapConfigurationActive "1"
  docker exec -u www-data nextcloud-app php occ ldap:test-config s01
  docker exec -u www-data nextcloud-app php occ config:app:set user_ldap enabled --value="yes"
  docker exec -u www-data nextcloud-app php occ ldap:check-user --force "$LDAP_ADMIN_USER_USERNAME"
  docker exec -u www-data nextcloud-app php occ ldap:search "$LDAP_ADMIN_USER_USERNAME"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install ldap_write_support
  docker exec -u www-data nextcloud-app php occ config:system:set trusted_domains 2 --value=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
  docker exec -u www-data nextcloud-app php occ config:system:set enabledPreviewProviders 0 --value="OC\\Preview\\Imaginary"
  docker exec -u www-data nextcloud-app php occ config:system:set preview_imaginary_url --value="http://nextcloud-imaginary:$NEXTCLOUD_IMAGINARY_PORT"
  docker exec -u www-data nextcloud-app php occ --no-warnings app:install notify_push
  docker exec -u www-data nextcloud-app php occ config:system:set maintenance_window_start --type=integer --value=1

  if ! [ "$(isServiceDisabled clamav)" = "true" ]; then
    docker exec -u www-data nextcloud-app php occ --no-warnings app:install files_antivirus
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_mode --value="daemon"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_host --value="antivirus"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_port --value="3310"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_stream_max_length --value="26214400"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_max_file_size --value="-1"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus av_infected_action --value="delete"
    docker exec -u www-data nextcloud-app php occ config:app:set files_antivirus enabled --value="yes"
  fi
  docker exec -u www-data nextcloud-app php occ db:add-missing-indices > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ maintenance:repair --include-expensive > /dev/null 2>&1
  docker exec -u www-data nextcloud-app php occ background:cron

  sleep 5
  cd ~
  docker compose -f $HOME/nextcloud-compose-tmp.yml down -v
  rm -f $HOME/nextcloud-compose-tmp.yml

  if sudo test -d $HSHQ_STACKS_DIR/nextcloud/app/custom_apps/notify_push/bin; then
    # This is dumb. https://github.com/nextcloud/notify_push/issues/355
    sudo chmod -R 755 $HSHQ_STACKS_DIR/nextcloud/app/custom_apps/notify_push/bin
  else
    performNextcloudInstallFailCleanup
    echo "ERROR: Nextcloud Push plugin was not installed correctly, exiting..."
    return 5
  fi
  echo "post_max_size=16G" | sudo tee -a $HSHQ_STACKS_DIR/nextcloud/app/.user.ini
  echo "upload_max_filesize=16G" | sudo tee -a $HSHQ_STACKS_DIR/nextcloud/app/.user.ini
  echo "memory_limit=2G" | sudo tee -a $HSHQ_STACKS_DIR/nextcloud/app/.user.ini
  echo "max_input_time=3600" | sudo tee -a $HSHQ_STACKS_DIR/nextcloud/app/.user.ini
  echo "max_execution_time=3600" | sudo tee -a $HSHQ_STACKS_DIR/nextcloud/app/.user.ini
  #sudo sed -i "s/'overwrite.cli.url'.*/'overwrite.cli.url' => 'https:\/\/$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN',/" $HSHQ_STACKS_DIR/nextcloud/app/config/config.php
  installStack nextcloud nextcloud-app "ready to handle connections" $HOME/nextcloud.env
  if [ $? -ne 0 ]; then
    nc_arr=($(docker ps --filter name=nextcloud --format "{{.Names}}"))
    for curcont in "${nc_arr[@]}"
    do
      docker container stop $curcont
      docker container rm $curcont
    done
    docker volume rm nextcloud_v-nextcloud > /dev/null 2>&1
    docker image rm $(getScriptImageByContainerName nextcloud-app) > /dev/null 2>&1
    docker image rm $(getScriptImageByContainerName nextcloud-imaginary) > /dev/null 2>&1
    stack_name=nextcloud
    echo "ERROR: Nextcloud did not start up correctly, exiting..."
    return 6
  fi
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>rewrite /.well-known/carddav /remote.php/dav\n"
  inner_block=$inner_block">>>>rewrite /.well-known/caldav /remote.php/dav\n"
  inner_block=$inner_block">>>>rewrite /.well-known/webfinger /index.php/.well-known/webfinger\n"
  inner_block=$inner_block">>>>rewrite /.well-known/nodeinfo /index.php/.well-known/nodeinfo\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>route /push/* {\n"
  inner_block=$inner_block">>>>>>>>uri strip_prefix /push\n"
  inner_block=$inner_block">>>>>>>>reverse_proxy http://nextcloud-push:$NEXTCLOUD_PUSH_PORT\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://nextcloud-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NEXTCLOUD $MANAGETLS_NEXTCLOUD "$is_integrate_hshq" $NETDEFAULT_NEXTCLOUD "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_NCTALKHPB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NCTALKHPB.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>route /standalone-signaling/* {\n"
  inner_block=$inner_block">>>>>>>>uri strip_prefix /standalone-signaling\n"
  inner_block=$inner_block">>>>>>>>reverse_proxy http://nextcloud-talkhpb:8081 {\n"
  inner_block=$inner_block">>>>>>>>>>import trusted-proxy-list\n"
  inner_block=$inner_block">>>>>>>>>>header_up X-Real-IP {remote_host}\n"
  inner_block=$inner_block">>>>>>>>}\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NCTALKHPB $MANAGETLS_NCTALKHPB "$is_integrate_hshq" $NETDEFAULT_NCTALKHPB "$inner_block"
  insertSubAuthelia $SUB_NCTALKHPB.$HOMESERVER_DOMAIN bypass

  inner_block=""
  inner_block=$inner_block">>https://$SUB_NCTALKRECORD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NCTALKHPB.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://nextcloud-talkrecord:1234 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NCTALKRECORD $MANAGETLS_NCTALKRECORD "$is_integrate_hshq" $NETDEFAULT_NCTALKRECORD "$inner_block"
  insertSubAuthelia $SUB_NCTALKRECORD.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll nextcloud "$FMLNAME_NEXTCLOUD" $USERTYPE_NEXTCLOUD "https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN" "nextcloud.png" "$(getHeimdallOrderFromSub $SUB_NEXTCLOUD $USERTYPE_NEXTCLOUD)"
    restartAllCaddyContainers
  fi
  docker exec -u www-data nextcloud-app php occ app:enable notify_push
  docker exec -u www-data nextcloud-app php occ notify_push:setup https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN/push
}

function performNextcloudInstallFailCleanup()
{
  sudo rm -fr $HSHQ_STACKS_DIR/nextcloud
  rm -f $HOME/nextcloud-compose-tmp.yml
  rm -f $HOME/nextcloud-compose.yml
  rm -f $HOME/nextcloud.env
  rm -f $HOME/nextcloud-json.tmp
  docker volume rm nextcloud_v-nextcloud > /dev/null 2>&1
  docker image rm $(getScriptImageByContainerName nextcloud-app) > /dev/null 2>&1
  docker image rm $(getScriptImageByContainerName nextcloud-imaginary) > /dev/null 2>&1
  stack_name=nextcloud
}

function outputConfigNextcloud()
{
  NCTALKRECORD_PYTHON_VER=python3.13
  outputNGINXConfigNextcloud
  cat <<EOFNC > $HSHQ_STACKS_DIR/nextcloud/www.conf
[www]
user = www-data
group = www-data
listen = 127.0.0.1:9000 
pm = dynamic
pm.max_children = 200
pm.start_servers = 50
pm.min_spare_servers = 50
pm.max_spare_servers = 150

EOFNC

  cat <<EOFLD > $HSHQ_STACKS_DIR/nextcloud/ldap-app.conf
TLS_CERT /opt/ssl/nextcloud-app.crt
TLS_KEY /opt/ssl/nextcloud-app.key
TLS_CACERT /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
TLS_REQCERT demand
TLS_REQSAN demand
EOFLD

  cat <<EOFLC > $HSHQ_STACKS_DIR/nextcloud/ldap-cron.conf
TLS_CERT /opt/ssl/nextcloud-cron.crt
TLS_KEY /opt/ssl/nextcloud-cron.key
TLS_CACERT /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
TLS_REQCERT demand
TLS_REQSAN demand
EOFLC

  cat <<EOFLC > $HSHQ_STACKS_DIR/nextcloud/ldap-push.conf
TLS_CERT /opt/ssl/nextcloud-push.crt
TLS_KEY /opt/ssl/nextcloud-push.key
TLS_CACERT /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
TLS_REQCERT demand
TLS_REQSAN demand
EOFLC

  cat <<EOFNC > $HOME/nextcloud-compose-tmp.yml
services:
  nextcloud-db:
    image: $(getScriptImageByContainerName nextcloud-db)
    container_name: nextcloud-db
    hostname: nextcloud-db
    user: "${USERID}"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-nextcloud-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${HSHQ_STACKS_DIR}/nextcloud/db:/var/lib/postgresql/data
    environment:
      - TZ=$TZ
      - POSTGRES_DB=$NEXTCLOUD_DATABASE_NAME
      - POSTGRES_USER=$NEXTCLOUD_DATABASE_USER
      - POSTGRES_PASSWORD=$NEXTCLOUD_DATABASE_USER_PASSWORD

  nextcloud-redis:
    image: $(getScriptImageByContainerName nextcloud-redis)
    container_name: nextcloud-redis
    hostname: nextcloud-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - TZ=$TZ
      - ALLOW_EMPTY_PASSWORD=no
      - REDIS_PASSWORD=$NEXTCLOUD_REDIS_PASSWORD
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
      - REDIS_TLS_ENABLED=no

  nextcloud-app:
    image: $(getScriptImageByContainerName nextcloud-app)
    container_name: nextcloud-app
    hostname: nextcloud-app
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ldap-net
      - dock-internalmail-net
      - int-nextcloud-net
      - dock-ext-net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - $HSHQ_STACKS_DIR/nextcloud/www.conf:/usr/local/etc/php-fpm.d/www.conf
      - $HSHQ_SSL_DIR/nextcloud-app.crt:/opt/ssl/nextcloud-app.crt
      - $HSHQ_SSL_DIR/nextcloud-app.key:/opt/ssl/nextcloud-app.key
      - $HSHQ_STACKS_DIR/nextcloud/ldap-app.conf:/etc/openldap/ldap.conf
      - v-nextcloud:/var/www/html
    environment:
      - TZ=$TZ
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=$NEXTCLOUD_DATABASE_NAME
      - POSTGRES_USER=$NEXTCLOUD_DATABASE_USER
      - POSTGRES_PASSWORD=$NEXTCLOUD_DATABASE_USER_PASSWORD
      - REDIS_HOST_PASSWORD=$NEXTCLOUD_REDIS_PASSWORD
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_ADMIN_USER=$NEXTCLOUD_ADMIN_USERNAME
      - NEXTCLOUD_ADMIN_PASSWORD=$NEXTCLOUD_ADMIN_PASSWORD
      - SMTP_MODE=smtp
      - SMTP_HOST=$SMTP_HOSTNAME
      - SMTP_PORT=$SMTP_HOSTPORT
      - SMTP_SECURE=tls
      - SMTP_AUTH=0
      - SMTP_AUTHTYPE=NONE
      - MAIL_FROM_ADDRESS=$EMAIL_SMTP_USERNAME
      - MAIL_DOMAIN=$HOMESERVER_DOMAIN
      - "NEXTCLOUD_TRUSTED_DOMAINS=nextcloud-web"
      - "TRUSTED_PROXIES=$TRUSTED_PROXIES"
      - NEXTCLOUD_DATA_DIR=/var/www/html/data
      - OVERWRITEHOST=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - OVERWRITECLIURL=https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - OVERWRITEPROTOCOL=https

  nextcloud-cron:
    image: $(getScriptImageByContainerName nextcloud-cron)
    container_name: nextcloud-cron
    hostname: nextcloud-cron
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    entrypoint: /cron.sh
    networks:
      - dock-proxy-net
      - dock-ldap-net
      - dock-internalmail-net
      - int-nextcloud-net
      - dock-ext-net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - $HSHQ_SSL_DIR/nextcloud-cron.crt:/opt/ssl/nextcloud-cron.crt
      - $HSHQ_SSL_DIR/nextcloud-cron.key:/opt/ssl/nextcloud-cron.key
      - $HSHQ_STACKS_DIR/nextcloud/ldap-cron.conf:/etc/openldap/ldap.conf
      - v-nextcloud:/var/www/html
    environment:
      - TZ=$TZ
      - POSTGRES_HOST=nextcloud-db
      - POSTGRES_DB=$NEXTCLOUD_DATABASE_NAME
      - POSTGRES_USER=$NEXTCLOUD_DATABASE_USER
      - POSTGRES_PASSWORD=$NEXTCLOUD_DATABASE_USER_PASSWORD
      - REDIS_HOST_PASSWORD=$NEXTCLOUD_REDIS_PASSWORD
      - REDIS_HOST=nextcloud-redis
      - NEXTCLOUD_ADMIN_USER=$NEXTCLOUD_ADMIN_USERNAME
      - NEXTCLOUD_ADMIN_PASSWORD=$NEXTCLOUD_ADMIN_PASSWORD
      - SMTP_MODE=smtp
      - SMTP_HOST=$SMTP_HOSTNAME
      - SMTP_PORT=$SMTP_HOSTPORT
      - SMTP_SECURE=tls
      - SMTP_AUTH=0
      - SMTP_AUTHTYPE=NONE
      - MAIL_FROM_ADDRESS=$EMAIL_SMTP_USERNAME
      - MAIL_DOMAIN=$HOMESERVER_DOMAIN
      - "NEXTCLOUD_TRUSTED_DOMAINS=nextcloud-web"
      - "TRUSTED_PROXIES=$TRUSTED_PROXIES"
      - NEXTCLOUD_DATA_DIR=/var/www/html/data

  nextcloud-imaginary:
    image: $(getScriptImageByContainerName nextcloud-imaginary)
    container_name: nextcloud-imaginary
    hostname: nextcloud-imaginary
    restart: unless-stopped
    command: -concurrency 50 -enable-url-source
    cap_add:
      - SYS_NICE
    networks:
      - int-nextcloud-net
      - dock-proxy-net
    depends_on:
      - nextcloud-app
    environment:
      - PORT=$NEXTCLOUD_IMAGINARY_PORT

  nextcloud-talkhpb:
    image: $(getScriptImageByContainerName nextcloud-talkhpb)
    container_name: nextcloud-talkhpb
    hostname: nextcloud-talkhpb
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - nextcloud-app
    environment:
      - NC_DOMAIN=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - TALK_HOST=$SUB_COTURN.$HOMESERVER_DOMAIN
      - TALK_PORT=$COTURN_PRIMARY_PORT
      - TURN_SECRET=$COTURN_STATIC_SECRET
      - SIGNALING_SECRET=$NEXTCLOUD_TALKHPB_SIGNALING_SECRET
      - INTERNAL_SECRET=$NEXTCLOUD_TALKHPB_INTERNAL_SECRET
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  nextcloud-talkrecord:
    image: $(getScriptImageByContainerName nextcloud-talkrecord)
    container_name: nextcloud-talkrecord
    hostname: nextcloud-talkrecord
    user: "122"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - nextcloud-app
    environment:
      - NC_DOMAIN=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - TZ=$TZ
      - RECORDING_SECRET=$NEXTCLOUD_TALKHPB_RECORDING_SECRET
      - INTERNAL_SECRET=$NEXTCLOUD_TALKHPB_INTERNAL_SECRET
      - SKIP_VERIFY=true
      - HPB_DOMAIN=$SUB_NCTALKHPB.$HOMESERVER_DOMAIN
    shm_size: 1073741824
    read_only: true
    tmpfs:
      - /conf
    cap_drop:
      - NET_RAW
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/$NCTALKRECORD_PYTHON_VER/site-packages/certifi/cacert.pem:ro
      - v-nextcloud-record:/tmp:rw

  nextcloud-web:
    image: $(getScriptImageByContainerName nextcloud-web)
    container_name: nextcloud-web
    hostname: nextcloud-web
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - int-nextcloud-net
    depends_on:
      - nextcloud-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-nextcloud:/var/www/html:ro
      - $HSHQ_STACKS_DIR/nextcloud/web/nginx.conf:/etc/nginx/nginx.conf
      - $HSHQ_SSL_DIR/nextcloud-web.crt:/etc/nginx/certs/cert.crt
      - $HSHQ_SSL_DIR/nextcloud-web.key:/etc/nginx/certs/cert.key
    environment:
      - TZ=$TZ

volumes:
  v-nextcloud:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: $HSHQ_STACKS_DIR/nextcloud/app
  v-nextcloud-record:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: $HSHQ_STACKS_DIR/nextcloud/record

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-nextcloud-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFNC

  outputComposeNextcloud

  cat <<EOFNC > $HOME/nextcloud.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
REDIS_TLS_ENABLED=no
PYTHON_VER=python3.13
EOFNC
}

function outputComposeNextcloud()
{
  rm -f $HOME/nextcloud-compose.yml
  cat <<EOFNC > $HOME/nextcloud-compose.yml
$STACK_VERSION_PREFIX nextcloud $(getScriptStackVersion nextcloud)

services:
  nextcloud-db:
    image: $(getScriptImageByContainerName nextcloud-db)
    container_name: nextcloud-db
    hostname: nextcloud-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-nextcloud-net
      - dock-dbs-net
    depends_on:
      - nextcloud-redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/nextcloud/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/nextcloud/dbexport:/dbexport
    environment:
      - TZ=$TZ
      - POSTGRES_DB=$NEXTCLOUD_DATABASE_NAME
      - POSTGRES_USER=$NEXTCLOUD_DATABASE_USER
      - POSTGRES_PASSWORD=$NEXTCLOUD_DATABASE_USER_PASSWORD
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.nextcloud-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.nextcloud-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.nextcloud-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.nextcloud-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.nextcloud-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.nextcloud-hourly-db.email-from=Nextcloud Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.nextcloud-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.nextcloud-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.nextcloud-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.nextcloud-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.nextcloud-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.nextcloud-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.nextcloud-monthly-db.email-from=Nextcloud Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.nextcloud-monthly-db.mail-only-on-error=false"

  nextcloud-redis:
    image: $(getScriptImageByContainerName nextcloud-redis)
    container_name: nextcloud-redis
    hostname: nextcloud-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - REDIS_PASSWORD=$NEXTCLOUD_REDIS_PASSWORD

  nextcloud-app:
    image: $(getScriptImageByContainerName nextcloud-app)
    container_name: nextcloud-app
    hostname: nextcloud-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ldap-net
      - dock-proxy-net
      - dock-internalmail-net
      - int-nextcloud-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/nextcloud/www.conf:/usr/local/etc/php-fpm.d/www.conf
      - \${HSHQ_SSL_DIR}/nextcloud-app.crt:/opt/ssl/nextcloud-app.crt
      - \${HSHQ_SSL_DIR}/nextcloud-app.key:/opt/ssl/nextcloud-app.key
      - \${HSHQ_STACKS_DIR}/nextcloud/ldap-app.conf:/etc/openldap/ldap.conf
      - v-nextcloud:/var/www/html
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    environment:
      - OVERWRITEHOST=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - OVERWRITECLIURL=https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - OVERWRITEPROTOCOL=https

  nextcloud-cron:
    image: $(getScriptImageByContainerName nextcloud-cron)
    container_name: nextcloud-cron
    hostname: nextcloud-cron
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    entrypoint: /cron.sh
    networks:
      - dock-ldap-net
      - dock-proxy-net
      - dock-internalmail-net
      - int-nextcloud-net
      - dock-ext-net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/nextcloud-cron.crt:/opt/ssl/nextcloud-cron.crt
      - \${HSHQ_SSL_DIR}/nextcloud-cron.key:/opt/ssl/nextcloud-cron.key
      - \${HSHQ_STACKS_DIR}/nextcloud/ldap-cron.conf:/etc/openldap/ldap.conf
      - v-nextcloud:/var/www/html

  nextcloud-push:
    image: $(getScriptImageByContainerName nextcloud-push)
    container_name: nextcloud-push
    hostname: nextcloud-push
    restart: unless-stopped
    entrypoint: /var/www/html/custom_apps/notify_push/bin/x86_64/notify_push /var/www/html/config/config.php
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ldap-net
      - dock-proxy-net
      - dock-internalmail-net
      - int-nextcloud-net
      - dock-ext-net
    depends_on:
      - nextcloud-db
      - nextcloud-redis
      - nextcloud-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/nextcloud-push.crt:/opt/ssl/nextcloud-push.crt
      - \${HSHQ_SSL_DIR}/nextcloud-push.key:/opt/ssl/nextcloud-push.key
      - \${HSHQ_STACKS_DIR}/nextcloud/ldap-push.conf:/etc/openldap/ldap.conf
      - v-nextcloud:/var/www/html
    environment:
      - PORT=$NEXTCLOUD_PUSH_PORT
      - NEXTCLOUD_URL=http://nextcloud-web

  nextcloud-imaginary:
    image: $(getScriptImageByContainerName nextcloud-imaginary)
    container_name: nextcloud-imaginary
    hostname: nextcloud-imaginary
    restart: unless-stopped
    command: -concurrency 50 -enable-url-source
    cap_add:
      - SYS_NICE
    networks:
      - int-nextcloud-net
      - dock-proxy-net
    depends_on:
      - nextcloud-app
    environment:
      - PORT=$NEXTCLOUD_IMAGINARY_PORT

  nextcloud-talkhpb:
    image: $(getScriptImageByContainerName nextcloud-talkhpb)
    container_name: nextcloud-talkhpb
    hostname: nextcloud-talkhpb
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - nextcloud-app
    environment:
      - NC_DOMAIN=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - TALK_HOST=$SUB_COTURN.$HOMESERVER_DOMAIN
      - TALK_PORT=$COTURN_PRIMARY_PORT
      - TURN_SECRET=$COTURN_STATIC_SECRET
      - SIGNALING_SECRET=$NEXTCLOUD_TALKHPB_SIGNALING_SECRET
      - INTERNAL_SECRET=$NEXTCLOUD_TALKHPB_INTERNAL_SECRET
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  nextcloud-talkrecord:
    image: $(getScriptImageByContainerName nextcloud-talkrecord)
    container_name: nextcloud-talkrecord
    hostname: nextcloud-talkrecord
    user: "122"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-nextcloud-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - nextcloud-app
    environment:
      - NC_DOMAIN=$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN
      - TZ=\${TZ}
      - RECORDING_SECRET=$NEXTCLOUD_TALKHPB_RECORDING_SECRET
      - INTERNAL_SECRET=$NEXTCLOUD_TALKHPB_INTERNAL_SECRET
      - SKIP_VERIFY=true
      - HPB_DOMAIN=$SUB_NCTALKHPB.$HOMESERVER_DOMAIN
    shm_size: 1073741824
    read_only: true
    tmpfs:
      - /conf
    cap_drop:
      - NET_RAW
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/\${PYTHON_VER}/site-packages/certifi/cacert.pem:ro
      - v-nextcloud-record:/tmp:rw

  nextcloud-web:
    image: $(getScriptImageByContainerName nextcloud-web)
    container_name: nextcloud-web
    hostname: nextcloud-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - int-nextcloud-net
    depends_on:
      - nextcloud-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-nextcloud:/var/www/html:ro
      - \${HSHQ_STACKS_DIR}/nextcloud/web/nginx.conf:/etc/nginx/nginx.conf
      - \${HSHQ_SSL_DIR}/nextcloud-web.crt:/etc/nginx/certs/cert.crt
      - \${HSHQ_SSL_DIR}/nextcloud-web.key:/etc/nginx/certs/cert.key

volumes:
  v-nextcloud:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/nextcloud/app
  v-nextcloud-record:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/nextcloud/record

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-nextcloud-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFNC

}

function outputNGINXConfigNextcloud()
{
  cat <<EOFNG > $HSHQ_STACKS_DIR/nextcloud/web/nginx.conf
worker_processes auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    default_type  application/octet-stream;

    log_format  main  '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                      '\$status \$body_bytes_sent "\$http_referer" '
                      '"\$http_user_agent" "\$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    # Prevent nginx HTTP Server Detection
    server_tokens   off;

    keepalive_timeout  65;

    map \$http_host \$this_host {
        "" \$host;
        default \$http_host;
    }

    map \$http_x_forwarded_proto \$the_scheme {
        default \$http_x_forwarded_proto;
        "" \$scheme;
    }

    map \$http_x_forwarded_host \$the_host {
       default \$http_x_forwarded_host;
       "" \$this_host;
    }

    # Set the immutable cache control options only for assets with a cache busting v argument
    map \$arg_v \$asset_immutable {
        "" "";
        default ", immutable";
    }

    #gzip  on;

    upstream php-handler {
        server nextcloud-app:9000;
    }

    server {
        listen 80;
        listen 443 ssl;
        http2 on;
        ssl_certificate /etc/nginx/certs/cert.crt;
        ssl_certificate_key /etc/nginx/certs/cert.key;
        include /etc/nginx/mime.types;
        types {
            text/javascript js mjs;
        }

        # HSTS settings
        # WARNING: Only add the preload option once you read about
        # the consequences in https://hstspreload.org/. This option
        # will add the domain to a hardcoded list that is shipped
        # in all major browsers and getting removed from this list
        # could take several months.
        add_header Strict-Transport-Security "max-age=15768000; includeSubDomains;" always;

        # set max upload size
        client_max_body_size 16400M;
        fastcgi_buffers 64 16K;
        fastcgi_buffer_size 16K;

        # Enable gzip but do not remove ETag headers
        gzip on;
        gzip_vary on;
        gzip_comp_level 4;
        gzip_min_length 256;
        gzip_proxied expired no-cache no-store private no_last_modified no_etag auth;
        gzip_types application/atom+xml application/javascript application/json application/ld+json application/manifest+json application/rss+xml application/vnd.geo+json application/vnd.ms-fontobject application/x-font-ttf application/x-web-app-manifest+json application/xhtml+xml application/xml font/opentype image/bmp image/svg+xml image/x-icon text/cache-manifest text/css text/plain text/vcard text/vnd.rim.location.xloc text/vtt text/x-component text/x-cross-domain-policy;

        # Pagespeed is not supported by Nextcloud, so if your server is built
        # with the ngx_pagespeed module, uncomment this line to disable it.
        #pagespeed off;

        # HTTP response headers borrowed from Nextcloud .htaccess
        add_header Referrer-Policy                      "no-referrer"   always;
        add_header X-Content-Type-Options               "nosniff"       always;
        add_header X-Download-Options                   "noopen"        always;
        add_header X-Frame-Options                      "SAMEORIGIN"    always;
        add_header X-Permitted-Cross-Domain-Policies    "none"          always;
        add_header X-Robots-Tag                     "noindex, nofollow" always;
        add_header X-XSS-Protection                     "1; mode=block" always;

        # Remove X-Powered-By, which is an information leak
        fastcgi_hide_header X-Powered-By;

        # Path to the root of your installation
        root /var/www/html;

        # Specify how to handle directories -- specifying /index.php\$request_uri
        # here as the fallback means that Nginx always exhibits the desired behaviour
        # when a client requests a path that corresponds to a directory that exists
        # on the server. In particular, if that directory contains an index.php file,
        # that file is correctly served; if it doesn't, then the request is passed to
        # the front-end controller. This consistent behaviour means that we don't need
        # to specify custom rules for certain paths (e.g. images and other assets,
        # /updater, /ocm-provider, /ocs-provider), and thus
        # try_files \$uri \$uri/ /index.php\$request_uri
        # always provides the desired behaviour.
        index index.php index.html /index.php\$request_uri;

        # Rule borrowed from .htaccess to handle Microsoft DAV clients
        location = / {
            if ( \$http_user_agent ~ ^DavClnt ) {
                return 302 /remote.php/webdav/\$is_args\$args;
            }
        }

        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
        }

        # Make a regex exception for /.well-known so that clients can still
        # access it despite the existence of the regex rule
        # location ~ /(\.|autotest|...) which would otherwise handle requests
        # for /.well-known.
        location ^~ /.well-known {
            # The rules in this block are an adaptation of the rules
            # in .htaccess that concern /.well-known.

            location = /.well-known/carddav { return 301 /remote.php/dav/; }
            location = /.well-known/caldav  { return 301 /remote.php/dav/; }

            location /.well-known/acme-challenge    { try_files \$uri \$uri/ =404; }
            location /.well-known/pki-validation    { try_files \$uri \$uri/ =404; }

            # Let Nextcloud's API for /.well-known URIs handle all other
            # requests by passing them to the front-end controller.
            return 301 /index.php\$request_uri;
        }

        # Rules borrowed from .htaccess to hide certain paths from clients
        location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)(?:\$|/)  { return 404; }
        location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console)                { return 404; }

        # Ensure this block, which passes PHP files to the PHP process, is above the blocks
        # which handle static assets (as seen below). If this block is not declared first,
        # then Nginx will encounter an infinite rewriting loop when it prepends /index.php
        # to the URI, resulting in a HTTP 500 error response.
        location ~ \.php(?:\$|/) {
            # Required for legacy support
            rewrite ^/(?!index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode\/proxy) /index.php\$request_uri;

            fastcgi_split_path_info ^(.+?\.php)(/.*)\$;
            set \$path_info \$fastcgi_path_info;

            try_files \$fastcgi_script_name =404;

            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
            fastcgi_param PATH_INFO \$path_info;
            #fastcgi_param HTTPS on;

            fastcgi_param modHeadersAvailable true;         # Avoid sending the security headers twice
            fastcgi_param front_controller_active true;     # Enable pretty urls
            fastcgi_pass php-handler;

            fastcgi_intercept_errors on;
            fastcgi_request_buffering off;
        }

        # Serve static files
        location ~ \.(?:css|js|mjs|svg|gif|png|jpg|ico|wasm|tflite|map|ogg|flac)\$ {
            try_files \$uri /index.php\$request_uri;
            # HTTP response headers borrowed from Nextcloud .htaccess
            add_header Cache-Control                     "public, max-age=15778463\$asset_immutable";
            add_header Referrer-Policy                   "no-referrer"       always;
            add_header X-Content-Type-Options            "nosniff"           always;
            add_header X-Frame-Options                   "SAMEORIGIN"        always;
            add_header X-Permitted-Cross-Domain-Policies "none"              always;
            add_header X-Robots-Tag                      "noindex, nofollow" always;
            add_header X-XSS-Protection                  "1; mode=block"     always;
            access_log off;     # Optional: Don't log access to assets
        }

        location ~ \.woff2?\$ {
            try_files \$uri /index.php\$request_uri;
            expires 7d;         # Cache-Control policy borrowed from .htaccess
            access_log off;     # Optional: Don't log access to assets
        }

        # Rule borrowed from .htaccess
        location /remote {
            return 301 /remote.php\$request_uri;
        }

        location / {
            try_files \$uri \$uri/ /index.php\$request_uri;
        }
    }
}

EOFNG

}

function performUpdateNextcloud()
{
  perform_stack_name=nextcloud
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.3-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.23.2-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:27.1.3-fpm-alpine,nextcloud:27.1.7-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.23.2-alpine,nginx:1.25.3-alpine"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.5-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:27.1.5-fpm-alpine,nextcloud:27.1.7-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.6-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:27.1.6-fpm-alpine,nextcloud:27.1.7-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:27.1.7-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:27.1.7-fpm-alpine,nextcloud:28.0.8-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfNextcloudUpdateNGINXConfig false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      performMaintenanceNextcloud
      docker exec -u www-data nextcloud-app php occ config:system:set maintenance_window_start --type=integer --value=1
      return
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:28.0.8-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:28.0.8-fpm-alpine,nextcloud:29.0.8-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:29.0.8-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="nextcloud:29.0.8-fpm-alpine,nextcloud:30.0.1-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:latest"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfNextcloudUpdateNGINXConfig false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      performMaintenanceNextcloud
      return
    ;;
    7)
      newVer=v8
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,nextcloud:30.0.1-fpm-alpine,nextcloud/aio-imaginary:latest,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[2]="nextcloud:30.0.1-fpm-alpine,nextcloud:31.0.2-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:latest,nextcloud/aio-imaginary:20250325_084656"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.27.4-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfNextcloudUpdateNGINXConfig false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      performMaintenanceNextcloud
      return
    ;;
    8)
      newVer=v9
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.4.2,nextcloud:31.0.2-fpm-alpine,nextcloud/aio-imaginary:20250325_084656,nginx:1.27.4-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[2]="nextcloud:31.0.2-fpm-alpine,nextcloud:31.0.2-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:20250325_084656,nextcloud/aio-imaginary:20250325_084656"
      image_update_map[4]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfNextcloudAddTalkHPB
      docker exec -u www-data nextcloud-app php occ config:app:set spreed turn_servers --value="[{\"schemes\":\"turn\",\"server\":\"$SUB_COTURN.$HOMESERVER_DOMAIN:$COTURN_PRIMARY_PORT\",\"secret\":\"$COTURN_STATIC_SECRET\",\"protocols\":\"udp,tcp\"}]" > /dev/null 2>&1
      docker exec -u www-data nextcloud-app php occ config:app:set spreed signaling_servers --value="{\"servers\":[{\"server\":\"https:\/\/$SUB_NCTALKHPB.$HOMESERVER_DOMAIN\/standalone-signaling\",\"verify\":true}],\"secret\":\"$NEXTCLOUD_TALKHPB_SIGNALING_SECRET\"}" > /dev/null 2>&1
      docker exec -u www-data nextcloud-app php occ config:app:set spreed recording_servers --value="{\"servers\":[{\"server\":\"https:\/\/$SUB_NCTALKRECORD.$HOMESERVER_DOMAIN\",\"verify\":true}],\"secret\":\"$NEXTCLOUD_TALKHPB_RECORDING_SECRET\"}" > /dev/null 2>&1
      docker exec -u www-data nextcloud-app php occ config:app:set spreed enabled --value="yes"
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      performMaintenanceNextcloud
      return
    ;;
    9)
      newVer=v9
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.4.2,nextcloud:31.0.2-fpm-alpine,nextcloud/aio-imaginary:20250325_084656,nginx:1.27.4-alpine,ghcr.io/nextcloud-releases/aio-talk:20250512_082954,ghcr.io/nextcloud-releases/aio-talk-recording:20250512_082954
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[2]="nextcloud:31.0.2-fpm-alpine,nextcloud:31.0.2-fpm-alpine"
      image_update_map[3]="nextcloud/aio-imaginary:20250325_084656,nextcloud/aio-imaginary:20250325_084656"
      image_update_map[4]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
      image_update_map[5]="ghcr.io/nextcloud-releases/aio-talk:20250512_082954,ghcr.io/nextcloud-releases/aio-talk:20250512_082954"
      image_update_map[6]="ghcr.io/nextcloud-releases/aio-talk-recording:20250512_082954,ghcr.io/nextcloud-releases/aio-talk-recording:20250512_082954"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
  performMaintenanceNextcloud
}

function performMaintenanceNextcloud()
{
  echo "Performing maintenance on Nextcloud, this could take a few minutes..."
  waitForStack "ready to handle connections" nextcloud-app 3600 5
  if [ "$isStackReady" = "true" ]; then
    docker exec -u www-data nextcloud-app php occ db:add-missing-indices > /dev/null 2>&1
    docker exec -u www-data nextcloud-app php occ maintenance:repair --include-expensive > /dev/null 2>&1
    docker exec -u www-data nextcloud-app php cron.php > /dev/null 2>&1
    docker exec -u www-data nextcloud-app php occ dav:sync-system-addressbook > /dev/null 2>&1
    docker exec -u www-data nextcloud-app php occ federation:sync-addressbooks > /dev/null 2>&1
  else
    echo "ERROR: There was a problem with the Nextcloud update..."
  fi
  echo "Maintenance complete!"
}

function mfNextcloudUpdateNGINXConfig()
{
  outputNGINXConfigNextcloud
}

function mfNextcloudAddTalkHPB()
{
  set +e
  initServicesCredentials
  pullImage $(getScriptImageByContainerName nextcloud-talkhpb)
  pullImage $(getScriptImageByContainerName nextcloud-talkrecord)
  outputComposeNextcloud
  set +e
  grep "PYTHON_VER=" $HOME/nextcloud.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "PYTHON_VER=python3.13" >> $HOME/nextcloud.env
  fi
  mkdir -p $HSHQ_STACKS_DIR/nextcloud/record
  inner_block=""
  inner_block=$inner_block">>https://$SUB_NCTALKHPB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NCTALKRECORD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>route /standalone-signaling/* {\n"
  inner_block=$inner_block">>>>>>>>uri strip_prefix /standalone-signaling\n"
  inner_block=$inner_block">>>>>>>>reverse_proxy http://nextcloud-talkhpb:8081 {\n"
  inner_block=$inner_block">>>>>>>>>>import trusted-proxy-list\n"
  inner_block=$inner_block">>>>>>>>>>header_up X-Real-IP {remote_host}\n"
  inner_block=$inner_block">>>>>>>>}\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NCTALKHPB $MANAGETLS_NCTALKHPB "$is_integrate_hshq" $NETDEFAULT_NCTALKHPB "$inner_block"
  insertSubAuthelia $SUB_NCTALKHPB.$HOMESERVER_DOMAIN bypass
  inner_block=""
  inner_block=$inner_block">>https://$SUB_NCTALKRECORD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NCTALKHPB.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://nextcloud-talkrecord:1234 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NCTALKRECORD $MANAGETLS_NCTALKRECORD "$is_integrate_hshq" $NETDEFAULT_NCTALKRECORD "$inner_block"
  insertSubAuthelia $SUB_NCTALKRECORD.$HOMESERVER_DOMAIN bypass
  restartAllCaddyContainers
}

# Jitsi
function installJitsi()
{
  set +e
  is_integrate_hshq=$1
  # Remember to check if directory exists
  checkDeleteStackAndDirectory jitsi "Jitsi"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jitsi-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jitsi-prosody)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jitsi-jicofo)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jitsi-jvb)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/jitsi
  outputConfigJitsi
  generateCert jitsi-web jitsi-web
  installStack jitsi jitsi-web "starting services" $HOME/jitsi.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Jitsi installed, sleeping 5 seconds..."
  sleep 5

  inner_block=""
  inner_block=$inner_block">>https://$SUB_JITSI.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://jitsi-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_JITSI $MANAGETLS_JITSI "$is_integrate_hshq" $NETDEFAULT_JITSI "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll jitsi "$FMLNAME_JITSI" $USERTYPE_JITSI "https://$SUB_JITSI.$HOMESERVER_DOMAIN" "jitsi.png" "$(getHeimdallOrderFromSub $SUB_JITSI $USERTYPE_JITSI)"
    restartAllCaddyContainers
  fi
}

function outputConfigJitsi()
{
  cat <<EOFJT > $HOME/jitsi-compose.yml
$STACK_VERSION_PREFIX jitsi $(getScriptStackVersion jitsi)

services:
  jitsi-web:
    image: $(getScriptImageByContainerName jitsi-web)
    container_name: jitsi-web
    hostname: jitsi-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-jitsi-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/jitsi/web:/config:Z
      - \${HSHQ_STACKS_DIR}/jitsi/web/crontabs:/var/spool/cron/crontabs:Z
      - \${HSHQ_STACKS_DIR}/jitsi/transcripts:/usr/share/jitsi-meet/transcripts:Z
      - \${HSHQ_SSL_DIR}/jitsi-web.crt:/config/keys/cert.crt
      - \${HSHQ_SSL_DIR}/jitsi-web.key:/config/keys/cert.key

  jitsi-prosody:
    image: $(getScriptImageByContainerName jitsi-prosody)
    container_name: jitsi-prosody
    hostname: jitsi-prosody
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      int-jitsi-net:
        aliases:
          - xmpp.meet.jitsi
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/jitsi/prosody/config:/config:Z
      - \${HSHQ_STACKS_DIR}/jitsi/prosody/prosody-plugins-custom:/prosody-plugins-custom:Z

  jitsi-jicofo:
    image: $(getScriptImageByContainerName jitsi-jicofo)
    container_name: jitsi-jicofo
    hostname: jitsi-jicofo
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-jitsi-net
    depends_on:
      - jitsi-prosody
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/jitsi/jicofo:/config:Z

  jitsi-jvb:
    image: $(getScriptImageByContainerName jitsi-jvb)
    container_name: jitsi-jvb
    hostname: jitsi-jvb
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - jitsi-prosody
    networks:
      - int-jitsi-net
      - dock-privateip-net
    ports:
      - "$JITSI_MEET_PORT:${JITSI_MEET_PORT}/udp"
      - "$JITSI_JVB_PORT:$JITSI_JVB_PORT"
      - "127.0.0.1:$JITSI_COLIBRI_PORT:$JITSI_COLIBRI_PORT"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/jitsi/jvb:/config:Z

networks:
  int-jitsi-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
EOFJT
  outputEnvJitsi
}

function outputEnvJitsi()
{
  cat <<EOFJT > $HOME/jitsi.env
JVB_COLIBRI_PORT=$JITSI_COLIBRI_PORT
PUBLIC_URL=https://$SUB_JITSI.$HOMESERVER_DOMAIN
JVB_ADVERTISE_IPS=\${ALL_INTERFACE_IPS}
DOCKER_HOST_ADDRESS=\${HOMESERVER_HOST_PRIMARY_INTERFACE_IP}
ENABLE_LETSENCRYPT=0
ENABLE_AUTH=0
JICOFO_AUTH_PASSWORD=$(openssl rand -hex 16)
JVB_AUTH_PASSWORD=$(openssl rand -hex 16)
JIGASI_XMPP_PASSWORD=$(openssl rand -hex 16)
JIBRI_RECORDER_PASSWORD=$(openssl rand -hex 16)
JIBRI_XMPP_PASSWORD=$(openssl rand -hex 16)
ENABLE_P2P=false
JVB_STUN_SERVERS=none
JVB_DISABLE_STUN=true
EOFJT
}

function performUpdateJitsi()
{
  perform_stack_name=jitsi
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v7
      curImageList=jitsi/jicofo:stable-8719,jitsi/jvb:stable-8719,jitsi/prosody:stable-8719,jitsi/web:stable-8719
      image_update_map[0]="jitsi/jicofo:stable-8719,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-8719,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-8719,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-8719,jitsi/web:stable-10133-1"
    ;;
    2)
      newVer=v7
      curImageList=jitsi/jicofo:stable-9111,jitsi/jvb:stable-9111,jitsi/prosody:stable-9111,jitsi/web:stable-9111
      image_update_map[0]="jitsi/jicofo:stable-9111,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-9111,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-9111,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-9111,jitsi/web:stable-10133-1"
    ;;
    3)
      newVer=v7
      curImageList=jitsi/jicofo:stable-9220,jitsi/jvb:stable-9220,jitsi/prosody:stable-9220,jitsi/web:stable-9220
      image_update_map[0]="jitsi/jicofo:stable-9220,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-9220,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-9220,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-9220,jitsi/web:stable-10133-1"
    ;;
    4)
      newVer=v7
      curImageList=jitsi/jicofo:stable-9258,jitsi/jvb:stable-9258,jitsi/prosody:stable-9258,jitsi/web:stable-9258
      image_update_map[0]="jitsi/jicofo:stable-9258,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-9258,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-9258,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-9258,jitsi/web:stable-10133-1"
    ;;
    5)
      newVer=v7
      curImageList=jitsi/jicofo:stable-9584,jitsi/jvb:stable-9584,jitsi/prosody:stable-9584,jitsi/web:stable-9584
      image_update_map[0]="jitsi/jicofo:stable-9584,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-9584,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-9584,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-9584,jitsi/web:stable-10133-1"
    ;;
    6)
      newVer=v7
      curImageList=jitsi/jicofo:stable-9779,jitsi/jvb:stable-9779,jitsi/prosody:stable-9779,jitsi/web:stable-9779
      image_update_map[0]="jitsi/jicofo:stable-9779,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-9779,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-9779,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-9779,jitsi/web:stable-10133-1"
    ;;
    7)
      newVer=v7
      curImageList=jitsi/jicofo:stable-10133-1,jitsi/jvb:stable-10133-1,jitsi/prosody:stable-10133-1,jitsi/web:stable-10133-1
      image_update_map[0]="jitsi/jicofo:stable-10133-1,jitsi/jicofo:stable-10133-1"
      image_update_map[1]="jitsi/jvb:stable-10133-1,jitsi/jvb:stable-10133-1"
      image_update_map[2]="jitsi/prosody:stable-10133-1,jitsi/prosody:stable-10133-1"
      image_update_map[3]="jitsi/web:stable-10133-1,jitsi/web:stable-10133-1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Matrix
function installMatrix()
{
  set +e
  is_integrate_hshq=$1
  # Only install if directory does not exist
  checkDeleteStackAndDirectory matrix "Matrix"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matrix-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matrix-synapse)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matrix-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matrix-element-private)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/matrix
  mkdir $HSHQ_STACKS_DIR/matrix/db
  mkdir $HSHQ_STACKS_DIR/matrix/dbexport
  mkdir $HSHQ_STACKS_DIR/matrix/synapse
  mkdir $HSHQ_STACKS_DIR/matrix/element
  chmod 777 $HSHQ_STACKS_DIR/matrix/dbexport

  initServicesCredentials
  if [ -z "$MATRIX_REDIS_PASSWORD" ]; then
    MATRIX_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MATRIX_REDIS_PASSWORD $MATRIX_REDIS_PASSWORD
  fi
  if [ -z "$MATRIX_SYNAPSE_REGISTRATION_SECRET" ]; then
    MATRIX_SYNAPSE_REGISTRATION_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar MATRIX_SYNAPSE_REGISTRATION_SECRET $MATRIX_SYNAPSE_REGISTRATION_SECRET
  fi
  if [ -z "$MATRIX_SYNAPSE_MACAROON_SECRET" ]; then
    MATRIX_SYNAPSE_MACAROON_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar MATRIX_SYNAPSE_MACAROON_SECRET $MATRIX_SYNAPSE_MACAROON_SECRET
  fi
  if [ -z "$MATRIX_SYNAPSE_FORM_SECRET" ]; then
    MATRIX_SYNAPSE_FORM_SECRET=$(pwgen -c -n 64 1)
    updateConfigVar MATRIX_SYNAPSE_FORM_SECRET $MATRIX_SYNAPSE_FORM_SECRET
  fi

  outputConfigMatrix
  generateCert matrix-synapse matrix-synapse
  installStack matrix matrix-synapse "Starting synapse with args" $HOME/matrix.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Matrix installed, sleeping 5 seconds..."
  sleep 5

  inner_block=""
  inner_block=$inner_block">>https://$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWCORS\n"
  inner_block=$inner_block">>>>encode zstd gzip\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy \"/_matrix/*\" https://matrix-synapse:8448 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>reverse_proxy \"/_synapse/client/*\" https://matrix-synapse:8448 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MATRIX_SYNAPSE $MANAGETLS_MATRIX_SYNAPSE "$is_integrate_hshq" $NETDEFAULT_MATRIX_SYNAPSE "$inner_block"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>encode zstd gzip\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://matrix-element-private {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MATRIX_ELEMENT_PRIVATE $MANAGETLS_MATRIX_ELEMENT_PRIVATE "$is_integrate_hshq" $NETDEFAULT_MATRIX_ELEMENT_PRIVATE "$inner_block"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>encode zstd gzip\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://matrix-element-public {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MATRIX_ELEMENT_PUBLIC $MANAGETLS_MATRIX_ELEMENT_PUBLIC "$is_integrate_hshq" $NETDEFAULT_MATRIX_ELEMENT_PUBLIC "$inner_block"

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll matrix "$FMLNAME_MATRIX_ELEMENT_PRIVATE" $USERTYPE_MATRIX_ELEMENT_PRIVATE "https://$SUB_MATRIX_ELEMENT_PRIVATE.$HOMESERVER_DOMAIN" "element-private.png" "$(getHeimdallOrderFromSub $SUB_MATRIX_ELEMENT_PRIVATE $USERTYPE_MATRIX_ELEMENT_PRIVATE)"
    insertEnableSvcAll matrix "$FMLNAME_MATRIX_ELEMENT_PUBLIC" $USERTYPE_MATRIX_ELEMENT_PUBLIC "https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN" "element-public.png" "$(getHeimdallOrderFromSub $SUB_MATRIX_ELEMENT_PUBLIC $USERTYPE_MATRIX_ELEMENT_PUBLIC)"
    restartAllCaddyContainers
  fi
}

function outputConfigMatrix()
{
  cat <<EOFJT > $HOME/matrix-compose.yml
$STACK_VERSION_PREFIX matrix $(getScriptStackVersion matrix)

services:
  matrix-db:
    image: $(getScriptImageByContainerName matrix-db)
    container_name: matrix-db
    hostname: matrix-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-matrix-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/matrix/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/matrix/dbexport:/dbexport
    environment:
      - POSTGRES_DB=$MATRIX_DATABASE_NAME
      - POSTGRES_USER=$MATRIX_DATABASE_USER
      - POSTGRES_PASSWORD=$MATRIX_DATABASE_USER_PASSWORD
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.matrix-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.matrix-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.matrix-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.matrix-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.matrix-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.matrix-hourly-db.email-from=Matrix Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.matrix-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.matrix-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.matrix-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.matrix-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.matrix-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.matrix-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.matrix-monthly-db.email-from=Matrix Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.matrix-monthly-db.mail-only-on-error=false"

  matrix-synapse:
    image: $(getScriptImageByContainerName matrix-synapse)
    container_name: matrix-synapse
    hostname: matrix-synapse
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - matrix-db
      - matrix-redis
    networks:
      - int-matrix-net
      - dock-ldap-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/matrix-synapse.crt:/data/matrix-synapse.crt:ro
      - \${HSHQ_SSL_DIR}/matrix-synapse.key:/data/matrix-synapse.key:ro
      - \${HSHQ_STACKS_DIR}/matrix/synapse:/data

  matrix-redis:
    image: $(getScriptImageByContainerName matrix-redis)
    container_name: matrix-redis
    hostname: matrix-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-matrix-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - REDIS_PASSWORD=$MATRIX_REDIS_PASSWORD

  matrix-element-private:
    image: $(getScriptImageByContainerName matrix-element-private)
    container_name: matrix-element-private
    hostname: matrix-element-private
    restart: unless-stopped
    env_file: stack.env
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/matrix/element/element-private-config.json:/app/config.json

  matrix-element-public:
    image: $(getScriptImageByContainerName matrix-element-public)
    container_name: matrix-element-public
    hostname: matrix-element-public
    restart: unless-stopped
    env_file: stack.env
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/matrix/element/element-public-config.json:/app/config.json

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-matrix-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFJT

  cat <<EOFJT > $HOME/matrix.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
SYNAPSE_CONFIG_DIR=/data
SYNAPSE_CONFIG_PATH=/data/homeserver.yaml
REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
REDIS_TLS_ENABLED=no
EOFJT

  cat <<EOFJT > $HSHQ_STACKS_DIR/matrix/synapse/homeserver.yaml
server_name: $HOMESERVER_DOMAIN
pid_file: /data/homeserver.pid
web_client_location: https://$SUB_MATRIX_ELEMENT_PUBLIC.$HOMESERVER_DOMAIN/
public_baseurl: https://$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN/
limit_profile_requests_to_users_who_share_rooms: true
include_profile_data_on_invite: false
allow_public_rooms_over_federation: false
default_room_version: "9"
auto_join_rooms:
  - "#Main:$HOMESERVER_DOMAIN"
listeners:
  - port: 8008
    tls: false
    type: http
    x_forwarded: true
    resources:
      - names: [client, federation]
        compress: false
  - port: 8448
    tls: true
    type: http
    x_forwarded: true
    resources:
      - names: [client, federation]
        compress: false
ip_range_whitelist:
  - '10.0.0.0/8'
max_avatar_size: 10M
redaction_retention_period: 1d
tls_certificate_path: /data/matrix-synapse.crt
tls_private_key_path: /data/matrix-synapse.key
#federation_domain_whitelist:
#  - $HOMESERVER_DOMAIN
allow_profile_lookup_over_federation: false
allow_device_name_lookup_over_federation: false
database:
  name: psycopg2
  txn_limit: 10000
  args:
    user: $MATRIX_DATABASE_USER
    password: $MATRIX_DATABASE_USER_PASSWORD
    database: $MATRIX_DATABASE_NAME
    host: matrix-db
    port: 5432
    cp_min: 5
    cp_max: 10
log_config: "/data/${HOMESERVER_DOMAIN}.log.config"
enable_media_repo: true
media_store_path: "/data/media_store"
max_upload_size: 512M
dynamic_thumbnails: true
thumbnail_sizes:
  - width: 32
    height: 32
    method: crop
  - width: 96
    height: 96
    method: crop
  - width: 320
    height: 240
    method: scale
  - width: 640
    height: 480
    method: scale
  - width: 800
    height: 600
    method: scale
url_preview_accept_language:
   - en-US;q=0.9
enable_registration: false
session_lifetime: 720h
registration_shared_secret: "$MATRIX_SYNAPSE_REGISTRATION_SECRET"
macaroon_secret_key: "$MATRIX_SYNAPSE_MACAROON_SECRET"
form_secret: "$MATRIX_SYNAPSE_FORM_SECRET"
allow_guest_access: false
enable_set_displayname: true
enable_set_avatar_url: true
enable_3pid_changes: false
enable_metrics: false
report_stats: false
signing_key_path: "/data/${HOMESERVER_DOMAIN}.signing.key"
trusted_key_servers:
  - server_name: "matrix.org"
encryption_enabled_by_default_for_room_type: off
enable_group_creation: true
group_creation_prefix: "unofficial_"
password_providers:
 - module: "ldap_auth_provider.LdapAuthProvider"
   config:
     enabled: true
     uri: "ldap://ldapserver:389"
     start_tls: true
     base: "ou=people,$LDAP_BASE_DN"
     attributes:
        uid: "uid"
        mail: "mail"
        name: "givenName"
     bind_dn: $LDAP_READONLY_USER_BIND_DN 
     bind_password: $LDAP_READONLY_USER_PASSWORD
     filter: "(&(objectClass=person)(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))"
     tls_options:
       validate: false
       local_certificate_file: /data/matrix-synapse.crt
       local_private_key_file: /data/matrix-synapse.key
password_config:
   enabled: true
   localdb_enabled: false
user_directory:
    enabled: true
    search_all_users: true
    prefer_local_users: true
enable_room_list_search: true
redis:
  enabled: true
  host: matrix-redis
  port: 6379
  password: $MATRIX_REDIS_PASSWORD
admin_contact: 'mailto:$EMAIL_ADMIN_EMAIL_ADDRESS'
email:
  smtp_host: $SMTP_HOSTNAME
  smtp_port: SMTP_HOSTPORT
  require_transport_security: true
  enable_tls: true
  notif_from: "Matrix Homeserver <$EMAIL_ADMIN_EMAIL_ADDRESS>"
  app_name: "$HOMESERVER_NAME Secure Communications"
  enable_notifs: true
  notif_for_new_users: true
  #client_base_url: "http://localhost/riot"
  #validation_token_lifetime: 15m
  #invite_client_location: https://app.element.io
  #subjects:
    #message_from_person_in_room: "[%(app)s] You have a message on %(app)s from %(person)s in the %(room)s room..."
    #message_from_person: "[%(app)s] You have a message on %(app)s from %(person)s..."
    #messages_from_person: "[%(app)s] You have messages on %(app)s from %(person)s..."
    #messages_in_room: "[%(app)s] You have messages on %(app)s in the %(room)s room..."
    #messages_in_room_and_others: "[%(app)s] You have messages on %(app)s in the %(room)s room and others..."
    #messages_from_person_and_others: "[%(app)s] You have messages on %(app)s from %(person)s and others..."
    #invite_from_person_to_room: "[%(app)s] %(person)s has invited you to join the %(room)s room on %(app)s..."
    #invite_from_person: "[%(app)s] %(person)s has invited you to chat on %(app)s..."
    #password_reset: "[%(server_name)s] Password reset"
    #email_validation: "[%(server_name)s] Validate your email"
EOFJT

  cat <<EOFJT > $HSHQ_STACKS_DIR/matrix/synapse/${HOMESERVER_DOMAIN}.log.config
version: 1
formatters:
  precise:
    format: '%(asctime)s - %(name)s - %(lineno)d - %(levelname)s - %(request)s - %(message)s'
handlers:
  console:
    class: logging.StreamHandler
    formatter: precise
loggers:
    synapse.storage.SQL:
        level: INFO
root:
    level: INFO
    handlers: [console]
disable_existing_loggers: false
EOFJT

  outputMatrixElementJSONConfig "$SUB_JITSI.$HOMESERVER_DOMAIN" $HSHQ_STACKS_DIR/matrix/element/element-private-config.json
  outputMatrixElementJSONConfig "meet.element.io" $HSHQ_STACKS_DIR/matrix/element/element-public-config.json
}

function performUpdateMatrix()
{
  perform_stack_name=matrix
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.90.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.40
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.90.0,matrixdotorg/synapse:v1.102.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="vectorim/element-web:v1.11.40,vectorim/element-web:v1.11.61"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.98.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.52
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.98.0,matrixdotorg/synapse:v1.102.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="vectorim/element-web:v1.11.52,vectorim/element-web:v1.11.61"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.100.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.57
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.100.0,matrixdotorg/synapse:v1.102.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="vectorim/element-web:v1.11.57,vectorim/element-web:v1.11.61"
    ;;
    4)
      newVer=v7
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.102.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.61
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.102.0,matrixdotorg/synapse:v1.127.1"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[3]="vectorim/element-web:v1.11.61,vectorim/element-web:v1.11.96"
    ;;
    5)
      newVer=v7
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.112.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.72
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.112.0,matrixdotorg/synapse:v1.127.1"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[3]="vectorim/element-web:v1.11.72,vectorim/element-web:v1.11.96"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.118.0,bitnami/redis:7.0.5,vectorim/element-web:v1.11.83
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.118.0,matrixdotorg/synapse:v1.127.1"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[3]="vectorim/element-web:v1.11.83,vectorim/element-web:v1.11.96"
    ;;
    7)
      newVer=v7
      curImageList=postgres:15.0-bullseye,matrixdotorg/synapse:v1.127.1,bitnami/redis:7.4.2,vectorim/element-web:v1.11.96
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="matrixdotorg/synapse:v1.127.1,matrixdotorg/synapse:v1.127.1"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[3]="vectorim/element-web:v1.11.96,vectorim/element-web:v1.11.96"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function outputMatrixElementJSONConfig()
{
  jitsi_url=$1
  output_file=$2
  cat <<EOFEL > $output_file
{
    "default_server_config": {
        "m.homeserver": {
            "base_url": "https://$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN",
            "server_name": "$HOMESERVER_DOMAIN"
        },
        "m.identity_server": {
            "base_url": "https://vector.im"
        }
    },
    "disable_custom_urls": true,
    "disable_guests": true,
    "disable_login_language_selector": true,
    "disable_3pid_login": true,
	"brand": "Element",
    "integrations_ui_url": "https://scalar.vector.im/",
    "integrations_rest_url": "https://scalar.vector.im/api",
    "integrations_widgets_urls": [
        "https://scalar.vector.im/_matrix/integrations/v1",
        "https://scalar.vector.im/api",
        "https://scalar-staging.vector.im/_matrix/integrations/v1",
        "https://scalar-staging.vector.im/api",
        "https://scalar-staging.riot.im/scalar/api"
    ],
    "hosting_signup_link": "https://element.io/matrix-services?utm_source=element-web&utm_medium=web",
    "bug_report_endpoint_url": "https://element.io/bugreports/submit",
    "defaultCountryCode": "US",
    "uisi_autorageshake_app": "element-auto-uisi",
    "showLabsSettings": true,
    "jitsi": {
        "preferred_domain": "$jitsi_url"
     },
    "piwik": {
        "url": "https://piwik.riot.im/",
        "siteId": 1,
        "policyUrl": "https://element.io/cookie-policy"
    },
    "roomDirectory": {
        "servers": [
            "$HOMESERVER_DOMAIN"
        ]
    },
    "enable_presence_by_hs_url": {
        "https://matrix.org": false,
        "https://matrix-client.matrix.org": false
    },
    "terms_and_conditions_links": [
        {
            "url": "https://element.io/privacy",
            "text": "Privacy Policy"
        },
        {
            "url": "https://element.io/cookie-policy",
            "text": "Cookie Policy"
        }
    ],
    "hostSignup": {
      "brand": "$HOMESERVER_NAME",
      "cookiePolicyUrl": "https://element.io/cookie-policy",
      "domains": [
          "matrix.org"
      ],
      "privacyPolicyUrl": "https://element.io/privacy",
      "termsOfServiceUrl": "https://element.io/terms-of-service",
      "url": "https://ems.element.io/element-home/in-app-loader"
    },
    "sentry": {
        "dsn": "https://029a0eb289f942508ae0fb17935bd8c5@sentry.matrix.org/6",
        "environment": "develop"
    },
    "posthog": {
        "projectApiKey": "phc_Jzsm6DTm6V2705zeU5dcNvQDlonOR68XvX2sh1sEOHO",
        "apiHost": "https://posthog.hss.element.io"
    },
    "features": {
        "feature_spotlight": true,
        "feature_new_spinner": "labs",
        "feature_pinning": "labs",
        "feature_custom_status": "labs",
        "feature_custom_tags": "labs",
        "feature_state_counters": "labs"
      },
      "default_federate": false,
      "default_theme": "dark",
    "map_style_url": "https://api.maptiler.com/maps/streets/style.json?key=fU3vlMsMn4Jb6dnEIFsx"
}
EOFEL

}

# Wikijs
function installWikijs()
{
  set +e
  is_integrate_hshq=$1
  # Test if directory exists
  checkDeleteStackAndDirectory wikijs "Wikijs"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wikijs-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wikijs-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/wikijs
  mkdir $HSHQ_STACKS_DIR/wikijs/db
  mkdir $HSHQ_STACKS_DIR/wikijs/dbexport
  mkdir $HSHQ_STACKS_DIR/wikijs/web
  chmod 777 $HSHQ_STACKS_DIR/wikijs/dbexport
  initServicesCredentials
  outputConfigWikijs
  generateCert wikijs-web wikijs-web
  installStack wikijs wikijs-web "HTTP Server on port" $HOME/wikijs.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sudo mv $HSHQ_STACKS_DIR/wikijs/config.yml $HSHQ_STACKS_DIR/wikijs/web/config.yml
  sleep 3
  docker container restart wikijs-web
  echo "Wikijs installed, sleeping 3 seconds..."
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_WIKIJS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://wikijs-web:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_WIKIJS $MANAGETLS_WIKIJS "$is_integrate_hshq" $NETDEFAULT_WIKIJS "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll wikijs "$FMLNAME_WIKIJS" $USERTYPE_WIKIJS "https://$SUB_WIKIJS.$HOMESERVER_DOMAIN" "wikijs.png" "$(getHeimdallOrderFromSub $SUB_WIKIJS $USERTYPE_WIKIJS)"
    restartAllCaddyContainers
  fi
}

function outputConfigWikijs()
{
  cat <<EOFWJ > $HOME/wikijs-compose.yml
$STACK_VERSION_PREFIX wikijs $(getScriptStackVersion wikijs)

services:
  wikijs-db:
    image: $(getScriptImageByContainerName wikijs-db)
    container_name: wikijs-db
    hostname: wikijs-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-wikijs-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/wikijs/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/wikijs/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.wikijs-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.wikijs-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wikijs-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wikijs-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wikijs-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wikijs-hourly-db.email-from=Wikijs Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wikijs-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.wikijs-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.wikijs-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wikijs-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wikijs-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wikijs-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wikijs-monthly-db.email-from=Wikijs Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wikijs-monthly-db.mail-only-on-error=false"

  wikijs-web:
    image: $(getScriptImageByContainerName wikijs-web)
    container_name: wikijs-web
    hostname: wikijs-web
    depends_on:
      - wikijs-db
    restart: unless-stopped
    env_file: stack.env
    networks:
      - int-wikijs-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_SSL_DIR}/wikijs-web.crt:/certs/wikijs-web.crt
      - \${HSHQ_SSL_DIR}/wikijs-web.key:/certs/wikijs-web.key
      - v-wikijs-web:/wiki/data/content

volumes:
  v-wikijs-web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wikijs/web

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-wikijs-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFWJ

  cat <<EOFWJ > $HOME/wikijs.env
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$WIKIJS_DATABASE_NAME
POSTGRES_USER=$WIKIJS_DATABASE_USER
POSTGRES_PASSWORD=$WIKIJS_DATABASE_USER_PASSWORD
DB_TYPE=postgres
DB_HOST=wikijs-db
DB_NAME=$WIKIJS_DATABASE_NAME
DB_PORT=5432
DB_USER=$WIKIJS_DATABASE_USER
DB_PASS=$WIKIJS_DATABASE_USER_PASSWORD
EOFWJ

  cat <<EOFWJ > $HSHQ_STACKS_DIR/wikijs/config.yml
port: 3000
bindIP: 0.0.0.0
db:
  type: \$(DB_TYPE)
  host: '\$(DB_HOST)'
  port: \$(DB_PORT)
  user: '\$(DB_USER)'
  pass: '\$(DB_PASS)'
  db: \$(DB_NAME)
  storage: \$(DB_FILEPATH)
  ssl: \$(DB_SSL)
ssl:
  enabled: true
  port: 3443
  provider: custom
  format: pem
  key: /certs/wikijs-web.key
  cert: /certs/wikijs-web.crt
  passphrase: null
  dhparam: null

logLevel: \$(LOG_LEVEL:info)
logFormat: \$(LOG_FORMAT:default)
ha: \$(HA_ACTIVE)
EOFWJ

}

function performUpdateWikijs()
{
  perform_stack_name=wikijs
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,requarks/wiki:2.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="requarks/wiki:2.5,requarks/wiki:2.5.301"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,requarks/wiki:2.5.301
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="requarks/wiki:2.5.301,requarks/wiki:2.5.307"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,requarks/wiki:2.5.305
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="requarks/wiki:2.5.305,requarks/wiki:2.5.307"
    ;;
    4)
      newVer=v4
      curImageList=postgres:15.0-bullseye,requarks/wiki:2.5.307
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="requarks/wiki:2.5.305,requarks/wiki:2.5.307"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Duplicati
function installDuplicati()
{
  set +e
  is_integrate_hshq=$1
  # Evaluate whether directory exists
  checkDeleteStackAndDirectory duplicati "Duplicati"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Duplicati directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName duplicati)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Duplicati docker image"
    exit 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/duplicati
  mkdir $HSHQ_STACKS_DIR/duplicati/config
  mkdir $HSHQ_NONBACKUP_DIR/duplicati
  mkdir $HSHQ_NONBACKUP_DIR/duplicati/restore

  initServicesCredentials
  echo "Installing Duplicati..."
  outputConfigDuplicati
  rm -f $HOME/duplicati.env
  cat <<EOFDP > $HOME/duplicati.env
PUID=0
PGID=0
SETTINGS_ENCRYPTION_KEY=$DUPLICATI_SETTINGS_ENCRYPTION_KEY
CLI_ARGS=--webservice-password=$DUPLICATI_ADMIN_PASSWORD
EOFDP
  generateCert duplicati duplicati
  installStack duplicati duplicati "\[ls.io-init\] done" $HOME/duplicati.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Duplicati"
    exit $retval
  fi
  echo "Duplicati installed, sleeping 5 seconds..."
  sleep 5
  db_name=$HSHQ_STACKS_DIR/duplicati/config/Duplicati-server.sqlite
  sudo sqlite3 $db_name "INSERT INTO Option(BackupID,Filter,Name,Value) VALUES(-1,'','--accept-any-ssl-certificate','true');"
  sudo sqlite3 $db_name "INSERT INTO Option(BackupID,Filter,Name,Value) VALUES(-1,'','--send-mail-from','Duplicati $(getAdminEmailName)<$EMAIL_ADMIN_EMAIL_ADDRESS>');"
  sudo sqlite3 $db_name "INSERT INTO Option(BackupID,Filter,Name,Value) VALUES(-1,'','--send-mail-to','$EMAIL_ADMIN_EMAIL_ADDRESS');"
  sudo sqlite3 $db_name "INSERT INTO Option(BackupID,Filter,Name,Value) VALUES(-1,'','--send-mail-url','smtp://$SMTP_HOSTNAME:$SMTP_HOSTPORT');"
  sudo sqlite3 $db_name "INSERT INTO Option(BackupID,Filter,Name,Value) VALUES(-1,'','--send-mail-level','all');"
  set +e
  updateStackEnv duplicati outputEnvDuplicati
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_DUPLICATI.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://duplicati:8200 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_DUPLICATI $MANAGETLS_DUPLICATI "$is_integrate_hshq" $NETDEFAULT_DUPLICATI "$inner_block"
}

function outputConfigDuplicati()
{
  rm -f $HOME/duplicati-compose.yml
  cat <<EOFDP > $HOME/duplicati-compose.yml
$STACK_VERSION_PREFIX duplicati $(getScriptStackVersion duplicati)

services:
  duplicati:
    image: $(getScriptImageByContainerName duplicati)
    container_name: duplicati
    hostname: duplicati
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/duplicati/config:/config
      - \${HSHQ_NONBACKUP_DIR}/duplicati/restore:/restore
      - \${HSHQ_BACKUP_DIR}:/backups
      - \${HSHQ_DATA_DIR}:/source

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
EOFDP
  outputEnvDuplicati
}

function outputEnvDuplicati()
{
  rm -f $HOME/duplicati.env
  cat <<EOFDP > $HOME/duplicati.env
PUID=0
PGID=0
SETTINGS_ENCRYPTION_KEY=$DUPLICATI_SETTINGS_ENCRYPTION_KEY
EOFDP
}

function performUpdateDuplicati()
{
  perform_stack_name=duplicati
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=linuxserver/duplicati:2.0.7
      image_update_map[0]="linuxserver/duplicati:2.0.7,linuxserver/duplicati:2.0.8"
    ;;
    2)
      newVer=v4
      curImageList=linuxserver/duplicati:2.0.8
      image_update_map[0]="linuxserver/duplicati:2.0.8,linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfDuplicatiAddSettingsEncryptionKey
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v4
      curImageList=linuxserver/duplicati:2.1.0
      image_update_map[0]="linuxserver/duplicati:2.1.0,linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246"
    ;;
    4)
      newVer=v5
      curImageList=linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246
      image_update_map[0]="linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246,linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfDuplicatiUpdateEnv
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    5)
      newVer=v5
      curImageList=linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246
      image_update_map[0]="linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246,linuxserver/duplicati:v2.1.0.5_stable_2025-03-04-ls246"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfDuplicatiUpdateEnv()
{
  set +e
  initServicesCredentials
  set +e
  outputEnvDuplicati
}

function mfDuplicatiAddSettingsEncryptionKey()
{
  mfdasek_curE=${-//[^e]/}
  set +e
  grep "SETTINGS_ENCRYPTION_KEY=" $HOME/duplicati.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    initServicesCredentials
    echo "SETTINGS_ENCRYPTION_KEY=$DUPLICATI_SETTINGS_ENCRYPTION_KEY" >> $HOME/duplicati.env
  fi
  if ! [ -z "$mfdasek_curE" ]; then
    set -e
  fi
}

# Mastodon
function installMastodon()
{
  set +e
  is_integrate_hshq=$1
  # Test if directory exists
  checkDeleteStackAndDirectory mastodon "Mastodon"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  set -e
  pullImage $(getScriptImageByContainerName mastodon-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mastodon-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mastodon-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mastodon-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mastodon-streaming)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mastodon-sidekiq)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/mastodon
  mkdir $HSHQ_STACKS_DIR/mastodon/db
  mkdir $HSHQ_STACKS_DIR/mastodon/dbexport
  mkdir $HSHQ_STACKS_DIR/mastodon/elasticsearch
  mkdir $HSHQ_STACKS_DIR/mastodon/system
  mkdir $HSHQ_STACKS_DIR/mastodon/web
  sudo chown 991:991 $HSHQ_STACKS_DIR/mastodon/system
  chmod 777 $HSHQ_STACKS_DIR/mastodon/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/mastodon
  mkdir $HSHQ_NONBACKUP_DIR/mastodon/redis
  mkdir $HSHQ_NONBACKUP_DIR/mastodon/static

  MASTODON_SECRET_KEY_BASE=$(openssl rand -hex 64)
  MASTODON_OTP_SECRET=$(openssl rand -hex 64)
  openssl ecparam -name prime256v1 -genkey -noout -out $HOME/vapid_private_key.pem
  openssl ec -in $HOME/vapid_private_key.pem -pubout -out $HOME/vapid_public_key.pem
  MASTODON_VAPID_PRIVATE_KEY=$(cat $HOME/vapid_private_key.pem | sed -e "1 d" -e "$ d" | tr -d "\n")
  MASTODON_VAPID_PUBLIC_KEY=$(cat $HOME/vapid_public_key.pem | sed -e "1 d" -e "$ d" | tr -d "\n")
  rm -f $HOME/vapid_private_key.pem
  rm -f $HOME/vapid_public_key.pem

  initServicesCredentials
  if [ -z "$MASTODON_REDIS_PASSWORD" ]; then
    MASTODON_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_REDIS_PASSWORD $MASTODON_REDIS_PASSWORD
  fi
  if [ -z "$MASTODON_ELASTICSEARCH_PASSWORD" ]; then
    MASTODON_ELASTICSEARCH_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar MASTODON_ELASTICSEARCH_PASSWORD $MASTODON_ELASTICSEARCH_PASSWORD
  fi

  outputConfigMastodon
  generateCert mastodon-app mastodon-app
  generateCert mastodon-web mastodon-web
  generateCert mastodon-elasticsearch mastodon-elasticsearch
  outputMastdonMigrate $(getScriptImageByContainerName mastodon-db) $(getScriptImageByContainerName mastodon-redis) $(getScriptImageByContainerName mastodon-app)
  cp $HOME/mastodon.env $HSHQ_STACKS_DIR/mastodon/stack.env
  sed -i "s|^TZ=.*|TZ=${TZ}|g" $HSHQ_STACKS_DIR/mastodon/stack.env
  migrateMastodon
  installStack mastodon mastodon-app "Listening on http" $HOME/mastodon.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Mastodon installed, sleeping 3 seconds..."
  sleep 3
  set +e
  docker exec mailu-admin flask mailu alias-delete $MASTODON_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $MASTODON_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  addaccount_res=$(docker exec mastodon-app tootctl accounts create $MASTODON_ADMIN_USERNAME --email=$MASTODON_ADMIN_EMAIL_ADDRESS --confirmed --role=Admin)
  MASTODON_ADMIN_PASSWORD=$(echo $addaccount_res | rev | cut -d" " -f1 | rev)
  updateConfigVar MASTODON_ADMIN_PASSWORD $MASTODON_ADMIN_PASSWORD

  sendEmail -s "Mastodon Login Info" -b "Mastodon Admin Username: $MASTODON_ADMIN_EMAIL_ADDRESS\nMastodon Admin Password: $MASTODON_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
  docker exec mastodon-app tootctl settings registrations close
  docker exec mastodon-app tootctl accounts approve $MASTODON_ADMIN_USERNAME > /dev/null 2>&1
  rm -f $HOME/mastodon-compose-tmp.yml

  inner_block=""
  inner_block=$inner_block">>https://$SUB_MASTODON.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://mastodon-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MASTODON $MANAGETLS_MASTODON "$is_integrate_hshq" $NETDEFAULT_MASTODON "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll mastodon "$FMLNAME_MASTODON" $USERTYPE_MASTODON "https://$SUB_MASTODON.$HOMESERVER_DOMAIN" "mastodon.png" "$(getHeimdallOrderFromSub $SUB_MASTODON $USERTYPE_MASTODON)"
    restartAllCaddyContainers
  fi
}

function outputConfigMastodon()
{
  outputMastodonCompose
  cat <<EOFMD > $HOME/mastodon.env
TZ=${TZ}
UID=$USERID
GID=$GROUPID
LOCAL_DOMAIN=$HOMESERVER_DOMAIN
WEB_DOMAIN=$SUB_MASTODON.$HOMESERVER_DOMAIN
SINGLE_USER_MODE=false
SECRET_KEY_BASE=$MASTODON_SECRET_KEY_BASE
OTP_SECRET=$MASTODON_OTP_SECRET
VAPID_PRIVATE_KEY=$MASTODON_VAPID_PRIVATE_KEY
VAPID_PUBLIC_KEY=$MASTODON_VAPID_PUBLIC_KEY
RAILS_SERVE_STATIC_FILES=true
ALLOWED_PRIVATE_ADDRESSES=10.0.0.0/8
DB_HOST=mastodon-db
DB_PORT=5432
DB_NAME=$MASTODON_DATABASE_NAME
DB_USER=$MASTODON_DATABASE_USER
DB_PASS=$MASTODON_DATABASE_USER_PASSWORD
POSTGRES_DB=$MASTODON_DATABASE_NAME
POSTGRES_USER=$MASTODON_DATABASE_USER
POSTGRES_PASSWORD=$MASTODON_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
REDIS_HOST=mastodon-redis
REDIS_PORT=6379
REDIS_PASSWORD=$MASTODON_REDIS_PASSWORD
CACHE_REDIS_HOST=mastodon-redis
CACHE_REDIS_PORT=6379
CACHE_REDIS_PASSWORD=$MASTODON_REDIS_PASSWORD
S3_ENABLED=false
IP_RETENTION_PERIOD=31556952
SESSION_RETENTION_PERIOD=31556952
SMTP_SERVER=$SMTP_HOSTNAME
SMTP_PORT=$SMTP_HOSTPORT
SMTP_FROM_ADDRESS=Mastodon $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>
ES_ENABLED=false
ES_HOST=mastodon-elasticsearch
ES_PORT=9200
ES_USER=elastic
ES_PASS=$MASTODON_ELASTICSEARCH_PASSWORD
LDAP_ENABLED=true
LDAP_HOST=ldapserver
LDAP_PORT=389
LDAP_METHOD=start_tls
LDAP_TLS_NO_VERIFY=false
LDAP_BASE=$LDAP_BASE_DN
LDAP_BIND_DN=$LDAP_READONLY_USER_BIND_DN
LDAP_PASSWORD=$LDAP_READONLY_USER_PASSWORD
LDAP_UID=uid
LDAP_SEARCH_FILTER=(&(|(%{uid}=%{email})(%{mail}=%{email}))(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))
ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$MASTODON_ARE_DETERMINISTIC_KEY
ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$MASTODON_ARE_KEY_DERIVATION_SALT
ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$MASTODON_ARE_PRIMARY_KEY
EOFMD

  cat <<EOFMD > $HSHQ_STACKS_DIR/mastodon/web/nginx.conf
worker_processes auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
  worker_connections  1024;
}


http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  log_format  main  '\$remote_addr - \$remote_user [\$time_local] "\$request" '
                    '\$status \$body_bytes_sent "\$http_referer" '
                    '"\$http_user_agent" "\$http_x_forwarded_for"';

  access_log  /var/log/nginx/access.log  main;

  sendfile        on;
  #tcp_nopush     on;

  # Prevent nginx HTTP Server Detection
  server_tokens   off;

  keepalive_timeout  65;

  map \$http_upgrade \$connection_upgrade {
    default upgrade;
    ''      close;
  }

  #gzip  on;

  upstream backend {
    server mastodon-app:3000 fail_timeout=0;
  }
  upstream streaming {
    server mastodon-streaming:4000 fail_timeout=0;
  }

  proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=CACHE:10m inactive=7d max_size=1g;

  server {
    listen 80;
    listen [::]:80;
    root /var/www/html;
    location /.well-known/acme-challenge/ { allow all; }
    location / { return 301 https://\$host\$request_uri; }
  }

  server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!MEDIUM:!LOW:!aNULL:!NULL:!SHA;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    ssl_certificate     /etc/nginx/certs/cert.crt;
    ssl_certificate_key /etc/nginx/certs/cert.key;

    keepalive_timeout    70;
    sendfile             on;
    client_max_body_size 256m;

    root /var/www/html;

    gzip on;
    gzip_disable "msie6";
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml image/x-icon;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains;" always;

    location / {
      try_files \$uri @proxy;
    }

    location ~ ^/(emoji|packs|system/accounts/avatars|system/media_attachments/files) {
      add_header Cache-Control "public, max-age=31536000, immutable";
      add_header Strict-Transport-Security "max-age=31536000" always;
      try_files \$uri @proxy;
    }

    location /sw.js {
      add_header Cache-Control "public, max-age=0";
      add_header Strict-Transport-Security "max-age=31536000" always;
      try_files \$uri @proxy;
    }

    location @proxy {
      proxy_set_header Host \$host;
      proxy_set_header X-Real-IP \$remote_addr;
      proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto \$scheme;
      proxy_set_header Proxy "";
      proxy_pass_header Server;

      proxy_pass http://backend;
      proxy_buffering on;
      proxy_redirect off;
      proxy_http_version 1.1;
      proxy_set_header Upgrade \$http_upgrade;
      proxy_set_header Connection \$connection_upgrade;

      proxy_cache CACHE;
      proxy_cache_valid 200 7d;
      proxy_cache_valid 410 24h;
      proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
      add_header X-Cached \$upstream_cache_status;
      add_header Strict-Transport-Security "max-age=31536000" always;

      tcp_nodelay on;
    }

    location /api/v1/streaming {
      proxy_set_header Host \$host;
      proxy_set_header X-Real-IP \$remote_addr;
      proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto \$scheme;
      proxy_set_header Proxy "";

      proxy_pass http://streaming;
      proxy_buffering off;
      proxy_redirect off;
      proxy_http_version 1.1;
      proxy_set_header Upgrade \$http_upgrade;
      proxy_set_header Connection \$connection_upgrade;

      tcp_nodelay on;
    }

    error_page 500 501 502 503 504 /500.html;
  }
}

EOFMD
}

function outputMastodonCompose()
{
  cat <<EOFMD > $HOME/mastodon-compose.yml
$STACK_VERSION_PREFIX mastodon $(getScriptStackVersion mastodon)

services:
  mastodon-db:
    image: $(getScriptImageByContainerName mastodon-db)
    container_name: mastodon-db
    hostname: mastodon-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-mastodon-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mastodon/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/mastodon/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.mastodon-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.mastodon-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.mastodon-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.mastodon-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.mastodon-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.mastodon-hourly-db.email-from=Mastodon Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.mastodon-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.mastodon-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.mastodon-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.mastodon-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.mastodon-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.mastodon-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.mastodon-monthly-db.email-from=Mastodon Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.mastodon-monthly-db.mail-only-on-error=false"

  mastodon-redis:
    image: $(getScriptImageByContainerName mastodon-redis)
    container_name: mastodon-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-mastodon-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mastodon-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$MASTODON_REDIS_PASSWORD

  mastodon-redis-cache:
    image: $(getScriptImageByContainerName mastodon-redis-cache)
    container_name: mastodon-redis-cache
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-mastodon-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - REDIS_PASSWORD=$MASTODON_REDIS_PASSWORD

  mastodon-app:
    image: $(getScriptImageByContainerName mastodon-app)
    container_name: mastodon-app
    hostname: mastodon-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: bash -c "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000"
    depends_on:
      - mastodon-db
      - mastodon-redis
      #- mastodon-elasticsearch
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider --proxy=off localhost:3000/health || exit 1']
    networks:
      - int-mastodon-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/mastodon/system:/mastodon/public/system
      - v-mastodon-static:/mastodon/public

  mastodon-streaming:
    image: $(getScriptImageByContainerName mastodon-streaming)
    container_name: mastodon-streaming
    hostname: mastodon-streaming
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: node ./streaming/index.js
    depends_on:
      - mastodon-db
      - mastodon-redis
    healthcheck:
      test: ['CMD-SHELL', "curl -s --noproxy localhost localhost:4000/api/v1/streaming/health | grep -q 'OK' || exit 1"]
    networks:
      - int-mastodon-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  mastodon-sidekiq:
    image: $(getScriptImageByContainerName mastodon-sidekiq)
    container_name: mastodon-sidekiq
    hostname: mastodon-sidekiq
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: bundle exec sidekiq
    depends_on:
      - mastodon-db
      - mastodon-redis
    healthcheck:
      test: ['CMD-SHELL', "ps aux | grep '[s]idekiq\ 6' || false"]
    networks:
      - int-mastodon-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/mastodon/system:/mastodon/public/system

  mastodon-web:
    image: $(getScriptImageByContainerName mastodon-web)
    container_name: mastodon-web
    hostname: mastodon-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-mastodon-net
      - dock-proxy-net
    depends_on:
      - mastodon-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/mastodon-web.crt:/etc/nginx/certs/cert.crt
      - \${HSHQ_SSL_DIR}/mastodon-web.key:/etc/nginx/certs/cert.key
      - \${HSHQ_STACKS_DIR}/mastodon/web/nginx.conf:/etc/nginx/nginx.conf
      - v-mastodon-static:/var/www/html:ro

#  mastodon-elasticsearch:
#    image: $(getScriptImageByContainerName mastodon-elasticsearch)
#    container_name: mastodon-elasticsearch
#    hostname: mastodon-elasticsearch
#    restart: unless-stopped
#    security_opt:
#      - no-new-privileges:true
#    healthcheck:
#       test: ["CMD-SHELL", "nc -z mastodon-elasticsearch 9200"]
#    networks:
#      - int-mastodon-net
#      - dock-ext-net
#    volumes:
#      - /etc/localtime:/etc/localtime:ro
#      - /etc/timezone:/etc/timezone:ro
#      - /etc/ssl/certs:/etc/ssl/certs:ro
#      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
#      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
#      - \${HSHQ_SSL_DIR}/mastodon-elasticsearch.crt:/usr/share/elasticsearch/config/certs/mastodon-elasticsearch.crt
#      - \${HSHQ_SSL_DIR}/mastodon-elasticsearch.key:/usr/share/elasticsearch/config/certs/mastodon-elasticsearch.key
#      - \${HSHQ_STACKS_DIR}/mastodon/elasticsearch:/usr/share/elasticsearch/data
#    ulimits:
#      memlock:
#        soft: -1
#        hard: -1
#      nofile:
#        soft: 65536
#        hard: 65536
#    environment:
#      - "ELASTIC_PASSWORD=$MASTODON_ELASTICSEARCH_PASSWORD"
#      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
#      - "xpack.security.enabled=true"
#      - "xpack.security.transport.ssl.enabled=true"
#      - "xpack.security.transport.ssl.certificate=/usr/share/elasticsearch/config/certs/mastodon-elasticsearch.crt"
#      - "xpack.security.transport.ssl.key=/usr/share/elasticsearch/config/certs/mastodon-elasticsearch.key"
#      - "xpack.watcher.enabled=false"
#      - "xpack.graph.enabled=false"
#      - "xpack.ml.enabled=false"
#      - "ingest.geoip.downloader.enabled=false"
#      - "bootstrap.memory_lock=true"
#      - "cluster.name=es-mastodon"
#      - "discovery.type=single-node"

volumes:
  v-mastodon-static:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/mastodon/static
  v-mastodon-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/mastodon/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-mastodon-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFMD

}

function performUpdateMastodon()
{
  perform_stack_name=mastodon
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # Stack status: 1=running, 2=stopped
  stackStatus=$(getStackStatusByID $perform_stack_id "$portainerToken")
  if [ -z "$stackStatus" ]; then
    is_upgrade_error=true
    perform_update_report="ERROR ($perform_stack_name): Could not get stack status"
    return
  fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.1.6,nginx:1.23.2-alpine,elasticsearch:8.8.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.1.6,tootsuite/mastodon:v4.2.8"
      image_update_map[3]="nginx:1.23.2-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.8.1,elasticsearch:8.12.2"
      # This upgrade requires a migration
      prepMastodonMigrate postgres:15.0-bullseye bitnami/redis:7.0.5 tootsuite/mastodon:v4.2.3 $perform_stack_id
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfMigrateMastodon false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.3,nginx:1.25.3-alpine,elasticsearch:8.11.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.2.3,tootsuite/mastodon:v4.2.8"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.11.3,elasticsearch:8.12.2"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.3,nginx:1.25.3-alpine,elasticsearch:8.12.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.2.3,tootsuite/mastodon:v4.2.8"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.12.0,elasticsearch:8.12.2"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.8,nginx:1.25.3-alpine,elasticsearch:8.12.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.2.8,tootsuite/mastodon:v4.2.10"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.12.2,elasticsearch:8.12.2"
    ;;
    5)
      newVer=v7
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.2.10,nginx:1.25.3-alpine,elasticsearch:8.12.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.2.10,tootsuite/mastodon:v4.3.1"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.12.2,elasticsearch:8.12.2"
      # This upgrade requires a migration
      prepMastodonMigrate postgres:15.0-bullseye bitnami/redis:7.0.5 tootsuite/mastodon:v4.3.1 $perform_stack_id
      echo "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$MASTODON_ARE_DETERMINISTIC_KEY" >> $HSHQ_STACKS_DIR/mastodon/stack.env
      echo "ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$MASTODON_ARE_KEY_DERIVATION_SALT" >> $HSHQ_STACKS_DIR/mastodon/stack.env
      echo "ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$MASTODON_ARE_PRIMARY_KEY" >> $HSHQ_STACKS_DIR/mastodon/stack.env
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfMigrateMastodon true mfUpdateMastodonV7
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.3.1,nginx:1.25.3-alpine,elasticsearch:8.12.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[2]="tootsuite/mastodon:v4.3.1,tootsuite/mastodon:v4.3.1"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      image_update_map[4]="elasticsearch:8.12.2,elasticsearch:8.12.2"
      # This update simply fixes the mastodon-streaming issue, i.e. it has its own container and a few aspects of the docker compose needed an update
      # See https://github.com/mastodon/mastodon/pull/31554/files/51638f89b57613f01b1696b8644478ff4937937b#diff-e45e45baeda1c1e73482975a664062aa56f20c03dd9d64a827aba57775bed0d3
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfUpdateMastodonV7
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    7)
      newVer=v8
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,tootsuite/mastodon:v4.3.1,nginx:1.25.3-alpine,elasticsearch:8.12.2,tootsuite/mastodon-streaming:v4.3.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[2]="tootsuite/mastodon:v4.3.1,tootsuite/mastodon:v4.3.7"
      image_update_map[3]="nginx:1.25.3-alpine,nginx:1.27.4-alpine"
      image_update_map[4]="elasticsearch:8.12.2,elasticsearch:8.17.4"
      image_update_map[5]="tootsuite/mastodon-streaming:v4.3.1,tootsuite/mastodon-streaming:v4.3.7"
    ;;
    8)
      newVer=v8
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.4.2,tootsuite/mastodon:v4.3.7,nginx:1.27.4-alpine,elasticsearch:8.12.2,tootsuite/mastodon-streaming:v4.3.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[2]="tootsuite/mastodon:v4.3.7,tootsuite/mastodon:v4.3.7"
      image_update_map[3]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
      image_update_map[4]="elasticsearch:8.17.4,elasticsearch:8.17.4"
      image_update_map[5]="tootsuite/mastodon-streaming:v4.3.7,tootsuite/mastodon-streaming:v4.3.7"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfClearStaticAssetsMastodon false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function outputMastdonMigrate()
{
  mastodon_db_image=$1
  mastodon_redis_image=$2
  mastodon_app_image=$3
  cat <<EOFMD > $HSHQ_STACKS_DIR/mastodon/docker-compose.yml

services:
  mastodon-db:
    image: $mastodon_db_image
    container_name: mastodon-db
    hostname: mastodon-db
    user: "${USERID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-mastodon-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${HSHQ_STACKS_DIR}/mastodon/db:/var/lib/postgresql/data

  mastodon-redis:
    image: $mastodon_redis_image
    container_name: mastodon-redis
    hostname: mastodon-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-mastodon-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-mastodon-redis:/bitnami/redis/data

  mastodon-redis-cache:
    image: $mastodon_redis_image
    container_name: mastodon-redis-cache
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-mastodon-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  mastodon-app:
    image: $mastodon_app_image
    container_name: mastodon-app
    hostname: mastodon-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: bash -c "rm -f /mastodon/tmp/pids/server.pid; bundle exec rails s -p 3000"
    depends_on:
      - mastodon-db
      - mastodon-redis
    healthcheck:
      test: ['CMD-SHELL', 'wget -q --spider --proxy=off localhost:3000/health || exit 1']
    networks:
      - int-mastodon-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/mastodon/system:/mastodon/public/system
      - v-mastodon-static:/mastodon/public

volumes:
  v-mastodon-static:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_NONBACKUP_DIR}/mastodon/static
  v-mastodon-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_NONBACKUP_DIR}/mastodon/redis

networks:
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-mastodon-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFMD

}

function prepMastodonMigrate()
{
  mastodon_db_image=$1
  mastodon_redis_image=$2
  mastodon_app_image=$3
  mastodon_stack_id=$4
  outputMastdonMigrate "$mastodon_db_image" "$mastodon_redis_image" "$mastodon_app_image"
  sudo cp $HSHQ_STACKS_DIR/portainer/compose/$mastodon_stack_id/stack.env $HSHQ_STACKS_DIR/mastodon/stack.env
  sudo chown $USERID:$USERID $HSHQ_STACKS_DIR/mastodon/stack.env
  sed -i "s|^TZ=.*|TZ=${TZ}|g" $HSHQ_STACKS_DIR/mastodon/stack.env
}

function migrateMastodon()
{
  # This function assumes the Mastodon stack/containers are NOT running.
  echo -e "\nPerforming Mastodon database migration...this could take a few minutes\n"
  sudo rm -fr ${HSHQ_NONBACKUP_DIR}/mastodon/static/*
  sudo rm -fr ${HSHQ_NONBACKUP_DIR}/mastodon/redis/*
  cd ~
  docker compose -f $HSHQ_STACKS_DIR/mastodon/docker-compose.yml run --rm mastodon-app bundle exec rake db:migrate > /dev/null 2>&1
  cd ~
  docker compose -f $HSHQ_STACKS_DIR/mastodon/docker-compose.yml down -v
  rm -f $HSHQ_STACKS_DIR/mastodon/docker-compose.yml
  rm -f $HSHQ_STACKS_DIR/mastodon/stack.env
  echo -e "\nFinished mastodon database migration, sleeping 3 seconds"
  sleep 3
}

function mfMigrateMastodon()
{
  if [ "$stackStatus" = "1" ];then
    # Stack is running, stop it, then migrate
    startStopStack mastodon stop "$portainerToken"
    isStartStackFromStopped=true
    sleep 3
  fi
  migrateMastodon
}

function mfUpdateMastodonV7()
{
  set +e
  rm -f $HOME/mastodon-compose.yml
  outputMastodonCompose
  pullImage $(getScriptImageByContainerName mastodon-streaming)
  grep "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY" $HSHQ_STACKS_DIR/mastodon/stack.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY=$MASTODON_ARE_DETERMINISTIC_KEY" >> $HSHQ_STACKS_DIR/mastodon/stack.env
    echo "ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT=$MASTODON_ARE_KEY_DERIVATION_SALT" >> $HSHQ_STACKS_DIR/mastodon/stack.env
    echo "ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY=$MASTODON_ARE_PRIMARY_KEY" >> $HSHQ_STACKS_DIR/mastodon/stack.env
  fi
}

function clearStaticAssetsMastodon()
{
  # This function assumes the Mastodon stack/containers are NOT running.
  echo -e "\nClearing Mastodon static assets...\n"
  sudo rm -fr ${HSHQ_NONBACKUP_DIR}/mastodon/static/*
  sudo rm -fr ${HSHQ_NONBACKUP_DIR}/mastodon/redis/*
  sleep 3
}

function mfClearStaticAssetsMastodon()
{
  if [ "$stackStatus" = "1" ];then
    # Stack is running, stop it, then clear assets
    startStopStack mastodon stop "$portainerToken"
    isStartStackFromStopped=true
    sleep 3
  fi
  clearStaticAssetsMastodon
}

# Dozzle
function installDozzle()
{
  set +e
  is_integrate_hshq=$1
  # Have to check if stack/container exists
  checkDeleteStackAndDirectory dozzle "Dozzle"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  set -e
  pullImage $(getScriptImageByContainerName dozzle)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/dozzle
  initServicesCredentials
  outputConfigDozzle
  installStack dozzle dozzle "Accepting connections on" $HOME/dozzle.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Dozzle installed, sleeping 3 seconds..."
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_DOZZLE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://dozzle:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_DOZZLE $MANAGETLS_DOZZLE "$is_integrate_hshq" $NETDEFAULT_DOZZLE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll dozzle "$FMLNAME_DOZZLE" $USERTYPE_DOZZLE "https://$SUB_DOZZLE.$HOMESERVER_DOMAIN" "dozzle.png" "$(getHeimdallOrderFromSub $SUB_DOZZLE $USERTYPE_DOZZLE)"
    restartAllCaddyContainers
  fi
}

function outputConfigDozzle()
{
  cat <<EOFDZ > $HOME/dozzle-compose.yml
$STACK_VERSION_PREFIX dozzle $(getScriptStackVersion dozzle)

services:
  dozzle:
    image: $(getScriptImageByContainerName dozzle)
    container_name: dozzle
    hostname: dozzle
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - \${HSHQ_STACKS_DIR}/dozzle/users.yml:/data/users.yml

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
EOFDZ

  cat <<EOFDZ > $HOME/dozzle.env
DOZZLE_NO_ANALYTICS=true
DOZZLE_AUTH_PROVIDER=simple
EOFDZ

  cat <<EOFDZ > $HSHQ_STACKS_DIR/dozzle/users.yml
users:
  $DOZZLE_USERNAME:
    name: "$HOMESERVER_NAME Admin"
    password: "$(echo -n $DOZZLE_PASSWORD | shasum -a 256 | xargs | cut -d' ' -f1)"
EOFDZ

}

function performUpdateDozzle()
{
  perform_stack_name=dozzle
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v6
      curImageList=amir20/dozzle:v4.10.26
      image_update_map[0]="amir20/dozzle:v4.10.26,amir20/dozzle:v6.1.1"
    ;;
    2)
      newVer=v6
      curImageList=amir20/dozzle:v5.8.1
      image_update_map[0]="amir20/dozzle:v5.8.1,amir20/dozzle:v6.1.1"
    ;;
    3)
      newVer=v6
      curImageList=amir20/dozzle:v6.0.8
      image_update_map[0]="amir20/dozzle:v6.0.8,amir20/dozzle:v6.1.1"
    ;;
    4)
      newVer=v6
      curImageList=amir20/dozzle:v6.1.1
      image_update_map[0]="amir20/dozzle:v6.1.1,amir20/dozzle:v6.1.1"
    ;;
    5)
      newVer=v6
      curImageList=amir20/dozzle:v8.7.1
      image_update_map[0]="amir20/dozzle:v8.7.1,amir20/dozzle:v6.1.1"
    ;;
    6)
      # Reverting back to v6.1.1, since v8.7.1 uses a lot more CPU at idle
      newVer=v6
      curImageList=amir20/dozzle:v6.1.1
      image_update_map[0]="amir20/dozzle:v6.1.1,amir20/dozzle:v6.1.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# SearxNG
function installSearxNG()
{
  set +e
  is_integrate_hshq=$1
  # If directory exists, then delete it
  checkDeleteStackAndDirectory searxng "SearxNG"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName searxng-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName searxng-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/searxng
  mkdir $HSHQ_STACKS_DIR/searxng/caddy
  mkdir $HSHQ_STACKS_DIR/searxng/web
  mkdir $HSHQ_NONBACKUP_DIR/searxng
  mkdir $HSHQ_NONBACKUP_DIR/searxng/redis

  if [ -z "$SEARXNG_REDIS_PASSWORD" ]; then
    SEARXNG_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SEARXNG_REDIS_PASSWORD $SEARXNG_REDIS_PASSWORD
  fi
  if [ -z "$SEARXNG_SECRET_KEY" ]; then
    SEARXNG_SECRET_KEY=$(openssl rand -hex 32)
    updateConfigVar SEARXNG_SECRET_KEY $SEARXNG_SECRET_KEY
  fi

  generateCert searxng-caddy searxng-caddy
  outputConfigSearxNG
  installStack searxng searxng-app "Listen on " $HOME/searxng.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SEARXNG.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://searxng-caddy {\n"
  inner_block=$inner_block">>>>>>>>header_up Host {upstream_hostport}\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SEARXNG $MANAGETLS_SEARXNG "$is_integrate_hshq" $NETDEFAULT_SEARXNG "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll searxng "$FMLNAME_SEARXNG" $USERTYPE_SEARXNG "https://$SUB_SEARXNG.$HOMESERVER_DOMAIN" "searxng.png" "$(getHeimdallOrderFromSub $SUB_SEARXNG $USERTYPE_SEARXNG)"
    restartAllCaddyContainers
  fi
}

function outputConfigSearxNG()
{
  cat <<EOFSE > $HOME/searxng-compose.yml
$STACK_VERSION_PREFIX searxng $(getScriptStackVersion searxng)

services:
  searxng-caddy:
    image: $(getScriptImageByContainerName searxng-caddy)
    container_name: searxng-caddy
    hostname: searxng-caddy
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-searxng-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/searxng-caddy.crt:/certs/searxng-caddy.crt
      - \${HSHQ_SSL_DIR}/searxng-caddy.key:/certs/searxng-caddy.key
      - \${HSHQ_STACKS_DIR}/searxng/caddy/Caddyfile:/etc/caddy/Caddyfile
      - \${HSHQ_STACKS_DIR}/searxng/caddy/data:/data
      - \${HSHQ_STACKS_DIR}/searxng/caddy/config:/config

  searxng-app:
    image: $(getScriptImageByContainerName searxng-app)
    container_name: searxng-app
    hostname: searxng-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-searxng-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/searxng/web:/etc/searxng:rw
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"

  searxng-redis:
    image: $(getScriptImageByContainerName searxng-redis)
    container_name: searxng-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-searxng-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-searxng-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$SEARXNG_REDIS_PASSWORD

volumes:
  v-searxng-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/searxng/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-searxng-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFSE

  cat <<EOFSE > $HOME/searxng.env
SEARXNG_BASE_URL=https://$SUB_SEARXNG.$HOMESERVER_DOMAIN/
EOFSE

  cat <<EOFSE > $HSHQ_STACKS_DIR/searxng/web/settings.yml
use_default_settings: true
general:
  instance_name: "$HOMESERVER_NAME Search Engine"
  donation_url: false
  contact_url: false
  enable_metrics: false
server:
  base_url: false
  bind_address: "0.0.0.0"
  secret_key: "$SEARXNG_SECRET_KEY"
  limiter: false
  image_proxy: true
  method: "GET"
ui:
  static_use_hash: true
  theme_args:
    simple_style: dark
  center_alignment: true
  results_on_new_tab: true
redis:
  url: redis://:$SEARXNG_REDIS_PASSWORD@searxng-redis:6379/0
enabled_plugins:
  - 'Hash plugin'
  - 'Search on category select'
  - 'Tracker URL remover'
  - 'Open Access DOI rewrite'
engines:
  - name: duckduckgo
    engine: duckduckgo
    shortcut: ddg
    disabled: true
  - name: brave
    shortcut: brave
    engine: xpath
    paging: true
    time_range_support: true
    first_page_num: 0
    time_range_url: "&tf={time_range_val}"
    search_url: https://search.brave.com/search?q={query}&offset={pageno}&spellcheck=1{time_range}
    url_xpath: //a[@class="result-header"]/@href
    title_xpath: //span[@class="snippet-title"]
    content_xpath: //p[1][@class="snippet-description"]
    suggestion_xpath: //div[@class="text-gray h6"]/a
    time_range_map:
      day: 'pd'
      week: 'pw'
      month: 'pm'
      year: 'py'
    categories: [general, web]
    disabled: false
    headers:
      Accept-Encoding: gzip, deflate
    about:
      website: https://brave.com/search/
      wikidata_id: Q107355971
      use_official_api: false
      require_api_key: false
      results: HTML
  - name: startpage
    engine: startpage
    shortcut: sp
    timeout: 6.0
    disabled: false
EOFSE

  cat <<EOFSE > $HSHQ_STACKS_DIR/searxng/caddy/Caddyfile
{
  admin off
}

https://searxng-caddy {

  tls /certs/searxng-caddy.crt /certs/searxng-caddy.key 

  @api {
    path /config
    path /healthz
    path /stats/errors
    path /stats/checker
  }
  @static {
    path /static/*
  }
  @notstatic {
    not path /static/*
  }
  @imageproxy {
    path /image_proxy
  }
  @notimageproxy {
    not path /image_proxy
  }
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    Permissions-Policy "accelerometer=(),ambient-light-sensor=(),autoplay=(),camera=(),encrypted-media=(),focus-without-user-activation=(),geolocation=(),gyroscope=(),magnetometer=(),microphone=(),midi=(),payment=(),picture-in-picture=(),speaker=(),sync-xhr=(),usb=(),vr=()"
    Feature-Policy "accelerometer 'none';ambient-light-sensor 'none'; autoplay 'none';camera 'none';encrypted-media 'none';focus-without-user-activation 'none'; geolocation 'none';gyroscope 'none';magnetometer 'none';microphone 'none';midi 'none';payment 'none';picture-in-picture 'none'; speaker 'none';sync-xhr 'none';usb 'none';vr 'none'"
    Referrer-Policy "no-referrer"
    X-Robots-Tag "noindex, noarchive, nofollow"
    -Server
  }
  header @api {
    Access-Control-Allow-Methods "GET, OPTIONS"
    Access-Control-Allow-Origin  "*"
  }
  header @static {
    Cache-Control "public, max-age=31536000"
    defer
  }
  header @notstatic {
    # No Cache
    Cache-Control "no-cache, no-store"
    Pragma "no-cache"
  }
  header @imageproxy {
    Content-Security-Policy "default-src 'none'; img-src 'self' data:"
  }
  header @notimageproxy {
    Content-Security-Policy "upgrade-insecure-requests; default-src 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; form-action 'self' https://github.com/searxng/searxng/issues/new; font-src 'self'; frame-ancestors 'self'; base-uri 'self'; connect-src 'self' https://overpass-api.de; img-src 'self' data: https://*.tile.openstreetmap.org; frame-src https://www.youtube-nocookie.com https://player.vimeo.com https://www.dailymotion.com https://www.deezer.com https://www.mixcloud.com https://w.soundcloud.com https://embed.spotify.com"
  }
  handle {
    encode zstd gzip
    reverse_proxy searxng-app:8080 {
      header_up X-Forwarded-Port {http.request.port}
      header_up X-Forwarded-Proto {http.request.scheme}
    }
  }
}

EOFSE

}

function performUpdateSearxNG()
{
  perform_stack_name=searxng
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v6
      curImageList=searxng/searxng:2023.8.19-018b0a932
      image_update_map[0]="searxng/searxng:2023.8.19-018b0a932,searxng/searxng:2025.4.1-e6308b816"
    ;;
    2)
      newVer=v6
      curImageList=searxng/searxng:2023.12.29-27e26b3d6
      image_update_map[0]="searxng/searxng:2023.12.29-27e26b3d6,searxng/searxng:2025.4.1-e6308b816"
    ;;
    3)
      newVer=v6
      curImageList=searxng/searxng:2024.3.15-e2af3e497
      image_update_map[0]="searxng/searxng:2024.3.15-e2af3e497,searxng/searxng:2025.4.1-e6308b816"
    ;;
    4)
      newVer=v6
      curImageList=searxng/searxng:2024.7.29-3196e7e86
      image_update_map[0]="searxng/searxng:2024.7.29-3196e7e86,searxng/searxng:2025.4.1-e6308b816"
    ;;
    5)
      newVer=v6
      curImageList=searxng/searxng:2024.10.31-fa108c140
      image_update_map[0]="searxng/searxng:2024.10.31-fa108c140,searxng/searxng:2025.4.1-e6308b816"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfSearxngRemoveStartpage false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    6)
      newVer=v6
      curImageList=searxng/searxng:2025.4.1-e6308b816
      image_update_map[0]="searxng/searxng:2025.4.1-e6308b816,searxng/searxng:2025.4.1-e6308b816"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfSearxngRemoveStartpage()
{
  sed -i "/^search:/,+1d" $HSHQ_STACKS_DIR/searxng/web/settings.yml
}

# Jellyfin
function installJellyfin()
{
  set +e
  is_integrate_hshq=$1
  # Should check if directory exists
  checkDeleteStackAndDirectory jellyfin "Jellyfin"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jellyfin)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/jellyfin
  mkdir $HSHQ_STACKS_DIR/jellyfin/config
  mkdir $HSHQ_STACKS_DIR/jellyfin/cache
  mkdir $HSHQ_STACKS_DIR/jellyfin/media

  initServicesCredentials

  outputConfigJellyfin
  installStack jellyfin jellyfin "Startup complete" $HOME/jellyfin.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5
  sed -i 's/^.*EncodingThreadCount.*$/  <EncodingThreadCount>1<\/EncodingThreadCount>/' $HSHQ_STACKS_DIR/jellyfin/config/config/encoding.xml
  mv $HOME/jellyfin-ldap.xml $HSHQ_STACKS_DIR/jellyfin/config/plugins/configurations/LDAP-Auth.xml
  docker container restart jellyfin

  inner_block=""
  inner_block=$inner_block">>https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://jellyfin:8096 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_JELLYFIN $MANAGETLS_JELLYFIN "$is_integrate_hshq" $NETDEFAULT_JELLYFIN "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll jellyfin "$FMLNAME_JELLYFIN" $USERTYPE_JELLYFIN "https://$SUB_JELLYFIN.$HOMESERVER_DOMAIN" "jellyfin.png" "$(getHeimdallOrderFromSub $SUB_JELLYFIN $USERTYPE_JELLYFIN)"
    restartAllCaddyContainers
  fi
}

function outputConfigJellyfin()
{
  cat <<EOFJF > $HOME/jellyfin-compose.yml
$STACK_VERSION_PREFIX jellyfin $(getScriptStackVersion jellyfin)

services:
  jellyfin:
    image: $(getScriptImageByContainerName jellyfin)
    container_name: jellyfin
    hostname: jellyfin
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
    ports:
      # UPnP Conflicts with HomeAssistant
      #- "$UPNP_PORT:$UPNP_PORT/udp"
      - "$JELLYFIN_PORT:$JELLYFIN_PORT/udp"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/jellyfin/config:/config
      - \${HSHQ_STACKS_DIR}/jellyfin/cache:/cache
      - \${HSHQ_STACKS_DIR}/jellyfin/media:/media
#    devices:
#      - /dev/dri/renderD128:/dev/dri/renderD128
#      - /dev/dri/card0:/dev/dri/card0

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true

EOFJF

  cat <<EOFJF > $HOME/jellyfin.env
UID=$USERID
GID=$GROUPID
EOFJF

  cat <<EOFLD > $HOME/jellyfin-ldap.xml
<?xml version="1.0" encoding="utf-8"?>
<PluginConfiguration xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">
  <LdapServer>ldapserver</LdapServer>
  <LdapPort>389</LdapPort>
  <UseSsl>false</UseSsl>
  <UseStartTls>true</UseStartTls>
  <SkipSslVerify>false</SkipSslVerify>
  <LdapBindUser>cn=$LDAP_READONLY_USER_USERNAME,$LDAP_BASE_DN</LdapBindUser>
  <LdapBindPassword>$LDAP_READONLY_USER_PASSWORD</LdapBindPassword>
  <LdapBaseDn>$LDAP_BASE_DN</LdapBaseDn>
  <LdapSearchFilter>(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)</LdapSearchFilter>
  <LdapAdminBaseDn>cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN</LdapAdminBaseDn>
  <LdapAdminFilter>(memberOf=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)</LdapAdminFilter>
  <LdapSearchAttributes>uid,mail</LdapSearchAttributes>
  <EnableCaseInsensitiveUsername>false</EnableCaseInsensitiveUsername>
  <CreateUsersFromLdap>true</CreateUsersFromLdap>
  <AllowPassChange>false</AllowPassChange>
  <LdapUsernameAttribute>uid</LdapUsernameAttribute>
  <LdapPasswordAttribute>userPassword</LdapPasswordAttribute>
  <EnableAllFolders>true</EnableAllFolders>
  <PasswordResetUrl>https://$SUB_OPENLDAP_MANAGER.$HOMESERVER_DOMAIN</PasswordResetUrl>
</PluginConfiguration>
EOFLD

  chmod 644 $HOME/jellyfin-ldap.xml
}

function performUpdateJellyfin()
{
  perform_stack_name=jellyfin
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=jellyfin/jellyfin:10.8.10
      image_update_map[0]="jellyfin/jellyfin:10.8.10,jellyfin/jellyfin:10.9.8"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" notifyJellyfinLDAPPluginUpdate false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      sendEmailJellyfinLDAPPluginUpdate
      return
    ;;
    2)
      newVer=v3
      curImageList=jellyfin/jellyfin:10.8.13
      image_update_map[0]="jellyfin/jellyfin:10.8.13,jellyfin/jellyfin:10.9.8"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" notifyJellyfinLDAPPluginUpdate false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      sendEmailJellyfinLDAPPluginUpdate
      return
    ;;
    3)
      newVer=v5
      curImageList=jellyfin/jellyfin:10.9.8
      image_update_map[0]="jellyfin/jellyfin:10.9.8,jellyfin/jellyfin:10.10.6"
    ;;
    4)
      newVer=v5
      curImageList=jellyfin/jellyfin:10.10.0
      image_update_map[0]="jellyfin/jellyfin:10.10.0,jellyfin/jellyfin:10.10.6"
    ;;
    5)
      newVer=v5
      curImageList=jellyfin/jellyfin:10.10.6
      image_update_map[0]="jellyfin/jellyfin:10.10.6,jellyfin/jellyfin:10.10.6"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function notifyJellyfinLDAPPluginUpdate()
{
  stack_upgrade_report="${stack_upgrade_report}jellyfin: This version update requires the LDAP plugin to be reinstalled. See admin email ($EMAIL_ADMIN_EMAIL_ADDRESS) for more details.\n"
}

function sendEmailJellyfinLDAPPluginUpdate()
{
  sendEmail -s "Jellyfin Version Update" -b "This new version of Jellyfin requires the LDAP plugin to be updated as well. Login as the Jellyfin administrator ($JELLYFIN_ADMIN_USERNAME), and uninstall and reinstall the LDAP Authentication plugin. The new version of the plugin should be version (19.0.0.0). After reinstalling, ensure to restart the jellyfin stack in Portainer." -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
}

# FileBrowser
function installFileBrowser()
{
  set +e
  is_integrate_hshq=$1
  # Check if directory exists
  checkDeleteStackAndDirectory filebrowser "FileBrowser"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName filebrowser)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set +e

  mkdir $HSHQ_STACKS_DIR/filebrowser
  mkdir $HSHQ_STACKS_DIR/filebrowser/db
  mkdir $HSHQ_STACKS_DIR/filebrowser/srv
  initServicesCredentials
  FILEBROWSER_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $FILEBROWSER_PASSWORD | tr -d ':\n' | sed 's/$2y/$2a/')

  outputConfigFileBrowser
  installStack filebrowser filebrowser "Listening on" $HOME/filebrowser.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://filebrowser {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FILEBROWSER $MANAGETLS_FILEBROWSER "$is_integrate_hshq" $NETDEFAULT_FILEBROWSER "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll filebrowser "$FMLNAME_FILEBROWSER" $USERTYPE_FILEBROWSER "https://$SUB_FILEBROWSER.$HOMESERVER_DOMAIN" "filebrowser.png" "$(getHeimdallOrderFromSub $SUB_FILEBROWSER $USERTYPE_FILEBROWSER)"
    restartAllCaddyContainers
  fi
}

function outputConfigFileBrowser()
{
  cat <<EOFJF > $HOME/filebrowser-compose.yml
$STACK_VERSION_PREFIX filebrowser $(getScriptStackVersion filebrowser)

services:
  filebrowser:
    image: $(getScriptImageByContainerName filebrowser)
    container_name: filebrowser
    hostname: filebrowser
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/filebrowser/filebrowser.json:/.filebrowser.json
      - \${HSHQ_STACKS_DIR}/filebrowser/srv:/srv
      - \${HSHQ_STACKS_DIR}/filebrowser/db:/database

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true

EOFJF

  cat <<EOFJF > $HOME/filebrowser.env
UID=$USERID
GID=$GROUPID
FB_USERNAME=$FILEBROWSER_USERNAME
FB_PASSWORD='$FILEBROWSER_PASSWORD_HASH'
EOFJF

  cat <<EOFJF > $HSHQ_STACKS_DIR/filebrowser/filebrowser.json
{
  "port": 80,
  "baseURL": "",
  "address": "",
  "log": "stdout",
  "database": "/database/filebrowser.db",
  "root": "/srv"
}
EOFJF

}

function performUpdateFileBrowser()
{
  perform_stack_name=filebrowser
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.24.2
      image_update_map[0]="filebrowser/filebrowser:v2.24.2,filebrowser/filebrowser:v2.32.0"
    ;;
    2)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.26.0
      image_update_map[0]="filebrowser/filebrowser:v2.26.0,filebrowser/filebrowser:v2.32.0"
    ;;
    3)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.27.0
      image_update_map[0]="filebrowser/filebrowser:v2.27.0,filebrowser/filebrowser:v2.32.0"
    ;;
    4)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.30.0
      image_update_map[0]="filebrowser/filebrowser:v2.30.0,filebrowser/filebrowser:v2.32.0"
    ;;
    5)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.31.2
      image_update_map[0]="filebrowser/filebrowser:v2.31.2,filebrowser/filebrowser:v2.32.0"
    ;;
    6)
      newVer=v6
      curImageList=filebrowser/filebrowser:v2.32.0
      image_update_map[0]="filebrowser/filebrowser:v2.32.0,filebrowser/filebrowser:v2.32.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# PhotoPrism
function installPhotoPrism()
{
  set +e
  is_integrate_hshq=$1
  # Only install if directory does not exist
  checkDeleteStackAndDirectory photoprism "PhotoPrism"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName photoprism-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName photoprism-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/photoprism
  mkdir $HSHQ_STACKS_DIR/photoprism/db
  mkdir $HSHQ_STACKS_DIR/photoprism/dbexport
  mkdir $HSHQ_STACKS_DIR/photoprism/app
  mkdir $HSHQ_STACKS_DIR/photoprism/app/originals
  mkdir $HSHQ_STACKS_DIR/photoprism/app/import
  mkdir $HSHQ_STACKS_DIR/photoprism/app/storage
  chmod 777 $HSHQ_STACKS_DIR/photoprism/dbexport

  initServicesCredentials
  outputConfigPhotoPrism
  if ! [ "$PHOTOPRISM_INIT_ENV" = "true" ]; then
    sendEmail -s "PhotoPrism Admin Login Info" -b "PhotoPrism Admin Username: $PHOTOPRISM_ADMIN_USERNAME\nPhotoPrism Admin Password: $PHOTOPRISM_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    PHOTOPRISM_INIT_ENV=true
    updateConfigVar PHOTOPRISM_INIT_ENV $PHOTOPRISM_INIT_ENV
  fi
  echo "Starting PhotoPrism. Please be patient, this process takes a few minutes..."
  cd ~
  docker compose -f $HOME/photoprism-compose-tmp.yml up -d
  search="listening on 0.0.0.0:2342"
  isFound=false
  i=0
  set +e
  while [ $i -le 600 ]
  do
    findtext=$(docker logs photoprism-app 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 10 seconds, total wait=$i seconds..."
    sleep 10
    i=$((i+10))
  done
  if ! [ "$isFound" = "true" ]; then
    cd ~
    docker compose -f $HOME/photoprism-compose-tmp.yml down -v
    echo "ERROR: PhotoPrism did not start up correctly..."
    return 1
  fi
  sleep 5
  cd ~
  docker compose -f $HOME/photoprism-compose-tmp.yml down -v
  installStack photoprism photoprism-app "listening on 0.0.0.0:2342" $HOME/photoprism.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  rm -f $HOME/photoprism-compose-tmp.yml
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_PHOTOPRISM.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://photoprism-app:2342 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PHOTOPRISM $MANAGETLS_PHOTOPRISM "$is_integrate_hshq" $NETDEFAULT_PHOTOPRISM "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll photoprism "$FMLNAME_PHOTOPRISM" $USERTYPE_PHOTOPRISM "https://$SUB_PHOTOPRISM.$HOMESERVER_DOMAIN" "photoprism.png" "$(getHeimdallOrderFromSub $SUB_PHOTOPRISM $USERTYPE_PHOTOPRISM)"
    restartAllCaddyContainers
  fi
}

function outputConfigPhotoPrism()
{
  cat <<EOFPP > $HOME/photoprism-compose-tmp.yml

services:
  photoprism-db:
    image: $(getScriptImageByContainerName photoprism-db)
    container_name: photoprism-db
    hostname: photoprism-db
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-photoprism-net
    volumes:
      - v-photoprism-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=$PHOTOPRISM_DATABASE_ROOT_PASSWORD
      - MYSQL_DATABASE=$PHOTOPRISM_DATABASE_NAME
      - MYSQL_USER=$PHOTOPRISM_DATABASE_USER
      - MYSQL_PASSWORD=$PHOTOPRISM_DATABASE_USER_PASSWORD

  photoprism-app:
    image: $(getScriptImageByContainerName photoprism-app)
    container_name: photoprism-app
    hostname: photoprism-app
    restart: unless-stopped
    user: "$USERID:$GROUPID"
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    depends_on:
      - photoprism-db
    working_dir: "/photoprism"
    networks:
      - int-photoprism-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - $HSHQ_STACKS_DIR/photoprism/app/originals:/photoprism/originals
      - $HSHQ_STACKS_DIR/photoprism/app/import:/photoprism/import
      - $HSHQ_STACKS_DIR/photoprism/app/storage:/photoprism/storage
    environment:
      - "PHOTOPRISM_INIT=gpu tensorflow"
      - PHOTOPRISM_UID=$USERID
      - PHOTOPRISM_GID=$GROUPID
      - PHOTOPRISM_AUTH_MODE=public
      - PHOTOPRISM_SITE_URL=http://localhost:2342/
      - PHOTOPRISM_SITE_TITLE=PhotoPrism
      - "PHOTOPRISM_SITE_CAPTION=AI-Powered Photos App"
      - "PHOTOPRISM_SITE_DESCRIPTION=$HOMESERVER_NAME Photos"
      - "PHOTOPRISM_SITE_AUTHOR=$HOMESERVER_NAME"
      - PHOTOPRISM_ORIGINALS_LIMIT=5000
      - PHOTOPRISM_HTTP_COMPRESSION=gzip
      - PHOTOPRISM_LOG_LEVEL=info
      - PHOTOPRISM_READONLY=false
      - PHOTOPRISM_EXPERIMENTAL=false
      - PHOTOPRISM_DISABLE_CHOWN=true
      - PHOTOPRISM_DISABLE_WEBDAV=false
      - PHOTOPRISM_DISABLE_SETTINGS=false
      - PHOTOPRISM_DISABLE_TENSORFLOW=false
      - PHOTOPRISM_DISABLE_FACES=false
      - PHOTOPRISM_DISABLE_CLASSIFICATION=false
      - PHOTOPRISM_DISABLE_RAW=false
      - PHOTOPRISM_RAW_PRESETS=false
      - PHOTOPRISM_JPEG_QUALITY=85
      - PHOTOPRISM_DETECT_NSFW=false
      - PHOTOPRISM_UPLOAD_NSFW=true
      - HOME=/photoprism
      - PHOTOPRISM_DATABASE_DRIVER=mysql
      - PHOTOPRISM_DATABASE_SERVER=photoprism-db:3306
      - PHOTOPRISM_DATABASE_NAME=$PHOTOPRISM_DATABASE_NAME
      - PHOTOPRISM_DATABASE_USER=$PHOTOPRISM_DATABASE_USER
      - PHOTOPRISM_DATABASE_PASSWORD=$PHOTOPRISM_DATABASE_USER_PASSWORD

volumes:
  v-photoprism-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: $HSHQ_STACKS_DIR/photoprism/db

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-photoprism-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFPP

  cat <<EOFPP > $HOME/photoprism-compose.yml
$STACK_VERSION_PREFIX photoprism $(getScriptStackVersion photoprism)

services:
  photoprism-db:
    image: $(getScriptImageByContainerName photoprism-db)
    container_name: photoprism-db
    hostname: photoprism-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-photoprism-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-photoprism-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/photoprism/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.photoprism-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.photoprism-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.photoprism-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.photoprism-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.photoprism-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.photoprism-hourly-db.email-from=PhotoPrism Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.photoprism-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.photoprism-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.photoprism-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.photoprism-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.photoprism-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.photoprism-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.photoprism-monthly-db.email-from=PhotoPrism Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.photoprism-monthly-db.mail-only-on-error=false"

  photoprism-app:
    image: $(getScriptImageByContainerName photoprism-app)
    container_name: photoprism-app
    hostname: photoprism-app
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    depends_on:
      - photoprism-db
    working_dir: "/photoprism"
    networks:
      - int-photoprism-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/photoprism/app/originals:/photoprism/originals
      - \${HSHQ_STACKS_DIR}/photoprism/app/import:/photoprism/import
      - \${HSHQ_STACKS_DIR}/photoprism/app/storage:/photoprism/storage

volumes:
  v-photoprism-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/photoprism/db

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-photoprism-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFPP

  outputPhotoPrismEnv
}

function outputPhotoPrismEnv()
{
  cat <<EOFPP > $HOME/photoprism.env
PHOTOPRISM_UID=$USERID
PHOTOPRISM_GID=$GROUPID
PHOTOPRISM_AUTH_MODE=password
PHOTOPRISM_ADMIN_USER=$PHOTOPRISM_ADMIN_USERNAME
PHOTOPRISM_ADMIN_PASSWORD=$PHOTOPRISM_ADMIN_PASSWORD
PHOTOPRISM_SITE_URL=http://localhost:2342/
PHOTOPRISM_SITE_CAPTION=AI-Powered Photos App
PHOTOPRISM_SITE_DESCRIPTION=$HOMESERVER_NAME Photos
PHOTOPRISM_SITE_AUTHOR=$HOMESERVER_NAME
PHOTOPRISM_HTTP_COMPRESSION=gzip
PHOTOPRISM_JPEG_SIZE=7680
PHOTOPRISM_THUMB_FILTER=lanczos
PHOTOPRISM_THUMB_UNCACHED=true
PHOTOPRISM_THUMB_SIZE=1920
PHOTOPRISM_THUMB_SIZE_UNCACHED=7680
PHOTOPRISM_READONLY=false
PHOTOPRISM_EXPERIMENTAL=false
PHOTOPRISM_DISABLE_CHOWN=true
PHOTOPRISM_DISABLE_WEBDAV=false
PHOTOPRISM_DISABLE_SETTINGS=false
PHOTOPRISM_DISABLE_TENSORFLOW=false
PHOTOPRISM_RAW_PRESETS=false
PHOTOPRISM_DETECT_NSFW=false
PHOTOPRISM_UPLOAD_NSFW=true
HOME=/photoprism
PHOTOPRISM_DATABASE_DRIVER=mysql
PHOTOPRISM_DATABASE_SERVER=photoprism-db:3306
PHOTOPRISM_DATABASE_NAME=$PHOTOPRISM_DATABASE_NAME
PHOTOPRISM_DATABASE_USER=$PHOTOPRISM_DATABASE_USER
PHOTOPRISM_DATABASE_PASSWORD=$PHOTOPRISM_DATABASE_USER_PASSWORD
MYSQL_DATABASE=$PHOTOPRISM_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$PHOTOPRISM_DATABASE_ROOT_PASSWORD
MYSQL_USER=$PHOTOPRISM_DATABASE_USER
MYSQL_PASSWORD=$PHOTOPRISM_DATABASE_USER_PASSWORD
EOFPP

}

function performUpdatePhotoPrism()
{
  perform_stack_name=photoprism
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=mariadb:10.7.3,photoprism/photoprism:220901-bullseye
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="photoprism/photoprism:220901-bullseye,photoprism/photoprism:240915"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfUpdatePhotoPrismV2
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      sendEmail -s "PhotoPrism Admin Login Info" -b "PhotoPrism Admin Username: $PHOTOPRISM_ADMIN_USERNAME\nPhotoPrism Admin Password: $PHOTOPRISM_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
      PHOTOPRISM_INIT_ENV=true
      updateConfigVar PHOTOPRISM_INIT_ENV $PHOTOPRISM_INIT_ENV
      return
    ;;
    2)
      newVer=v2
      curImageList=mariadb:10.7.3,photoprism/photoprism:240915
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="photoprism/photoprism:240915,photoprism/photoprism:240915"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfUpdatePhotoPrismV2()
{
  rm -f $HOME/photoprism.env
  outputPhotoPrismEnv
}

# Guacamole
function installGuacamole()
{
  set +e
  is_integrate_hshq=$1
  # Don't proceed if directory exists
  checkDeleteStackAndDirectory guacamole "Guacamole"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName guacamole-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName guacamole-daemon)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName guacamole-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/guacamole
  mkdir $HSHQ_STACKS_DIR/guacamole/db
  mkdir $HSHQ_STACKS_DIR/guacamole/dbexport
  mkdir $HSHQ_STACKS_DIR/guacamole/init
  chmod 777 $HSHQ_STACKS_DIR/guacamole/dbexport
  initServicesCredentials
  if [ -z "$GUACAMOLE_DATABASE_ROOT_PASSWORD" ]; then
    GUACAMOLE_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GUACAMOLE_DATABASE_ROOT_PASSWORD $GUACAMOLE_DATABASE_ROOT_PASSWORD
  fi

  outputConfigGuacamole
  docker run --rm $(getScriptImageByContainerName guacamole-web) /opt/guacamole/bin/initdb.sh --mysql > $HSHQ_STACKS_DIR/guacamole/init/initdb.sql
  cd ~
  docker compose -f $HOME/guacamole-compose-tmp.yml up -d
  echo "Waiting at least 15 seconds before continuing..."
  sleep 15
  search="ready for connections"
  isFound=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs guacamole-db 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 5 seconds, total wait=$i seconds..."
    sleep 5
    i=$((i+5))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "Guacamole did not start up correctly..."
    cd ~
    docker compose -f $HOME/guacamole-compose-tmp.yml down -v
    rm -f $HOME/guacamole-compose-tmp.yml
    return 1
  fi
  sleep 5
  cd ~
  docker compose -f $HOME/guacamole-compose-tmp.yml down -v
  installStack guacamole guacamole-web "Server startup in" $HOME/guacamole.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  rm -f $HOME/guacamole-compose-tmp.yml
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_GUACAMOLE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>@notGuac {\n"
  inner_block=$inner_block">>>>>>>>not path \"/guacamole/*\"\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>redir @notGuac /guacamole/\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://guacamole-web:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GUACAMOLE $MANAGETLS_GUACAMOLE "$is_integrate_hshq" $NETDEFAULT_GUACAMOLE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll guacamole "$FMLNAME_GUACAMOLE" $USERTYPE_GUACAMOLE "https://$SUB_GUACAMOLE.$HOMESERVER_DOMAIN" "guacamole.png" "$(getHeimdallOrderFromSub $SUB_GUACAMOLE $USERTYPE_GUACAMOLE)"
    restartAllCaddyContainers
  fi
}

function outputConfigGuacamole()
{
  cat <<EOFGC > $HOME/guacamole-compose-tmp.yml

services:
  guacamole-db:
    image: $(getScriptImageByContainerName guacamole-db)
    container_name: guacamole-db
    hostname: guacamole-db
    user: "$USERID"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-guacamole-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - $HSHQ_STACKS_DIR/guacamole/db:/var/lib/mysql
      - $HSHQ_STACKS_DIR/guacamole/init:/docker-entrypoint-initdb.d:ro
    environment:
      - MYSQL_ROOT_PASSWORD=$GUACAMOLE_DATABASE_ROOT_PASSWORD
      - MYSQL_DATABASE=$GUACAMOLE_DATABASE_NAME
      - MYSQL_USER=$GUACAMOLE_DATABASE_USER
      - MYSQL_PASSWORD=$GUACAMOLE_DATABASE_USER_PASSWORD

networks:
  int-guacamole-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFGC

  cat <<EOFGC > $HOME/guacamole-compose.yml
$STACK_VERSION_PREFIX guacamole $(getScriptStackVersion guacamole)

services:
  guacamole-db:
    image: $(getScriptImageByContainerName guacamole-db)
    container_name: guacamole-db
    hostname: guacamole-db
    user: \${UID}
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-guacamole-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/guacamole/db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/guacamole/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.guacamole-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.guacamole-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.guacamole-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.guacamole-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.guacamole-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.guacamole-hourly-db.email-from=Guacamole Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.guacamole-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.guacamole-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.guacamole-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.guacamole-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.guacamole-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.guacamole-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.guacamole-monthly-db.email-from=Guacamole Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.guacamole-monthly-db.mail-only-on-error=false"

  guacamole-daemon:
    image: $(getScriptImageByContainerName guacamole-daemon)
    container_name: guacamole-daemon
    hostname: guacamole-daemon
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-guacamole-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  guacamole-web:
    image: $(getScriptImageByContainerName guacamole-web)
    container_name: guacamole-web
    hostname: guacamole-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - guacamole-db
      - guacamole-daemon
    networks:
      - int-guacamole-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-guacamole-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFGC

  cat <<EOFGC > $HOME/guacamole.env
UID=$USERID
GID=$GROUPID
GUACD_HOSTNAME=guacamole-daemon
MYSQL_HOSTNAME=guacamole-db
MYSQL_DATABASE=$GUACAMOLE_DATABASE_NAME
MYSQL_USER=$GUACAMOLE_DATABASE_USER
MYSQL_PASSWORD=$GUACAMOLE_DATABASE_USER_PASSWORD
EOFGC

}

function performUpdateGuacamole()
{
  perform_stack_name=guacamole
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=guacamole/guacd:1.5.3,guacamole/guacamole:1.5.3
      image_update_map[0]="guacamole/guacd:1.5.3,guacamole/guacd:1.5.5"
      image_update_map[1]="guacamole/guacamole:1.5.3,guacamole/guacamole:1.5.5"
    ;;
    2)
      newVer=v3
      curImageList=guacamole/guacd:1.5.4,guacamole/guacamole:1.5.4
      image_update_map[0]="guacamole/guacd:1.5.4,guacamole/guacd:1.5.5"
      image_update_map[1]="guacamole/guacamole:1.5.4,guacamole/guacamole:1.5.5"
    ;;
    3)
      newVer=v3
      curImageList=guacamole/guacd:1.5.5,guacamole/guacamole:1.5.5
      image_update_map[0]="guacamole/guacd:1.5.5,guacamole/guacd:1.5.5"
      image_update_map[1]="guacamole/guacamole:1.5.5,guacamole/guacamole:1.5.5"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Authelia
function installAuthelia()
{
  set +e
  is_integrate_hshq=$1
  # Exit if directory exists
  checkDeleteStackAndDirectory authelia "Authelia"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Authelia directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName authelia)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Authelia docker image"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName authelia-redis)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Authelia Redis docker image"
    exit 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/authelia
  mkdir $HSHQ_STACKS_DIR/authelia/config
  mkdir $HSHQ_STACKS_DIR/authelia/config/certs
  mkdir $HSHQ_STACKS_DIR/authelia/config/cacerts
  mkdir $HSHQ_STACKS_DIR/authelia/config/secrets
  mkdir $HSHQ_STACKS_DIR/authelia/keys

  if [ -z "$AUTHELIA_REDIRECTION_URL" ]; then
    AUTHELIA_REDIRECTION_URL=$SUB_HSHQHOME.$HOMESERVER_DOMAIN
    updateConfigVar AUTHELIA_REDIRECTION_URL $AUTHELIA_REDIRECTION_URL
  fi
  AUTHELIA_JWT_SECRET=$(pwgen -c -n 32 1)
  rm -f "$HSHQ_SECRETS_DIR/authelia_jwt_secret.txt"
  echo "$AUTHELIA_JWT_SECRET" > "$HSHQ_SECRETS_DIR/authelia_jwt_secret.txt"
  chmod 0400 "$HSHQ_SECRETS_DIR/authelia_jwt_secret.txt"
  AUTHELIA_SESSION_SECRET=$(pwgen -c -n 64 1)
  rm -f "$HSHQ_SECRETS_DIR/authelia_session_secret.txt"
  echo "$AUTHELIA_SESSION_SECRET" > "$HSHQ_SECRETS_DIR/authelia_session_secret.txt"
  chmod 0400 "$HSHQ_SECRETS_DIR/authelia_session_secret.txt"
  AUTHELIA_STORAGE_ENCRYPTION_KEY=$(pwgen -c -n 64 1)
  rm -f "$HSHQ_SECRETS_DIR/authelia_storage_encryption_key.txt"
  echo "$AUTHELIA_STORAGE_ENCRYPTION_KEY" > "$HSHQ_SECRETS_DIR/authelia_storage_encryption_key.txt"
  chmod 0400 "$HSHQ_SECRETS_DIR/authelia_storage_encryption_key.txt"
  AUTHELIA_REDIS_PASSWORD=$(pwgen -c -n 64 1)
  rm -f "$HSHQ_SECRETS_DIR/authelia_redis_password.txt"
  echo "$AUTHELIA_REDIS_PASSWORD" > "$HSHQ_SECRETS_DIR/authelia_redis_password.txt"
  chmod 0400 "$HSHQ_SECRETS_DIR/authelia_redis_password.txt"
  outputAutheliaIDPSecretsV108

  generateCert authelia authelia
  generateCert authelia-redis authelia-redis
  outputConfigAuthelia
  installStack authelia authelia "Listening for TLS connections on" $HOME/authelia.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Authelia"
    exit $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://authelia:9091 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_AUTHELIA $MANAGETLS_AUTHELIA "$is_integrate_hshq" $NETDEFAULT_AUTHELIA "$inner_block"
}

function outputConfigAuthelia()
{
  cat <<EOFAC > $HOME/authelia-compose.yml
$STACK_VERSION_PREFIX authelia $(getScriptStackVersion authelia)

services:
  authelia:
    image: $(getScriptImageByContainerName authelia)
    container_name: authelia
    hostname: authelia
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    security_opt:
      - no-new-privileges:true
    networks:
      - int-authelia-net
      - dock-proxy-net
      - dock-privateip-net
      - dock-ldap-net
      - dock-internalmail-net
    depends_on:
      - authelia-redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/config/cacerts/${CERTS_ROOT_CA_NAME}.crt:ro
      - \${HSHQ_STACKS_DIR}/authelia/config:/config
      - \${HSHQ_STACKS_DIR}/authelia/keys:/keys
      - \${HSHQ_SSL_DIR}/authelia.crt:/config/certs/authelia.crt
      - \${HSHQ_SSL_DIR}/authelia.key:/config/certs/authelia.key
    secrets:
      - authelia_jwt_secret
      - authelia_session_secret
      - authelia_storage_encryption_key
      - ldap_admin_user_password
      - authelia_redis_password

  authelia-redis:
    image: $(getScriptImageByContainerName authelia-redis)
    container_name: authelia-redis
    hostname: authelia-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-authelia-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/tls/${CERTS_ROOT_CA_NAME}.crt:ro
      - \${HSHQ_SSL_DIR}/authelia-redis.crt:/tls/authelia-redis.crt:ro
      - \${HSHQ_SSL_DIR}/authelia-redis.key:/tls/authelia-redis.key:ro
      - \${HSHQ_SSL_DIR}/dhparam.pem:/tls/dhparam.pem:ro
    environment:
      - REDIS_PASSWORD=$(cat $HSHQ_SECRETS_DIR/authelia_redis_password.txt)

secrets:
  authelia_jwt_secret:
    file: \${HSHQ_SECRETS_DIR}/authelia_jwt_secret.txt
  authelia_session_secret:
    file: \${HSHQ_SECRETS_DIR}/authelia_session_secret.txt
  authelia_storage_encryption_key:
    file: \${HSHQ_SECRETS_DIR}/authelia_storage_encryption_key.txt
  ldap_admin_user_password:
    file: \${HSHQ_SECRETS_DIR}/ldap_admin_bind_password.txt
  authelia_redis_password:
    file: \${HSHQ_SECRETS_DIR}/authelia_redis_password.txt

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-authelia-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFAC

  cat <<EOFAE > $HOME/authelia.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE=/run/secrets/authelia_jwt_secret
AUTHELIA_SESSION_SECRET_FILE=/run/secrets/authelia_session_secret
AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE=/run/secrets/authelia_storage_encryption_key
AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD_FILE=/run/secrets/ldap_admin_user_password
AUTHELIA_SESSION_REDIS_PASSWORD_FILE=/run/secrets/authelia_redis_password
ALLOW_EMPTY_PASSWORD=no
REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
REDIS_AOF_ENABLED=no
REDIS_TLS_ENABLED=yes
REDIS_TLS_PORT=6379
REDIS_TLS_CERT_FILE=/tls/authelia-redis.crt
REDIS_TLS_KEY_FILE=/tls/authelia-redis.key
REDIS_TLS_CA_FILE=/tls/${CERTS_ROOT_CA_NAME}.crt
REDIS_TLS_DH_PARAMS_FILE=/tls/dhparam.pem
REDIS_TLS_AUTH_CLIENTS=no
X_AUTHELIA_CONFIG_FILTERS=template
EOFAE

  cat <<EOFAC > $HSHQ_STACKS_DIR/authelia/config/configuration.yml
# yamllint disable rule:comments-indentation
---
###############################################################################
#                           Authelia Configuration                            #
###############################################################################

theme: dark

certificates_directory: /config/cacerts/

server:
  address: 'tcp://:9091/'
  disable_healthcheck: true
  tls:
    key: /config/certs/authelia.key
    certificate: /config/certs/authelia.crt
  endpoints:
    enable_pprof: false
    enable_expvars: false

log:
  level: info

totp:
  disable: false
  issuer: "$HOMESERVER_NAME"
  digits: 6
  period: 30
  skew: 1

webauthn:
  disable: false
  timeout: 60s
  display_name: "$HOMESERVER_NAME"
  attestation_conveyance_preference: indirect
  selection_criteria:
    user_verification: preferred

duo_api:
  disable: true

authentication_backend:
  password_reset:
    disable: true
  refresh_interval: 5m
  ldap:
    address: $LDAP_URI
    implementation: custom
    timeout: 5s
    start_tls: true
    tls:
      server_name: ldapserver
      skip_verify: false
      minimum_version: TLS1.2
    base_dn: $LDAP_BASE_DN
    additional_users_dn: ou=people
    users_filter: (&(&({username_attribute}={input})(objectClass=person))(memberOf=cn=everybody,ou=groups,$LDAP_BASE_DN))
    additional_groups_dn: ou=groups
    groups_filter: (&(uniquemember={dn})(objectClass=groupOfUniqueNames))
    group_search_mode: filter
    permit_referrals: false
    permit_unauthenticated_bind: false
    user: $LDAP_ADMIN_BIND_DN
    attributes:
      distinguished_name: cn
      username: uid
      display_name: cn
      mail: mail
      member_of: memberOf
      group_name: cn

#AC_BEGIN
#AC_END

session:
  name: authelia
  same_site: lax
  inactivity: 21600
  expiration: 43200
  remember_me: 21600
  cookies:
# Authelia session cookies BEGIN
    - domain: $HOMESERVER_DOMAIN
      authelia_url: https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
      default_redirection_url: https://$AUTHELIA_REDIRECTION_URL
      name: authelia
      same_site: lax
      inactivity: 21600
      expiration: 43200
      remember_me: 21600
# Authelia session cookies END
  redis:
    host: authelia-redis
    port: 6379
    maximum_active_connections: 8
    tls:
      server_name: authelia-redis
      skip_verify: false
      minimum_version: TLS1.2

regulation:
  max_retries: 5
  find_time: 10m
  ban_time: 10m

storage:
  local:
    path: /config/db.sqlite3

ntp:
  address: udp://${NET_PRIVATEIP_SUBNET_PREFIX}.1:123
  version: 3
  max_desync: 3s
  disable_startup_check: false
  disable_failure: false

notifier:
  disable_startup_check: true
  smtp:
    address: smtp://${SMTP_HOSTNAME}:${SMTP_HOSTPORT}
    sender: "Authelia $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>"
    identifier: localhost
    subject: "[Authelia] {title}"
    startup_check_address: $EMAIL_ADMIN_EMAIL_ADDRESS
    disable_require_tls: false
    disable_html_emails: false
    tls:
      skip_verify: false
      minimum_version: TLS1.2

identity_providers:
  oidc:
    authorization_policies:
      everyone_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:everyone
      ${LDAP_BASIC_USER_GROUP_NAME}_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:$LDAP_BASIC_USER_GROUP_NAME
      ${LDAP_PRIMARY_USER_GROUP_NAME}_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:${LDAP_PRIMARY_USER_GROUP_NAME}
      adminusers_auth:
        default_policy: deny
        rules:
          - policy: one_factor
            subject: group:${LDAP_ADMIN_USER_GROUP_NAME}
    hmac_secret: |
      {{- fileContent "/config/secrets/authelia_identity_providers_oidc_hmac_secret.txt" | nindent 6 }}
    jwks:
      - key: |
        {{- fileContent "/config/secrets/jwks-key.pem" | nindent 10 }}
    clients:
# Authelia OIDC Clients BEGIN
# Authelia OIDC Client default BEGIN
      - client_id: default
        client_name: Default
        client_secret: '$(htpasswd -bnBC 10 "" $(pwgen -c -n 64 1) | cut -d":" -f2)'
        public: false
        authorization_policy: two_factor
        redirect_uris:
          - https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN
# Authelia OIDC Client default END
# Authelia OIDC Clients END
...
EOFAC

  set +e
  replaceTextBlockInFile "#AC_BEGIN" "#AC_END" "$(getAutheliaBlock)" $HSHQ_STACKS_DIR/authelia/config/configuration.yml true
  set -e
}

function performUpdateAuthelia()
{
  perform_stack_name=authelia
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=authelia/authelia:4.37.5,bitnami/redis:7.0.5
      image_update_map[0]="authelia/authelia:4.37.5,authelia/authelia:4.38.2"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfUpdateAutheliaConfig
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v5
      curImageList=authelia/authelia:4.38.2,bitnami/redis:7.0.5
      image_update_map[0]="authelia/authelia:4.38.2,authelia/authelia:4.39.1"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    3)
      newVer=v5
      curImageList=authelia/authelia:4.38.9,bitnami/redis:7.0.5
      image_update_map[0]="authelia/authelia:4.38.9,authelia/authelia:4.39.1"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    4)
      newVer=v5
      curImageList=authelia/authelia:4.38.17,bitnami/redis:7.0.5
      image_update_map[0]="authelia/authelia:4.38.17,authelia/authelia:4.39.1"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAutheliaFixConfigV133 false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    5)
      newVer=v5
      curImageList=authelia/authelia:4.39.1,bitnami/redis:7.4.2
      image_update_map[0]="authelia/authelia:4.39.1,authelia/authelia:4.39.1"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAutheliaFixConfigV133 false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfUpdateAutheliaConfig()
{
  configfile=$HSHQ_STACKS_DIR/authelia/config/configuration.yml
  acblock="$(sed -n "/#AC_BEGIN/,/#AC_END/p" $configfile | sed '1d' | sed '$d')"
  outputConfigAuthelia
  replaceTextBlockInFile "#AC_BEGIN" "#AC_END" "$acblock" $configfile true
  rm -f $HOME/authelia.env
  cat <<EOFAE > $HOME/authelia.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
AUTHELIA_IDENTITY_VALIDATION_RESET_PASSWORD_JWT_SECRET_FILE=/run/secrets/authelia_jwt_secret
AUTHELIA_SESSION_SECRET_FILE=/run/secrets/authelia_session_secret
AUTHELIA_STORAGE_ENCRYPTION_KEY_FILE=/run/secrets/authelia_storage_encryption_key
AUTHELIA_AUTHENTICATION_BACKEND_LDAP_PASSWORD_FILE=/run/secrets/ldap_admin_user_password
AUTHELIA_SESSION_REDIS_PASSWORD_FILE=/run/secrets/authelia_redis_password
ALLOW_EMPTY_PASSWORD=no
REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
REDIS_AOF_ENABLED=no
REDIS_TLS_ENABLED=yes
REDIS_TLS_PORT=6379
REDIS_TLS_CERT_FILE=/tls/authelia-redis.crt
REDIS_TLS_KEY_FILE=/tls/authelia-redis.key
REDIS_TLS_CA_FILE=/tls/${CERTS_ROOT_CA_NAME}.crt
REDIS_TLS_DH_PARAMS_FILE=/tls/dhparam.pem
REDIS_TLS_AUTH_CLIENTS=no
EOFAE
  set +e
  docker ps | grep codeserver > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker container restart codeserver > /dev/null 2>&1
  fi
}

function mfAutheliaFixConfigV133()
{
  set +e
  grep "selection_criteria:" $HSHQ_STACKS_DIR/authelia/config/configuration.yml > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sed -i "s/user_verification:.*/selection_criteria:\n    user_verification: preferred/" $HSHQ_STACKS_DIR/authelia/config/configuration.yml 
  fi
}

function outputAutheliaIDPSecretsV108()
{
  mkdir -p $HSHQ_STACKS_DIR/authelia/config/secrets
  if ! [ -f $HSHQ_STACKS_DIR/authelia/config/secrets/authelia_identity_providers_oidc_hmac_secret.txt ]; then
    echo "$(pwgen -c -n 64 1)" > $HSHQ_STACKS_DIR/authelia/config/secrets/authelia_identity_providers_oidc_hmac_secret.txt
    chmod 0400 $HSHQ_STACKS_DIR/authelia/config/secrets/authelia_identity_providers_oidc_hmac_secret.txt
  fi
  if ! [ -f $HSHQ_STACKS_DIR/authelia/config/secrets/jwks-key.pem ]; then
    openssl genrsa -out $HSHQ_STACKS_DIR/authelia/config/secrets/jwks-key.pem 2048
  fi
}

# WordPress
function installWordPress()
{
  set +e
  is_integrate_hshq=$1
  # Check if directory exists
  checkDeleteStackAndDirectory wordpress "WordPress"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wordpress-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wordpress-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/wordpress
  mkdir $HSHQ_STACKS_DIR/wordpress/db
  mkdir $HSHQ_STACKS_DIR/wordpress/dbexport
  mkdir $HSHQ_STACKS_DIR/wordpress/web
  chmod 777 $HSHQ_STACKS_DIR/wordpress/dbexport

  initServicesCredentials
  outputConfigWordPress
  installStack wordpress wordpress-web "WordPress" $HOME/wordpress.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_WORDPRESS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>@insecureadmin {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_NOTHOMESUBNET\n"
  inner_block=$inner_block">>>>>>>>path /wp-login.php*\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>redir @insecureadmin /\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://wordpress-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_WORDPRESS $MANAGETLS_WORDPRESS "$is_integrate_hshq" $NETDEFAULT_WORDPRESS "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll wordpress "$FMLNAME_WORDPRESS" $USERTYPE_WORDPRESS "https://$SUB_WORDPRESS.$HOMESERVER_DOMAIN" "wordpress.png" "$(getHeimdallOrderFromSub $SUB_WORDPRESS $USERTYPE_WORDPRESS)"
    restartAllCaddyContainers
  fi
}

function outputConfigWordPress()
{
  cat <<EOFWP > $HOME/wordpress-compose.yml
$STACK_VERSION_PREFIX wordpress $(getScriptStackVersion wordpress)

services:
  wordpress-db:
    image: $(getScriptImageByContainerName wordpress-db)
    container_name: wordpress-db
    hostname: wordpress-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-wordpress-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-wordpress-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/wordpress/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.wordpress-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.wordpress-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wordpress-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wordpress-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wordpress-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wordpress-hourly-db.email-from=WordPress Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wordpress-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.wordpress-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.wordpress-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wordpress-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wordpress-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wordpress-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wordpress-monthly-db.email-from=WordPress Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wordpress-monthly-db.mail-only-on-error=false"

  wordpress-web:
    image: $(getScriptImageByContainerName wordpress-web)
    container_name: wordpress-web
    hostname: wordpress-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-wordpress-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-wordpress-web:/var/www/html

volumes:
  v-wordpress-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wordpress/db
  v-wordpress-web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/wordpress/web

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-wordpress-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFWP

  cat <<EOFWP > $HOME/wordpress.env
MYSQL_ROOT_PASSWORD=$WORDPRESS_DATABASE_ROOT_PASSWORD
MYSQL_DATABASE=$WORDPRESS_DATABASE_NAME
MYSQL_USER=$WORDPRESS_DATABASE_USER
MYSQL_PASSWORD=$WORDPRESS_DATABASE_USER_PASSWORD
WORDPRESS_DB_HOST=wordpress-db
WORDPRESS_DB_NAME=$WORDPRESS_DATABASE_NAME
WORDPRESS_DB_USER=$WORDPRESS_DATABASE_USER
WORDPRESS_DB_PASSWORD=$WORDPRESS_DATABASE_USER_PASSWORD
EOFWP
}

function performUpdateWordPress()
{
  perform_stack_name=wordpress
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=mariadb:10.7.3,wordpress:php8.2-apache
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="wordpress:php8.2-apache,wordpress:php8.3-apache"
    ;;
    2)
      newVer=v2
      curImageList=mariadb:10.7.3,wordpress:php8.3-apache
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="wordpress:php8.3-apache,wordpress:php8.3-apache"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Ghost
function installGhost()
{
  set +e
  is_integrate_hshq=$1
  # Have to check if directory exits
  checkDeleteStackAndDirectory ghost "Ghost"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName ghost-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName ghost-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/ghost
  mkdir $HSHQ_STACKS_DIR/ghost/db
  mkdir $HSHQ_STACKS_DIR/ghost/dbexport
  mkdir $HSHQ_STACKS_DIR/ghost/web
  chmod 777 $HSHQ_STACKS_DIR/ghost/dbexport
  initServicesCredentials
  if [ -z "$GHOST_DATABASE_ROOT_PASSWORD" ]; then
    GHOST_DATABASE_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GHOST_DATABASE_ROOT_PASSWORD $GHOST_DATABASE_ROOT_PASSWORD
  fi

  outputConfigGhost
  installStack ghost ghost-web "Ghost booted in" $HOME/ghost.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_GHOST.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>@insecureadmin {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_NOTHOMESUBNET\n"
  inner_block=$inner_block">>>>>>>>path /ghost/*\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://ghost-web:2368 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GHOST $MANAGETLS_GHOST "$is_integrate_hshq" $NETDEFAULT_GHOST "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll ghost "$FMLNAME_GHOST" $USERTYPE_GHOST "https://$SUB_GHOST.$HOMESERVER_DOMAIN" "ghost.png" "$(getHeimdallOrderFromSub $SUB_GHOST $USERTYPE_GHOST)"
    restartAllCaddyContainers
  fi
}

function outputConfigGhost()
{
  cat <<EOFGW > $HOME/ghost-compose.yml
$STACK_VERSION_PREFIX ghost $(getScriptStackVersion ghost)

services:
  ghost-db:
    image: $(getScriptImageByContainerName ghost-db)
    container_name: ghost-db
    hostname: ghost-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-ghost-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-ghost-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/ghost/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.ghost-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.ghost-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.ghost-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.ghost-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.ghost-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.ghost-hourly-db.email-from=Ghost Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.ghost-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.ghost-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.ghost-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.ghost-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.ghost-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.ghost-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.ghost-monthly-db.email-from=Ghost Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.ghost-monthly-db.mail-only-on-error=false"

  ghost-web:
    image: $(getScriptImageByContainerName ghost-web)
    container_name: ghost-web
    hostname: ghost-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - ghost-db
    networks:
      - int-ghost-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-ghost-web:/var/lib/ghost/content

volumes:
  v-ghost-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/ghost/db
  v-ghost-web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/ghost/web

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-ghost-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFGW

  cat <<EOFGW > $HOME/ghost.env
MYSQL_DATABASE=$GHOST_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$GHOST_DATABASE_ROOT_PASSWORD
MYSQL_USER=$GHOST_DATABASE_USER
MYSQL_PASSWORD=$GHOST_DATABASE_USER_PASSWORD
database__client=mysql
database__connection__host=ghost-db
database__connection__database=$GHOST_DATABASE_NAME
database__connection__user=$GHOST_DATABASE_USER
database__connection__password=$GHOST_DATABASE_USER_PASSWORD
url=https://$SUB_GHOST.$HOMESERVER_DOMAIN
NODE_ENV=development
EOFGW
}

function performUpdateGhost()
{
  perform_stack_name=ghost
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=mariadb:10.7.3,ghost:5.59.1-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.59.1-alpine,ghost:5.88.2-alpine"
    ;;
    2)
      newVer=v5
      curImageList=mariadb:10.7.3,ghost:5.75.2-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.75.2-alpine,ghost:5.88.2-alpine"
    ;;
    3)
      newVer=v5
      curImageList=mariadb:10.7.3,ghost:5.78.0-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.78.0-alpine,ghost:5.88.2-alpine"
    ;;
    4)
      newVer=v5
      curImageList=mariadb:10.7.3,ghost:5.80.3-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.80.3-alpine,ghost:5.88.2-alpine"
    ;;
    5)
      newVer=v7
      curImageList=mariadb:10.7.3,ghost:5.88.2-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.88.2-alpine,ghost:5.115.1-alpine"
    ;;
    6)
      newVer=v7
      curImageList=mariadb:10.7.3,ghost:5.98.1-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.98.1-alpine,ghost:5.115.1-alpine"
    ;;
    7)
      newVer=v7
      curImageList=mariadb:10.7.3,ghost:5.115.1-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="ghost:5.115.1-alpine,ghost:5.115.1-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# PeerTube
function installPeerTube()
{
  set +e
  is_integrate_hshq=$1
  # Evaulate whether directory exists
  checkDeleteStackAndDirectory peertube "PeerTube"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName peertube-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName peertube-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName peertube-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/peertube
  mkdir $HSHQ_STACKS_DIR/peertube/config
  mkdir $HSHQ_STACKS_DIR/peertube/db
  mkdir $HSHQ_STACKS_DIR/peertube/dbexport
  mkdir $HSHQ_STACKS_DIR/peertube/data
  chmod 777 $HSHQ_STACKS_DIR/peertube/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/peertube
  mkdir $HSHQ_NONBACKUP_DIR/peertube/assets
  mkdir $HSHQ_NONBACKUP_DIR/peertube/redis

  initServicesCredentials

  pt_secret=$(openssl rand -hex 32)
  set +e
  docker exec mailu-admin flask mailu alias-delete $PEERTUBE_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $ADMIN_USERNAME_BASE"_peertube" $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  outputConfigPeerTube
  installStack peertube peertube-app "HTTP server listening on 0.0.0.0" $HOME/peertube.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  docker exec peertube-app bash -c "echo $PEERTUBE_ADMIN_PASSWORD | npm run reset-password -- -u root" > /dev/null
  echo "Installing plugins..."
  set +e
  docker exec -u 999 peertube-app bash -c "timeout 60 npm run plugin:install -- --npm-name peertube-plugin-auth-ldap" > /dev/null
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not install LDAP plugin, exiting..."
    return 2
  fi
  docker exec -u 999 peertube-app bash -c "timeout 60 npm run plugin:install -- --npm-name peertube-plugin-livechat" > /dev/null
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not install LiveChat plugin, continuing..."
  fi
  docker exec -u 999 peertube-app bash -c "timeout 60 npm run plugin:install -- --npm-name peertube-theme-dark" > /dev/null
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not install Dark Theme plugin, continuing..."
  fi
  set -e
  docker exec peertube-db /dbexport/setupLDAP.sh
  rm -f $HSHQ_STACKS_DIR/peertube/dbexport/setupLDAP.sh
  docker container restart peertube-app

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://peertube-app:9000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PEERTUBE $MANAGETLS_PEERTUBE "$is_integrate_hshq" $NETDEFAULT_PEERTUBE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll peertube "$FMLNAME_PEERTUBE" $USERTYPE_PEERTUBE "https://$SUB_PEERTUBE.$HOMESERVER_DOMAIN" "peertube.png" "$(getHeimdallOrderFromSub $SUB_PEERTUBE $USERTYPE_PEERTUBE)"
    restartAllCaddyContainers
  fi
}

function outputConfigPeerTube()
{
  cat <<EOFPT > $HOME/peertube-compose.yml
$STACK_VERSION_PREFIX peertube $(getScriptStackVersion peertube)

services:
  peertube-db:
    image: $(getScriptImageByContainerName peertube-db)
    container_name: peertube-db
    hostname: peertube-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    depends_on:
      - peertube-redis
    networks:
      - int-peertube-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/peertube/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/peertube/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.peertube-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.peertube-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.peertube-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.peertube-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.peertube-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.peertube-hourly-db.email-from=PeerTube Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.peertube-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.peertube-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.peertube-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.peertube-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.peertube-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.peertube-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.peertube-monthly-db.email-from=PeerTube Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.peertube-monthly-db.mail-only-on-error=false"

  peertube-app:
    image: $(getScriptImageByContainerName peertube-app)
    container_name: peertube-app
    hostname: peertube-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-peertube-net
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
      - dock-internalmail-net
    ports:
      - "$PEERTUBE_RDP_PORT:$PEERTUBE_RDP_PORT"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/peertube/data:/data
      - \${HSHQ_STACKS_DIR}/peertube/config:/config
      - v-peertube-assets:/app/client/dist
    environment:
      - PEERTUBE_TRUST_PROXY=["127.0.0.1", "loopback", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]

  peertube-redis:
    image: $(getScriptImageByContainerName peertube-redis)
    container_name: peertube-redis
    hostname: peertube-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-peertube-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-peertube-redis:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=yes

volumes:
  v-peertube-assets:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/peertube/assets
  v-peertube-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/peertube/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-peertube-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFPT

  cat <<EOFPT > $HOME/peertube.env
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$PEERTUBE_DATABASE_NAME
POSTGRES_USER=$PEERTUBE_DATABASE_USER
POSTGRES_PASSWORD=$PEERTUBE_DATABASE_USER_PASSWORD
PEERTUBE_DB_SUFFIX=db
PEERTUBE_DB_HOSTNAME=peertube-db
PEERTUBE_DB_USERNAME=$PEERTUBE_DATABASE_USER
PEERTUBE_DB_PASSWORD=$PEERTUBE_DATABASE_USER_PASSWORD
PEERTUBE_DB_SSL=false
PEERTUBE_SECRET=$pt_secret
PEERTUBE_WEBSERVER_HOSTNAME=$SUB_PEERTUBE.$HOMESERVER_DOMAIN
PEERTUBE_WEBSERVER_PORT=443
PEERTUBE_WEBSERVER_HTTPS=true
PEERTUBE_SMTP_HOSTNAME=$SMTP_HOSTNAME
PEERTUBE_SMTP_PORT=$SMTP_HOSTPORT
PEERTUBE_SMTP_FROM=$EMAIL_ADMIN_EMAIL_ADDRESS
PEERTUBE_SMTP_TLS=false
PEERTUBE_SMTP_DISABLE_STARTTLS=false
PEERTUBE_ADMIN_EMAIL=$PEERTUBE_ADMIN_EMAIL_ADDRESS
PEERTUBE_REDIS_HOSTNAME=peertube-redis
PEERTUBE_REDIS_PORT=6379
EOFPT

  cat <<EOFPT > $HSHQ_STACKS_DIR/peertube/config/production.yaml
smtp:
  ca_file: /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
theme:
  default: 'dark'
EOFPT

  cat <<EOFPT > $HSHQ_STACKS_DIR/peertube/dbexport/setupLDAP.sh
#!/bin/bash

PGPASSWORD=$PEERTUBE_DATABASE_USER_PASSWORD
sqlcmd="update plugin set settings='{\"url\": \"ldaps://ldapserver:636\",\"weight\": 100,\"bind-dn\": \"$LDAP_READONLY_USER_BIND_DN\",\"custom-ca\": \"/usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt\",\"group-mod\": \"\",\"group-base\": \"\",\"group-user\": \"\",\"group-admin\": \"\",\"search-base\": \"$LDAP_BASE_DN\",\"group-filter\": \"\",\"insecure-tls\": false,\"mail-property\": \"mail\",\"search-filter\": \"(&(|(mail={{username}})(uid={{username}}))(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))\",\"bind-credentials\": \"$LDAP_READONLY_USER_PASSWORD\",\"username-property\": \"uid\",\"mail-property-index\": \"0\"}' where name='auth-ldap';"
echo "\$sqlcmd" | psql -U $PEERTUBE_DATABASE_USER $PEERTUBE_DATABASE_NAME
EOFPT

  chmod +x $HSHQ_STACKS_DIR/peertube/dbexport/setupLDAP.sh
}

function performUpdatePeerTube()
{
  perform_stack_name=peertube
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v5.2.0-bullseye,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v5.2.0-bullseye,chocobozzz/peertube:v6.2.0-bookworm"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    2)
      newVer=v6
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v6.0.2-bookworm,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v6.0.2-bookworm,chocobozzz/peertube:v7.1.0-bookworm"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    3)
      newVer=v6
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v6.0.3-bookworm,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v6.0.3-bookworm,chocobozzz/peertube:v7.1.0-bookworm"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    4)
      newVer=v6
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v6.2.0-bookworm,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v6.2.0-bookworm,chocobozzz/peertube:v7.1.0-bookworm"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v6.3.3-bookworm,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v6.3.3-bookworm,chocobozzz/peertube:v7.1.0-bookworm"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    6)
      newVer=v6
      curImageList=postgres:15.0-bullseye,chocobozzz/peertube:v7.1.0-bookworm,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="chocobozzz/peertube:v7.1.0-bookworm,chocobozzz/peertube:v7.1.0-bookworm"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# HomeAssistant
function installHomeAssistant()
{
  set +e
  is_integrate_hshq=$1
  # Evaulate whether directory exists
  checkDeleteStackAndDirectory homeassistant "HomeAssistant"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homeassistant-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homeassistant-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homeassistant-nodered)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homeassistant-configurator)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homeassistant-tasmoadmin)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/homeassistant
  mkdir $HSHQ_STACKS_DIR/homeassistant/config
  mkdir $HSHQ_STACKS_DIR/homeassistant/config/www
  mkdir $HSHQ_STACKS_DIR/homeassistant/config/www/images
  mkdir $HSHQ_STACKS_DIR/homeassistant/config/www/plugins
  mkdir $HSHQ_STACKS_DIR/homeassistant/config/www/themes
  mkdir $HSHQ_STACKS_DIR/homeassistant/config/www/panels
  mkdir $HSHQ_STACKS_DIR/homeassistant/configurator
  mkdir $HSHQ_STACKS_DIR/homeassistant/db
  mkdir $HSHQ_STACKS_DIR/homeassistant/dbexport
  mkdir $HSHQ_STACKS_DIR/homeassistant/media
  mkdir $HSHQ_STACKS_DIR/homeassistant/nodered
  chmod 777 $HSHQ_STACKS_DIR/homeassistant/dbexport
  sudo chown 1000:1000 $HSHQ_STACKS_DIR/homeassistant/nodered

  initServicesCredentials
  generateCert homeassistant-app "homeassistant-app,host.docker.internal"
  generateCert homeassistant-configurator homeassistant-configurator
  generateCert homeassistant-nodered homeassistant-nodered
  outputConfigHomeAssistant

  # Ensure NodeRed data directory and settings file permissions are set to 1000:1000
  sudo chown 1000:1000 $HOME/noderedsettings.conf
  sudo mv $HOME/noderedsettings.conf $HSHQ_STACKS_DIR/homeassistant/nodered/settings.js

  installStack homeassistant homeassistant-app "legacy-services successfully started" $HOME/homeassistant.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Waiting 10 seconds for HomeAssistant to load"
  sleep 10
  docker container stop homeassistant-app
  sudo mv $HSHQ_STACKS_DIR/homeassistant/configuration.yaml $HSHQ_STACKS_DIR/homeassistant/config/configuration.yaml
  docker container start homeassistant-app

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://host.docker.internal:$HOMEASSISTANT_LOCALHOST_PORT {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HOMEASSISTANT_APP $MANAGETLS_HOMEASSISTANT_APP "$is_integrate_hshq" $NETDEFAULT_HOMEASSISTANT_APP "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HOMEASSISTANT_CONFIGURATOR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://homeassistant-configurator {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HOMEASSISTANT_CONFIGURATOR $MANAGETLS_HOMEASSISTANT_CONFIGURATOR "$is_integrate_hshq" $NETDEFAULT_HOMEASSISTANT_CONFIGURATOR "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HOMEASSISTANT_NODERED.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://homeassistant-nodered {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HOMEASSISTANT_NODERED $MANAGETLS_HOMEASSISTANT_NODERED "$is_integrate_hshq" $NETDEFAULT_HOMEASSISTANT_NODERED "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://homeassistant-tasmoadmin {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HOMEASSISTANT_TASMOADMIN $MANAGETLS_HOMEASSISTANT_TASMOADMIN "$is_integrate_hshq" $NETDEFAULT_HOMEASSISTANT_TASMOADMIN "$inner_block"

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll homeassistant "$FMLNAME_HOMEASSISTANT_APP" $USERTYPE_HOMEASSISTANT_APP "https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN" "homeassistant.png" "$(getHeimdallOrderFromSub $SUB_HOMEASSISTANT_APP $USERTYPE_HOMEASSISTANT_APP)"
    insertEnableSvcUptimeKuma homeassistant "$FMLNAME_HOMEASSISTANT_NODERED" $USERTYPE_HOMEASSISTANT_NODERED "https://$SUB_HOMEASSISTANT_NODERED.$HOMESERVER_DOMAIN" true
    insertEnableSvcUptimeKuma homeassistant "$FMLNAME_HOMEASSISTANT_TASMOADMIN" $USERTYPE_HOMEASSISTANT_TASMOADMIN "https://$SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN" true
    restartAllCaddyContainers
  fi
}

function outputConfigHomeAssistant()
{
  outputComposeHomeAssistant
  cat <<EOFHA > $HOME/homeassistant.env
UID=$USERID
GID=$GROUPID
PYTHON_VER=python3.13
EOFHA

  cat <<EOFCF > $HSHQ_STACKS_DIR/homeassistant/configurator/settings.conf
{
    "PORT": 443,
    "BASEPATH": "/hass-config",
    "HASS_API": "",
    "USERNAME": "$HOMEASSISTANT_CONFIGURATOR_USER",
    "PASSWORD": "{sha256}$(echo -n $HOMEASSISTANT_CONFIGURATOR_USER_PASSWORD | openssl dgst -sha256 | cut -d"=" -f2 | xargs)",
    "SSL_CERTIFICATE": "/certs/homeassistant-configurator.crt",
    "SSL_KEY": "/certs/homeassistant-configurator.key"
}
EOFCF

  cat <<EOFCF > $HOME/noderedsettings.conf
module.exports = {
    flowFile: 'flows.json',
    flowFilePretty: true,
    credentialSecret: "$(pwgen -c -n 32 1)",
    https: {
      key: require("fs").readFileSync('/data/homeassistant-nodered.key'),
      cert: require("fs").readFileSync('/data/homeassistant-nodered.crt')
    },
    requireHttps: true,
    uiPort: 443,
    logging: {
        console: {
            level: "info",
            metrics: false,
            audit: false
        }
    },
    exportGlobalContextKeys: false,
    externalModules: {
    },
    editorTheme: {
        theme: "dark",
        tours: false
    },
    functionExternalModules: true,
    functionGlobalContext: {
    },
    debugMaxLength: 1000,
    mqttReconnectTime: 15000,
    serialReconnectTime: 15000,
}
EOFCF

  outputHASSPanels
  outputHASSConfigYaml
}

function outputComposeHomeAssistant()
{
  rm -f $HOME/homeassistant-compose.yml
  cat <<EOFHA > $HOME/homeassistant-compose.yml
$STACK_VERSION_PREFIX homeassistant $(getScriptStackVersion homeassistant)

services:
  homeassistant-db:
    image: $(getScriptImageByContainerName homeassistant-db)
    container_name: homeassistant-db
    hostname: homeassistant-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - dock-privateip-net
      - dock-dbs-net
    ports:
      - "$HOMEASSISTANT_DB_LOCALHOST_PORT:5432"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/homeassistant/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/homeassistant/dbexport:/dbexport
    environment:
      - POSTGRES_DB=$HOMEASSISTANT_DATABASE_NAME
      - POSTGRES_USER=$HOMEASSISTANT_DATABASE_USER
      - POSTGRES_PASSWORD=$HOMEASSISTANT_DATABASE_USER_PASSWORD
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.homeassistant-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.homeassistant-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.homeassistant-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.homeassistant-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.homeassistant-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.homeassistant-hourly-db.email-from=Home Assistant Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.homeassistant-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.homeassistant-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.homeassistant-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.homeassistant-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.homeassistant-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.homeassistant-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.homeassistant-monthly-db.email-from=Home Assistant Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.homeassistant-monthly-db.mail-only-on-error=false"

  homeassistant-app:
    image: $(getScriptImageByContainerName homeassistant-app)
    container_name: homeassistant-app
    hostname: homeassistant-app
    restart: unless-stopped
    env_file: stack.env
    privileged: true
    depends_on:
      - homeassistant-db
    network_mode: host
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/\${PYTHON_VER}/site-packages/certifi/cacert.pem:ro
      - \${HSHQ_SSL_DIR}/homeassistant-app.crt:/certs/homeassistant-app.crt
      - \${HSHQ_SSL_DIR}/homeassistant-app.key:/certs/homeassistant-app.key
      - \${HSHQ_STACKS_DIR}/homeassistant/config:/config
      - \${HSHQ_STACKS_DIR}/homeassistant/media:/media

  homeassistant-nodered:
    image: $(getScriptImageByContainerName homeassistant-nodered)
    container_name: homeassistant-nodered
    hostname: homeassistant-nodered
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - homeassistant-app
    networks:
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/homeassistant/nodered:/data
      - \${HSHQ_SSL_DIR}/homeassistant-nodered.crt:/data/homeassistant-nodered.crt
      - \${HSHQ_SSL_DIR}/homeassistant-nodered.key:/data/homeassistant-nodered.key

  homeassistant-configurator:
    image: $(getScriptImageByContainerName homeassistant-configurator)
    container_name: homeassistant-configurator
    hostname: homeassistant-configurator
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - homeassistant-app
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/homeassistant-configurator.crt:/certs/homeassistant-configurator.crt
      - \${HSHQ_SSL_DIR}/homeassistant-configurator.key:/certs/homeassistant-configurator.key
      - \${HSHQ_STACKS_DIR}/homeassistant/configurator:/config
      - \${HSHQ_STACKS_DIR}/homeassistant/config:/hass-config

  homeassistant-tasmoadmin:
    image: $(getScriptImageByContainerName homeassistant-tasmoadmin)
    container_name: homeassistant-tasmoadmin
    hostname: homeassistant-tasmoadmin
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - homeassistant-app
    networks:
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/homeassistant/tasmoadmin:/data

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true

EOFHA

}

function outputHASSConfigYaml()
{
  cat <<EOFHC > $HSHQ_STACKS_DIR/homeassistant/configuration.yaml

default_config:

homeassistant:
  time_zone: $TZ
  external_url: "https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN"
  internal_url: "https://$SUB_HOMEASSISTANT_APP.$HOMESERVER_DOMAIN"
  country: US

frontend:
  themes: !include_dir_merge_named themes

tts:
  - platform: picotts
    language: 'en-US'

notify:
  - name: "LOCAL_SMTP"
    platform: smtp
    server: "$SUB_POSTFIX.$HOMESERVER_DOMAIN"
    port: 25
    timeout: 15
    sender: "$EMAIL_SMTP_EMAIL_ADDRESS"
    encryption: starttls
    verify_ssl: false
    recipient:
      - "$EMAIL_ADMIN_EMAIL_ADDRESS"
    sender_name: "HomeAssistant $(getAdminEmailName)"

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 10.0.0.0/8
    - 172.16.0.0/12
    - 192.168.0.0/16
  ip_ban_enabled: true
  login_attempts_threshold: 5
  server_host: 0.0.0.0
  server_port: $HOMEASSISTANT_LOCALHOST_PORT
  ssl_certificate: /certs/homeassistant-app.crt
  ssl_key: /certs/homeassistant-app.key

panel_custom:
  - name: nodered
    sidebar_title: "Node Red"
    sidebar_icon: mdi:file-tree
    url_path: nodered
    module_url: /local/panels/nodered_redirect.js
    embed_iframe: true
    require_admin: true
  - name: Configurator
    sidebar_title: "Configurator"
    sidebar_icon: mdi:wrench
    url_path: configurator
    module_url: /local/panels/configurator_redirect.js
    embed_iframe: true
    require_admin: true
  - name: tasmoadmin
    sidebar_title: "TasmoAdmin"
    sidebar_icon: mdi:home-automation
    url_path: tasmoadmin
    module_url: /local/panels/tasmoadmin_redirect.js
    embed_iframe: true
    require_admin: true

recorder:
  db_url: postgresql://$HOMEASSISTANT_DATABASE_USER:$HOMEASSISTANT_DATABASE_USER_PASSWORD@localhost:$HOMEASSISTANT_DB_LOCALHOST_PORT/$HOMEASSISTANT_DATABASE_NAME

influxdb:
  api_version: 2
  ssl: true
  host: $SUB_INFLUXDB.$HOMESERVER_DOMAIN
  port: 443
  verify_ssl: true
  ssl_ca_cert: /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
  token: "$INFLUXDB_TOKEN"
  organization: "$INFLUXDB_ORG"
  bucket: "$INFLUXDB_HA_BUCKET"

EOFHC

}

function outputHASSPanels()
{
  mkdir -p $HSHQ_STACKS_DIR/homeassistant/config/www/panels
  echo "window.location.replace(\"https://$SUB_HOMEASSISTANT_CONFIGURATOR.$HOMESERVER_DOMAIN/\");" > $HSHQ_STACKS_DIR/homeassistant/config/www/panels/configurator_redirect.js
  echo "window.location.replace(\"https://$SUB_HOMEASSISTANT_NODERED.$HOMESERVER_DOMAIN/\");" > $HSHQ_STACKS_DIR/homeassistant/config/www/panels/nodered_redirect.js
  echo "window.location.replace(\"https://$SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN/\");" > $HSHQ_STACKS_DIR/homeassistant/config/www/panels/tasmoadmin_redirect.js
}

function performUpdateHomeAssistant()
{
  perform_stack_name=homeassistant
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2023.8,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2023.8,homeassistant/home-assistant:2024.3.1"
      image_update_map[2]="nodered/node-red:3.0.2,nodered/node-red:3.1.7"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v3.1.0,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfV4UpdateHASS false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v5
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.3,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.1.3,homeassistant/home-assistant:2024.3.1"
      image_update_map[2]="nodered/node-red:3.0.2,nodered/node-red:3.1.7"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v3.1.0,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfV4UpdateHASS false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v5
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.5,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.1.5,homeassistant/home-assistant:2024.3.1"
      image_update_map[2]="nodered/node-red:3.0.2,nodered/node-red:3.1.7"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v3.1.0,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.1.6,nodered/node-red:3.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v3.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.1.6,homeassistant/home-assistant:2024.3.1"
      image_update_map[2]="nodered/node-red:3.0.2,nodered/node-red:3.1.7"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v3.1.0,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.3.1,nodered/node-red:3.1.7,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.3.1,homeassistant/home-assistant:2024.7.4"
      image_update_map[2]="nodered/node-red:3.1.7,nodered/node-red:4.0.2"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v4.0.1,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfUpdateHASSiFramesConfig false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.7.4,nodered/node-red:4.0.2,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v4.0.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.7.4,homeassistant/home-assistant:2024.10.4"
      image_update_map[2]="nodered/node-red:4.0.2,nodered/node-red:4.0.5"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v4.0.1,ghcr.io/tasmoadmin/tasmoadmin:v4.1.3"
    ;;
    7)
      newVer=v8
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2024.10.4,nodered/node-red:4.0.5,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v4.1.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2024.10.4,homeassistant/home-assistant:2025.4.0"
      image_update_map[2]="nodered/node-red:4.0.5,nodered/node-red:4.0.9-22"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v4.1.3,ghcr.io/tasmoadmin/tasmoadmin:v4.1.3"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfHomeAssistantUpdatePythonCertPath
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    8)
      newVer=v8
      curImageList=postgres:15.0-bullseye,homeassistant/home-assistant:2025.4.0,nodered/node-red:4.0.9-22,causticlab/hass-configurator-docker:0.5.2,ghcr.io/tasmoadmin/tasmoadmin:v4.1.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="homeassistant/home-assistant:2025.4.0,homeassistant/home-assistant:2025.4.0"
      image_update_map[2]="nodered/node-red:4.0.9-22,nodered/node-red:4.0.9-22"
      image_update_map[3]="causticlab/hass-configurator-docker:0.5.2,causticlab/hass-configurator-docker:0.5.2"
      image_update_map[4]="ghcr.io/tasmoadmin/tasmoadmin:v4.1.3,ghcr.io/tasmoadmin/tasmoadmin:v4.1.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfV4UpdateHASS()
{
  # Replace the config and compose files...
  # Typically, we would be more surgical with the changes,
  # but in this case, the amount of users affected is minimal.
  outputHASSConfigYaml
  outputComposeHomeAssistant
  chmod 600 $HOME/homeassistant-compose.yml
  sudo chown root:root $HOME/homeassistant-compose.yml
  sudo mv $HOME/homeassistant-compose.yml $upgrade_compose_file
  insertEnableSvcUptimeKuma homeassistant "$FMLNAME_HOMEASSISTANT_TASMOADMIN" $USERTYPE_HOMEASSISTANT_TASMOADMIN "https://$SUB_HOMEASSISTANT_TASMOADMIN.$HOMESERVER_DOMAIN" true
}

function mfUpdateHASSiFramesConfig()
{
  outputHASSPanels
  if [ -f $HSHQ_STACKS_DIR/homeassistant/config/configuration.yaml ]; then
    sudo mv $HSHQ_STACKS_DIR/homeassistant/config/configuration.yaml $HSHQ_STACKS_DIR/homeassistant/config/configuration.old
  fi
  outputHASSConfigYaml
  sudo mv $HSHQ_STACKS_DIR/homeassistant/configuration.yaml $HSHQ_STACKS_DIR/homeassistant/config/configuration.yaml
}

function mfHomeAssistantUpdatePythonCertPath()
{
  # This will address the python version cert path correctly
  # by moving the version to an environment variable.
  # Much easier to update in the future.
  sed -i "s|\/etc\/ssl\/certs\/ca-certificates.crt:\/usr\/local\/lib\/python.*|\/etc\/ssl\/certs\/ca-certificates.crt:\/usr\/local\/lib\/\${PYTHON_VER}\/site-packages\/certifi\/cacert.pem:ro|g" $HOME/homeassistant-compose.yml
  grep "PYTHON_VER=" $HOME/homeassistant.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "PYTHON_VER=python3.13" >> $HOME/homeassistant.env
  fi
}

# Gitlab
function installGitlab()
{
  set +e
  is_integrate_hshq=$1
  # Remember to check if exists
  checkDeleteStackAndDirectory gitlab "Gitlab"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName gitlab-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName gitlab-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName gitlab-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/gitlab
  mkdir $HSHQ_STACKS_DIR/gitlab/app
  mkdir $HSHQ_STACKS_DIR/gitlab/app/config
  mkdir $HSHQ_STACKS_DIR/gitlab/app/data
  mkdir $HSHQ_STACKS_DIR/gitlab/app/logs
  mkdir $HSHQ_STACKS_DIR/gitlab/db
  mkdir $HSHQ_STACKS_DIR/gitlab/dbexport
  chmod 777 $HSHQ_STACKS_DIR/gitlab/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/gitlab
  mkdir $HSHQ_NONBACKUP_DIR/gitlab/redis

  initServicesCredentials
  if [ -z "$GITLAB_ROOT_PASSWORD" ]; then
    GITLAB_ROOT_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GITLAB_ROOT_PASSWORD $GITLAB_ROOT_PASSWORD
  fi
  if [ -z "$GITLAB_REDIS_PASSWORD" ]; then
    GITLAB_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar GITLAB_REDIS_PASSWORD $GITLAB_REDIS_PASSWORD
  fi
  outputConfigGitlab
  generateCert gitlab-app gitlab-app
  installStack gitlab gitlab-app "" $HOME/gitlab.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 1
  startStopStack gitlab stop
  sudo rm -fr $HSHQ_STACKS_DIR/gitlab
  sudo rm -fr $HSHQ_NONBACKUP_DIR/gitlab

  mkdir $HSHQ_STACKS_DIR/gitlab
  mkdir $HSHQ_STACKS_DIR/gitlab/app
  mkdir $HSHQ_STACKS_DIR/gitlab/app/config
  mkdir $HSHQ_STACKS_DIR/gitlab/app/data
  mkdir $HSHQ_STACKS_DIR/gitlab/app/logs
  mkdir $HSHQ_STACKS_DIR/gitlab/db
  mkdir $HSHQ_STACKS_DIR/gitlab/dbexport
  chmod 777 $HSHQ_STACKS_DIR/gitlab/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/gitlab
  mkdir $HSHQ_NONBACKUP_DIR/gitlab/redis

  mv $HOME/gitlab.rb $HSHQ_STACKS_DIR/gitlab/app/config/gitlab.rb
  mv $HOME/gitlab-postconfigure.sh $HSHQ_STACKS_DIR/gitlab/app/config/gitlab-postconfigure.sh
  chmod +x $HSHQ_STACKS_DIR/gitlab/app/config/gitlab-postconfigure.sh
  startStopStack gitlab start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_GITLAB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://gitlab-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GITLAB $MANAGETLS_GITLAB "$is_integrate_hshq" $NETDEFAULT_GITLAB "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll gitlab "$FMLNAME_GITLAB" $USERTYPE_GITLAB "https://$SUB_GITLAB.$HOMESERVER_DOMAIN" "gitlab.png" "$(getHeimdallOrderFromSub $SUB_GITLAB $USERTYPE_GITLAB)"
    restartAllCaddyContainers
  fi
}

function outputConfigGitlab()
{
  cat <<EOFGL > $HOME/gitlab-compose.yml
$STACK_VERSION_PREFIX gitlab $(getScriptStackVersion gitlab)

services:
  gitlab-db:
    image: $(getScriptImageByContainerName gitlab-db)
    container_name: gitlab-db
    hostname: gitlab-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    depends_on:
      - gitlab-redis
    networks:
      - int-gitlab-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/gitlab/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/gitlab/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.gitlab-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.gitlab-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.gitlab-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.gitlab-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.gitlab-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.gitlab-hourly-db.email-from=Gitlab Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.gitlab-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.gitlab-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.gitlab-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.gitlab-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.gitlab-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.gitlab-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.gitlab-monthly-db.email-from=Gitlab Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.gitlab-monthly-db.mail-only-on-error=false"

  gitlab-app:
    image: $(getScriptImageByContainerName gitlab-app)
    container_name: gitlab-app
    hostname: gitlab-app
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-gitlab-net
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/gitlab-app.crt:/certs/gitlab-app.crt
      - \${HSHQ_SSL_DIR}/gitlab-app.key:/certs/gitlab-app.key
      - \${HSHQ_STACKS_DIR}/gitlab/app/config:/etc/gitlab
      - \${HSHQ_STACKS_DIR}/gitlab/app/logs:/var/log/gitlab
      - \${HSHQ_STACKS_DIR}/gitlab/app/data:/var/opt/gitlab
    environment:
      - GITLAB_ROOT_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
      - GITLAB_POST_RECONFIGURE_SCRIPT=/etc/gitlab/gitlab-postconfigure.sh

  gitlab-redis:
    image: $(getScriptImageByContainerName gitlab-redis)
    container_name: gitlab-redis
    hostname: gitlab-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-gitlab-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-gitlab-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$GITLAB_REDIS_PASSWORD

volumes:
  v-gitlab-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/gitlab/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-gitlab-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFGL

  cat <<EOFGL > $HOME/gitlab.env
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$GITLAB_DATABASE_NAME
POSTGRES_USER=$GITLAB_DATABASE_USER
POSTGRES_PASSWORD=$GITLAB_DATABASE_USER_PASSWORD
EOFGL

  cat <<EOFGL > $HOME/gitlab.rb
external_url 'https://$SUB_GITLAB.$HOMESERVER_DOMAIN'
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = '$SMTP_HOSTNAME'
gitlab_rails['smtp_port'] = $SMTP_HOSTPORT
gitlab_rails['smtp_user_name'] = '$EMAIL_SMTP_EMAIL_ADDRESS'
gitlab_rails['smtp_password'] = '$EMAIL_SMTP_PASSWORD'
gitlab_rails['smtp_domain'] = '$SMTP_HOSTNAME'
gitlab_rails['smtp_authentication'] = 'login'
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['gitlab_email_enabled'] = true
gitlab_rails['gitlab_email_from'] = '$EMAIL_SMTP_EMAIL_ADDRESS'
gitlab_rails['gitlab_email_display_name'] = 'Gitlab $(getAdminEmailName)'
gitlab_rails['gitlab_email_reply_to'] = '$EMAIL_ADMIN_EMAIL_ADDRESS'
gitlab_rails['incoming_email_enabled'] = false
alertmanager['admin_email'] = '$EMAIL_ADMIN_EMAIL_ADDRESS'
gitlab_rails['gitlab_default_theme'] = 11
gitlab_rails['trusted_proxies'] = [ '10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16' ]
gitlab_rails['terraform_state_enabled'] = false
gitlab_rails['usage_ping_enabled'] = false
gitlab_rails['ldap_enabled'] = true
gitlab_rails['ldap_servers'] = YAML.load <<-'EOS'
  main:
    label: 'LDAP'
    host: 'ldapserver'
    port: 389
    uid: 'uid'
    bind_dn: '$LDAP_READONLY_USER_BIND_DN'
    password: '$LDAP_READONLY_USER_PASSWORD'
    encryption: 'start_tls' 
    verify_certificates: true
    base: '$LDAP_BASE_DN'
    group_base: 'ou=groups,$LDAP_BASE_DN'
    admin_group: '$LDAP_ADMIN_USER_GROUP_NAME'
    lowercase_usernames: true
    tls_options:
      ca_file: /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
EOS
gitlab_rails['initial_root_password'] = '$GITLAB_ROOT_PASSWORD'
gitlab_rails['store_initial_root_password'] = false
gitlab_rails['db_adapter'] = 'postgresql'
gitlab_rails['db_database'] = '$GITLAB_DATABASE_NAME'
gitlab_rails['db_username'] = '$GITLAB_DATABASE_USER'
gitlab_rails['db_password'] = '$GITLAB_DATABASE_USER_PASSWORD'
gitlab_rails['db_host'] = 'gitlab-db'
gitlab_rails['db_port'] = 5432
gitlab_rails['redis_host'] = 'gitlab-redis'
gitlab_rails['redis_password'] = '$GITLAB_REDIS_PASSWORD'
postgresql['shared_buffers'] = '256MB'
postgresql['enable'] = false
redis['enable'] = false
puma['worker_processes'] = 2
puma['max_threads'] = 4
sidekiq['concurrency'] = 2
sidekiq['max_concurrency'] = 5
prometheus_monitoring['enable'] = false
nginx['redirect_http_to_https'] = true
nginx['ssl_certificate'] = '/certs/gitlab-app.crt'
nginx['ssl_certificate_key'] = '/certs/gitlab-app.key'
nginx['real_ip_trusted_addresses'] = [ '10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16' ]
nginx['real_ip_header'] = 'X-Forwarded-For'
nginx['real_ip_recursive'] = 'on'
EOFGL

  cat <<EOFGL > $HOME/gitlab-postconfigure.sh
#!/bin/bash

gitlab-rails runner 'ApplicationSetting.last.update(signup_enabled: false)'
gitlab-rails runner 'ApplicationSetting.last.update(password_authentication_enabled_for_web: false)'
echo "Gitlab Postconfigure Scirpt Completed"

EOFGL
}

function performUpdateGitlab()
{
  perform_stack_name=gitlab
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.2.4-ce.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:16.2.4-ce.0,gitlab/gitlab-ce:16.8.4-ce.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.7.0-ce.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:16.7.0-ce.0,gitlab/gitlab-ce:16.8.4-ce.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.8.1-ce.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:16.8.1-ce.0,gitlab/gitlab-ce:16.8.4-ce.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.8.4-ce.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:16.8.4-ce.0,gitlab/gitlab-ce:16.10.10-ce.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:16.10.10-ce.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:16.10.10-ce.0,gitlab/gitlab-ce:17.10.3-ce.0"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    6)
      newVer=v6
      curImageList=postgres:15.0-bullseye,gitlab/gitlab-ce:17.10.3-ce.0,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitlab/gitlab-ce:17.10.3-ce.0,gitlab/gitlab-ce:17.10.3-ce.0"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Vaultwarden
function installVaultwarden()
{
  set +e
  is_integrate_hshq=$1
  # Same as before, check if directory exists
  checkDeleteStackAndDirectory vaultwarden "Vaultwarden"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName vaultwarden-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName vaultwarden-ldap)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName vaultwarden-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/vaultwarden
  mkdir $HSHQ_STACKS_DIR/vaultwarden/app
  mkdir $HSHQ_STACKS_DIR/vaultwarden/db
  mkdir $HSHQ_STACKS_DIR/vaultwarden/dbexport
  chmod 777 $HSHQ_STACKS_DIR/vaultwarden/dbexport

  initServicesCredentials
  outputConfigVaultwarden
  generateCert vaultwarden-app vaultwarden-app
  installStack vaultwarden vaultwarden-app "Rocket has launched" $HOME/vaultwarden.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  docker container restart vaultwarden-ldap > /dev/null 2>&1

  inner_block=""
  inner_block=$inner_block">>https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>@insecureadmin {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_NOTHOMESUBNET\n"
  inner_block=$inner_block">>>>>>>>path /admin*\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>redir @insecureadmin /\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://vaultwarden-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>>>header_up X-Real-IP {remote_host}\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_VAULTWARDEN $MANAGETLS_VAULTWARDEN "$is_integrate_hshq" $NETDEFAULT_VAULTWARDEN "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll vaultwarden "$FMLNAME_VAULTWARDEN" $USERTYPE_VAULTWARDEN "https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN" "vaultwarden.png" "$(getHeimdallOrderFromSub $SUB_VAULTWARDEN $USERTYPE_VAULTWARDEN)"
    insertEnableSvcHeimdall vaultwarden "$FMLNAME_VAULTWARDEN Admin" admin "https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN/admin" "vaultwarden.png" true "$(getHeimdallOrderFromSub $SUB_VAULTWARDEN admin)"
    restartAllCaddyContainers
  fi
  emailVaultwardenCredentials false
}

function outputConfigVaultwarden()
{
  cat <<EOFVW > $HOME/vaultwarden-compose.yml
$STACK_VERSION_PREFIX vaultwarden $(getScriptStackVersion vaultwarden)

services:
  vaultwarden-db:
    image: $(getScriptImageByContainerName vaultwarden-db)
    container_name: vaultwarden-db
    hostname: vaultwarden-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-vaultwarden-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/vaultwarden/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/vaultwarden/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.vaultwarden-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.vaultwarden-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.vaultwarden-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.vaultwarden-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.vaultwarden-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.vaultwarden-hourly-db.email-from=Vaultwarden Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.vaultwarden-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.vaultwarden-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.vaultwarden-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.vaultwarden-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.vaultwarden-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.vaultwarden-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.vaultwarden-monthly-db.email-from=Vaultwarden Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.vaultwarden-monthly-db.mail-only-on-error=false"

  vaultwarden-app:
    image: $(getScriptImageByContainerName vaultwarden-app)
    container_name: vaultwarden-app
    hostname: vaultwarden-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - vaultwarden-db
    networks:
      - int-vaultwarden-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/vaultwarden-app.crt:/certs/vaultwarden-app.crt
      - \${HSHQ_SSL_DIR}/vaultwarden-app.key:/certs/vaultwarden-app.key
      - \${HSHQ_STACKS_DIR}/vaultwarden/app:/data

  vaultwarden-ldap:
    image: $(getScriptImageByContainerName vaultwarden-ldap)
    container_name: vaultwarden-ldap
    hostname: vaultwarden-ldap
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - vaultwarden-app
    networks:
      - int-vaultwarden-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.der:/cacert/rootca.der:ro
    environment:
      - APP_VAULTWARDEN_ADMIN_TOKEN=$VAULTWARDEN_ADMIN_TOKEN
      - APP_LDAP_BIND_PASSWORD=$LDAP_READONLY_USER_PASSWORD

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-vaultwarden-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFVW

  VAULTWARDEN_ADMIN_TOKEN_HASH=$(echo -n "$VAULTWARDEN_ADMIN_TOKEN" | argon2 $(pwgen -c -n 32 1) -id -e -m 16 | sed 's/\$/\$\$/g')
  cat <<EOFVW > $HOME/vaultwarden.env
UID=$USERID
GID=$GROUPID
ADMIN_TOKEN=$VAULTWARDEN_ADMIN_TOKEN_HASH
DATABASE_URL=postgresql://$VAULTWARDEN_DATABASE_USER:$VAULTWARDEN_DATABASE_USER_PASSWORD@vaultwarden-db:5432/$VAULTWARDEN_DATABASE_NAME
ROCKET_TLS={certs=/certs/vaultwarden-app.crt,key=/certs/vaultwarden-app.key}
ROCKET_PORT=443
IP_HEADER=X-Forwarded-For
SIGNUPS_ALLOWED=false
DOMAIN=https://$SUB_VAULTWARDEN.$HOMESERVER_DOMAIN
SMTP_HOST=$SMTP_HOSTNAME
SMTP_FROM_NAME=Vaultwarden $(getAdminEmailName)
SMTP_FROM=$EMAIL_ADMIN_EMAIL_ADDRESS
SMTP_PORT=$SMTP_HOSTPORT
SMTP_SECURITY=starttls
POSTGRES_DB=$VAULTWARDEN_DATABASE_NAME
POSTGRES_USER=$VAULTWARDEN_DATABASE_USER
POSTGRES_PASSWORD=$VAULTWARDEN_DATABASE_USER_PASSWORD
RUST_BACKTRACE=1
APP_VAULTWARDEN_URL=https://vaultwarden-app:443
APP_LDAP_HOST=ldapserver
APP_LDAP_PORT=389
APP_LDAP_BIND_DN=$LDAP_READONLY_USER_BIND_DN
APP_LDAP_SEARCH_BASE_DN=$LDAP_BASE_DN
APP_LDAP_STARTTLS=true
APP_LDAP_NO_TLS_VERIFY=true
APP_VAULTWARDEN_ROOT_CERT_FILE=/cacert/rootca.der
APP_LDAP_SEARCH_BASE_DN=$LDAP_BASE_DN
APP_LDAP_SEARCH_FILTER=(&(objectClass=person)(memberof=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))
APP_LDAP_SYNC_INTERVAL_SECONDS=300

EOFVW

}

function performUpdateVaultwarden()
{
  perform_stack_name=vaultwarden
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.29.1-alpine,thegeeklab/vaultwarden-ldap:0.6.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.29.1-alpine,vaultwarden/server:1.30.5-alpine"
      image_update_map[2]="thegeeklab/vaultwarden-ldap:0.6.2,vividboarder/vaultwarden_ldap:2.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfReplaceVaultwardenLDAPConnector
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v5
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.1-alpine,thegeeklab/vaultwarden-ldap:0.6.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.30.1-alpine,vaultwarden/server:1.30.5-alpine"
      image_update_map[2]="thegeeklab/vaultwarden-ldap:0.6.2,vividboarder/vaultwarden_ldap:2.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfReplaceVaultwardenLDAPConnector
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v5
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.2-alpine,thegeeklab/vaultwarden-ldap:0.6.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.30.2-alpine,vaultwarden/server:1.30.5-alpine"
      image_update_map[2]="thegeeklab/vaultwarden-ldap:0.6.2,vividboarder/vaultwarden_ldap:2.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfReplaceVaultwardenLDAPConnector
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.5-alpine,thegeeklab/vaultwarden-ldap:0.6.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.30.5-alpine,vaultwarden/server:1.30.5-alpine"
      image_update_map[2]="thegeeklab/vaultwarden-ldap:0.6.2,vividboarder/vaultwarden_ldap:2.0.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfReplaceVaultwardenLDAPConnector
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    5)
      newVer=v7
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.30.5-alpine,vividboarder/vaultwarden_ldap:2.0.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.30.5-alpine,vaultwarden/server:1.33.2-alpine"
      image_update_map[2]="vividboarder/vaultwarden_ldap:2.0.1,vividboarder/vaultwarden_ldap:2.1.1"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.32.3-alpine,vividboarder/vaultwarden_ldap:2.0.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.32.3-alpine,vaultwarden/server:1.33.2-alpine"
      image_update_map[2]="vividboarder/vaultwarden_ldap:2.0.2,vividboarder/vaultwarden_ldap:2.1.1"
    ;;
    7)
      newVer=v7
      curImageList=postgres:15.0-bullseye,vaultwarden/server:1.33.2-alpine,vividboarder/vaultwarden_ldap:2.1.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="vaultwarden/server:1.33.2-alpine,vaultwarden/server:1.33.2-alpine"
      image_update_map[2]="vividboarder/vaultwarden_ldap:2.1.1,vividboarder/vaultwarden_ldap:2.1.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfReplaceVaultwardenLDAPConnector()
{
  outputConfigVaultwarden
}

# Discourse
function installDiscourse()
{
  set +e
  is_integrate_hshq=$1
  # !Check if directory exists
  checkDeleteStackAndDirectory discourse "Discourse"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName discourse-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName discourse-sidekiq)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName discourse-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName discourse-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/discourse
  mkdir $HSHQ_STACKS_DIR/discourse/db
  mkdir $HSHQ_STACKS_DIR/discourse/dbexport
  mkdir $HSHQ_STACKS_DIR/discourse/app
  chmod 777 $HSHQ_STACKS_DIR/discourse/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/discourse
  mkdir $HSHQ_NONBACKUP_DIR/discourse/redis

  initServicesCredentials
  if [ -z "$DISCOURSE_DATABASE_USER_PASSWORD" ]; then
    DISCOURSE_DATABASE_USER_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DISCOURSE_DATABASE_USER_PASSWORD $DISCOURSE_DATABASE_USER_PASSWORD
  fi
  if [ -z "$DISCOURSE_REDIS_PASSWORD" ]; then
    DISCOURSE_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar DISCOURSE_REDIS_PASSWORD $DISCOURSE_REDIS_PASSWORD
  fi
  set +e
  docker exec mailu-admin flask mailu alias-delete $DISCOURSE_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $DISCOURSE_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  #generateCert discourse-app discourse-app
  outputConfigDiscourse
  installStack discourse discourse-app "" $HOME/discourse.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_DISCOURSE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://discourse-app:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_DISCOURSE $MANAGETLS_DISCOURSE "$is_integrate_hshq" $NETDEFAULT_DISCOURSE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll discourse "$FMLNAME_DISCOURSE" $USERTYPE_DISCOURSE "https://$SUB_DISCOURSE.$HOMESERVER_DOMAIN" "discourse.png" "$(getHeimdallOrderFromSub $SUB_DISCOURSE $USERTYPE_DISCOURSE)"
    restartAllCaddyContainers
  fi
}

function outputConfigDiscourse()
{
  cat <<EOFDC > $HOME/discourse-compose.yml
$STACK_VERSION_PREFIX discourse $(getScriptStackVersion discourse)

services:
  discourse-db:
    image: $(getScriptImageByContainerName discourse-db)
    container_name: discourse-db
    hostname: discourse-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-discourse-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/discourse/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/discourse/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.discourse-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.discourse-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.discourse-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.discourse-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.discourse-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.discourse-hourly-db.email-from=Discourse Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.discourse-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.discourse-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.discourse-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.discourse-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.discourse-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.discourse-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.discourse-monthly-db.email-from=Discourse Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.discourse-monthly-db.mail-only-on-error=false"

  discourse-app:
    image: $(getScriptImageByContainerName discourse-app)
    container_name: discourse-app
    hostname: discourse-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - discourse-db
      - discourse-redis
    networks:
      - int-discourse-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-discourse-data:/bitnami/discourse

  discourse-sidekiq:
    image: $(getScriptImageByContainerName discourse-sidekiq)
    container_name: discourse-sidekiq
    hostname: discourse-sidekiq
    restart: unless-stopped
    env_file: stack.env
    command: /opt/bitnami/scripts/discourse-sidekiq/run.sh
    depends_on:
      - discourse-db
      - discourse-redis
    networks:
      - int-discourse-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-discourse-data:/bitnami/discourse

  discourse-redis:
    image: $(getScriptImageByContainerName discourse-redis)
    container_name: discourse-redis
    hostname: discourse-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-discourse-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-discourse-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$DISCOURSE_REDIS_PASSWORD

volumes:
  v-discourse-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/discourse/redis
  v-discourse-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/discourse/app

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-discourse-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFDC

  cat <<EOFDC > $HOME/discourse.env
UID=$USERID
GID=$GROUPID
DISCOURSE_USERNAME=$DISCOURSE_ADMIN_USERNAME
DISCOURSE_PASSWORD=$DISCOURSE_ADMIN_PASSWORD
DISCOURSE_EMAIL=$DISCOURSE_ADMIN_EMAIL_ADDRESS
DISCOURSE_FIRST_NAME=$(echo $HOMESERVER_ABBREV | tr '[:lower:]' '[:upper:]')
DISCOURSE_LAST_NAME=Admin
DISCOURSE_SITE_NAME=$HOMESERVER_NAME Discourse
DISCOURSE_HOST=$SUB_DISCOURSE.$HOMESERVER_DOMAIN
DISCOURSE_DATABASE_HOST=discourse-db
DISCOURSE_DATABASE_PORT_NUMBER=5432
DISCOURSE_DATABASE_USER=$DISCOURSE_DATABASE_USER
DISCOURSE_DATABASE_NAME=$DISCOURSE_DATABASE_NAME
DISCOURSE_DATABASE_PASSWORD=$DISCOURSE_DATABASE_USER_PASSWORD
DISCOURSE_REDIS_HOST=discourse-redis
DISCOURSE_REDIS_PORT_NUMBER=6379
DISCOURSE_REDIS_PASSWORD=$DISCOURSE_REDIS_PASSWORD
POSTGRESQL_CLIENT_DATABASE_HOST=discourse-db
POSTGRESQL_CLIENT_DATABASE_PORT_NUMBER=5432
POSTGRESQL_CLIENT_CREATE_DATABASE_NAME=$DISCOURSE_DATABASE_NAME
POSTGRESQL_CLIENT_POSTGRES_USER=$DISCOURSE_DATABASE_USER
POSTGRESQL_CLIENT_POSTGRES_PASSWORD=$DISCOURSE_DATABASE_USER_PASSWORD
POSTGRESQL_CLIENT_CREATE_DATABASE_EXTENSIONS=hstore,pg_trgm
POSTGRES_DB=$DISCOURSE_DATABASE_NAME
POSTGRES_USER=$DISCOURSE_DATABASE_USER
POSTGRES_PASSWORD=$DISCOURSE_DATABASE_USER_PASSWORD
DISCOURSE_SMTP_HOST=$SMTP_HOSTNAME
DISCOURSE_SMTP_PORT=$SMTP_HOSTPORT
DISCOURSE_SMTP_PROTOCOL=tls
EOFDC

}

function performUpdateDiscourse()
{
  perform_stack_name=discourse
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.0.6,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.0.6,bitnami/discourse:3.0.6"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Discourse cannot be upgraded to the next version. You must export your data from this instance, uninstall and reinstall Discourse, then import your data into the new instance."
      return
    ;;
    2)
      newVer=v5
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.1.3,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.1.3,bitnami/discourse:3.2.5"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    3)
      # This is unstable as a fresh installation. It strangely works when upgrading from 3.1.3...
      newVer=v5
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.1.4,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.1.4,bitnami/discourse:3.2.5"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.2.1,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.2.1,bitnami/discourse:3.2.5"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.2.5,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.2.5,bitnami/discourse:3.4.1"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    6)
      newVer=v6
      curImageList=postgres:15.0-bullseye,bitnami/discourse:3.3.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/discourse:3.3.2,bitnami/discourse:3.3.2"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Syncthing
function installSyncthing()
{
  set +e
  is_integrate_hshq=$1
  # !Check if directory exists
  checkDeleteStackAndDirectory syncthing "Syncthing"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Syncthing directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName syncthing)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Syncthing docker image"
    exit 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/syncthing
  mkdir $HSHQ_STACKS_DIR/syncthing/config
  mkdir $HSHQ_STACKS_DIR/syncthing/data

  initServicesCredentials
  SYNCTHING_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $SYNCTHING_ADMIN_PASSWORD | tr -d ':\n' | sed 's/$2y/$2a/')
  SYNCTHING_API_KEY=$(pwgen -c -n 32 1)
  updateConfigVar SYNCTHING_API_KEY $SYNCTHING_API_KEY
  generateCert syncthing syncthing
  outputConfigSyncthing
  installStack syncthing syncthing "Access the GUI via the following URL" $HOME/syncthing.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Syncthing"
    exit $retval
  fi
  sleep 3
  startStopStack syncthing stop
  alltext=$(sudo cat $HSHQ_STACKS_DIR/syncthing/config/config.xml)
  replacetext='<gui enabled="true" tls="true" debugging="false">\n        <address>127.0.0.1:'$SYNCTHING_LOCAL_WEB_PORT'</address>\n        <user>'$SYNCTHING_ADMIN_USERNAME'</user>\n        <password>'$SYNCTHING_ADMIN_PASSWORD_HASH'</password>\n        <apikey>'$SYNCTHING_API_KEY'</apikey>\n        <theme>dark</theme>\n    </gui>'
  echo -e "${alltext%%<gui*}${replacetext}${alltext##*</gui>}" > $HOME/st_config.xml
  alltext=$(cat $HOME/st_config.xml)
  replacetext='<globalAnnounceEnabled>false</globalAnnounceEnabled>'
  echo -e "${alltext%%<globalAnnounceEnabled*}${replacetext}${alltext##*</globalAnnounceEnabled>}" > $HOME/st_config.xml
  alltext=$(cat $HOME/st_config.xml)
  replacetext='<natEnabled>false</natEnabled>'
  echo -e "${alltext%%<natEnabled*}${replacetext}${alltext##*</natEnabled>}" > $HOME/st_config.xml
  alltext=$(cat $HOME/st_config.xml)
  replacetext='<localAnnounceEnabled>false</localAnnounceEnabled>'
  echo -e "${alltext%%<localAnnounceEnabled*}${replacetext}${alltext##*</localAnnounceEnabled>}" > $HOME/st_config.xml
  alltext=$(cat $HOME/st_config.xml)
  replacetext='<relaysEnabled>false</relaysEnabled>'
  echo -e "${alltext%%<relaysEnabled*}${replacetext}${alltext##*</relaysEnabled>}" > $HOME/st_config.xml
  sudo mv $HOME/st_config.xml $HSHQ_STACKS_DIR/syncthing/config/config.xml
  startStopStack syncthing start
  sleep 3
  curl -s -H "X-API-Key: $SYNCTHING_API_KEY" -X DELETE -k https://127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT/rest/config/folders/default
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SYNCTHING.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://syncthing:$SYNCTHING_LOCAL_WEB_PORT {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SYNCTHING $MANAGETLS_SYNCTHING "$is_integrate_hshq" $NETDEFAULT_SYNCTHING "$inner_block"
}

function outputConfigSyncthing()
{
  cat <<EOFST > $HOME/syncthing-compose.yml
$STACK_VERSION_PREFIX syncthing $(getScriptStackVersion syncthing)

services:
  syncthing:
    image: $(getScriptImageByContainerName syncthing)
    container_name: syncthing
    hostname: syncthing
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-privateip-net
    ports:
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/tcp"
      - "$SYNCTHING_SYNC_PORT:$SYNCTHING_SYNC_PORT/udp"
      - "$SYNCTHING_DISC_PORT:$SYNCTHING_DISC_PORT/udp"
      - "127.0.0.1:$SYNCTHING_LOCAL_WEB_PORT:$SYNCTHING_LOCAL_WEB_PORT"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/cert.pem:ro
      - \${HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/key.pem:ro
      - \${HSHQ_SSL_DIR}/syncthing.crt:/var/syncthing/config/https-cert.pem:ro
      - \${HSHQ_SSL_DIR}/syncthing.key:/var/syncthing/config/https-key.pem:ro
      - \${HSHQ_STACKS_DIR}/syncthing/config:/var/syncthing/config
      - \${HSHQ_STACKS_DIR}/syncthing/data:/var/syncthing/data
      - \${HSHQ_BACKUP_DIR}:/backup
      - \${HSHQ_RELAYSERVER_DIR}/backup:/relayserver

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
EOFST

  cat <<EOFST > $HOME/syncthing.env
PUID=0
PGID=0
STCONFDIR=/var/syncthing/config
STDATADIR=/var/syncthing/data
STHOMEDIR=
EOFST

}

function performUpdateSyncthing()
{
  perform_stack_name=syncthing
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=syncthing/syncthing:1.23.7
      image_update_map[0]="syncthing/syncthing:1.23.7,syncthing/syncthing:1.27.1"
    ;;
    2)
      newVer=v5
      curImageList=syncthing/syncthing:1.27.1
      image_update_map[0]="syncthing/syncthing:1.27.1,syncthing/syncthing:1.27.9"
    ;;
    3)
      newVer=v5
      curImageList=syncthing/syncthing:1.27.2
      image_update_map[0]="syncthing/syncthing:1.27.2,syncthing/syncthing:1.27.9"
    ;;
    4)
      newVer=v5
      curImageList=syncthing/syncthing:1.27.4
      image_update_map[0]="syncthing/syncthing:1.27.4,syncthing/syncthing:1.27.9"
    ;;
    5)
      newVer=v7
      curImageList=syncthing/syncthing:1.27.9
      image_update_map[0]="syncthing/syncthing:1.27.9,syncthing/syncthing:1.29.4"
    ;;
    6)
      newVer=v7
      curImageList=syncthing/syncthing:1.28.0
      image_update_map[0]="syncthing/syncthing:1.28.0,syncthing/syncthing:1.29.4"
    ;;
    7)
      newVer=v7
      curImageList=syncthing/syncthing:1.29.4
      image_update_map[0]="syncthing/syncthing:1.29.4,syncthing/syncthing:1.29.4"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# CodeServer
function installCodeServer()
{
  set +e
  is_integrate_hshq=$1
  # !Check if directory exists
  checkDeleteStackAndDirectory codeserver "CodeServer"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName codeserver)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/codeserver
  mkdir $HSHQ_STACKS_DIR/codeserver/.config
  mkdir $HSHQ_STACKS_DIR/codeserver/.config/code-server
  initServicesCredentials
  CODESERVER_ADMIN_PASSWORD_HASH=$(echo -n "$CODESERVER_ADMIN_PASSWORD" | argon2 $(pwgen -c -n 32 1) -e)
  generateCert codeserver codeserver
  outputConfigCodeServer
  mv $HOME/codeserver.yaml $HSHQ_STACKS_DIR/codeserver/.config/code-server/config.yaml
  cd ~
  docker compose -f $HOME/codeserver-compose-tmp.yml up -d
  search="HTTPS server listening on https"
  isFound=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs codeserver 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 5 seconds, total wait=$i seconds..."
    sleep 5
    i=$((i+5))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "CodeServer did not start up correctly..."
    cd ~
    docker compose -f $HOME/codeserver-compose-tmp.yml down -v
    rm -f $HOME/codeserver-compose-tmp.yml
    return 1
  fi
  echo "Codeserver installed, sleeping 10 seconds..."
  sleep 10
  docker exec codeserver code-server --install-extension kelvin.vscode-sshfs
  cd ~
  docker compose -f $HOME/codeserver-compose-tmp.yml down -v
  rm -f $HOME/codeserver-compose-tmp.yml
  rm -f $HSHQ_STACKS_DIR/codeserver/.local/share/code-server/User/settings.json
  mv $HOME/codeserver-settings.json $HSHQ_STACKS_DIR/codeserver/.local/share/code-server/User/settings.json
  installStack codeserver codeserver "HTTPS server listening on https" $HOME/codeserver.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_CODESERVER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://codeserver:3443 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_CODESERVER $MANAGETLS_CODESERVER "$is_integrate_hshq" $NETDEFAULT_CODESERVER "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll codeserver "$FMLNAME_CODESERVER" $USERTYPE_CODESERVER "https://$SUB_CODESERVER.$HOMESERVER_DOMAIN" "codeserver.png" "$(getHeimdallOrderFromSub $SUB_CODESERVER $USERTYPE_CODESERVER)"
    restartAllCaddyContainers
  fi
}

function outputConfigCodeServer()
{
  cat <<EOFCS > $HOME/codeserver-compose-tmp.yml

services:
  codeserver:
    image: $(getScriptImageByContainerName codeserver)
    container_name: codeserver
    hostname: codeserver
    restart: unless-stopped
    user: "$USERID:$GROUPID"
    command:
      --cert /certs/codeserver.crt
      --cert-key /certs/codeserver.key
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - $HSHQ_STACKS_DIR/codeserver:/home/coder
      - $HSHQ_SSL_DIR/codeserver.crt:/certs/codeserver.crt
      - $HSHQ_SSL_DIR/codeserver.key:/certs/codeserver.key
    environment:
      - DOCKER_USER=$USERNAME
      - USER=$USERNAME

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCS

  cat <<EOFCS > $HOME/codeserver-compose.yml
$STACK_VERSION_PREFIX codeserver $(getScriptStackVersion codeserver)

services:
  codeserver:
    image: $(getScriptImageByContainerName codeserver)
    container_name: codeserver
    hostname: codeserver
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    command:
      --cert /certs/codeserver.crt
      --cert-key /certs/codeserver.key
    networks:
      - dock-proxy-net
      #- dock-ext-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/codeserver:/home/coder
      - \${HSHQ_STACKS_DIR}/authelia/config/configuration.yml:/home/coder/HSHQ/authelia/configuration.yml
      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles:/home/coder/HSHQ/caddy/caddyfiles
      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/home/coder/HSHQ/caddy/snippets
      - \${HSHQ_SSL_DIR}/codeserver.crt:/certs/codeserver.crt
      - \${HSHQ_SSL_DIR}/codeserver.key:/certs/codeserver.key

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
EOFCS

  cat <<EOFCS > $HOME/codeserver.env
UID=$USERID
GID=$GROUPID
DOCKER_USER=$USERNAME
USER=$USERNAME
PORT=3443
EOFCS

  cat <<EOFCS > $HOME/codeserver.yaml
bind-addr: 127.0.0.1:3443
auth: password
hashed-password: "$CODESERVER_ADMIN_PASSWORD_HASH"
cert: false
disable-telemetry: true
EOFCS

  cat <<EOFCS > $HOME/codeserver-settings.json
{
    "workbench.colorTheme": "Default Dark Modern",
    "workbench.startupEditor": "none",
    "telemetry.telemetryLevel": "off",
    "workbench.editor.enablePreview": false,
    "files.autoSave": "off"
}
EOFCS

}

function performUpdateCodeServer()
{
  perform_stack_name=codeserver
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=codercom/code-server:4.16.1
      image_update_map[0]="codercom/code-server:4.16.1,codercom/code-server:4.22.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAddConfigsMountCodeServer false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v4
      curImageList=codercom/code-server:4.20.0
      image_update_map[0]="codercom/code-server:4.20.0,codercom/code-server:4.22.1"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfAddConfigsMountCodeServer false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v4
      curImageList=codercom/code-server:4.20.1
      image_update_map[0]="codercom/code-server:4.20.1,codercom/code-server:4.22.1"
    ;;
    4)
      newVer=v6
      curImageList=codercom/code-server:4.22.1
      image_update_map[0]="codercom/code-server:4.22.1,codercom/code-server:4.98.2"
    ;;
    5)
      newVer=v6
      curImageList=codercom/code-server:4.93.1
      image_update_map[0]="codercom/code-server:4.93.1,codercom/code-server:4.98.2"
    ;;
    6)
      newVer=v6
      curImageList=codercom/code-server:4.98.2
      image_update_map[0]="codercom/code-server:4.98.2,codercom/code-server:4.98.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfAddConfigsMountCodeServer()
{
  sudo grep "authelia/config/configuration.yml" $upgrade_compose_file > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    # Mount some config files into the code server container for easy access to edit
    sudo sed -i "s|/codeserver:/home/coder|/codeserver:/home/coder\n      - \${HSHQ_STACKS_DIR}/authelia/config/configuration.yml:/home/coder/HSHQ/authelia/configuration.yml\n      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles:/home/coder/HSHQ/caddy/caddyfiles\n      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/home/coder/HSHQ/caddy/snippets|" $upgrade_compose_file
  fi
}

# Shlink
function installShlink()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory shlink "Shlink"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName shlink-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName shlink-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName shlink-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName shlink-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/shlink
  mkdir $HSHQ_STACKS_DIR/shlink/db
  mkdir $HSHQ_STACKS_DIR/shlink/dbexport
  mkdir $HSHQ_STACKS_DIR/shlink/web
  chmod 777 $HSHQ_STACKS_DIR/shlink/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/shlink
  mkdir $HSHQ_NONBACKUP_DIR/shlink/redis

  initServicesCredentials
  if [ -z "$SHLINK_REDIS_PASSWORD" ]; then
    SHLINK_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar SHLINK_REDIS_PASSWORD $SHLINK_REDIS_PASSWORD
  fi
  if [ -z "$SHLINK_INITIAL_API_KEY" ]; then
    SHLINK_INITIAL_API_KEY=$(pwgen -c -n -A 8 1)"-"$(pwgen -c -n -A 4 1)"-"$(pwgen -c -n -A 4 1)"-"$(pwgen -c -n -A 4 1)"-"$(pwgen -c -n -A 12 1)
    updateConfigVar SHLINK_INITIAL_API_KEY $SHLINK_INITIAL_API_KEY
  fi

  outputConfigShlink
  installStack shlink shlink "shlink" $HOME/shlink.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SHLINK_WEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://shlink-web:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SHLINK_WEB $MANAGETLS_SHLINK_WEB "$is_integrate_hshq" $NETDEFAULT_SHLINK_WEB "$inner_block"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SHLINK_APP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://shlink-app:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SHLINK_APP $MANAGETLS_SHLINK_APP "$is_integrate_hshq" $NETDEFAULT_SHLINK_APP "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll shlink "$FMLNAME_SHLINK_WEB" $USERTYPE_SHLINK_WEB "https://$SUB_SHLINK_WEB.$HOMESERVER_DOMAIN" "shlink.png" "$(getHeimdallOrderFromSub $SUB_SHLINK_WEB $USERTYPE_SHLINK_WEB)"
    restartAllCaddyContainers
  fi
}

function outputConfigShlink()
{
  cat <<EOFST > $HOME/shlink-compose.yml
$STACK_VERSION_PREFIX shlink $(getScriptStackVersion shlink)

services:
  shlink-db:
    image: $(getScriptImageByContainerName shlink-db)
    container_name: shlink-db
    hostname: shlink-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-shlink-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/shlink/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/shlink/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.shlink-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.shlink-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.shlink-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.shlink-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.shlink-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.shlink-hourly-db.email-from=Shlink Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.shlink-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.shlink-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.shlink-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.shlink-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.shlink-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.shlink-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.shlink-monthly-db.email-from=Shlink Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.shlink-monthly-db.mail-only-on-error=false"

  shlink-app:
    image: $(getScriptImageByContainerName shlink-app)
    container_name: shlink-app
    hostname: shlink-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - shlink-db
    networks:
      - int-shlink-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  shlink-web:
    image: $(getScriptImageByContainerName shlink-web)
    container_name: shlink-web
    hostname: shlink-web
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - shlink-db
      - shlink-app
    networks:
      - int-shlink-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shlink/web/servers.json:/usr/share/nginx/html/servers.json

  shlink-redis:
    image: $(getScriptImageByContainerName shlink-redis)
    container_name: shlink-redis
    hostname: shlink-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-shlink-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-shlink-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=\$SHLINK_REDIS_PASSWORD

volumes:
  v-shlink-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/shlink/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-shlink-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFST

  cat <<EOFST > $HOME/shlink.env
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$SHLINK_DATABASE_NAME
POSTGRES_USER=$SHLINK_DATABASE_USER
POSTGRES_PASSWORD=$SHLINK_DATABASE_USER_PASSWORD
DB_DRIVER=postgres
DB_HOST=shlink-db
DB_NAME=$SHLINK_DATABASE_NAME
DB_USER=$SHLINK_DATABASE_USER
DB_PASSWORD=$SHLINK_DATABASE_USER_PASSWORD
DEFAULT_DOMAIN=$SUB_SHLINK_APP.$HOMESERVER_DOMAIN
IS_HTTPS_ENABLED=true
INITIAL_API_KEY=$SHLINK_INITIAL_API_KEY
SHLINK_REDIS_PASSWORD=$SHLINK_REDIS_PASSWORD
REDIS_SERVERS=tcp://:$SHLINK_REDIS_PASSWORD@shlink-redis:6379

EOFST

  cat <<EOFST > $HSHQ_STACKS_DIR/shlink/web/servers.json
[
  {
    "name": "$HOMESERVER_NAME",
    "url": "https://$SUB_SHLINK_APP.$HOMESERVER_DOMAIN",
    "apiKey": "$SHLINK_INITIAL_API_KEY"
  }
]
EOFST
}

function performUpdateShlink()
{
  perform_stack_name=shlink
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.6.3,shlinkio/shlink-web-client:3.10.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:3.6.3,shlinkio/shlink:4.0.3"
      image_update_map[2]="shlinkio/shlink-web-client:3.10.2,shlinkio/shlink-web-client:4.0.1"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfUpdateShlinkInternalWebUIPort false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v3
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.7.2,shlinkio/shlink-web-client:3.10.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:3.7.2,shlinkio/shlink:4.0.3"
      image_update_map[2]="shlinkio/shlink-web-client:3.10.2,shlinkio/shlink-web-client:4.0.1"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfUpdateShlinkInternalWebUIPort false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:3.7.3,shlinkio/shlink-web-client:4.0.0,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:3.7.3,shlinkio/shlink:4.0.3"
      image_update_map[2]="shlinkio/shlink-web-client:4.0.0,shlinkio/shlink-web-client:4.0.1"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      if [ "$stackStatus" = "1" ];then
        startStopStack shlink stop "$portainerToken"
        sleep 3
      fi
      sudo rm -fr $HSHQ_NONBACKUP_DIR/shlink/redis/*
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfShlinkFixRedisUrl
      if [ "$stackStatus" = "2" ];then
        startStopStack shlink stop "$portainerToken"
      fi
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    4)
      newVer=v6
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:4.0.3,shlinkio/shlink-web-client:4.0.1,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:4.0.3,shlinkio/shlink:4.4.6"
      image_update_map[2]="shlinkio/shlink-web-client:4.0.1,shlinkio/shlink-web-client:4.3.0"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:4.2.4,shlinkio/shlink-web-client:4.2.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:4.2.4,shlinkio/shlink:4.4.6"
      image_update_map[2]="shlinkio/shlink-web-client:4.2.2,shlinkio/shlink-web-client:4.3.0"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    6)
      newVer=v6
      curImageList=postgres:15.0-bullseye,shlinkio/shlink:4.4.6,shlinkio/shlink-web-client:4.3.0,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="shlinkio/shlink:4.4.6,shlinkio/shlink:4.4.6"
      image_update_map[2]="shlinkio/shlink-web-client:4.3.0,shlinkio/shlink-web-client:4.3.0"
      image_update_map[3]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfUpdateShlinkInternalWebUIPort()
{
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SHLINK_WEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://shlink-web:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SHLINK_WEB $MANAGETLS_SHLINK_WEB true $NETDEFAULT_SHLINK_WEB "$inner_block"
  restartAllCaddyContainers
}

function mfShlinkFixRedisUrl()
{
  rm -f $HOME/shlink.env
  cat <<EOFST > $HOME/shlink.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$SHLINK_DATABASE_NAME
POSTGRES_USER=$SHLINK_DATABASE_USER
POSTGRES_PASSWORD=$SHLINK_DATABASE_USER_PASSWORD
DB_DRIVER=postgres
DB_HOST=shlink-db
DB_NAME=$SHLINK_DATABASE_NAME
DB_USER=$SHLINK_DATABASE_USER
DB_PASSWORD=$SHLINK_DATABASE_USER_PASSWORD
DEFAULT_DOMAIN=$SUB_SHLINK_APP.$HOMESERVER_DOMAIN
IS_HTTPS_ENABLED=true
INITIAL_API_KEY=$SHLINK_INITIAL_API_KEY
SHLINK_REDIS_PASSWORD=$SHLINK_REDIS_PASSWORD
REDIS_SERVERS=tcp://:$SHLINK_REDIS_PASSWORD@shlink-redis:6379

EOFST
}

# Firefly
function installFirefly()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory firefly "Firefly"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName firefly-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName firefly-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName firefly-importer)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName firefly-cron)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName firefly-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/firefly
  mkdir $HSHQ_STACKS_DIR/firefly/db
  mkdir $HSHQ_STACKS_DIR/firefly/dbexport
  mkdir $HSHQ_STACKS_DIR/firefly/data
  chmod 777 $HSHQ_STACKS_DIR/firefly/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/firefly
  mkdir $HSHQ_NONBACKUP_DIR/firefly/redis

  initServicesCredentials
  if [ -z "$FIREFLY_REDIS_PASSWORD" ]; then
    FIREFLY_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar FIREFLY_REDIS_PASSWORD $FIREFLY_REDIS_PASSWORD
  fi
  if [ -z "$FIREFLY_INITIAL_API_KEY" ]; then
    FIREFLY_INITIAL_API_KEY=$(pwgen -c -n 32 1)
    updateConfigVar FIREFLY_INITIAL_API_KEY $FIREFLY_INITIAL_API_KEY
  fi

  outputConfigFirefly
  installStack firefly firefly "" $HOME/firefly.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Firefly installed, sleeping 10 seconds..."
  sleep 10

  inner_block=""
  inner_block=$inner_block">>https://$SUB_FIREFLY_APP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://firefly-app:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FIREFLY_APP $MANAGETLS_FIREFLY_APP "$is_integrate_hshq" $NETDEFAULT_FIREFLY_APP "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://firefly-importer:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FIREFLY_IMPORTER $MANAGETLS_FIREFLY_IMPORTER "$is_integrate_hshq" $NETDEFAULT_FIREFLY_IMPORTER "$inner_block"
  insertSubAuthelia $SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll firefly "$FMLNAME_FIREFLY_APP" $USERTYPE_FIREFLY_APP "https://$SUB_FIREFLY_APP.$HOMESERVER_DOMAIN" "firefly.png" "$(getHeimdallOrderFromSub $SUB_FIREFLY_APP $USERTYPE_FIREFLY_APP)"
    insertEnableSvcAll firefly "$FMLNAME_FIREFLY_IMPORTER" $USERTYPE_FIREFLY_IMPORTER "https://$SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN" "firefly-importer.png" "$(getHeimdallOrderFromSub $SUB_FIREFLY_IMPORTER $USERTYPE_FIREFLY_IMPORTER)"
    restartAllCaddyContainers
  fi
}

function outputConfigFirefly()
{
  cat <<EOFFF > $HOME/firefly-compose.yml
$STACK_VERSION_PREFIX firefly $(getScriptStackVersion firefly)

services:
  firefly-db:
    image: $(getScriptImageByContainerName firefly-db)
    container_name: firefly-db
    hostname: firefly-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    depends_on:
      - firefly-redis
    networks:
      - int-firefly-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/firefly/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/firefly/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.firefly-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.firefly-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.firefly-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.firefly-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.firefly-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.firefly-hourly-db.email-from=Firefly Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.firefly-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.firefly-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.firefly-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.firefly-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.firefly-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.firefly-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.firefly-monthly-db.email-from=Firefly Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.firefly-monthly-db.mail-only-on-error=false"

  firefly-app:
    image: $(getScriptImageByContainerName firefly-app)
    container_name: firefly-app
    hostname: firefly-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - firefly-db
    networks:
      - int-firefly-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-firefly-data:/var/www/html/storage/upload

  firefly-importer:
    image: $(getScriptImageByContainerName firefly-importer)
    container_name: firefly-importer
    hostname: firefly-importer
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - firefly-app
    networks:
      - int-firefly-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  firefly-cron:
    image: $(getScriptImageByContainerName firefly-cron)
    container_name: firefly-cron
    hostname: firefly-cron
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: sh -c "
      echo \"0 3 * * * wget -qO- http://firefly-app:8080/api/v1/cron/$FIREFLY_STATIC_CRON_TOKEN;echo\" 
      | crontab - 
      && crond -f -L /dev/stdout"
    depends_on:
      - firefly-app
    networks:
      - int-firefly-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  firefly-redis:
    image: $(getScriptImageByContainerName firefly-redis)
    container_name: firefly-redis
    hostname: firefly-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-firefly-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-firefly-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$FIREFLY_REDIS_PASSWORD

volumes:
  v-firefly-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/firefly/db
  v-firefly-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/firefly/data
  v-firefly-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/firefly/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-firefly-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFFF

  cat <<EOFFF > $HOME/firefly.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
SITE_OWNER=$EMAIL_ADMIN_EMAIL_ADDRESS
APP_URL=https://$SUB_FIREFLY_APP.$HOMESERVER_DOMAIN
TRUSTED_PROXIES='*'
APP_KEY=$FIREFLY_INITIAL_API_KEY
DEFAULT_LANGUAGE=en_US
DEFAULT_LOCALE=equal
MAIL_MAILER=smtp
MAIL_HOST=$SMTP_HOSTNAME
MAIL_PORT=$SMTP_HOSTPORT
MAIL_FROM=$EMAIL_ADMIN_EMAIL_ADDRESS
MAIL_ENCRYPTION=tls
DB_CONNECTION=pgsql
DB_HOST=firefly-db
DB_PORT=5432
DB_DATABASE=$FIREFLY_DATABASE_NAME
DB_USERNAME=$FIREFLY_DATABASE_USER
DB_PASSWORD=$FIREFLY_DATABASE_USER_PASSWORD
REDIS_HOST=firefly-redis
REDIS_PASSWORD=$FIREFLY_REDIS_PASSWORD
POSTGRES_DB=$FIREFLY_DATABASE_NAME
POSTGRES_USER=$FIREFLY_DATABASE_USER
POSTGRES_PASSWORD=$FIREFLY_DATABASE_USER_PASSWORD
FIREFLY_III_URL=http://firefly-app:8080
VANITY_URL=https://$SUB_FIREFLY_APP.$HOMESERVER_DOMAIN
STATIC_CRON_TOKEN=$FIREFLY_STATIC_CRON_TOKEN
EOFFF

}

function performUpdateFirefly()
{
  perform_stack_name=firefly
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.0.20,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.0.20,fireflyiii/core:version-6.1.19"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    2)
      newVer=v5
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.1,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.1.1,fireflyiii/core:version-6.1.19"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    3)
      newVer=v5
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.7,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.1.7,fireflyiii/core:version-6.1.19"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.10,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.1.10,fireflyiii/core:version-6.1.19"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    5)
      newVer=v7
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.19,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.1.19,fireflyiii/core:version-6.2.10"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.1.21,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.1.21,fireflyiii/core:version-6.2.10"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    7)
      newVer=v8
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.2.10,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.2.10,fireflyiii/core:version-6.2.10"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfFireflyAddImporterAndCron
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    8)
      newVer=v8
      curImageList=postgres:15.0-bullseye,fireflyiii/core:version-6.2.10,bitnami/redis:7.4.2,fireflyiii/data-importer:version-1.6.1,alpine:3.21.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="fireflyiii/core:version-6.2.10,fireflyiii/core:version-6.2.10"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[3]="fireflyiii/data-importer:version-1.6.1,fireflyiii/data-importer:version-1.6.1"
      image_update_map[4]="alpine:3.21.3,alpine:3.21.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfFireflyAddImporterAndCron()
{
  pullImage $(getScriptImageByContainerName firefly-importer)
  pullImage $(getScriptImageByContainerName firefly-cron)
  initServicesCredentials
  rm -f $HOME/firefly-compose.yml
  rm -f $HOME/firefly.env
  outputConfigFirefly
  inner_block=""
  inner_block=$inner_block">>https://$SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://firefly-importer:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FIREFLY_IMPORTER $MANAGETLS_FIREFLY_IMPORTER "$is_integrate_hshq" $NETDEFAULT_FIREFLY_IMPORTER "$inner_block"
  insertSubAuthelia $SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}
  insertEnableSvcAll firefly "$FMLNAME_FIREFLY_IMPORTER" $USERTYPE_FIREFLY_IMPORTER "https://$SUB_FIREFLY_IMPORTER.$HOMESERVER_DOMAIN" "firefly-importer.png" "$(getHeimdallOrderFromSub $SUB_FIREFLY_IMPORTER $USERTYPE_FIREFLY_IMPORTER)"
  restartAllCaddyContainers
}

# Excalidraw
function installExcalidraw()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory excalidraw "Excalidraw"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName excalidraw-server)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName excalidraw-storage)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName excalidraw-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName excalidraw-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/excalidraw
  mkdir $HSHQ_STACKS_DIR/excalidraw/redis
  if [ -z "$EXCALIDRAW_REDIS_PASSWORD" ]; then
    EXCALIDRAW_REDIS_PASSWORD=$(pwgen -c -n 64 1)
    updateConfigVar EXCALIDRAW_REDIS_PASSWORD $EXCALIDRAW_REDIS_PASSWORD
  fi

  outputConfigExcalidraw
  installStack excalidraw excalidraw-web "" $HOME/excalidraw.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Excalidraw installed, sleeping 10 seconds..."
  sleep 10

  inner_block=""
  inner_block=$inner_block">>https://$SUB_EXCALIDRAW_WEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://excalidraw-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_EXCALIDRAW_WEB $MANAGETLS_EXCALIDRAW_WEB "$is_integrate_hshq" $NETDEFAULT_EXCALIDRAW_WEB "$inner_block"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_EXCALIDRAW_SERVER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_EXCALIDRAW_WEB.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERCORS https://$SUB_NEXTCLOUD.$HOMESERVER_DOMAIN\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://excalidraw-server {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_EXCALIDRAW_SERVER $MANAGETLS_EXCALIDRAW_SERVER "$is_integrate_hshq" $NETDEFAULT_EXCALIDRAW_SERVER "$inner_block"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_EXCALIDRAW_STORAGE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://excalidraw-storage:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_EXCALIDRAW_STORAGE $MANAGETLS_EXCALIDRAW_STORAGE "$is_integrate_hshq" $NETDEFAULT_EXCALIDRAW_STORAGE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll excalidraw "$FMLNAME_EXCALIDRAW_WEB" $USERTYPE_EXCALIDRAW_WEB "https://$SUB_EXCALIDRAW_WEB.$HOMESERVER_DOMAIN" "excalidraw.png" "$(getHeimdallOrderFromSub $SUB_EXCALIDRAW_WEB $USERTYPE_EXCALIDRAW_WEB)"
    insertEnableSvcUptimeKuma excalidraw "$FMLNAME_EXCALIDRAW_WEB Server" $USERTYPE_EXCALIDRAW_WEB "https://$SUB_EXCALIDRAW_SERVER.$HOMESERVER_DOMAIN" true
    restartAllCaddyContainers
  fi
}

function outputConfigExcalidraw()
{
  cat <<EOFEX > $HOME/excalidraw-compose.yml
$STACK_VERSION_PREFIX excalidraw $(getScriptStackVersion excalidraw)

services:
  excalidraw-storage:
    image: $(getScriptImageByContainerName excalidraw-storage)
    container_name: excalidraw-storage
    hostname: excalidraw-storage
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - int-excalidraw-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  excalidraw-server:
    image: $(getScriptImageByContainerName excalidraw-server)
    container_name: excalidraw-server
    hostname: excalidraw-server
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - int-excalidraw-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  excalidraw-web:
    image: $(getScriptImageByContainerName excalidraw-web)
    container_name: excalidraw-web
    hostname: excalidraw-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - int-excalidraw-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
 
  excalidraw-redis:
    image: $(getScriptImageByContainerName excalidraw-redis)
    container_name: excalidraw-redis
    hostname: excalidraw-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-excalidraw-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-excalidraw-redis:/bitnami/redis/data

volumes:
  v-excalidraw-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/excalidraw/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  int-excalidraw-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFEX

  cat <<EOFEX > $HOME/excalidraw.env
ALLOW_EMPTY_PASSWORD=no
REDIS_PASSWORD=$EXCALIDRAW_REDIS_PASSWORD
REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
STORAGE_URI=redis://:$EXCALIDRAW_REDIS_PASSWORD@excalidraw-redis:6379
BACKEND_V2_GET_URL=https://$SUB_EXCALIDRAW_STORAGE.$HOMESERVER_DOMAIN/api/v2/scenes/
BACKEND_V2_POST_URL=https://$SUB_EXCALIDRAW_STORAGE.$HOMESERVER_DOMAIN/api/v2/scenes/
LIBRARY_URL=https://libraries.excalidraw.com
LIBRARY_BACKEND=https://us-central1-excalidraw-room-persistence.cloudfunctions.net/libraries/
STORAGE_BACKEND=http
HTTP_STORAGE_BACKEND_URL=https://$SUB_EXCALIDRAW_STORAGE.$HOMESERVER_DOMAIN/api/v2
SOCKET_SERVER_URL=https://$SUB_EXCALIDRAW_SERVER.$HOMESERVER_DOMAIN
EOFEX
}

function performUpdateExcalidraw()
{
  perform_stack_name=excalidraw
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=excalidraw/excalidraw-room,kiliandeca/excalidraw-storage-backend,kiliandeca/excalidraw
      image_update_map[0]="excalidraw/excalidraw-room,excalidraw/excalidraw-room"
      image_update_map[1]="kiliandeca/excalidraw-storage-backend,kiliandeca/excalidraw-storage-backend"
      image_update_map[2]="kiliandeca/excalidraw,kiliandeca/excalidraw"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# DrawIO
function installDrawIO()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory drawio "Draw.io"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName drawio-plantuml)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName drawio-export)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName drawio-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/drawio
  mkdir $HSHQ_STACKS_DIR/drawio/fonts
  outputConfigDrawIO
  installStack drawio drawio-web "" $HOME/drawio.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Draw.io installed, sleeping 10 seconds..."
  sleep 10

  set +e
  docker container ps | grep nextcloud-app > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker exec -u www-data nextcloud-app php occ --no-warnings app:install drawio
    docker exec -u www-data nextcloud-app php occ --no-warnings config:app:set drawio DrawioUrl --value="https://$SUB_DRAWIO_WEB.$HOMESERVER_DOMAIN"
  fi
  set -e

  inner_block=""
  inner_block=$inner_block">>https://$SUB_DRAWIO_WEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADERALLOWFRAME\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://drawio-web:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_DRAWIO_WEB $MANAGETLS_DRAWIO_WEB "$is_integrate_hshq" $NETDEFAULT_DRAWIO_WEB "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll drawio "$FMLNAME_DRAWIO_WEB" $USERTYPE_DRAWIO_WEB "https://$SUB_DRAWIO_WEB.$HOMESERVER_DOMAIN" "drawio.png" "$(getHeimdallOrderFromSub $SUB_DRAWIO_WEB $USERTYPE_DRAWIO_WEB)"
    restartAllCaddyContainers
  fi
}

function outputConfigDrawIO()
{
  cat <<EOFDI > $HOME/drawio-compose.yml
$STACK_VERSION_PREFIX drawio $(getScriptStackVersion drawio)

services:
  drawio-plantuml:
    image: $(getScriptImageByContainerName drawio-plantuml)
    container_name: drawio-plantuml
    hostname: drawio-plantuml
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-drawio-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-drawio-fonts:/usr/share/fonts/drawio

  drawio-export:
    image: $(getScriptImageByContainerName drawio-export)
    container_name: drawio-export
    hostname: drawio-export
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-drawio-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-drawio-fonts:/usr/share/fonts/drawio

  drawio-web:
    image: $(getScriptImageByContainerName drawio-web)
    container_name: drawio-web
    hostname: drawio-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - drawio-plantuml
      - drawio-export
    networks:
      - dock-proxy-net
      - int-drawio-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

volumes:
  v-drawio-fonts:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/drawio/fonts

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  int-drawio-net:
    driver: bridge
    internal: true
    ipam:
      driver: default


EOFDI

  cat <<EOFDI > $HOME/drawio.env
DRAWIO_SELF_CONTAINED=1
PLANTUML_URL=http://drawio-plantuml:8080/
EXPORT_URL=http://drawio-export:8000/
DRAWIO_BASE_URL=https://$SUB_DRAWIO_WEB.$HOMESERVER_DOMAIN
EOFDI
}

function performUpdateDrawIO()
{
  perform_stack_name=drawio
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=jgraph/drawio:21.0.2,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:21.0.2,jgraph/drawio:24.7.5"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    2)
      newVer=v4
      curImageList=jgraph/drawio:23.1.0,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:23.1.0,jgraph/drawio:24.7.5"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    3)
      newVer=v4
      curImageList=jgraph/drawio:24.0.7,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:24.0.7,jgraph/drawio:24.7.5"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    4)
      newVer=v6
      curImageList=jgraph/drawio:24.7.5,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:24.7.5,jgraph/drawio:26.2.2"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    5)
      newVer=v6
      curImageList=jgraph/drawio:24.7.17,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:24.7.17,jgraph/drawio:26.2.2"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    6)
      newVer=v6
      curImageList=jgraph/drawio:26.2.2,jgraph/plantuml-server,jgraph/export-server
      image_update_map[0]="jgraph/drawio:26.2.2,jgraph/drawio:26.2.2"
      image_update_map[1]="jgraph/plantuml-server,jgraph/plantuml-server"
      image_update_map[2]="jgraph/export-server,jgraph/export-server"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Invidious
function installInvidious()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory invidious "Invidious"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName invidious-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName invidious-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName invidious-companion)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $IMG_INVIDIOUS_SESSIONGEN
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/invidious
  mkdir $HSHQ_STACKS_DIR/invidious/db
  mkdir $HSHQ_STACKS_DIR/invidious/dbexport
  mkdir $HSHQ_STACKS_DIR/invidious/companion
  mkdir $HSHQ_STACKS_DIR/invidious/init
  chmod 777 $HSHQ_STACKS_DIR/invidious/dbexport
  initServicesCredentials
  set +e
  docker run --rm $IMG_INVIDIOUS_SESSIONGEN > $HOME/invidious-session.txt
  visitorData="$(grep visitor_data $HOME/invidious-session.txt | cut -d":" -f2 | xargs)"
  poToken="$(grep po_token $HOME/invidious-session.txt | cut -d":" -f2 | xargs)"
  rm -f $HOME/invidious-session.txt
  outputConfigInvidious
  installStack invidious invidious-web "Invidious is ready to lead at" $HOME/invidious.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Invidious installed, sleeping 10 seconds..."
  sleep 10

  inner_block=""
  inner_block=$inner_block">>https://$SUB_INVIDIOUS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://invidious-web:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_INVIDIOUS $MANAGETLS_INVIDIOUS "$is_integrate_hshq" $NETDEFAULT_INVIDIOUS "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll invidious "$FMLNAME_INVIDIOUS" $USERTYPE_INVIDIOUS "https://$SUB_INVIDIOUS.$HOMESERVER_DOMAIN" "invidious.png" "$(getHeimdallOrderFromSub $SUB_INVIDIOUS $USERTYPE_INVIDIOUS)"
    restartAllCaddyContainers
  fi
}

function outputConfigInvidious()
{
  outputComposeEnvInvidious
  cat <<EOFIV > $HSHQ_STACKS_DIR/invidious/init/init.sql
-- Table: public.channels

-- DROP TABLE public.channels;

CREATE TABLE IF NOT EXISTS public.channels
(
  id text NOT NULL,
  author text,
  updated timestamp with time zone,
  deleted boolean,
  subscribed timestamp with time zone,
  CONSTRAINT channels_id_key UNIQUE (id)
);

GRANT ALL ON TABLE public.channels TO current_user;

-- Index: public.channels_id_idx

-- DROP INDEX public.channels_id_idx;

CREATE INDEX IF NOT EXISTS channels_id_idx
  ON public.channels
  USING btree
  (id COLLATE pg_catalog."default");

-- Table: public.videos

-- DROP TABLE public.videos;

CREATE UNLOGGED TABLE IF NOT EXISTS public.videos
(
  id text NOT NULL,
  info text,
  updated timestamp with time zone,
  CONSTRAINT videos_pkey PRIMARY KEY (id)
);

GRANT ALL ON TABLE public.videos TO current_user;

-- Index: public.id_idx

-- DROP INDEX public.id_idx;

CREATE UNIQUE INDEX IF NOT EXISTS id_idx
  ON public.videos
  USING btree
  (id COLLATE pg_catalog."default");

-- Table: public.channel_videos

-- DROP TABLE public.channel_videos;

CREATE TABLE IF NOT EXISTS public.channel_videos
(
  id text NOT NULL,
  title text,
  published timestamp with time zone,
  updated timestamp with time zone,
  ucid text,
  author text,
  length_seconds integer,
  live_now boolean,
  premiere_timestamp timestamp with time zone,
  views bigint,
  CONSTRAINT channel_videos_id_key UNIQUE (id)
);

GRANT ALL ON TABLE public.channel_videos TO current_user;

-- Index: public.channel_videos_ucid_idx

-- DROP INDEX public.channel_videos_ucid_idx;

CREATE INDEX IF NOT EXISTS channel_videos_ucid_idx
  ON public.channel_videos
  USING btree
  (ucid COLLATE pg_catalog."default");

-- Table: public.users

-- DROP TABLE public.users;

CREATE TABLE IF NOT EXISTS public.users
(
  updated timestamp with time zone,
  notifications text[],
  subscriptions text[],
  email text NOT NULL,
  preferences text,
  password text,
  token text,
  watched text[],
  feed_needs_update boolean,
  CONSTRAINT users_email_key UNIQUE (email)
);

GRANT ALL ON TABLE public.users TO current_user;

-- Index: public.email_unique_idx

-- DROP INDEX public.email_unique_idx;

CREATE UNIQUE INDEX IF NOT EXISTS email_unique_idx
  ON public.users
  USING btree
  (lower(email) COLLATE pg_catalog."default");

-- Table: public.session_ids

-- DROP TABLE public.session_ids;

CREATE TABLE IF NOT EXISTS public.session_ids
(
  id text NOT NULL,
  email text,
  issued timestamp with time zone,
  CONSTRAINT session_ids_pkey PRIMARY KEY (id)
);

GRANT ALL ON TABLE public.session_ids TO current_user;

-- Index: public.session_ids_id_idx

-- DROP INDEX public.session_ids_id_idx;

CREATE INDEX IF NOT EXISTS session_ids_id_idx
  ON public.session_ids
  USING btree
  (id COLLATE pg_catalog."default");

-- Table: public.nonces

-- DROP TABLE public.nonces;

CREATE TABLE IF NOT EXISTS public.nonces
(
  nonce text,
  expire timestamp with time zone,
  CONSTRAINT nonces_id_key UNIQUE (nonce)
);

GRANT ALL ON TABLE public.nonces TO current_user;

-- Index: public.nonces_nonce_idx

-- DROP INDEX public.nonces_nonce_idx;

CREATE INDEX IF NOT EXISTS nonces_nonce_idx
  ON public.nonces
  USING btree
  (nonce COLLATE pg_catalog."default");

-- Table: public.annotations

-- DROP TABLE public.annotations;

CREATE TABLE IF NOT EXISTS public.annotations
(
  id text NOT NULL,
  annotations xml,
  CONSTRAINT annotations_id_key UNIQUE (id)
);

GRANT ALL ON TABLE public.annotations TO current_user;

-- Type: public.privacy

-- DROP TYPE public.privacy;

CREATE TYPE public.privacy AS ENUM
(
    'Public',
    'Unlisted',
    'Private'
);

-- Table: public.playlists

-- DROP TABLE public.playlists;

CREATE TABLE IF NOT EXISTS public.playlists
(
    title text,
    id text primary key,
    author text,
    description text,
    video_count integer,
    created timestamptz,
    updated timestamptz,
    privacy privacy,
    index int8[]
);

GRANT ALL ON public.playlists TO current_user;

-- Table: public.playlist_videos

-- DROP TABLE public.playlist_videos;

CREATE TABLE IF NOT EXISTS public.playlist_videos
(
    title text,
    id text,
    author text,
    ucid text,
    length_seconds integer,
    published timestamptz,
    plid text references playlists(id),
    index int8,
    live_now boolean,
    PRIMARY KEY (index,plid)
);

GRANT ALL ON TABLE public.playlist_videos TO current_user;


EOFIV
}

function outputComposeEnvInvidious()
{
  INVIDIOUS_HMAC_KEY=$(pwgen -n 16 1)
  INVIDIOUS_COMPANION_KEY=$(pwgen -n 16 1)
  cat <<EOFIV > $HOME/invidious-compose.yml
$STACK_VERSION_PREFIX invidious $(getScriptStackVersion invidious)

services:
  invidious-db:
    image: $(getScriptImageByContainerName invidious-db)
    container_name: invidious-db
    hostname: invidious-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-invidious-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/invidious/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/invidious/dbexport:/dbexport
      - \${HSHQ_STACKS_DIR}/invidious/init:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_DB=$INVIDIOUS_DATABASE_NAME
      - POSTGRES_USER=$INVIDIOUS_DATABASE_USER
      - POSTGRES_PASSWORD=$INVIDIOUS_DATABASE_USER_PASSWORD
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.invidious-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.invidious-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.invidious-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.invidious-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.invidious-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.invidious-hourly-db.email-from=Invidious Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.invidious-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.invidious-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.invidious-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.invidious-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.invidious-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.invidious-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.invidious-monthly-db.email-from=Invidious Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"

  invidious-web:
    image: $(getScriptImageByContainerName invidious-web)
    container_name: invidious-web
    hostname: invidious-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - invidious-db
    networks:
      - int-invidious-net
      - dock-proxy-net
      - dock-ext-net
    environment:
      INVIDIOUS_CONFIG: |
        db:
          dbname: $INVIDIOUS_DATABASE_NAME
          user: $INVIDIOUS_DATABASE_USER
          password: $INVIDIOUS_DATABASE_USER_PASSWORD
          host: invidious-db
          port: 5432
        check_tables: true
        https_only: true
        statistics_enabled: false
        domain: $SUB_INVIDIOUS.$HOMESERVER_DOMAIN
        visitor_data: '$visitorData'
        po_token: '$poToken'
        hmac_key: "$INVIDIOUS_HMAC_KEY"
        invidious_companion_key: "$INVIDIOUS_COMPANION_KEY"
        invidious_companion:
        - private_url: "http://invidious-companion:8282"
          public_url: "https://$SUB_INVIDIOUS.$HOMESERVER_DOMAIN"

  invidious-companion:
    image: $(getScriptImageByContainerName invidious-companion)
    container_name: invidious-companion
    hostname: invidious-companion
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    depends_on:
      - invidious-db
    networks:
      - int-invidious-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - v-invidious-companion:/var/tmp/youtubei.js:rw
    environment:
      - SERVER_SECRET_KEY=$INVIDIOUS_COMPANION_KEY

volumes:
  v-invidious-companion:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/invidious/companion

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-invidious-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFIV
  cat <<EOFIV > $HOME/invidious.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
SERVER_SECRET_KEY=$INVIDIOUS_COMPANION_KEY
RUST_LOG=info
EOFIV
}

function performUpdateInvidious()
{
  perform_stack_name=invidious
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,quay.io/invidious/invidious:latest
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="quay.io/invidious/invidious:latest,quay.io/invidious/invidious:latest"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfInvidiousAddCompanion
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v2
      curImageList=postgres:15.0-bullseye,quay.io/invidious/invidious:master,quay.io/invidious/invidious-companion:latest
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="quay.io/invidious/invidious:master,quay.io/invidious/invidious:master"
      image_update_map[2]="quay.io/invidious/invidious-companion:latest,quay.io/invidious/invidious-companion:latest"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfInvidiousAddCompanion()
{
  mkdir -p $HSHQ_STACKS_DIR/invidious/companion
  outputComposeEnvInvidious
}

# Gitea
function installGitea()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory gitea "Gitea"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName gitea-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName gitea-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/gitea
  mkdir $HSHQ_STACKS_DIR/gitea/app
  mkdir $HSHQ_STACKS_DIR/gitea/db
  mkdir $HSHQ_STACKS_DIR/gitea/dbexport
  chmod 777 $HSHQ_STACKS_DIR/gitea/dbexport

  initServicesCredentials
  outputConfigGitea
  installStack gitea gitea-app "Starting new Web server:" $HOME/gitea.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Gitea installed, sleeping 10 seconds..."
  sleep 10
  set +e
  docker exec mailu-admin flask mailu alias-delete $GITEA_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $GITEA_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  docker exec -u $USERID gitea-app gitea admin user create --admin --username $GITEA_ADMIN_USERNAME --password $GITEA_ADMIN_PASSWORD --email $GITEA_ADMIN_EMAIL_ADDRESS
  docker exec -u $USERID gitea-app gitea admin auth add-ldap --name OpenLDAP --security-protocol ldaps --host ldapserver --port 636 --bind-dn "$LDAP_READONLY_USER_BIND_DN" --bind-password "$LDAP_READONLY_USER_PASSWORD" --user-search-base "ou=people,$LDAP_BASE_DN" --user-filter "(&(&(uid=%s)(objectClass=person))(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))" --admin-filter "(memberOf=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)" --username-attribute uid --firstname-attribute givenName --surname-attribute sn --email-attribute mail --avatar-attribute jpegPhoto --synchronize-users --active

  inner_block=""
  inner_block=$inner_block">>https://$SUB_GITEA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://gitea-app:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GITEA $MANAGETLS_GITEA "$is_integrate_hshq" $NETDEFAULT_GITEA "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll gitea "$FMLNAME_GITEA" $USERTYPE_GITEA "https://$SUB_GITEA.$HOMESERVER_DOMAIN" "gitea.png" "$(getHeimdallOrderFromSub $SUB_GITEA $USERTYPE_GITEA)"
    restartAllCaddyContainers
  fi
}

function outputConfigGitea()
{
  cat <<EOFGL > $HOME/gitea-compose.yml
$STACK_VERSION_PREFIX gitea $(getScriptStackVersion gitea)

services:
  gitea-db:
    image: $(getScriptImageByContainerName gitea-db)
    container_name: gitea-db
    hostname: gitea-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-gitea-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/gitea/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/gitea/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.gitea-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.gitea-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.gitea-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.gitea-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.gitea-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.gitea-hourly-db.email-from=Gitea Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.gitea-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.gitea-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.gitea-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.gitea-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.gitea-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.gitea-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.gitea-monthly-db.email-from=Gitea Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.gitea-monthly-db.mail-only-on-error=false"

  gitea-app:
    image: $(getScriptImageByContainerName gitea-app)
    container_name: gitea-app
    hostname: gitea-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - gitea-db
    networks:
      - int-gitea-net
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
      - dock-internalmail-net
    #ports:
    #  - "2222:22"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/gitea/app:/data

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-gitea-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFGL

  cat <<EOFGL > $HOME/gitea.env
USER_UID=$USERID
USER_GID=$GROUPID
POSTGRES_DB=$GITEA_DATABASE_NAME
POSTGRES_USER=$GITEA_DATABASE_USER
POSTGRES_PASSWORD=$GITEA_DATABASE_USER_PASSWORD
DISABLE_QUERY_AUTH_TOKEN=true
GITEA__APP_NAME=$HOMESERVER_NAME
GITEA__server__ROOT_URL=https://$SUB_GITEA.$HOMESERVER_DOMAIN/
GITEA__database__DB_TYPE=postgres
GITEA__database__HOST=gitea-db:5432
GITEA__database__NAME=$GITEA_DATABASE_NAME
GITEA__database__USER=$GITEA_DATABASE_USER
GITEA__database__PASSWD=$GITEA_DATABASE_USER_PASSWORD
GITEA__mailer__ENABLED=true
GITEA__mailer__FROM=Gitea $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>
GITEA__mailer__PROTOCOL=smtp+starttls
GITEA__mailer__SMTP_ADDR=$SMTP_HOSTNAME
GITEA__mailer__SMTP_PORT=$SMTP_HOSTPORT
GITEA__service__DISABLE_REGISTRATION=true
GITEA__security__INSTALL_LOCK=true
EOFGL

}

function performUpdateGitea()
{
  perform_stack_name=gitea
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.20.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.20.3,gitea/gitea:1.22.1"
    ;;
    2)
      newVer=v5
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.21.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.21.3,gitea/gitea:1.22.1"
    ;;
    3)
      newVer=v5
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.21.4
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.21.4,gitea/gitea:1.22.1"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.21.8
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.21.8,gitea/gitea:1.22.1"
    ;;
    5)
      newVer=v7
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.22.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.22.1,gitea/gitea:1.23.6"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.22.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.22.3,gitea/gitea:1.23.6"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfGiteaRemoveDeprecatedEnvVars
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    7)
      newVer=v7
      curImageList=postgres:15.0-bullseye,gitea/gitea:1.23.6
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gitea/gitea:1.23.6,gitea/gitea:1.23.6"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfGiteaRemoveDeprecatedEnvVars
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfGiteaRemoveDeprecatedEnvVars()
{
  set +e
  sed -i "/GITEA__mailer__MAILER_TYPE=/d" $HOME/gitea.env
  sed -i "/GITEA__mailer__HOST=/d" $HOME/gitea.env
  sed -i "/GITEA__mailer__MAILER_TYPE=/d" $HOME/gitea.env
  grep "GITEA__mailer__PROTOCOL=" $HOME/gitea.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "GITEA__mailer__PROTOCOL=smtp+starttls" >> $HOME/gitea.env
  fi
}

# Mealie
function installMealie()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory mealie "Mealie"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mealie-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName mealie-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/mealie
  mkdir $HSHQ_STACKS_DIR/mealie/app
  mkdir $HSHQ_STACKS_DIR/mealie/db
  mkdir $HSHQ_STACKS_DIR/mealie/dbexport
  chmod 777 $HSHQ_STACKS_DIR/mealie/dbexport

  initServicesCredentials

  set +e
  docker exec mailu-admin flask mailu alias-delete $MEALIE_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $MEALIE_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  outputConfigMealie
  installStack mealie mealie-app "Application startup complete" $HOME/mealie.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_MEALIE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://mealie-app:9000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MEALIE $MANAGETLS_MEALIE "$is_integrate_hshq" $NETDEFAULT_MEALIE "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll mealie "$FMLNAME_MEALIE" $USERTYPE_MEALIE "https://$SUB_MEALIE.$HOMESERVER_DOMAIN" "mealie.png" "$(getHeimdallOrderFromSub $SUB_MEALIE $USERTYPE_MEALIE)"
    restartAllCaddyContainers

    mealie_token=$(http -f --verify=no --timeout=300 --print="b" POST https://$SUB_MEALIE.$HOMESERVER_DOMAIN/api/auth/token username=changeme@example.com password=MyPassword | jq -r '.access_token')
    adminid=$(http -f --verify=no --timeout=300 --print="b" GET https://$SUB_MEALIE.$HOMESERVER_DOMAIN/api/users "Authorization: Bearer $mealie_token" | jq '.items[0].id' | tr -d '"')
    # Can't seem to get httpie to work, so switching to curl
    #curl -X "PUT" "https://$SUB_MEALIE.$HOMESERVER_DOMAIN/api/users/$adminid" -H "accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer $mealie_token" -d "{\"username\": \"$MEALIE_ADMIN_USERNAME\",\"fullName\": \"$HOMESERVER_NAME Mealie Admin\",\"email\": \"$MEALIE_ADMIN_EMAIL_ADDRESS\",\"group\":\"Home\",\"admin\": true}" > /dev/null 2>&1
    # API is broken in v1.3.2, so we'll go direct to DB
    docker exec mealie-db bash -c "PGPASSWORD=$MEALIE_DATABASE_USER_PASSWORD echo \"update users set full_name='$HOMESERVER_NAME Mealie Admin', username='$MEALIE_ADMIN_USERNAME', email='$MEALIE_ADMIN_EMAIL_ADDRESS' where id='$adminid';\" | psql -U $MEALIE_DATABASE_USER $MEALIE_DATABASE_NAME"
    curl -X "PUT" "https://$SUB_MEALIE.$HOMESERVER_DOMAIN/api/users/password" -H "accept: application/json" -H "Content-Type: application/json" -H "Authorization: Bearer $mealie_token" -d "{\"currentPassword\": \"MyPassword\",\"newPassword\": \"$MEALIE_ADMIN_PASSWORD\"}" > /dev/null 2>&1
  fi
}

function outputConfigMealie()
{
  cat <<EOFGL > $HOME/mealie-compose.yml
$STACK_VERSION_PREFIX mealie $(getScriptStackVersion mealie)

services:
  mealie-db:
    image: $(getScriptImageByContainerName mealie-db)
    container_name: mealie-db
    hostname: mealie-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-mealie-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/mealie/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/mealie/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.mealie-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.mealie-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.mealie-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.mealie-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.mealie-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.mealie-hourly-db.email-from=Mealie Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.mealie-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.mealie-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.mealie-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.mealie-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.mealie-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.mealie-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.mealie-monthly-db.email-from=Mealie Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.mealie-monthly-db.mail-only-on-error=false"

  mealie-app:
    image: $(getScriptImageByContainerName mealie-app)
    container_name: mealie-app
    hostname: mealie-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - mealie-db
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
      - dock-internalmail-net
      - int-mealie-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-mealie-app:/app/data

volumes:
  v-mealie-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/mealie/app

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-mealie-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFGL

  cat <<EOFGL > $HOME/mealie.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
DEFAULT_GROUP=Home
PRODUCTION=True
API_DOCS=True
ALLOW_SIGNUP=false
BASE_URL=https://$SUB_MEALIE.$HOMESERVER_DOMAIN
DB_ENGINE=postgres
POSTGRES_USER=$MEALIE_DATABASE_USER
POSTGRES_PASSWORD=$MEALIE_DATABASE_USER_PASSWORD
POSTGRES_SERVER=mealie-db
POSTGRES_PORT=5432
POSTGRES_DB=$MEALIE_DATABASE_NAME
TOKEN_TIME=168
SMTP_HOST=$SMTP_HOSTNAME
SMTP_PORT=$MAILU_PORT_5
SMTP_FROM_NAME=Mealie $(getAdminEmailName)
SMTP_AUTH_STRATEGY=TLS
SMTP_FROM_EMAIL=$EMAIL_SMTP_EMAIL_ADDRESS
SMTP_USER=$EMAIL_SMTP_EMAIL_ADDRESS
SMTP_PASSWORD=$EMAIL_SMTP_PASSWORD
LDAP_AUTH_ENABLED=True
LDAP_SERVER_URL=$LDAP_URI
LDAP_TLS_INSECURE=False
LDAP_TLS_CACERTFILE=/usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
LDAP_ENABLE_STARTTLS=True
LDAP_BASE_DN=$LDAP_BASE_DN
LDAP_QUERY_BIND=$LDAP_READONLY_USER_BIND_DN
LDAP_QUERY_PASSWORD=$LDAP_READONLY_USER_PASSWORD
LDAP_USER_FILTER=(&(|({id_attribute}={input})({mail_attribute}={input}))(objectClass=person)(|(memberOf=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)))
LDAP_ADMIN_FILTER=(memberOf=cn=$LDAP_ADMIN_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)
LDAP_ID_ATTRIBUTE=uid
LDAP_NAME_ATTRIBUTE=cn
LDAP_MAIL_ATTRIBUTE=mail
EOFGL

}

function performUpdateMealie()
{
  perform_stack_name=mealie
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=hkotel/mealie:v0.5.6
      image_update_map[0]="hkotel/mealie:v0.5.6,hkotel/mealie:v0.5.6"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Mealie cannot be upgraded to the next version. You must export your data/recipes from this instance, uninstall and reinstall mealie, then import your data/recipes into the new instance. See https://nightly.mealie.io/documentation/getting-started/migrating-to-mealie-v1/ for migration instructions."
      return
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.0.0-RC2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v1.0.0-RC2,ghcr.io/mealie-recipes/mealie:v1.3.2"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v1.1.0,ghcr.io/mealie-recipes/mealie:v1.3.2"
    ;;
    4)
      newVer=v6
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.3.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v1.3.2,ghcr.io/mealie-recipes/mealie:v1.12.0"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.11.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v1.11.0,ghcr.io/mealie-recipes/mealie:v1.12.0"
    ;;
    6)
      newVer=v7
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v1.12.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v1.12.0,ghcr.io/mealie-recipes/mealie:v2.1.0"
    ;;
    7)
      newVer=v8
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v2.1.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v2.1.0,ghcr.io/mealie-recipes/mealie:v2.8.0"
    ;;
    8)
      newVer=v8
      curImageList=postgres:15.0-bullseye,ghcr.io/mealie-recipes/mealie:v2.8.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/mealie-recipes/mealie:v2.8.0,ghcr.io/mealie-recipes/mealie:v2.8.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Kasm
function installKasm()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory kasm "Kasm"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName kasm)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/kasm
  mkdir $HSHQ_STACKS_DIR/kasm/profiles
  mkdir $HSHQ_NONBACKUP_DIR/kasm
  mkdir $HSHQ_NONBACKUP_DIR/kasm/data

  outputConfigKasm
  installStack kasm kasm "" $HOME/kasm.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_KASM.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://kasm {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>>>transport http {\n"
  inner_block=$inner_block">>>>>>>>>>tls\n"
  inner_block=$inner_block">>>>>>>>>>tls_insecure_skip_verify\n"
  inner_block=$inner_block">>>>>>>>}\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_KASM $MANAGETLS_KASM "$is_integrate_hshq" $NETDEFAULT_KASM "$inner_block"

  inner_block=""
  inner_block=$inner_block">>https://$SUB_KASM_WIZARD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://kasm:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>>>transport http {\n"
  inner_block=$inner_block">>>>>>>>>>tls\n"
  inner_block=$inner_block">>>>>>>>>>tls_insecure_skip_verify\n"
  inner_block=$inner_block">>>>>>>>}\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_KASM_WIZARD $MANAGETLS_KASM_WIZARD "$is_integrate_hshq" $NETDEFAULT_KASM_WIZARD "$inner_block"

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcHeimdall kasm "$FMLNAME_KASM" $USERTYPE_KASM "https://$SUB_KASM.$HOMESERVER_DOMAIN" "kasm.png" true "$(getHeimdallOrderFromSub $SUB_KASM $USERTYPE_KASM)"
    insertEnableSvcHeimdall kasm "$FMLNAME_KASM_WIZARD" $USERTYPE_KASM_WIZARD "https://$SUB_KASM_WIZARD.$HOMESERVER_DOMAIN" "kasm.png" true "$(getHeimdallOrderFromSub $SUB_KASM_WIZARD $USERTYPE_KASM_WIZARD)"
    restartAllCaddyContainers
  fi
}

function outputConfigKasm()
{
  cat <<EOFGL > $HOME/kasm-compose.yml
$STACK_VERSION_PREFIX kasm $(getScriptStackVersion kasm)

services:
  kasm:
    image: $(getScriptImageByContainerName kasm)
    container_name: kasm
    privileged: true
    hostname: kasm
    restart: unless-stopped
    env_file: stack.env
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_NONBACKUP_DIR}/kasm/data:/opt
      - \${HSHQ_STACKS_DIR}/kasm/profiles:/profiles

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFGL

  cat <<EOFGL > $HOME/kasm.env
KASM_PORT=443
EOFGL

}

function performUpdateKasm()
{
  perform_stack_name=kasm
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=lscr.io/linuxserver/kasm:1.13.0
      image_update_map[0]="lscr.io/linuxserver/kasm:1.13.0,lscr.io/linuxserver/kasm:1.15.0-ls29"
    ;;
    2)
      newVer=v4
      curImageList=lscr.io/linuxserver/kasm:1.14.0
      image_update_map[0]="lscr.io/linuxserver/kasm:1.14.0,lscr.io/linuxserver/kasm:1.15.0-ls29"
    ;;
    3)
      newVer=v6
      curImageList=lscr.io/linuxserver/kasm:1.15.0
      image_update_map[0]="lscr.io/linuxserver/kasm:1.15.0,lscr.io/linuxserver/kasm:1.16.1-ls68"
    ;;
    4)
      newVer=v6
      curImageList=lscr.io/linuxserver/kasm:1.15.0-ls29
      image_update_map[0]="lscr.io/linuxserver/kasm:1.15.0-ls29,lscr.io/linuxserver/kasm:1.16.1-ls68"
    ;;
    5)
      newVer=v6
      curImageList=lscr.io/linuxserver/kasm:1.16.0-ls44
      image_update_map[0]="lscr.io/linuxserver/kasm:1.16.0-ls44,lscr.io/linuxserver/kasm:1.16.1-ls68"
    ;;
    6)
      newVer=v6
      curImageList=lscr.io/linuxserver/kasm:1.16.1-ls68
      image_update_map[0]="lscr.io/linuxserver/kasm:1.16.1-ls68,lscr.io/linuxserver/kasm:1.16.1-ls68"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# NTFY
function installNTFY()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory ntfy "NTFY"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName ntfy)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/ntfy
  mkdir $HSHQ_STACKS_DIR/ntfy/cache
  mkdir $HSHQ_STACKS_DIR/ntfy/etc
  outputConfigNTFY
  installStack ntfy ntfy "" $HOME/ntfy.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3
  inner_block=""
  inner_block=$inner_block">>https://$SUB_NTFY.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://ntfy {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NTFY $MANAGETLS_NTFY "$is_integrate_hshq" $NETDEFAULT_NTFY "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll ntfy "$FMLNAME_NTFY" $USERTYPE_NTFY "https://$SUB_NTFY.$HOMESERVER_DOMAIN" "ntfy.png" "$(getHeimdallOrderFromSub $SUB_NTFY $USERTYPE_NTFY)"
    restartAllCaddyContainers
  fi
}

function outputConfigNTFY()
{
  cat <<EOFNT > $HOME/ntfy-compose.yml
$STACK_VERSION_PREFIX ntfy $(getScriptStackVersion ntfy)

services:
  ntfy:
    image: $(getScriptImageByContainerName ntfy)
    container_name: ntfy
    hostname: ntfy
    restart: unless-stopped
    env_file: stack.env
    user: "\${UID}:\${GID}"
    security_opt:
      - no-new-privileges:true
    command:
      - serve
    networks:
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/ntfy/cache:/var/cache/ntfy
      - \${HSHQ_STACKS_DIR}/ntfy/etc:/etc/ntfy
      - \${HSHQ_STACKS_DIR}/ntfy/etc/server.yml:/etc/ntfy/server.yml

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true

EOFNT

  cat <<EOFNT > $HOME/ntfy.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
EOFNT

  cat <<EOFNT > $HSHQ_STACKS_DIR/ntfy/etc/server.yml
# ntfy server config file
#
# Please refer to the documentation at https://ntfy.sh/docs/config/ for details.
# All options also support underscores (_) instead of dashes (-) to comply with the YAML spec.

# Public facing base URL of the service (e.g. https://ntfy.sh or https://ntfy.example.com)
#
# This setting is required for any of the following features:
# - attachments (to return a download URL)
# - e-mail sending (for the topic URL in the email footer)
# - iOS push notifications for self-hosted servers (to calculate the Firebase poll_request topic)
# - Matrix Push Gateway (to validate that the pushkey is correct)
#
base-url: https://$SUB_NTFY.$HOMESERVER_DOMAIN

# Listen address for the HTTP & HTTPS web server. If "listen-https" is set, you must also
# set "key-file" and "cert-file". Format: [<ip>]:<port>, e.g. "1.2.3.4:8080".
#
# To listen on all interfaces, you may omit the IP address, e.g. ":443".
# To disable HTTP, set "listen-http" to "-".
#
# listen-http: ":80"
# listen-https:

# Listen on a Unix socket, e.g. /var/lib/ntfy/ntfy.sock
# This can be useful to avoid port issues on local systems, and to simplify permissions.
#
# listen-unix: <socket-path>
# listen-unix-mode: <linux permissions, e.g. 0700>

# Path to the private key & cert file for the HTTPS web server. Not used if "listen-https" is not set.
#
# key-file: <filename>
# cert-file: <filename>

# If set, also publish messages to a Firebase Cloud Messaging (FCM) topic for your app.
# This is optional and only required to save battery when using the Android app.
#
# firebase-key-file: <filename>

# If "cache-file" is set, messages are cached in a local SQLite database instead of only in-memory.
# This allows for service restarts without losing messages in support of the since= parameter.
#
# The "cache-duration" parameter defines the duration for which messages will be buffered
# before they are deleted. This is required to support the "since=..." and "poll=1" parameter.
# To disable the cache entirely (on-disk/in-memory), set "cache-duration" to 0.
# The cache file is created automatically, provided that the correct permissions are set.
#
# The "cache-startup-queries" parameter allows you to run commands when the database is initialized,
# e.g. to enable WAL mode (see https://phiresky.github.io/blog/2020/sqlite-performance-tuning/)).
# Example:
#    cache-startup-queries: |
#       pragma journal_mode = WAL;
#       pragma synchronous = normal;
#       pragma temp_store = memory;
#       pragma busy_timeout = 15000;
#       vacuum;
#
# The "cache-batch-size" and "cache-batch-timeout" parameter allow enabling async batch writing
# of messages. If set, messages will be queued and written to the database in batches of the given
# size, or after the given timeout. This is only required for high volume servers.
#
# Debian/RPM package users:
#   Use /var/cache/ntfy/cache.db as cache file to avoid permission issues. The package
#   creates this folder for you.
#
# Check your permissions:
#   If you are running ntfy with systemd, make sure this cache file is owned by the
#   ntfy user and group by running: chown ntfy.ntfy <filename>.
#
cache-file: /var/cache/ntfy/cache.db
# cache-duration: "12h"
# cache-startup-queries:
# cache-batch-size: 0
# cache-batch-timeout: "0ms"

# If set, access to the ntfy server and API can be controlled on a granular level using
# the 'ntfy user' and 'ntfy access' commands. See the --help pages for details, or check the docs.
#
# - auth-file is the SQLite user/access database; it is created automatically if it doesn't already exist
# - auth-default-access defines the default/fallback access if no access control entry is found; it can be
#   set to "read-write" (default), "read-only", "write-only" or "deny-all".
# - auth-startup-queries allows you to run commands when the database is initialized, e.g. to enable
#   WAL mode. This is similar to cache-startup-queries. See above for details.
#
# Debian/RPM package users:
#   Use /var/lib/ntfy/user.db as user database to avoid permission issues. The package
#   creates this folder for you.
#
# Check your permissions:
#   If you are running ntfy with systemd, make sure this user database file is owned by the
#   ntfy user and group by running: chown ntfy.ntfy <filename>.
#
# auth-file: <filename>
# auth-default-access: "read-write"
# auth-startup-queries:

# If set, the X-Forwarded-For header is used to determine the visitor IP address
# instead of the remote address of the connection.
#
# WARNING: If you are behind a proxy, you must set this, otherwise all visitors are rate limited
#          as if they are one.
#
behind-proxy: true

# If enabled, clients can attach files to notifications as attachments. Minimum settings to enable attachments
# are "attachment-cache-dir" and "base-url".
#
# - attachment-cache-dir is the cache directory for attached files
# - attachment-total-size-limit is the limit of the on-disk attachment cache directory (total size)
# - attachment-file-size-limit is the per-file attachment size limit (e.g. 300k, 2M, 100M)
# - attachment-expiry-duration is the duration after which uploaded attachments will be deleted (e.g. 3h, 20h)
#
# attachment-cache-dir:
# attachment-total-size-limit: "5G"
# attachment-file-size-limit: "15M"
# attachment-expiry-duration: "3h"

# If enabled, allow outgoing e-mail notifications via the 'X-Email' header. If this header is set,
# messages will additionally be sent out as e-mail using an external SMTP server.
#
# As of today, only SMTP servers with plain text auth (or no auth at all), and STARTLS are supported.
# Please also refer to the rate limiting settings below (visitor-email-limit-burst & visitor-email-limit-burst).
#
# - smtp-sender-addr is the hostname:port of the SMTP server
# - smtp-sender-from is the e-mail address of the sender
# - smtp-sender-user/smtp-sender-pass are the username and password of the SMTP user (leave blank for no auth)
#
smtp-sender-addr: $SMTP_HOSTNAME:$SMTP_HOSTPORT
smtp-sender-from: $EMAIL_ADMIN_EMAIL_ADDRESS
# smtp-sender-user:
# smtp-sender-pass:

# If enabled, ntfy will launch a lightweight SMTP server for incoming messages. Once configured, users can send
# emails to a topic e-mail address to publish messages to a topic.
#
# - smtp-server-listen defines the IP address and port the SMTP server will listen on, e.g. :25 or 1.2.3.4:25
# - smtp-server-domain is the e-mail domain, e.g. ntfy.sh
# - smtp-server-addr-prefix is an optional prefix for the e-mail addresses to prevent spam. If set to "ntfy-",
#   for instance, only e-mails to ntfy-$topic@ntfy.sh will be accepted. If this is not set, all emails to
#   $topic@ntfy.sh will be accepted (which may obviously be a spam problem).
#
# smtp-server-listen:
# smtp-server-domain:
# smtp-server-addr-prefix:

# Web Push support (background notifications for browsers)
#
# If enabled, allows ntfy to receive push notifications, even when the ntfy web app is closed. When enabled, users
# can enable background notifications in the web app. Once enabled, ntfy will forward published messages to the push
# endpoint, which will then forward it to the browser.
#
# You must configure web-push-public/private key, web-push-file, and web-push-email-address below to enable Web Push.
# Run "ntfy webpush keys" to generate the keys.
#
# - web-push-public-key is the generated VAPID public key, e.g. AA1234BBCCddvveekaabcdfqwertyuiopasdfghjklzxcvbnm1234567890
# - web-push-private-key is the generated VAPID private key, e.g. AA2BB1234567890abcdefzxcvbnm1234567890
# - web-push-file is a database file to keep track of browser subscription endpoints, e.g. /var/cache/ntfy/webpush.db
# - web-push-email-address is the admin email address send to the push provider, e.g. sysadmin@example.com
# - web-push-startup-queries is an optional list of queries to run on startup
#
# web-push-public-key:
# web-push-private-key:
# web-push-file:
# web-push-email-address:
# web-push-startup-queries:

# If enabled, ntfy can perform voice calls via Twilio via the "X-Call" header.
#
# - twilio-account is the Twilio account SID, e.g. AC12345beefbeef67890beefbeef122586
# - twilio-auth-token is the Twilio auth token, e.g. affebeef258625862586258625862586
# - twilio-phone-number is the outgoing phone number you purchased, e.g. +18775132586
# - twilio-verify-service is the Twilio Verify service SID, e.g. VA12345beefbeef67890beefbeef122586
#
# twilio-account:
# twilio-auth-token:
# twilio-phone-number:
# twilio-verify-service:

# Interval in which keepalive messages are sent to the client. This is to prevent
# intermediaries closing the connection for inactivity.
#
# Note that the Android app has a hardcoded timeout at 77s, so it should be less than that.
#
# keepalive-interval: "45s"

# Interval in which the manager prunes old messages, deletes topics
# and prints the stats.
#
# manager-interval: "1m"

# Defines topic names that are not allowed, because they are otherwise used. There are a few default topics
# that cannot be used (e.g. app, account, settings, ...). To extend the default list, define them here.
#
# Example:
#   disallowed-topics:
#     - about
#     - pricing
#     - contact
#
# disallowed-topics:

# Defines the root path of the web app, or disables the web app entirely.
#
# Can be any simple path, e.g. "/", "/app", or "/ntfy". For backwards-compatibility reasons,
# the values "app" (maps to "/"), "home" (maps to "/app"), or "disable" (maps to "") to disable
# the web app entirely.
#
# web-root: /

# Various feature flags used to control the web app, and API access, mainly around user and
# account management.
#
# - enable-signup allows users to sign up via the web app, or API
# - enable-login allows users to log in via the web app, or API
# - enable-reservations allows users to reserve topics (if their tier allows it)
#
# enable-signup: false
# enable-login: false
# enable-reservations: false

# Server URL of a Firebase/APNS-connected ntfy server (likely "https://ntfy.sh").
#
# iOS users:
#   If you use the iOS ntfy app, you MUST configure this to receive timely notifications. You'll like want this:
#   upstream-base-url: "https://ntfy.sh"
#
# If set, all incoming messages will publish a "poll_request" message to the configured upstream server, containing
# the message ID of the original message, instructing the iOS app to poll this server for the actual message contents.
# This is to prevent the upstream server and Firebase/APNS from being able to read the message.
#
# - upstream-base-url is the base URL of the upstream server. Should be "https://ntfy.sh".
# - upstream-access-token is the token used to authenticate with the upstream server. This is only required
#   if you exceed the upstream rate limits, or the uptream server requires authentication.
#
upstream-base-url: "https://ntfy.sh"
# upstream-access-token:

# Rate limiting: Total number of topics before the server rejects new topics.
#
# global-topic-limit: 15000

# Rate limiting: Number of subscriptions per visitor (IP address)
#
# visitor-subscription-limit: 30

# Rate limiting: Allowed GET/PUT/POST requests per second, per visitor:
# - visitor-request-limit-burst is the initial bucket of requests each visitor has
# - visitor-request-limit-replenish is the rate at which the bucket is refilled
# - visitor-request-limit-exempt-hosts is a comma-separated list of hostnames, IPs or CIDRs to be
#   exempt from request rate limiting. Hostnames are resolved at the time the server is started.
#   Example: "1.2.3.4,ntfy.example.com,8.7.6.0/24"
#
# visitor-request-limit-burst: 60
# visitor-request-limit-replenish: "5s"
# visitor-request-limit-exempt-hosts: ""

# Rate limiting: Hard daily limit of messages per visitor and day. The limit is reset
# every day at midnight UTC. If the limit is not set (or set to zero), the request
# limit (see above) governs the upper limit.
#
# visitor-message-daily-limit: 0

# Rate limiting: Allowed emails per visitor:
# - visitor-email-limit-burst is the initial bucket of emails each visitor has
# - visitor-email-limit-replenish is the rate at which the bucket is refilled
#
# visitor-email-limit-burst: 16
# visitor-email-limit-replenish: "1h"

# Rate limiting: Attachment size and bandwidth limits per visitor:
# - visitor-attachment-total-size-limit is the total storage limit used for attachments per visitor
# - visitor-attachment-daily-bandwidth-limit is the total daily attachment download/upload traffic limit per visitor
#
# visitor-attachment-total-size-limit: "100M"
# visitor-attachment-daily-bandwidth-limit: "500M"

# Rate limiting: Enable subscriber-based rate limiting (mostly used for UnifiedPush)
#
# If enabled, subscribers may opt to have published messages counted against their own rate limits, as opposed
# to the publisher's rate limits. This is especially useful to increase the amount of messages that high-volume
# publishers (e.g. Matrix/Mastodon servers) are allowed to send.
#
# Once enabled, a client may send a "Rate-Topics: <topic1>,<topic2>,..." header when subscribing to topics via
# HTTP stream, or websockets, thereby registering itself as the "rate visitor", i.e. the visitor whose rate limits
# to use when publishing on this topic. Note: Setting the rate visitor requires READ-WRITE permission on the topic.
#
# UnifiedPush only: If this setting is enabled, publishing to UnifiedPush topics will lead to a HTTP 507 response if
# no "rate visitor" has been previously registered. This is to avoid burning the publisher's "visitor-message-daily-limit".
#
# visitor-subscriber-rate-limiting: false

# Payments integration via Stripe
#
# - stripe-secret-key is the key used for the Stripe API communication. Setting this values
#   enables payments in the ntfy web app (e.g. Upgrade dialog). See https://dashboard.stripe.com/apikeys.
# - stripe-webhook-key is the key required to validate the authenticity of incoming webhooks from Stripe.
#   Webhooks are essential up keep the local database in sync with the payment provider. See https://dashboard.stripe.com/webhooks.
# - billing-contact is an email address or website displayed in the "Upgrade tier" dialog to let people reach
#   out with billing questions. If unset, nothing will be displayed.
#
# stripe-secret-key:
# stripe-webhook-key:
# billing-contact:

# Metrics
#
# ntfy can expose Prometheus-style metrics via a /metrics endpoint, or on a dedicated listen IP/port.
# Metrics may be considered sensitive information, so before you enable them, be sure you know what you are
# doing, and/or secure access to the endpoint in your reverse proxy.
#
# - enable-metrics enables the /metrics endpoint for the default ntfy server (i.e. HTTP, HTTPS and/or Unix socket)
# - metrics-listen-http exposes the metrics endpoint via a dedicated [IP]:port. If set, this option implicitly
#   enables metrics as well, e.g. "10.0.1.1:9090" or ":9090"
#
# enable-metrics: false
# metrics-listen-http:

# Profiling
#
# ntfy can expose Go's net/http/pprof endpoints to support profiling of the ntfy server. If enabled, ntfy will listen
# on a dedicated listen IP/port, which can be accessed via the web browser on http://<ip>:<port>/debug/pprof/.
# This can be helpful to expose bottlenecks, and visualize call flows. See https://pkg.go.dev/net/http/pprof for details.
#
# profile-listen-http:

# Logging options
#
# By default, ntfy logs to the console (stderr), with an "info" log level, and in a human-readable text format.
# ntfy supports five different log levels, can also write to a file, log as JSON, and even supports granular
# log level overrides for easier debugging. Some options (log-level and log-level-overrides) can be hot reloaded
# by calling "kill -HUP $pid" or "systemctl reload ntfy".
#
# - log-format defines the output format, can be "text" (default) or "json"
# - log-file is a filename to write logs to. If this is not set, ntfy logs to stderr.
# - log-level defines the default log level, can be one of "trace", "debug", "info" (default), "warn" or "error".
#   Be aware that "debug" (and particularly "trace") can be VERY CHATTY. Only turn them on briefly for debugging purposes.
# - log-level-overrides lets you override the log level if certain fields match. This is incredibly powerful
#   for debugging certain parts of the system (e.g. only the account management, or only a certain visitor).
#   This is an array of strings in the format:
#      - "field=value -> level" to match a value exactly, e.g. "tag=manager -> trace"
#      - "field -> level" to match any value, e.g. "time_taken_ms -> debug"
#   Warning: Using log-level-overrides has a performance penalty. Only use it for temporary debugging.
#
# Check your permissions:
#   If you are running ntfy with systemd, make sure this log file is owned by the
#   ntfy user and group by running: chown ntfy.ntfy <filename>.
#
# Example (good for production):
#   log-level: info
#   log-format: json
#   log-file: /var/log/ntfy.log
#
# Example level overrides (for debugging, only use temporarily):
#   log-level-overrides:
#      - "tag=manager -> trace"
#      - "visitor_ip=1.2.3.4 -> debug"
#      - "time_taken_ms -> debug"
#
# log-level: info
# log-level-overrides:
# log-format: text
# log-file:

EOFNT

}

function performUpdateNTFY()
{
  perform_stack_name=ntfy
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=binwiederhier/ntfy:v2.7.0
      image_update_map[0]="binwiederhier/ntfy:v2.7.0,binwiederhier/ntfy:v2.11.0"
    ;;
    2)
      newVer=v4
      curImageList=binwiederhier/ntfy:v2.8.0
      image_update_map[0]="binwiederhier/ntfy:v2.8.0,binwiederhier/ntfy:v2.11.0"
    ;;
    3)
      newVer=v4
      curImageList=binwiederhier/ntfy:v2.9.0
      image_update_map[0]="binwiederhier/ntfy:v2.9.0,binwiederhier/ntfy:v2.11.0"
    ;;
    4)
      newVer=v4
      curImageList=binwiederhier/ntfy:v2.11.0
      image_update_map[0]="binwiederhier/ntfy:v2.11.0,binwiederhier/ntfy:v2.11.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# ITTools
function installITTools()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory ittools "ITTools"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName ittools)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/ittools
  outputConfigITTools
  installStack ittools ittools "" $HOME/ittools.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3
  inner_block=""
  inner_block=$inner_block">>https://$SUB_ITTOOLS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://ittools {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_ITTOOLS $MANAGETLS_ITTOOLS "$is_integrate_hshq" $NETDEFAULT_ITTOOLS "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll ittools "$FMLNAME_ITTOOLS" $USERTYPE_ITTOOLS "https://$SUB_ITTOOLS.$HOMESERVER_DOMAIN" "ittools.png" "$(getHeimdallOrderFromSub $SUB_ITTOOLS $USERTYPE_ITTOOLS)"
    restartAllCaddyContainers
  fi
}

function outputConfigITTools()
{
  cat <<EOFNT > $HOME/ittools-compose.yml
$STACK_VERSION_PREFIX ittools $(getScriptStackVersion ittools)

services:
  ittools:
    image: $(getScriptImageByContainerName ittools)
    container_name: ittools
    hostname: ittools
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true


EOFNT

  cat <<EOFNT > $HOME/ittools.env
UID=$USERID
GID=$GROUPID
EOFNT

}

function performUpdateITTools()
{
  perform_stack_name=ittools
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=ghcr.io/corentinth/it-tools:latest
      image_update_map[0]="ghcr.io/corentinth/it-tools:latest,ghcr.io/corentinth/it-tools:latest"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Remotely
function installRemotely()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory remotely "Remotely"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName remotely)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/remotely
  initServicesCredentials
  docker exec mailu-admin flask mailu alias-delete $REMOTELY_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $REMOTELY_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$REMOTELY_INIT_ENV" = "true" ]; then
    sendEmail -s "Remotely Admin Login Info" -b "Remotely Admin Username: $REMOTELY_ADMIN_EMAIL_ADDRESS\nRemotely Admin Password: $REMOTELY_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    REMOTELY_INIT_ENV=true
    updateConfigVar REMOTELY_INIT_ENV $REMOTELY_INIT_ENV
  fi
  outputConfigRemotely
  installStack remotely remotely "No XML encryptor configured" $HOME/remotely.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Sleeping 10 seconds..."
  sleep 10

  startStopStack remotely stop
  sudo sqlite3 $HSHQ_STACKS_DIR/remotely/Remotely.db "update KeyValueRecords set Value='{\"AllowApiLogin\":false,\"BannedDevices\":[],\"DataRetentionInDays\":90,\"DbProvider\":\"SQLite\",\"EnableRemoteControlRecording\":false,\"EnableWindowsEventLog\":false,\"EnforceAttendedAccess\":false,\"ForceClientHttps\":true,\"KnownProxies\":[],\"MaxConcurrentUpdates\":10,\"MaxOrganizationCount\":1,\"MessageOfTheDay\":\"\",\"RedirectToHttps\":false,\"RemoteControlNotifyUser\":true,\"RemoteControlRequiresAuthentication\":true,\"RemoteControlSessionLimit\":5,\"Require2FA\":false,\"ServerUrl\":\"https://$SUB_REMOTELY.$HOMESERVER_DOMAIN\",\"SmtpCheckCertificateRevocation\":false,\"SmtpDisplayName\":\"Remotely $(getAdminEmailName)\",\"SmtpEmail\":\"$EMAIL_ADMIN_EMAIL_ADDRESS\",\"SmtpHost\":\"$SMTP_HOSTNAME\",\"SmtpLocalDomain\":\"\",\"SmtpPassword\":\"\",\"SmtpPort\":$SMTP_HOSTPORT,\"SmtpUserName\":\"\",\"Theme\":0,\"TrustedCorsOrigins\":[],\"UseHsts\":false,\"UseHttpLogging\":false}';"
  startStopStack remotely start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_REMOTELY.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://remotely:5000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_REMOTELY $MANAGETLS_REMOTELY "$is_integrate_hshq" $NETDEFAULT_REMOTELY "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll remotely "$FMLNAME_REMOTELY" $USERTYPE_REMOTELY "https://$SUB_REMOTELY.$HOMESERVER_DOMAIN" "remotely.png" "$(getHeimdallOrderFromSub $SUB_REMOTELY $USERTYPE_REMOTELY)"
    restartAllCaddyContainers
  fi
}

function outputConfigRemotely()
{
  cat <<EOFRM > $HOME/remotely-compose.yml
$STACK_VERSION_PREFIX remotely $(getScriptStackVersion remotely)

services:
  remotely:
    image: $(getScriptImageByContainerName remotely)
    container_name: remotely
    hostname: remotely
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/remotely:/app/AppData

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
EOFRM

  cat <<EOFRM > $HOME/remotely.env
TZ=\${TZ}
ASPNETCORE_ENVIRONMENT=Production
ASPNETCORE_HTTP_PORTS=5000
Remotely_ApplicationOptions__DbProvider=SQLite
Remotely_ConnectionStrings__SQLite=Data Source=/app/AppData/Remotely.db
EOFRM

}

function performUpdateRemotely()
{
  perform_stack_name=remotely
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=immybot/remotely:69
      image_update_map[0]="immybot/remotely:69,immybot/remotely:69"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Remotely cannot be upgraded to the next version. You must uninstall your current version and reinstall the new version."
      return
    ;;
    2)
      newVer=v3
      curImageList=immybot/remotely:88
      image_update_map[0]="immybot/remotely:88,immybot/remotely:589"
    ;;
    3)
      newVer=v4
      curImageList=immybot/remotely:589
      image_update_map[0]="immybot/remotely:589,immybot/remotely:1037"
    ;;
    4)
      newVer=v4
      curImageList=immybot/remotely:1037
      image_update_map[0]="immybot/remotely:1037,immybot/remotely:1037"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Calibre
function installCalibre()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory calibre "Calibre"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName calibre-server)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName calibre-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/calibre
  mkdir $HSHQ_STACKS_DIR/calibre/server
  mkdir $HSHQ_STACKS_DIR/calibre/library
  mkdir $HSHQ_STACKS_DIR/calibre/web

  initServicesCredentials

  set +e
  docker exec mailu-admin flask mailu alias-delete $CALIBRE_WEB_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $CALIBRE_WEB_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$CALIBRE_WEB_INIT_ENV" = "true" ]; then
    sendEmail -s "Calibre-Web Admin Login Info" -b "Calibre-Web Admin Username: $CALIBRE_WEB_ADMIN_USERNAME\nCalibre-Web Admin Password: $CALIBRE_WEB_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    CALIBRE_WEB_INIT_ENV=true
    updateConfigVar CALIBRE_WEB_INIT_ENV $CALIBRE_WEB_INIT_ENV
  fi

  outputConfigCalibre
  generateCert calibre-web calibre-web
  installStack calibre calibre-web "done." $HOME/calibre.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "Calibre stack installed, sleeping 10 seconds..."
  sleep 10

  docker exec -it calibre-web python3 /app/calibre-web/cps.py -p /config/app.db -s admin:$CALIBRE_WEB_ADMIN_PASSWORD
  encpw=$(docker exec -it calibre-web python3 /config/getencpw.py)
  encpw=${encpw:2:${#encpw}-4}
  startStopStack calibre stop
  cat $HSHQ_STACKS_DIR/calibre/server/.config/calibre/global.py.json | jq '.library_path |= "/library"' > $HOME/calibre_new.json
  mv -f $HOME/calibre_new.json $HSHQ_STACKS_DIR/calibre/server/.config/calibre/global.py.json
  
  rm $HSHQ_STACKS_DIR/calibre/web/getencpw.py
  sqlite3 $HSHQ_STACKS_DIR/calibre/web/app.db "UPDATE user set name='$CALIBRE_WEB_ADMIN_USERNAME', email='$CALIBRE_WEB_ADMIN_EMAIL_ADDRESS', kindle_mail='$CALIBRE_WEB_ADMIN_EMAIL_ADDRESS' where id=1;"
  sqlite3 $HSHQ_STACKS_DIR/calibre/web/app.db "UPDATE settings set mail_server='$SMTP_HOSTNAME', mail_port=$SMTP_HOSTPORT, mail_use_ssl=1, mail_from='Calibre-Web $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>', mail_size=26214400, mail_server_type=0, config_calibre_dir='/library', config_theme=1, config_login_type=1, config_ldap_provider_url='ldapserver', config_ldap_port=389, config_ldap_authentication=2, config_ldap_serv_username='$LDAP_READONLY_USER_BIND_DN', config_ldap_serv_password_e='$encpw', config_ldap_encryption=1, config_ldap_cacert_path='/usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt', config_ldap_cert_path='/certs/calibre-web.crt', config_ldap_key_path='/certs/calibre-web.key', config_ldap_dn='$LDAP_BASE_DN', config_ldap_user_object='(&(objectclass=person)(uid=%s))', config_ldap_member_user_object='(&(objectclass=person)(uid=%s))', config_ldap_openldap=1, config_ldap_group_object_filter='(&(objectclass=groupOfUniqueNames)(cn=%s))', config_ldap_group_members_field='uniqueMember', config_ldap_group_name='$LDAP_PRIMARY_USER_GROUP_NAME' where id=1;"
  startStopStack calibre start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_CALIBRE_SERVER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://calibre-server:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_CALIBRE_SERVER $MANAGETLS_CALIBRE_SERVER "$is_integrate_hshq" $NETDEFAULT_CALIBRE_SERVER "$inner_block"
  insertSubAuthelia $SUB_CALIBRE_SERVER.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://calibre-web:8083 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_CALIBRE_WEB $MANAGETLS_CALIBRE_WEB "$is_integrate_hshq" $NETDEFAULT_CALIBRE_WEB "$inner_block"
  insertSubAuthelia $SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll calibre "$FMLNAME_CALIBRE_SERVER" $USERTYPE_CALIBRE_SERVER "https://$SUB_CALIBRE_SERVER.$HOMESERVER_DOMAIN" "calibre-server.png" "$(getHeimdallOrderFromSub $SUB_CALIBRE_SERVER $USERTYPE_CALIBRE_SERVER)"
    insertEnableSvcAll calibre "$FMLNAME_CALIBRE_WEB" $USERTYPE_CALIBRE_WEB "https://$SUB_CALIBRE_WEB.$HOMESERVER_DOMAIN" "calibre-web.png" "$(getHeimdallOrderFromSub $SUB_CALIBRE_WEB $USERTYPE_CALIBRE_WEB)"
    restartAllCaddyContainers
  fi
}

function outputConfigCalibre()
{
  cat <<EOFNT > $HOME/calibre-compose.yml
$STACK_VERSION_PREFIX calibre $(getScriptStackVersion calibre)

services:
  calibre-server:
    image: $(getScriptImageByContainerName calibre-server)
    container_name: calibre-server
    hostname: calibre-server
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/calibre/server:/config
      - \${HSHQ_STACKS_DIR}/calibre/library:/library

  calibre-web:
    image: $(getScriptImageByContainerName calibre-web)
    container_name: calibre-web
    hostname: calibre-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-ldap-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/calibre-web.crt:/certs/calibre-web.crt:ro
      - \${HSHQ_SSL_DIR}/calibre-web.key:/certs/calibre-web.key:ro
      - \${HSHQ_STACKS_DIR}/calibre/web:/config
      - \${HSHQ_STACKS_DIR}/calibre/library:/library

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true

EOFNT

  cat <<EOFNT > $HOME/calibre.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
CALIBRE_LDAP_AUTO_CREATE=true
EOFNT

  cat <<EOFPY > $HSHQ_STACKS_DIR/calibre/web/getencpw.py
from cryptography.fernet import Fernet
import cryptography.exceptions
from base64 import urlsafe_b64decode
f = open("/config/.key", "r")
key = f.read()
f.close()
crypter = Fernet(key)
configpw = "$LDAP_READONLY_USER_PASSWORD"
configpw_e=crypter.encrypt(configpw.encode())
print(configpw_e)
EOFPY

}

function performUpdateCalibre()
{
  perform_stack_name=calibre
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=linuxserver/calibre:7.3.0,linuxserver/calibre-web:0.6.21
      image_update_map[0]="linuxserver/calibre:7.3.0,linuxserver/calibre:7.20.0"
      image_update_map[1]="linuxserver/calibre-web:0.6.21,linuxserver/calibre-web:0.6.23"
    ;;
    2)
      newVer=v5
      curImageList=linuxserver/calibre:7.4.0,linuxserver/calibre-web:0.6.21
      image_update_map[0]="linuxserver/calibre:7.4.0,linuxserver/calibre:7.20.0"
      image_update_map[1]="linuxserver/calibre-web:0.6.21,linuxserver/calibre-web:0.6.23"
    ;;
    3)
      newVer=v5
      curImageList=linuxserver/calibre:7.7.0,linuxserver/calibre-web:0.6.21-ls257
      image_update_map[0]="linuxserver/calibre:7.7.0,linuxserver/calibre:7.20.0"
      image_update_map[1]="linuxserver/calibre-web:0.6.21-ls257,linuxserver/calibre-web:0.6.23"
    ;;
    4)
      newVer=v5
      curImageList=linuxserver/calibre:7.16.0,linuxserver/calibre-web:0.6.22
      image_update_map[0]="linuxserver/calibre:7.16.0,linuxserver/calibre:7.20.0"
      image_update_map[1]="linuxserver/calibre-web:0.6.22,linuxserver/calibre-web:0.6.23"
    ;;
    5)
      newVer=v6
      curImageList=linuxserver/calibre:7.20.0,linuxserver/calibre-web:0.6.23
      image_update_map[0]="linuxserver/calibre:7.20.0,linuxserver/calibre:8.2.1"
      image_update_map[1]="linuxserver/calibre-web:0.6.23,linuxserver/calibre-web:0.6.24"
    ;;
    6)
      newVer=v6
      curImageList=linuxserver/calibre:8.2.1,linuxserver/calibre-web:0.6.24
      image_update_map[0]="linuxserver/calibre:8.2.1,linuxserver/calibre:8.2.1"
      image_update_map[1]="linuxserver/calibre-web:0.6.24,linuxserver/calibre-web:0.6.24"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Netdata
function installNetdata()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory netdata "Netdata"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName netdata)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/netdata
  mkdir $HSHQ_STACKS_DIR/netdata/config
  mkdir $HSHQ_STACKS_DIR/netdata/lib
  mkdir $HSHQ_NONBACKUP_DIR/netdata
  mkdir $HSHQ_NONBACKUP_DIR/netdata/cache

  outputConfigNetdata
  installStack netdata netdata "" $HOME/netdata.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_NETDATA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://netdata:19999 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_NETDATA $MANAGETLS_NETDATA "$is_integrate_hshq" $NETDEFAULT_NETDATA "$inner_block"
  insertSubAuthelia $SUB_NETDATA.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll netdata "$FMLNAME_NETDATA" $USERTYPE_NETDATA "https://$SUB_NETDATA.$HOMESERVER_DOMAIN" "netdata.png" "$(getHeimdallOrderFromSub $SUB_NETDATA $USERTYPE_NETDATA)"
    restartAllCaddyContainers
  fi
}

function outputConfigNetdata()
{
  cat <<EOFDZ > $HOME/netdata-compose.yml
$STACK_VERSION_PREFIX netdata $(getScriptStackVersion netdata)

services:
  netdata:
    image: $(getScriptImageByContainerName netdata)
    container_name: netdata
    hostname: netdata
    restart: unless-stopped
    pid: host
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    networks:
      - dock-proxy-net
      - dock-privateip-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - v-netdata-config:/etc/netdata
      - v-netdata-lib:/var/lib/netdata
      - v-netdata-cache:/var/cache/netdata

volumes:
  v-netdata-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/netdata/config
  v-netdata-lib:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/netdata/lib
  v-netdata-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/netdata/cache

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true

EOFDZ

  cat <<EOFDZ > $HOME/netdata.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
EOFDZ

}

function performUpdateNetdata()
{
  perform_stack_name=netdata
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=netdata/netdata:v1.44.1
      image_update_map[0]="netdata/netdata:v1.44.1,netdata/netdata:v2.3.2"
    ;;
    2)
      newVer=v5
      curImageList=netdata/netdata:v1.44.3
      image_update_map[0]="netdata/netdata:v1.44.3,netdata/netdata:v2.3.2"
    ;;
    3)
      newVer=v5
      curImageList=netdata/netdata:v1.46.3
      image_update_map[0]="netdata/netdata:v1.46.3,netdata/netdata:v2.3.2"
    ;;
    4)
      newVer=v5
      curImageList=netdata/netdata:v1.47.5
      image_update_map[0]="netdata/netdata:v1.47.5,netdata/netdata:v2.3.2"
    ;;
    5)
      newVer=v5
      curImageList=netdata/netdata:v2.3.2
      image_update_map[0]="netdata/netdata:v2.3.2,netdata/netdata:v2.3.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Linkwarden
function installLinkwarden()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory linkwarden "$FMLNAME_LINKWARDEN"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName linkwarden-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName linkwarden-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/linkwarden
  mkdir $HSHQ_STACKS_DIR/linkwarden/db
  mkdir $HSHQ_STACKS_DIR/linkwarden/dbexport
  mkdir $HSHQ_STACKS_DIR/linkwarden/app
  chmod 777 $HSHQ_STACKS_DIR/linkwarden/dbexport

  initServicesCredentials
  if [ -z "$LINKWARDEN_NEXTAUTH_SECRET" ]; then
    LINKWARDEN_NEXTAUTH_SECRET=$(pwgen -c -n 32 1)
    updateConfigVar LINKWARDEN_NEXTAUTH_SECRET $LINKWARDEN_NEXTAUTH_SECRET
  fi
  
  LINKWARDEN_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $LINKWARDEN_OIDC_CLIENT_SECRET | tr -d ':\n')
  outputConfigLinkwarden
  oidcBlock=$(cat $HOME/linkwarden.oidc)
  rm -f $HOME/linkwarden.oidc
  insertOIDCClientAuthelia linkwarden "$oidcBlock"

  installStack linkwarden linkwarden "" $HOME/linkwarden.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_LINKWARDEN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://linkwarden-app:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_LINKWARDEN $MANAGETLS_LINKWARDEN "$is_integrate_hshq" $NETDEFAULT_LINKWARDEN "$inner_block"
  insertSubAuthelia $SUB_LINKWARDEN.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll linkwarden "$FMLNAME_LINKWARDEN" $USERTYPE_LINKWARDEN "https://$SUB_LINKWARDEN.$HOMESERVER_DOMAIN" "linkwarden.png" "$(getHeimdallOrderFromSub $SUB_LINKWARDEN $USERTYPE_LINKWARDEN)"
    restartAllCaddyContainers
    checkAddDBConnection true linkwarden "$FMLNAME_LINKWARDEN" postgres linkwarden-db $LINKWARDEN_DATABASE_NAME $LINKWARDEN_DATABASE_USER $LINKWARDEN_DATABASE_USER_PASSWORD
  fi
}

function outputConfigLinkwarden()
{
  cat <<EOFDZ > $HOME/linkwarden-compose.yml
$STACK_VERSION_PREFIX linkwarden $(getScriptStackVersion linkwarden)

services:
  linkwarden-db:
    image: $(getScriptImageByContainerName linkwarden-db)
    container_name: linkwarden-db
    hostname: linkwarden-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-linkwarden-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/linkwarden/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/linkwarden/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.linkwarden-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.linkwarden-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.linkwarden-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.linkwarden-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.linkwarden-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.linkwarden-hourly-db.email-from=Linkwarden Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.linkwarden-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.linkwarden-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.linkwarden-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.linkwarden-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.linkwarden-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.linkwarden-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.linkwarden-monthly-db.email-from=Linkwarden Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.linkwarden-monthly-db.mail-only-on-error=false"

  linkwarden-app:
    image: $(getScriptImageByContainerName linkwarden-app)
    container_name: linkwarden-app
    hostname: linkwarden-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - linkwarden-db
    networks:
      - int-linkwarden-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-linkwarden-app:/data/data

volumes:
  v-linkwarden-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/linkwarden/app

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-linkwarden-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFDZ

  cat <<EOFDZ > $HOME/linkwarden.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$LINKWARDEN_DATABASE_NAME
POSTGRES_USER=$LINKWARDEN_DATABASE_USER
POSTGRES_PASSWORD=$LINKWARDEN_DATABASE_USER_PASSWORD
DATABASE_URL=postgresql://$LINKWARDEN_DATABASE_USER:$LINKWARDEN_DATABASE_USER_PASSWORD@linkwarden-db:5432/$LINKWARDEN_DATABASE_NAME
NEXTAUTH_SECRET=$LINKWARDEN_NEXTAUTH_SECRET
NEXTAUTH_URL=https://$SUB_LINKWARDEN.$HOMESERVER_DOMAIN/api/v1/auth
NEXT_PUBLIC_AUTHELIA_ENABLED=true
AUTHELIA_WELLKNOWN_URL=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/.well-known/openid-configuration
AUTHELIA_CLIENT_ID=linkwarden
AUTHELIA_CLIENT_SECRET=$LINKWARDEN_OIDC_CLIENT_SECRET
NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
NEXT_PUBLIC_DISABLE_REGISTRATION=true
EOFDZ

  cat <<EOFIM > $HOME/linkwarden.oidc
# Authelia OIDC Client linkwarden BEGIN
      - client_id: linkwarden
        client_name: Linkwarden
        client_secret: '$LINKWARDEN_OIDC_CLIENT_SECRET_HASH'
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        consent_mode: implicit
        scopes:
          - openid
          - groups
          - email
          - profile
        redirect_uris:
          - https://$SUB_LINKWARDEN.$HOMESERVER_DOMAIN/api/v1/auth/callback/authelia
        userinfo_signed_response_alg: none
# Authelia OIDC Client linkwarden END
EOFIM

}

function performUpdateLinkwarden()
{
  perform_stack_name=linkwarden
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.4.8
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.4.8,ghcr.io/linkwarden/linkwarden:v2.6.2"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.4.9
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.4.9,ghcr.io/linkwarden/linkwarden:v2.6.2"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.5.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.5.1,ghcr.io/linkwarden/linkwarden:v2.6.2"
    ;;
    4)
      newVer=v6
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.6.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.6.2,ghcr.io/linkwarden/linkwarden:v2.9.3"
    ;;
    5)
      newVer=v6
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.7.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.7.1,ghcr.io/linkwarden/linkwarden:v2.9.3"
    ;;
    6)
      newVer=v6
      curImageList=postgres:15.0-bullseye,ghcr.io/linkwarden/linkwarden:v2.9.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/linkwarden/linkwarden:v2.9.3,ghcr.io/linkwarden/linkwarden:v2.9.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# StirlingPDF
function installStirlingPDF()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory stirlingpdf "StirlingPDF"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName stirlingpdf)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/stirlingpdf
  mkdir $HSHQ_STACKS_DIR/stirlingpdf/configs
  mkdir $HSHQ_NONBACKUP_DIR/stirlingpdf
  mkdir $HSHQ_NONBACKUP_DIR/stirlingpdf/logs
  mkdir $HSHQ_NONBACKUP_DIR/stirlingpdf/traindata

  outputConfigStirlingPDF
  installStack stirlingpdf stirlingpdf "" $HOME/stirlingpdf.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_STIRLINGPDF.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://stirlingpdf:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_STIRLINGPDF $MANAGETLS_STIRLINGPDF "$is_integrate_hshq" $NETDEFAULT_STIRLINGPDF "$inner_block"
  insertSubAuthelia $SUB_STIRLINGPDF.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll stirlingpdf "$FMLNAME_STIRLINGPDF" $USERTYPE_STIRLINGPDF "https://$SUB_STIRLINGPDF.$HOMESERVER_DOMAIN" "stirlingpdf.png" "$(getHeimdallOrderFromSub $SUB_STIRLINGPDF $USERTYPE_STIRLINGPDF)"
    restartAllCaddyContainers
  fi
}

function outputConfigStirlingPDF()
{
  cat <<EOFDZ > $HOME/stirlingpdf-compose.yml
$STACK_VERSION_PREFIX stirlingpdf $(getScriptStackVersion stirlingpdf)

services:
  stirlingpdf:
    image: $(getScriptImageByContainerName stirlingpdf)
    container_name: stirlingpdf
    hostname: stirlingpdf
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/stirlingpdf/configs:/configs
      - \${HSHQ_NONBACKUP_DIR}/stirlingpdf/logs:/logs
      - \${HSHQ_NONBACKUP_DIR}/stirlingpdf/traindata:/usr/share/tesseract-ocr/5/tessdata

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true

EOFDZ

  cat <<EOFDZ > $HOME/stirlingpdf.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
EOFDZ

}

function performUpdateStirlingPDF()
{
  perform_stack_name=stirlingpdf
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v6
      curImageList=frooodle/s-pdf:0.19.0
      image_update_map[0]="frooodle/s-pdf:0.19.0,frooodle/s-pdf:0.45.0"
    ;;
    2)
      newVer=v6
      curImageList=frooodle/s-pdf:0.20.1
      image_update_map[0]="frooodle/s-pdf:0.20.1,frooodle/s-pdf:0.45.0"
    ;;
    3)
      newVer=v6
      curImageList=frooodle/s-pdf:0.22.2
      image_update_map[0]="frooodle/s-pdf:0.22.2,frooodle/s-pdf:0.45.0"
    ;;
    4)
      newVer=v6
      curImageList=frooodle/s-pdf:0.26.1
      image_update_map[0]="frooodle/s-pdf:0.26.1,frooodle/s-pdf:0.45.0"
    ;;
    5)
      newVer=v6
      curImageList=frooodle/s-pdf:0.31.1
      image_update_map[0]="frooodle/s-pdf:0.31.1,frooodle/s-pdf:0.45.0"
    ;;
    6)
      newVer=v6
      curImageList=frooodle/s-pdf:0.45.0
      image_update_map[0]="frooodle/s-pdf:0.45.0,frooodle/s-pdf:0.45.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# BarAssistant
function installBarAssistant()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory bar-assistant "Bar Assistant"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName bar-assistant-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName bar-assistant-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName bar-assistant-meilisearch)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName bar-assistant-saltrim)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName bar-assistant-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/bar-assistant
  mkdir $HSHQ_STACKS_DIR/bar-assistant/app
  mkdir $HSHQ_STACKS_DIR/bar-assistant/meilisearch
  mkdir $HSHQ_STACKS_DIR/bar-assistant/web
  mkdir $HSHQ_NONBACKUP_DIR/bar-assistant
  mkdir $HSHQ_NONBACKUP_DIR/bar-assistant/redis

  if [ -z "$BARASSISTANT_REDIS_PASSWORD" ]; then
    BARASSISTANT_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar BARASSISTANT_REDIS_PASSWORD $BARASSISTANT_REDIS_PASSWORD
  fi
  if [ -z "$BARASSISTANT_MEILISEARCH_KEY" ]; then
    BARASSISTANT_MEILISEARCH_KEY=$(pwgen -c -n 64 1)
    updateConfigVar BARASSISTANT_MEILISEARCH_KEY $BARASSISTANT_MEILISEARCH_KEY
  fi

  outputConfigBarAssistant
  installStack bar-assistant bar-assistant-app "ready to handle connections" $HOME/bar-assistant.env 10
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_BARASSISTANT.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://bar-assistant-web:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_BARASSISTANT $MANAGETLS_BARASSISTANT "$is_integrate_hshq" $NETDEFAULT_BARASSISTANT "$inner_block"
  insertSubAuthelia $SUB_BARASSISTANT.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll bar-assistant "$FMLNAME_BARASSISTANT" $USERTYPE_BARASSISTANT "https://$SUB_BARASSISTANT.$HOMESERVER_DOMAIN" "bar-assistant.png" "$(getHeimdallOrderFromSub $SUB_BARASSISTANT $USERTYPE_BARASSISTANT)"
    restartAllCaddyContainers
  fi
}

function outputConfigBarAssistant()
{
  cat <<EOFBA > $HOME/bar-assistant-compose.yml
$STACK_VERSION_PREFIX bar-assistant $(getScriptStackVersion bar-assistant)

services:
  bar-assistant-app:
    image: $(getScriptImageByContainerName bar-assistant-app)
    container_name: bar-assistant-app
    hostname: bar-assistant-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - bar-assistant-meilisearch
      - bar-assistant-redis
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - int-bar-assistant-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-bar-assistant-app:/var/www/cocktails/storage/bar-assistant

  bar-assistant-meilisearch:
    image: $(getScriptImageByContainerName bar-assistant-meilisearch)
    container_name: bar-assistant-meilisearch
    hostname: bar-assistant-meilisearch
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7700"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - int-bar-assistant-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-bar-assistant-meilisearch:/meili_data

  bar-assistant-redis:
    image: $(getScriptImageByContainerName bar-assistant-redis)
    container_name: bar-assistant-redis
    hostname: bar-assistant-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-bar-assistant-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-bar-assistant-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$BARASSISTANT_REDIS_PASSWORD

  bar-assistant-saltrim:
    image: $(getScriptImageByContainerName bar-assistant-saltrim)
    container_name: bar-assistant-saltrim
    hostname: bar-assistant-saltrim
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - bar-assistant-app
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - int-bar-assistant-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  bar-assistant-web:
    image: $(getScriptImageByContainerName bar-assistant-web)
    container_name: bar-assistant-web
    hostname: bar-assistant-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-bar-assistant-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - bar-assistant-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/bar-assistant/web/nginx.conf:/etc/nginx/conf.d/default.conf

volumes:
  v-bar-assistant-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/bar-assistant/app
  v-bar-assistant-meilisearch:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/bar-assistant/meilisearch
  v-bar-assistant-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/bar-assistant/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-bar-assistant-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFBA

  cat <<EOFBA > $HOME/bar-assistant.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
BASE_URL=https://$SUB_BARASSISTANT.$HOMESERVER_DOMAIN
APP_URL=\${BASE_URL}
DEFAULT_LOCALE=en-US
LOG_CHANNEL=stderr
API_URL=\${BASE_URL}/bar
MEILISEARCH_URL=\${BASE_URL}/search
MEILI_MASTER_KEY=$BARASSISTANT_MEILISEARCH_KEY
MEILI_ENV=production
MEILISEARCH_KEY=$BARASSISTANT_MEILISEARCH_KEY
MEILISEARCH_HOST=http://bar-assistant-meilisearch:7700
REDIS_HOST=bar-assistant-redis
REDIS_PASSWORD=$BARASSISTANT_REDIS_PASSWORD
ALLOW_REGISTRATION=true
MAIL_MAILER=smtp
MAILS_ENABLED=true
MAIL_FROM_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
MAIL_FROM_NAME=Bar Assistant $(getAdminEmailName)
MAIL_HOST=$SMTP_HOSTNAME
MAIL_PORT=$SMTP_HOSTPORT
MAIL_ENCRYPTION=tls
MAIL_REQUIRE_CONFIRMATION=true
MAIL_CONFIRM_URL=\${BASE_URL}/confirmation/[id]/[hash]
MAIL_RESET_URL=\${BASE_URL}/reset-password?token=[token]
EOFBA

  cat <<EOFBA > $HSHQ_STACKS_DIR/bar-assistant/web/nginx.conf
server {
    listen 3000 default_server;
    listen [::]:3000 default_server;
    server_name _;

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    client_max_body_size 100M;

    location /bar/ {
        proxy_pass http://bar-assistant-app:8080/;
    }

    location /uploads/ {
        proxy_pass http://bar-assistant-app:8080;
    }

    location /search/ {
        proxy_pass http://bar-assistant-meilisearch:7700/;
    }

    location / {
        proxy_pass http://bar-assistant-saltrim:8080/;
    }
}
EOFBA

}

function performUpdateBarAssistant()
{
  perform_stack_name=bar-assistant
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      # Meilisearch has a more recent version, v1.6. However, moving between versions requires manual migration.
      # So, we'll use v1.4 until the migration process has been mapped out.
      # See https://www.meilisearch.com/docs/learn/cookbooks/docker#generating-dumps-and-updating-meilisearch 
      newVer=v3
      curImageList=barassistant/server:v3,getmeili/meilisearch:v1.4,bitnami/redis:7.0.5,barassistant/salt-rim:v2,nginx:1.25.3-alpine
      image_update_map[0]="barassistant/server:v3,barassistant/server:3.11.0"
      image_update_map[1]="getmeili/meilisearch:v1.4,getmeili/meilisearch:v1.6"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="barassistant/salt-rim:v2,barassistant/salt-rim:2.15.0"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
    ;;
    2)
      newVer=v3
      curImageList=barassistant/server:3.11.0,getmeili/meilisearch:v1.6,bitnami/redis:7.0.5,barassistant/salt-rim:2.11.0,nginx:1.25.3-alpine
      image_update_map[0]="barassistant/server:3.11.0,barassistant/server:3.17.1"
      image_update_map[1]="getmeili/meilisearch:v1.6,getmeili/meilisearch:v1.6"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="barassistant/salt-rim:2.11.0,barassistant/salt-rim:2.15.0"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
    ;;
    3)
      newVer=v4
      curImageList=barassistant/server:3.17.1,getmeili/meilisearch:v1.6,bitnami/redis:7.0.5,barassistant/salt-rim:2.15.0,nginx:1.25.3-alpine
      image_update_map[0]="barassistant/server:3.17.1,barassistant/server:4.0.3"
      image_update_map[1]="getmeili/meilisearch:v1.6,getmeili/meilisearch:v1.6"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
      image_update_map[3]="barassistant/salt-rim:2.15.0,barassistant/salt-rim:3.2.1"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.25.3-alpine"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfUpdateBarAssistantV4
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    4)
      newVer=v5
      curImageList=barassistant/server:4.0.3,getmeili/meilisearch:v1.6,bitnami/redis:7.0.5,barassistant/salt-rim:3.2.1,nginx:1.25.3-alpine
      image_update_map[0]="barassistant/server:4.0.3,barassistant/server:5.2.0"
      image_update_map[1]="getmeili/meilisearch:v1.6,getmeili/meilisearch:v1.13.3"
      image_update_map[2]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[3]="barassistant/salt-rim:3.2.1,barassistant/salt-rim:4.1.0"
      image_update_map[4]="nginx:1.25.3-alpine,nginx:1.27.4-alpine"
    ;;
    5)
      newVer=v5
      curImageList=barassistant/server:5.2.0,getmeili/meilisearch:v1.13.3,bitnami/redis:7.4.2,barassistant/salt-rim:4.1.0,nginx:1.27.4-alpine
      image_update_map[0]="barassistant/server:5.2.0,barassistant/server:5.2.0"
      image_update_map[1]="getmeili/meilisearch:v1.13.3,getmeili/meilisearch:v1.13.3"
      image_update_map[2]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[3]="barassistant/salt-rim:4.1.0,barassistant/salt-rim:4.1.0"
      image_update_map[4]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfClearMeiliData false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function clearMeiliData()
{
  # This function assumes the BarAssistant stack/containers are NOT running.
  echo -e "\nClearing BarAssistant Meilisearch data...\n"
  sudo rm -fr ${HSHQ_STACKS_DIR}/bar-assistant/meilisearch/*
  sleep 3
}

function mfClearMeiliData()
{
  if [ "$stackStatus" = "1" ];then
    # Stack is running, stop it, then clear data
    startStopStack bar-assistant stop "$portainerToken"
    isStartStackFromStopped=true
    sleep 3
  fi
  clearMeiliData
}

function mfUpdateBarAssistantV4()
{
  mfClearMeiliData
  isStartStackFromStopped=""
  sed -i "s/localhost:3000/localhost:8080/g" $HOME/bar-assistant-compose.yml
  sed -i "s/bar-assistant-app:3000/bar-assistant-app:8080/g" $HSHQ_STACKS_DIR/bar-assistant/web/nginx.conf
  sudo chown -R 33:33 $HSHQ_STACKS_DIR/bar-assistant/app
}

# FreshRSS
function installFreshRSS()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory freshrss "FreshRSS"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName freshrss-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName freshrss-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/freshrss
  mkdir $HSHQ_STACKS_DIR/freshrss/db
  mkdir $HSHQ_STACKS_DIR/freshrss/dbexport
  mkdir $HSHQ_STACKS_DIR/freshrss/data
  mkdir $HSHQ_STACKS_DIR/freshrss/extensions
  chmod 777 $HSHQ_STACKS_DIR/freshrss/dbexport

  initServicesCredentials

  set +e
  docker exec mailu-admin flask mailu alias-delete $FRESHRSS_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $FRESHRSS_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$FRESHRSS_INIT_ENV" = "true" ]; then
    sendEmail -s "FreshRSS Admin Login Info" -b "FreshRSS Admin Username: $FRESHRSS_ADMIN_USERNAME\nFreshRSS Admin Password: $FRESHRSS_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    FRESHRSS_INIT_ENV=true
    updateConfigVar FRESHRSS_INIT_ENV $FRESHRSS_INIT_ENV
  fi
  FRESHRSS_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $FRESHRSS_OIDC_CLIENT_SECRET | tr -d ':\n')
  set +e
  outputConfigFreshRSS
  oidcBlock=$(cat $HOME/freshrss.oidc)
  rm -f $HOME/freshrss.oidc
  insertOIDCClientAuthelia freshrss "$oidcBlock"
  set +e
  installStack freshrss freshrss-app "apache2 -D FOREGROUND" $HOME/freshrss.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5

  inner_block=""
  inner_block=$inner_block">>https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://freshrss-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FRESHRSS $MANAGETLS_FRESHRSS "$is_integrate_hshq" $NETDEFAULT_FRESHRSS "$inner_block"
  insertSubAuthelia $SUB_FRESHRSS.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll freshrss "$FMLNAME_FRESHRSS" $USERTYPE_FRESHRSS "https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN" "freshrss.png" "$(getHeimdallOrderFromSub $SUB_FRESHRSS $USERTYPE_FRESHRSS)"
    restartAllCaddyContainers
    checkAddDBConnection true freshrss "$FMLNAME_FRESHRSS" postgres freshrss-db $FRESHRSS_DATABASE_NAME $FRESHRSS_DATABASE_USER $FRESHRSS_DATABASE_USER_PASSWORD
  fi
}

function outputConfigFreshRSS()
{
  cat <<EOFBA > $HOME/freshrss-compose.yml
$STACK_VERSION_PREFIX freshrss $(getScriptStackVersion freshrss)

services:
  freshrss-db:
    image: $(getScriptImageByContainerName freshrss-db)
    container_name: freshrss-db
    hostname: freshrss-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-freshrss-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/freshrss/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/freshrss/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.freshrss-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.freshrss-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.freshrss-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.freshrss-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.freshrss-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.freshrss-hourly-db.email-from=FreshRSS Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.freshrss-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.freshrss-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.freshrss-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.freshrss-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.freshrss-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.freshrss-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.freshrss-monthly-db.email-from=FreshRSS Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.freshrss-monthly-db.mail-only-on-error=false"

  freshrss-app:
    image: $(getScriptImageByContainerName freshrss-app)
    container_name: freshrss-app
    hostname: freshrss-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
    depends_on:
      - freshrss-db
    networks:
      - int-freshrss-net
      - dock-ext-net
      - dock-proxy-net
    volumes:
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-freshrss-data:/var/www/FreshRSS/data
      - v-freshrss-extensions:/var/www/FreshRSS/extensions
    environment:
      FRESHRSS_INSTALL: |-
        --auth_type http_auth
        --environment production
        --base_url \${BASE_URL}
        --language en
        --title FreshRSS
        --api_enabled
        --db-type pgsql
        --db-host \${DB_HOST}
        --db-user \${DB_USER}
        --db-password \${DB_PASSWORD}
        --db-base \${DB_BASE}
        --default_user \${ADMIN_USERNAME}
      FRESHRSS_USER: |-
        --api_password \${ADMIN_API_PASSWORD}
        --email \${ADMIN_EMAIL}
        --language en
        --password \${ADMIN_PASSWORD}
        --user \${ADMIN_USERNAME}

volumes:
  v-freshrss-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/freshrss/data
  v-freshrss-extensions:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/freshrss/extensions

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-freshrss-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFBA

  cat <<EOFBA > $HOME/freshrss.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
BASE_URL=https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN
CRON_MIN=3,33
TRUSTED_PROXY=10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
POSTGRES_DB=$FRESHRSS_DATABASE_NAME
POSTGRES_USER=$FRESHRSS_DATABASE_USER
POSTGRES_PASSWORD=$FRESHRSS_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
ADMIN_USERNAME=$LDAP_ADMIN_USER_USERNAME
ADMIN_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
ADMIN_PASSWORD=$LDAP_ADMIN_USER_PASSWORD
ADMIN_API_PASSWORD=$LDAP_ADMIN_USER_PASSWORD
DB_HOST=freshrss-db
DB_BASE=freshrssdb
DB_PASSWORD=$FRESHRSS_DATABASE_USER_PASSWORD
DB_USER=freshrss-user
OIDC_ENABLED=1
OIDC_PROVIDER_METADATA_URL=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/.well-known/openid-configuration
OIDC_CLIENT_ID=freshrss
OIDC_CLIENT_SECRET=$FRESHRSS_OIDC_CLIENT_SECRET
OIDC_CLIENT_CRYPTO_KEY=$(pwgen -c -n 32 1)
OIDC_REMOTE_USER_CLAIM=preferred_username
OIDC_SCOPES=openid groups email profile
OIDC_X_FORWARDED_HEADERS=X-Forwarded-Host X-Forwarded-Proto
EOFBA

  cat <<EOFIM > $HOME/freshrss.oidc
# Authelia OIDC Client freshrss BEGIN
      - client_id: freshrss
        client_name: FreshRSS
        client_secret: $FRESHRSS_OIDC_CLIENT_SECRET_HASH
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        redirect_uris:
          - https://$SUB_FRESHRSS.$HOMESERVER_DOMAIN/i/oidc/
        scopes:
          - openid
          - groups
          - email
          - profile
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic
# Authelia OIDC Client freshrss END
EOFIM

}

function performUpdateFreshRSS()
{
  perform_stack_name=freshrss
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=postgres:15.0-bullseye,freshrss/freshrss:1.23.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="freshrss/freshrss:1.23.1,freshrss/freshrss:1.26.1"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,freshrss/freshrss:1.24.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="freshrss/freshrss:1.24.1,freshrss/freshrss:1.26.1"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,freshrss/freshrss:1.24.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="freshrss/freshrss:1.24.3,freshrss/freshrss:1.26.1"
    ;;
    4)
      newVer=v4
      curImageList=postgres:15.0-bullseye,freshrss/freshrss:1.26.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="freshrss/freshrss:1.26.1,freshrss/freshrss:1.26.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Keila
function installKeila()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory keila "Keila"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName keila-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName keila-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/keila
  mkdir $HSHQ_STACKS_DIR/keila/db
  mkdir $HSHQ_STACKS_DIR/keila/dbexport
  mkdir $HSHQ_STACKS_DIR/keila/uploads
  chmod 777 $HSHQ_STACKS_DIR/keila/dbexport

  initServicesCredentials

  KEILA_SECRET_KEY_BASE=$(pwgen -c -n 64 1)
  set +e
  docker exec mailu-admin flask mailu alias-delete $KEILA_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $KEILA_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$KEILA_INIT_ENV" = "true" ]; then
    sendEmail -s "Keila Admin Login Info" -b "Keila Admin Username: $KEILA_ADMIN_EMAIL_ADDRESS\nKeila Admin Password: $KEILA_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    KEILA_INIT_ENV=true
    updateConfigVar KEILA_INIT_ENV $KEILA_INIT_ENV
  fi

  outputConfigKeila
  installStack keila keila-app "Access KeilaWeb.Endpoint at" $HOME/keila.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5

  inner_block=""
  inner_block=$inner_block">>https://$SUB_KEILA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://keila-app:4000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_KEILA $MANAGETLS_KEILA "$is_integrate_hshq" $NETDEFAULT_KEILA "$inner_block"
  insertSubAuthelia $SUB_KEILA.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll keila "$FMLNAME_KEILA" $USERTYPE_KEILA "https://$SUB_KEILA.$HOMESERVER_DOMAIN" "keila.png" "$(getHeimdallOrderFromSub $SUB_KEILA $USERTYPE_KEILA)"
    restartAllCaddyContainers
    checkAddDBConnection true keila "$FMLNAME_KEILA" postgres keila-db $KEILA_DATABASE_NAME $KEILA_DATABASE_USER $KEILA_DATABASE_USER_PASSWORD
  fi
}

function outputConfigKeila()
{
  cat <<EOFBA > $HOME/keila-compose.yml
$STACK_VERSION_PREFIX keila $(getScriptStackVersion keila)

services:
  keila-db:
    image: $(getScriptImageByContainerName keila-db)
    container_name: keila-db
    hostname: keila-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-keila-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/keila/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/keila/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.keila-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.keila-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.keila-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.keila-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.keila-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.keila-hourly-db.email-from=Keila Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.keila-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.keila-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.keila-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.keila-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.keila-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.keila-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.keila-monthly-db.email-from=Keila Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.keila-monthly-db.mail-only-on-error=false"

  keila-app:
    image: $(getScriptImageByContainerName keila-app)
    container_name: keila-app
    hostname: keila-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - keila-db
    networks:
      - int-keila-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-keila-uploads:/uploads

volumes:
  v-keila-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/keila/db
  v-keila-uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/keila/uploads

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-keila-net:
    driver: bridge
    internal: true
    ipam:
      driver: default


EOFBA

  cat <<EOFBA > $HOME/keila.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$KEILA_DATABASE_NAME
POSTGRES_USER=$KEILA_DATABASE_USER
POSTGRES_PASSWORD=$KEILA_DATABASE_USER_PASSWORD
SECRET_KEY_BASE=$KEILA_SECRET_KEY_BASE
DB_URL=postgres://$KEILA_DATABASE_USER:$KEILA_DATABASE_USER_PASSWORD@keila-db/$KEILA_DATABASE_NAME
URL_HOST=$SUB_KEILA.$HOMESERVER_DOMAIN
URL_SCHEMA=https
MAILER_SMTP_HOST=$SMTP_HOSTNAME
MAILER_SMTP_PORT=$SMTP_HOSTPORT
MAILER_SMTP_USER=$EMAIL_SMTP_EMAIL_ADDRESS
MAILER_SMTP_PASSWORD=$EMAIL_SMTP_PASSWORD
MAILER_SMTP_FROM_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
MAILER_ENABLE_STARTTLS=true
KEILA_USER=$KEILA_ADMIN_EMAIL_ADDRESS
KEILA_PASSWORD=$KEILA_ADMIN_PASSWORD
DISABLE_REGISTRATION=true
USER_CONTENT_DIR=/uploads
EOFBA

}

function performUpdateKeila()
{
  perform_stack_name=keila
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=postgres:15.0-bullseye,pentacent/keila:0.13.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="pentacent/keila:0.13.1,pentacent/keila:0.14.11"
    ;;
    2)
      newVer=v4
      curImageList=postgres:15.0-bullseye,pentacent/keila:0.14.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="pentacent/keila:0.14.0,pentacent/keila:0.15.0"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,pentacent/keila:0.14.11
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="pentacent/keila:0.14.11,pentacent/keila:0.15.0"
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,pentacent/keila:0.15.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="pentacent/keila:0.15.0,pentacent/keila:0.17.1"
    ;;
    5)
      newVer=v5
      curImageList=postgres:15.0-bullseye,pentacent/keila:0.17.1
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="pentacent/keila:0.17.1,pentacent/keila:0.17.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Wallabag
function installWallabag()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory wallabag "Wallabag"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wallabag-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wallabag-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName wallabag-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/wallabag
  mkdir $HSHQ_STACKS_DIR/wallabag/db
  mkdir $HSHQ_STACKS_DIR/wallabag/dbexport
  mkdir $HSHQ_STACKS_DIR/wallabag/images
  chmod 777 $HSHQ_STACKS_DIR/wallabag/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/wallabag
  mkdir $HSHQ_NONBACKUP_DIR/wallabag/redis

  initServicesCredentials
  if [ -z "$WALLABAG_ENV_SECRET" ]; then
    WALLABAG_ENV_SECRET=$(pwgen -c -n 30 1)
    updateConfigVar WALLABAG_ENV_SECRET $WALLABAG_ENV_SECRET
  fi
  if [ -z "$WALLABAG_REDIS_PASSWORD" ]; then
    WALLABAG_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar WALLABAG_REDIS_PASSWORD $WALLABAG_REDIS_PASSWORD
  fi
  set +e
  docker exec mailu-admin flask mailu alias-delete $WALLABAG_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $WALLABAG_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$WALLABAG_INIT_ENV" = "true" ]; then
    sendEmail -s "Wallabag Admin Login Info" -b "Wallabag Admin Username: $WALLABAG_ADMIN_USERNAME\nWallabag Admin Password: $WALLABAG_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    WALLABAG_INIT_ENV=true
    updateConfigVar WALLABAG_INIT_ENV $WALLABAG_INIT_ENV
  fi

  outputConfigWallabag
  installStack wallabag wallabag-app "wallabag is ready" $HOME/wallabag.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5

  docker exec -t wallabag-app /var/www/wallabag/bin/console wallabag:install --env=prod --no-interaction > /dev/null 2>&1
  docker exec -t wallabag-app /var/www/wallabag/bin/console doctrine:migrations:migrate --env=prod --no-interaction > /dev/null 2>&1
  docker exec -t wallabag-app /var/www/wallabag/bin/console fos:user:create --env=prod --super-admin $WALLABAG_ADMIN_USERNAME $WALLABAG_ADMIN_EMAIL_ADDRESS $WALLABAG_ADMIN_PASSWORD > /dev/null 2>&1
  docker exec -t wallabag-app /var/www/wallabag/bin/console fos:user:deactivate --env=prod wallabag > /dev/null 2>&1
  docker exec wallabag-db /dbexport/setupRedis.sh > /dev/null 2>&1
  rm -f $HSHQ_STACKS_DIR/wallabag/dbexport/setupRedis.sh

  startStopStack wallabag stop
  sleep 3
  startStopStack wallabag start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_WALLABAG.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://wallabag-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_WALLABAG $MANAGETLS_WALLABAG "$is_integrate_hshq" $NETDEFAULT_WALLABAG "$inner_block"
  insertSubAuthelia $SUB_WALLABAG.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll wallabag "$FMLNAME_WALLABAG" $USERTYPE_WALLABAG "https://$SUB_WALLABAG.$HOMESERVER_DOMAIN" "wallabag.png" "$(getHeimdallOrderFromSub $SUB_WALLABAG $USERTYPE_WALLABAG)"
    restartAllCaddyContainers
    checkAddDBConnection true wallabag "$FMLNAME_WALLABAG" postgres wallabag-db $WALLABAG_DATABASE_NAME $WALLABAG_DATABASE_USER $WALLABAG_DATABASE_USER_PASSWORD
  fi
}

function outputConfigWallabag()
{
  cat <<EOFBA > $HOME/wallabag-compose.yml
$STACK_VERSION_PREFIX wallabag $(getScriptStackVersion wallabag)

services:
  wallabag-db:
    image: $(getScriptImageByContainerName wallabag-db)
    container_name: wallabag-db
    hostname: wallabag-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-wallabag-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/wallabag/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/wallabag/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.wallabag-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.wallabag-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wallabag-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wallabag-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wallabag-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wallabag-hourly-db.email-from=Wallabag Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wallabag-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.wallabag-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.wallabag-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.wallabag-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.wallabag-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.wallabag-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.wallabag-monthly-db.email-from=Wallabag Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.wallabag-monthly-db.mail-only-on-error=false"

  wallabag-redis:
    image: $(getScriptImageByContainerName wallabag-redis)
    container_name: wallabag-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-wallabag-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-wallabag-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$WALLABAG_REDIS_PASSWORD

  wallabag-app:
    image: $(getScriptImageByContainerName wallabag-app)
    container_name: wallabag-app
    hostname: wallabag-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - wallabag-db
      - wallabag-redis
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - int-wallabag-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/wallabag/images:/var/www/wallabag/web/assets/images

volumes:
  v-wallabag-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/wallabag/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-wallabag-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFBA

  cat <<EOFBA > $HOME/wallabag.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$WALLABAG_DATABASE_NAME
POSTGRES_USER=$WALLABAG_DATABASE_USER
POSTGRES_PASSWORD=$WALLABAG_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
POPULATE_DATABASE=false
SYMFONY__ENV__DATABASE_DRIVER=pdo_pgsql
SYMFONY__ENV__DATABASE_HOST=wallabag-db
SYMFONY__ENV__DATABASE_PORT=5432
SYMFONY__ENV__DATABASE_NAME=$WALLABAG_DATABASE_NAME
SYMFONY__ENV__DATABASE_USER=$WALLABAG_DATABASE_USER
SYMFONY__ENV__DATABASE_PASSWORD=$WALLABAG_DATABASE_USER_PASSWORD
SYMFONY__ENV__MAILER_DSN=smtp://$SMTP_HOSTNAME:$SMTP_HOSTPORT
SYMFONY__ENV__FROM_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
SYMFONY__ENV__DOMAIN_NAME=https://$SUB_WALLABAG.$HOMESERVER_DOMAIN
SYMFONY__ENV__SERVER_NAME=$HOMESERVER_NAME
SYMFONY__ENV__SECRET=$WALLABAG_ENV_SECRET
SYMFONY__ENV__TWOFACTOR_SENDER=$EMAIL_ADMIN_EMAIL_ADDRESS
SYMFONY__ENV__REDIS_HOST=wallabag-redis
SYMFONY__ENV__REDIS_PASSWORD=$WALLABAG_REDIS_PASSWORD
EOFBA

  cat <<EOFPT > $HSHQ_STACKS_DIR/wallabag/dbexport/setupRedis.sh
#!/bin/bash

PGPASSWORD=$WALLABAG_DATABASE_USER_PASSWORD
sqlcmd="update wallabag_internal_setting set value=1 where name='import_with_redis';"
echo "\$sqlcmd" | psql -U $WALLABAG_DATABASE_USER $WALLABAG_DATABASE_NAME
EOFPT

  chmod +x $HSHQ_STACKS_DIR/wallabag/dbexport/setupRedis.sh
}

function performUpdateWallabag()
{
  perform_stack_name=wallabag
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,wallabag/wallabag:2.6.8
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[2]="wallabag/wallabag:2.6.8,wallabag/wallabag:2.6.10"
    ;;
    2)
      newVer=v3
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,wallabag/wallabag:2.6.9
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      image_update_map[2]="wallabag/wallabag:2.6.9,wallabag/wallabag:2.6.10"
    ;;
    3)
      newVer=v3
      curImageList=postgres:15.0-bullseye,bitnami/redis:7.0.5,wallabag/wallabag:2.6.10
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
      image_update_map[2]="wallabag/wallabag:2.6.10,wallabag/wallabag:2.6.10"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Jupyter
function installJupyter()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory jupyter "Jupyter"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName jupyter)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/jupyter
  mkdir $HSHQ_STACKS_DIR/jupyter/notebooks
  initServicesCredentials
  outputConfigJupyter
  set +e
  installStack jupyter jupyter "Jupyter .* is running at" $HOME/jupyter.env 5
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  set -e
  if ! [ "$JUPYTER_INIT_ENV" = "true" ]; then
    sendEmail -s "Jupyter Admin Login Info" -b "Jupyter Admin Password: $JUPYTER_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    JUPYTER_INIT_ENV=true
    updateConfigVar JUPYTER_INIT_ENV $JUPYTER_INIT_ENV
  fi

  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_JUPYTER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://jupyter:8888 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_JUPYTER $MANAGETLS_JUPYTER "$is_integrate_hshq" $NETDEFAULT_JUPYTER "$inner_block"
  insertSubAuthelia $SUB_JUPYTER.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll jupyter "$FMLNAME_JUPYTER" $USERTYPE_JUPYTER "https://$SUB_JUPYTER.$HOMESERVER_DOMAIN" "jupyter.png" "$(getHeimdallOrderFromSub $SUB_JUPYTER $USERTYPE_JUPYTER)"
    restartAllCaddyContainers
  fi
}

function outputConfigJupyter()
{
  cat <<EOFDZ > $HOME/jupyter-compose.yml
$STACK_VERSION_PREFIX jupyter $(getScriptStackVersion jupyter)

services:
  jupyter:
    image: $(getScriptImageByContainerName jupyter)
    container_name: jupyter
    hostname: jupyter
    restart: unless-stopped
    env_file: stack.env
    command: '/bin/bash -c "conda install jupyter -y --quiet && mkdir -p /opt/notebooks && jupyter notebook --notebook-dir=/opt/notebooks --ip="*" --port=8888 --no-browser --allow-root --NotebookApp.token=$JUPYTER_ADMIN_PASSWORD"'
    security_opt:
      - no-new-privileges:true
    tty: true
    stdin_open: true
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/jupyter/notebooks:/opt/notebooks

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFDZ

  cat <<EOFDZ > $HOME/jupyter.env
TZ=\${TZ}
EOFDZ

}

function performUpdateJupyter()
{
  perform_stack_name=jupyter
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=continuumio/anaconda3:2023.09-0
      image_update_map[0]="continuumio/anaconda3:2023.09-0,continuumio/anaconda3:2024.10-1"
    ;;
    2)
      newVer=v4
      curImageList=continuumio/anaconda3:2024.02-1
      image_update_map[0]="continuumio/anaconda3:2024.02-1,continuumio/anaconda3:2024.10-1"
    ;;
    3)
      newVer=v4
      curImageList=continuumio/anaconda3:2024.06-1
      image_update_map[0]="continuumio/anaconda3:2024.06-1,continuumio/anaconda3:2024.10-1"
    ;;
    4)
      newVer=v4
      curImageList=continuumio/anaconda3:2024.10-1
      image_update_map[0]="continuumio/anaconda3:2024.10-1,continuumio/anaconda3:2024.10-1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Paperless
function installPaperless()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory paperless "Paperless"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName paperless-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName paperless-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName paperless-tika)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName paperless-gotenberg)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName paperless-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/paperless
  mkdir $HSHQ_STACKS_DIR/paperless/db
  mkdir $HSHQ_STACKS_DIR/paperless/dbexport
  mkdir $HSHQ_STACKS_DIR/paperless/redis
  mkdir $HSHQ_STACKS_DIR/paperless/data
  mkdir $HSHQ_STACKS_DIR/paperless/media
  mkdir $HSHQ_STACKS_DIR/paperless/export
  mkdir $HSHQ_STACKS_DIR/paperless/consume
  chmod 777 $HSHQ_STACKS_DIR/paperless/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/paperless
  mkdir $HSHQ_NONBACKUP_DIR/paperless/redis

  initServicesCredentials
  if [ -z "$PAPERLESS_SECRET_KEY" ]; then
    PAPERLESS_SECRET_KEY=$(pwgen -c -n 64 1)
    updateConfigVar PAPERLESS_SECRET_KEY $PAPERLESS_SECRET_KEY
  fi
  if [ -z "$PAPERLESS_REDIS_PASSWORD" ]; then
    PAPERLESS_REDIS_PASSWORD=$(pwgen -c -n 32 1)
    updateConfigVar PAPERLESS_REDIS_PASSWORD $PAPERLESS_REDIS_PASSWORD
  fi
  PAPERLESS_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $PAPERLESS_OIDC_CLIENT_SECRET | tr -d ':\n')
  set +e
  docker exec mailu-admin flask mailu alias-delete $PAPERLESS_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $PAPERLESS_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$PAPERLESS_INIT_ENV" = "true" ]; then
    sendEmail -s "Paperless Admin Login Info" -b "Paperless Admin Username: $PAPERLESS_ADMIN_USERNAME\nPaperless Admin Password: $PAPERLESS_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    PAPERLESS_INIT_ENV=true
    updateConfigVar PAPERLESS_INIT_ENV $PAPERLESS_INIT_ENV
  fi
  outputConfigPaperless
  oidcBlock=$(cat $HOME/paperless.oidc)
  rm -f $HOME/paperless.oidc
  insertOIDCClientAuthelia paperless "$oidcBlock"
  set +e
  installStack paperless paperless-app "celery@paperless-app ready" $HOME/paperless.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://paperless-app:8000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PAPERLESS $MANAGETLS_PAPERLESS "$is_integrate_hshq" $NETDEFAULT_PAPERLESS "$inner_block"
  insertSubAuthelia $SUB_PAPERLESS.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll paperless "$FMLNAME_PAPERLESS" $USERTYPE_PAPERLESS "https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN" "paperless.png" "$(getHeimdallOrderFromSub $SUB_PAPERLESS $USERTYPE_PAPERLESS)"
    restartAllCaddyContainers
    checkAddDBConnection true paperless "$FMLNAME_PAPERLESS" postgres paperless-db $PAPERLESS_DATABASE_NAME $PAPERLESS_DATABASE_USER $PAPERLESS_DATABASE_USER_PASSWORD
  fi
}

function outputConfigPaperless()
{
  rm -f $HOME/paperless-compose.yml
  cat <<EOFJT > $HOME/paperless-compose.yml
$STACK_VERSION_PREFIX paperless $(getScriptStackVersion paperless)

services:
  paperless-db:
    image: $(getScriptImageByContainerName paperless-db)
    container_name: paperless-db
    hostname: paperless-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-paperless-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/paperless/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/paperless/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.paperless-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.paperless-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.paperless-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.paperless-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.paperless-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.paperless-hourly-db.email-from=Paperless Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.paperless-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.paperless-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.paperless-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.paperless-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.paperless-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.paperless-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.paperless-monthly-db.email-from=Paperless Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.paperless-monthly-db.mail-only-on-error=false"

  paperless-gotenberg:
    image: $(getScriptImageByContainerName paperless-gotenberg)
    container_name: paperless-gotenberg
    hostname: paperless-gotenberg
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command:
      - "gotenberg"
      - "--chromium-disable-javascript=true"
      - "--chromium-allow-list=file:///tmp/.*"
    networks:
      - int-paperless-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  paperless-tika:
    image: $(getScriptImageByContainerName paperless-tika)
    container_name: paperless-tika
    hostname: paperless-tika
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-paperless-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  paperless-app:
    image: $(getScriptImageByContainerName paperless-app)
    container_name: paperless-app
    hostname: paperless-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - paperless-db
      - paperless-redis
      - paperless-gotenberg
      - paperless-tika
    networks:
      - dock-proxy-net
      - dock-internalmail-net
      - dock-privateip-net
      - int-paperless-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/\${PYTHON_VER}/site-packages/certifi/cacert.pem:ro
      - v-paperless-data:/usr/src/paperless/data
      - v-paperless-media:/usr/src/paperless/media
      - \${HSHQ_STACKS_DIR}/paperless/export:/usr/src/paperless/export
      - \${HSHQ_STACKS_DIR}/paperless/consume:/usr/src/paperless/consume

  paperless-redis:
    image: $(getScriptImageByContainerName paperless-redis)
    container_name: paperless-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-paperless-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-paperless-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$PAPERLESS_REDIS_PASSWORD

volumes:
  v-paperless-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/paperless/data
  v-paperless-media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/paperless/media
  v-paperless-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/paperless/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-privateip-net:
    name: dock-privateip
    external: true
  int-paperless-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFJT
  rm -f $HOME/paperless.env
  cat <<EOFJT > $HOME/paperless.env
POSTGRES_DB=$PAPERLESS_DATABASE_NAME
POSTGRES_USER=$PAPERLESS_DATABASE_USER
POSTGRES_PASSWORD=$PAPERLESS_DATABASE_USER_PASSWORD
PAPERLESS_REDIS=redis://:$PAPERLESS_REDIS_PASSWORD@paperless-redis:6379
PAPERLESS_DBHOST=paperless-db
PAPERLESS_DBNAME=$PAPERLESS_DATABASE_NAME
PAPERLESS_DBUSER=$PAPERLESS_DATABASE_USER
PAPERLESS_DBPASS=$PAPERLESS_DATABASE_USER_PASSWORD
PAPERLESS_SECRET_KEY=$PAPERLESS_SECRET_KEY
PAPERLESS_URL=https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN
PAPERLESS_ADMIN_USER=$PAPERLESS_ADMIN_USERNAME
PAPERLESS_ADMIN_MAIL=$PAPERLESS_ADMIN_EMAIL_ADDRESS
PAPERLESS_ADMIN_PASSWORD=$PAPERLESS_ADMIN_PASSWORD
PAPERLESS_TIKA_ENABLED=true
PAPERLESS_TIKA_ENDPOINT=http://paperless-tika:9998
PAPERLESS_TIKA_GOTENBERG_ENDPOINT=http://paperless-gotenberg:3000
PAPERLESS_EMAIL_HOST=$SMTP_HOSTNAME
PAPERLESS_EMAIL_PORT=$SMTP_HOSTPORT
PAPERLESS_EMAIL_FROM=$EMAIL_ADMIN_EMAIL_ADDRESS
PAPERLESS_EMAIL_USE_TLS=true
PAPERLESS_APPS=allauth.socialaccount.providers.openid_connect
PAPERLESS_SOCIAL_ACCOUNT_SYNC_GROUPS=true
PAPERLESS_SOCIAL_AUTO_SIGNUP=true
PAPERLESS_SOCIALACCOUNT_PROVIDERS={"openid_connect":{"SCOPE":["openid","profile","email","groups"],"OAUTH_PKCE_ENABLED":true,"APPS":[{"provider_id":"authelia","name":"Authelia","client_id":"paperless","secret":"$PAPERLESS_OIDC_CLIENT_SECRET","settings":{"server_url":"https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN","token_auth_method":"client_secret_basic"}}]}}
PYTHON_VER=python3.12
EOFJT
  rm -f $HOME/paperless.oidc
  cat <<EOFIM > $HOME/paperless.oidc
# Authelia OIDC Client paperless BEGIN
      - client_id: paperless
        client_name: Paperless
        client_secret: '$PAPERLESS_OIDC_CLIENT_SECRET_HASH'
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        require_pkce: true
        pkce_challenge_method: S256
        redirect_uris:
          - https://$SUB_PAPERLESS.$HOMESERVER_DOMAIN/accounts/oidc/authelia/login/callback/
        scopes:
          - openid
          - profile
          - email
          - groups
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic
# Authelia OIDC Client paperless END
EOFIM
}

function performUpdatePaperless()
{
  perform_stack_name=paperless
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=postgres:15.0-bullseye,gotenberg/gotenberg:7.10,ghcr.io/paperless-ngx/tika:2.9.1-minimal,ghcr.io/paperless-ngx/paperless-ngx:2.4.3,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gotenberg/gotenberg:7.10,gotenberg/gotenberg:8.12.0"
      image_update_map[2]="ghcr.io/paperless-ngx/tika:2.9.1-minimal,ghcr.io/paperless-ngx/tika:2.9.1-minimal"
      image_update_map[3]="ghcr.io/paperless-ngx/paperless-ngx:2.4.3,ghcr.io/paperless-ngx/paperless-ngx:2.13.2"
      image_update_map[4]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    2)
      newVer=v3
      curImageList=postgres:15.0-bullseye,gotenberg/gotenberg:8.2.2,ghcr.io/paperless-ngx/tika:2.9.1-minimal,ghcr.io/paperless-ngx/paperless-ngx:2.6.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gotenberg/gotenberg:8.2.2,gotenberg/gotenberg:8.12.0"
      image_update_map[2]="ghcr.io/paperless-ngx/tika:2.9.1-minimal,apache/tika:3.0.0.0"
      image_update_map[3]="ghcr.io/paperless-ngx/paperless-ngx:2.6.2,ghcr.io/paperless-ngx/paperless-ngx:2.13.2"
      image_update_map[4]="bitnami/redis:7.0.5,bitnami/redis:7.0.5"
    ;;
    3)
      newVer=v4
      curImageList=postgres:15.0-bullseye,gotenberg/gotenberg:8.12.0,apache/tika:3.0.0.0,ghcr.io/paperless-ngx/paperless-ngx:2.13.2,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gotenberg/gotenberg:8.12.0,gotenberg/gotenberg:8.19.1"
      image_update_map[2]="apache/tika:3.0.0.0,apache/tika:3.1.0.0"
      image_update_map[3]="ghcr.io/paperless-ngx/paperless-ngx:2.13.2,ghcr.io/paperless-ngx/paperless-ngx:2.14.7"
      image_update_map[4]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing true mfPaperlessUpdatePythonCertPath
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    4)
      newVer=v4
      curImageList=postgres:15.0-bullseye,gotenberg/gotenberg:8.19.1,apache/tika:3.1.0.0,ghcr.io/paperless-ngx/paperless-ngx:2.14.7,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="gotenberg/gotenberg:8.19.1,gotenberg/gotenberg:8.19.1"
      image_update_map[2]="apache/tika:3.1.0.0,apache/tika:3.1.0.0"
      image_update_map[3]="ghcr.io/paperless-ngx/paperless-ngx:2.14.7,ghcr.io/paperless-ngx/paperless-ngx:2.14.7"
      image_update_map[4]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mvFixRedisDir()
{
  outputConfigPaperless
  docker volume rm paperless_v-paperless-redis
}

function mfPaperlessUpdatePythonCertPath()
{
  # This will address the python version cert path correctly
  # by moving the version to an environment variable.
  # Much easier to update in the future.
  sed -i "s|\/etc\/ssl\/certs\/ca-certificates.crt:\/usr\/local\/lib\/python.*|\/etc\/ssl\/certs\/ca-certificates.crt:\/usr\/local\/lib\/\${PYTHON_VER}\/site-packages\/certifi\/cacert.pem:ro|g" $HOME/paperless-compose.yml
  grep "PYTHON_VER=" $HOME/paperless.env > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "PYTHON_VER=python3.12" >> $HOME/paperless.env
  fi
}

# Speedtest Tracker Local
function installSpeedtestTrackerLocal()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory speedtest-tracker-local "SpeedtestTrackerLocal"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName speedtest-tracker-local-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName speedtest-tracker-local-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-local
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-local/db
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-local/dbexport
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-local/config
  chmod 777 $HSHQ_STACKS_DIR/speedtest-tracker-local/dbexport

  initServicesCredentials
  set +e

  docker exec mailu-admin flask mailu alias-delete $SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $SPEEDTEST_TRACKER_LOCAL_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$SPEEDTEST_TRACKER_LOCAL_INIT_ENV" = "true" ]; then
    sendEmail -s "SpeedtestTrackerLocal Admin Login Info" -b "SpeedtestTrackerLocal Admin Username: $SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS\nSpeedtestTrackerLocal Admin Password: $SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    SPEEDTEST_TRACKER_LOCAL_INIT_ENV=true
    updateConfigVar SPEEDTEST_TRACKER_LOCAL_INIT_ENV $SPEEDTEST_TRACKER_LOCAL_INIT_ENV
  fi

  outputConfigSpeedtestTrackerLocal
  installStack speedtest-tracker-local speedtest-tracker-local-app "\[ls.io-init\] done" $HOME/speedtest-tracker-local.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5

  docker exec speedtest-tracker-local-db /dbexport/setupDBSettings.sh > /dev/null 2>&1
  rm -f $HSHQ_STACKS_DIR/speedtest-tracker-local/dbexport/setupDBSettings.sh
  sleep 4
  startStopStack speedtest-tracker-local stop
  sleep 1
  startStopStack speedtest-tracker-local start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://speedtest-tracker-local-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SPEEDTEST_TRACKER_LOCAL $MANAGETLS_SPEEDTEST_TRACKER_LOCAL "$is_integrate_hshq" $NETDEFAULT_SPEEDTEST_TRACKER_LOCAL "$inner_block"
  insertSubAuthelia $SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll speedtest-tracker-local "$FMLNAME_SPEEDTEST_TRACKER_LOCAL" $USERTYPE_SPEEDTEST_TRACKER_LOCAL "https://$SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN" "speedtest-tracker.png" "$(getHeimdallOrderFromSub $SUB_SPEEDTEST_TRACKER_LOCAL $USERTYPE_SPEEDTEST_TRACKER_LOCAL)"
    restartAllCaddyContainers
    checkAddDBConnection true speedtest-tracker-local "$FMLNAME_SPEEDTEST_TRACKER_LOCAL" postgres speedtest-tracker-local-db $SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
  fi
}

function outputConfigSpeedtestTrackerLocal()
{
  pw_hash=$(htpasswd -bnBC 10 "" $SPEEDTEST_TRACKER_LOCAL_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$/\\$/g')
  rand_minute=$((3 + RANDOM % 24))

  cat <<EOFBA > $HOME/speedtest-tracker-local-compose.yml
$STACK_VERSION_PREFIX speedtest-tracker-local $(getScriptStackVersion speedtest-tracker-local)

services:
  speedtest-tracker-local-db:
    image: $(getScriptImageByContainerName speedtest-tracker-local-db)
    container_name: speedtest-tracker-local-db
    hostname: speedtest-tracker-local-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-speedtest-tracker-local-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/speedtest-tracker-local/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/speedtest-tracker-local/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.email-from=SpeedtestTrackerLocal Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.speedtest-tracker-local-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.email-from=SpeedtestTrackerLocal Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.speedtest-tracker-local-monthly-db.mail-only-on-error=false"

  speedtest-tracker-local-app:
    image: $(getScriptImageByContainerName speedtest-tracker-local-app)
    container_name: speedtest-tracker-local-app
    hostname: speedtest-tracker-local-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - speedtest-tracker-local-db
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - int-speedtest-tracker-local-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/speedtest-tracker-local/config:/config

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-speedtest-tracker-local-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFBA

  set -f
  cat <<EOFBA > $HOME/speedtest-tracker-local.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
APP_NAME=Speedtest Tracker Local
APP_URL=https://$SUB_SPEEDTEST_TRACKER_LOCAL.$HOMESERVER_DOMAIN
APP_KEY=base64:$(pwgen -c -n 43 1)=
APP_TIMEZONE=${TZ}
DISPLAY_TIMEZONE=${TZ}
PUBLIC_DASHBOARD=false
SPEEDTEST_SCHEDULE='$rand_minute */3 * * *'
POSTGRES_DB=$SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME
POSTGRES_USER=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER
POSTGRES_PASSWORD=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
DB_CONNECTION=pgsql
DB_HOST=speedtest-tracker-local-db
DB_PORT=5432
DB_DATABASE=$SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME
DB_USERNAME=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER
DB_PASSWORD=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
MAIL_MAILER=smtp
MAIL_HOST=$SMTP_HOSTNAME
MAIL_PORT=$SMTP_HOSTPORT
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
MAIL_FROM_NAME=SpeedtestTrackerLocal $(getAdminEmailName)

EOFBA
  set +f
  cat <<EOFDS > $HSHQ_STACKS_DIR/speedtest-tracker-local/dbexport/setupDBSettings.sh
#!/bin/bash

PGPASSWORD=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD

echo "update settings set payload='[ { \"email_address\": \"$EMAIL_ADMIN_EMAIL_ADDRESS\" } ]' where name='mail_recipients';" | psql -U $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER $SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME
echo "update users set name='${HOMESERVER_ABBREV^^} SpeedtestTrackerLocal Admin', email='$SPEEDTEST_TRACKER_LOCAL_ADMIN_EMAIL_ADDRESS', password='$pw_hash' where id=1;" | psql -U $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER $SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME

EOFDS

  chmod +x $HSHQ_STACKS_DIR/speedtest-tracker-local/dbexport/setupDBSettings.sh
}

function performUpdateSpeedtestTrackerLocal()
{
  perform_stack_name=speedtest-tracker-local
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.15.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.15.2,linuxserver/speedtest-tracker:0.15.4"
    ;;
    2)
      newVer=v2
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.15.4
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.15.4,linuxserver/speedtest-tracker:0.15.4"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Speedtest Tracker cannot be upgraded to the next version. You must uninstall your current version and reinstall the new version."
      return
    ;;
    3)
      newVer=v3
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.18.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.18.3,linuxserver/speedtest-tracker:0.18.3"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Speedtest Tracker cannot be upgraded to the next version. You must uninstall your current version and reinstall the new version."
      return
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.20.8
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.20.8,linuxserver/speedtest-tracker:1.3.0"
    ;;
    5)
      newVer=v5
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:1.3.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:1.3.0,linuxserver/speedtest-tracker:1.3.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Speedtest Tracker VPN
function installSpeedtestTrackerVPN()
{
  set +e
  if ! [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
    return
  fi
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory speedtest-tracker-vpn "SpeedtestTrackerVPN"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName speedtest-tracker-vpn-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName speedtest-tracker-vpn-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-vpn
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-vpn/db
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-vpn/dbexport
  mkdir $HSHQ_STACKS_DIR/speedtest-tracker-vpn/config
  chmod 777 $HSHQ_STACKS_DIR/speedtest-tracker-vpn/dbexport

  initServicesCredentials
  set +e

  docker exec mailu-admin flask mailu alias-delete $SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $SPEEDTEST_TRACKER_VPN_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$SPEEDTEST_TRACKER_VPN_INIT_ENV" = "true" ]; then
    sendEmail -s "SpeedtestTrackerVPN Admin Login Info" -b "SpeedtestTrackerVPN Admin Username: $SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS\nSpeedtestTrackerVPN Admin Password: $SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    SPEEDTEST_TRACKER_VPN_INIT_ENV=true
    updateConfigVar SPEEDTEST_TRACKER_VPN_INIT_ENV $SPEEDTEST_TRACKER_VPN_INIT_ENV
  fi

  outputConfigSpeedtestTrackerVPN
  installStack speedtest-tracker-vpn speedtest-tracker-vpn-app "\[ls.io-init\] done" $HOME/speedtest-tracker-vpn.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 5

  docker exec speedtest-tracker-vpn-db /dbexport/setupDBSettings.sh > /dev/null 2>&1
  rm -f $HSHQ_STACKS_DIR/speedtest-tracker-vpn/dbexport/setupDBSettings.sh
  sleep 4
  startStopStack speedtest-tracker-vpn stop
  sleep 1
  startStopStack speedtest-tracker-vpn start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://speedtest-tracker-vpn-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SPEEDTEST_TRACKER_VPN $MANAGETLS_SPEEDTEST_TRACKER_VPN "$is_integrate_hshq" $NETDEFAULT_SPEEDTEST_TRACKER_VPN "$inner_block"
  insertSubAuthelia $SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll speedtest-tracker-vpn "$FMLNAME_SPEEDTEST_TRACKER_VPN" $USERTYPE_SPEEDTEST_TRACKER_VPN "https://$SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN" "speedtest-tracker.png" "$(getHeimdallOrderFromSub $SUB_SPEEDTEST_TRACKER_VPN $USERTYPE_SPEEDTEST_TRACKER_VPN)"
    restartAllCaddyContainers
    checkAddDBConnection true speedtest-tracker-vpn "$FMLNAME_SPEEDTEST_TRACKER_VPN" postgres speedtest-tracker-vpn-db $SPEEDTEST_TRACKER_VPN_DATABASE_NAME $SPEEDTEST_TRACKER_VPN_DATABASE_USER $SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
  fi
}

function outputConfigSpeedtestTrackerVPN()
{
  pw_hash=$(htpasswd -bnBC 10 "" $SPEEDTEST_TRACKER_VPN_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$/\\$/g')
  rand_minute=$((33 + RANDOM % 24))

  cat <<EOFBA > $HOME/speedtest-tracker-vpn-compose.yml
$STACK_VERSION_PREFIX speedtest-tracker-vpn $(getScriptStackVersion speedtest-tracker-vpn)

services:
  speedtest-tracker-vpn-db:
    image: $(getScriptImageByContainerName speedtest-tracker-vpn-db)
    container_name: speedtest-tracker-vpn-db
    hostname: speedtest-tracker-vpn-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-speedtest-tracker-vpn-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/speedtest-tracker-vpn/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/speedtest-tracker-vpn/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.email-from=SpeedtestTrackerVPN Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.speedtest-tracker-vpn-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.email-from=SpeedtestTrackerVPN Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.speedtest-tracker-vpn-monthly-db.mail-only-on-error=false"

  speedtest-tracker-vpn-app:
    image: $(getScriptImageByContainerName speedtest-tracker-vpn-app)
    container_name: speedtest-tracker-vpn-app
    hostname: speedtest-tracker-vpn-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - speedtest-tracker-vpn-db
    networks:
      - dock-proxy-net
      - dwg-${RELAYSERVER_WG_INTERNET_NETNAME}-net
      - dock-internalmail-net
      - int-speedtest-tracker-vpn-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/speedtest-tracker-vpn/config:/config

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dwg-${RELAYSERVER_WG_INTERNET_NETNAME}-net:
    name: dwg-${RELAYSERVER_WG_INTERNET_NETNAME}
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-speedtest-tracker-vpn-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFBA

  set -f
  cat <<EOFBA > $HOME/speedtest-tracker-vpn.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
APP_NAME=Speedtest Tracker VPN
APP_URL=https://$SUB_SPEEDTEST_TRACKER_VPN.$HOMESERVER_DOMAIN
APP_KEY=base64:$(pwgen -c -n 43 1)=
APP_TIMEZONE=${TZ}
DISPLAY_TIMEZONE=${TZ}
PUBLIC_DASHBOARD=false
SPEEDTEST_SCHEDULE='$rand_minute */3 * * *'
POSTGRES_DB=$SPEEDTEST_TRACKER_VPN_DATABASE_NAME
POSTGRES_USER=$SPEEDTEST_TRACKER_VPN_DATABASE_USER
POSTGRES_PASSWORD=$SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
DB_CONNECTION=pgsql
DB_HOST=speedtest-tracker-vpn-db
DB_PORT=5432
DB_DATABASE=$SPEEDTEST_TRACKER_VPN_DATABASE_NAME
DB_USERNAME=$SPEEDTEST_TRACKER_VPN_DATABASE_USER
DB_PASSWORD=$SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
MAIL_MAILER=smtp
MAIL_HOST=$SMTP_HOSTNAME
MAIL_PORT=$SMTP_HOSTPORT
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS=$EMAIL_ADMIN_EMAIL_ADDRESS
MAIL_FROM_NAME=SpeedtestTrackerVPN $(getAdminEmailName)

EOFBA
  set +f
  cat <<EOFDS > $HSHQ_STACKS_DIR/speedtest-tracker-vpn/dbexport/setupDBSettings.sh
#!/bin/bash

PGPASSWORD=$SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD

echo "update settings set payload='[ { \"email_address\": \"$EMAIL_ADMIN_EMAIL_ADDRESS\" } ]' where name='mail_recipients';" | psql -U $SPEEDTEST_TRACKER_VPN_DATABASE_USER $SPEEDTEST_TRACKER_VPN_DATABASE_NAME
echo "update users set name='${HOMESERVER_ABBREV^^} SpeedtestTrackerVPN Admin', email='$SPEEDTEST_TRACKER_VPN_ADMIN_EMAIL_ADDRESS', password='$pw_hash' where id=1;" | psql -U $SPEEDTEST_TRACKER_VPN_DATABASE_USER $SPEEDTEST_TRACKER_VPN_DATABASE_NAME

EOFDS

  chmod +x $HSHQ_STACKS_DIR/speedtest-tracker-vpn/dbexport/setupDBSettings.sh
}

function performUpdateSpeedtestTrackerVPN()
{
  perform_stack_name=speedtest-tracker-vpn
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.15.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.15.2,linuxserver/speedtest-tracker:0.15.4"
    ;;
    2)
      newVer=v2
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.15.4
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.15.4,linuxserver/speedtest-tracker:0.15.4"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Speedtest Tracker cannot be upgraded to the next version. You must uninstall your current version and reinstall the new version."
      return
    ;;
    3)
      newVer=v3
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.18.3
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.18.3,linuxserver/speedtest-tracker:0.18.3"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Speedtest Tracker cannot be upgraded to the next version. You must uninstall your current version and reinstall the new version."
      return
    ;;
    4)
      newVer=v5
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:0.20.8
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:0.20.8,linuxserver/speedtest-tracker:1.3.0"
    ;;
    5)
      newVer=v5
      curImageList=postgres:15.0-bullseye,linuxserver/speedtest-tracker:1.3.0
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="linuxserver/speedtest-tracker:1.3.0,linuxserver/speedtest-tracker:1.3.0"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Change Detection
function installChangeDetection()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory changedetection "$FMLNAME_CHANGEDETECTION"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName changedetection-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName changedetection-playwright-chrome)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/changedetection
  mkdir $HSHQ_STACKS_DIR/changedetection/data

  initServicesCredentials

  if ! [ "$CHANGEDETECTION_INIT_ENV" = "true" ]; then
    sendEmail -s "Change Detection Admin Login Info" -b "Change Detection Admin Password: $CHANGEDETECTION_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    CHANGEDETECTION_INIT_ENV=true
    updateConfigVar CHANGEDETECTION_INIT_ENV $CHANGEDETECTION_INIT_ENV
  fi

  outputConfigChangeDetection
  installStack changedetection changedetection-app "wsgi starting up on" $HOME/changedetection.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3
  pass_hash=$(docker exec -it changedetection-app python3 /datastore/genpass.py)
  startStopStack changedetection stop
  rem_item="notfound"
  rem_tag="notfound"
  tmp_item=$(cat $HSHQ_STACKS_DIR/changedetection/data/url-watches.json | jq -r '.watching[] | select(.url | contains("ycombinator.com")) | .uuid')
  if ! [ -z "$tmp_item" ]; then
    rem_item="$tmp_item"
  fi
  if ! [ -z "$rem_item" ] && ! [ "$rem_item" = "notfound" ]; then
    rem_tag=$(cat $HSHQ_STACKS_DIR/changedetection/data/url-watches.json | jq -r --arg remitem "$rem_item" '.watching[$remitem].tags[0]')
  fi
  cat $HSHQ_STACKS_DIR/changedetection/data/url-watches.json | jq --arg mylist "[ \"mailto://$SMTP_HOSTNAME:$SMTP_HOSTPORT?from=$EMAIL_ADMIN_EMAIL_ADDRESS&to=$EMAIL_ADMIN_EMAIL_ADDRESS\" ]" '.settings.application.notification_urls |= ($mylist | fromjson)' | jq --arg remtag "$rem_tag" 'del(.settings.application.tags[$remtag])' | jq --arg remitem $rem_item 'del(.watching[$remitem])' | jq --arg passhash $pass_hash '.settings.application.password |= $passhash' > $HSHQ_STACKS_DIR/changedetection/url-watches.json

  sudo rm -fr $HSHQ_STACKS_DIR/changedetection/data/$rem_item
  sudo chmod 644 $HSHQ_STACKS_DIR/changedetection/url-watches.json
  sudo chown root:root $HSHQ_STACKS_DIR/changedetection/url-watches.json
  sudo mv $HSHQ_STACKS_DIR/changedetection/url-watches.json $HSHQ_STACKS_DIR/changedetection/data/url-watches.json
  sudo rm -f $HSHQ_STACKS_DIR/changedetection/data/genpass.py
  startStopStack changedetection start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://changedetection-app:5000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_CHANGEDETECTION $MANAGETLS_CHANGEDETECTION "$is_integrate_hshq" $NETDEFAULT_CHANGEDETECTION "$inner_block"
  insertSubAuthelia $SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll changedetection "$FMLNAME_CHANGEDETECTION" $USERTYPE_CHANGEDETECTION "https://$SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN" "changedetection.png" "$(getHeimdallOrderFromSub $SUB_CHANGEDETECTION $USERTYPE_CHANGEDETECTION)"
    restartAllCaddyContainers
  fi
}

function outputConfigChangeDetection()
{
  cat <<EOFCD > $HOME/changedetection-compose.yml
$STACK_VERSION_PREFIX changedetection $(getScriptStackVersion changedetection)

services:
  changedetection-app:
    image: $(getScriptImageByContainerName changedetection-app)
    container_name: changedetection-app
    hostname: changedetection-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-changedetection-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    depends_on:
      - changedetection-playwright-chrome
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-changedetection-data:/datastore

  changedetection-playwright-chrome:
    image: $(getScriptImageByContainerName changedetection-playwright-chrome)
    container_name: changedetection-playwright-chrome
    hostname: changedetection-playwright-chrome
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-changedetection-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

volumes:
  v-changedetection-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/changedetection/data

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-changedetection-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFCD

  cat <<EOFCD > $HOME/changedetection.env
TZ=${TZ}
PUID=$USERID
PGID=$GROUPID
PORT=5000
PLAYWRIGHT_DRIVER_URL=ws://changedetection-playwright-chrome:3000
BASE_URL=https://$SUB_CHANGEDETECTION.$HOMESERVER_DOMAIN
HIDE_REFERER=true
SCREEN_WIDTH=1920
SCREEN_HEIGHT=1024
SCREEN_DEPTH=16
MAX_CONCURRENT_CHROME_PROCESSES=10
EOFCD

  cat <<EOFCD > $HSHQ_STACKS_DIR/changedetection/data/genpass.py
import base64
import hashlib
import secrets
password="$CHANGEDETECTION_ADMIN_PASSWORD"
salt = secrets.token_bytes(32)
key = hashlib.pbkdf2_hmac('sha256', password.encode('utf-8'), salt, 100000)
store = base64.b64encode(salt + key).decode('ascii')
print(store)
EOFCD

}

function performUpdateChangeDetection()
{
  perform_stack_name=changedetection
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=ghcr.io/dgtlmoon/changedetection.io:0.45.14,dgtlmoon/sockpuppetbrowser
      image_update_map[0]="ghcr.io/dgtlmoon/changedetection.io:0.45.14,ghcr.io/dgtlmoon/changedetection.io:0.47.05"
      image_update_map[1]="dgtlmoon/sockpuppetbrowser,dgtlmoon/sockpuppetbrowser:latest"
    ;;
    2)
      newVer=v4
      curImageList=ghcr.io/dgtlmoon/changedetection.io:0.45.16,dgtlmoon/sockpuppetbrowser:latest
      image_update_map[0]="ghcr.io/dgtlmoon/changedetection.io:0.45.16,ghcr.io/dgtlmoon/changedetection.io:0.47.05"
      image_update_map[1]="dgtlmoon/sockpuppetbrowser:latest,dgtlmoon/sockpuppetbrowser:latest"
    ;;
    3)
      newVer=v4
      curImageList=ghcr.io/dgtlmoon/changedetection.io:0.46.02,dgtlmoon/sockpuppetbrowser:latest
      image_update_map[0]="ghcr.io/dgtlmoon/changedetection.io:0.46.02,ghcr.io/dgtlmoon/changedetection.io:0.47.05"
      image_update_map[1]="dgtlmoon/sockpuppetbrowser:latest,dgtlmoon/sockpuppetbrowser:latest"
    ;;
    4)
      newVer=v5
      curImageList=ghcr.io/dgtlmoon/changedetection.io:0.47.05,dgtlmoon/sockpuppetbrowser:latest
      image_update_map[0]="ghcr.io/dgtlmoon/changedetection.io:0.47.05,ghcr.io/dgtlmoon/changedetection.io:0.49.11"
      image_update_map[1]="dgtlmoon/sockpuppetbrowser:latest,dgtlmoon/sockpuppetbrowser:latest"
    ;;
    5)
      newVer=v5
      curImageList=ghcr.io/dgtlmoon/changedetection.io:0.49.11,dgtlmoon/sockpuppetbrowser:latest
      image_update_map[0]="ghcr.io/dgtlmoon/changedetection.io:0.49.11,ghcr.io/dgtlmoon/changedetection.io:0.49.11"
      image_update_map[1]="dgtlmoon/sockpuppetbrowser:latest,dgtlmoon/sockpuppetbrowser:latest"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Huginn
function installHuginn()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory huginn "$FMLNAME_HUGINN"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName huginn-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName huginn-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/huginn
  mkdir $HSHQ_STACKS_DIR/huginn/db
  mkdir $HSHQ_STACKS_DIR/huginn/dbexport
  chmod 777 $HSHQ_STACKS_DIR/huginn/dbexport

  initServicesCredentials
  if [ -z "$HUGINN_APP_SECRET_TOKEN" ]; then
    HUGINN_APP_SECRET_TOKEN=$(openssl rand -hex 64)
    updateConfigVar HUGINN_APP_SECRET_TOKEN $HUGINN_APP_SECRET_TOKEN
  fi
  set +e
  docker exec mailu-admin flask mailu alias-delete $HUGINN_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $HUGINN_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  if ! [ "$HUGINN_INIT_ENV" = "true" ]; then
    sendEmail -s "Huginn Admin Login Info" -b "Huginn Admin Username: $HUGINN_ADMIN_USERNAME\nHuginn Admin Password: $HUGINN_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    HUGINN_INIT_ENV=true
    updateConfigVar HUGINN_INIT_ENV $HUGINN_INIT_ENV
  fi

  outputConfigHuginn
  installStack huginn huginn-app "" $HOME/huginn.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HUGINN.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://huginn-app:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HUGINN $MANAGETLS_HUGINN "$is_integrate_hshq" $NETDEFAULT_HUGINN "$inner_block"
  insertSubAuthelia $SUB_HUGINN.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll huginn "$FMLNAME_HUGINN" $USERTYPE_HUGINN "https://$SUB_HUGINN.$HOMESERVER_DOMAIN" "huginn.png" "$(getHeimdallOrderFromSub $SUB_HUGINN $USERTYPE_HUGINN)"
    restartAllCaddyContainers
    checkAddDBConnection true huginn "$FMLNAME_HUGINN" postgres huginn-db $HUGINN_DATABASE_NAME $HUGINN_DATABASE_USER $HUGINN_DATABASE_USER_PASSWORD
  fi
}

function outputConfigHuginn()
{
  cat <<EOFDZ > $HOME/huginn-compose.yml
$STACK_VERSION_PREFIX huginn $(getScriptStackVersion huginn)

services:
  huginn-db:
    image: $(getScriptImageByContainerName huginn-db)
    container_name: huginn-db
    hostname: huginn-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-huginn-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/huginn/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/huginn/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.huginn-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.huginn-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.huginn-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.huginn-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.huginn-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.huginn-hourly-db.email-from=Huginn Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.huginn-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.huginn-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.huginn-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.huginn-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.huginn-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.huginn-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.huginn-monthly-db.email-from=Huginn Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.huginn-monthly-db.mail-only-on-error=false"

  huginn-app:
    image: $(getScriptImageByContainerName huginn-app)
    container_name: huginn-app
    hostname: huginn-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - huginn-db
    networks:
      - int-huginn-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-huginn-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFDZ

  cat <<EOFDZ > $HOME/huginn.env
UID=$USERID
GID=$GROUPID
TZ=${TZ}
POSTGRES_DB=$HUGINN_DATABASE_NAME
POSTGRES_USER=$HUGINN_DATABASE_USER
POSTGRES_PASSWORD=$HUGINN_DATABASE_USER_PASSWORD
APP_SECRET_TOKEN=$HUGINN_APP_SECRET_TOKEN
DOMAIN=$SUB_HUGINN.$HOMESERVER_DOMAIN
PORT=3000
DATABASE_ADAPTER=postgresql
DATABASE_ENCODING=utf8
DATABASE_RECONNECT=true
DATABASE_NAME=$HUGINN_DATABASE_NAME
DATABASE_POOL=20
DATABASE_USERNAME=$HUGINN_DATABASE_USER
DATABASE_PASSWORD=$HUGINN_DATABASE_USER_PASSWORD
DATABASE_HOST=huginn-db
DATABASE_PORT=5432
FORCE_SSL=false
SKIP_INVITATION_CODE=true
REQUIRE_CONFIRMED_EMAIL=true
ALLOW_UNCONFIRMED_ACCESS_FOR=0
MIN_PASSWORD_LENGTH=16
USE_JQ=jq
USE_GRAPHVIZ_DOT=dot
SMTP_DOMAIN=$SMTP_HOSTNAME
SMTP_SERVER=$SMTP_HOSTNAME
SMTP_PORT=$SMTP_HOSTPORT
SMTP_USER_NAME=none
SMTP_ENABLE_STARTTLS_AUTO=true
SMTP_SSL=false
EMAIL_FROM_ADDRESS=Huginn $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>
SEED_USERNAME=$HUGINN_ADMIN_USERNAME
SEED_PASSWORD=$HUGINN_ADMIN_PASSWORD
SEED_EMAIL=$HUGINN_ADMIN_EMAIL_ADDRESS
TWITTER_OAUTH_KEY=
TWITTER_OAUTH_SECRET=
THIRTY_SEVEN_SIGNALS_OAUTH_KEY=
THIRTY_SEVEN_SIGNALS_OAUTH_SECRET=
GITHUB_OAUTH_KEY=
GITHUB_OAUTH_SECRET=
TUMBLR_OAUTH_KEY=
TUMBLR_OAUTH_SECRET=
EVERNOTE_OAUTH_KEY=
EVERNOTE_OAUTH_SECRET=
USE_EVERNOTE_SANDBOX=true
EOFDZ

}

function performUpdateHuginn()
{
  perform_stack_name=huginn
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=postgres:15.0-bullseye,ghcr.io/huginn/huginn:c2839b8a78335a1cb7052d6ee1c4fbdc11ee6bb5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/huginn/huginn:c2839b8a78335a1cb7052d6ee1c4fbdc11ee6bb5,ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61"
    ;;
    2)
      newVer=v3
      curImageList=postgres:15.0-bullseye,ghcr.io/huginn/huginn:087bcdd8f21ead2dd4e587b554e8248e5ffd4b99
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/huginn/huginn:087bcdd8f21ead2dd4e587b554e8248e5ffd4b99,ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61"
    ;;
    3)
      newVer=v3
      curImageList=postgres:15.0-bullseye,ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61,ghcr.io/huginn/huginn:1e0c359a46b1e84eb8c658404212eaf693b30e61"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Coturn
function installCoturn()
{
  # Since we allow other stack install functions to install Coturn,
  # we need to just return if already installed.
  if [ -d $HSHQ_STACKS_DIR/coturn ]; then
    return
  fi
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory coturn "$FMLNAME_COTURN"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName coturn)
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return 1 $retVal
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/coturn
  initServicesCredentials
  outputConfigCoturn
  generateCert coturn "coturn,$SUB_COTURN.$HOMESERVER_DOMAIN"
  set +e
  installStack coturn coturn "" $HOME/coturn.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3
}

function outputConfigCoturn()
{
  cat <<EOFOF > $HOME/coturn-compose.yml
$STACK_VERSION_PREFIX coturn $(getScriptStackVersion coturn)

services:
  coturn:
    image: $(getScriptImageByContainerName coturn)
    container_name: coturn
    hostname: coturn
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$COTURN_PRIMARY_PORT:$COTURN_PRIMARY_PORT"
      - "$COTURN_PRIMARY_PORT:$COTURN_PRIMARY_PORT/udp"
      - "$COTURN_SECONDARY_PORT:$COTURN_SECONDARY_PORT"
      - "$COTURN_SECONDARY_PORT:$COTURN_SECONDARY_PORT/udp"
      - "${COTURN_COMMS_MIN_PORT}-${COTURN_COMMS_MAX_PORT}:${COTURN_COMMS_MIN_PORT}-${COTURN_COMMS_MAX_PORT}/udp"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/coturn/turnserver.conf:/etc/coturn/turnserver.conf
      - \${HSHQ_SSL_DIR}/coturn.crt:/usr/local/etc/cert.pem
      - \${HSHQ_SSL_DIR}/coturn.key:/usr/local/etc/key.pem

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFOF
  cat <<EOFRM > $HOME/coturn.env
TZ=\${TZ}
EOFRM
  outputCoturnConf
  checkAddIPsCoturn
}

function outputCoturnConf()
{
  sudo rm -f $HSHQ_STACKS_DIR/coturn/turnserver.conf
  cat <<EOFRM > $HSHQ_STACKS_DIR/coturn/turnserver.conf
listening-port=$COTURN_PRIMARY_PORT
tls-listening-port=$COTURN_SECONDARY_PORT
min-port=$COTURN_COMMS_MIN_PORT
max-port=$COTURN_COMMS_MAX_PORT
fingerprint
use-auth-secret
static-auth-secret=$COTURN_STATIC_SECRET
realm=$SUB_COTURN.$HOMESERVER_DOMAIN
total-quota=0
bps-capacity=0
stale-nonce=600
cert=/usr/local/etc/cert.pem
pkey=/usr/local/etc/key.pem
no-rfc5780
no-stun-backward-compatibility
response-origin-only-with-rfc5780
no-cli
no-multicast-peers
denied-peer-ip=0.0.0.0-0.255.255.255
denied-peer-ip=10.0.0.0-10.255.255.255
denied-peer-ip=100.64.0.0-100.127.255.255
denied-peer-ip=127.0.0.0-127.255.255.255
denied-peer-ip=169.254.0.0-169.254.255.255
denied-peer-ip=172.16.0.0-172.31.255.255
denied-peer-ip=192.0.0.0-192.0.0.255
denied-peer-ip=192.0.2.0-192.0.2.255
denied-peer-ip=192.88.99.0-192.88.99.255
denied-peer-ip=192.168.0.0-192.168.255.255
denied-peer-ip=198.18.0.0-198.19.255.255
denied-peer-ip=198.51.100.0-198.51.100.255
denied-peer-ip=203.0.113.0-203.0.113.255
denied-peer-ip=240.0.0.0-255.255.255.255
denied-peer-ip=::1
denied-peer-ip=64:ff9b::-64:ff9b::ffff:ffff
denied-peer-ip=::ffff:0.0.0.0-::ffff:255.255.255.255
denied-peer-ip=100::-100::ffff:ffff:ffff:ffff
denied-peer-ip=2001::-2001:1ff:ffff:ffff:ffff:ffff:ffff:ffff
denied-peer-ip=2002::-2002:ffff:ffff:ffff:ffff:ffff:ffff:ffff
denied-peer-ip=fc00::-fdff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
denied-peer-ip=fe80::-febf:ffff:ffff:ffff:ffff:ffff:ffff:ffff
EOFRM
}

function checkAddIPsCoturn()
{
  set +e
  is_any_changed=false
  ifaceIPsArr=($(echo "$(getAllInterfaceIPs)" | tr "," "\n"))
  for curIP in "${ifaceIPsArr[@]}"
  do
    if [ -z "$curIP" ]; then
      continue
    fi
    grep "allowed-peer-ip=$curIP" $HSHQ_STACKS_DIR/coturn/turnserver.conf > /dev/null 2>&1
    if [ $? -ne 0 ]; then
      is_any_changed=true
    fi
  done
  sed -i "/allowed-peer-ip=.*/d" $HSHQ_STACKS_DIR/coturn/turnserver.conf
  for curIP in "${ifaceIPsArr[@]}"
  do
    if [ -z "$curIP" ]; then
      continue
    fi
    echo "allowed-peer-ip=$curIP" >> $HSHQ_STACKS_DIR/coturn/turnserver.conf
  done
  ext_subnet_startIP=$(sipcalc $NET_EXTERNAL_SUBNET | grep "^Network range" | rev | cut -d"-" -f2- | xargs | cut -d" " -f1 | rev)
  ext_subnet_endIP=$(sipcalc $NET_EXTERNAL_SUBNET | grep "^Network range" | rev | cut -d" " -f1 | rev)
  echo "allowed-peer-ip=${ext_subnet_startIP}-${ext_subnet_endIP}" >> $HSHQ_STACKS_DIR/coturn/turnserver.conf
  if [ "$is_any_changed" = "true" ]; then
    return 1
  fi
}

function updateCoturnAllowedIPs()
{
  set +e
  if [ -f $HSHQ_STACKS_DIR/coturn/turnserver.conf ]; then
    checkAddIPsCoturn
    if [ $? -eq 1 ]; then
      docker ps | grep coturn > /dev/null 2>&1
      if [ $? -eq 0 ]; then
        startStopStack coturn stop > /dev/null 2>&1
        sleep 1
        startStopStack coturn start > /dev/null 2>&1
      fi
    fi
  fi
}

function performUpdateCoturn()
{
  perform_stack_name=coturn
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=coturn/coturn:4.6
      image_update_map[0]="coturn/coturn:4.6,coturn/coturn:4.6.3"
    ;;
    2)
      newVer=v3
      curImageList=coturn/coturn:4.6.2
      image_update_map[0]="coturn/coturn:4.6.2,coturn/coturn:4.6.3"
    ;;
    3)
      newVer=v3
      curImageList=coturn/coturn:4.6.3
      image_update_map[0]="coturn/coturn:4.6.3,coturn/coturn:4.6.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# FileDrop
function installFileDrop()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory filedrop "FileDrop"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  buildFileDropImage
  if [ $? -ne 0 ]; then
    return 1
  fi
  if ! [ -d $HSHQ_STACKS_DIR/coturn ]; then
    echo "Missing coturn, installing..."
    installCoturn
    retval=$?
    if [ $retval -ne 0 ]; then
      notifyStackInstallFailure coturn
    fi
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/filedrop
  outputConfigFileDrop
  installStack filedrop filedrop "" $HOME/filedrop.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  sleep 3
  inner_block=""
  inner_block=$inner_block">>https://$SUB_FILEDROP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://filedrop:5000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_FILEDROP $MANAGETLS_FILEDROP "$is_integrate_hshq" $NETDEFAULT_FILEDROP "$inner_block"
  insertSubAuthelia $SUB_FILEDROP.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll filedrop "$FMLNAME_FILEDROP" $USERTYPE_FILEDROP "https://$SUB_FILEDROP.$HOMESERVER_DOMAIN" "filedrop.png" "$(getHeimdallOrderFromSub $SUB_FILEDROP $USERTYPE_FILEDROP)"
    restartAllCaddyContainers
  fi
}

function outputConfigFileDrop()
{
  cat <<EOFDZ > $HOME/filedrop-compose.yml
$STACK_VERSION_PREFIX filedrop $(getScriptStackVersion filedrop)

services:
  filedrop:
    image: $(getScriptImageByContainerName filedrop)
    container_name: filedrop
    hostname: filedrop
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFDZ

  cat <<EOFDZ > $HOME/filedrop.env
TZ=\${TZ}
WS_HOST=0.0.0.0
WS_APP_NAME=$HOMESERVER_NAME FileDrop
WS_ABUSE_EMAIL=$EMAIL_ADMIN_EMAIL_ADDRESS
WS_REQUIRE_CRYPTO=1
TURN_MODE=hmac
TURN_SERVER=turns:$SUB_COTURN.$HOMESERVER_DOMAIN:$COTURN_SECONDARY_PORT
TURN_USERNAME=filedrop
TURN_SECRET=$COTURN_STATIC_SECRET
STUN_SERVER=
EOFDZ

}

function performUpdateFileDrop()
{
  perform_stack_name=filedrop
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=filedrop/filedrop:1
      image_update_map[0]="filedrop/filedrop:1,filedrop/filedrop:1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function buildFileDropImage()
{
  set +e
  sudo rm -fr $HSHQ_BUILD_DIR/filedrop
  git clone https://github.com/mat-sz/filedrop.git $HSHQ_BUILD_DIR/filedrop
  docker build --build-arg VITE_APP_NAME=FileDrop -t filedrop/filedrop:1 $HSHQ_BUILD_DIR/filedrop
  retVal=$?
  sudo rm -fr $HSHQ_BUILD_DIR/filedrop
  return $retVal
}

# Piped
function installPiped()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory piped "Piped"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-frontend)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-proxy)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-api)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-cron)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName piped-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/piped
  mkdir $HSHQ_STACKS_DIR/piped/db
  mkdir $HSHQ_STACKS_DIR/piped/dbexport
  mkdir $HSHQ_STACKS_DIR/piped/config
  mkdir $HSHQ_STACKS_DIR/piped/cron
  mkdir $HSHQ_STACKS_DIR/piped/web
  chmod 777 $HSHQ_STACKS_DIR/piped/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/piped
  mkdir $HSHQ_NONBACKUP_DIR/piped/proxy

  initServicesCredentials
  outputConfigPiped
  installStack piped piped-app "" $HOME/piped.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://piped-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PIPED_FRONTEND $MANAGETLS_PIPED_FRONTEND "$is_integrate_hshq" $NETDEFAULT_PIPED_FRONTEND "$inner_block"
  insertSubAuthelia $SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN ${LDAP_PRIMARY_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PIPED_PROXY.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>uri replace \"&ump=1\" \"\"\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://piped-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PIPED_PROXY $MANAGETLS_PIPED_PROXY "$is_integrate_hshq" $NETDEFAULT_PIPED_PROXY "$inner_block"
  insertSubAuthelia $SUB_PIPED_PROXY.$HOMESERVER_DOMAIN bypass

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PIPED_API.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://piped-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PIPED_API $MANAGETLS_PIPED_API "$is_integrate_hshq" $NETDEFAULT_PIPED_API "$inner_block"
  insertSubAuthelia $SUB_PIPED_API.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll piped "$FMLNAME_PIPED_FRONTEND" $USERTYPE_PIPED_FRONTEND "https://$SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN" "piped.png" "$(getHeimdallOrderFromSub $SUB_PIPED_FRONTEND $USERTYPE_PIPED_FRONTEND)"
    restartAllCaddyContainers
    checkAddDBConnection true piped "$FMLNAME_PIPED_FRONTEND" postgres piped-db $PIPED_DATABASE_NAME $PIPED_DATABASE_USER $PIPED_DATABASE_USER_PASSWORD
  fi
}

function outputConfigPiped()
{
  cat <<EOFPI > $HOME/piped-compose.yml
$STACK_VERSION_PREFIX piped $(getScriptStackVersion piped)

services:
  piped-db:
    image: $(getScriptImageByContainerName piped-db)
    container_name: piped-db
    hostname: piped-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-piped-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/piped/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/piped/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.piped-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.piped-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.piped-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.piped-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.piped-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.piped-hourly-db.email-from=Piped Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.piped-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.piped-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.piped-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.piped-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.piped-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.piped-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.piped-monthly-db.email-from=Piped Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.piped-monthly-db.mail-only-on-error=false"

  piped-frontend:
    image: $(getScriptImageByContainerName piped-frontend)
    container_name: piped-frontend
    hostname: piped-frontend
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    entrypoint: ash -c 'sed -i s/pipedapi.kavin.rocks/$SUB_PIPED_API.$HOMESERVER_DOMAIN/g /usr/share/nginx/html/assets/* && /docker-entrypoint.sh && nginx -g "daemon off;"'
    depends_on:
      - piped-api
    networks:
      - int-piped-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

  piped-proxy:
    image: $(getScriptImageByContainerName piped-proxy)
    container_name: piped-proxy
    hostname: piped-proxy
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-piped-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-piped-proxy:/app/socket

  piped-api:
    image: $(getScriptImageByContainerName piped-api)
    container_name: piped-api
    hostname: piped-api
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-piped-net
      - dock-proxy-net
      - dock-ext-net
    depends_on:
      - piped-db
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/piped/config/config.properties:/app/config.properties:ro

  piped-cron:
    image: $(getScriptImageByContainerName piped-cron)
    container_name: piped-cron
    hostname: piped-cron
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    tty: true
    networks:
      - int-piped-net
      - dock-ext-net
    depends_on:
      - piped-web
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/piped/cron/updateSubs.sh:/updateSubs.sh
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.piped-subs.schedule=@every 15m"
      - "ofelia.job-exec.piped-subs.command=/updateSubs.sh"

  piped-web:
    image: $(getScriptImageByContainerName piped-web)
    container_name: piped-web
    hostname: piped-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-piped-net
      - dock-proxy-net
    depends_on:
      - piped-frontend
      - piped-proxy
      - piped-api
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/piped/web/nginx.conf:/etc/nginx/nginx.conf:ro
      - \${HSHQ_STACKS_DIR}/piped/web/pipedapi.conf:/etc/nginx/conf.d/pipedapi.conf:ro
      - \${HSHQ_STACKS_DIR}/piped/web/pipedproxy.conf:/etc/nginx/conf.d/pipedproxy.conf:ro
      - \${HSHQ_STACKS_DIR}/piped/web/pipedfrontend.conf:/etc/nginx/conf.d/pipedfrontend.conf:ro
      - \${HSHQ_STACKS_DIR}/piped/web/ytproxy.conf:/etc/nginx/snippets/ytproxy.conf:ro
      - v-piped-proxy:/var/run/ytproxy

volumes:
  v-piped-proxy:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/piped/proxy

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-piped-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFPI

  cat <<EOFPI > $HOME/piped.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
POSTGRES_DB=$PIPED_DATABASE_NAME
POSTGRES_USER=$PIPED_DATABASE_USER
POSTGRES_PASSWORD=$PIPED_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--encoding='UTF8' --lc-collate='C' --lc-ctype='C'
UDS=1
EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/config/config.properties
PORT: 8080
HTTP_WORKERS: 2
PROXY_PART: https://$SUB_PIPED_PROXY.$HOMESERVER_DOMAIN
CAPTCHA_BASE_URL: 
CAPTCHA_API_KEY: 
API_URL: https://$SUB_PIPED_API.$HOMESERVER_DOMAIN
FRONTEND_URL: https://$SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN
COMPROMISED_PASSWORD_CHECK: false
DISABLE_REGISTRATION: false
FEED_RETENTION: 30
hibernate.connection.url: jdbc:postgresql://piped-db:5432/$PIPED_DATABASE_NAME
hibernate.connection.driver_class: org.postgresql.Driver
hibernate.dialect: org.hibernate.dialect.PostgreSQLDialect
hibernate.connection.username: $PIPED_DATABASE_USER
hibernate.connection.password: $PIPED_DATABASE_USER_PASSWORD
EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/web/nginx.conf
user root;
worker_processes auto;

error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    server_names_hash_bucket_size 128;
    log_format main '\$remote_addr - \$remote_user [\$time_local] "\$request" '
    '\$status \$body_bytes_sent "\$http_referer" '
    '"\$http_user_agent" "\$http_x_forwarded_for"';
    access_log /var/log/nginx/access.log main;
    sendfile on;
    tcp_nodelay on;
    keepalive_timeout 65;
    resolver 127.0.0.11 ipv6=off valid=10s;
    include /etc/nginx/conf.d/*.conf;
}

EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/web/pipedapi.conf
proxy_cache_path /tmp/pipedapi_cache levels=1:2 keys_zone=pipedapi:4m max_size=2g inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name $SUB_PIPED_API.$HOMESERVER_DOMAIN;

    set \$backend "http://piped-api:8080";

    location / {
        proxy_cache pipedapi;
        proxy_pass \$backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "keep-alive";
    }
}

EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/web/pipedfrontend.conf
server {
    listen 80;
    server_name $SUB_PIPED_FRONTEND.$HOMESERVER_DOMAIN;

    set \$backend "http://piped-frontend:80";

    location / {
        proxy_pass \$backend;
        proxy_http_version 1.1;
        proxy_set_header Connection "keep-alive";
    }
}

EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/web/pipedproxy.conf
server {
    listen 80;
    server_name $SUB_PIPED_PROXY.$HOMESERVER_DOMAIN;

    location ~ (/videoplayback|/api/v4/|/api/manifest/) {
        include snippets/ytproxy.conf;
        add_header Cache-Control private always;
    }

    location / {
        include snippets/ytproxy.conf;
        add_header Cache-Control "public, max-age=604800";
    }
}

EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/web/ytproxy.conf
proxy_buffering on;
proxy_buffers 1024 16k;
proxy_set_header X-Forwarded-For "";
proxy_set_header CF-Connecting-IP "";
proxy_hide_header "alt-svc";
sendfile on;
sendfile_max_chunk 512k;
tcp_nopush on;
aio threads=default;
aio_write on;
directio 16m;
proxy_hide_header Cache-Control;
proxy_hide_header etag;
proxy_http_version 1.1;
proxy_set_header Connection keep-alive;
proxy_max_temp_file_size 32m;
access_log off;
proxy_pass http://unix:/var/run/ytproxy/actix.sock;

EOFPI

  cat <<EOFPI > $HSHQ_STACKS_DIR/piped/cron/updateSubs.sh
#!/bin/bash

sqlcmd="SELECT DISTINCT(channel) FROM users_subscribed;"
echo "\$sqlcmd" | PGPASSWORD=\$POSTGRES_PASSWORD psql -qtA -h piped-db -U \$POSTGRES_USER \$POSTGRES_DB | xargs -I\\{} curl -sk -o /dev/null "https://$SUB_PIPED_API.$HOMESERVER_DOMAIN/channel/{}"

EOFPI

  chmod 751 $HSHQ_STACKS_DIR/piped/cron/updateSubs.sh

}

function performUpdatePiped()
{
  perform_stack_name=piped
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,1337kavin/piped-frontend:latest,1337kavin/piped-proxy:latest,1337kavin/piped:latest,barrypiccinni/psql-curl,nginx:1.25.3-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="1337kavin/piped-frontend:latest,1337kavin/piped-frontend:latest"
      image_update_map[2]="1337kavin/piped-proxy:latest,1337kavin/piped-proxy:latest"
      image_update_map[3]="1337kavin/piped:latest,1337kavin/piped:latest"
      image_update_map[4]="barrypiccinni/psql-curl,barrypiccinni/psql-curl"
      image_update_map[5]="nginx:1.25.3-alpine,nginx:1.27.4-alpine"
    ;;
    2)
      newVer=v2
      curImageList=postgres:15.0-bullseye,1337kavin/piped-frontend:latest,1337kavin/piped-proxy:latest,1337kavin/piped:latest,barrypiccinni/psql-curl,nginx:1.27.4-alpine
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="1337kavin/piped-frontend:latest,1337kavin/piped-frontend:latest"
      image_update_map[2]="1337kavin/piped-proxy:latest,1337kavin/piped-proxy:latest"
      image_update_map[3]="1337kavin/piped:latest,1337kavin/piped:latest"
      image_update_map[4]="barrypiccinni/psql-curl,barrypiccinni/psql-curl"
      image_update_map[5]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# GrampsWeb
function installGrampsWeb()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory grampsweb "GrampsWeb"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName grampsweb-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName grampsweb-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/grampsweb
  mkdir $HSHQ_STACKS_DIR/grampsweb/redis
  mkdir $HSHQ_STACKS_DIR/grampsweb/users
  mkdir $HSHQ_STACKS_DIR/grampsweb/index
  mkdir $HSHQ_STACKS_DIR/grampsweb/thumbcache
  mkdir $HSHQ_STACKS_DIR/grampsweb/cache
  mkdir $HSHQ_STACKS_DIR/grampsweb/secret
  mkdir $HSHQ_STACKS_DIR/grampsweb/db
  mkdir $HSHQ_STACKS_DIR/grampsweb/media
  mkdir $HSHQ_STACKS_DIR/grampsweb/tmp

  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $GRAMPSWEB_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $GRAMPSWEB_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  if ! [ "$GRAMPSWEB_INIT_ENV" = "true" ]; then
    sendEmail -s "GrampsWeb Admin Login Info" -b "GrampsWeb Admin Username: $GRAMPSWEB_ADMIN_USERNAME\nGrampsWeb Admin Password: $GRAMPSWEB_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    GRAMPSWEB_INIT_ENV=true
    updateConfigVar GRAMPSWEB_INIT_ENV $GRAMPSWEB_INIT_ENV
  fi
  outputConfigGrampsWeb
  installStack grampsweb grampsweb-app "Listening at: http://0.0.0.0:5000" $HOME/grampsweb.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  docker exec -it grampsweb-app python3 -m gramps_webapi user add --fullname "$HOMESERVER_NAME Admin" --email "$GRAMPSWEB_ADMIN_EMAIL_ADDRESS" --role 5 "$GRAMPSWEB_ADMIN_USERNAME" "$GRAMPSWEB_ADMIN_PASSWORD" > /dev/null 2>&1
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(1,'EMAIL_HOST','$SMTP_HOSTNAME');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(2,'EMAIL_PORT','465');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(3,'EMAIL_HOST_USER','$EMAIL_SMTP_EMAIL_ADDRESS');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(4,'EMAIL_HOST_PASSWORD','$EMAIL_SMTP_PASSWORD');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(5,'DEFAULT_FROM_EMAIL','GrampsWeb $(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(6,'BASE_URL','https://$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN');"
  sudo sqlite3 $HSHQ_STACKS_DIR/grampsweb/users/users.sqlite "insert into configuration values(7,'EMAIL_USE_TLS','0');"
  portainerToken="$(getPortainerToken -u $PORTAINER_ADMIN_USERNAME -p $PORTAINER_ADMIN_PASSWORD)"
  startStopStack grampsweb stop "$portainerToken"
  startStopStack grampsweb start "$portainerToken"
  inner_block=""
  inner_block=$inner_block">>https://$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://grampsweb-app:5000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_GRAMPSWEB $MANAGETLS_GRAMPSWEB "$is_integrate_hshq" $NETDEFAULT_GRAMPSWEB "$inner_block"
  insertSubAuthelia $SUB_GRAMPSWEB.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll grampsweb "$FMLNAME_GRAMPSWEB" $USERTYPE_GRAMPSWEB "https://$SUB_GRAMPSWEB.$HOMESERVER_DOMAIN" "grampsweb.png" "$(getHeimdallOrderFromSub $SUB_GRAMPSWEB $USERTYPE_GRAMPSWEB)"
    restartAllCaddyContainers
  fi
}

function outputConfigGrampsWeb()
{
  cat <<EOFPI > $HOME/grampsweb-compose.yml
$STACK_VERSION_PREFIX grampsweb $(getScriptStackVersion grampsweb)

services:

  grampsweb-app:
    image: $(getScriptImageByContainerName grampsweb-app)
    container_name: grampsweb-app
    hostname: grampsweb-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - grampsweb-redis
    networks:
      - dock-grampsweb-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-grampsweb-users:/app/users
      - v-grampsweb-index:/app/indexdir
      - v-grampsweb-thumbcache:/app/thumbnail_cache
      - v-grampsweb-cache:/app/cache
      - v-grampsweb-secret:/app/secret
      - v-grampsweb-db:/root/.gramps/grampsdb
      - v-grampsweb-media:/app/media
      - v-grampsweb-tmp:/tmp

  grampsweb-celery:
    image: $(getScriptImageByContainerName grampsweb-app)
    container_name: grampsweb-celery
    hostname: grampsweb-celery
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: celery -A gramps_webapi.celery worker --loglevel=INFO
    depends_on:
      - grampsweb-redis
    networks:
      - dock-grampsweb-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-grampsweb-users:/app/users
      - v-grampsweb-index:/app/indexdir
      - v-grampsweb-thumbcache:/app/thumbnail_cache
      - v-grampsweb-cache:/app/cache
      - v-grampsweb-secret:/app/secret
      - v-grampsweb-db:/root/.gramps/grampsdb
      - v-grampsweb-media:/app/media
      - v-grampsweb-tmp:/tmp

  grampsweb-redis:
    image: $(getScriptImageByContainerName grampsweb-redis)
    container_name: grampsweb-redis
    hostname: grampsweb-redis
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-grampsweb-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-grampsweb-redis:/bitnami/redis/data

volumes:
  v-grampsweb-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/redis
  v-grampsweb-users:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/users
  v-grampsweb-index:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/index
  v-grampsweb-thumbcache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/thumbcache
  v-grampsweb-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/cache
  v-grampsweb-secret:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/secret
  v-grampsweb-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/db
  v-grampsweb-media:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/media
  v-grampsweb-tmp:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/grampsweb/tmp

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-grampsweb-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFPI

  cat <<EOFPI > $HOME/grampsweb.env
TZ=\${TZ}
UID=$USERID
GID=$GROUPID
GRAMPSWEB_SECRET_KEY=$GRAMPSWEB_SECRET_KEY
GRAMPSWEB_TREE=GrampsWeb Tree
GRAMPSWEB_CELERY_CONFIG__broker_url=redis://:$GRAMPSWEB_REDIS_PASSWORD@grampsweb-redis:6379/0
GRAMPSWEB_CELERY_CONFIG__result_backend=redis://:$GRAMPSWEB_REDIS_PASSWORD@grampsweb-redis:6379/0
GRAMPSWEB_RATELIMIT_STORAGE_URI=redis://:$GRAMPSWEB_REDIS_PASSWORD@grampsweb-redis:6379/1
REDIS_PASSWORD=$GRAMPSWEB_REDIS_PASSWORD
EOFPI

}

function performUpdateGrampsWeb()
{
  perform_stack_name=grampsweb
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v3
      curImageList=ghcr.io/gramps-project/grampsweb:v24.8.0,bitnami/redis:7.0.5
      image_update_map[0]="ghcr.io/gramps-project/grampsweb:v24.8.0,ghcr.io/gramps-project/grampsweb:v25.4.0"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    2)
      newVer=v3
      curImageList=ghcr.io/gramps-project/grampsweb:v24.10.0,bitnami/redis:7.0.5
      image_update_map[0]="ghcr.io/gramps-project/grampsweb:v24.10.0,ghcr.io/gramps-project/grampsweb:v25.4.0"
      image_update_map[1]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    3)
      newVer=v3
      curImageList=ghcr.io/gramps-project/grampsweb:v25.4.0,bitnami/redis:7.0.5
      image_update_map[0]="ghcr.io/gramps-project/grampsweb:v25.4.0,ghcr.io/gramps-project/grampsweb:v25.4.0"
      image_update_map[1]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Penpot
function installPenpot()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory penpot "$FMLNAME_PENPOT"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName penpot-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName penpot-backend)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName penpot-frontend)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName penpot-exporter)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName penpot-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $IMG_TOMCAT
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/penpot
  mkdir $HSHQ_STACKS_DIR/penpot/db
  mkdir $HSHQ_STACKS_DIR/penpot/dbexport
  mkdir $HSHQ_STACKS_DIR/penpot/ssl
  mkdir $HSHQ_STACKS_DIR/penpot/assets
  chmod 777 $HSHQ_STACKS_DIR/penpot/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/penpot
  mkdir $HSHQ_NONBACKUP_DIR/penpot/redis

  initServicesCredentials
  set +e
  docker run --rm --name=tomcat -v $HSHQ_STACKS_DIR/penpot/ssl:/certsexport -v /usr/local/share/ca-certificates:/usr/local/share/ca-certificates $IMG_TOMCAT bash -c "keytool -importcert -file /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt -alias ${CERTS_ROOT_CA_NAME}.crt -cacerts -storepass changeit -noprompt; cp /opt/java/openjdk/lib/security/cacerts /certsexport/"
  if ! [ -f $HSHQ_STACKS_DIR/penpot/ssl/cacerts ]; then
    echo "There was an error generating the java keystore with the added CA certificate, returning..."
    return 2
  fi
  outputConfigPenpot
  installStack penpot penpot-backend "welcome to penpot" $HOME/penpot.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  if ! [ "$PENPOT_INIT_ENV" = "true" ]; then
    sendEmail -s "Penpot Login Info" -b "Penpot has been installed. It has been configured and integrated with LDAP. However, you must use the email address of the LDAP user rather than the username. The password is the LDAP user's password. Here are the credentials for the LDAP Admin user: \n\nEmail: $EMAIL_ADMIN_EMAIL_ADDRESS\nPassword: $LDAP_ADMIN_USER_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    PENPOT_INIT_ENV=true
    updateConfigVar PENPOT_INIT_ENV $PENPOT_INIT_ENV
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_PENPOT.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://penpot-frontend:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PENPOT $MANAGETLS_PENPOT "$is_integrate_hshq" $NETDEFAULT_PENPOT "$inner_block"
  insertSubAuthelia $SUB_PENPOT.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll penpot "$FMLNAME_PENPOT" $USERTYPE_PENPOT "https://$SUB_PENPOT.$HOMESERVER_DOMAIN" "penpot.png" "$(getHeimdallOrderFromSub $SUB_PENPOT $USERTYPE_PENPOT)"
    restartAllCaddyContainers
    checkAddDBConnection true penpot "$FMLNAME_PENPOT" postgres penpot-db $PENPOT_DATABASE_NAME $PENPOT_DATABASE_USER $PENPOT_DATABASE_USER_PASSWORD
  fi
  docker image rm $IMG_TOMCAT > /dev/null 2>&1
}

function outputConfigPenpot()
{
  cat <<EOFPI > $HOME/penpot-compose.yml
$STACK_VERSION_PREFIX penpot $(getScriptStackVersion penpot)

services:
  penpot-db:
    image: $(getScriptImageByContainerName penpot-db)
    container_name: penpot-db
    hostname: penpot-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-penpot-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/penpot/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/penpot/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.penpot-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.penpot-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.penpot-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.penpot-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.penpot-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.penpot-hourly-db.email-from=Penpot Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.penpot-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.penpot-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.penpot-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.penpot-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.penpot-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.penpot-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.penpot-monthly-db.email-from=Penpot Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.penpot-monthly-db.mail-only-on-error=false"

  penpot-frontend:
    image: $(getScriptImageByContainerName penpot-frontend)
    container_name: penpot-frontend
    hostname: penpot-frontend
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - penpot-backend
      - penpot-exporter
    networks:
      - int-penpot-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-penpot-assets:/opt/data/assets

  penpot-backend:
    image: $(getScriptImageByContainerName penpot-backend)
    container_name: penpot-backend
    hostname: penpot-backend
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - penpot-db
      - penpot-redis
    networks:
      - int-penpot-net
      - dock-ldap-net
      - dock-internalmail-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/penpot/ssl/cacerts:/opt/jdk/lib/security/cacerts:ro
      - v-penpot-assets:/opt/data/assets

  penpot-exporter:
    image: $(getScriptImageByContainerName penpot-exporter)
    container_name: penpot-exporter
    hostname: penpot-exporter
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - penpot-db
    networks:
      - int-penpot-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
    environment:
      - PENPOT_PUBLIC_URI=http://penpot-frontend

  penpot-redis:
    image: $(getScriptImageByContainerName penpot-redis)
    container_name: penpot-redis
    hostname: penpot-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-penpot-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-penpot-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$PENPOT_REDIS_PASSWORD

volumes:
  v-penpot-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/penpot/db
  v-penpot-assets:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/penpot/assets
  v-penpot-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/penpot/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  int-penpot-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFPI

  cat <<EOFPI > $HOME/penpot.env
TZ=\${TZ}
PENPOT_FLAGS=enable-webhooks enable-smtp enable-prepl-server enable-login-with-ldap enable-backend-api-doc disable-login-with-password disable-onboarding
PENPOT_PUBLIC_URI=https://$SUB_PENPOT.$HOMESERVER_DOMAIN
PENPOT_TELEMETRY_ENABLED=false
PENPOT_SECRET_KEY=$PENPOT_SECRET_KEY
PENPOT_SMTP_DEFAULT_FROM=Penpot $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>
PENPOT_SMTP_DEFAULT_REPLY_TO=$EMAIL_ADMIN_EMAIL_ADDRESS
PENPOT_SMTP_HOST=$SMTP_HOSTNAME
PENPOT_SMTP_PORT=$SMTP_HOSTPORT
PENPOT_SMTP_TLS=true
PENPOT_ASSETS_STORAGE_BACKEND=assets-fs
PENPOT_STORAGE_ASSETS_FS_DIRECTORY=/opt/data/assets
PENPOT_DATABASE_URI=postgresql://penpot-db/$PENPOT_DATABASE_NAME
PENPOT_DATABASE_USERNAME=$PENPOT_DATABASE_USER
PENPOT_DATABASE_PASSWORD=$PENPOT_DATABASE_USER_PASSWORD
PENPOT_REDIS_URI=redis://:$PENPOT_REDIS_PASSWORD@penpot-redis:6379/0
POSTGRES_DB=$PENPOT_DATABASE_NAME
POSTGRES_USER=$PENPOT_DATABASE_USER
POSTGRES_PASSWORD=$PENPOT_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--data-checksums
PENPOT_LDAP_HOST=ldapserver
PENPOT_LDAP_PORT=389
PENPOT_LDAP_SSL=false
PENPOT_LDAP_STARTTLS=true
PENPOT_LDAP_BASE_DN=ou=people,$LDAP_BASE_DN
PENPOT_LDAP_BIND_DN=$LDAP_READONLY_USER_BIND_DN
PENPOT_LDAP_BIND_PASSWORD=$LDAP_READONLY_USER_PASSWORD
PENPOT_LDAP_USER_QUERY=(&(|(uid=:username)(mail=:username))(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN))
PENPOT_LDAP_ATTRS_USERNAME=uid
PENPOT_LDAP_ATTRS_EMAIL=mail
PENPOT_LDAP_ATTRS_FULLNAME=cn
PENPOT_LDAP_ATTRS_PHOTO=jpegPhoto
EOFPI

}

function performUpdatePenpot()
{
  perform_stack_name=penpot
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=postgres:15.0-bullseye,penpotapp/backend:2.2.1,penpotapp/frontend:2.2.1,penpotapp/exporter:2.2.1,bitnami/redis:7.0.5
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="penpotapp/backend:2.2.1,penpotapp/backend:2.5.4"
      image_update_map[2]="penpotapp/frontend:2.2.1,penpotapp/frontend:2.5.4"
      image_update_map[3]="penpotapp/exporter:2.2.1,penpotapp/exporter:2.5.4"
      image_update_map[4]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
      upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" mfPenpotFixPort false
      perform_update_report="${perform_update_report}$stack_upgrade_report"
      return
    ;;
    2)
      newVer=v2
      curImageList=postgres:15.0-bullseye,penpotapp/backend:2.5.4,penpotapp/frontend:2.5.4,penpotapp/exporter:2.5.4,bitnami/redis:7.4.2
      image_update_map[0]="postgres:15.0-bullseye,postgres:15.0-bullseye"
      image_update_map[1]="penpotapp/backend:2.5.4,penpotapp/backend:2.5.4"
      image_update_map[2]="penpotapp/frontend:2.5.4,penpotapp/frontend:2.5.4"
      image_update_map[3]="penpotapp/exporter:2.5.4,penpotapp/exporter:2.5.4"
      image_update_map[4]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function mfPenpotFixPort()
{
  inner_block=""
  inner_block=$inner_block">>https://$SUB_PENPOT.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://penpot-frontend:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PENPOT $MANAGETLS_PENPOT "$is_integrate_hshq" $NETDEFAULT_PENPOT "$inner_block"
  set +e
  restartAllCaddyContainers
}

# EspoCRM
function installEspoCRM()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory espocrm "$FMLNAME_ESPOCRM"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName espocrm-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName espocrm-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName espocrm-daemon)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName espocrm-websocket)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/espocrm
  mkdir $HSHQ_STACKS_DIR/espocrm/db
  mkdir $HSHQ_STACKS_DIR/espocrm/dbexport
  mkdir $HSHQ_STACKS_DIR/espocrm/app
  chmod 777 $HSHQ_STACKS_DIR/espocrm/dbexport

  initServicesCredentials
  set +e
  outputConfigEspoCRM
  installStack espocrm espocrm-app "apache2 -D FOREGROUND" $HOME/espocrm.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  if ! [ "$ESPOCRM_INIT_ENV" = "true" ]; then
    sendEmail -s "EspoCRM Login Info" -b "EspoCRM Admin Username: $ESPOCRM_ADMIN_USERNAME\nPassword: $ESPOCRM_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    ESPOCRM_INIT_ENV=true
    updateConfigVar ESPOCRM_INIT_ENV $ESPOCRM_INIT_ENV
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy /ws espocrm-websocket:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://espocrm-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_ESPOCRM $MANAGETLS_ESPOCRM "$is_integrate_hshq" $NETDEFAULT_ESPOCRM "$inner_block"
  insertSubAuthelia $SUB_ESPOCRM.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll espocrm "$FMLNAME_ESPOCRM" $USERTYPE_ESPOCRM "https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN" "espocrm.png" "$(getHeimdallOrderFromSub $SUB_ESPOCRM $USERTYPE_ESPOCRM)"
    restartAllCaddyContainers
    checkAddDBConnection true espocrm "$FMLNAME_ESPOCRM" mysql espocrm-db $ESPOCRM_DATABASE_NAME $ESPOCRM_DATABASE_USER $ESPOCRM_DATABASE_USER_PASSWORD
  fi
}

function outputConfigEspoCRM()
{
  cat <<EOFPI > $HOME/espocrm-compose.yml
$STACK_VERSION_PREFIX espocrm $(getScriptStackVersion espocrm)

services:
  espocrm-db:
    image: $(getScriptImageByContainerName espocrm-db)
    container_name: espocrm-db
    hostname: espocrm-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-espocrm-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-espocrm-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/espocrm/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.espocrm-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.espocrm-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.espocrm-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.espocrm-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.espocrm-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.espocrm-hourly-db.email-from=EspoCRM Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.espocrm-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.espocrm-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.espocrm-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.espocrm-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.espocrm-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.espocrm-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.espocrm-monthly-db.email-from=EspoCRM Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.espocrm-monthly-db.mail-only-on-error=false"

  espocrm-app:
    image: $(getScriptImageByContainerName espocrm-app)
    container_name: espocrm-app
    hostname: espocrm-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - espocrm-db
    networks:
      - int-espocrm-net
      - dock-proxy-net
      - dock-internalmail-net
      - dock-ldap-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-espocrm-app:/var/www/html

  espocrm-daemon:
    image: $(getScriptImageByContainerName espocrm-daemon)
    container_name: espocrm-daemon
    hostname: espocrm-daemon
    restart: unless-stopped
    env_file: stack.env
    entrypoint: docker-daemon.sh
    security_opt:
      - no-new-privileges:true
    depends_on:
      - espocrm-db
    networks:
      - int-espocrm-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-espocrm-app:/var/www/html

  espocrm-websocket:
    image: $(getScriptImageByContainerName espocrm-websocket)
    container_name: espocrm-websocket
    hostname: espocrm-websocket
    restart: unless-stopped
    env_file: stack.env
    entrypoint: docker-websocket.sh
    security_opt:
      - no-new-privileges:true
    depends_on:
      - espocrm-db
    networks:
      - int-espocrm-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-espocrm-app:/var/www/html

volumes:
  v-espocrm-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/espocrm/db
  v-espocrm-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/espocrm/app

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  int-espocrm-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFPI

  cat <<EOFPI > $HOME/espocrm.env
ESPOCRM_TIME_ZONE=\${TZ}
ESPOCRM_DATE_FORMAT=YYYY-MM-DD
ESPOCRM_DATABASE_HOST=espocrm-db
ESPOCRM_DATABASE_PORT=3306
ESPOCRM_DATABASE_NAME=$ESPOCRM_DATABASE_NAME
ESPOCRM_DATABASE_USER=$ESPOCRM_DATABASE_USER
ESPOCRM_DATABASE_PASSWORD=$ESPOCRM_DATABASE_USER_PASSWORD
MYSQL_DATABASE=$ESPOCRM_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$ESPOCRM_DATABASE_ROOT_PASSWORD
MYSQL_USER=$ESPOCRM_DATABASE_USER
MYSQL_PASSWORD=$ESPOCRM_DATABASE_USER_PASSWORD
ESPOCRM_ADMIN_USERNAME=$ESPOCRM_ADMIN_USERNAME
ESPOCRM_ADMIN_PASSWORD=$ESPOCRM_ADMIN_PASSWORD
ESPOCRM_SITE_URL=https://$SUB_ESPOCRM.$HOMESERVER_DOMAIN
ESPOCRM_CONFIG_USE_WEB_SOCKET=true
ESPOCRM_CONFIG_WEB_SOCKET_URL=wss://$SUB_ESPOCRM.$HOMESERVER_DOMAIN/ws
ESPOCRM_CONFIG_WEB_SOCKET_ZERO_M_Q_SUBSCRIBER_DSN=tcp://*:7777
ESPOCRM_CONFIG_WEB_SOCKET_ZERO_M_Q_SUBMISSION_DSN=tcp://espocrm-websocket:7777
ESPOCRM_CONFIG_OUTBOUND_EMAIL_IS_SHARED=false
ESPOCRM_CONFIG_OUTBOUND_EMAIL_FROM_NAME=EspoCRM $(getAdminEmailName)
ESPOCRM_CONFIG_OUTBOUND_EMAIL_FROM_ADDRESS=$EMAIL_SMTP_EMAIL_ADDRESS
ESPOCRM_CONFIG_SMTP_SERVER=$SMTP_HOSTNAME
ESPOCRM_CONFIG_SMTP_PORT=$SMTP_HOSTPORT
ESPOCRM_CONFIG_SMTP_AUTH=false
ESPOCRM_CONFIG_SMTP_SECURITY=TLS
ESPOCRM_CONFIG_AUTHENTICATION_METHOD=LDAP
ESPOCRM_CONFIG_THEME=Dark
ESPOCRM_CONFIG_LDAP_HOST=ldapserver
ESPOCRM_CONFIG_LDAP_PORT=389
ESPOCRM_CONFIG_LDAP_SECURITY=TLS
ESPOCRM_CONFIG_LDAP_BASE_DN=ou=people,$LDAP_BASE_DN
ESPOCRM_CONFIG_LDAP_USER_NAME_ATTRIBUTE=uid
ESPOCRM_CONFIG_LDAP_USER_LOGIN_FILTER=memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN
ESPOCRM_CONFIG_LDAP_AUTH=true
ESPOCRM_CONFIG_LDAP_USERNAME=$LDAP_READONLY_USER_BIND_DN
ESPOCRM_CONFIG_LDAP_PASSWORD=$LDAP_READONLY_USER_PASSWORD
ESPOCRM_CONFIG_LDAP_ACCOUNT_CANONICAL_FORM=Dn
ESPOCRM_CONFIG_LDAP_CREATE_ESPO_USER=true
EOFPI

}

function performUpdateEspoCRM()
{
  perform_stack_name=espocrm
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=mariadb:10.7.3,espocrm/espocrm:8.4.2-apache
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="espocrm/espocrm:8.4.2-apache,espocrm/espocrm:9.0.6-apache"
    ;;
    2)
      newVer=v2
      curImageList=mariadb:10.7.3,espocrm/espocrm:9.0.6-apache
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="espocrm/espocrm:9.0.6-apache,espocrm/espocrm:9.0.6-apache"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Immich
function installImmich()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory immich "$FMLNAME_IMMICH"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName immich-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName immich-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName immich-ml)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName immich-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi

  mkdir $HSHQ_STACKS_DIR/immich
  mkdir $HSHQ_STACKS_DIR/immich/db
  mkdir $HSHQ_STACKS_DIR/immich/dbexport
  mkdir $HSHQ_STACKS_DIR/immich/app
  mkdir $HSHQ_STACKS_DIR/immich/config
  chmod 777 $HSHQ_STACKS_DIR/immich/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/immich
  mkdir $HSHQ_NONBACKUP_DIR/immich/redis
  mkdir $HSHQ_NONBACKUP_DIR/immich/cache
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $IMMICH_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $IMMICH_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS

  IMMICH_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $IMMICH_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$2y/\$2b/')
  IMMICH_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $IMMICH_OIDC_CLIENT_SECRET | tr -d ':\n')
  outputConfigImmich
  oidcBlock=$(cat $HOME/immich.oidc)
  rm -f $HOME/immich.oidc
  insertOIDCClientAuthelia immich "$oidcBlock"
  set +e
  installStack immich immich-app "Immich Server is listening on" $HOME/immich.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  docker exec -u postgres immich-db psql immichdb immich-user -f /dbexport/addadmin.sql > /dev/null 2>&1
  rm -f $HSHQ_STACKS_DIR/immich/dbexport/addadmin.sql

  if ! [ "$IMMICH_INIT_ENV" = "true" ]; then
    sendEmail -s "Immich Login Info" -b "Immich Admin Username: $IMMICH_ADMIN_EMAIL_ADDRESS\nPassword: $IMMICH_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    IMMICH_INIT_ENV=true
    updateConfigVar IMMICH_INIT_ENV $IMMICH_INIT_ENV
  fi
  set +e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_IMMICH.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://immich-app:2283 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_IMMICH $MANAGETLS_IMMICH "$is_integrate_hshq" $NETDEFAULT_IMMICH "$inner_block"
  insertSubAuthelia $SUB_IMMICH.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll immich "$FMLNAME_IMMICH" $USERTYPE_IMMICH "https://$SUB_IMMICH.$HOMESERVER_DOMAIN" "immich.png" "$(getHeimdallOrderFromSub $SUB_IMMICH $USERTYPE_IMMICH)"
    restartAllCaddyContainers
    checkAddDBConnection true immich "$FMLNAME_IMMICH" postgres immich-db $IMMICH_DATABASE_NAME $IMMICH_DATABASE_USER $IMMICH_DATABASE_USER_PASSWORD
  fi
}

function outputConfigImmich()
{
  cat <<EOFPI > $HOME/immich-compose.yml
$STACK_VERSION_PREFIX immich $(getScriptStackVersion immich)

services:
  immich-db:
    image: $(getScriptImageByContainerName immich-db)
    container_name: immich-db
    hostname: immich-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: ['postgres','-c','shared_preload_libraries=vectors.so','-c','search_path="$$user", public, vectors','-c','logging_collector=on','-c','max_wal_size=2GB','-c','shared_buffers=512MB','-c','wal_compression=on',]
    networks:
      - int-immich-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/immich/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/immich/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.immich-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.immich-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.immich-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.immich-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.immich-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.immich-hourly-db.email-from=Immich Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.immich-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.immich-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.immich-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.immich-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.immich-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.immich-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.immich-monthly-db.email-from=Immich Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.immich-monthly-db.mail-only-on-error=false"

  immich-app:
    image: $(getScriptImageByContainerName immich-app)
    # extends:
    #   file: hwaccel.transcoding.yml
    #   service: cpu
    container_name: immich-app
    hostname: immich-app
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - immich-db
    networks:
      - int-immich-net
      - dock-proxy-net
      - dock-internalmail-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/immich/app:/usr/src/app/upload
      - \${HSHQ_STACKS_DIR}/immich/config/immich.json:/config/immich.json

  immich-ml:
    image: $(getScriptImageByContainerName immich-ml)
    # extends:
    #   file: hwaccel.ml.yml
    #   service: cpu
    container_name: immich-ml
    hostname: immich-ml
    restart: unless-stopped
    env_file: stack.env
    depends_on:
      - immich-db
    networks:
      - int-immich-net
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-immich-cache:/cache

  immich-redis:
    image: $(getScriptImageByContainerName immich-redis)
    container_name: immich-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-immich-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-immich-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$IMMICH_REDIS_PASSWORD

volumes:
  v-immich-cache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/immich/cache
  v-immich-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/immich/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  int-immich-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFPI

  cat <<EOFPI > $HOME/immich.env
TZ=\${TZ}
NO_COLOR=true
IMMICH_CONFIG_FILE=/config/immich.json
IMMICH_PROCESS_INVALID_IMAGES=true
IMMICH_TRUSTED_PROXIES=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16
DB_HOSTNAME=immich-db
DB_DATABASE_NAME=$IMMICH_DATABASE_NAME
DB_USERNAME=$IMMICH_DATABASE_USER
DB_PASSWORD=$IMMICH_DATABASE_USER_PASSWORD
POSTGRES_PASSWORD=$IMMICH_DATABASE_USER_PASSWORD
POSTGRES_USER=$IMMICH_DATABASE_USER
POSTGRES_DB=$IMMICH_DATABASE_NAME
POSTGRES_INITDB_ARGS=--data-checksums
REDIS_HOSTNAME=immich-redis
REDIS_PASSWORD=$IMMICH_REDIS_PASSWORD
NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
EOFPI

  cat <<EOFIM > $HSHQ_STACKS_DIR/immich/config/immich.json
{
  "ffmpeg": {
    "crf": 23,
    "threads": 0,
    "preset": "ultrafast",
    "targetVideoCodec": "h264",
    "acceptedVideoCodecs": ["h264"],
    "targetAudioCodec": "aac",
    "acceptedAudioCodecs": ["aac", "mp3", "libopus", "pcm_s16le"],
    "acceptedContainers": ["mov", "ogg", "webm"],
    "targetResolution": "720",
    "maxBitrate": "0",
    "bframes": -1,
    "refs": 0,
    "gopSize": 0,
    "temporalAQ": false,
    "cqMode": "auto",
    "twoPass": false,
    "preferredHwDevice": "auto",
    "transcode": "required",
    "tonemap": "hable",
    "accel": "disabled",
    "accelDecode": false
  },
  "backup": {
    "database": {
      "enabled": true,
      "cronExpression": "0 02 * * *",
      "keepLastAmount": 14
    }
  },
  "job": {
    "backgroundTask": {
      "concurrency": 5
    },
    "smartSearch": {
      "concurrency": 2
    },
    "metadataExtraction": {
      "concurrency": 5
    },
    "faceDetection": {
      "concurrency": 2
    },
    "search": {
      "concurrency": 5
    },
    "sidecar": {
      "concurrency": 5
    },
    "library": {
      "concurrency": 5
    },
    "migration": {
      "concurrency": 5
    },
    "thumbnailGeneration": {
      "concurrency": 3
    },
    "videoConversion": {
      "concurrency": 1
    },
    "notifications": {
      "concurrency": 5
    }
  },
  "logging": {
    "enabled": true,
    "level": "log"
  },
  "machineLearning": {
    "enabled": true,
    "url": "http://immich-ml:3003",
    "clip": {
      "enabled": true,
      "modelName": "ViT-B-32__openai"
    },
    "duplicateDetection": {
      "enabled": true,
      "maxDistance": 0.01
    },
    "facialRecognition": {
      "enabled": true,
      "modelName": "buffalo_l",
      "minScore": 0.7,
      "maxDistance": 0.5,
      "minFaces": 3
    }
  },
  "map": {
    "enabled": true,
    "lightStyle": "https://tiles.immich.cloud/v1/style/light.json",
    "darkStyle": "https://tiles.immich.cloud/v1/style/dark.json"
  },
  "reverseGeocoding": {
    "enabled": true
  },
  "metadata": {
    "faces": {
      "import": false
    }
  },
  "oauth": {
    "autoLaunch": false,
    "autoRegister": true,
    "buttonText": "Login with Authelia",
    "clientId": "immich",
    "clientSecret": "$IMMICH_OIDC_CLIENT_SECRET",
    "defaultStorageQuota": 0,
    "enabled": true,
    "issuerUrl": "https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/.well-known/openid-configuration",
    "mobileOverrideEnabled": false,
    "mobileRedirectUri": "",
    "scope": "openid profile email",
    "signingAlgorithm": "RS256",
    "profileSigningAlgorithm": "none",
    "storageLabelClaim": "preferred_username",
    "storageQuotaClaim": "immich_quota"
  },
  "passwordLogin": {
    "enabled": true
  },
  "storageTemplate": {
    "enabled": false,
    "hashVerificationEnabled": true,
    "template": "{{y}}/{{y}}-{{MM}}-{{dd}}/{{filename}}"
  },
  "image": {
    "thumbnail": {
      "format": "webp",
      "size": 250,
      "quality": 80
    },
    "preview": {
      "format": "jpeg",
      "size": 1440,
      "quality": 80
    },
    "colorspace": "p3",
    "extractEmbedded": false
  },
  "newVersionCheck": {
    "enabled": true
  },
  "trash": {
    "enabled": true,
    "days": 30
  },
  "theme": {
    "customCss": ""
  },
  "library": {
    "scan": {
      "enabled": true,
      "cronExpression": "*/15 * * * *"
    },
    "watch": {
      "enabled": true
    }
  },
  "server": {
    "externalDomain": "https://$SUB_IMMICH.$HOMESERVER_DOMAIN/",
    "loginPageMessage": "Welcome to Immich on $HOMESERVER_NAME!"
  },
  "notifications": {
    "smtp": {
      "enabled": true,
      "from": "Immich $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>",
      "replyTo": "$EMAIL_ADMIN_EMAIL_ADDRESS",
      "transport": {
        "ignoreCert": false,
        "host": "$SMTP_HOSTNAME",
        "port": $SMTP_HOSTPORT,
        "username": "",
        "password": ""
      }
    }
  },
  "user": {
    "deleteDelay": 7
  }
}
EOFIM

  cat <<EOFIM > $HOME/immich.oidc
# Authelia OIDC Client immich BEGIN
      - client_id: immich
        client_name: Immich
        client_secret: '$IMMICH_OIDC_CLIENT_SECRET_HASH'
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        redirect_uris:
          - https://$SUB_IMMICH.$HOMESERVER_DOMAIN/auth/login
          - https://$SUB_IMMICH.$HOMESERVER_DOMAIN/user-settings
          - app.immich:///oauth-callback
        scopes:
          - openid
          - profile
          - email
          - groups
        userinfo_signed_response_alg: none
# Authelia OIDC Client immich END
EOFIM

  curdt=$(date '+%Y-%m-%d %H:%M:%S.%3N')
  cat <<EOFIM > $HSHQ_STACKS_DIR/immich/dbexport/addadmin.sql
insert into users(id,email,password,"createdAt","profileImagePath","isAdmin","shouldChangePassword","deletedAt","oauthId","updatedAt","storageLabel",name,"quotaSizeInBytes","quotaUsageInBytes",status,"profileChangedAt") values(gen_random_uuid(),'$IMMICH_ADMIN_EMAIL_ADDRESS','$IMMICH_ADMIN_PASSWORD_HASH','$curdt','',true,true,NULL,'','$curdt','admin','$(getAdminEmailName) Immich',NULL,0,'active','$curdt');
EOFIM
}

function performUpdateImmich()
{
  perform_stack_name=immich
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=docker.io/tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0,ghcr.io/immich-app/immich-server:v1.121.0,ghcr.io/immich-app/immich-machine-learning:v1.121.0,bitnami/redis:7.0.5
      image_update_map[0]="docker.io/tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0,tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0"
      image_update_map[1]="ghcr.io/immich-app/immich-server:v1.121.0,ghcr.io/immich-app/immich-server:v1.131.3"
      image_update_map[2]="ghcr.io/immich-app/immich-machine-learning:v1.121.0,ghcr.io/immich-app/immich-machine-learning:v1.131.3"
      image_update_map[3]="bitnami/redis:7.0.5,bitnami/redis:7.4.2"
    ;;
    2)
      newVer=v2
      curImageList=tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0,ghcr.io/immich-app/immich-machine-learning:v1.131.3,bitnami/redis:7.4.2
      image_update_map[0]="tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0,tensorchord/pgvecto-rs:pg14-v0.2.0@sha256:90724186f0a3517cf6914295b5ab410db9ce23190a2d9d0b9dd6463e3fa298f0"
      image_update_map[1]="ghcr.io/immich-app/immich-server:v1.131.3,ghcr.io/immich-app/immich-server:v1.131.3"
      image_update_map[2]="ghcr.io/immich-app/immich-machine-learning:v1.131.3,ghcr.io/immich-app/immich-machine-learning:v1.131.3"
      image_update_map[3]="bitnami/redis:7.4.2,bitnami/redis:7.4.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Homarr
function installHomarr()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory homarr "$FMLNAME_HOMARR"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName homarr-app)
  if [ $? -ne 0 ]; then
    return 1
  fi

  mkdir $HSHQ_STACKS_DIR/homarr
  mkdir $HSHQ_STACKS_DIR/homarr/data
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $HOMARR_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $HOMARR_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  HOMARR_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $HOMARR_OIDC_CLIENT_SECRET | tr -d ':\n')
  HOMARR_NEXTAUTH_SECRET=$(pwgen -c -n 32 1)
  HOMARR_SECRET_ENCRYPTION_KEY=$(openssl rand -hex 32)
  outputConfigHomarr
  oidcBlock=$(cat $HOME/homarr.oidc)
  rm -f $HOME/homarr.oidc
  insertOIDCClientAuthelia homarr "$oidcBlock"
  set +e
  installStack homarr homarr-app "Ready to accept connections" $HOME/homarr.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  rand_uid=$(pwgen -c -n -A 24 1)
  HOMARR_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $HOMARR_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$2y/\$2a/')
  HOMARR_PASSWORD_SALT_HASH=$(htpasswd -bnBC 10 "" $(pwgen -c -n 32 1) | tr -d ':\n' | sed 's/\$2y/\$2a/')
  rand_groupid=$(pwgen -c -n -A 24 1)
  everyone_gid=$(sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "select id from 'group' where name='everyone';")
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "insert into user(id,name,email,password,salt) values('$rand_uid', '$HOMARR_ADMIN_USERNAME','$HOMARR_ADMIN_EMAIL_ADDRESS','$HOMARR_ADMIN_PASSWORD_HASH','$HOMARR_PASSWORD_SALT_HASH');"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "insert into 'group'(id,name,owner_id,position) values('$rand_groupid','$LDAP_ADMIN_USER_GROUP_NAME','$rand_uid',1);"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "insert into groupMember(group_id,user_id) values('$everyone_gid','$rand_uid');"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "insert into groupMember(group_id,user_id) values('$rand_groupid','$rand_uid');"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "insert into groupPermission(group_id,permission) values('$rand_groupid','admin');"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "update search_engine set icon_url='https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/svg/brave.svg', name='Brave', short='b', description='Search the web with Brave', url_template='https://search.brave.com/search?q=%s' where name='Google';"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "update serverSetting set value='{\"json\":{\"enableGeneral\":false,\"enableWidgetData\":false,\"enableIntegrationData\":false,\"enableUserData\":false}}' where setting_key='analytics';"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "update serverSetting set value='{\"json\":{\"defaultColorScheme\":\"dark\"}}' where setting_key='appearance';"
  searchEngID=$(sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "select id from 'search_engine' where name='Brave';")
  # Change the default search engine since the homarr docs search is broken
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "update serverSetting set value='{\"json\":{\"defaultSearchEngineId\":\"$searchEngID\"}}' where setting_key='search';"
  sudo sqlite3 $HSHQ_STACKS_DIR/homarr/data/db/db.sqlite "update onboarding set step='finish', previous_step='settings';"
  sleep 1
  startStopStack homarr stop
  sleep 1
  startStopStack homarr start
  set +e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_HOMARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://homarr-app:7575 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HOMARR $MANAGETLS_HOMARR "$is_integrate_hshq" $NETDEFAULT_HOMARR "$inner_block"
  insertSubAuthelia $SUB_HOMARR.$HOMESERVER_DOMAIN bypass

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll homarr "$FMLNAME_HOMARR" $USERTYPE_HOMARR "https://$SUB_HOMARR.$HOMESERVER_DOMAIN" "homarr.png" "$(getHeimdallOrderFromSub $SUB_HOMARR $USERTYPE_HOMARR)"
    restartAllCaddyContainers
  fi
}

function outputConfigHomarr()
{
  cat <<EOFPI > $HOME/homarr-compose.yml
$STACK_VERSION_PREFIX homarr $(getScriptStackVersion homarr)

services:
  homarr-app:
    image: $(getScriptImageByContainerName homarr-app)
    container_name: homarr-app
    hostname: homarr-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/homarr/data:/appdata

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true

EOFPI

  cat <<EOFPI > $HOME/homarr.env
TZ=\${TZ}
AUTH_TRUST_HOST=true
NEXTAUTH_SECRET=$HOMARR_NEXTAUTH_SECRET
SECRET_ENCRYPTION_KEY=$HOMARR_SECRET_ENCRYPTION_KEY
NEXT_PUBLIC_DISABLE_ANALYTICS=true
DEFAULT_COLOR_SCHEME=dark
NEXTAUTH_URL=https://$SUB_HOMARR.$HOMESERVER_DOMAIN
NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
NODE_TLS_REJECT_UNAUTHORIZED=0
AUTH_PROVIDERS=credentials,oidc
AUTH_OIDC_ISSUER=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
AUTH_OIDC_CLIENT_ID=homarr
AUTH_OIDC_CLIENT_SECRET=$HOMARR_OIDC_CLIENT_SECRET
AUTH_OIDC_CLIENT_NAME=Authelia
AUTH_OIDC_ADMIN_GROUP=${LDAP_ADMIN_USER_GROUP_NAME}
AUTH_OIDC_OWNER_GROUP=${LDAP_PRIMARY_USER_GROUP_NAME}
AUTH_OIDC_AUTO_LOGIN=false
AUTH_OIDC_SCOPE_OVERWRITE=openid email profile groups
AUTH_OIDC_GROUPS_ATTRIBUTE=groups
AUTH_OIDC_FORCE_USERINFO=true
AUTH_LOGOUT_REDIRECT_URL=https://$SUB_HOMARR.$HOMESERVER_DOMAIN
EOFPI

  cat <<EOFIM > $HOME/homarr.oidc
# Authelia OIDC Client homarr BEGIN
      - client_id: homarr
        client_name: Homarr
        client_secret: $HOMARR_OIDC_CLIENT_SECRET_HASH
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        redirect_uris:
          - https://$SUB_HOMARR.$HOMESERVER_DOMAIN/api/auth/callback/oidc
        scopes:
          - openid
          - profile
          - groups
          - email
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic
# Authelia OIDC Client homarr END
EOFIM

}

function performUpdateHomarr()
{
  perform_stack_name=homarr
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=ghcr.io/ajnart/homarr:0.15.7
      image_update_map[0]="ghcr.io/ajnart/homarr:0.15.7,ghcr.io/ajnart/homarr:0.15.10"
    ;;
    2)
      newVer=v2
      curImageList=ghcr.io/ajnart/homarr:0.15.10
      image_update_map[0]="ghcr.io/ajnart/homarr:0.15.10,ghcr.io/ajnart/homarr:0.15.10"
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): This version of Homarr cannot be upgraded to the next version. You must export your data from this instance, uninstall and reinstall the homarr stack, then import your data into the new instance. See https://homarr.dev/blog/2025/01/19/migration-guide-1.0/ for migration instructions."
      return
    ;;
    3)
      newVer=v3
      curImageList=ghcr.io/homarr-labs/homarr:v1.18.1
      image_update_map[0]="ghcr.io/homarr-labs/homarr:v1.18.1,ghcr.io/homarr-labs/homarr:v1.18.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Matomo
function installMatomo()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory matomo "Matomo"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matomo-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matomo-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName matomo-web)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/matomo
  mkdir $HSHQ_STACKS_DIR/matomo/config
  mkdir $HSHQ_STACKS_DIR/matomo/db
  mkdir $HSHQ_STACKS_DIR/matomo/dbexport
  mkdir $HSHQ_STACKS_DIR/matomo/web
  chmod 777 $HSHQ_STACKS_DIR/matomo/dbexport
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $MATOMO_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $MATOMO_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  MATOMO_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $MATOMO_ADMIN_PASSWORD | tr -d ':\n')

  outputConfigMatomo
  installStack matomo matomo-app "ready to handle connections" $HOME/matomo.env 5
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$MATOMO_INIT_ENV" = "true" ]; then
    sendEmail -s "Matomo Admin Login Info" -b "Matomo Admin Username: $MATOMO_ADMIN_USERNAME\nMatomo Admin Email: ${MATOMO_ADMIN_USERNAME}@${HOMESERVER_DOMAIN}\nMatomo Admin Password: $MATOMO_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    MATOMO_INIT_ENV=true
    updateConfigVar MATOMO_INIT_ENV $MATOMO_INIT_ENV
  fi
  sleep 3
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_MATOMO.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://matomo-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_MATOMO $MANAGETLS_MATOMO "$is_integrate_hshq" $NETDEFAULT_MATOMO "$inner_block"
  insertSubAuthelia $SUB_MATOMO.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll matomo "$FMLNAME_MATOMO" $USERTYPE_MATOMO "https://$SUB_MATOMO.$HOMESERVER_DOMAIN" "matomo.png" "$(getHeimdallOrderFromSub $SUB_MATOMO $USERTYPE_MATOMO)"
    restartAllCaddyContainers
    checkAddDBConnection true matomo "$FMLNAME_MATOMO" mysql matomo-db $MATOMO_DATABASE_NAME $MATOMO_DATABASE_USER $MATOMO_DATABASE_USER_PASSWORD
  fi
}

function outputConfigMatomo()
{
  cat <<EOFMT > $HOME/matomo-compose.yml
$STACK_VERSION_PREFIX matomo $(getScriptStackVersion matomo)

services:
  matomo-db:
    image: $(getScriptImageByContainerName matomo-db)
    container_name: matomo-db
    hostname: matomo-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-matomo-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-matomo-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/matomo/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.matomo-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.matomo-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.matomo-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.matomo-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.matomo-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.matomo-hourly-db.email-from=Matomo Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.matomo-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.matomo-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.matomo-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.matomo-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.matomo-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.matomo-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.matomo-monthly-db.email-from=Matomo Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.matomo-monthly-db.mail-only-on-error=false"

  matomo-app:
    image: $(getScriptImageByContainerName matomo-app)
    container_name: matomo-app
    hostname: matomo-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - matomo-db
    networks:
      - int-matomo-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-matomo-web:/var/www/html:z

  matomo-web:
    image: $(getScriptImageByContainerName matomo-web)
    container_name: matomo-web
    hostname: matomo-web
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-matomo-net
      - dock-proxy-net
    depends_on:
      - matomo-app
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/matomo/config/nginx.conf:/etc/nginx/conf.d/default.conf:z,ro
      - v-matomo-web:/var/www/html:z,ro

volumes:
  v-matomo-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/matomo/db
  v-matomo-web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/matomo/web

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-matomo-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFMT

  cat <<EOFMT > $HOME/matomo.env
TZ=\${TZ}
MYSQL_DATABASE=$MATOMO_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$MATOMO_DATABASE_ROOT_PASSWORD
MYSQL_USER=$MATOMO_DATABASE_USER
MYSQL_PASSWORD=$MATOMO_DATABASE_USER_PASSWORD
MATOMO_DATABASE_HOST=matomo-db
MATOMO_DATABASE_ADAPTER=mysql
MATOMO_DATABASE_TABLES_PREFIX=matomo_
MATOMO_DATABASE_USERNAME=$MATOMO_DATABASE_USER
MATOMO_DATABASE_PASSWORD=$MATOMO_DATABASE_USER_PASSWORD
MATOMO_DATABASE_DBNAME=$MATOMO_DATABASE_NAME
EOFMT

  cat <<EOFMT > $HSHQ_STACKS_DIR/matomo/config/nginx.conf
upstream php-handler {
	server matomo-app:9000;
}

server {
	listen 80;

	add_header Referrer-Policy origin; # make sure outgoing links don't show the URL to the Matomo instance
	root /var/www/html; # replace with path to your matomo instance
	index index.php;
	try_files \$uri \$uri/ =404;

	## only allow accessing the following php files
	location ~ ^/(index|matomo|piwik|js/index|plugins/HeatmapSessionRecording/configs).php {
		# regex to split \$uri to \$fastcgi_script_name and \$fastcgi_path
		fastcgi_split_path_info ^(.+\.php)(/.+)\$;

		# Check that the PHP script exists before passing it
		try_files \$fastcgi_script_name =404;

		include fastcgi_params;
		fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
		fastcgi_param PATH_INFO \$fastcgi_path_info;
		fastcgi_param HTTP_PROXY ""; # prohibit httpoxy: https://httpoxy.org/
		fastcgi_pass php-handler;
	}

	## deny access to all other .php files
	location ~* ^.+\.php\$ {
		deny all;
		return 403;
	}

	## disable all access to the following directories
	location ~ /(config|tmp|core|lang) {
		deny all;
		return 403; # replace with 404 to not show these directories exist
	}
	location ~ /\.ht {
		deny all;
		return 403;
	}

	location ~ js/container_.*_preview\.js\$ {
		expires off;
		add_header Cache-Control 'private, no-cache, no-store';
	}

	location ~ \.(gif|ico|jpg|png|svg|js|css|htm|html|mp3|mp4|wav|ogg|avi|ttf|eot|woff|woff2|json)\$ {
		allow all;
		## Cache images,CSS,JS and webfonts for an hour
		## Increasing the duration may improve the load-time, but may cause old files to show after an Matomo upgrade
		expires 1h;
		add_header Pragma public;
		add_header Cache-Control "public";
	}

	location ~ /(libs|vendor|plugins|misc/user) {
		deny all;
		return 403;
	}

	## properly display textfiles in root directory
	location ~/(.*\.md|LEGALNOTICE|LICENSE) {
		default_type text/plain;
	}
}

EOFMT

}

function performUpdateMatomo()
{
  perform_stack_name=matomo
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=mariadb:10.7.3,matomo:5.3.1-fpm-alpine,nginx:1.27.4-alpine
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="matomo:5.3.1-fpm-alpine,matomo:5.3.1-fpm-alpine"
      image_update_map[2]="nginx:1.27.4-alpine,nginx:1.27.4-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Pastefy
function installPastefy()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory pastefy "Pastefy"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName pastefy-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName pastefy-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/pastefy
  mkdir $HSHQ_STACKS_DIR/pastefy/db
  mkdir $HSHQ_STACKS_DIR/pastefy/dbexport
  chmod 777 $HSHQ_STACKS_DIR/pastefy/dbexport
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $PASTEFY_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $PASTEFY_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  PASTEFY_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $PASTEFY_ADMIN_PASSWORD | tr -d ':\n')
  outputConfigPastefy
  installStack pastefy pastefy-app "" $HOME/pastefy.env
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$PASTEFY_INIT_ENV" = "true" ]; then
    #sendEmail -s "Pastefy Admin Login Info" -b "Pastefy Admin Username: $PASTEFY_ADMIN_USERNAME\nPastefy Admin Password: $PASTEFY_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    PASTEFY_INIT_ENV=true
    updateConfigVar PASTEFY_INIT_ENV $PASTEFY_INIT_ENV
  fi
  sleep 3
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_PASTEFY.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://pastefy-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PASTEFY $MANAGETLS_PASTEFY "$is_integrate_hshq" $NETDEFAULT_PASTEFY "$inner_block"
  insertSubAuthelia $SUB_PASTEFY.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll pastefy "$FMLNAME_PASTEFY" $USERTYPE_PASTEFY "https://$SUB_PASTEFY.$HOMESERVER_DOMAIN" "pastefy.png" "$(getHeimdallOrderFromSub $SUB_PASTEFY $USERTYPE_PASTEFY)"
    restartAllCaddyContainers
    checkAddDBConnection true pastefy "$FMLNAME_PASTEFY" mysql pastefy-db $PASTEFY_DATABASE_NAME $PASTEFY_DATABASE_USER $PASTEFY_DATABASE_USER_PASSWORD
  fi
}

function outputConfigPastefy()
{
  cat <<EOFMT > $HOME/pastefy-compose.yml
$STACK_VERSION_PREFIX pastefy $(getScriptStackVersion pastefy)

services:
  pastefy-db:
    image: $(getScriptImageByContainerName pastefy-db)
    container_name: pastefy-db
    hostname: pastefy-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-pastefy-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-pastefy-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/pastefy/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.pastefy-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.pastefy-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.pastefy-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.pastefy-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.pastefy-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.pastefy-hourly-db.email-from=Pastefy Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.pastefy-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.pastefy-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.pastefy-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.pastefy-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.pastefy-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.pastefy-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.pastefy-monthly-db.email-from=Pastefy Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.pastefy-monthly-db.mail-only-on-error=false"

  pastefy-app:
    image: $(getScriptImageByContainerName pastefy-app)
    container_name: pastefy-app
    hostname: pastefy-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - pastefy-db
    networks:
      - int-pastefy-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

volumes:
  v-pastefy-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/pastefy/db

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-pastefy-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFMT

  cat <<EOFMT > $HOME/pastefy.env
TZ=\${TZ}
MYSQL_DATABASE=$PASTEFY_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$PASTEFY_DATABASE_ROOT_PASSWORD
MYSQL_USER=$PASTEFY_DATABASE_USER
MYSQL_PASSWORD=$PASTEFY_DATABASE_USER_PASSWORD
DATABASE_HOST=pastefy-db
DATABASE_DRIVER=mysql
DATABASE_NAME=$PASTEFY_DATABASE_NAME
DATABASE_USER=$PASTEFY_DATABASE_USER
DATABASE_PASSWORD=$PASTEFY_DATABASE_USER_PASSWORD
SERVER_NAME=https://$SUB_PASTEFY.$HOMESERVER_DOMAIN
PASTEFY_INFO_CUSTOM_NAME=$HOMESERVER_NAME Pastefy
PASTEFY_LOGIN_REQUIRED=false
PASTEFY_LOGIN_REQUIRED_CREATE=false
PASTEFY_LOGIN_REQUIRED_READ=false
PASTEFY_ENCRYPTION_DEFAULT=false
PASTEFY_GRANT_ACCESS_REQUIRED=false
PASTEFY_LIST_PASTES=true
PASTEFY_PUBLIC_STATS=true
PASTEFY_PUBLIC_PASTES=true
EOFMT

}

function performUpdatePastefy()
{
  perform_stack_name=pastefy
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=mariadb:10.7.3,interaapps/pastefy:7.0.3
      image_update_map[0]="mariadb:10.7.3,mariadb:10.7.3"
      image_update_map[1]="interaapps/pastefy:7.0.3,interaapps/pastefy:7.0.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# SnippetBox
function installSnippetBox()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory snippetbox "SnippetBox"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName snippetbox)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/snippetbox
  mkdir $HSHQ_STACKS_DIR/snippetbox/data
  set +e
  outputConfigSnippetBox
  installStack snippetbox snippetbox-app "" $HOME/snippetbox.env
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  sleep 3
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SNIPPETBOX.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://snippetbox:5000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SNIPPETBOX $MANAGETLS_SNIPPETBOX "$is_integrate_hshq" $NETDEFAULT_SNIPPETBOX "$inner_block"
  insertSubAuthelia $SUB_SNIPPETBOX.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll snippetbox "$FMLNAME_SNIPPETBOX" $USERTYPE_SNIPPETBOX "https://$SUB_SNIPPETBOX.$HOMESERVER_DOMAIN" "snippetbox.png" "$(getHeimdallOrderFromSub $SUB_SNIPPETBOX $USERTYPE_SNIPPETBOX)"
    restartAllCaddyContainers
  fi
}

function outputConfigSnippetBox()
{
  cat <<EOFMT > $HOME/snippetbox-compose.yml
$STACK_VERSION_PREFIX snippetbox $(getScriptStackVersion snippetbox)

services:
  snippetbox:
    image: $(getScriptImageByContainerName snippetbox)
    container_name: snippetbox
    hostname: snippetbox
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/snippetbox/data:/app/data

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true

EOFMT

  cat <<EOFMT > $HOME/snippetbox.env
TZ=\${TZ}

EOFMT

}

function performUpdateSnippetBox()
{
  perform_stack_name=snippetbox
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=pawelmalak/snippet-box:latest
      image_update_map[0]="pawelmalak/snippet-box:latest,pawelmalak/snippet-box:latest"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# AIStack
function installAIStack()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory aistack "AIStack"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-mindsdb-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-mindsdb-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-otel)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-langfuse)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-ollama-server)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-openwebui)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName aistack-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/aistack
  mkdir $HSHQ_STACKS_DIR/aistack/mindsdb
  mkdir $HSHQ_STACKS_DIR/aistack/mindsdb/app
  mkdir $HSHQ_STACKS_DIR/aistack/mindsdb/db
  mkdir $HSHQ_STACKS_DIR/aistack/mindsdb/dbexport
  mkdir $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport
  mkdir $HSHQ_STACKS_DIR/aistack/otel
  mkdir $HSHQ_STACKS_DIR/aistack/ollama
  mkdir $HSHQ_STACKS_DIR/aistack/ollama/code
  mkdir $HSHQ_STACKS_DIR/aistack/ollama/root
  mkdir $HSHQ_STACKS_DIR/aistack/openwebui
  mkdir $HSHQ_NONBACKUP_DIR/aistack
  mkdir $HSHQ_NONBACKUP_DIR/aistack/redis
  chmod 777 $HSHQ_STACKS_DIR/aistack/mindsdb/dbexport
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $AISTACK_MINDSDB_ADMIN_EMAIL_ADDRESS
  sleep 2
  addUserMailu alias $AISTACK_MINDSDB_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  docker exec mailu-admin flask mailu alias-delete $AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS
  sleep 2
  addUserMailu alias $AISTACK_LANGFUSE_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  docker exec mailu-admin flask mailu alias-delete $AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS
  sleep 2
  addUserMailu alias $AISTACK_OPENWEBUI_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  outputConfigAIStack
  oidcBlock=$(cat $HOME/openwebui.oidc)
  rm -f $HOME/openwebui.oidc
  insertOIDCClientAuthelia aistack-openwebui "$oidcBlock"
  cd ~
  docker compose -f $HOME/aistack-compose-tmp.yml up -d
  echo "Waiting at least 5 seconds before continuing..."
  sleep 5
  search="mindsdb: http API: started on 47334"
  isFound=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs aistack-mindsdb-app 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 5 seconds, total wait=$i seconds..."
    sleep 5
    i=$((i+5))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "MindsDB did not start up correctly..."
    cd ~
    docker compose -f $HOME/aistack-compose-tmp.yml down -v
    rm -f $HOME/aistack-compose-tmp.yml
    rm -f $HOME/aistack.env
    rm -f $HOME/aistack-compose.yml
    return 1
  fi
  sleep 5
  echo "Installing polars-lts-cpu, please be patient, this might take a few minutes..."
  docker exec aistack-mindsdb-app pip install polars-lts-cpu
  docker image rm $(getScriptImageByContainerName aistack-mindsdb-mod-app) > /dev/null 2>&1
  docker commit aistack-mindsdb-app $(getScriptImageByContainerName aistack-mindsdb-mod-app)
  # See the code at the end of this function, as it informs the user regarding the import
  #importDBConnectionsAIStack
  docker exec aistack-mindsdb-db bash /dbimport/insertAdmin.sh
  rm -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/insertAdmin.sh
  sleep 5
  cd ~
  docker compose -f $HOME/aistack-compose-tmp.yml down -v
  rm -f $HOME/aistack-compose-tmp.yml
  rm -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbexport/init-dbs.sh
  installStack aistack aistack-mindsdb-app "mindsdb: http API: started on 47334" $HOME/aistack.env 3
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$AISTACK_INIT_ENV" = "true" ]; then
    sendEmail -s "AIStack Login Info" -b "MindsDB Admin Username: $AISTACK_MINDSDB_ADMIN_USERNAME\nMindsDB Admin Password: $AISTACK_MINDSDB_ADMIN_PASSWORD\nLangfuse Admin Username: $AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS\nLangfuse Admin Password: $AISTACK_LANGFUSE_ADMIN_PASSWORD\nOpenWebUI Admin Username: $AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS\nOpenWebUI Admin Password: $AISTACK_OPENWEBUI_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    AISTACK_INIT_ENV=true
    updateConfigVar AISTACK_INIT_ENV $AISTACK_INIT_ENV
  fi
  sleep 3
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://aistack-mindsdb-app:47334 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_AISTACK_MINDSDB_APP $MANAGETLS_AISTACK_MINDSDB_APP "$is_integrate_hshq" $NETDEFAULT_AISTACK_MINDSDB_APP "$inner_block"
  insertSubAuthelia $SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://aistack-langfuse:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_AISTACK_LANGFUSE $MANAGETLS_AISTACK_LANGFUSE "$is_integrate_hshq" $NETDEFAULT_AISTACK_LANGFUSE "$inner_block"
  insertSubAuthelia $SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://aistack-openwebui:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_AISTACK_OPENWEBUI $MANAGETLS_AISTACK_OPENWEBUI "$is_integrate_hshq" $NETDEFAULT_AISTACK_OPENWEBUI "$inner_block"
  insertSubAuthelia $SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll aistack "$FMLNAME_AISTACK_MINDSDB_APP" $USERTYPE_AISTACK_MINDSDB_APP "https://$SUB_AISTACK_MINDSDB_APP.$HOMESERVER_DOMAIN" "mindsdb.png" "$(getHeimdallOrderFromSub $SUB_AISTACK_MINDSDB_APP $USERTYPE_AISTACK_MINDSDB_APP)"
    insertEnableSvcAll aistack "$FMLNAME_AISTACK_LANGFUSE" $USERTYPE_AISTACK_LANGFUSE "https://$SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN" "langfuse.png" "$(getHeimdallOrderFromSub $SUB_AISTACK_LANGFUSE $USERTYPE_AISTACK_LANGFUSE)"
    insertEnableSvcAll aistack "$FMLNAME_AISTACK_OPENWEBUI" $USERTYPE_AISTACK_OPENWEBUI "https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN" "openwebui.png" "$(getHeimdallOrderFromSub $SUB_AISTACK_OPENWEBUI $USERTYPE_AISTACK_OPENWEBUI)"
    restartAllCaddyContainers
    checkAddDBConnection false aistack-mindsdb "$FMLNAME_AISTACK_MINDSDB_APP" postgres aistack-mindsdb-db $AISTACK_MINDSDB_DATABASE_NAME $AISTACK_MINDSDB_DATABASE_USER $AISTACK_MINDSDB_DATABASE_USER_PASSWORD
    checkAddDBConnection false aistack-langfuse "$FMLNAME_AISTACK_LANGFUSE" postgres aistack-mindsdb-db $AISTACK_LANGFUSE_DATABASE_NAME $AISTACK_MINDSDB_DATABASE_USER $AISTACK_MINDSDB_DATABASE_USER_PASSWORD
  fi
  echo -e "================================================================================"
  echo -e "================================================================================\n"
  echo -e "  For your convenience, the DB connections for all of your services"
  echo -e "  have been prepped and output to the following file on your host: \n"
  echo -e "  $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME\n"
  echo -e "  If you wish to perform a batch import on these connections into"
  echo -e "  MindsDB, then enter the following command in a terminal: \n"
  echo -e "  docker exec aistack-mindsdb-db bash /dbimport/importConnections.sh\n"
  echo -e "  You can remove unwanted connections from this list before running"
  echo -e "  the above command. Ensure to delete this file by running the command:\n"
  echo -e "  rm $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME\n"
  echo -e "================================================================================"
  echo -e "================================================================================"
}

function outputConfigAIStack()
{
  AISTACK_LANGFUSE_PUBKEY=$(pwgen -c -n 32 1)
  AISTACK_LANGFUSE_SECRETKEY=$(pwgen -c -n 32 1)
  AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET | tr -d ':\n')
  randuid=$(uuidgen)
  cat <<EOFMT > $HOME/aistack-compose-tmp.yml
$STACK_VERSION_PREFIX aistack $(getScriptStackVersion aistack)

services:
  aistack-mindsdb-db:
    image: $(getScriptImageByContainerName aistack-mindsdb-db)
    container_name: aistack-mindsdb-db
    hostname: aistack-mindsdb-db
    user: "${USERID}:${GROUPID}"
    restart: unless-stopped
    env_file: aistack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-aistack-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ${HSHQ_STACKS_DIR}/aistack/mindsdb/db:/var/lib/postgresql/data
      - ${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - ${HSHQ_STACKS_DIR}/aistack/mindsdb/dbexport:/dbexport
      - ${HSHQ_STACKS_DIR}/aistack/mindsdb/dbimport:/dbimport
      - ${HSHQ_STACKS_DIR}/aistack/mindsdb/dbexport/init-dbs.sh:/docker-entrypoint-initdb.d/init-dbs.sh

  aistack-mindsdb-app:
    image: $(getScriptImageByContainerName aistack-mindsdb-app)
    container_name: aistack-mindsdb-app
    hostname: aistack-mindsdb-app
    restart: unless-stopped
    env_file: aistack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-aistack-mindsdb-app:/mindsdb

  aistack-otel:
    image: $(getScriptImageByContainerName aistack-otel)
    container_name: aistack-otel
    hostname: aistack-otel
    restart: unless-stopped
    env_file: aistack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/aistack/otel/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml

  aistack-langfuse:
    image: $(getScriptImageByContainerName aistack-langfuse)
    container_name: aistack-langfuse
    hostname: aistack-langfuse
    restart: unless-stopped
    env_file: aistack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
    environment:
      - HOSTNAME=0.0.0.0
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  aistack-ollama-server:
    image: $(getScriptImageByContainerName aistack-ollama-server)
    container_name: aistack-ollama-server
    hostname: aistack-ollama-server
    restart: unless-stopped
    env_file: aistack.env
    tty: true
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
    networks:
      - int-aistack-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/aistack/ollama/code:/code
      - ${HSHQ_STACKS_DIR}/aistack/ollama/root:/root/.ollama

  aistack-openwebui:
    image: $(getScriptImageByContainerName aistack-openwebui)
    container_name: aistack-openwebui
    hostname: aistack-openwebui
    restart: unless-stopped
    env_file: aistack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
      - aistack-ollama-server
    networks:
      - int-aistack-net
      - dock-ext-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - ${HSHQ_STACKS_DIR}/aistack/openwebui:/app/backend/data

  aistack-redis:
    image: $(getScriptImageByContainerName aistack-redis)
    container_name: aistack-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-aistack-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-aistack-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$AISTACK_REDIS_PASSWORD

volumes:
  v-aistack-mindsdb-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_STACKS_DIR}/aistack/mindsdb/app
  v-aistack-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${HSHQ_NONBACKUP_DIR}/aistack/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-aistack-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFMT
  cat <<EOFDB > $HSHQ_STACKS_DIR/aistack/mindsdb/dbexport/init-dbs.sh
#!/bin/bash
set -e

# Create additional databases
psql -v ON_ERROR_STOP=1 --username "$AISTACK_MINDSDB_DATABASE_USER" --dbname "$AISTACK_MINDSDB_DATABASE_NAME" <<-EOSQL
  CREATE DATABASE langfuse;
EOSQL
EOFDB
  chmod 755 $HSHQ_STACKS_DIR/aistack/mindsdb/dbexport/init-dbs.sh
  cat <<EOFMT > $HOME/aistack-compose.yml
$STACK_VERSION_PREFIX aistack $(getScriptStackVersion aistack)

services:
  aistack-mindsdb-db:
    image: $(getScriptImageByContainerName aistack-mindsdb-db)
    container_name: aistack-mindsdb-db
    hostname: aistack-mindsdb-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-aistack-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/aistack/mindsdb/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/aistack/mindsdb/dbexport:/dbexport
      - \${HSHQ_STACKS_DIR}/aistack/mindsdb/dbimport:/dbimport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.email-from=AIStack MindsDB Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.aistack-mindsdb-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.email-from=AIStack MindsDB Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.aistack-mindsdb-monthly-db.mail-only-on-error=false"

  aistack-mindsdb-app:
    image: $(getScriptImageByContainerName aistack-mindsdb-mod-app)
    container_name: aistack-mindsdb-app
    hostname: aistack-mindsdb-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-aistack-mindsdb-app:/mindsdb

  aistack-otel:
    image: $(getScriptImageByContainerName aistack-otel)
    container_name: aistack-otel
    hostname: aistack-otel
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/aistack/otel/otel-collector-config.yaml:/etc/otelcol-contrib/config.yaml

  aistack-langfuse:
    image: $(getScriptImageByContainerName aistack-langfuse)
    container_name: aistack-langfuse
    hostname: aistack-langfuse
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-mindsdb-db
    networks:
      - int-aistack-net
      - dock-proxy-net
      - dock-ext-net
    environment:
      - HOSTNAME=0.0.0.0
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro

  aistack-ollama-server:
    image: $(getScriptImageByContainerName aistack-ollama-server)
    container_name: aistack-ollama-server
    hostname: aistack-ollama-server
    restart: unless-stopped
    env_file: stack.env
    tty: true
    security_opt:
      - no-new-privileges:true
    networks:
      - int-aistack-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/aistack/ollama/code:/code
      - \${HSHQ_STACKS_DIR}/aistack/ollama/root:/root/.ollama

  aistack-openwebui:
    image: $(getScriptImageByContainerName aistack-openwebui)
    container_name: aistack-openwebui
    hostname: aistack-openwebui
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - aistack-ollama-server
    networks:
      - int-aistack-net
      - dock-ext-net
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/\${PYTHON_VER}/site-packages/certifi/cacert.pem:ro
      - \${HSHQ_STACKS_DIR}/aistack/openwebui:/app/backend/data

  aistack-redis:
    image: $(getScriptImageByContainerName aistack-redis)
    container_name: aistack-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-aistack-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-aistack-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$AISTACK_REDIS_PASSWORD

volumes:
  v-aistack-mindsdb-app:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/aistack/mindsdb/app
  v-aistack-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/aistack/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-aistack-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFMT
  cat <<EOFMT > $HOME/aistack.env
TZ=${TZ}
MINDSDB_DB_CON=postgresql://$AISTACK_MINDSDB_DATABASE_USER:$AISTACK_MINDSDB_DATABASE_USER_PASSWORD@aistack-mindsdb-db:5432/$AISTACK_MINDSDB_DATABASE_NAME
MINDSDB_DOCKER_ENV=True
MINDSDB_STORAGE_DIR=/mindsdb/var
MINDSDB_USERNAME=$AISTACK_MINDSDB_ADMIN_USERNAME
MINDSDB_PASSWORD=$AISTACK_MINDSDB_ADMIN_PASSWORD
SENTRY_IO_DSN=
SENTRY_IO_ENVIRONMENT=local
LANGFUSE_HOST=http://aistack-langfuse:3000
LANGFUSE_PUBLIC_KEY=$AISTACK_LANGFUSE_PUBKEY
LANGFUSE_SECRET_KEY=$AISTACK_LANGFUSE_SECRETKEY
LANGFUSE_ENVIRONMENT=local
LANGFUSE_RELEASE=local
LANGFUSE_TIMEOUT=10
LANGFUSE_SAMPLE_RATE=1.0
OTEL_EXPORTER_TYPE=otlp
OTEL_EXPORTER_PROTOCOL=grpc
OTEL_OTLP_ENDPOINT=http://aistack-otel:4317
OTEL_SERVICE_NAME=aistack
OTEL_SERVICE_INSTANCE_ID=aistack-instance
OTEL_SERVICE_ENVIRONMENT=local
OTEL_SERVICE_RELEASE=local
OTEL_TRACE_SAMPLE_RATE=1.0
OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED=true
DATABASE_URL=postgresql://$AISTACK_MINDSDB_DATABASE_USER:$AISTACK_MINDSDB_DATABASE_USER_PASSWORD@aistack-mindsdb-db:5432/$AISTACK_LANGFUSE_DATABASE_NAME
NEXTAUTH_SECRET=$(openssl rand -base64 32)
SALT=$(openssl rand -base64 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)
NEXTAUTH_URL=https://$SUB_AISTACK_LANGFUSE.$HOMESERVER_DOMAIN
LANGFUSE_INIT_ORG_ID=aistack
LANGFUSE_INIT_ORG_NAME=AIStack
LANGFUSE_INIT_PROJECT_ID=$(uuidgen)
LANGFUSE_INIT_PROJECT_NAME=AIStack
LANGFUSE_INIT_PROJECT_PUBLIC_KEY=$AISTACK_LANGFUSE_PUBKEY
LANGFUSE_INIT_PROJECT_SECRET_KEY=$AISTACK_LANGFUSE_SECRETKEY
LANGFUSE_INIT_USER_EMAIL=$AISTACK_LANGFUSE_ADMIN_EMAIL_ADDRESS
LANGFUSE_INIT_USER_NAME=$AISTACK_LANGFUSE_ADMIN_USERNAME
LANGFUSE_INIT_USER_PASSWORD=$AISTACK_LANGFUSE_ADMIN_PASSWORD
POSTGRES_USER=$AISTACK_MINDSDB_DATABASE_USER
POSTGRES_PASSWORD=$AISTACK_MINDSDB_DATABASE_USER_PASSWORD
POSTGRES_DB=$AISTACK_MINDSDB_DATABASE_NAME
OLLAMA_BASE_URL=http://aistack-ollama-server:11434
OLLAMA_HOST=0.0.0.0
WEBUI_AUTH=True
ENABLE_SIGNUP=False
ENABLE_LOGIN_FORM=True
DEFAULT_USER_ROLE=user
WEBUI_URL=https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN
WEBUI_SECRET_KEY=$(pwgen -c -n 32 1)
ENABLE_OAUTH_SIGNUP=true
ADMIN_EMAIL=$AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS
ENV=prod
OAUTH_MERGE_ACCOUNTS_BY_EMAIL=true
OAUTH_PROVIDER_NAME=Authelia
OPENID_PROVIDER_URL=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/.well-known/openid-configuration
OAUTH_CLIENT_ID=$AISTACK_OPENWEBUI_OIDC_CLIENT_ID
OAUTH_CLIENT_SECRET=$AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET
OAUTH_SCOPES=openid groups email profile
OPENID_REDIRECT_URI=https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN/oauth/oidc/callback
REDIS_HOST=aistack-redis
REDIS_PORT=6379
REDIS_PASSWORD=$AISTACK_REDIS_PASSWORD
REDIS_CONNECTION_STRING=redis://:$AISTACK_REDIS_PASSWORD@aistack-redis:6379/0
PYTHON_VER=python3.11
EOFMT
  cat <<EOFIM > $HOME/openwebui.oidc
# Authelia OIDC Client aistack-openwebui BEGIN
      - client_id: $AISTACK_OPENWEBUI_OIDC_CLIENT_ID
        client_name: OpenWebUI
        client_secret: '$AISTACK_OPENWEBUI_OIDC_CLIENT_SECRET_HASH'
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        redirect_uris:
          - https://$SUB_AISTACK_OPENWEBUI.$HOMESERVER_DOMAIN/oauth/oidc/callback
        scopes:
          - openid
          - profile
          - email
          - groups
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic
# Authelia OIDC Client aistack-openwebui END
EOFIM
  cat <<EOFOT > $HSHQ_STACKS_DIR/aistack/otel/otel-collector-config.yaml
receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

exporters:
  debug:
    verbosity: normal

processors:
  batch:

extensions:
  health_check:
  pprof:
  zpages:

service:
  extensions: [health_check, pprof, zpages]
  telemetry:
    logs:
      level: "debug"
      encoding: "console"
    metrics:
      level: "detailed"
  pipelines:
    logs:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug]
    metrics:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug]
    traces:
      receivers: [otlp]
      processors: [batch]
      exporters: [debug]
EOFOT
  cat <<EOFAS > $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME
"MindsDB" postgres aistack-mindsdb-db $AISTACK_MINDSDB_DATABASE_NAME $AISTACK_MINDSDB_DATABASE_USER $AISTACK_MINDSDB_DATABASE_USER_PASSWORD
"Langfuse" postgres aistack-mindsdb-db $AISTACK_LANGFUSE_DATABASE_NAME $AISTACK_MINDSDB_DATABASE_USER $AISTACK_MINDSDB_DATABASE_USER_PASSWORD
"Discourse" postgres discourse-db $DISCOURSE_DATABASE_NAME $DISCOURSE_DATABASE_USER $DISCOURSE_DATABASE_USER_PASSWORD
"EspoCRM" mysql espocrm-db $ESPOCRM_DATABASE_NAME $ESPOCRM_DATABASE_USER $ESPOCRM_DATABASE_USER_PASSWORD
"Firefly" postgres firefly-db $FIREFLY_DATABASE_NAME $FIREFLY_DATABASE_USER $FIREFLY_DATABASE_USER_PASSWORD
"FreshRSS" postgres freshrss-db $FRESHRSS_DATABASE_NAME $FRESHRSS_DATABASE_USER $FRESHRSS_DATABASE_USER_PASSWORD
"Ghost" mysql ghost-db $GHOST_DATABASE_NAME $GHOST_DATABASE_USER $GHOST_DATABASE_USER_PASSWORD
"Gitea" postgres gitea-db $GITEA_DATABASE_NAME $GITEA_DATABASE_USER $GITEA_DATABASE_USER_PASSWORD
"Gitlab" postgres gitlab-db $GITLAB_DATABASE_NAME $GITLAB_DATABASE_USER $GITLAB_DATABASE_USER_PASSWORD
"Guacamole" mysql guacamole-db $GUACAMOLE_DATABASE_NAME $GUACAMOLE_DATABASE_USER $GUACAMOLE_DATABASE_USER_PASSWORD
"HomeAssistant" postgres homeassistant-db $HOMEASSISTANT_DATABASE_NAME $HOMEASSISTANT_DATABASE_USER $HOMEASSISTANT_DATABASE_USER_PASSWORD
"Huginn" postgres huginn-db $HUGINN_DATABASE_NAME $HUGINN_DATABASE_USER $HUGINN_DATABASE_USER_PASSWORD
"Immich" postgres immich-db $IMMICH_DATABASE_NAME $IMMICH_DATABASE_USER $IMMICH_DATABASE_USER_PASSWORD
"Invidious" postgres invidious-db $INVIDIOUS_DATABASE_NAME $INVIDIOUS_DATABASE_USER $INVIDIOUS_DATABASE_USER_PASSWORD
"Keila" postgres keila-db $KEILA_DATABASE_NAME $KEILA_DATABASE_USER $KEILA_DATABASE_USER_PASSWORD
"Linkwarden" postgres linkwarden-db $LINKWARDEN_DATABASE_NAME $LINKWARDEN_DATABASE_USER $LINKWARDEN_DATABASE_USER_PASSWORD
"Mastodon" postgres mastodon-db $MASTODON_DATABASE_NAME $MASTODON_DATABASE_USER $MASTODON_DATABASE_USER_PASSWORD
"Matomo" mysql matomo-db $MATOMO_DATABASE_NAME $MATOMO_DATABASE_USER $MATOMO_DATABASE_USER_PASSWORD
"Matrix" postgres matrix-db $MATRIX_DATABASE_NAME $MATRIX_DATABASE_USER $MATRIX_DATABASE_USER_PASSWORD
"Mealie" postgres mealie-db $MEALIE_DATABASE_NAME $MEALIE_DATABASE_USER $MEALIE_DATABASE_USER_PASSWORD
"Nextcloud" postgres nextcloud-db $NEXTCLOUD_DATABASE_NAME $NEXTCLOUD_DATABASE_USER $NEXTCLOUD_DATABASE_USER_PASSWORD
"Paperless" postgres paperless-db $PAPERLESS_DATABASE_NAME $PAPERLESS_DATABASE_USER $PAPERLESS_DATABASE_USER_PASSWORD
"Pastefy" mysql pastefy-db $PASTEFY_DATABASE_NAME $PASTEFY_DATABASE_USER $PASTEFY_DATABASE_USER_PASSWORD
"PeerTube" postgres peertube-db $PEERTUBE_DATABASE_NAME $PEERTUBE_DATABASE_USER $PEERTUBE_DATABASE_USER_PASSWORD
"Penpot" postgres penpot-db $PENPOT_DATABASE_NAME $PENPOT_DATABASE_USER $PENPOT_DATABASE_USER_PASSWORD
"PhotoPrism" mysql photoprism-db $PHOTOPRISM_DATABASE_NAME $PHOTOPRISM_DATABASE_USER $PHOTOPRISM_DATABASE_USER_PASSWORD
"Piped" postgres piped-db $PIPED_DATABASE_NAME $PIPED_DATABASE_USER $PIPED_DATABASE_USER_PASSWORD
"Pixelfed" mysql pixelfed-db $PIXELFED_DATABASE_NAME $PIXELFED_DATABASE_USER $PIXELFED_DATABASE_USER_PASSWORD
"Shlink" postgres shlink-db $SHLINK_DATABASE_NAME $SHLINK_DATABASE_USER $SHLINK_DATABASE_USER_PASSWORD
"$FMLNAME_SPEEDTEST_TRACKER_LOCAL" postgres speedtest-tracker-local-db $SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER $SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
"$FMLNAME_SPEEDTEST_TRACKER_VPN" postgres speedtest-tracker-vpn-db $SPEEDTEST_TRACKER_VPN_DATABASE_NAME $SPEEDTEST_TRACKER_VPN_DATABASE_USER $SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
"Vaultwarden" postgres vaultwarden-db $VAULTWARDEN_DATABASE_NAME $VAULTWARDEN_DATABASE_USER $VAULTWARDEN_DATABASE_USER_PASSWORD
"Wallabag" postgres wallabag-db $WALLABAG_DATABASE_NAME $WALLABAG_DATABASE_USER $WALLABAG_DATABASE_USER_PASSWORD
"Wikijs" postgres wikijs-db $WIKIJS_DATABASE_NAME $WIKIJS_DATABASE_USER $WIKIJS_DATABASE_USER_PASSWORD
"WordPress" mysql wordpress-db $WORDPRESS_DATABASE_NAME $WORDPRESS_DATABASE_USER $WORDPRESS_DATABASE_USER_PASSWORD
EOFAS
  cat <<EOFIM > $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/importConnections.sh
#!/bin/bash

AISTACK_MINDSDB_DATABASE_NAME=$AISTACK_MINDSDB_DATABASE_NAME
AISTACK_MINDSDB_DATABASE_USER=$AISTACK_MINDSDB_DATABASE_USER
PGPASSWORD=$AISTACK_MINDSDB_DATABASE_USER_PASSWORD
curdt=\$(date '+%Y-%m-%d %H:%M:%S.%3N')

function main()
{
  if ! [ -f /dbimport/$MINDSDB_IMPORT_FILENAME ]; then
    return
  fi
  while read curLine; do
    if [ -z "\$curLine" ]; then
      continue
    fi
    connName=\$(echo "\$curLine" | cut -d" " -f1 | sed 's/"//g')
    connType=\$(echo "\$curLine" | cut -d" " -f2)
    connHost=\$(echo "\$curLine" | cut -d" " -f3)
    connDatabase=\$(echo "\$curLine" | cut -d" " -f4)
    connUser=\$(echo "\$curLine" | cut -d" " -f5)
    connPassword=\$(echo "\$curLine" | cut -d" " -f6)
    case "\$connType" in
      "postgres")
        connPort=5432
      ;;
      "mysql")
        connPort=3306
      ;;
      *)
        continue
      ;;
    esac
    sqlcmd="select count(*) from integration where name='\$connName';"
    checkExist=\$(echo "\$sqlcmd" | psql -t -U \$AISTACK_MINDSDB_DATABASE_USER \$AISTACK_MINDSDB_DATABASE_NAME | xargs)
    if [ -z "\$checkExist" ]; then
      echo "ERROR: There was a problem adding this DB Connection to MindsDB - \$connName"
      continue
    fi
    if [ \$checkExist -eq 0 ]; then
      sqlcmd="insert into integration(updated_at, created_at, name, data, engine) values ('\$curdt', '\$curdt', '\$connName','{\"database\": \"\$connDatabase\", \"host\": \"\$connHost\", \"password\": \"\$connPassword\", \"port\": \"\$connPort\", \"user\": \"\$connUser\"}','\$connType');"
      echo "\$sqlcmd" | psql -U \$AISTACK_MINDSDB_DATABASE_USER \$AISTACK_MINDSDB_DATABASE_NAME > /dev/null 2>&1
    else
      echo "INFO: DB Connection already exists in MindsDB - \$connName"
    fi
  done </dbimport/$MINDSDB_IMPORT_FILENAME
}

main
EOFIM
  chmod 755 $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/importConnections.sh
  cat <<EOFIM > $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/insertAdmin.sh
#!/bin/bash

AISTACK_LANGFUSE_DATABASE_NAME=$AISTACK_LANGFUSE_DATABASE_NAME
AISTACK_MINDSDB_DATABASE_USER=$AISTACK_MINDSDB_DATABASE_USER
PGPASSWORD=$AISTACK_MINDSDB_DATABASE_USER_PASSWORD
curdt=\$(date '+%s')
AISTACK_OPENWEBUI_ADMIN_PASSWORD_HASH="$(htpasswd -bnBC 10 "" $AISTACK_OPENWEBUI_ADMIN_PASSWORD | tr -d ':\n' | sed 's/\$2y/\$2b/' | sed 's/\$/\\\$/g')"
function main()
{
  sqlcmd="insert into \"user\"(id,name,email,role,profile_image_url,created_at,updated_at,last_active_at) values ('$randuid', '$(getAdminEmailName) OpenWebUI', '$AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS', 'admin','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAJSElEQVR4Xu1aaZBV1RH+3r66gLIYETUogiITGUBwArKIEAeMDLgBLok/NNGykqqYyqrZrLjFMokmJiHEqmQkRirioAyIooihCCqCBLFQwyKiqKPCzNuXm+775t3HG+fNe/fO3DunKt2/YF6fvt/p7/Q5fbqPq33pQA0iynjAJYQow4UORAhRiw8hRDE+hBAhRDUPKIZHzhAhRDEPKAZHIkQIUcwDisGRCBFCFPOAYnAkQoQQxTygGByJECFEMQ8oBkciRAhRzAOKwZEIEUIU84BicCRChBDFPKAYHIkQIUQxDygGRyJECFHMA4rBkQgRQhTzgGJwJEKEEMU8oBgciRAhRDEPKAanXyPEPage3tMa4TmxDu7jRsLlPxbwBoF0B/LJj5D/5A3k3t+I7J4WaMm2PnWd56QGhC5pMWzGV81G/sNX+vQbVoz1CyGeYRchMOF2uAeeUxvmfAaZNx9Beus90FKf1DamilZwym/gHbnY0MrsWobUptv6xHZvjDhLiNuHwOS74Bt1fQlzNo7s/jXIvvsstNhBaOnDcIUGwX3s6fCefik8Qy8gXZeur8UPIrH+BuQPbenNnAFPENHFbwK+Yww7THSseTR9JNs7270c7RwhLi+CM/8C76mXGJBz7z2P5IaboSUOVZyGZ+hkBKf9Aa7IyQUdIjDxzFW0lf3L8tS9IxaQzT8C+TTg9ht2EusWI0eLoz/FMUICE38G37k3l8g4uAGJ1gW87qvO3xU9BZH5GwD/cQXd1GeIPTFFjygrEprzODwnz0DmP7+Hb8w3DBPZPU8iuf7rVkz22RhHCOHDO3zpWmPrQaYdsX/UmzqovSMW6pFSlNyB55BYe4VpR7hCQxC5egftgh7E/9lAUfsIJRRnFuzkkuhoHgXG11/iCCGhOStoRU435pjZ8SBSW+4wN2eXG5ErXoUrOry0xaz+Km1dL5my4zv3FgQm/pTOo/cRWz4GgUl3wnfOTYaN5MZbkd3dbMpmXyrbTojrmNN0Rx4tsccnQDvyX9Pz8J93G/zjvlfaYvY9jeSz15qyE256Ce4Bo5HZ+TBSm38I95CJCM9tLUUepdmJ1ZeZstmXyrYT4q/7Nvzjf2Rg1tr30XY1ztIc3IPGd259ncMpHe5oPovuLYdrsuc+YSzClz2v68ZbZiH/0Vb935ErXytFnpZH7O91ekbXH2I7IV23q+xby5F88RZrc6VtK3rdu3raWhSOkCxFSi1S3J44OjlKi+If/2P4675l/D/18k+Qef23tZjscx3bCYleQ1tTMTsi+OlXfo709gcsTyS8YBPcx1NUdErN5xEd4pFFO+EKDqIL5l1Iv3avYcM9YBTCTaU0Ov/pG3TgT7GMsTcD7SUkMADRJW+X4eO0ktNLqxKa1QzP8DnG8Oz+ViTXLalqzjN8NkKzHiU9DbHHxkHr2F82Jty0kc6Ws42/MSFMjNNiKyFcGgnPf7FsTonWJuToDmJVghf+Dt4zrjSG59t2IL5yWlVzwRnL6OZPWdkHm5B4et7n9P1jb4V/Qinz4y2Lty6nxV5CumQwPLn4qjlUxHvZ8jwDF9wH3+ivGeO1I3voPBjfsz0qWkYXUanEE0CltJYrAZGrtpOdUpkmtnysHlFOiq2EeE76MlVUy7en+MrpyLe9bnmOgfN/UXa7Lt4nejLoG3UdAg3308UvQVkZ1asqXPxCjU9R7WyyYYrTX642Oym2EuIeTGnqPL6hl6Q/IiQ8bw3cgycg+84KJF+4saJ/uegZaPiV8TtfEDminBR7CemSvfDEnD5DXFQ1jlxe6HMk1lyO3HvrK/uXk5BFu6jg6CvoUCTppRQqqTglthLC5e3otXvL5pKk8nl2z0rL8wtdvByeUy4ureJ9q+m2fk1Fe3yz5xu+VektXrPftZcQQhNZvJty/xMMXOlX70R6G+3nFiW8cHOpGMiLuEo2VHYLt/DN3P61SKxbZGGktSG2E/K5Ff32Y9QD+aZFtB5Erz9Q1sPgOwjfRboTbm6FGlfpP3FlN//ZW9W/6w3RtkX3D2+koEvlmdijZ/dZp7IaANsJ4X4DZ0ZF0ToO0MWsrhqu7h085HyE5q4u/UYNpkIt60i3+oEpv4Zv5BLqze9E/ImpNX8zOP1P8H6xydBPbfouMrv+XPP43ijaTogr8gXK7znNLeT3+mpdMQn5wzWs1i4z63oeZPe2IPlc6U5Spn5Um9ZsuYa7msGL/mqY48cP/AjCCbGdEJ5EcNbf4B3+FWM+3KlL/btUAa5polyL4qpssZVLgxJPNSJ3aHO3w402Lf3K1WWuMtcs1NaNLtld1nPXG2rte2s2YVXREULcA8dQ2ZvSTXKqLpkOvdqqJT6sGbf3zKsRnPqgoc+9b+6BV5LQbGrTDpuB/MfbEH9yZs3fKSp2LdGkt95NBcl7TNsxO8ARQhiUv/778H/pOyWHUqcv0TqfKhP5qpj1Jtf8F4wVqyU/pkN6asXHEa4wb5Pb9AVQczW4Cwo+Q/gsKYp25B1aRBOrYu2tgmOEgHoZwelL9QJfUbjIyBmXFv+g4jz4QVtw2sNgJxeiqx3xNQt7fNTGDTFujLFwmZ3L7WaFo4uj7GjhoiQXJ+0U5wjhWdBToMDkX1Jx8KiXHfwua18rvctap3fptHQ7vcs6kd5ljdDJ8wydxAN1H3DJPEGHOG9DlUSvMFOpBN6wrsLJQ3wVnV+pT0340YXghQ+VVZV1W9RhjHN7NxszYcucqrOEdGLzDJtJLxfvqP3lYi6lp50pbipVSHH99T/QH9V5BteX3VMKUdWBXNt2uksc7uzBd1/B5XPKR4uAG1b89KhboSdIubZt1JNfWvH+Y46Ccu1+IaQIgYuPvlPnws1ve48/g9720rsrbs+SA/PxQ/r9gbe1zF663JEjepJQYwsR0lDVFx3LBlOo5brV6/p2rCdjqS230/n0UNXvmVXoV0LMgv1/0BdCFGNZCBFCFPOAYnAkQoQQxTygGByJECFEMQ8oBkciRAhRzAOKwZEIEUIU84BicCRChBDFPKAYHIkQIUQxDygGRyJECFHMA4rBkQgRQhTzgGJwJEKEEMU8oBgciRAhRDEPKAZHIkQIUcwDisGRCBFCFPOAYnAkQoQQxTygGByJECFEMQ8oBkciRAhRzAOKwZEIEUIU84BicCRChBDFPKAYHIkQxQj5H8Wj5BIH8hVZAAAAAElFTkSuQmCC', \$curdt, \$curdt, \$curdt);"
  echo "\$sqlcmd" | psql -U \$AISTACK_MINDSDB_DATABASE_USER \$AISTACK_LANGFUSE_DATABASE_NAME > /dev/null 2>&1

  psql -U \$AISTACK_MINDSDB_DATABASE_USER \$AISTACK_LANGFUSE_DATABASE_NAME -c "insert into auth(id,email,password,active) values('$randuid','$AISTACK_OPENWEBUI_ADMIN_EMAIL_ADDRESS','\$AISTACK_OPENWEBUI_ADMIN_PASSWORD_HASH',true);" > /dev/null 2>&1
}

main
EOFIM
  chmod 755 $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/insertAdmin.sh
}

function importDBConnectionsAIStack()
{
  # Let's not automatically add DB connections to the MindsDB as it may pose a security risk
  # See https://github.com/mindsdb/mindsdb/issues/10803 and https://cybernews.com/security/aws-cloud-storage-bucket-ransomware-attacks/
  rm -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME
  if true; then return; fi
  # This function assumes the file, ~/hshq/data/stacks/aistack/mindsdb/dbimport/DBCImport.txt
  # exists and has been populated with the connection info
  # that will be imported into the MindsDB database.
  set +e
  if ! [ -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME ]; then
    echo "$MINDSDB_IMPORT_FILENAME does not exist, returning..."
    return
  fi
  docker ps | grep aistack-mindsdb-db > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    docker exec aistack-mindsdb-db bash /dbimport/importConnections.sh
  else
    echo "aistack-mindsdb-db container does not exist, returning..."
  fi
  rm -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME
}

function performUpdateAIStack()
{
  perform_stack_name=mindsdb
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=exampleimage
      image_update_map[0]="exampleimage,exampleimage"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Pixelfed
function installPixelfed()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory pixelfed "Pixelfed"
  cdRes=$?
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName pixelfed-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName pixelfed-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  buildImagePixelfed
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/pixelfed
  mkdir $HSHQ_STACKS_DIR/pixelfed/config
  mkdir $HSHQ_STACKS_DIR/pixelfed/db
  mkdir $HSHQ_STACKS_DIR/pixelfed/dbexport
  mkdir $HSHQ_STACKS_DIR/pixelfed/appstorage
  mkdir $HSHQ_STACKS_DIR/pixelfed/appbootstrapcache
  mkdir $HSHQ_NONBACKUP_DIR/pixelfed
  mkdir $HSHQ_NONBACKUP_DIR/pixelfed/redis
  chmod 777 $HSHQ_STACKS_DIR/pixelfed/dbexport
  initServicesCredentials
  set +e
  generateCert pixelfed-app pixelfed-app
  set +e
  outputConfigPixelfed
  installStack pixelfed pixelfed-app "ready to handle connections" $HOME/pixelfed.env 10
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$PIXELFED_INIT_ENV" = "true" ]; then
    sendEmail -s "Pixelfed Admin Login Info" -b "Pixelfed Admin Username: $EMAIL_ADMIN_EMAIL_ADDRESS\nPixelfed Admin Password: $LDAP_ADMIN_USER_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    PIXELFED_INIT_ENV=true
    updateConfigVar PIXELFED_INIT_ENV $PIXELFED_INIT_ENV
  fi
  set +e
  sleep 3
  docker exec pixelfed-app bash -c "php artisan ldap:import users --filter \"(memberOf=cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN)\" -n -q" >/dev/null
  docker exec pixelfed-app bash -c "yes | php artisan user:admin $LDAP_ADMIN_USER_USERNAME" >/dev/null
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_PIXELFED.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://pixelfed-app {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_PIXELFED $MANAGETLS_PIXELFED "$is_integrate_hshq" $NETDEFAULT_PIXELFED "$inner_block"
  insertSubAuthelia $SUB_PIXELFED.$HOMESERVER_DOMAIN bypass
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll pixelfed "$FMLNAME_PIXELFED" $USERTYPE_PIXELFED "https://$SUB_PIXELFED.$HOMESERVER_DOMAIN" "pixelfed.png" "$(getHeimdallOrderFromSub $SUB_PIXELFED $USERTYPE_PIXELFED)"
    restartAllCaddyContainers
    checkAddDBConnection true pixelfed "$FMLNAME_PIXELFED" mysql pixelfed-db $PIXELFED_DATABASE_NAME $PIXELFED_DATABASE_USER $PIXELFED_DATABASE_USER_PASSWORD
  fi
}

function outputConfigPixelfed()
{
  cat <<EOFMT > $HOME/pixelfed-compose.yml
$STACK_VERSION_PREFIX pixelfed $(getScriptStackVersion pixelfed)

services:
  pixelfed-db:
    image: $(getScriptImageByContainerName pixelfed-db)
    container_name: pixelfed-db
    hostname: pixelfed-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --default-authentication-plugin=mysql_native_password --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-pixelfed-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-pixelfed-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/pixelfed/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.pixelfed-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.pixelfed-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.pixelfed-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.pixelfed-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.pixelfed-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.pixelfed-hourly-db.email-from=Pixelfed Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.pixelfed-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.pixelfed-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.pixelfed-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.pixelfed-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.pixelfed-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.pixelfed-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.pixelfed-monthly-db.email-from=Pixelfed Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.pixelfed-monthly-db.mail-only-on-error=false"

  pixelfed-app:
    image: $(getScriptImageByContainerName pixelfed-app)
    container_name: pixelfed-app
    hostname: pixelfed-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - pixelfed-db
      - pixelfed-redis
    networks:
      - int-pixelfed-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/pixelfed/ldap.conf:/etc/ldap/ldap.conf
      - \${HSHQ_SSL_DIR}/pixelfed-app.crt:/ldapcerts/pixelfed-app.crt
      - \${HSHQ_SSL_DIR}/pixelfed-app.key:/ldapcerts/pixelfed-app.key
      - v-pixelfed-appstorage:/var/www/storage
      - v-pixelfed-appbootstrapcache:/var/www/bootstrap/cache
      - \${HSHQ_STACKS_DIR}/pixelfed/docker.env:/var/www/.env

  pixelfed-worker:
    image: $(getScriptImageByContainerName pixelfed-worker)
    container_name: pixelfed-worker
    hostname: pixelfed-worker
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: gosu www-data php artisan horizon
    depends_on:
      - pixelfed-app
      - pixelfed-db
      - pixelfed-redis
    networks:
      - int-pixelfed-net
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
      - dock-ldap-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/pixelfed/ldap.conf:/etc/ldap/ldap.conf
      - \${HSHQ_SSL_DIR}/pixelfed-app.crt:/ldapcerts/pixelfed-app.crt
      - \${HSHQ_SSL_DIR}/pixelfed-app.key:/ldapcerts/pixelfed-app.key
      - v-pixelfed-appstorage:/var/www/storage
      - v-pixelfed-appbootstrapcache:/var/www/bootstrap/cache
      - \${HSHQ_STACKS_DIR}/pixelfed/docker.env:/var/www/.env

  pixelfed-redis:
    image: $(getScriptImageByContainerName pixelfed-redis)
    container_name: pixelfed-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-pixelfed-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-pixelfed-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$PIXELFED_REDIS_PASSWORD

volumes:
  v-pixelfed-appstorage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/pixelfed/appstorage
  v-pixelfed-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/pixelfed/db
  v-pixelfed-appbootstrapcache:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/pixelfed/appbootstrapcache
  v-pixelfed-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/pixelfed/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ldap-net:
    name: dock-ldap
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-pixelfed-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFMT
  cat <<EOFMT > $HOME/pixelfed.env
TZ=\${TZ}
UID=${USERID}
GID=${GROUPID}
MYSQL_DATABASE=$PIXELFED_DATABASE_NAME
MYSQL_ROOT_PASSWORD=$PIXELFED_DATABASE_ROOT_PASSWORD
MYSQL_USER=$PIXELFED_DATABASE_USER
MYSQL_PASSWORD=$PIXELFED_DATABASE_USER_PASSWORD
REDIS_PASSWORD=$PIXELFED_REDIS_PASSWORD
EOFMT
  cat <<EOFPF > $HSHQ_STACKS_DIR/pixelfed/docker.env
APP_NAME="Pixelfed"
APP_ENV="production"
APP_KEY=
APP_DEBUG="false"
OPEN_REGISTRATION="false"
ENFORCE_EMAIL_VERIFICATION="false"
PF_MAX_USERS="1000"
OAUTH_ENABLED="true"
ENABLE_CONFIG_CACHE=true
INSTANCE_DISCOVER_PUBLIC="true"
PF_OPTIMIZE_IMAGES="true"
IMAGE_QUALITY="80"
MAX_PHOTO_SIZE="15000"
MAX_CAPTION_LENGTH="500"
MAX_ALBUM_LENGTH="4"
APP_URL="https://$SUB_PIXELFED.$HOMESERVER_DOMAIN"
APP_DOMAIN="$SUB_PIXELFED.$HOMESERVER_DOMAIN"
ADMIN_DOMAIN="$SUB_PIXELFED.$HOMESERVER_DOMAIN"
SESSION_DOMAIN="$SUB_PIXELFED.$HOMESERVER_DOMAIN"
TRUST_PROXIES="*"
DB_CONNECTION="mysql"
DB_HOST="pixelfed-db"
DB_PORT="3306"
DOCKER_DB_HOST_PORT="3306"
DB_DATABASE="$PIXELFED_DATABASE_NAME"
DB_USERNAME="$PIXELFED_DATABASE_USER"
DB_PASSWORD="$PIXELFED_DATABASE_USER_PASSWORD"
REDIS_CLIENT="predis"
REDIS_SCHEME="tcp"
REDIS_HOST="pixelfed-redis"
REDIS_PASSWORD="$PIXELFED_REDIS_PASSWORD"
REDIS_PORT="6379"
SESSION_DRIVER="database"
CACHE_DRIVER="redis"
QUEUE_DRIVER="redis"
BROADCAST_DRIVER="log"
LOG_CHANNEL="stack"
HORIZON_PREFIX="horizon-"
ACTIVITY_PUB="true"
AP_REMOTE_FOLLOW="true"
AP_INBOX="false"
AP_OUTBOX="false"
AP_SHAREDINBOX="false"
EXP_EMC="true"
MAIL_DRIVER=smtp
MAIL_HOST=$SMTP_HOSTNAME
MAIL_PORT=$SMTP_HOSTPORT
MAIL_USERNAME=
MAIL_PASSWORD=
MAIL_ENCRYPTION=tls
MAIL_FROM_ADDRESS="$EMAIL_ADMIN_EMAIL_ADDRESS"
MAIL_FROM_NAME="Pixelfed $(getAdminEmailName)"
INSTANCE_CONTACT_EMAIL="$EMAIL_ADMIN_EMAIL_ADDRESS"
PF_ENABLE_CLOUD=false
FILESYSTEM_CLOUD=s3
LDAP_LOGGING=false
LDAP_CONNECTION=default
LDAP_CONNECTIONS=default
LDAP_DEFAULT_HOSTS=ldapserver
LDAP_DEFAULT_PORT=389
LDAP_DEFAULT_USERNAME="$LDAP_READONLY_USER_BIND_DN"
LDAP_DEFAULT_PASSWORD="$LDAP_READONLY_USER_PASSWORD"
LDAP_DEFAULT_BASE_DN="$LDAP_BASE_DN"
LDAP_DEFAULT_TIMEOUT=5
LDAP_DEFAULT_SSL=false
LDAP_DEFAULT_TLS=true
LDAP_GROUPFILTER="cn=$LDAP_PRIMARY_USER_GROUP_NAME,ou=groups,$LDAP_BASE_DN"
DOCKER_PROXY_PROFILE="disabled"
DOCKER_APP_PHP_VERSION="8.3"
DOCKER_APP_RUNTIME="fpm"
DOCKER_APP_DEBIAN_RELEASE="bookworm"
DOCKER_APP_BASE_TYPE="fpm"
EOFPF
  cat <<EOFPF > $HSHQ_STACKS_DIR/pixelfed/ldap.conf
TLS_CERT /ldapcerts/pixelfed-app.crt
TLS_KEY /ldapcerts/pixelfed-app.key
TLS_CACERT /usr/local/share/ca-certificates/${CERTS_ROOT_CA_NAME}.crt
TLS_REQCERT never
TLS_REQSAN never
EOFPF
}

function buildImagePixelfed()
{
  img_ver=v0.12.5.tar.gz
  cd $HSHQ_BUILD_DIR
  sudo rm -fr $HSHQ_BUILD_DIR/pixelfed*
  wget -q4 -O $HSHQ_BUILD_DIR/pixelfed.tar.gz https://github.com/pixelfed/pixelfed/archive/refs/tags/$img_ver
  tar xvzf ./pixelfed.tar.gz >/dev/null
  rm -f ./pixelfed.tar.gz
  cd pixelfed*
  rm -f app/Http/Controllers/Auth/LoginController.php
  cat <<EOFPF > app/Http/Controllers/Auth/LoginController.php
<?php

namespace App\Http\Controllers\Auth;

use App\AccountLog;
use App\Http\Controllers\Controller;
use App\User;
use Illuminate\Foundation\Auth\AuthenticatesUsers;
use App\Services\BouncerService;
use Illuminate\Http\Request;
use Illuminate\Validation\ValidationException;

class LoginController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Login Controller
    |--------------------------------------------------------------------------
    |
    | This controller handles authenticating users for the application and
    | redirecting them to your home screen. The controller uses a trait
    | to conveniently provide its functionality to your applications.
    |
    */

    use AuthenticatesUsers;

    /**
     * Where to redirect users after login.
     *
     * @var string
     */
    protected \$redirectTo = '/i/web';

    protected \$maxAttempts = 5;
    protected \$decayMinutes = 60;

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        \$this->middleware('guest')->except('logout');
    }

    public function showLoginForm()
    {
                if(config('pixelfed.bouncer.cloud_ips.ban_logins')) {
                        abort_if(BouncerService::checkIp(request()->ip()), 404);
                }

        return view('auth.login');
    }

    protected function credentials(Request \$request)
    {
        return [
            'mail' => \$request->email,
            'password' => \$request->password,
        ];
    }

    /**
     * Validate the user login request.
     *
     * @param \Illuminate\Http\Request \$request
     *
     * @return void
     */
    public function validateLogin(\$request)
    {
        if(config('pixelfed.bouncer.cloud_ips.ban_logins')) {
                        abort_if(BouncerService::checkIp(\$request->ip()), 404);
                }

        \$rules = [
            \$this->username() => 'required|email',
            'password'        => 'required|string|min:6',
        ];
        \$messages = [];

        if(
                (bool) config_cache('captcha.enabled') &&
                (bool) config_cache('captcha.active.login') ||
                (
                                (bool) config_cache('captcha.triggers.login.enabled') &&
                                request()->session()->has('login_attempts') &&
                                request()->session()->get('login_attempts') >= config('captcha.triggers.login.attempts')
                        )
        ) {
            \$rules['h-captcha-response'] = 'required|filled|captcha|min:5';
            \$messages['h-captcha-response.required'] = 'The captcha must be filled';
        }
        \$request->validate(\$rules, \$messages);
    }

    /**
     * The user has been authenticated.
     *
     * @param \Illuminate\Http\Request \$request
     * @param mixed                    \$user
     *
     * @return mixed
     */
    protected function authenticated(\$request, \$user)
    {
        if(\$user->status == 'deleted') {
            return;
        }

        \$log = new AccountLog();
        \$log->user_id = \$user->id;
        \$log->item_id = \$user->id;
        \$log->item_type = 'App\User';
        \$log->action = 'auth.login';
        \$log->message = 'Account Login';
        \$log->link = null;
        \$log->ip_address = \$request->ip();
        \$log->user_agent = \$request->userAgent();
        \$log->save();
    }

    /**
     * Get the failed login response instance.
     *
     * @param  \Illuminate\Http\Request  \$request
     * @return \Symfony\Component\HttpFoundation\Response
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    protected function sendFailedLoginResponse(Request \$request)
    {
        if(config('captcha.triggers.login.enabled')) {
                        if (\$request->session()->has('login_attempts')) {
                                \$ct = \$request->session()->get('login_attempts');
                                \$request->session()->put('login_attempts', \$ct + 1);
                        } else {
                                \$request->session()->put('login_attempts', 1);
                        }
        }

        throw ValidationException::withMessages([
            \$this->username() => [trans('auth.failed')],
        ]);
    }
}
EOFPF
  mkdir -p app/Ldap/Rules
  rm -f app/Ldap/Rules/OnlyPixelfedUsers.php
  cat <<EOFPF > app/Ldap/Rules/OnlyPixelfedUsers.php
<?php

namespace App\Ldap\Rules;

use Illuminate\Database\Eloquent\Model as Eloquent;
use LdapRecord\Laravel\Auth\Rule;
use LdapRecord\Models\Model as LdapRecord;
use LdapRecord\Models\OpenLDAP\Group;

class OnlyPixelfedUsers implements Rule
{
    /**
     * Check if the rule passes validation.
     *
     * @return bool
     */
    public function passes(LdapRecord \$user, Eloquent \$model = null): bool
    {
        \$groupSearch = \config('ldap.groupfilter');
        return \$user->groups()->exists(
            Group::findOrFail(\$groupSearch)
        );
    }
}
EOFPF
  rm -f app/User.php
  cat <<EOFPF > app/User.php
<?php

namespace App;

use App\Services\AvatarService;
use LdapRecord\Laravel\Auth\LdapAuthenticatable;
use LdapRecord\Laravel\Auth\AuthenticatesWithLdap;
use App\Util\RateLimit\User as UserRateLimit;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Laravel\Passport\HasApiTokens;
use NotificationChannels\WebPush\HasPushSubscriptions;

class User extends Authenticatable implements LdapAuthenticatable
{
    use HasApiTokens, HasFactory, HasPushSubscriptions, Notifiable, SoftDeletes, UserRateLimit, AuthenticatesWithLdap;

    /**
     * The attributes that should be mutated to dates.
     *
     * @var array
     */
    protected function casts(): array
    {
        return [
            'deleted_at' => 'datetime',
            'email_verified_at' => 'datetime',
            '2fa_setup_at' => 'datetime',
            'last_active_at' => 'datetime',
        ];
    }

    /**
     * The attributes that are mass assignable.
     *
     * @var array
     */
    protected \$fillable = [
        'name',
        'username',
        'email',
        'password',
        'app_register_ip',
        'email_verified_at',
        'last_active_at',
        'register_source',
        'expo_token',
        'notify_enabled',
        'notify_like',
        'notify_follow',
        'notify_mention',
        'notify_comment',
    ];

    /**
     * The attributes that should be hidden for arrays.
     *
     * @var array
     */
    protected \$hidden = [
        'email', 'password', 'is_admin', 'remember_token',
        'email_verified_at', '2fa_enabled', '2fa_secret',
        '2fa_backup_codes', '2fa_setup_at', 'deleted_at',
        'updated_at',
    ];

    public function profile()
    {
        return \$this->hasOne(Profile::class);
    }

    public function url()
    {
        return url(config('app.url').'/'.\$this->username);
    }

    public function settings()
    {
        return \$this->hasOne(UserSetting::class);
    }

    public function statuses()
    {
        return \$this->hasManyThrough(
            Status::class,
            Profile::class
        );
    }

    public function filters()
    {
        return \$this->hasMany(UserFilter::class, 'user_id', 'profile_id');
    }

    public function receivesBroadcastNotificationsOn()
    {
        return 'App.User.'.\$this->id;
    }

    public function devices()
    {
        return \$this->hasMany(UserDevice::class);
    }

    public function storageUsedKey()
    {
        return 'profile:storage:used:'.\$this->id;
    }

    public function accountLog()
    {
        return \$this->hasMany(AccountLog::class);
    }

    public function interstitials()
    {
        return \$this->hasMany(AccountInterstitial::class);
    }

    public function avatarUrl()
    {
        if (! \$this->profile_id || \$this->status) {
            return config('app.url').'/storage/avatars/default.jpg';
        }

        return AvatarService::get(\$this->profile_id);
    }

    public function routeNotificationForExpo()
    {
        return \$this->expo_token;
    }
}
EOFPF
  rm -f config/auth.php
  cat <<EOFPF > config/auth.php
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Authentication Defaults
    |--------------------------------------------------------------------------
    |
    | This option controls the default authentication "guard" and password
    | reset options for your application. You may change these defaults
    | as required, but they're a perfect start for most applications.
    |
    */

    'defaults' => [
        'guard'     => 'web',
        'passwords' => 'users',
    ],

    /*
    |--------------------------------------------------------------------------
    | Authentication Guards
    |--------------------------------------------------------------------------
    |
    | Next, you may define every authentication guard for your application.
    | Of course, a great default configuration has been defined for you
    | here which uses session storage and the Eloquent user provider.
    |
    | All authentication drivers have a user provider. This defines how the
    | users are actually retrieved out of your database or other storage
    | mechanisms used by this application to persist your user's data.
    |
    | Supported: "session", "token"
    |
    */

    'guards' => [
        'web' => [
            'driver'   => 'session',
            'provider' => 'users',
        ],

        'api' => [
            'driver'   => 'passport',
            'provider' => 'users',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | User Providers
    |--------------------------------------------------------------------------
    |
    | All authentication drivers have a user provider. This defines how the
    | users are actually retrieved out of your database or other storage
    | mechanisms used by this application to persist your user's data.
    |
    | If you have multiple user tables or models you may configure multiple
    | sources which represent each model / table. These sources may then
    | be assigned to any extra authentication guards you have defined.
    |
    | Supported: "database", "eloquent"
    |
    */

    'providers' => [
        'users' => [
            'driver' => 'ldap',
            'model' => LdapRecord\Models\OpenLDAP\User::class,
            'rules' => [
                App\Ldap\Rules\OnlyPixelfedUsers::class,
            ],
            'database' => [
                'model' => App\User::class,
                'sync_passwords' => true,
                'sync_attributes' => [
                    'username' => 'uid',
                    'name' => 'cn',
                    'email' => 'mail',
                ],
            ],
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Resetting Passwords
    |--------------------------------------------------------------------------
    |
    | You may specify multiple password reset configurations if you have more
    | than one user table or model in the application and you want to have
    | separate password reset settings based on the specific user types.
    |
    | The expire time is the number of minutes that the reset token should be
    | considered valid. This security feature keeps tokens short-lived so
    | they have less time to be guessed. You may change this as needed.
    |
    */

    'passwords' => [
        'users' => [
            'provider' => 'users',
            'table'    => 'password_resets',
            'expire'   => 60,
            'throttle' => 60,
        ],
    ],

    'in_app_registration' => (bool) env('APP_REGISTER', true),
];
EOFPF
  rm -f config/ldap.php
  cat <<EOFPF > config/ldap.php
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Default LDAP Connection Name
    |--------------------------------------------------------------------------
    |
    | Here you may specify which of the LDAP connections below you wish
    | to use as your default connection for all LDAP operations. Of
    | course you may add as many connections you'd like below.
    |
    */

    'default' => env('LDAP_CONNECTION', 'default'),

    /*
    |--------------------------------------------------------------------------
    | LDAP Connections
    |--------------------------------------------------------------------------
    |
    | Below you may configure each LDAP connection your application requires
    | access to. Be sure to include a valid base DN - otherwise you may
    | not receive any results when performing LDAP search operations.
    |
    */

    'connections' => [

        'default' => [
            'hosts' => [env('LDAP_HOST', '127.0.0.1')],
            'username' => env('LDAP_USERNAME', 'cn=user,dc=local,dc=com'),
            'password' => env('LDAP_PASSWORD', 'secret'),
            'port' => env('LDAP_PORT', 389),
            'base_dn' => env('LDAP_BASE_DN', 'dc=local,dc=com'),
            'timeout' => env('LDAP_TIMEOUT', 5),
            'use_ssl' => env('LDAP_SSL', false),
            'use_tls' => env('LDAP_TLS', false),
        ],

    ],

    'groupfilter' => env('LDAP_GROUPFILTER', 'everyone'),

    /*
    |--------------------------------------------------------------------------
    | LDAP Logging
    |--------------------------------------------------------------------------
    |
    | When LDAP logging is enabled, all LDAP search and authentication
    | operations are logged using the default application logging
    | driver. This can assist in debugging issues and more.
    |
    */

    'logging' => env('LDAP_LOGGING', true),

    /*
    |--------------------------------------------------------------------------
    | LDAP Cache
    |--------------------------------------------------------------------------
    |
    | LDAP caching enables the ability of caching search results using the
    | query builder. This is great for running expensive operations that
    | may take many seconds to complete, such as a pagination request.
    |
    */

    'cache' => [
        'enabled' => env('LDAP_CACHE', false),
        'driver' => env('CACHE_DRIVER', 'file'),
    ],

];
EOFPF
  rm -f Dockerfile
  cat <<EOFPF > Dockerfile
# syntax=docker/dockerfile:1
# See https://hub.docker.com/r/docker/dockerfile

#######################################################
# Configuration
#######################################################

# See: https://github.com/mlocati/docker-php-extension-installer
ARG DOCKER_PHP_EXTENSION_INSTALLER_VERSION="2.1.80"

# See: https://github.com/composer/composer
ARG COMPOSER_VERSION="2.6"

# See: https://nginx.org/
ARG NGINX_VERSION="1.25.3"

# See: https://github.com/ddollar/forego
ARG FOREGO_VERSION="0.17.2"

# See: https://github.com/hairyhenderson/gomplate
ARG GOMPLATE_VERSION="v3.11.6"

# See: https://github.com/jippi/dottie
ARG DOTTIE_VERSION="v0.9.5"

ARG APT_PACKAGES_EXTRA="nano libldb-dev libldap2-dev libpq-dev"
###
# PHP base configuration
###

# See: https://hub.docker.com/_/php/tags
ARG PHP_VERSION="8.3"

# See: https://github.com/docker-library/docs/blob/master/php/README.md#image-variants
ARG PHP_BASE_TYPE="fpm"
ARG PHP_DEBIAN_RELEASE="bookworm"

ARG RUNTIME_UID=33 # often called 'www-data'
ARG RUNTIME_GID=33 # often called 'www-data'

# APT extra packages
ARG APT_PACKAGES_EXTRA=

# Extensions installed via [pecl install]
# ! NOTE: imagick is installed from [master] branch on GitHub due to 8.3 bug on ARM that haven't
# ! been released yet (after +10 months)!
# ! See: https://github.com/Imagick/imagick/pull/641
ARG PHP_PECL_EXTENSIONS="redis https://codeload.github.com/Imagick/imagick/tar.gz/28f27044e435a2b203e32675e942eb8de620ee58"
ARG PHP_PECL_EXTENSIONS_EXTRA=

# Extensions installed via [docker-php-ext-install]
ARG PHP_EXTENSIONS="intl bcmath zip pcntl exif curl gd ldap"
ARG PHP_EXTENSIONS_EXTRA=""
ARG PHP_EXTENSIONS_DATABASE="pdo_pgsql pdo_mysql pdo_sqlite"

# GPG key for nginx apt repository
ARG NGINX_GPGKEY="573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62"

# GPP key path for nginx apt repository
ARG NGINX_GPGKEY_PATH="/usr/share/keyrings/nginx-archive-keyring.gpg"

#######################################################
# Docker "copy from" images
#######################################################

# Composer docker image from Docker Hub
#
# NOTE: Docker will *not* pull this image unless it's referenced (via build target)
FROM composer:\${COMPOSER_VERSION} AS composer-image

# php-extension-installer image from Docker Hub
#
# NOTE: Docker will *not* pull this image unless it's referenced (via build target)
FROM mlocati/php-extension-installer:\${DOCKER_PHP_EXTENSION_INSTALLER_VERSION} AS php-extension-installer

# nginx webserver from Docker Hub.
# Used to copy some docker-entrypoint files for [nginx-runtime]
#
# NOTE: Docker will *not* pull this image unless it's referenced (via build target)
FROM nginx:\${NGINX_VERSION} AS nginx-image

# Forego is a Procfile "runner" that makes it trival to run multiple
# processes under a simple init / PID 1 process.
#
# NOTE: Docker will *not* pull this image unless it's referenced (via build target)
#
# See: https://github.com/nginx-proxy/forego
FROM nginxproxy/forego:\${FOREGO_VERSION}-debian AS forego-image

# Dottie makes working with .env files easier and safer
#
# NOTE: Docker will *not* pull this image unless it's referenced (via build target)
#
# See: https://github.com/jippi/dottie
FROM ghcr.io/jippi/dottie:\${DOTTIE_VERSION} AS dottie-image

# gomplate-image grabs the gomplate binary from GitHub releases
#
# It's in its own layer so it can be fetched in parallel with other build steps
FROM php:\${PHP_VERSION}-\${PHP_BASE_TYPE}-\${PHP_DEBIAN_RELEASE} AS gomplate-image

ARG TARGETARCH
ARG TARGETOS
ARG GOMPLATE_VERSION

RUN set -ex \
    && curl \
        --silent \
        --show-error \
        --location \
        --output /usr/local/bin/gomplate \
        https://github.com/hairyhenderson/gomplate/releases/download/\${GOMPLATE_VERSION}/gomplate_\${TARGETOS}-\${TARGETARCH} \
    && chmod +x /usr/local/bin/gomplate \
    && /usr/local/bin/gomplate --version

#######################################################
# Base image
#######################################################

FROM php:\${PHP_VERSION}-\${PHP_BASE_TYPE}-\${PHP_DEBIAN_RELEASE} AS base

ARG BUILDKIT_SBOM_SCAN_STAGE="true"

ARG APT_PACKAGES_EXTRA
ARG PHP_DEBIAN_RELEASE
ARG PHP_VERSION
ARG RUNTIME_GID
ARG RUNTIME_UID
ARG TARGETPLATFORM

ENV DEBIAN_FRONTEND="noninteractive"

# Ensure we run all scripts through 'bash' rather than 'sh'
SHELL ["/bin/bash", "-c"]

# Set www-data to be RUNTIME_UID/RUNTIME_GID
RUN groupmod --gid \${RUNTIME_GID} www-data \
    && usermod --uid \${RUNTIME_UID} --gid \${RUNTIME_GID} www-data

RUN set -ex \
    && mkdir -pv /var/www/ \
    && chown -R \${RUNTIME_UID}:\${RUNTIME_GID} /var/www

WORKDIR /var/www/

ENV APT_PACKAGES_EXTRA=\${APT_PACKAGES_EXTRA}

# Install and configure base layer
COPY docker/shared/root/docker/install/base.sh /docker/install/base.sh

RUN --mount=type=cache,id=pixelfed-apt-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/lib/apt \
    --mount=type=cache,id=pixelfed-apt-cache-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/cache/apt \
    /docker/install/base.sh

#######################################################
# PHP: extensions
#######################################################

FROM base AS php-extensions

ARG PHP_DEBIAN_RELEASE
ARG PHP_EXTENSIONS
ARG PHP_EXTENSIONS_DATABASE
ARG PHP_EXTENSIONS_EXTRA
ARG PHP_PECL_EXTENSIONS
ARG PHP_PECL_EXTENSIONS_EXTRA
ARG PHP_VERSION
ARG TARGETPLATFORM

COPY --from=php-extension-installer /usr/bin/install-php-extensions /usr/local/bin/

COPY docker/shared/root/docker/install/php-extensions.sh /docker/install/php-extensions.sh

RUN --mount=type=cache,id=pixelfed-pear-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/tmp/pear  \
    --mount=type=cache,id=pixelfed-apt-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/lib/apt \
    --mount=type=cache,id=pixelfed-apt-cache-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/cache/apt \
    PHP_EXTENSIONS=\${PHP_EXTENSIONS} \
    PHP_EXTENSIONS_DATABASE=\${PHP_EXTENSIONS_DATABASE} \
    PHP_EXTENSIONS_EXTRA=\${PHP_EXTENSIONS_EXTRA} \
    PHP_PECL_EXTENSIONS=\${PHP_PECL_EXTENSIONS} \
    PHP_PECL_EXTENSIONS_EXTRA=\${PHP_PECL_EXTENSIONS_EXTRA} \
    /docker/install/php-extensions.sh

#######################################################
# Node: Build frontend
#######################################################

# NOTE: Since the nodejs build is CPU architecture agnostic,
# we only want to build once and cache it for other architectures.
# We force the (CPU) [--platform] here to be architecture
# of the "builder"/"server" and not the *target* CPU architecture
# (e.g.) building the ARM version of Pixelfed on AMD64.
FROM --platform=\${BUILDARCH} node:lts AS frontend-build

ARG BUILDARCH
ARG BUILD_FRONTEND=0
ARG RUNTIME_UID
ARG RUNTIME_GID

ARG NODE_ENV=production
ENV NODE_ENV=\$NODE_ENV

WORKDIR /var/www/

SHELL [ "/usr/bin/bash", "-c" ]

# Install NPM dependencies
RUN --mount=type=cache,id=pixelfed-node-\${BUILDARCH},sharing=locked,target=/tmp/cache \
    --mount=type=bind,source=package.json,target=/var/www/package.json \
    --mount=type=bind,source=package-lock.json,target=/var/www/package-lock.json \
<<EOF
    if [[ \$BUILD_FRONTEND -eq 1 ]];
    then
        npm install --cache /tmp/cache --no-save --dev
    else
        echo "Skipping [npm install] as --build-arg [BUILD_FRONTEND] is not set to '1'"
    fi
EOF

# Copy the frontend source into the image before building
COPY --chown=\${RUNTIME_UID}:\${RUNTIME_GID} . /var/www

# Build the frontend with "mix" (See package.json)
RUN \
<<EOF
    if [[ \$BUILD_FRONTEND -eq 1 ]];
    then
        npm run production
    else
        echo "Skipping [npm run production] as --build-arg [BUILD_FRONTEND] is not set to '1'"
    fi
EOF

#######################################################
# PHP: composer and source code
#######################################################

FROM php-extensions AS composer-and-src

ARG PHP_VERSION
ARG PHP_DEBIAN_RELEASE
ARG RUNTIME_UID
ARG RUNTIME_GID
ARG TARGETPLATFORM

# Make sure composer cache is targeting our cache mount later
ENV COMPOSER_CACHE_DIR="/cache/composer"

# Don't enforce any memory limits for composer
ENV COMPOSER_MEMORY_LIMIT=-1

# Disable interactvitity from composer
ENV COMPOSER_NO_INTERACTION=1

# Copy composer from https://hub.docker.com/_/composer
COPY --link --from=composer-image /usr/bin/composer /usr/bin/composer

#! Changing user to runtime user
USER \${RUNTIME_UID}:\${RUNTIME_GID}


# Install composer dependencies
# NOTE: we skip the autoloader generation here since we don't have all files avaliable (yet)
RUN --mount=type=cache,id=pixelfed-composer-\${PHP_VERSION},sharing=locked,uid=\${RUNTIME_UID},gid=\${RUNTIME_GID},target=/cache/composer \
    --mount=type=bind,source=composer.json,target=/var/www/composer.json \
    --mount=type=bind,source=composer.lock,target=/var/www/composer.lock \
    set -ex \
    && composer install --prefer-dist --no-autoloader --ignore-platform-reqs --no-scripts

# Copy all other files over
COPY --chown=\${RUNTIME_UID}:\${RUNTIME_GID} . /var/www/

RUN composer require directorytree/ldaprecord-laravel

# Generate optimized autoloader now that we have all files around
RUN set -ex \
    && ENABLE_CONFIG_CACHE=false composer dump-autoload --optimize

# Now we can run the post-install scripts
RUN set -ex \
    && composer run-script post-update-cmd

#######################################################
# Runtime: base
#######################################################

FROM php-extensions AS shared-runtime

ARG RUNTIME_GID
ARG RUNTIME_UID

ENV RUNTIME_UID=\${RUNTIME_UID}
ENV RUNTIME_GID=\${RUNTIME_GID}

COPY --link --from=forego-image /usr/local/bin/forego /usr/local/bin/forego
COPY --link --from=dottie-image /dottie /usr/local/bin/dottie
COPY --link --from=gomplate-image /usr/local/bin/gomplate /usr/local/bin/gomplate
COPY --link --from=composer-image /usr/bin/composer /usr/bin/composer
COPY --link --from=composer-and-src --chown=\${RUNTIME_UID}:\${RUNTIME_GID} /var/www /var/www
COPY --link --from=frontend-build --chown=\${RUNTIME_UID}:\${RUNTIME_GID} /var/www/public /var/www/public

USER root

# for detail why storage is copied this way, pls refer to https://github.com/pixelfed/pixelfed/pull/2137#discussion_r434468862
RUN set -ex \
    && cp --recursive --link --preserve=all storage storage.skel \
    && rm -rf html && ln -s public html

COPY docker/shared/root /

ENTRYPOINT ["/docker/entrypoint.sh"]

#######################################################
# Runtime: apache
#######################################################

FROM shared-runtime AS apache-runtime

COPY docker/apache/root /

RUN set -ex \
    && a2enmod rewrite remoteip proxy proxy_http \
    && a2enconf remoteip

CMD ["apache2-foreground"]

#######################################################
# Runtime: fpm
#######################################################

FROM shared-runtime AS fpm-runtime

COPY docker/fpm/root /

CMD ["php-fpm"]

#######################################################
# Runtime: nginx
#######################################################

FROM shared-runtime AS nginx-runtime

ARG NGINX_GPGKEY
ARG NGINX_GPGKEY_PATH
ARG NGINX_VERSION
ARG PHP_DEBIAN_RELEASE
ARG PHP_VERSION
ARG TARGETPLATFORM

# Install nginx dependencies
RUN --mount=type=cache,id=pixelfed-apt-lists-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/lib/apt/lists \
    --mount=type=cache,id=pixelfed-apt-cache-\${PHP_VERSION}-\${PHP_DEBIAN_RELEASE}-\${TARGETPLATFORM},sharing=locked,target=/var/cache/apt \
    set -ex \
    && gpg1 --keyserver "hkp://keyserver.ubuntu.com:80" --keyserver-options timeout=10 --recv-keys "\${NGINX_GPGKEY}" \
    && gpg1 --export "\$NGINX_GPGKEY" > "\$NGINX_GPGKEY_PATH" \
    && echo "deb [signed-by=\${NGINX_GPGKEY_PATH}] https://nginx.org/packages/mainline/debian/ \${PHP_DEBIAN_RELEASE} nginx" >> /etc/apt/sources.list.d/nginx.list \
    && apt-get update \
    && apt-get install -y --no-install-recommends nginx=\${NGINX_VERSION}*

# copy docker entrypoints from the *real* nginx image directly
COPY --link --from=nginx-image /docker-entrypoint.d /docker/entrypoint.d/
COPY docker/nginx/root /
COPY docker/nginx/Procfile .

STOPSIGNAL SIGQUIT

CMD ["forego", "start", "-r"]
EOFPF
  rm -f resources/views/settings/home.blade.php
  cat <<EOFPF > resources/views/settings/home.blade.php
@extends('settings.template')

@section('section')

        <div class="title">
                <h3 class="font-weight-bold">{{__('settings.home.account_settings')}}</h3>
        </div>
        <hr>
        <div class="form-group row">
                <div class="col-sm-3">
                        <img src="{{Auth::user()->profile->avatarUrl()}}" width="38px" height="38px" class="rounded-circle float-right" draggable="false" onerror="this.src='/storage/avatars/default.jpg?v=0';this.onerror=null;">
                </div>
                <div class="col-sm-9">
                        <p class="lead font-weight-bold mb-0">{{Auth::user()->username}}</p>
                        <p class="">
                                <a href="#" class="font-weight-bold change-profile-photo" data-toggle="collapse" data-target="#avatarCollapse" aria-expanded="false" aria-controls="avatarCollapse">{{__('settings.home.change_profile_photo')}}</a>
                        </p>
                        <div class="collapse" id="avatarCollapse">
                                <form method="post" action="/settings/avatar" enctype="multipart/form-data">
                                @csrf
                                <div class="card card-body">
                                        <div class="custom-file mb-1">
                                                <input type="file" name="avatar" class="custom-file-input" id="avatarInput">
                                                <label class="custom-file-label" for="avatarInput">{{__('settings.home.select_a_profile_photo')}}</label>
                                        </div>
                                        <p><span class="small font-weight-bold">{{__('settings.home.must_be_a_jpeg_or_png_max_avatar_size')}} <span id="maxAvatarSize"></span></span></p>
                                        <div id="previewAvatar"></div>
                                        <p class="mb-0"><button type="submit" class="btn btn-primary px-4 py-0 font-weight-bold">{{__('settings.home.upload')}}</button></p>
                                </div>
                                </form>
                        </div>
                        <p class="">
                                <a class="font-weight-bold text-muted delete-profile-photo" href="#">{{__('settings.home.delete_profile_photo')}}</a>
                        </p>
                </div>
        </div>
        <form method="post">
                @csrf
                <div class="form-group row">
                        <label for="name" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.name')}}</label>                        <div class="col-sm-9">
                                <input type="text" class="form-control" id="name" name="name" placeholder="{{__('settings.home.your_name')}}" maxlength="30" value="{{Auth::user()->profile->name}}" v-pre>
                        </div>
                </div>
                <div class="form-group row">
                        <label for="website" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.website')}}</label>
                        <div class="col-sm-9">
                                <input type="text" class="form-control" id="website" name="website" placeholder="{{__('settings.home.website')}}" value="{{Auth::user()->profile->website}}" v-pre>
                        </div>
                </div>
                <div class="form-group row">
                        <label for="bio" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.bio')}}</label>
                        <div class="col-sm-9">
                                <textarea
                                        class="form-control"
                                        id="bio"
                                        name="bio"
                                        placeholder="{{__('settings.home.add_a_bio_here')}}"
                                        rows="2"
                                        data-max-length="{{config('pixelfed.max_bio_length')}}"
                                        maxlength="{{config('pixelfed.max_bio_length')}}"
                                        v-pre>{{strip_tags(Auth::user()->profile->bio)}}</textarea>
                                <p class="form-text">
                                        <span class="bio-counter float-right small text-muted">0/{{config('pixelfed.max_bio_length')}}</span>
                                </p>
                        </div>
                </div>
                <div class="form-group row">
                        <label for="language" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.language')}}</label>
                        <div class="col-sm-9">
                                <select class="form-control" name="language">
                                @foreach(App\Util\Localization\Localization::languages() as \$lang)
                                        <option value="{{\$lang}}" {{(Auth::user()->language ?? 'en') == \$lang ? 'selected':''}}>{{locale_get_display_language(\$lang, 'en')}} - {{locale_get_display_language(\$lang, \$lang)}}</option>
                                @endforeach
                                </select>
                        </div>
                </div>
        @if((bool) config_cache('federation.activitypub.enabled'))
        <div class="form-group row">
            <label for="aliases" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.account_aliases')}}</label>
            <div class="col-sm-9" id="aliases">
                <a class="font-weight-bold" href="/settings/account/aliases/manage">{{__('settings.home.manage_account_alias')}}</a>
                <p class="help-text text-muted small">{{__('settings.home.to_move_from_another_account_to_this_one_first_etc')}}</p>
            </div>
        </div>

        @if((bool) config_cache('federation.migration'))
        <div class="form-group row">
            <label for="aliases" class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.account_migrate')}}</label>
            <div class="col-sm-9" id="aliases">
                <a class="font-weight-bold" href="/settings/account/migration/manage">{{__('settings.home.migrate_to_another_account')}}</a>
                <p class="help-text text-muted small">{{__('settings.home.to_redirect_this_account_to_a_different_one_etc')}}</p>
            </div>
        </div>
        @endif
        @endif
                @if(config_cache('pixelfed.enforce_account_limit'))
                <div class="pt-3">
                        <p class="font-weight-bold text-muted text-center">{{__('settings.home.storage_usage')}}</p>
                </div>
                <div class="form-group row">
                        <label class="col-sm-3 col-form-label font-weight-bold">{{__('settings.home.storage_used')}}</label>
                        <div class="col-sm-9">
                                <div class="progress mt-2">
                                        <div class="progress-bar" role="progressbar" style="width: {{\$storage['percentUsed']}}%"  aria-valuenow="{{\$storage['percentUsed']}}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="help-text">
                                        <span class="small text-muted">
                                                {{\$storage['percentUsed']}}% used
                                        </span>
                                        <span class="small text-muted float-right">
                                                {{\$storage['usedPretty']}} / {{\$storage['limitPretty']}}
                                        </span>
                                </div>
                        </div>
                </div>
                @endif
                <hr>
                <div class="form-group row">
                        <div class="col-12 text-right">
                                <button type="submit" class="btn btn-primary font-weight-bold py-0 px-5">{{__('settings.submit')}}</button>
                        </div>
                </div>
        </form>

@endsection

@push('scripts')
<script type="text/javascript">

\$(document).ready(function() {
                let el = \$('#bio');
                let len = el.val().length;
                let limit = el.data('max-length');

                if(len > 100) {
                        el.attr('rows', '4');
                }

                let val = len + ' / ' + limit;

                if(len > limit) {
                        let diff = len - limit;
                        val = '<span class="text-danger">-' + diff + '</span> / ' + limit;
                }

                \$('.bio-counter').html(val);

                \$('#bio').on('change keyup paste', function(e) {
                        let el = \$(this);
                        let len = el.val().length;
                        let limit = el.data('max-length');

                        if(len > 100) {
                                el.attr('rows', '4');
                        }

                        let val = len + ' / ' + limit;

                        if(len > limit) {
                                let diff = len - limit;
                                val = '<span class="text-danger">-' + diff + '</span> / ' + limit;
                        }

                        \$('.bio-counter').html(val);
                });

                \$(document).on('click', '.modal-close', function(e) {
                        swal.close();
                });

                \$('#maxAvatarSize').text(filesize({{config('pixelfed.max_avatar_size') * 1024}}, {round: 0}));

                \$('#avatarInput').on('change', function(e) {
                                var file = document.getElementById('avatarInput').files[0];
                                var reader = new FileReader();

                                reader.addEventListener("load", function() {
                                                \$('#previewAvatar').html('<img src="' + reader.result + '" class="rounded-circle box-shadow mb-3" width="100%" height="100%"/>');
                                }, false);

                                if (file) {
                                                reader.readAsDataURL(file);
                                }
                });

                \$('.delete-profile-photo').on('click', function(e) {
                        e.preventDefault();
                        if(window.confirm('{{__('settings.home.are_you_sure_you_want_to_delete_your_profile_photo')}}') == false) {
                                return;
                        }
                        axios.delete('/settings/avatar').then(res => {
                                window.location.href = window.location.href;
                        }).catch(err => {
                                swal('{{__('settings.error')}}', '{{__('settings.home.an_error_occured_please_try_again_later')}}', 'error');
                        });
                });
})

</script>
@endpush
EOFPF
  DOCKER_BUILDKIT=1 docker build -t $(getScriptImageByContainerName pixelfed-app) .
  buildRetVal=$?
  cd ~
  sudo rm -fr $HSHQ_BUILD_DIR/pixelfed*
  return $buildRetVal
}

function performUpdatePixelfed()
{
  perform_stack_name=pixelfed
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=exampleimage
      image_update_map[0]="exampleimage,exampleimage"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Yamtrack
function installYamtrack()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory yamtrack "Yamtrack"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName yamtrack-db)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName yamtrack-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName yamtrack-redis)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/yamtrack
  mkdir $HSHQ_STACKS_DIR/yamtrack/db
  mkdir $HSHQ_STACKS_DIR/yamtrack/dbexport
  mkdir $HSHQ_NONBACKUP_DIR/yamtrack
  mkdir $HSHQ_NONBACKUP_DIR/yamtrack/redis
  chmod 777 $HSHQ_STACKS_DIR/yamtrack/dbexport
  initServicesCredentials
  set +e
  YAMTRACK_OIDC_CLIENT_SECRET_HASH=$(htpasswd -bnBC 10 "" $YAMTRACK_OIDC_CLIENT_SECRET | tr -d ':\n')
  outputConfigYamtrack
  oidcBlock=$(cat $HOME/yamtrack.oidc)
  rm -f $HOME/yamtrack.oidc
  insertOIDCClientAuthelia yamtrack "$oidcBlock"
  installStack yamtrack yamtrack-app "Listening at: http://127.0.0.1:8001" $HOME/yamtrack.env 5
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$YAMTRACK_INIT_ENV" = "true" ]; then
    sendEmail -s "Yamtrack Admin Login Info" -b "Yamtrack Admin Username: $YAMTRACK_ADMIN_USERNAME\nYamtrack Admin Password: $YAMTRACK_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    YAMTRACK_INIT_ENV=true
    updateConfigVar YAMTRACK_INIT_ENV $YAMTRACK_INIT_ENV
  fi
  sleep 3
  docker exec -it yamtrack-app python manage.py shell -c "User.objects.create_user(username='$YAMTRACK_ADMIN_USERNAME', password='$YAMTRACK_ADMIN_PASSWORD', is_staff=True, is_superuser=True)" > /dev/null 2>&1
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://yamtrack-app:8000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_YAMTRACK $MANAGETLS_YAMTRACK "$is_integrate_hshq" $NETDEFAULT_YAMTRACK "$inner_block"
  insertSubAuthelia $SUB_YAMTRACK.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll yamtrack "$FMLNAME_YAMTRACK" $USERTYPE_YAMTRACK "https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN" "yamtrack.png" "$(getHeimdallOrderFromSub $SUB_YAMTRACK $USERTYPE_YAMTRACK)"
    restartAllCaddyContainers
    checkAddDBConnection true yamtrack "$FMLNAME_YAMTRACK" postgres yamtrack-db $YAMTRACK_DATABASE_NAME $YAMTRACK_DATABASE_USER $YAMTRACK_DATABASE_USER_PASSWORD
  fi
}

function outputConfigYamtrack()
{
  cat <<EOFMT > $HOME/yamtrack-compose.yml
$STACK_VERSION_PREFIX yamtrack $(getScriptStackVersion yamtrack)

services:
  yamtrack-db:
    image: $(getScriptImageByContainerName yamtrack-db)
    container_name: yamtrack-db
    hostname: yamtrack-db
    user: "\${UID}:\${GID}"
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    shm_size: 256mb
    networks:
      - int-yamtrack-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/yamtrack/db:/var/lib/postgresql/data
      - \${HSHQ_SCRIPTS_DIR}/user/exportPostgres.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/yamtrack/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.yamtrack-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.yamtrack-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.yamtrack-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.yamtrack-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.yamtrack-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.yamtrack-hourly-db.email-from=Yamtrack Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.yamtrack-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.yamtrack-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.yamtrack-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.yamtrack-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.yamtrack-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.yamtrack-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.yamtrack-monthly-db.email-from=Yamtrack Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.yamtrack-monthly-db.mail-only-on-error=false"

  yamtrack-app:
    image: $(getScriptImageByContainerName yamtrack-app)
    container_name: yamtrack-app
    hostname: yamtrack-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - yamtrack-db
    networks:
      - int-yamtrack-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - /etc/ssl/certs/ca-certificates.crt:/usr/local/lib/\${PYTHON_VER}/site-packages/certifi/cacert.pem:ro

  yamtrack-redis:
    image: $(getScriptImageByContainerName yamtrack-redis)
    container_name: yamtrack-redis
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - int-yamtrack-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-yamtrack-redis:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD=$YAMTRACK_REDIS_PASSWORD

volumes:
  v-yamtrack-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/yamtrack/db
  v-yamtrack-redis:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_NONBACKUP_DIR}/yamtrack/redis

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-yamtrack-net:
    driver: bridge
    internal: true
    ipam:
      driver: default
EOFMT
  cat <<EOFMT > $HOME/yamtrack.env
TZ=\${TZ}
PUID=\${UID}
PGID=\${GID}
SOCIAL_PROVIDERS=allauth.socialaccount.providers.openid_connect
SOCIALACCOUNT_PROVIDERS={"openid_connect":{"OAUTH_PKCE_ENABLED":true,"APPS":[{"provider_id":"authelia","name":"Authelia","client_id":"$YAMTRACK_OIDC_CLIENT_ID","secret":"$YAMTRACK_OIDC_CLIENT_SECRET","settings":{"server_url":"https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN/.well-known/openid-configuration"}}]}}
ACCOUNT_DEFAULT_HTTP_PROTOCOL=https
REDIS_URL=redis://:$YAMTRACK_REDIS_PASSWORD@yamtrack-redis:6379/0
SECRET=$YAMTRACK_SECRET_KEY
URLS=https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN
ALLOWED_HOSTS=https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN
CSRF=https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN
REGISTRATION=true
DEBUG=false
ADMIN_ENABLED=true
DB_HOST=yamtrack-db
DB_PORT=5432
DB_NAME=$YAMTRACK_DATABASE_NAME
DB_USER=$YAMTRACK_DATABASE_USER
DB_PASSWORD=$YAMTRACK_DATABASE_USER_PASSWORD
POSTGRES_DB=$YAMTRACK_DATABASE_NAME
POSTGRES_USER=$YAMTRACK_DATABASE_USER
POSTGRES_PASSWORD=$YAMTRACK_DATABASE_USER_PASSWORD
POSTGRES_INITDB_ARGS=--data-checksums
PYTHON_VER=python3.12
EOFMT
  rm -f $HOME/yamtrack.oidc
  cat <<EOFIM > $HOME/yamtrack.oidc
# Authelia OIDC Client yamtrack BEGIN
      - client_id: $YAMTRACK_OIDC_CLIENT_ID
        client_name: $FMLNAME_YAMTRACK
        client_secret: '$YAMTRACK_OIDC_CLIENT_SECRET_HASH'
        public: false
        authorization_policy: ${LDAP_PRIMARY_USER_GROUP_NAME}_auth
        require_pkce: true
        pkce_challenge_method: S256
        redirect_uris:
          - https://$SUB_YAMTRACK.$HOMESERVER_DOMAIN/accounts/oidc/authelia/login/callback/
        scopes:
          - openid
          - profile
          - email
          - groups
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic
# Authelia OIDC Client yamtrack END
EOFIM
}

function performUpdateYamtrack()
{
  perform_stack_name=yamtrack
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=exampleimage
      image_update_map[0]="exampleimage,exampleimage"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Servarr
function installServarr()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory servarr "Servarr"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-sonarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-radarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-lidarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-readarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-bazarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-mylar3)
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName servarr-prowlarr)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e
  mkdir -p $HSHQ_STACKS_DIR/shared/rdata/media/{audio,books,comics,misc,movies,software,tv}
  mkdir -p $HSHQ_STACKS_DIR/servarr/sonarr/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/radarr/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/lidarr/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/readarr/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/bazarr/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/mylar3/config
  mkdir -p $HSHQ_STACKS_DIR/servarr/prowlarr/config
  initServicesCredentials
  set +e
  outputConfigServarr
  installStack servarr servarr-sonarr "\[ls.io-init\] done" $HOME/servarr.env 5
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-sonarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-radarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-lidarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-readarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-bazarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-mylar3 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  waitForContainerLogString servarr-prowlarr 1 300 "\[ls.io-init\] done"
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  sleep 5
  echo "Stopping servarr stack..."
  startStopStack servarr stop
  sonarr_api_key=$(cat $HSHQ_STACKS_DIR/servarr/sonarr/config/config.xml | grep ApiKey | cut -d">" -f2 | cut -d"<" -f1)
  radarr_api_key=$(cat $HSHQ_STACKS_DIR/servarr/radarr/config/config.xml | grep ApiKey | cut -d">" -f2 | cut -d"<" -f1)
  lidarr_api_key=$(cat $HSHQ_STACKS_DIR/servarr/lidarr/config/config.xml | grep ApiKey | cut -d">" -f2 | cut -d"<" -f1)
  readarr_api_key=$(cat $HSHQ_STACKS_DIR/servarr/readarr/config/config.xml | grep ApiKey | cut -d">" -f2 | cut -d"<" -f1)
  mylar3_api_key=$(uuidgen | sed "s/-//g")
  cat <<EOFPY > /tmp/hashtmp.py
import base64
import hashlib
import secrets
password='$SONARR_ADMIN_PASSWORD'
salt='$(pwgen -c -n 16 1)'
iterations=10000
key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt.encode('utf-8'), iterations, dklen=32)
print(base64.b64encode(key),base64.b64encode(salt.encode('utf-8')));
EOFPY
  sonarr_hashes=$(python3 /tmp/hashtmp.py)
  sonarr_pw_hash=$(echo "$sonarr_hashes" | cut -d" " -f1 | cut -d"'" -f2)
  sonarr_salt_hash=$(echo "$sonarr_hashes" | cut -d" " -f2 | cut -d"'" -f2)
  sqlite3 $HSHQ_STACKS_DIR/servarr/sonarr/config/sonarr.db "insert into Users("Id","Identifier","Username","Password","Salt","Iterations") values(1,'$(uuidgen)','$SONARR_ADMIN_USERNAME','$sonarr_pw_hash','$sonarr_salt_hash',10000);"
  sqlite3 $HSHQ_STACKS_DIR/servarr/sonarr/config/sonarr.db "insert into RootFolders("Path") values('/data/media/tv/');"
  sed -i 's/^.*AuthenticationMethod.*$/  <AuthenticationMethod>Forms<\/AuthenticationMethod>/' $HSHQ_STACKS_DIR/servarr/sonarr/config/config.xml
  sed -i 's/<\/Config>/\  <AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/' $HSHQ_STACKS_DIR/servarr/sonarr/config/config.xml
  cat <<EOFPY > /tmp/hashtmp.py
import base64
import hashlib
import secrets
password='$RADARR_ADMIN_PASSWORD'
salt='$(pwgen -c -n 16 1)'
iterations=10000
key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt.encode('utf-8'), iterations, dklen=32)
print(base64.b64encode(key),base64.b64encode(salt.encode('utf-8')));
EOFPY
  radarr_hashes=$(python3 /tmp/hashtmp.py)
  radarr_pw_hash=$(echo "$radarr_hashes" | cut -d" " -f1 | cut -d"'" -f2)
  radarr_salt_hash=$(echo "$radarr_hashes" | cut -d" " -f2 | cut -d"'" -f2)
  sqlite3 $HSHQ_STACKS_DIR/servarr/radarr/config/radarr.db "insert into Users("Id","Identifier","Username","Password","Salt","Iterations") values(1,'$(uuidgen)','$RADARR_ADMIN_USERNAME','$radarr_pw_hash','$radarr_salt_hash',10000);"
  sqlite3 $HSHQ_STACKS_DIR/servarr/radarr/config/radarr.db "insert into RootFolders("Path") values('/data/media/movies/');"
  sed -i 's/^.*AuthenticationMethod.*$/  <AuthenticationMethod>Forms<\/AuthenticationMethod>/' $HSHQ_STACKS_DIR/servarr/radarr/config/config.xml
  sed -i 's/<\/Config>/\  <AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/' $HSHQ_STACKS_DIR/servarr/radarr/config/config.xml
  cat <<EOFPY > /tmp/hashtmp.py
import base64
import hashlib
import secrets
password='$LIDARR_ADMIN_PASSWORD'
salt='$(pwgen -c -n 16 1)'
iterations=10000
key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt.encode('utf-8'), iterations, dklen=32)
print(base64.b64encode(key),base64.b64encode(salt.encode('utf-8')));
EOFPY
  lidarr_hashes=$(python3 /tmp/hashtmp.py)
  lidarr_pw_hash=$(echo "$lidarr_hashes" | cut -d" " -f1 | cut -d"'" -f2)
  lidarr_salt_hash=$(echo "$lidarr_hashes" | cut -d" " -f2 | cut -d"'" -f2)
  sqlite3 $HSHQ_STACKS_DIR/servarr/lidarr/config/lidarr.db "insert into Users("Id","Identifier","Username","Password","Salt","Iterations") values(1,'$(uuidgen)','$LIDARR_ADMIN_USERNAME','$lidarr_pw_hash','$lidarr_salt_hash',10000);"
  sqlite3 $HSHQ_STACKS_DIR/servarr/lidarr/config/lidarr.db "insert into RootFolders("Path","Name","DefaultMetadataProfileId","DefaultQualityProfileId","DefaultMonitorOption","DefaultTags","DefaultNewItemMonitorOption") values('/data/media/audio/','Audio',1,1,0,'[]',0);"
  sed -i 's/^.*AuthenticationMethod.*$/  <AuthenticationMethod>Forms<\/AuthenticationMethod>/' $HSHQ_STACKS_DIR/servarr/lidarr/config/config.xml
  sed -i 's/<\/Config>/\  <AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/' $HSHQ_STACKS_DIR/servarr/lidarr/config/config.xml
  readarr_pw_hash=$(echo -n "$READARR_ADMIN_PASSWORD" | sha256sum | xargs | cut -d" " -f1)
  sqlite3 $HSHQ_STACKS_DIR/servarr/readarr/config/readarr.db "insert into Users("Id","Identifier","Username","Password") values(1,'$(uuidgen)','$READARR_ADMIN_USERNAME','$readarr_pw_hash');"

  sqlite3 $HSHQ_STACKS_DIR/servarr/readarr/config/readarr.db "insert into RootFolders("Path","Name","DefaultMetadataProfileId","DefaultQualityProfileId","DefaultMonitorOption","DefaultTags","IsCalibreLibrary","DefaultNewItemMonitorOption") values('/data/media/books/','Books',1,1,0,'[]',0,0);"

  sed -i 's/^.*AuthenticationMethod.*$/  <AuthenticationMethod>Forms<\/AuthenticationMethod>/' $HSHQ_STACKS_DIR/servarr/readarr/config/config.xml
  sed -i 's/<\/Config>/\  <AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/' $HSHQ_STACKS_DIR/servarr/readarr/config/config.xml
  bazarr_pw_hash=$(echo -n "$BAZARR_ADMIN_PASSWORD" | md5sum | xargs | cut -d" " -f1)
  yq -r -i ".analytics.enabled = false" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".auth.password = \"$bazarr_pw_hash\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".auth.type = \"form\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".auth.username = \"$BAZARR_ADMIN_USERNAME\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".general.use_sonarr = true" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".sonarr.apikey = \"$sonarr_api_key\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".sonarr.ip = \"$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".sonarr.port = 443" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".sonarr.ssl = true" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".general.use_radarr = true" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".radarr.apikey = \"$radarr_api_key\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".radarr.ip = \"$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN\"" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".radarr.port = 443" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  yq -r -i ".radarr.ssl = true" $HSHQ_STACKS_DIR/servarr/bazarr/config/config/config.yaml
  sed -i "s/^destination_dir.*/destination_dir = \/data\/media\/comics/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^replace_char.*/replace_char = \./" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^zero_level_n.*/zero_level_n = none/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "/^config_version.*/a\minimal_ini = False/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^http_username.*/http_username = $MYLAR3_ADMIN_USERNAME/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^http_password.*/http_password = $MYLAR3_ADMIN_PASSWORD/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^authentication.*/authentication = 2/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^api_enabled.*/api_enabled = True/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^api_key.*/api_key = $mylar3_api_key/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^log_dir.*/log_dir = \/config\/mylar\/logs/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^provider_order.*/provider_order = None/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^nzbget_priority.*/nzbget_priority = Default/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "/^extra_torznabs.*/a torznab_name = None\ntorznab_host = None\ntorznab_apikey = None\ntorznab_category = None\ntorznab_verify = False/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_enabled.*/email_enabled = True/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_from.*/email_from = $EMAIL_ADMIN_EMAIL_ADDRESS/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_to.*/email_to = $EMAIL_ADMIN_EMAIL_ADDRESS/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_server.*/email_server = $SMTP_HOSTNAME/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_port.*/email_port = $SMTP_HOSTPORT/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  sed -i "s/^email_enc.*/email_enc = 2/" $HSHQ_STACKS_DIR/servarr/mylar3/config/mylar/config.ini
  cat <<EOFPY > /tmp/hashtmp.py
import base64
import hashlib
import secrets
password='$PROWLARR_ADMIN_PASSWORD'
salt='$(pwgen -c -n 16 1)'
iterations=10000
key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt.encode('utf-8'), iterations, dklen=32)
print(base64.b64encode(key),base64.b64encode(salt.encode('utf-8')));
EOFPY
  prowlarr_hashes=$(python3 /tmp/hashtmp.py)
  prowlarr_pw_hash=$(echo "$prowlarr_hashes" | cut -d" " -f1 | cut -d"'" -f2)
  prowlarr_salt_hash=$(echo "$prowlarr_hashes" | cut -d" " -f2 | cut -d"'" -f2)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Users("Id","Identifier","Username","Password","Salt","Iterations") values(1,'$(uuidgen)','$PROWLARR_ADMIN_USERNAME','$prowlarr_pw_hash','$prowlarr_salt_hash',10000);"
  sed -i 's/^.*AuthenticationMethod.*$/  <AuthenticationMethod>Forms<\/AuthenticationMethod>/' $HSHQ_STACKS_DIR/servarr/prowlarr/config/config.xml
  sed -i 's/<\/Config>/\  <AnalyticsEnabled>False<\/AnalyticsEnabled>\n<\/Config>/' $HSHQ_STACKS_DIR/servarr/prowlarr/config/config.xml
  rm -f /tmp/hashtmp.py
  config_settings=$(cat <<EOFCF
{
  "prowlarrUrl": "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN",
  "baseUrl": "https://$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN",
  "apiKey": "$sonarr_api_key",
  "syncCategories": [
    5000,
    5010,
    5020,
    5030,
    5040,
    5045,
    5050,
    5090
  ],
  "animeSyncCategories": [
    5070
  ],
  "syncAnimeStandardFormatSearch": true,
  "syncRejectBlocklistedTorrentHashesWhileGrabbing": false
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Applications("Id","Name","Implementation","Settings","ConfigContract","SyncLevel","Tags") values(1,'Sonarr','Sonarr','$config_settings','SonarrSettings',2,'[]');"
  config_settings=$(cat <<EOFCF
{
  "prowlarrUrl": "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN",
  "baseUrl": "https://$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN",
  "apiKey": "$radarr_api_key",
  "syncCategories": [
    2000,
    2010,
    2020,
    2030,
    2040,
    2045,
    2050,
    2060,
    2070,
    2080,
    2090
  ],
  "syncRejectBlocklistedTorrentHashesWhileGrabbing": false
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Applications("Id","Name","Implementation","Settings","ConfigContract","SyncLevel","Tags") values(2,'Radarr','Radarr','$config_settings','RadarrSettings',2,'[]');"
  config_settings=$(cat <<EOFCF
{
  "prowlarrUrl": "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN",
  "baseUrl": "https://$SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN",
  "apiKey": "$lidarr_api_key",
  "syncCategories": [
    3000,
    3010,
    3030,
    3040,
    3050,
    3060
  ],
  "syncRejectBlocklistedTorrentHashesWhileGrabbing": false
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Applications("Id","Name","Implementation","Settings","ConfigContract","SyncLevel","Tags") values(3,'Lidarr','Lidarr','$config_settings','LidarrSettings',2,'[]');"
  config_settings=$(cat <<EOFCF
{
  "prowlarrUrl": "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN",
  "baseUrl": "https://$SUB_SERVARR_READARR.$HOMESERVER_DOMAIN",
  "apiKey": "$readarr_api_key",
  "syncCategories": [
    3030,
    7000,
    7010,
    7020,
    7030,
    7040,
    7050,
    7060
  ],
  "syncRejectBlocklistedTorrentHashesWhileGrabbing": false
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Applications("Id","Name","Implementation","Settings","ConfigContract","SyncLevel","Tags") values(4,'Readarr','Readarr','$config_settings','ReadarrSettings',2,'[]');"
  config_settings=$(cat <<EOFCF
{
  "prowlarrUrl": "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN",
  "baseUrl": "https://$SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN",
  "apiKey": "$mylar3_api_key",
  "syncCategories": [
    7030
  ]
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Applications("Id","Name","Implementation","Settings","ConfigContract","SyncLevel","Tags") values(5,'Mylar','Mylar','$config_settings','MylarSettings',2,'[]');"
  mail_settings=$(cat <<EOFCF
{
  "server": "$SMTP_HOSTNAME",
  "port": $SMTP_HOSTPORT,
  "useEncryption": 2,
  "from": "Sonarr $(getAdminEmailName) \u003C$EMAIL_ADMIN_EMAIL_ADDRESS\u003E",
  "to": [
    "$EMAIL_ADMIN_EMAIL_ADDRESS"
  ],
  "cc": [],
  "bcc": []
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/sonarr/config/sonarr.db "insert into Notifications("Name","OnGrab","OnDownload","Settings","Implementation","ConfigContract","OnUpgrade","Tags","OnRename","OnHealthIssue","IncludeHealthWarnings","OnSeriesDelete","OnEpisodeFileDelete","OnEpisodeFileDeleteForUpgrade","OnApplicationUpdate","OnManualInteractionRequired","OnSeriesAdd","OnHealthRestored","OnImportComplete") values('Email',1,1,'$mail_settings','Email','EmailSettings',1,'[]',0,0,0,1,1,1,1,1,1,0,1);"
  mail_settings=$(cat <<EOFCF
{
  "server": "$SMTP_HOSTNAME",
  "port": $SMTP_HOSTPORT,
  "useEncryption": 2,
  "from": "Radarr $(getAdminEmailName) \u003C$EMAIL_ADMIN_EMAIL_ADDRESS\u003E",
  "to": [
    "$EMAIL_ADMIN_EMAIL_ADDRESS"
  ],
  "cc": [],
  "bcc": []
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/radarr/config/radarr.db "insert into Notifications("Name","OnGrab","OnDownload","Settings","Implementation","ConfigContract","OnUpgrade","Tags","OnRename","OnHealthIssue","IncludeHealthWarnings","OnMovieDelete","OnMovieFileDelete","OnMovieFileDeleteForUpgrade","OnApplicationUpdate","OnMovieAdded","OnHealthRestored","OnManualInteractionRequired") values('Email',1,1,'$mail_settings','Email','EmailSettings',1,'[]',0,0,0,1,1,1,1,1,0,1);"
  mail_settings=$(cat <<EOFCF
{
  "server": "$SMTP_HOSTNAME",
  "port": $SMTP_HOSTPORT,
  "useEncryption": 2,
  "from": "Lidarr $(getAdminEmailName) \u003C$EMAIL_ADMIN_EMAIL_ADDRESS\u003E",
  "to": [
    "$EMAIL_ADMIN_EMAIL_ADDRESS"
  ],
  "cc": [],
  "bcc": []
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/lidarr/config/lidarr.db "insert into Notifications("Name","OnGrab","Settings","Implementation","ConfigContract","OnUpgrade","Tags","OnRename","OnReleaseImport","OnHealthIssue","IncludeHealthWarnings","OnDownloadFailure","OnImportFailure","OnTrackRetag","OnApplicationUpdate","OnArtistDelete","OnAlbumDelete","OnHealthRestored","OnArtistAdd") values('Email',1,'$mail_settings','Email','EmailSettings',1,'[]',0,1,0,0,1,1,0,1,1,0,0,1);"
  sqlite3 $HSHQ_STACKS_DIR/servarr/lidarr/config/lidarr.db "insert into Config("Key","Value") values('certificatevalidation','DisabledForLocalAddresses');"
  mail_settings=$(cat <<EOFCF
{
  "server": "$SMTP_HOSTNAME",
  "port": $SMTP_HOSTPORT,
  "useEncryption": 2,
  "from": "Readarr $(getAdminEmailName) \u003C$EMAIL_ADMIN_EMAIL_ADDRESS\u003E",
  "to": [
    "$EMAIL_ADMIN_EMAIL_ADDRESS"
  ],
  "cc": [],
  "bcc": []
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/readarr/config/readarr.db "insert into Notifications("Name","OnGrab","Settings","Implementation","ConfigContract","OnUpgrade","Tags","OnRename","OnReleaseImport","OnHealthIssue","IncludeHealthWarnings","OnDownloadFailure","OnImportFailure","OnBookRetag","OnAuthorDelete","OnBookDelete","OnBookFileDelete","OnBookFileDeleteForUpgrade","OnApplicationUpdate","OnAuthorAdded") values('Email',1,'$mail_settings','Email','EmailSettings',1,'[]',0,1,0,0,1,1,0,1,1,1,1,1,1);"
  sqlite3 $HSHQ_STACKS_DIR/servarr/readarr/config/readarr.db "insert into Config("Key","Value") values('certificatevalidation','DisabledForLocalAddresses');"
  sqlite3 $HSHQ_STACKS_DIR/servarr/bazarr/config/db/bazarr.db "update table_settings_notifier set enabled=1,url='mailto://$SMTP_HOSTNAME:$SMTP_HOSTPORT?from=Bazarr $(getAdminEmailName) <$EMAIL_ADMIN_EMAIL_ADDRESS>&to=$EMAIL_ADMIN_EMAIL_ADDRESS' where name='E-Mail';"
  mail_settings=$(cat <<EOFCF
{
  "server": "$SMTP_HOSTNAME",
  "port": $SMTP_HOSTPORT,
  "useEncryption": 2,
  "from": "Prowlarr $(getAdminEmailName) \u003C$EMAIL_ADMIN_EMAIL_ADDRESS\u003E",
  "to": [
    "$EMAIL_ADMIN_EMAIL_ADDRESS"
  ],
  "cc": [],
  "bcc": []
}
EOFCF
)
  sqlite3 $HSHQ_STACKS_DIR/servarr/prowlarr/config/prowlarr.db "insert into Notifications("Name","Settings","Implementation","ConfigContract","Tags","OnHealthIssue","IncludeHealthWarnings","OnApplicationUpdate","OnGrab","IncludeManualGrabs","OnHealthRestored") values('Email','$mail_settings','Email','EmailSettings','[]',0,0,1,1,0,0);"
  echo "Starting servarr stack..."
  startStopStack servarr start
  if ! [ "$SERVARR_INIT_ENV" = "true" ]; then
    sendEmail -s "Servarr Admin Login Info" -b "Sonarr Admin Username: $SONARR_ADMIN_USERNAME\nSonarr Admin Password: $SONARR_ADMIN_PASSWORD\n\nRadarr Admin Username: $RADARR_ADMIN_USERNAME\nRadarr Admin Password: $RADARR_ADMIN_PASSWORD\n\nLidarr Admin Username: $LIDARR_ADMIN_USERNAME\nLidarr Admin Password: $LIDARR_ADMIN_PASSWORD\n\nReadarr Admin Username: $READARR_ADMIN_USERNAME\nReadarr Admin Password: $READARR_ADMIN_PASSWORD\n\nBazarr Admin Username: $BAZARR_ADMIN_USERNAME\nBazarr Admin Password: $BAZARR_ADMIN_PASSWORD\n\nMylar3 Admin Username: $MYLAR3_ADMIN_USERNAME\nMylar3 Admin Password: $MYLAR3_ADMIN_PASSWORD\n\nProwlarr Admin Username: $PROWLARR_ADMIN_USERNAME\nProwlarr Admin Password: $PROWLARR_ADMIN_PASSWORD\n\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    SERVARR_INIT_ENV=true
    updateConfigVar SERVARR_INIT_ENV $SERVARR_INIT_ENV
  fi
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-sonarr:8989 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_SONARR $MANAGETLS_SERVARR_SONARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_SONARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-radarr:7878 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_RADARR $MANAGETLS_SERVARR_RADARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_RADARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-lidarr:8686 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_LIDARR $MANAGETLS_SERVARR_LIDARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_LIDARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_READARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-readarr:8787 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_READARR $MANAGETLS_SERVARR_READARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_READARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_READARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-bazarr:6767 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_BAZARR $MANAGETLS_SERVARR_BAZARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_BAZARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-mylar3:8090 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_MYLAR3 $MANAGETLS_SERVARR_MYLAR3 "$is_integrate_hshq" $NETDEFAULT_SERVARR_MYLAR3 "$inner_block"
  insertSubAuthelia $SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://servarr-prowlarr:9696 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SERVARR_PROWLARR $MANAGETLS_SERVARR_PROWLARR "$is_integrate_hshq" $NETDEFAULT_SERVARR_PROWLARR "$inner_block"
  insertSubAuthelia $SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_SONARR" $USERTYPE_SERVARR_SONARR "https://$SUB_SERVARR_SONARR.$HOMESERVER_DOMAIN" "sonarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_SONARR $USERTYPE_SERVARR_SONARR)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_RADARR" $USERTYPE_SERVARR_RADARR "https://$SUB_SERVARR_RADARR.$HOMESERVER_DOMAIN" "radarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_RADARR $USERTYPE_SERVARR_RADARR)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_LIDARR" $USERTYPE_SERVARR_LIDARR "https://$SUB_SERVARR_LIDARR.$HOMESERVER_DOMAIN" "lidarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_LIDARR $USERTYPE_SERVARR_LIDARR)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_READARR" $USERTYPE_SERVARR_READARR "https://$SUB_SERVARR_READARR.$HOMESERVER_DOMAIN" "readarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_READARR $USERTYPE_SERVARR_READARR)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_BAZARR" $USERTYPE_SERVARR_BAZARR "https://$SUB_SERVARR_BAZARR.$HOMESERVER_DOMAIN" "bazarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_BAZARR $USERTYPE_SERVARR_BAZARR)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_MYLAR3" $USERTYPE_SERVARR_MYLAR3 "https://$SUB_SERVARR_MYLAR3.$HOMESERVER_DOMAIN" "mylar3.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_MYLAR3 $USERTYPE_SERVARR_MYLAR3)"
    insertEnableSvcAll servarr "$FMLNAME_SERVARR_PROWLARR" $USERTYPE_SERVARR_PROWLARR "https://$SUB_SERVARR_PROWLARR.$HOMESERVER_DOMAIN" "prowlarr.png" "$(getHeimdallOrderFromSub $SUB_SERVARR_PROWLARR $USERTYPE_SERVARR_PROWLARR)"
    restartAllCaddyContainers
  fi
}

function outputConfigServarr()
{
  cat <<EOFMT > $HOME/servarr-compose.yml
$STACK_VERSION_PREFIX servarr $(getScriptStackVersion servarr)

services:
  servarr-sonarr:
    image: $(getScriptImageByContainerName servarr-sonarr)
    container_name: servarr-sonarr
    hostname: servarr-sonarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/sonarr/config:/config

  servarr-radarr:
    image: $(getScriptImageByContainerName servarr-radarr)
    container_name: servarr-radarr
    hostname: servarr-radarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/radarr/config:/config

  servarr-lidarr:
    image: $(getScriptImageByContainerName servarr-lidarr)
    container_name: servarr-lidarr
    hostname: servarr-lidarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/lidarr/config:/config

  servarr-readarr:
    image: $(getScriptImageByContainerName servarr-readarr)
    container_name: servarr-readarr
    hostname: servarr-readarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/readarr/config:/config

  servarr-bazarr:
    image: $(getScriptImageByContainerName servarr-bazarr)
    container_name: servarr-bazarr
    hostname: servarr-bazarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/bazarr/config:/config

  servarr-mylar3:
    image: $(getScriptImageByContainerName servarr-mylar3)
    container_name: servarr-mylar3
    hostname: servarr-mylar3
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/shared/rdata:/data
      - \${HSHQ_STACKS_DIR}/servarr/mylar3/config:/config

  servarr-prowlarr:
    image: $(getScriptImageByContainerName servarr-prowlarr)
    container_name: servarr-prowlarr
    hostname: servarr-prowlarr
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/servarr/prowlarr/config:/config

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true

EOFMT

  cat <<EOFMT > $HOME/servarr.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
EOFMT

}

function performUpdateServarr()
{
  perform_stack_name=servarr
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=linuxserver/sonarr:4.0.15,linuxserver/radarr:5.27.1-nightly,linuxserver/lidarr:2.13.1-nightly,linuxserver/readarr:0.4.19-nightly,linuxserver/bazarr:1.5.2,linuxserver/mylar3:0.8.2,linuxserver/prowlarr:2.0.1-nightly
      image_update_map[0]="linuxserver/sonarr:4.0.15,linuxserver/sonarr:4.0.15"
      image_update_map[1]="linuxserver/radarr:5.27.1-nightly,linuxserver/radarr:5.27.1-nightly"
      image_update_map[2]="linuxserver/lidarr:2.13.1-nightly,linuxserver/lidarr:2.13.1-nightly"
      image_update_map[3]="linuxserver/readarr:0.4.19-nightly,linuxserver/readarr:0.4.19-nightly"
      image_update_map[4]="linuxserver/bazarr:1.5.2,linuxserver/bazarr:1.5.2"
      image_update_map[5]="linuxserver/mylar3:0.8.2,linuxserver/mylar3:0.8.2"
      image_update_map[6]="linuxserver/prowlarr:2.0.1-nightly,linuxserver/prowlarr:2.0.1-nightly"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# SABnzbd
function installSABnzbd()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory sabnzbd "SABnzbd"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName sabnzbd)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/sabnzbd
  mkdir $HSHQ_STACKS_DIR/sabnzbd/config
  mkdir -p $HSHQ_STACKS_DIR/shared/rdata/usenet/incomplete
  mkdir -p $HSHQ_STACKS_DIR/shared/rdata/usenet/complete/{audio,books,comics,misc,movies,software,tv}
  initServicesCredentials
  set +e
  outputConfigSABnzbd
  installStack sabnzbd sabnzbd "Serving SSDP" $HOME/sabnzbd.env
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$SABNZBD_INIT_ENV" = "true" ]; then
    sendEmail -s "SABnzbd Admin Login Info" -b "SABnzbd Admin Username: $SABNZBD_ADMIN_USERNAME\nSABnzbd Admin Password: $SABNZBD_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    SABNZBD_INIT_ENV=true
    updateConfigVar SABNZBD_INIT_ENV $SABNZBD_INIT_ENV
  fi
  sleep 3
  startStopStack sabnzbd stop
  sed -i "s/^refresh_rate =.*/refresh_rate = 1/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^username =.*/username = $SABNZBD_ADMIN_USERNAME/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^password =.*/password = $SABNZBD_ADMIN_PASSWORD/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^web_color =.*/web_color = Night/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^download_dir =.*/download_dir = \/data\/usenet\/incomplete/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^complete_dir =.*/complete_dir = \/data\/usenet\/complete/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^history_retention_number =.*/history_retention_number = 1/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^host_whitelist =.*/host_whitelist = sabnzbd, $SUB_SABNZBD.$HOMESERVER_DOMAIN/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^email_server =.*/email_server = $SMTP_HOSTNAME/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^email_to =.*/email_to = $EMAIL_ADMIN_EMAIL_ADDRESS,/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^email_from =.*/email_from = $EMAIL_ADMIN_EMAIL_ADDRESS/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^email_full =.*/email_full = 1/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^email_rss =.*/email_rss = 1/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ncenter_prio_complete =.*/ncenter_prio_complete = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ncenter_prio_failed =.*/ncenter_prio_failed = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ncenter_prio_disk_full =.*/ncenter_prio_disk_full = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ncenter_prio_other =.*/ncenter_prio_other = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^acenter_prio_complete =.*/acenter_prio_complete = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^acenter_prio_failed =.*/acenter_prio_failed = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^acenter_prio_disk_full =.*/acenter_prio_disk_full = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^acenter_prio_other =.*/acenter_prio_other = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ntfosd_enable =.*/ntfosd_enable = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ntfosd_prio_complete =.*/ntfosd_prio_complete = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ntfosd_prio_failed =.*/ntfosd_prio_failed = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ntfosd_prio_disk_full =.*/ntfosd_prio_disk_full = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^ntfosd_prio_other =.*/ntfosd_prio_other = 0/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^prowl_prio_complete =.*/prowl_prio_complete = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^prowl_prio_failed =.*/prowl_prio_failed = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^prowl_prio_disk_full =.*/prowl_prio_disk_full = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^prowl_prio_other =.*/prowl_prio_other = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_download =.*/pushover_prio_download = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_pause_resume =.*/pushover_prio_pause_resume = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_complete =.*/pushover_prio_complete = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_failed =.*/pushover_prio_failed = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_disk_full =.*/pushover_prio_disk_full = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_warning =.*/pushover_prio_warning = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_error =.*/pushover_prio_error = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^pushover_prio_other =.*/pushover_prio_other = -3/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^nscript_script =.*/nscript_script = None/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  sed -i "s/^nscript_prio_other =.*/nscript_prio_other = 1/" $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini
  tee -a $HSHQ_STACKS_DIR/sabnzbd/config/sabnzbd.ini >/dev/null <<EOFSZ
[categories]
[[*]]
name = *
order = 0
pp = 3
script = None
dir = ""
newzbin = ""
priority = 0
[[tv]]
name = tv
order = 6
pp = ""
script = Default
dir = tv
newzbin = ""
priority = -100
[[software]]
name = software
order = 5
pp = ""
script = Default
dir = software
newzbin = ""
priority = -100
[[movies]]
name = movies
order = 4
pp = ""
script = Default
dir = movies
newzbin = ""
priority = -100
[[misc]]
name = misc
order = 3
pp = ""
script = Default
dir = misc
newzbin = ""
priority = -100
[[comics]]
name = comics
order = 2
pp = ""
script = Default
dir = comics
newzbin = ""
priority = -100
[[books]]
name = books
order = 1
pp = ""
script = Default
dir = books
newzbin = ""
priority = -100
[[audio]]
name = audio
order = 0
pp = ""
script = Default
dir = audio
newzbin = ""
priority = -100
EOFSZ
  startStopStack sabnzbd start
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SABNZBD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://sabnzbd:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SABNZBD $MANAGETLS_SABNZBD "$is_integrate_hshq" $NETDEFAULT_SABNZBD "$inner_block"
  insertSubAuthelia $SUB_SABNZBD.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll sabnzbd "$FMLNAME_SABNZBD" $USERTYPE_SABNZBD "https://$SUB_SABNZBD.$HOMESERVER_DOMAIN" "sabnzbd.png" "$(getHeimdallOrderFromSub $SUB_SABNZBD $USERTYPE_SABNZBD)"
    restartAllCaddyContainers
  fi
}

function outputConfigSABnzbd()
{
  cat <<EOFMT > $HOME/sabnzbd-compose.yml
$STACK_VERSION_PREFIX sabnzbd $(getScriptStackVersion sabnzbd)

services:
  sabnzbd:
    image: $(getScriptImageByContainerName sabnzbd)
    container_name: sabnzbd
    hostname: sabnzbd
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/sabnzbd/config:/config
      - \${HSHQ_STACKS_DIR}/shared/rdata/usenet:/data/usenet

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFMT

  cat <<EOFMT > $HOME/sabnzbd.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
EOFMT

}

function performUpdateSABnzbd()
{
  perform_stack_name=sabnzbd
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=linuxserver/sabnzbd:4.5.1
      image_update_map[0]="linuxserver/sabnzbd:4.5.1,linuxserver/sabnzbd:4.5.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# qBittorrent
function installqBittorrent()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory qbittorrent "qBittorrent"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName qbittorrent)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/qbittorrent
  mkdir $HSHQ_STACKS_DIR/qbittorrent/config
  mkdir -p $HSHQ_STACKS_DIR/shared/rdata/torrents/{audio,books,comics,misc,movies,software,tv}
  initServicesCredentials
  set +e
  outputConfigqBittorrent
  installStack qbittorrent qbittorrent "\[ls.io-init\] done" $HOME/qbittorrent.env
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$QBITTORRENT_INIT_ENV" = "true" ]; then
    sendEmail -s "qBittorrent Admin Login Info" -b "qBittorrent Admin Username: $QBITTORRENT_ADMIN_USERNAME\nqBittorrent Admin Password: $QBITTORRENT_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    QBITTORRENT_INIT_ENV=true
    updateConfigVar QBITTORRENT_INIT_ENV $QBITTORRENT_INIT_ENV
  fi
  sleep 3
  echo "Stopping qbittorrent stack..."
  startStopStack qbittorrent stop
  set +e
  sed -i "/^\[BitTorrent\].*/a Session\\\\Preallocation=true" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  grep -q AutoDeleteAddedTorrentFile $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  if [ $? -eq 0 ]; then
    sed -i "s/^AutoDeleteAddedTorrentFile=.*/AutoDeleteAddedTorrentFile=IfAdded/" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  else
    echo -e "\n[Core]\nAutoDeleteAddedTorrentFile=IfAdded\n" >> $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  fi
  sed -i "s/^Session\\\\DefaultSavePath=.*/Session\\\\DefaultSavePath=\/data\/torrents\//" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[BitTorrent\].*/a Session\\\\DisableAutoTMMByDefault=false" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[BitTorrent\].*/a Session\\\\DisableAutoTMMTriggers\\\\CategorySavePathChanged=false" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[BitTorrent\].*/a Session\\\\DisableAutoTMMTriggers\\\\DefaultSavePathChanged=false" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\email=$EMAIL_ADMIN_EMAIL_ADDRESS" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\enabled=true" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\req_auth=false" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\req_ssl=false" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\sender=$EMAIL_ADMIN_EMAIL_ADDRESS" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a MailNotification\\\\smtp_server=$SMTP_HOSTNAME" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  cat <<EOFPY > /tmp/hashtmp.py
import base64
import hashlib
import secrets
password='$QBITTORRENT_ADMIN_PASSWORD'
salt='$(pwgen -c -n 16 1)'
iterations=100000
key = hashlib.pbkdf2_hmac('sha512', password.encode('utf-8'), salt.encode('utf-8'), iterations, dklen=64)
print(base64.b64encode(key),base64.b64encode(salt.encode('utf-8')));
EOFPY
  qbittorrent_hashes=$(python3 /tmp/hashtmp.py)
  qbittorrent_pw_hash=$(echo "$qbittorrent_hashes" | cut -d" " -f1 | cut -d"'" -f2)
  qbittorrent_salt_hash=$(echo "$qbittorrent_hashes" | cut -d" " -f2 | cut -d"'" -f2)
  rm -f /tmp/hashtmp.py
  sed -i "/^\[Preferences\].*/a WebUI\\\\Password_PBKDF2=\"@ByteArray($qbittorrent_salt_hash:$qbittorrent_pw_hash)\"" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  sed -i "/^\[Preferences\].*/a WebUI\\\\Username=$QBITTORRENT_ADMIN_USERNAME" $HSHQ_STACKS_DIR/qbittorrent/config/qBittorrent/qBittorrent.conf
  echo "Starting qbittorrent stack..."
  startStopStack qbittorrent start
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_QBITTORRENT.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://qbittorrent:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_QBITTORRENT $MANAGETLS_QBITTORRENT "$is_integrate_hshq" $NETDEFAULT_QBITTORRENT "$inner_block"
  insertSubAuthelia $SUB_QBITTORRENT.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll qbittorrent "$FMLNAME_QBITTORRENT" $USERTYPE_QBITTORRENT "https://$SUB_QBITTORRENT.$HOMESERVER_DOMAIN" "qbittorrent.png" "$(getHeimdallOrderFromSub $SUB_QBITTORRENT $USERTYPE_QBITTORRENT)"
    restartAllCaddyContainers
  fi
}

function outputConfigqBittorrent()
{
  cat <<EOFMT > $HOME/qbittorrent-compose.yml
$STACK_VERSION_PREFIX qbittorrent $(getScriptStackVersion qbittorrent)

services:
  qbittorrent:
    image: $(getScriptImageByContainerName qbittorrent)
    container_name: qbittorrent
    hostname: qbittorrent
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
      - dock-internalmail-net
    ports:
      - "$QBITTORRENT_PORT:$QBITTORRENT_PORT"
      - "$QBITTORRENT_PORT:$QBITTORRENT_PORT/udp"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/qbittorrent/config:/config
      - \${HSHQ_STACKS_DIR}/shared/rdata/torrents:/data/torrents

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFMT

  cat <<EOFMT > $HOME/qbittorrent.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
EOFMT
}

function performUpdateqBittorrent()
{
  perform_stack_name=qbittorrent
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=linuxserver/qbittorrent:5.1.2
      image_update_map[0]="linuxserver/qbittorrent:5.1.2,linuxserver/qbittorrent:5.1.2"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# ExampleService
function installExampleService()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory exampleservice "ExampleService"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName exampleservice-app)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/exampleservice
  mkdir $HSHQ_STACKS_DIR/exampleservice/config
  mkdir $HSHQ_STACKS_DIR/exampleservice/db
  mkdir $HSHQ_STACKS_DIR/exampleservice/dbexport
  mkdir $HSHQ_STACKS_DIR/exampleservice/web
  chmod 777 $HSHQ_STACKS_DIR/exampleservice/dbexport
  initServicesCredentials
  set +e
  docker exec mailu-admin flask mailu alias-delete $EXAMPLESERVICE_ADMIN_EMAIL_ADDRESS
  sleep 5
  addUserMailu alias $EXAMPLESERVICE_ADMIN_USERNAME $HOMESERVER_DOMAIN $EMAIL_ADMIN_EMAIL_ADDRESS
  EXAMPLESERVICE_ADMIN_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $EXAMPLESERVICE_ADMIN_PASSWORD | tr -d ':\n')

  outputConfigExampleService
  installStack exampleservice exampleservice-app "" $HOME/exampleservice.env
  retVal=$?
  if [ $retVal -ne 0 ]; then
    return $retVal
  fi
  if ! [ "$EXAMPLESERVICE_INIT_ENV" = "true" ]; then
    sendEmail -s "ExampleService Admin Login Info" -b "ExampleService Admin Username: $EXAMPLESERVICE_ADMIN_USERNAME\nExampleService Admin Password: $EXAMPLESERVICE_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    EXAMPLESERVICE_INIT_ENV=true
    updateConfigVar EXAMPLESERVICE_INIT_ENV $EXAMPLESERVICE_INIT_ENV
  fi
  sleep 3
  set -e
  inner_block=""
  inner_block=$inner_block">>https://$SUB_EXAMPLESERVICE.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://exampleservice-web {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_EXAMPLESERVICE $MANAGETLS_EXAMPLESERVICE "$is_integrate_hshq" $NETDEFAULT_EXAMPLESERVICE "$inner_block"
  insertSubAuthelia $SUB_EXAMPLESERVICE.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}

  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll exampleservice "$FMLNAME_EXAMPLESERVICE" $USERTYPE_EXAMPLESERVICE "https://$SUB_EXAMPLESERVICE.$HOMESERVER_DOMAIN" "exampleservice.png" "$(getHeimdallOrderFromSub $SUB_EXAMPLESERVICE $USERTYPE_EXAMPLESERVICE)"
    restartAllCaddyContainers
    checkAddDBConnection true exampleservice "$FMLNAME_EXAMPLESERVICE" mysql exampleservice-db $EXAMPLESERVICE_DATABASE_NAME $EXAMPLESERVICE_DATABASE_USER $EXAMPLESERVICE_DATABASE_USER_PASSWORD
  fi
}

function outputConfigExampleService()
{
  cat <<EOFMT > $HOME/exampleservice-compose.yml
$STACK_VERSION_PREFIX exampleservice $(getScriptStackVersion exampleservice)

services:
  exampleservice-db:
    image: $(getScriptImageByContainerName exampleservice-db)
    container_name: exampleservice-db
    hostname: exampleservice-db
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    command: mysqld --innodb-buffer-pool-size=128M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_bin --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    networks:
      - int-exampleservice-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - v-exampleservice-db:/var/lib/mysql
      - \${HSHQ_SCRIPTS_DIR}/user/exportMySQL.sh:/exportDB.sh:ro
      - \${HSHQ_STACKS_DIR}/exampleservice/dbexport:/dbexport
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.exampleservice-hourly-db.schedule=@every 1h"
      - "ofelia.job-exec.exampleservice-hourly-db.command=/exportDB.sh"
      - "ofelia.job-exec.exampleservice-hourly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.exampleservice-hourly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.exampleservice-hourly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.exampleservice-hourly-db.email-from=ExampleService Hourly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.exampleservice-hourly-db.mail-only-on-error=true"
      - "ofelia.job-exec.exampleservice-monthly-db.schedule=0 0 8 1 * *"
      - "ofelia.job-exec.exampleservice-monthly-db.command=/exportDB.sh"
      - "ofelia.job-exec.exampleservice-monthly-db.smtp-host=$SMTP_HOSTNAME"
      - "ofelia.job-exec.exampleservice-monthly-db.smtp-port=$SMTP_HOSTPORT"
      - "ofelia.job-exec.exampleservice-monthly-db.email-to=$EMAIL_ADMIN_EMAIL_ADDRESS"
      - "ofelia.job-exec.exampleservice-monthly-db.email-from=ExampleService Monthly DB Export <$EMAIL_ADMIN_EMAIL_ADDRESS>"
      - "ofelia.job-exec.exampleservice-monthly-db.mail-only-on-error=false"

  exampleservice-app:
    image: $(getScriptImageByContainerName exampleservice-app)
    container_name: exampleservice-app
    hostname: exampleservice-app
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    depends_on:
      - exampleservice-db
    networks:
      - int-exampleservice-net
      - dock-ext-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - v-exampleservice-web:/var/www/html:z

volumes:
  v-exampleservice-db:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/exampleservice/db
  v-exampleservice-web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/exampleservice/web

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
  int-exampleservice-net:
    driver: bridge
    internal: true
    ipam:
      driver: default

EOFMT

  cat <<EOFMT > $HOME/exampleservice.env
TZ=\${TZ}

EOFMT

}

function performUpdateExampleService()
{
  perform_stack_name=exampleservice
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=exampleimage
      image_update_map[0]="exampleimage,exampleimage"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Ofelia
function installOfelia()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory ofelia "Ofelia"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Ofelia directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName ofelia)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Ofelia docker image"
    exit 1
  fi
  set -e
  mkdir $HSHQ_STACKS_DIR/ofelia
  outputConfigOfelia
  installStack ofelia ofelia "" $HOME/ofelia.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Ofelia"
    exit $retval
  fi
}

function outputConfigOfelia()
{
  cat <<EOFOF > $HOME/ofelia-compose.yml
$STACK_VERSION_PREFIX ofelia $(getScriptStackVersion ofelia)

services:
  ofelia:
    image: $(getScriptImageByContainerName ofelia)
    container_name: ofelia
    hostname: ofelia
    restart: unless-stopped
    command: daemon --docker
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-internalmail-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
    labels:
      - "ofelia.job-local.my-test-job.schedule=@every 5m"
      - "ofelia.job-local.my-test-job.command=date"

networks:
  dock-internalmail-net:
    name: dock-internalmail
    external: true
EOFOF

  cat <<EOFRM > $HOME/ofelia.env
TZ=\${TZ}
EOFRM

}

function performUpdateOfelia()
{
  perform_stack_name=ofelia
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=mcuadros/ofelia:v0.3.7
      image_update_map[0]="mcuadros/ofelia:v0.3.7,mcuadros/ofelia:0.3.16"
    ;;
    2)
      newVer=v5
      curImageList=mcuadros/ofelia:v0.3.9
      image_update_map[0]="mcuadros/ofelia:v0.3.9,mcuadros/ofelia:0.3.16"
    ;;
    3)
      newVer=v5
      curImageList=mcuadros/ofelia:0.3.10
      image_update_map[0]="mcuadros/ofelia:0.3.10,mcuadros/ofelia:0.3.16"
    ;;
    4)
      newVer=v5
      curImageList=mcuadros/ofelia:0.3.13
      image_update_map[0]="mcuadros/ofelia:0.3.13,mcuadros/ofelia:0.3.16"
    ;;
    5)
      newVer=v5
      curImageList=mcuadros/ofelia:0.3.16
      image_update_map[0]="mcuadros/ofelia:0.3.16,mcuadros/ofelia:0.3.16"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# Script-server
function installScriptServer()
{
  if [ -d $HSHQ_STACKS_DIR/script-server ]; then
    return
  fi
  set +e
  retVal=0
  if ! [ -f $HOME/script-server.zip ]; then
    wget -q4 -O $HOME/script-server.zip https://github.com/bugy/script-server/releases/download/1.18.0/script-server.zip
    retVal=$?
  fi
  if [ $retVal -ne 0 ] || ! [ -f $HOME/script-server.zip ]; then
    echo "ERROR: Could not obtain Script-server zip file"
    exit 1
  fi
  mkdir $HSHQ_STACKS_DIR/script-server
  unzip $HOME/script-server.zip -d $HSHQ_STACKS_DIR/script-server > /dev/null 2>&1
  retVal=$?
  if [ $retVal -ne 0 ]; then
    sudo rm -fr $HSHQ_STACKS_DIR/script-server
    echo "ERROR: There was a problem extracting the Script-server zip file"
    exit 1
  fi
  set -e
  rm $HOME/script-server.zip
  sudo chown -R $USERNAME:$USERNAME $HSHQ_STACKS_DIR/script-server
  mkdir -p $HSHQ_STACKS_DIR/script-server/conf/scripts
  mkdir -p $HSHQ_STACKS_DIR/script-server/conf/theme
  echo "Installing python3-tornado..."
  performAptInstall python3-tornado > /dev/null 2>&1
  initServicesCredentials
  generateCert script-server "script-server,host.docker.internal,localhost" "127.0.0.1,$HOMESERVER_HOST_PRIMARY_INTERFACE_IP"
  outputConfigScriptServer
  htpasswd -bcBC 10 $HSHQ_STACKS_DIR/script-server/users $SCRIPTSERVER_ADMIN_USERNAME $SCRIPTSERVER_ADMIN_PASSWORD > /dev/null 2>&1
  cp $HSHQ_ASSETS_DIR/images/script-server.ico $HSHQ_STACKS_DIR/script-server/web/favicon.ico
  cp $HSHQ_ASSETS_DIR/images/script-server_header.jpg $HSHQ_STACKS_DIR/script-server/conf/theme/
  cp $HSHQ_ASSETS_DIR/images/script-server_login.jpg $HSHQ_STACKS_DIR/script-server/conf/theme/
  cp $HSHQ_ASSETS_DIR/images/HSHQ-ApplyJoin.png $HSHQ_STACKS_DIR/script-server/web/img/
  cp $HSHQ_ASSETS_DIR/images/HSHQ-Invite.png $HSHQ_STACKS_DIR/script-server/web/img/
  set +e
  grep "base target" $HSHQ_STACKS_DIR/script-server/web/index.html > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    sed -i "s|<\/title>|<\/title><base target=\"_blank\">|" $HSHQ_STACKS_DIR/script-server/web/index.html
  fi
  set -e
  sudo chmod 644 $HSHQ_SCRIPTS_DIR/root/runScriptServer.service
  sudo chown root:root $HSHQ_SCRIPTS_DIR/root/runScriptServer.service
  sudo rm -f /etc/systemd/system/runScriptServer.service
  sudo ln -s $HSHQ_SCRIPTS_DIR/root/runScriptServer.service /etc/systemd/system/runScriptServer.service
  inner_block=""
  inner_block=$inner_block">>https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://host.docker.internal:$SCRIPTSERVER_LOCALHOST_PORT {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SCRIPTSERVER $MANAGETLS_SCRIPTSERVER "$is_integrate_hshq" $NETDEFAULT_SCRIPTSERVER "$inner_block"
  insertSubAuthelia $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN ${LDAP_ADMIN_USER_GROUP_NAME}
  insertEnableSvcAll script-server "$FMLNAME_SCRIPTSERVER" $USERTYPE_SCRIPTSERVER "https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN" "script-server.png" "$(getHeimdallOrderFromSub $SUB_SCRIPTSERVER $USERTYPE_SCRIPTSERVER)"
  insertEnableSvcHeimdall script-server "$FMLNAME_SCRIPTSERVER (IP)" $USERTYPE_SCRIPTSERVER "https://$HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$SCRIPTSERVER_LOCALHOST_PORT" "script-server.png" true "$(getHeimdallOrderFromSub $SUB_SCRIPTSERVER $USERTYPE_SCRIPTSERVER)"
  restartAllCaddyContainers
  sudo systemctl daemon-reload
  sudo systemctl enable runScriptServer
  sudo systemctl start runScriptServer
  sleep 3
  fullResetScriptServer true
  if ! [ "$SCRIPTSERVER_INIT_ENV" = "true" ]; then
    sendEmail -s "Script-server Login Info" -b "Script-server Username: $SCRIPTSERVER_ADMIN_USERNAME\nScript-server Password: $SCRIPTSERVER_ADMIN_PASSWORD\n" -f "$(getAdminEmailName) <$EMAIL_SMTP_EMAIL_ADDRESS>"
    SCRIPTSERVER_INIT_ENV=true
    updateConfigVar SCRIPTSERVER_INIT_ENV $SCRIPTSERVER_INIT_ENV
  fi
}

function outputConfigScriptServer()
{
  sudo tee $HSHQ_SCRIPTS_DIR/root/runScriptServer.service >/dev/null <<EOFHS
[Unit]
Description=Script-server
After=network.target
StartLimitIntervalSec=0

[Service]
Type=simple
Restart=always
RestartSec=1
ExecStart=/usr/bin/python3 $HSHQ_STACKS_DIR/script-server/launcher.py
User=$USERNAME

[Install]
WantedBy=multi-user.target
EOFHS
  outputScriptServerConfigFile
  outputScriptServerTheme
  outputAllScriptServerScripts true true
  outputStackListsScriptServer
}

function outputScriptServerConfigFile()
{
  rm -f $HSHQ_STACKS_DIR/script-server/conf/conf.json
  cat <<EOFHS > $HSHQ_STACKS_DIR/script-server/conf/conf.json
{
  "port": $SCRIPTSERVER_LOCALHOST_PORT,
  "address": "0.0.0.0",
  "title": "Script-server",
  "ssl": {
    "key_path": "$HSHQ_SSL_DIR/script-server.key",
    "cert_path": "$HSHQ_SSL_DIR/script-server.crt"
  },
  "auth": {
    "type": "htpasswd",
    "htpasswd_path": "$HSHQ_STACKS_DIR/script-server/users"
  },
  "access": {
	"allowed_users": [ "$SCRIPTSERVER_ADMIN_USERNAME" ],
	"admin_users": [ "$SCRIPTSERVER_ADMIN_USERNAME" ]
  },
  "alerts": {
    "destinations": [
      {
        "type": "email",
        "from": "Script-server $(getAdminEmailName)<$EMAIL_SMTP_EMAIL_ADDRESS>",
        "to": "$EMAIL_ADMIN_EMAIL_ADDRESS",
        "server": "$SUB_POSTFIX.$HOMESERVER_DOMAIN:$MAILU_PORT_5",
        "auth_enabled": true,
        "login": "$EMAIL_SMTP_EMAIL_ADDRESS",
        "password": "$EMAIL_SMTP_PASSWORD",
        "tls": true,
        "url": "https://$SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN/test_alerts"
      }
    ]
  }
}
EOFHS
}

function outputScriptServerTheme()
{
  getUpdateAssets
  rm -f $HSHQ_STACKS_DIR/script-server/web/img/HSHQ-ApplyJoin.png
  rm -f $HSHQ_STACKS_DIR/script-server/web/img/HSHQ-Invite.png
  cp $HSHQ_ASSETS_DIR/images/HSHQ-ApplyJoin.png $HSHQ_STACKS_DIR/script-server/web/img/
  cp $HSHQ_ASSETS_DIR/images/HSHQ-Invite.png $HSHQ_STACKS_DIR/script-server/web/img/
  rm -f $HSHQ_STACKS_DIR/script-server/conf/theme/theme.css
  cat <<EOFHS > $HSHQ_STACKS_DIR/script-server/conf/theme/theme.css
html:root {

    --primary-color-dark-color: #22262A;
    --surface-color: #22262A;
    --background-color: #22262A;

    --hover-color: rgba(255, 255, 255, 0.04);
    --focus-color: rgba(255, 255, 255, 0.12);
    --focus-color-solid: #424242;
    --font-color-main: rgba(255, 255, 255, 1);
    --font-color-medium: rgba(255, 255, 172, 1);
    --font-color-disabled: rgba(255, 255, 255, 0.5);
    --primary-color: #FFFFAC;
    --primary-color-raised-hover-solid: #FFFFAC;
    --primary-color-raised-focus-solid: #FFFFAC;
    --primary-color-when-focused: rgba(0, 0, 0, 0.12);
    --primary-color-when-hovered: rgba(0, 0, 0, 0.04);
    --font-on-primary-color-main: rgba(0, 0, 0, 1);
    --font-on-primary-color-medium: rgba(0, 0, 0, 1);
    --primary-color-dark-when-focused: rgba(0, 0, 0, 0.12);
    --primary-color-dark-when-hovered: rgba(0, 0, 0, 0.04);
    --font-on-primary-color-dark-main: rgba(255, 255, 255, 1);
    --font-on-primary-color-dark-medium: rgba(255, 255, 172, 1);
    --primary-color-light-color: #FFFFAC;
    --background-color-slight-emphasis: rgba(255, 255, 255, 0.05);
    --background-color-high-emphasis: rgba(255, 255, 255, 0.09);
    --background-color-level-4dp: rgba(255, 255, 255, 0.09);
    --background-color-level-8dp: rgba(255, 255, 255, 0.12);
    --background-color-level-16dp: rgba(255, 255, 255, 0.15);
    --background-color-disabled: rgba(255, 255, 255, 0.12);
    --script-header-background: url('../theme/script-server_header.jpg') center / cover no-repeat;
    --login-header-background: url('../theme/script-server_login.jpg') center / cover no-repeat;
    --separator-color: #424242;
    --outline-color: rgba(255, 255, 255, 0.18);
}

.script-parameters-panel .parameter textarea {
    max-height: 10em !important;
    overflow: auto !important;
}

.readonly-field.long {
    max-height: 20em !important;
    width: 100% !important;
    overflow: auto !important;
}

.log-panel {
    min-height: 20em !important;
    overflow: auto !important;
    background: #000000 !important;
}

#login-panel {
    background-color: #000000 !important;
}

#login-body {
    background: #000000 !important;
}

.content-panel a {
    color: #00A8FF !important;
}

EOFHS
}

function performUpdateScriptServer()
{
  return
}

function clearAllScriptServerScripts()
{
  rm -fr $HSHQ_STACKS_DIR/script-server/conf/scripts/*
  rm -fr $HSHQ_STACKS_DIR/script-server/conf/runners/*
  rm -fr $HSHQ_STACKS_DIR/script-server/conf/deleted/*
}

function fullResetScriptServer()
{
  isReplaceSSScripts="$1"
  clearAllScriptServerScripts
  rm -f $HSHQ_STACKS_DIR/script-server/logs/processes/*
  rm -fr $HSHQ_STACKS_DIR/script-server/temp/uploadFiles/*
  outputAllScriptServerScripts "$isReplaceSSScripts" true
}

function outputAllScriptServerScripts()
{
  isReplaceSSScripts="$1"
  isReplaceUpdateScript="$2"
  sudo_stdin_prompt="Checking sudo password..."
  config_stdin_prompt="Checking config decrypt password..."
  relaysudo_stdin_prompt="Getting RelayServer password..."
  rs_cur_password_prompt="Getting current RS password..."
  rs_new_password_prompt="Getting new RS password..."
  password_regex="^[a-zA-Z0-9(~!@#%^&*_+=<>?.,)-]+$"
  password_max_len=64
  password_special_chars="(~!@#%^&*_+=<>?.,)-"
  password_text_description="Must be letters, numbers, and/or (~!@#%^&*_+=<>?.,)-"
  email_regex="^[a-zA-Z0-9._+-]+@[a-zA-Z0-9._+-]+\\\\.[a-zA-Z]{2,}$"
  email_max_len=128
  email_text_description="Must be a valid email addresss"
  long_reason_regex="^[A-Za-z0-9 ;:@()?!'_,.-]+$"
  long_reason_max_len=512
  long_reason_text_description="Only letters, numbers, and basic punctuation."
  if [ -z "$isReplaceSSScripts" ]; then
    isReplaceSSScripts=true
  fi
  if [ -z "$isReplaceUpdateScript" ]; then
    isReplaceUpdateScript=true
  fi
  group_id_misc="01 Misc Utils"
  group_id_services="02 Services"
  group_id_scriptserver="03 Script-server Utils"
  group_id_systemutils="04 System Utils"
  group_id_testing="05 Testing"
  group_id_mynetwork="06 My Network"
  group_id_othernetworks="07 Other Networks"
  group_id_relayserver="08 RelayServer Utils"
  group_id_homenetwork="09 Home Network"

  # Util scripts
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
#!/bin/bash

function getArgumentValue()
{
  arg_name="\$1"
  arg_string="\$@"
  shift
  while [[ \$# -gt 0 ]]
  do
    if [[ "\$1" =~ ^-\${arg_name}= ]]; then
      echo "\$1" | sed 's/^[^=]*=//' | sed 's/ *\$//g'
    fi
    shift
  done
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkConfirm.sh
#!/bin/bash

if ! [ "\$1" = "confirm" ]; then
  echo "ERROR: Confirmation was not entered correctly."
  exit
fi

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
#!/bin/bash

# Reading from stdin is better than parameters or environment variables,
# since they can easily be seen in plaintext by running 'ps auxwwe'
# However, using stdin redirection introduces a bit of a timing issue
# between processes. The code below addresses this in the best possible
# way, but some more analysis should be done to ensure that this cannot
# be exploited.

function main()
{
  read -r -s -p "$sudo_stdin_prompt" USER_SUDO_PW
  if [ -z "\$USER_SUDO_PW" ]; then
    read -r -t 5 -s -p "" USER_SUDO_PW
  fi
  if [ -z "\$USER_SUDO_PW" ]; then
    USER_SUDO_PW=""
    cat <<< "ERROR: Password is incorrect." 1>&2
    exit 1
  fi
  echo "\$USER_SUDO_PW" | sudo -S -v -p "" > /dev/null 2>&1
  if [ \$? -ne 0 ]; then
    echo "bad"
    USER_SUDO_PW=""
    cat <<< "ERROR: Password is incorrect." 1>&2
    exit 1
  else
    echo "good"
  fi
}

main
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
#!/bin/bash

# See note in checkPass.sh

function main()
{
  source $HSHQ_LIB_SCRIPT lib
  read -r -s -p "$config_stdin_prompt" USER_CONFIG_PW
  if [ -z "\$USER_CONFIG_PW" ]; then
    read -r -t 5 -s -p "" USER_CONFIG_PW
  fi
  if [ -z "\$USER_CONFIG_PW" ]; then
    USER_CONFIG_PW=""
    cat <<< "ERROR: Incorrect password for encrypted configuration file." 1>&2
    exit 3
  fi
  checkDecryptConfigFile
  if [ \$? -ne 0 ]; then
    exit 4
  fi
}

main
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkRelayPass.sh
#!/bin/bash

function main()
{
  read -r -s -p "$relaysudo_stdin_prompt" relaysudopw
  if [ -z "\$relaysudopw" ]; then
    read -r -t 5 -s -p "" relaysudopw
  fi
  if [ -z "\$relaysudopw" ]; then
    relaysudopw=""
    cat <<< "ERROR: RelayServer password was not captured." 1>&2
    exit 1
  fi
  USER_RELAY_SUDO_PW="\$relaysudopw"
  echo "good"
}

main
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
#!/bin/bash

checkRes=\$(checkIsLockEnabled hshqopen SS-Test)
if ! [ -z "\$checkRes" ]; then
  echo "ERROR: The HSHQ script is already open or running in a different instance (\$checkRes). This situation could occur if another scheduled process is currently running or the script exited prematurely with an error. If you are sure that this has occurred erroneously, then run the 04 System Utils -> 06 Reset Mutex Lock function to reset it."
  exit 8
fi

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/generateRandomIP.sh
#!/bin/bash

echo 10.\$(( \$RANDOM % 256 )).\$(( \$RANDOM % 256 )).\$((\$((\$RANDOM%250))+1))

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/generateRandomSubnet.sh
#!/bin/bash

echo 10.\$(( \$RANDOM % 256 )).\$(( \$RANDOM % 256 )).0

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getExposedPortsVariablesLists.sh
#!/bin/bash
set +e

chainName="\$1"

OLDIFS=\$IFS
IFS=\$(echo -en "\n\b")
expList=(\$(sqlite3 $HSHQ_DB "select InterfaceName,' (',Name,')' from connections where (ConnectionType='homeserver_vpn' and NetworkType in ('primary','other')) or (NetworkType='home_network') order by NetworkType;" | sed 's/|//g'))
IFS=\$OLDIFS

tmpList=(\$(sqlite3 $HSHQ_DB "select ID from customfwsubnet;"))
for curID in "\${tmpList[@]}"
do
  curName=\$(sqlite3 $HSHQ_DB "select Name from customfwsubnet where ID=\$curID;")
  curSubnet=\$(sqlite3 $HSHQ_DB "select Subnet from customfwsubnet where ID=\$curID;")
  expList+=( "\$curID (Custom) \$curName [\$curSubnet]" )
done

if [ "\$chainName" = "INPUT" ]; then
  expList+=( "INPUT_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT" )
  expList+=( "INPUT_PRIMARY_VPN_ALLOW_PORTS_DEFAULT" )
  expList+=( "INPUT_OTHER_VPN_ALLOW_PORTS_DEFAULT" )
elif [ "\$chainName" = "DOCKER-USER" ]; then
  expList+=( "DOCKERUSER_HOMESERVER_HOST_ALLOW_PORTS_DEFAULT" )
  expList+=( "DOCKERUSER_PRIMARY_VPN_ALLOW_PORTS_DEFAULT" )
  expList+=( "DOCKERUSER_OTHER_VPN_ALLOW_PORTS_DEFAULT" )
fi

for curList in "\${expList[@]}"
do
  echo "\$curList"
done

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getExposedPortsByVariableName.sh
#!/bin/bash

chainName="\$1"
varName="\$2"

checkCustom=\$(echo "\$varName" | cut -d" " -f2)

if [ "\${varName: -8}" = "_DEFAULT" ]; then
  echo \$(grep ^\$varName= $HSHQ_PLAINTEXT_USER_CONFIG | sed 's/^[^=]*=//' | sed 's/ *\$//g' | sed 's/"//g')
elif [ "\${checkCustom}" = "(Custom)" ]; then
  intID=\$(echo "\$varName" | cut -d" " -f1 | xargs)
  if [ "\$chainName" = "INPUT" ]; then
    sqlite3 $HSHQ_DB "select InputAllowPorts from customfwsubnet where ID=\$intID;"
  elif [ "\$chainName" = "DOCKER-USER" ]; then
    sqlite3 $HSHQ_DB "select DockerUserAllowPorts from customfwsubnet where ID=\$intID;"
  fi
else
  intName=\$(echo "\$varName" | cut -d" " -f1 | xargs)
  if [ "\$chainName" = "INPUT" ]; then
    sqlite3 $HSHQ_DB "select InputAllowPorts from connections where InterfaceName='\$intName';"
  elif [ "\$chainName" = "DOCKER-USER" ]; then
    sqlite3 $HSHQ_DB "select DockerUserAllowPorts from connections where InterfaceName='\$intName';"
  fi
fi

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getInterfaceIP.sh
#!/bin/bash

interfaceName="\$1"
interfaceName=\$(echo "\$interfaceName" | cut -d" " -f1 | xargs)
source $HSHQ_LIB_SCRIPT lib
getIPAddressOfInterface \$interfaceName

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getInterfaceCIDRLength.sh
#!/bin/bash

interfaceName="\$1"
interfaceName=\$(echo "\$interfaceName" | cut -d" " -f1 | xargs)
source $HSHQ_LIB_SCRIPT lib
getCIDRLengthOfInterface \$interfaceName

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getInterfaceGateway.sh
#!/bin/bash

interfaceName="\$1"
interfaceName=\$(echo "\$interfaceName" | cut -d" " -f1 | xargs)
source $HSHQ_LIB_SCRIPT lib
getGatewayOfInterface \$interfaceName

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/getWGInternetTrafficInterfaces.sh
#!/bin/bash
set +e

echo "default"
for conf in $HSHQ_WIREGUARD_DIR/internet/*.conf
do
  if ! test -f "\$conf"; then continue; fi
  echo \$(basename \${conf%.*})
done
EOFSC

  # 01 Misc Utils
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restartAuthelia.sh
#!/bin/bash

docker container restart authelia > /dev/null 2>&1
echo "Authelia successfully restarted."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restartAuthelia.json
{
  "name": "01 Restart Authelia",
  "script_path": "conf/scripts/restartAuthelia.sh",
  "description": "Restarts Authelia container. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This is typically useful after updates have been applied to the configuration.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": []
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restartCaddyContainer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
caddyinstance=\$(getArgumentValue caddyinstance "\$@")
docker container restart "\$caddyinstance"

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restartCaddyContainer.json
{
  "name": "02 Restart Caddy Container",
  "script_path": "conf/scripts/restartCaddyContainer.sh",
  "description": "Restarts a specific Caddy container. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Caddy Instances",
      "required": true,
      "param": "-caddyinstance=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "docker ps -a --filter name=caddy- --format \"{{.Names}}\"",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restartAllCaddyContainers.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
confirm=\$(getArgumentValue confirm "\$@")
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkConfirm.sh "\$confirm"
source $HSHQ_LIB_SCRIPT lib
restartAllCaddyContainers
echo "Caddy containers successfully restarted."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restartAllCaddyContainers.json
{
  "name": "03 Restart All Caddy Containers",
  "script_path": "conf/scripts/restartAllCaddyContainers.sh",
  "description": "Restarts all Caddy containers. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Enter confirm in the box below.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter 'confirm' to continue.",
      "required": true,
      "param": "-confirm=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "7",
      "regex": {
        "pattern": "^confirm\$",
        "description": "Must be the word confirm"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restartPortainerStack.sh
#!/bin/bash

source $HSHQ_LIB_SCRIPT lib
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
restartPortainer
echo "Portainer successfully restarted."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restartPortainerStack.json
{
  "name": "04 Restart Portainer",
  "script_path": "conf/scripts/restartPortainerStack.sh",
  "description": "Restarts Portainer stack. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function restarts the Portainer stack.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": []
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/generateSignedCertificate.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

certs_filename=\$(getArgumentValue filename "\$@")
certs_domains=\$(getArgumentValue domains "\$@")
certs_ipaddresses=\$(getArgumentValue ipaddresses "\$@")
certs_startdate=\$(getArgumentValue startdate "\$@")
certs_enddate=\$(getArgumentValue enddate "\$@")

set +e
generateCert "\$certs_filename" "\$certs_domains" "\$certs_ipaddresses" "\$certs_startdate" "\$certs_enddate"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/generateSignedCertificate.json
{
  "name": "05 Generate Signed Certificate",
  "script_path": "conf/scripts/generateSignedCertificate.sh",
  "description": "Generates a certificate signed by the Root CA. [Need Help?](https://forum.homeserverhq.com/)<br/>\n- The resulting key/certificate pair will be stored in $HSHQ_SSL_DIR.\n- Multiple domain names and/or IP addresses should be a comma-separated list (no spaces).\n- Dates should be formatted as '2023-01-01 00:00:00 GMT'.\n- Leave start date empty to default to current date/time.\n- If end date is empty, then the certificate will expire $CERTS_INTERNAL_CA_DAYS days after the start date.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the filename",
      "required": true,
      "param": "-filename=",
      "same_arg_param": true,
      "type": "text",
      "secure": false,
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]+\$",
        "description": "Only lowercase letters, numbers, and/or hyphens"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    },
    {
      "name": "Enter domain names",
      "required": true,
      "param": "-domains=",
      "same_arg_param": true,
      "type": "text",
      "secure": false,
      "max_length": "512",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9.-]*(,[a-z0-9][a-z0-9.-]*)*\$",
        "description": "Comma-separated - only lowercase, numbers, hyphens, periods"
      },
      "ui": {
        "width_weight": 2
      },
      "pass_as": "argument"
    },
    {
      "name": "Enter IP addresses",
      "required": false,
      "param": "-ipaddresses=",
      "same_arg_param": true,
      "type": "text",
      "secure": false,
      "max_length": "64",
      "regex": {
        "pattern": "^((?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)+(,((?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))*\$",
        "description": "Comma-separated - IP Addresses"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    },
    {
      "name": "Enter start date",
      "required": false,
      "param": "-startdate=",
      "same_arg_param": true,
      "type": "text",
      "secure": false,
      "regex": {
        "pattern": "[1-2][0-9][0-9][0-9]-[0-2][0-9]-[0-2][0-9] [0-2][0-9]\\\\:[0-2][0-9]\\\\:[0-2][0-9] [A-Z]{3,5}",
        "description": "Date format (see instructions)"
      },
      "ui": {
        "width_weight": 2
      },
      "pass_as": "argument"
    },
    {
      "name": "Enter end date",
      "required": false,
      "param": "-enddate=",
      "same_arg_param": true,
      "type": "text",
      "secure": false,
      "regex": {
        "pattern": "[1-2][0-9][0-9][0-9]-[0-2][0-9]-[0-2][0-9] [0-2][0-9]\\\\:[0-2][0-9]\\\\:[0-2][0-9] [A-Z]{3,5}",
        "description": "Date format (see instructions)"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/resetCaddyData.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

caddyinstance=\$(getArgumentValue caddyinstance "\$@")

set +e
echo "Clearing out data for \$caddyinstance"
sudo $HSHQ_SCRIPTS_DIR/userasroot/resetCaddyContainer.sh \$caddyinstance
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/resetCaddyData.json
{
  "name": "06 Reset Caddy Data",
  "script_path": "conf/scripts/resetCaddyData.sh",
  "description": "Clears out all data for the selected Caddy instance and restarts the stack. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This should only be used as a last resort if you encountering continual issues that do not resolve after restarting the stack.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Caddy Instance",
      "required": true,
      "param": "-caddyinstance=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "docker ps -a --filter name=caddy- --format \"{{.Names}}\"",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restartAllStacks.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Restarting all stacks..."
restartAllStacks
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restartAllStacks.json
{
  "name": "07 Restart All Stacks",
  "script_path": "conf/scripts/restartAllStacks.sh",
  "description": "Restarts all stacks. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>1. Stops all Docker stacks.\n2. Removes all Docker networks.\n3. Restarts the Docker daemon.\n4. Recreates all Docker networks.\n5. Starts all stacks that were stopped.<br/>\nThis function is useful to do a full fresh reboot of all services. You should rarely if ever need to do this, but there are certain situations where it might be needed. The most prevalent case is when you run an update on the host system and docker is updated to a new version. The docker daemon is restarted as a result, but sometimes not everything comes back up correctly. Depending on the number of stacks, this could take 10-15 minutes to complete. You will also lose access to this web app during the process, but it will continue to run in the background, so be patient (unless you are accessing this utility via IP on your home network, which is preferred). If you stop the process midway through, then you will have to manually fix any issues from the state that everything is in.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailCredentialsVaultwarden.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing login credentials in Vaultwarden format..."
emailVaultwardenCredentials false
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailCredentialsVaultwarden.json
{
  "name": "08 Email Vaultwarden Credentials",
  "script_path": "conf/scripts/emailCredentialsVaultwarden.sh",
  "description": "Emails Vaultwarden credentials. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails all login credentials, in a format that can easily be imported into Vaultwarden, to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailRootCA.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing Root CA..."
sendRootCAEmail
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailRootCA.json
{
  "name": "09 Email Root CA",
  "script_path": "conf/scripts/emailRootCA.sh",
  "description": "Emails Root CA. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails the Root Certificate Authority (CA) certificate to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailUserVaultwardenTemplate.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

username=\$(getArgumentValue username "\$@")
emailaddr=\$(getArgumentValue emailaddr "\$@")

set +e
echo "Emailing Vaultwarden import template to user..."
emailUserVaultwardenCredentials "\$username" "\$emailaddr"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailUserVaultwardenTemplate.json
{
  "name": "10 Email User VW Template",
  "script_path": "conf/scripts/emailUserVaultwardenTemplate.sh",
  "description": "Emails Vaultwarden template to user. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function emails a Vaultwarden import template to the provided user at the provided email address. The template keeps all of the LDAP-based services together as a single entry within the Vaultwarden password manager. The default password is simply 'abcdefg', but the user only needs to change this one entry to their correct password. If they change their LDAP password in the future, then they need only change this one entry within Vaultwarden. The is simply a suggested convenience method for your users.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter LDAP username",
      "required": true,
      "param": "-username=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]*\$",
        "description": "Only lowercase letters, numbers, and/or hyphens"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-emailaddr=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailCredentialsFormatted.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing login credentials for all services..."
emailFormattedCredentials
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailCredentialsFormatted.json
{
  "name": "11 Email All Credentials",
  "script_path": "conf/scripts/emailCredentialsFormatted.sh",
  "description": "Emails all login credentials. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails all login credentials, in a human-readable format, to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_misc",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  # 02 Services
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/installServicesFromList.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

services=\$(getArgumentValue services "\$@")

set +e
installListOfServices "\$services"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/installServicesFromList.json
{
  "name": "01 Install Service(s)",
  "script_path": "conf/scripts/installServicesFromList.sh",
  "description": "Select the service(s) that you wish to install. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Note that after each service is installed, the reverse proxy (Caddy) will be restarted. The reverse proxy also serves <ins>this Script-server webpage</ins> (if you are accessing it via $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN rather than via IP address), so the console output will desync when this occurs. The process will continue to run in the background albeit this issue, so be patient and allow the process to complete. You can also refresh this webpage to resync the output. If you are accessing it via IP, then you will not experience any desync. The full log of the installation process can be viewed in the HISTORY section (bottom left corner).<br/><br/>More details on all services can be found on the [HomeServerHQ Wiki](https://wiki.homeserverhq.com/en/foss-projects)<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "List of Services To Install",
      "required": true,
      "param": "-services=",
      "same_arg_param": true,
      "type": "multiselect",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "while read filename; do if ! [ -d ~/hshq/data/stacks/\$filename ]; then echo \"\$filename\"; fi; done < conf/$SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/installAllAvailableServices.sh
#!/bin/bash

#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
installAllAvailableStacks false
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/installAllAvailableServices.json
{
  "name": "02 Install All Available Services",
  "script_path": "conf/scripts/installAllAvailableServices.sh",
  "description": "Installs nearly all available services. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This is an opinionated list of well known FOSS projects that a typical environment might have. The selections are also based on the amount of available system RAM. Services can also be installed via 02 Services -> 01 Install Service(s).<br/><br/>Note that after each service is installed, the reverse proxy (Caddy) will be restarted. The reverse proxy also serves <ins>this Script-server webpage</ins> (if you are accessing it via $SUB_SCRIPTSERVER.$HOMESERVER_DOMAIN rather than via IP address), so the console output will desync when this occurs. The process will continue to run in the background albeit this issue, so be patient and allow the process to complete. You can also refresh this webpage to resync the output. If you are accessing it via IP, then you will not experience any desync. The full log of the installation process can be viewed in the HISTORY section (bottom left corner). <br/><br/>If you are running this on a fresh installation, there are a lot of services that will be installed, it will take about 45 mins to an hour to complete. If for some reason the installation process halts abnormally, then attempt to determine which service via the most recent log entries. Then, reset the HSHQ open status (04 System Utils -> Reset Mutex Lock). <ins>***ENSURE***</ins> that this script is not still running before resetting this value, i.e. check the Status in the HISTORY section to ensure nothing is running. Then rerun this utility to install the remainder of services. After everything else has installed, remove the service that failed (02 Services -> 05 Remove Service(s)), and attempt to reinstall it. If it continues to fail to install, then report the issue [here on Github](https://github.com/homeserverhq/hshq/issues). <br/><br/>More details on all services can be found on the [HomeServerHQ Wiki](https://wiki.homeserverhq.com/en/foss-projects)<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/updateServicesFromList.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkRelayPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
TMP_USER_RELAY_SUDO_PW="\$USER_RELAY_SUDO_PW"
decryptConfigFileAndLoadEnvNoPrompts
USER_RELAY_SUDO_PW="\$TMP_USER_RELAY_SUDO_PW"
services=\$(getArgumentValue services "\$@")
set +e
updateListOfStacks "\$services"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/updateServicesFromList.json
{
  "name": "03 Update Service(s)",
  "script_path": "conf/scripts/updateServicesFromList.sh",
  "description": "Select the service(s) that you wish to update. [Need Help?](https://forum.homeserverhq.com/)<br/><br/><ins>***ENSURE***</ins> your have good and recent backups for any services that you plan to update. Best possible efforts have been made to ensure smooth and reliable upgrades will be applied. However, <ins>***nothing***</ins> is guaranteed. In the event that an upgrade results in an unresponse service, just ask for help on the [Forum](https://forum.homeserverhq.com/) and we'll help get you back to a working state.<br/><br/>The RelayServer password is only applicable if you are hosting a VPN. However, the password will not be checked for validity unless it is needed, which currently is only by Wazuh if updating the agent on the RelayServer. If you do not provide the correct password, then you will be prompted again during the upgrade process.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter RelayServer sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "default": "pass",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$relaysudo_stdin_prompt"
    },
    {
      "name": "List of Services To Update",
      "required": true,
      "param": "-services=",
      "same_arg_param": true,
      "type": "multiselect",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "cat conf/$SCRIPTSERVER_UPDATE_STACKLIST_FILENAME",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/updateAllAvailableServices.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkRelayPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
TMP_USER_RELAY_SUDO_PW="\$USER_RELAY_SUDO_PW"
decryptConfigFileAndLoadEnvNoPrompts
USER_RELAY_SUDO_PW="\$TMP_USER_RELAY_SUDO_PW"
set +e
performAllAvailableStackUpdates false
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/updateAllAvailableServices.json
{
  "name": "04 Update All Available Services",
  "script_path": "conf/scripts/updateAllAvailableServices.sh",
  "description": "Updates all available services that have an update available. [Need Help?](https://forum.homeserverhq.com/)<br/><br/><ins>***ENSURE***</ins> your have good and recent backups for any services that will be updated. Best possible efforts have been made to ensure smooth and reliable upgrades will be applied. However, <ins>***nothing***</ins> is guaranteed. In the event that an upgrade results in an unresponse service, just ask for help on the [Forum](https://forum.homeserverhq.com/) and we'll help get you back to a working state.<br/><br/>The RelayServer password is only applicable if you are hosting a VPN. However, the password will not be checked for validity unless it is needed, which currently is only by Wazuh if updating the agent on the RelayServer. If you do not provide the correct password, then you will be prompted again during the upgrade process.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter RelayServer sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "default": "pass",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$relaysudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeServicesFromList.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

services=\$(getArgumentValue services "\$@")

set +e
echo "Removing services: \$services"
deleteListOfStacks true "\$services"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeServicesFromList.json
{
  "name": "05 Remove Service(s)",
  "script_path": "conf/scripts/removeServicesFromList.sh",
  "description": "Select the service(s) that you wish to remove. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>**!!! CAUTION !!!**  This will <ins>***permanently***</ins> remove <ins>***ALL***</ins> data for the selected service(s).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "List of Services To Remove",
      "required": true,
      "param": "-services=",
      "same_arg_param": true,
      "type": "multiselect",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "while read filename; do if [ -d ~/hshq/data/stacks/\$filename ]; then echo \"\$filename\"; fi; done < conf/$SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/refreshServicesLists.sh
#!/bin/bash

#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Refreshing all services lists..."
outputStackListsScriptServer
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/refreshServicesLists.json
{
  "name": "06 Refresh Services Lists",
  "script_path": "conf/scripts/refreshServicesLists.sh",
  "description": "Refreshes all services lists. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will check the state of all available services and refresh the associated lists within this user interface, i.e. Install/Update/Remove. These lists are normally updated automatically. However, in the event of an error or some other unforeseen circumstance, this will perform a manual refresh.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/clearTempRedisData.sh
#!/bin/bash

#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selstack=\$(getArgumentValue selstack "\$@")

set +e
echo "Clearing out temp data for \${selstack}..."
clearRedisTempDataByStackName "\${selstack}"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/clearTempRedisData.json
{
  "name": "07 Clear Service Temp Data",
  "script_path": "conf/scripts/clearTempRedisData.sh",
  "description": "Clear Temp Data For Selected Service. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will stop the selected stack, delete all data from its respective Redis database, then restart the service. The use case for this function is in the event of a sudden power outage or some other unforseen circumstance, the Redis database could become corrupted and render the entire service unusable. The Redis database for each of these services functions as a caching mechanism, and can be safely cleared out if necessary.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_services",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select stack",
      "required": true,
      "param": "-selstack=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "cat conf/$SCRIPTSERVER_REDIS_STACKLIST_FILENAME",
        "shell": true
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  # 03 Script-server Utils
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/clearScriptServerProcessLogs.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
confirm=\$(getArgumentValue confirm "\$@")
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkConfirm.sh "\$confirm"

rm -f $HSHQ_STACKS_DIR/script-server/logs/processes/*
echo "Logs have been cleared."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/clearScriptServerProcessLogs.json
{
  "name": "01 Clear History",
  "script_path": "conf/scripts/clearScriptServerProcessLogs.sh",
  "description": "Clears out all of the process logs (history) in this app. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Enter confirm in the box below.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_scriptserver",
  "parameters": [
    {
      "name": "Enter 'confirm' to continue.",
      "required": true,
      "param": "-confirm=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "7",
      "regex": {
        "pattern": "^confirm\$",
        "description": "Must be the word confirm"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh
#!/bin/bash
{
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
outputAllScriptServerScripts false true
echo "Script-server scripts restored."
set -e
performExitFunctions false

if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts.sh
fi
}
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/restoreScriptServerScripts.json
{
  "name": "02 Restore Scripts",
  "script_path": "conf/scripts/restoreScriptServerScripts.sh",
  "description": "Restores all Script-server scripts. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Does not clear/remove any scripts, but will overwrite those with the same name.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_scriptserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh
#!/bin/bash
{
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
clearAllScriptServerScripts
outputAllScriptServerScripts false true
echo "Script-server scripts cleared and restored."
set -e
performExitFunctions false

if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts.sh
fi
}
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/clearRestoreScriptServerScripts.json
{
  "name": "03 Clear and Restore Scripts",
  "script_path": "conf/scripts/clearRestoreScriptServerScripts.sh",
  "description": "Clears and restores all Script-server scripts. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>If you have added/modified any scripts, they will be deleted.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_scriptserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh
#!/bin/bash
{
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
fullResetScriptServer false
echo "Script-server fully reset."
set -e
performExitFunctions false

if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts.sh
fi
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh ]; then
  mv $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts.sh
fi
}
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/fullResetScriptServerScripts.json
{
  "name": "04 Full Script-server Reset",
  "script_path": "conf/scripts/fullResetScriptServerScripts.sh",
  "description": "Performs a full reset. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Performs a full reset and restore of all scripts and runners in the Script-server app to default. Deletes all logs and temp files. If you have added/modified any scripts, they will be deleted.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_scriptserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  if [ "$isReplaceSSScripts" = "true" ]; then
    mv $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/restoreScriptServerScripts.sh
    mv $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/clearRestoreScriptServerScripts.sh
    mv $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/fullResetScriptServerScripts.sh
  fi

  # 04 System Utils
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkUpdateHSHQ.sh
#!/bin/bash

source $HSHQ_LIB_SCRIPT lib

latest_ver_wrapper=\$(getLatestVersionWrapper)
this_ver_wrapper=\$(getThisVersionWrapper)
latest_ver_lib=\$(getLatestVersionLib)
this_ver_lib=\$(getThisVersionLib)
pending_ver_lib=\$(getPendingVersionLib)

if [ -z "\$latest_ver_wrapper" ]; then
  echo "ERROR: Could not obtain latest wrapper version, check your internet connection and try again."
  exit
fi

if [ \$this_ver_wrapper -eq 0 ]; then
  echo "ERROR: Could not determine current wrapper version."
  exit
fi

if [ -z "\$latest_ver_lib" ]; then
  echo "ERROR: Could not obtain latest lib version, check your internet connection and try again."
  exit
fi

if [ \$this_ver_lib -eq 0 ]; then
  echo "ERROR: Could not determine current lib version."
  exit
fi

output_rep=""
is_any_avail=false

if [ \$this_ver_wrapper -lt \$latest_ver_wrapper ]; then
  output_rep="\${output_rep}There is a a new version of the wrapper script available.\n\n"
  output_rep="\${output_rep}Current wrapper version: \${this_ver_wrapper}\n"
  output_rep="\${output_rep}Latest wrapper version: \${latest_ver_wrapper}\n\n"
  is_any_avail=true
fi

if [ \$this_ver_lib -lt \$latest_ver_lib ]; then
  output_rep="\${output_rep}There is a a new version of the lib script available.\n\n"
  output_rep="\${output_rep}Current lib version: \${this_ver_lib}\n"
  output_rep="\${output_rep}Latest lib version: \${latest_ver_lib}\n\n"
  is_any_avail=true
elif ! [ -z "\$pending_ver_lib" ]; then
  output_rep="\${output_rep}There is a a pending version of the lib script available.\n\n"
  output_rep="\${output_rep}Current lib version: \${this_ver_lib}\n"
  output_rep="\${output_rep}Pending lib version: \${pending_ver_lib}\n\n"
  is_any_avail=true
fi

if [ "\$is_any_avail" = "true" ]; then
  echo -e "==========UPDATES AVAILABLE==========\n"
  echo -e "\${output_rep}\n"
else
  echo -e "Your system is up to date.\n"
  echo -e "Current wrapper version: \${this_ver_wrapper}"
  echo -e "Latest wrapper version: \${latest_ver_wrapper}\n"
  echo -e "Current lib version: \${this_ver_lib}"
  echo -e "Latest lib version: \${latest_ver_lib}\n"
fi

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/checkUpdateHSHQ.json
{
  "name": "01 Check Update HSHQ",
  "script_path": "conf/scripts/checkUpdateHSHQ.sh",
  "description": "Check for updates. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Checks for updates to either the wrapper script ($HSHQ_WRAP_FILENAME) or the lib script ($HSHQ_LIB_FILENAME). Does not perform any actions, just simply informs if there is an update available.<br/><br/>Github Releases: https://github.com/homeserverhq/hshq/releases<br/>Changelog: https://homeserverhq.com/changelog.txt<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": []
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/performUpdateHSHQ-New.sh
#!/bin/bash
{
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkRelayPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

set +e
echo "Updating HSHQ..."
is_any_updated=false

latest_ver_wrapper="\$(getLatestVersionWrapper)"
this_ver_wrapper="\$(getThisVersionWrapper)"
latest_ver_lib="\$(getLatestVersionLib)"
this_ver_lib="\$(getThisVersionLib)"
pending_ver_lib="\$(getPendingVersionLib)"

if [ -z "\$latest_ver_wrapper" ]; then
  echo "ERROR: Could not obtain latest wrapper version, check your internet connection and try again."
  exit
fi

if [ \$this_ver_wrapper -eq 0 ]; then
  echo "ERROR: Could not determine current wrapper version."
  exit
fi

if [ -z "\$latest_ver_lib" ]; then
  echo "ERROR: Could not obtain latest lib version, check your internet connection and try again."
  exit
fi

if [ \$this_ver_lib -eq 0 ]; then
  echo "ERROR: Could not determine current lib version."
  exit
fi

if [ \$this_ver_wrapper -lt \$latest_ver_wrapper ]; then
  wget -q4 -O \$HSHQ_WRAP_TMP \$(getLatestWrapperURL)
  if [ \$? -ne 0 ]; then
    rm -f \$HSHQ_WRAP_TMP
    echo "ERROR: Could not obtain current version of wrapper script."
    exit
  fi
  hshq_wrap_dl_version=\$(sed -n 2p \$HSHQ_WRAP_TMP | cut -d"=" -f2)
  if [ "\$(checkValidVersionNumber "\$hshq_wrap_dl_version")" = "true" ]; then
    wget -q4 -O $HOME/wrap-\${hshq_wrap_dl_version}.sig \$HSHQ_SIG_BASE_URL/wrap-\${hshq_wrap_dl_version}.sig
    verifyFile \$HSHQ_WRAP_TMP $HOME/wrap-\${hshq_wrap_dl_version}.sig
    ver_res=\$?
    rm -f $HOME/wrap-\${hshq_wrap_dl_version}.sig
  else
    ver_res=5
  fi
  if [ \$ver_res -ne 0 ]; then
    # Not verified, raise the red flag
    rm -f \$HSHQ_WRAP_TMP
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@  SECURITY ALERT  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
    echo "@ There was a verification error on the latest wrapper version (Version \${hshq_wrap_dl_version}). @"
    echo "@         Please email security@homeserverhq.com as soon as possible.        @"
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
    exit 8
  fi
  rm -f \$HSHQ_WRAP_SCRIPT
  mv \$HSHQ_WRAP_TMP \$HSHQ_WRAP_SCRIPT
  chmod 544 \$HSHQ_WRAP_SCRIPT
  is_any_updated=true
  echo "Wrapper script verified and updated."
fi

if [ \$this_ver_lib -lt \$latest_ver_lib ] || ( ! [ -z "\$pending_ver_lib" ] && [ \$pending_ver_lib -lt \$latest_ver_lib ] ); then
  wget -q4 -O \$HSHQ_LIB_TMP \$(getLatestLibURL)
  if [ \$? -ne 0 ]; then
    rm -f \$HSHQ_LIB_TMP
    echo "ERROR: Could not obtain current version of lib script."
    exit
  fi
  hshq_lib_dl_version=\$(sed -n 2p \$HSHQ_LIB_TMP | cut -d"=" -f2)
  if [ "\$(checkValidVersionNumber "\$hshq_lib_dl_version")" = "true" ]; then
    wget -q4 -O $HOME/lib-\${hshq_lib_dl_version}.sig \$HSHQ_SIG_BASE_URL/lib-\${hshq_lib_dl_version}.sig
    verifyFile \$HSHQ_LIB_TMP $HOME/lib-\${hshq_lib_dl_version}.sig
    ver_res=\$?
    rm -f $HOME/lib-\${hshq_lib_dl_version}.sig
  else
    ver_res=5
  fi
  if [ \$ver_res -ne 0 ]; then
    # Not verified, raise the red flag
    rm -f \$HSHQ_LIB_TMP
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@  SECURITY ALERT  @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
    echo "@   There was a verification error on the latest lib version (Version \${hshq_lib_dl_version}).   @"
    echo "@         Please email security@homeserverhq.com as soon as possible.        @"
    echo "@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@"
    exit 8
  fi
  rm -f \$HSHQ_NEW_LIB_SCRIPT
  chmod 644 \$HSHQ_LIB_TMP
  mv \$HSHQ_LIB_TMP \$HSHQ_NEW_LIB_SCRIPT
  echo "Lib script verified!"
fi

# Acquire all locks
checkRes="\$(acquireAllLocks)"
if ! [ -z "\$checkRes" ]; then
  # Could not get all locks, try again later.
  echo "The necessary locks could not be obtained (\$checkRes). Please try applying the update later."
  exit 10
fi
decryptAndLoad false
USER_CONFIG_PW=""

set +e
prior_version=\$(sed -n 2p \$HSHQ_LIB_SCRIPT | cut -d"=" -f2)
if [ -f \$HSHQ_NEW_LIB_SCRIPT ]; then
  source \$HSHQ_NEW_LIB_SCRIPT lib
  if [ "\$PRIMARY_VPN_SETUP_TYPE" = "host" ] && [ \$prior_version -lt \$LAST_RELAYSERVER_VERSION_UPDATE ]; then
    echo "Prior Version: \$prior_version, Last RelayServer Version Update: \$LAST_RELAYSERVER_VERSION_UPDATE, checking RelayServer password..."
    testRelayServerPassword 
    if [ \$? -ne 0 ]; then
      echo "ERROR: The provided RelayServer password is incorrect. The update(s) were NOT applied."
      performExitFunctions false
      releaseAllLocks false
      exit 11
    fi
  fi
  performPreUpdateCheck
  if [ \$? -eq 0 ]; then
    mv \$HSHQ_NEW_LIB_SCRIPT \$HSHQ_LIB_SCRIPT
    is_any_updated=true
  else
    performExitFunctions false
    releaseAllLocks false
    exit 12
  fi
else
  if [ "\$PRIMARY_VPN_SETUP_TYPE" = "host" ] && [ \$prior_version -lt \$LAST_RELAYSERVER_VERSION_UPDATE ]; then
    echo "Prior Version: \$prior_version, Last RelayServer Version Update: \$LAST_RELAYSERVER_VERSION_UPDATE, checking RelayServer password..."
    testRelayServerPassword 
    if [ \$? -ne 0 ]; then
      echo "ERROR: The provided RelayServer password is incorrect. The update(s) were NOT applied."
      performExitFunctions false
      releaseAllLocks false
      exit 13
    fi
  fi
fi

source \$HSHQ_LIB_SCRIPT lib
checkUpdateVersion

if ! [ "\$is_any_updated" = "true" ]; then
  is_any_updated="\$is_update_performed"
fi

if [ "\$is_any_updated" = "true" ]; then
  echo "All updates have been successfully applied."
else
  echo "No updates available. Your system is already up to date."
fi

set -e
performExitFunctions false
releaseAllLocks false

# Check if this got replaced by itself, and replace it if so
if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/performUpdateHSHQ-New.sh ]; then
  moveScriptServerPerformUpdate
fi

# Restart Script-server if necessary
if [ "\$IS_RESTART_SCRIPTSERVER" = "true" ]; then
  sudo systemctl daemon-reload
  sudo systemctl restart runScriptServer.service
fi

}
EOFSC

  if [ "$isReplaceUpdateScript" = "true" ]; then
    moveScriptServerPerformUpdate
  fi

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/performUpdateHSHQ.json
{
  "name": "02 Perform Update HSHQ",
  "script_path": "conf/scripts/performUpdateHSHQ.sh",
  "description": "Performs HSHQ Updates. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Checks for updates to either the wrapper script ($HSHQ_WRAP_FILENAME) or the lib script ($HSHQ_LIB_FILENAME), and automatically applies update(s) if available. Only applies update(s) with a valid signature on the new source code.<br/><br/>The RelayServer password will only apply if you are hosting a VPN and the server requires an update. The field requires an entry, so just leave the default value if not applicable.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter RelayServer sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "default": "pass",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$relaysudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/updateHostAndReboot.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_LIB_SCRIPT lib
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

set +e
echo "Updating Linux and rebooting..."
sudo DEBIAN_FRONTEND=noninteractive apt update
sudo DEBIAN_FRONTEND=noninteractive apt upgrade -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'
sudo DEBIAN_FRONTEND=noninteractive apt autoremove -y
sudo reboot
set -e

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/updateHostAndReboot.json
{
  "name": "03 Update Linux OS and Reboot",
  "script_path": "conf/scripts/updateHostAndReboot.sh",
  "description": "Updates the host Linux Ubuntu OS and reboots the HomeServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This process will (obviously) disconnect you from this web app during the reboot process. It can take up to 5-10 minutes for all of the services to come back up after reboot, so be patient.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/poweroffHomeServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh

echo "Powering down..."
sudo poweroff

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/poweroffHomeServer.json
{
  "name": "04 Power off HomeServer",
  "script_path": "conf/scripts/poweroffHomeServer.sh",
  "description": "Shuts down the HomeServer. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/downloadAllDockerImages.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
confirm=\$(getArgumentValue confirm "\$@")
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkConfirm.sh "\$confirm"
source $HSHQ_LIB_SCRIPT lib

echo "Downloading all docker images..."
pullDockerImages

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/downloadAllDockerImages.json
{
  "name": "05 Download All Docker Images",
  "script_path": "conf/scripts/downloadAllDockerImages.sh",
  "description": "Downloads all docker images. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Enter confirm in the box below.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter 'confirm' to continue.",
      "required": true,
      "param": "-confirm=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "7",
      "regex": {
        "pattern": "^confirm\$",
        "description": "Must be the word confirm"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/resetMutexLock.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_LIB_SCRIPT lib

sellock=\$(getArgumentValue sellock "\$@")
releaseLock "\$sellock" "resetMutexLock" true
echo "Mutex lock (\$sellock) successfully reset."
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/resetMutexLock.json
{
  "name": "06 Reset Mutex Lock",
  "script_path": "conf/scripts/resetMutexLock.sh",
  "description": "Resets the selected mutex lock. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>A mutex lock, or mutual exclusion lock, is a mechanism to ensure only <ins>***ONE***</ins> instance is doing a certain thing at a time. A lock only needs to be manually reset if something went wrong, and the lock was never properly released by the holder.<br/><br/>There are only two locks in use in this infrastructure - hshqopen and networkchecks. The hshqopen lock is primarily for script functions, such as those in this Script-server web utility or the console-based utility. The networkchecks lock is primarily for the background network monitoring processes. The hshqopen lock might need to be reset on occasion. The networkchecks should rarely, if ever, require a reset.<br/><br/>Only reset a lock if you are sure no other instances are holding the lock in normal operating conditions.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Select lock",
      "required": true,
      "param": "-sellock=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": [ "hshqopen", "networkchecks" ],
      "default": "hshqopen",
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/changeConnectionEmail.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")
newemail=\$(getArgumentValue newemail "\$@")

set +e
change_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
is_changed=false
if [ "\$(checkValidEmail \$newemail)" = "false" ]; then
  echo "ERROR: Invalid email address."
else
  sudo sqlite3 $HSHQ_DB "update connections set EmailAddress='\$newemail' where ID='\$change_id';"
  echo "Email address successfully changed."
  is_changed=true
fi
set -e
performExitFunctions false

if ! [ "\$is_changed" = "true" ]; then
  exit 1
fi
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/changeConnectionEmail.json
{
  "name": "07 Change Connection Email",
  "script_path": "conf/scripts/changeConnectionEmail.sh",
  "description": "Change a connection email. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will allow you to change any email address in the connections database. Be very careful with any changes, as it will affect where notifications are sent when network changes occur.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name,': ',EmailAddress from connections order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter new email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-newemail=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/displayAllConnections.sh
#!/bin/bash

source $HSHQ_LIB_SCRIPT lib

echo "  | Name | EmailAddress | NetworkType | PublicKey | IPAddress |"
echo "---------------------------------------------------------------------------------------"
sqlite3 -separator " | " \$HSHQ_DB "select ' ',Name,EmailAddress,NetworkType,PublicKey,IPAddress,' ' from connections order by ID;"
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/displayAllConnections.json
{
  "name": "08 Display All Connections",
  "script_path": "conf/scripts/displayAllConnections.sh",
  "description": "Display all network connections. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function outputs all network connections to the console. If you are hosting a VPN, the output will include all connections that you manage.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils"
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/uploadHomeServerLogo.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

img=\$(getArgumentValue img "\$@")
uploadHomeServerLogo "\$img"
performExitFunctions false
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/uploadHomeServerLogo.json
{
  "name": "09 Upload HomeServer Logo",
  "script_path": "conf/scripts/uploadHomeServerLogo.sh",
  "description": "Upload HomeServer Logo. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function uploads the logo image for your HomeServer as shown in the HomeServers section of the home page. It will also replace the file $HSHQ_ASSETS_DIR/images/${HOMESERVER_DOMAIN}.png, and your logo will be displayed on other networks accordingly (given that the other manager(s) run the 04 System Utils -> 10 Update HomeServer Logos function). Finally, it will replace the image /usr/share/icons/HSHQ/Homepage.png, which is the default source for the Homepage icon on the desktop (if applicable). The image must be a .png and it can be no larger than 1 MB.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select Image",
      "required": true,
      "param": "-img=",
      "same_arg_param": true,
      "type": "file_upload",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/updateHomeServerLogoImages.sh
#!/bin/bash

source $HSHQ_LIB_SCRIPT lib
updateHomeServerLogoImages

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/updateHomeServerLogoImages.json
{
  "name": "10 Update HomeServer Logos",
  "script_path": "conf/scripts/updateHomeServerLogoImages.sh",
  "description": "Updates HomeServer Logos. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function downloads the logo images for each of the HomeServers shown in the HomeServers section of the home page. If you wish to set the logo image for your own HomeServer, then run the 04 System Utils -> 09 Upload HomeServer Logo function and select the image of your choice, and your logo will be displayed on other networks accordingly (given that the other manager(s) run this function). The downloaded images must be in .png format and can be no larger than 1MB (1024 KB).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": []
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addRemoveVNCServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
isAddRem=\$(getArgumentValue addremvnc "\$@")
if [ "\$isAddRem" = "Add" ]; then
  addVNCServer
elif [ "\$isAddRem" = "Remove" ]; then
  removeVNCServer
else
  echo "Unknown option, returning..."
fi
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addRemoveVNCServer.json
{
  "name": "11 Add/Remove VNC Server",
  "script_path": "conf/scripts/addRemoveVNCServer.sh",
  "description": "Add or Remove Host VNC Server. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will add (or remove) an [x11vnc](https://github.com/LibVNC/x11vnc) server on the Linux host. It will bind the service to port $VNC_SERVER_PORT, and it will expose this port on the local network. It will also allow this port to be accessed on the dock-ext docker network, which is needed for setting up a connection profile in [Guacmole](https://wiki.homeserverhq.com/en/foss-projects/guacamole) (access the desktop from anywhere in a web-browser). You must have a desktop environment installed in order for this service to be functional. The default password is your sudo password. To access your server with a VNC client on the local network, use the following IP address/port combo: $HOMESERVER_HOST_PRIMARY_INTERFACE_IP:$VNC_SERVER_PORT. You can also use the hostname, i.e.: $HOMESERVER_DOMAIN:$VNC_SERVER_PORT.<br/>\nItems of note:\n1. This services fails to work on the GNOME desktop environment. If you attempt to do so, you will have to log out of that desktop instance directly on this physical server, so that the VNC server can (automatically) restore itself to a healthy state. It does not have any (known) issues with Cinnamon, KDE, XFCE, MATE, or Budgie.\n2. This service is configured with the -shared option, meaning multiple clients can connect to the same shared session. It also attaches directly to an X display environment. Thus, if you log in remotely, it will also log in on the physical machine as well.\n3. Finally, if you attempt to open a Guacamole web instance directly on this server's desktop environment, it will cause a paradox that could implode the universe onto itself (or just cause some cool screen effects, it depends).\n\n<hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_systemutils",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Add/Remove",
      "required": true,
      "param": "-addremvnc=",
      "same_arg_param": true,
      "type": "list",
      "default": "Add",
      "values": [
        "Add",
        "Remove"
      ],
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  # 05 Testing
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/sudoPasswordTest.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh

echo "Sudo password is correct."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/sudoPasswordTest.json
{
  "name": "01 Sudo Password Test",
  "script_path": "conf/scripts/sudoPasswordTest.sh",
  "description": "Checks if sudo (super user do...something) password is correct. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/decryptConfigPasswordTest.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
USER_CONFIG_PW=""

echo "Config decrypt password is correct."

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/decryptConfigPasswordTest.json
{
  "name": "02 Decrypt Config Password Test",
  "script_path": "conf/scripts/decryptConfigPasswordTest.sh",
  "description": "Checks if config decrypt password is correct. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkMutexLockStatus.sh
#!/bin/bash
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
sellock=\$(getArgumentValue sellock "\$@")
source $HSHQ_LIB_DIR/$LOCK_UTILS_FILENAME
checkRes=\$(checkIsLockEnabled \$sellock checkMutexLockStatus)
if ! [ -z "\$checkRes" ]; then
  echo "LOCK HELD: The lock (\$sellock) is currently held by a process: \$checkRes"
else
  echo "The lock (\$sellock) is not held by any instance."
fi

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/checkMutexLockStatus.json
{
  "name": "03 Check Mutex Lock Status",
  "script_path": "conf/scripts/checkMutexLockStatus.sh",
  "description": "Checks the status of a mutex lock. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This is a safeguard to ensure only <ins>***ONE***</ins> instance doing a certain thing at a time.<br/><br/>There are only two locks in use in this infrastructure - hshqopen and networkchecks. The hshqopen lock is primarily for script functions, such as those in this Script-server web utility or the console-based utility. The networkchecks lock is primarily for the background network monitoring processes. The hshqopen lock might need to be reset on occasion. The networkchecks should rarely, if ever, require a reset.<br/><br/>This function does not perform any actions, it only reports the status. If you need to reset one of them, go to Reset Mutex Lock in System Utils.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Select lock",
      "required": true,
      "param": "-sellock=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": [ "hshqopen", "networkchecks" ],
      "default": "hshqopen",
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkIPAddress.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

ischeckall=\$(getArgumentValue ischeckall "\$@")
ipaddr=\$(getArgumentValue ipaddr "\$@")
cidrlen=\$(getArgumentValue cidrlen "\$@")

set +e
is_check_all=false
if [ "\$ischeckall" = "Yes" ]; then
  is_check_all=true
fi
retVal=\$(isNetworkIntersectOurNetworks "\${ipaddr}/\${cidrlen}" "\$is_check_all" "\$is_check_all")
if [ -z "\$retVal" ]; then
  echo -e "\nThere are no network collisions with \${ipaddr}/\${cidrlen}\n"
else
  echo -e "\nNetwork Collision: \$retVal\n"
fi
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/checkIPAddress.json
{
  "name": "04 Check for Network Collision",
  "script_path": "conf/scripts/checkIPAddress.sh",
  "description": "Tests an IP address or subnet for network collisions. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function checks whether the provided IP address or subnet intersects with any of the networks that this HomeServer is on. It does not assert any consequential actions, just performs the tests.<br/><br/>Regarding Check all possible connections - with it set to No, it will only check the network connections directly on this HomeServer. With it set to Yes, it will check any and all connections that this HomeServer manages, i.e. if hosting a VPN, then it will check all User and/or HS Internet connections, which may be on behalf of another device in the network. If the explanation for this distinction is confusing, then ask on the [Forum](https://forum.homeserverhq.com/).<br/><br/>If you want to test a subnet range, then input its CIDR length. For a single IP address, leave it at the default of 32.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Check all possible connections?",
      "required": true,
      "param": "-ischeckall=",
      "same_arg_param": true,
      "type": "list",
      "default": "No",
      "values": [
        "Yes",
        "No"
      ],
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter an IP address",
      "required": true,
      "param": "-ipaddr=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "default": { 
        "script": "conf/scripts/generateRandomIP.sh"
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "CIDR length",
      "required": true,
      "param": "-cidrlen=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "32",
      "min": "0",
      "max": "32",
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/checkWireGuardKey.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_LIB_SCRIPT lib
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

checkkey=\$(getArgumentValue checkkey "\$@")

set +e
retVal=\$(checkValidWireGuardKey "\$checkkey")
if [ "\$retVal" = "true" ]; then
  echo -e "\nThe key is valid.\n"
else
  echo -e "\nThe key is NOT valid.\n"
fi
set -e

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/checkWireGuardKey.json
{
  "name": "05 Check WireGuard Key",
  "script_path": "conf/scripts/checkWireGuardKey.sh",
  "description": "Tests a WireGuard key for validity. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function checks whether the provided key (public/private/preshared) is a valid WireGuard key.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Enter a key",
      "required": true,
      "param": "-checkkey=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "max_length": "44",
      "regex": {
        "pattern": "^[A-Za-z0-9+/]{42}[AEIMQUYcgkosw480]=\$",
        "description": "Must be a valid WireGuard key"
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/testPortainer.sh
#!/bin/bash
echo "Start script"
source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Testing Portainer"
echo "Getting auth token..."
portainerToken="\$(getPortainerToken -u \$PORTAINER_ADMIN_USERNAME -p \$PORTAINER_ADMIN_PASSWORD)"
if [ \$? -eq 0 ]; then
  echo "Querying stacks..."
  tVal=\$(http --check-status --ignore-stdin --verify=no --timeout=300 --print="b" GET https://127.0.0.1:\$PORTAINER_LOCAL_HTTPS_PORT/api/stacks "Authorization: Bearer \$portainerToken" endpointId==1)
  if [ \$? -eq 0 ]; then
    echo "Succesfully executed query, connection is good!"
  else
    echo "ERROR: There was a problem running a query on the stacks"
  fi
else
  echo "ERROR: Could not get auth token - either there is a problem with the service or bad credentials"
fi
echo "End Test"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/testPortainer.json
{
  "name": "06 Test Portainer Connection",
  "script_path": "conf/scripts/testPortainer.sh",
  "description": "Tests Portainer Connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function tests the connectivity with the Portainer API. It acquires an auth token, then runs a simple query. If you change the admin password (in both Portainer and the config file), then use this function to test it before running any other utilities.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_testing",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  # 06 My Network
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/myNetworkInviteConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

configname=\$(getArgumentValue configname "\$@")

set +e
echo "\$myappcnf" > \$HOME/apply_hsv.cnf
performNetworkInvite "\$HOME/apply_hsv.cnf" "\$configname"
retVal=\$?
rm -f \$HOME/apply_hsv.cnf
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/myNetworkInviteConnection.json
{
  "name": "01 Invite to Network",
  "script_path": "conf/scripts/myNetworkInviteConnection.sh",
  "description": "Performs a network invite. [Need Help?](https://forum.homeserverhq.com/)<br/>![HSHQ-Invite.png](/img/HSHQ-Invite.png)To invite a HomeServer or user device to your network, you should have recieved an application via email. Paste the contents of the application into the corresponding field below. Ensure to review the details of the application including the email sender. You should <ins>***NEVER***</ins> invite anyone to your network that you do not know and trust. An invitation will be automatically sent to the requesting email address upon execution. The name field only applies to User device applications, for your your own internal nomenclature (use the Description that the applicant provided in the email as reference). Names for other connection types will be automatically generated.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter a name for this configuration (User device invites only)",
      "required": false,
      "param": "-configname=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]+\$",
        "description": "Only lowercase letters, numbers, and/or hyphens"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the application",
      "required": true,
      "type": "multiline_text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "myappcnf"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/myNetworkInviteDeviceConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

configname=\$(getArgumentValue configname "\$@")
requestemailaddress=\$(getArgumentValue requestemailaddress "\$@")
requestinternet=\$(getArgumentValue requestinternet "\$@")
ipaddress=\$(getArgumentValue ipaddress "\$@")
publickey=\$(getArgumentValue publickey "\$@")
presharedkey=\$(getArgumentValue presharedkey "\$@")

req_internet=false
if [ "\$requestinternet" = "Yes" ]; then
  req_internet=true
fi
set +e
createMyNetworkUserInvite "\$requestemailaddress" "\$req_internet" "\$ipaddress" "\$publickey" "\$presharedkey" "\$HOME/apply_hsv.cnf"
retVal=\$?
if [ \$retVal -eq 0 ]; then
  performNetworkInvite "\$HOME/apply_hsv.cnf" "\$configname"
  retVal=\$?
fi
rm -f \$HOME/apply_hsv.cnf
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/myNetworkInviteDeviceConnection.json
{
  "name": "02 Invite Device to Network",
  "script_path": "conf/scripts/myNetworkInviteDeviceConnection.sh",
  "description": "Performs a device invite to your network. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to skip the application process and jump right to the invitation. If you received an application via email, then it would be easier to use the standard 06 My Network -> 01 Invite to Network function. But if someone emailed you their client device's public key (and interface IP address), or you are adding one of your own devices (cellphone/laptop/tablet) to your network, then this utilty can help speed up the process. <ins>***However***</ins>, if this is a new profile with no provided public key, then take the proper precautions as this method will generate and insert the <ins>***ACTUAL***</ins> private key into the configuration, i.e. <ins>***DO NOT***</ins> send this configuration to an email address of a centralized email provider, nor share this configuration over any other public channels. Treat it as <ins>***HIGHLY CONFIDENTIAL***</ins>. <br/>\nIf you are requesting a new profile: \n1. Leave the interface IP address blank.\n2. If the public key is left blank, then a key pair will be generated and included in the configuration.\n\nIf you already have an existing profile:\n1. Include both the interface IP address and the public key of your existing profile.\n2. When the recipient receives the WireGuard configuration via email, append the peer configuration to the existing WireGuard profile.\n\nIf the preshared key is blank in any case, one will be generated. Finally, if you allow public internet IP masquerade, then this device can masquerade its internet traffic via your RelayServer.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter a name for this configuration",
      "required": true,
      "param": "-configname=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]+\$",
        "description": "Only lowercase letters, numbers, and/or hyphens"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the requesting email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-requestemailaddress=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Allow public internet IP masquerade?",
      "required": true,
      "param": "-requestinternet=",
      "same_arg_param": true,
      "type": "list",
      "default": "No",
      "values": [
        "Yes",
        "No"
      ],
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the interface IP address",
      "required": false,
      "param": "-ipaddress=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the public key",
      "required": false,
      "param": "-publickey=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "44",
      "regex": {
        "pattern": "^[A-Za-z0-9+/]{42}[AEIMQUYcgkosw480]=\$",
        "description": "Must be a valid WireGuard key"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the preshared key",
      "required": false,
      "param": "-presharedkey=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "44",
      "regex": {
        "pattern": "^[A-Za-z0-9+/]{42}[AEIMQUYcgkosw480]=\$",
        "description": "Must be a valid WireGuard key"
      },
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/changeHSPrimaryInternetIP.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

ipaddr=\$(getArgumentValue ipaddr "\$@")

set +e
changeHSInternetPrimaryIPAddress \$ipaddr
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/changeHSPrimaryInternetIP.json
{
  "name": "03 Change Primary HS Int IP",
  "script_path": "conf/scripts/changeHSPrimaryInternetIP.sh",
  "description": "Changes the interface IP address of the primary HomeServer Internet connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The main use case for this function is in the event of a network collision. If this connection is the cause of the collision, then change it to something else, within the 10.0.0.0/8 range. A new randomly selected value has been generated for you (refresh the page to regenerate a new one). No logic checks will be applied until execution, so even a randomly generated value could result in an error. If so, just try again with a new value (or use the 05 Testing -> 04 Check for Network Collision function to find a non-intersecting IP).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter a new IP address",
      "required": true,
      "param": "-ipaddr=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": { 
        "script": "conf/scripts/generateRandomIP.sh"
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/changeDeviceIP.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")
ipaddr=\$(getArgumentValue ipaddr "\$@")

set +e
rem_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
changeDeviceIPAddress \$rem_id \$ipaddr
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/changeDeviceIP.json
{
  "name": "04 Change Device IP",
  "script_path": "conf/scripts/changeDeviceIP.sh",
  "description": "Changes the interface IP address of a device connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The main use case for this function is if a user requests a new interface IP address for their device due to a collision. A new randomly selected value has been generated for you (refresh the page to regenerate a new one). No logic checks will be applied until execution, so even a randomly generated value could result in an error. If so, just try again with a new value (or use the 05 Testing -> 04 Check for Network Collision function to find a non-intersecting IP).<br/><br/>Upon a successful change, an email will be automatically sent to the corresponding email address for this connection. If <ins>you</ins> are the one initiating the change, i.e. the user did not request the change, then ensure to confer with them beforehand, since changing it has potential cascading effects on their device's interface peers.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name,' - ',IPAddress from connections where ConnectionType='user' and NetworkType='mynetwork' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a new IP address",
      "required": true,
      "param": "-ipaddr=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "default": { 
        "script": "conf/scripts/generateRandomIP.sh"
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeHSVPNConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")

set +e
rem_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
removeMyNetworkHomeServerVPNConnection \$rem_id "\$myremreason"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeHSVPNConnection.json
{
  "name": "05 Remove HS VPN Connection",
  "script_path": "conf/scripts/removeHSVPNConnection.sh",
  "description": "Removes a HomeServer VPN connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The reason for removal will be emailed to the manager of the HomeServer being removed.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='homeserver_vpn' and NetworkType='mynetwork' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a reason for removal",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "myremreason"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeHSInternetConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")

set +e
rem_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
removeMyNetworkHomeServerInternetConnection "\$rem_id" "\$myremreason"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeHSInternetConnection.json
{
  "name": "06 Remove HS Int Connection",
  "script_path": "conf/scripts/removeHSInternetConnection.sh",
  "description": "Removes a HomeServer Internet connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The reason for removal will be emailed to the manager of the HomeServer with the internet connection being removed.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='homeserver_internet' and NetworkType='mynetwork' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a reason for removal",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "myremreason"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeDeviceConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")

set +e
rem_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
removeMyNetworkUserConnection "\$rem_id" "\$myremreason"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeDeviceConnection.json
{
  "name": "07 Remove Device Connection",
  "script_path": "conf/scripts/removeDeviceConnection.sh",
  "description": "Removes a client device connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The reason for removal will be emailed to the user of the device being removed.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='user' and NetworkType='mynetwork' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a reason for removal",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "myremreason"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailHomeServersDNSList.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing HomeServers DNS list..."
showEmailMyNetworkHomeServerDNSListNoMenu
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailHomeServersDNSList.json
{
  "name": "08 Email HomeServers DNS List",
  "script_path": "conf/scripts/emailHomeServersDNSList.sh",
  "description": "Emails HomeServers DNS list to self. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails a list of all HomeServers on your network and their corresponding internal IP addresses to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). The format of the list is the standard import format for HomeServers.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailUsersDNSList.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing HomeServer DNS list for user devices..."
showEmailMyNetworkHomeServerDNSListClientDNSNoMenu
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailUsersDNSList.json
{
  "name": "09 Email Client Device DNS List",
  "script_path": "conf/scripts/emailUsersDNSList.sh",
  "description": "Emails HomeServers DNS list to self. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails a list of all HomeServers on your network and their corresponding internal IP addresses to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). The format of the list is compatible with DNSMasq (a DNS server that is used for client devices within this ecosystem).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailMyNetworkClientDeviceDetails.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing user details..."
sendEmailMyNetworkFullUserDetails
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailMyNetworkClientDeviceDetails.json
{
  "name": "10 Email Client Device Details",
  "script_path": "conf/scripts/emailMyNetworkClientDeviceDetails.sh",
  "description": "Emails client device details to self. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Emails the full details for all client device connections to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). The main use case for this function is if you want to tear down and rebuild the primary network. This will allow you to re-add the devices to the new network with the same information.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailMyNetworkBroadcast.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Emailing broadcast message..."
sendEmailMyNetworkBroadcast "\$mybcastmsg"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailMyNetworkBroadcast.json
{
  "name": "11 Email All Broadcast",
  "script_path": "conf/scripts/emailMyNetworkBroadcast.sh",
  "description": "Emails a broadcast message. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will send a broadcast message to all users and connected devices on your network.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the message",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "mybcastmsg"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/createClientDNSServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

cdnsname=\$(getArgumentValue cdnsname "\$@")
set +e
echo "Creating ClientDNS Server..."
performMyNetworkCreateClientDNS "\$cdnsname"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/createClientDNSServer.json
{
  "name": "12 Create ClientDNS Server",
  "script_path": "conf/scripts/createClientDNSServer.sh",
  "description": "Creates a ClientDNS server. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Creates a DNS server that can be used by client devices that are connected to multiple networks. This type of DNS server will 'intercept' DNS requests before they fall through to another underlying primary DNS server (the default fallback is the HomeServer's AdguardHome where this ClientDNS is installed). The main use case for this is when a client device is connected to a network to which the HomeServer is <ins>***NOT***</ins> connected. The DNS records for this foreign network cannot be stored on the HomeServer, since it is not on that network and would thus cause errors with the HomeServer's routing logic. A ClientDNS server resolves this problem.<br/><br/>The name for this server must contain 3-10 lowercase alpha-numeric characters, no spaces or special characters. An email containing the setup details will be sent to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter a name",
      "required": true,
      "param": "-cdnsname=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "10",
      "regex": {
        "pattern": "^[a-z0-9]{3,10}\$",
        "description": "3-10 lowercase letters or numbers"
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeClientDNSServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selserver=\$(getArgumentValue selserver "\$@")
set +e
ss_id="\$(echo \$selserver | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
ss_name="\$(echo \$selserver | cut -d ')' -f2 | sed 's/ //g')"
performMyNetworkRemoveClientDNS "\$ss_id" "\$ss_name" true true
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeClientDNSServer.json
{
  "name": "13 Remove ClientDNS Server",
  "script_path": "conf/scripts/removeClientDNSServer.sh",
  "description": "Removes a ClientDNS server. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select server",
      "required": true,
      "param": "-selserver=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='clientdns' and NetworkType='mynetwork' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/hostVPN.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
read -r -s -p "$rs_cur_password_prompt" rs_cur_password
if [ -z "\$rs_cur_password" ]; then
  read -r -t 5 -s -p "" rs_cur_password
fi
if [ -z "\$rs_cur_password" ]; then
  rs_cur_password=""
  cat <<< "ERROR: Invalid RelayServer current password, please try again." 1>&2
  exit 3
fi
echo "ok"
read -r -s -p "$rs_new_password_prompt" rs_new_password
if [ -z "\$rs_new_password" ]; then
  read -r -t 5 -s -p "" rs_new_password
fi
if [ -z "\$rs_new_password" ]; then
  rs_new_password=""
  cat <<< "ERROR: Invalid RelayServer new password, please try again." 1>&2
  exit 3
fi
echo "ok"
echo "Obtaining networkchecks lock..."
tgLock="\$(tryGetLock networkchecks Script-server-hostVPN)"
if ! [ "\$tgLock" = "true" ]; then
  checkRes="\$(getLockOpenMsg networkchecks)"
  totLockAttempts=\$(getIncrementLockAttempts networkchecks)
  strErr="Cannot obtain networkchecks lock(\$totLockAttempts): \$checkRes, exiting..."
  exit
fi
setSystemState $SS_INSTALLING
echo "Loading environment..."
decryptConfigFileAndLoadEnvNoPrompts

rs_name=\$(getArgumentValue rs_name "\$@")
rs_cur_username=\$(getArgumentValue rs_cur_username "\$@")
rs_cur_ssh_port=\$(getArgumentValue rs_cur_ssh_port "\$@")
rs_external_ip=\$(getArgumentValue rs_external_ip "\$@")
rs_ledomains="\$(getArgumentValue rs_ledomains \$@)"
rs_new_username=\$(getArgumentValue rs_new_username "\$@")
rs_new_ssh_port=\$(getArgumentValue rs_new_ssh_port "\$@")
rs_primary_vpn_subnet=\$(getArgumentValue rs_primary_vpn_subnet "\$@")
webSetupHostedVPN
set +e
performExitFunctions false
setSystemState $SS_RUNNING
releaseLock networkchecks "Script-server-hostVPN" false
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/hostVPN.json
{
  "name": "14 Set Up Hosted VPN",
  "script_path": "conf/scripts/hostVPN.sh",
  "description": "Set up a hosted VPN. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will set up a personal hosted VPN. It is one of the core architectural elements of this infrastructure, i.e. the RelayServer. This server must have a public static IP address and publically accessible ports. If the provider has their own firewall, ensure that the following ports are open: 25 (Email), 80(http), 443(https), ${RELAYSERVER_WG_PORT}(WireGuard), Current SSH Port AND New SSH Port. See [this page](https://wiki.homeserverhq.com/en/getting-started/setup-relayserver) for more details.<br/><br/> <ins>***BEFORE***</ins> you run this function, ensure to point the DNS records for your domain to the IP address of your RelayServer. You can use the function 08 RelayServer Utils -> 11 Email DNS Records to obtain the necessary info. See Step 1 [at this link](https://wiki.homeserverhq.com/en/getting-started/installation) for more details.<br/><br/>The installation will take around 10-15 minutes to complete. Also note that during parts of the installation, the console output below will appear to freeze at times, output duplicate messages, overwrite previous output, etc. This is due to the usage of the Linux [screen](https://www.gnu.org/software/screen/manual/screen.html) utility. Just be patient and allow the process to run its course. If it hangs for longer than 30 minutes, then something may have gone wrong, and you may have to remove the VPN (see 06 My Network -> 15 Remove Primary VPN) and try again. <br/><br/>If you have not yet set up a non-root user on this server, then likely the only account is the root account. So ensure a new Linux username is provided as well as a password (at least 16 characters). If the current Linux username is not root, then the new username and corresponding password will be ignored (even though all password fields require a value). The default SSH port is likely 22, unless you have changed it. The VPN subnet can only be in the 10.0.0.0/8 range, and it can only be of size /24. Thus, only the first three octets of the provided value matter. A random subnet has been generated for you. If you don't know what any of this means, just use the provided value.<br/><br/>Upon completion, the mail DNS records will be emailed to the admin account ($EMAIL_ADMIN_EMAIL_ADDRESS), and the first user WireGuard configuration will be saved to the home directory (/home/$USERNAME), or Desktop (/home/$USERNAME/Desktop), if applicable. This WireGuard configuration is strictly for a client device, i.e. anything but <ins>this</ins> server. It is generated merely as a convenience, and you should permanently delete the config file as soon as you are finished with it.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "RelayServer name",
      "required": true,
      "param": "-rs_name=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[A-Za-z0-9 _,.-]+\$",
        "description": "Only letters, numbers, and simple punctuation."
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "$HOMESERVER_NAME RelayServer",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Let's Encrypt subdomains",
      "required": false,
      "param": "-rs_ledomains=",
      "same_arg_param": true,
      "type": "text",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9.-]*\\\\.[a-zA-Z]{2,}(,[a-z0-9][a-z0-9.-]*\\\\.[a-zA-Z]{2,})*\$",
        "description": "Comma-separated - only lowercase, numbers, hyphens, periods"
      },
      "ui": {
        "width_weight": 2
      },
      "default": "$(getLetsEncryptCertsDefault)",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "CURRENT Linux username",
      "required": true,
      "param": "-rs_cur_username=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z][a-z0-9_-]+\$",
        "description": "Only letters, numbers, hyphens, underscores."
      },
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "root",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "NEW Linux username",
      "required": false,
      "param": "-rs_new_username=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "64",
      "regex": {
        "pattern": "^[a-z][a-z0-9_-]+\$",
        "description": "Only letters, numbers, hyphens, underscores."
      },
      "ui": {
        "width_weight": 2
      },
      "default": "$USERNAME",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "CURRENT Linux password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "param": "-rs_cur_password=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$rs_cur_password_prompt"
    },
    {
      "name": "NEW Linux password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "param": "-rs_new_password=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "default": "",
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$rs_new_password_prompt"
    },
    {
      "name": "CURRENT SSH port",
      "required": true,
      "param": "-rs_cur_ssh_port=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "22",
      "min": "1",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "NEW SSH port",
      "required": true,
      "param": "-rs_new_ssh_port=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2
      },
      "default": "$SSH_PORT",
      "min": "1024",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "RelayServer IP address",
      "required": true,
      "param": "-rs_external_ip=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "VPN subnet",
      "required": true,
      "param": "-rs_primary_vpn_subnet=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "default": { 
        "script": "conf/scripts/generateRandomSubnet.sh"
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removePrimaryVPNConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

echo "Obtaining networkchecks lock..."
tgLock="\$(tryGetLock networkchecks Script-server-removePrimaryVPNConnection)"
if ! [ "\$tgLock" = "true" ]; then
  totLockAttempts=\$(getIncrementLockAttempts networkchecks)
  checkRes="\$(getLockOpenMsg networkchecks)"
  strErr="Cannot obtain networkchecks lock(\$totLockAttempts): \$checkRes, exiting..."
  echo "\$strErr"
  exit
fi
setSystemState $SS_REMOVING
decryptConfigFileAndLoadEnvNoPrompts
set +e
removeMyNetworkPrimaryVPN "\$mydisreason"
set -e
performExitFunctions false
setSystemState $SS_RUNNING
releaseLock networkchecks "Script-server-removePrimaryVPNConnection" false
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removePrimaryVPNConnection.json
{
  "name": "15 Remove Primary VPN",
  "script_path": "conf/scripts/removePrimaryVPNConnection.sh",
  "description": "Complete removal of primary VPN. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>If you are hosting a VPN, this will: \n1. Remove all HomeServers from your network.\n2. Delete all ClientDNS servers and data.\n3. Disconnect you from your RelayServer and delete its local backup data.\n4. Disable sending/receiving external email.\n5. In short, <ins>***TOTAL HOSTED VPN DESTRUCTION***</ins>\n\nIf you have joined this VPN as primary, this will: \n1. Disconnect you from this network.\n2. Disable sending/receiving external email.\n\nThis operation will not affect any other networks on which you are currently hosting, although you will be without external email services. The reason for disconnect/removal will be emailed to all HomeServers and clients on the network (before dismantling).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_mynetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter a reason for disconnect/removal",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "mydisreason"
    }
  ]
}

EOFSC

  # 07 Other Networks
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/applyHSVPNConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

applyemailaddress=\$(getArgumentValue applyemailaddress "\$@")

set +e
sendOtherNetworkApplyHomeServerVPNConfig "\$applyemailaddress" false ""
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/applyHSVPNConnection.json
{
  "name": "01 HS VPN Application",
  "script_path": "conf/scripts/applyHSVPNConnection.sh",
  "description": "Generates and sends a HomeServer VPN application to the recipient email address. [Need Help?](https://forum.homeserverhq.com/)<br/>![HSHQ-ApplyJoin.png](/img/HSHQ-ApplyJoin.png)A HomeServer VPN connection will allow you to host selected services on the private network to which you are applying. The recipient email should be the network administrator of that network. Ensure to double check the email address, as this will automatically send the application upon execution. You will also receive a manager (MGR) copy of this request in your admin mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). Upon approval, you will recieve a join invitation via email. Go to the Join Network function with the invitation to finalize the connection.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the recipient email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-applyemailaddress=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/applyHSInternetConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

applyemailaddress=\$(getArgumentValue applyemailaddress "\$@")

set +e
sendOtherNetworkApplyHomeServerInternetConfig "\${applyemailaddress}"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/applyHSInternetConnection.json
{
  "name": "02 HS Internet Application",
  "script_path": "conf/scripts/applyHSInternetConnection.sh",
  "description": "Generates and sends a HomeServer internet application to the recipient email address. [Need Help?](https://forum.homeserverhq.com/)<br/>![HSHQ-ApplyJoin.png](/img/HSHQ-ApplyJoin.png)A HomeServer internet connection will allow you to masquerade your internet IP address for a docker network (and thus specific docker containers) on your HomeServer via the RelayServer of the network to which you are applying. The recipient email should be the network administrator of that network. Ensure to double check the email address, as this will automatically send the application upon execution. You will also receive a manager (MGR) copy of this request in your admin mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). Upon approval, you will recieve a join invitation via email. Go to the Join Network function with the invitation to finalize the connection.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the recipient email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-applyemailaddress=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/applyUserConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

applyemailaddress=\$(getArgumentValue applyemailaddress "\$@")
requestemailaddress=\$(getArgumentValue requestemailaddress "\$@")
requestinternet=\$(getArgumentValue requestinternet "\$@")
ipaddress=\$(getArgumentValue ipaddress "\$@")
publickey=\$(getArgumentValue publickey "\$@")
description=\$(getArgumentValue description "\$@")

req_internet=false
if [ "\$requestinternet" = "Yes" ]; then
  req_internet=true
fi
set +e
sendOtherNetworkApplyUserConfig "\$applyemailaddress" "\$requestemailaddress" "\$req_internet" "\$ipaddress" "\$publickey" "\$description"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/applyUserConnection.json
{
  "name": "03 User Device Application",
  "script_path": "conf/scripts/applyUserConnection.sh",
  "description": "Generates and sends a user device application to the recipient email address. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>A user device application is specifically for a client device (desktop, laptop, mobile, etc.) to access the private network to which you are applying. The recipient email should be the network administrator of that network. Ensure to double check all of the inputs, as this will automatically send the application upon execution. Also ensure the client device has access to the requesting email in order to be notified of updates to the network. If this is a new profile with no provided public key, then take the proper precautions as this method will generate and email the <ins>***ACTUAL***</ins> private key to the requesting email, i.e. <ins>***DO NOT***</ins> send this to an email address of a centralized email provider, nor share it over any other public channels. Treat it as <ins>***HIGHLY CONFIDENTIAL***</ins>. If you request public internet IP masquerade and it is approved, then you can masquerade your internet traffic for the device via the RelayServer of that network. The description field is to convey what the connection will be used for, i.e. My cellphone, Home desktop, etc.<br/>\nIf you are requesting a new profile: \n1. Leave the interface IP address blank.\n2. If the public key is left blank, then a key pair will be generated and the private key will be sent to the requesting email. \n3. If the public key is provided, then the requestor must marry their private key back into the provided WireGuard configuration (replacing the one provided).\n\nIf you are making a request on an existing profile:\n1. Include both the interface IP address and the public key of the existing profile.\n2. When the WireGuard configuration is received via email, append the peer configuration to the existing WireGuard profile.\n\n<hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the recipient email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-applyemailaddress=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the requesting email address",
      "max_length": "$email_max_len",
      "regex": {
        "pattern": "$email_regex",
        "description": "$email_text_description"
      },
      "required": true,
      "param": "-requestemailaddress=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a description",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "param": "-description=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Request public internet IP masquerade?",
      "required": true,
      "param": "-requestinternet=",
      "same_arg_param": true,
      "type": "list",
      "default": "No",
      "values": [
        "Yes",
        "No"
      ],
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the interface IP address",
      "required": false,
      "param": "-ipaddress=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the public key",
      "required": false,
      "param": "-publickey=",
      "same_arg_param": true,
      "type": "text",
      "max_length": "44",
      "regex": {
        "pattern": "^[A-Za-z0-9+/]{42}[AEIMQUYcgkosw480]=\$",
        "description": "Must be a valid WireGuard key"
      },
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/applyHSVPNPrimaryConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

lecertsubs=\$(getArgumentValue lecertsubs "\$@")

set +e
sendOtherNetworkApplyHomeServerVPNConfig "na" true "\$lecertsubs"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/applyHSVPNPrimaryConnection.json
{
  "name": "04 Primary VPN Application",
  "script_path": "conf/scripts/applyHSVPNPrimaryConnection.sh",
  "description": "Generates a HomeServer primary VPN application. [Need Help?](https://forum.homeserverhq.com/)<br/>![HSHQ-ApplyJoin.png](/img/HSHQ-ApplyJoin.png)A primary VPN connection will allow you to host selected services as well as route your email. This function is specifically for joining a pre-existing network managed by someone you know and trust. You must point the DNS records on the domain name provider for your domain to the RelayServer of this network. Upon execution, you will receive the application in your admin mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). Since this is your primary VPN, which will route your email, you will have to use other means to send the application. There is nothing confidential in the application, it can be safely transmitted on any 3rd party medium (i.e. a centralized email provider, etc.). Upon approval, you will need to obtain the join invitation from the administrator of the network which you are applying (perhaps through the same means with which this application is transferred). Go to the Join Network function with the invitation to finalize the connection.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the LE cert subdomains",
      "required": true,
      "param": "-lecertsubs=",
      "same_arg_param": true,
      "type": "text",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9.-]*\\\\.[a-zA-Z]{2,}(,[a-z0-9][a-z0-9.-]*\\\\.[a-zA-Z]{2,})*\$",
        "description": "Comma-separated - only lowercase, numbers, hyphens, periods"
      },
      "default": "$(getLetsEncryptCertsDefault)",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/joinNetwork.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "\$myjoincnf" > \$HOME/join_hsv.cnf
performNetworkJoin true \$HOME/join_hsv.cnf
rm -f \$HOME/join_hsv.cnf

set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/joinNetwork.json
{
  "name": "05 Join Network",
  "script_path": "conf/scripts/joinNetwork.sh",
  "description": "Joins a network via a provided configuration. [Need Help?](https://forum.homeserverhq.com/)<br/>![HSHQ-ApplyJoin.png](/img/HSHQ-ApplyJoin.png)This is the third and final step in establishing a connection with a private network. This function can be used for either a HomeServer VPN or HomeServer Internet connection. Paste the contents of the invitation you received via email into the corresponding field below. The private key that was generated during the application step will be automatically married back into this configuration based on the request ID.<br/><br/>Ensure to review the details of the invitation, specifically the email sender. You should <ins>***NEVER***</ins> just paste and execute an invitation from someone that you do not know and trust. There are safeguards that will help mitigate spoofing, but nothing is ever guaranteed.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the invitation",
      "required": true,
      "type": "multiline_text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "myjoincnf"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/disconnectVPNConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")

set +e
dis_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
disconnectOtherNetworkHomeServerVPNConnection \$dis_id "\$mydisreason"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/disconnectVPNConnection.json
{
  "name": "06 Disconnect VPN Connection",
  "script_path": "conf/scripts/disconnectVPNConnection.sh",
  "description": "Disconnect a HomeServer VPN connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The reason for disconnecting will be emailed to the manager of the network.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='homeserver_vpn' and NetworkType='other' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a reason for disconnecting",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "mydisreason"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/disconnectInternetConnection.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selconnection=\$(getArgumentValue selconnection "\$@")

set +e
dis_id="\$(echo \$selconnection | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"
disconnectOtherNetworkHomeServerInternetConnection "\$dis_id" "\$mydisreason"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/disconnectInternetConnection.json
{
  "name": "07 Disconnect Int Connection",
  "script_path": "conf/scripts/disconnectInternetConnection.sh",
  "description": "Disconnect a HomeServer internet connection. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>The reason for disconnecting will be emailed to the manager of the network.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select connection",
      "required": true,
      "param": "-selconnection=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',Name from connections where ConnectionType='homeserver_internet' and NetworkType='other' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter a reason for disconnecting",
      "max_length": "$long_reason_max_len",
      "regex": {
        "pattern": "$long_reason_regex",
        "description": "$long_reason_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 4,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "mydisreason"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/updateHomeServerDNS.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Updating HomeServer DNS..."
echo "\$mydnsconf" > \$HOME/dns.tmp
updateHomeServerDNS \$HOME/dns.tmp
rm -f \$HOME/dns.tmp
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/updateHomeServerDNS.json
{
  "name": "08 Update HomeServer DNS",
  "script_path": "conf/scripts/updateHomeServerDNS.sh",
  "description": "Update HomeServer DNS. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to update the DNS records for servers on other networks on which you are hosting. You do not need to use this for changes to your network, only changes to other networks. You should receive notices to update via email. Paste the indicated section within the email into the DNS config field below.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter DNS config",
      "required": true,
      "type": "multiline_text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "env_variable",
      "env_var": "mydnsconf"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/syncAdguardDNS.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Sync Adguard DNS server from database..."
syncAdguardDNSFromDB
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/syncAdguardDNS.json
{
  "name": "09 Sync Adguard DNS Server",
  "script_path": "conf/scripts/syncAdguardDNS.sh",
  "description": "Sync Adguard DNS server from database. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function sychronizes the DNS records from the database to the primary DNS server (Adguard). This should rarely if ever be needed. However, if you accidentally make changes to your Adguard server, or perhaps some other unforeseen circumstance, then this can restore back to the correct values.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_othernetworks",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  # 08 RelayServer Utils
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addDomainToRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

adddomain=\$(getArgumentValue adddomain "\$@")
mailsubdomain=\$(getArgumentValue mailsubdomain "\$@")
ms_id="\$(echo \$mailsubdomain | cut -d ')' -f1 | sed 's/(//g' | sed 's/ //g')"

set +e
echo "Adding \$adddomain with ID: \$ms_id"
addSecondaryDomainToRelayServer "\$adddomain" "\$ms_id"
retVal=\$?
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addDomainToRelayServer.json
{
  "name": "01 Add Secondary Domain",
  "script_path": "conf/scripts/addDomainToRelayServer.sh",
  "description": "Adds a new secondary domain to the RelayServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will add the domain entered below to the RelayServer. It will forward the mail sent to this domain to the selected mail subdomain, and configure the internal DNS records to point to the same corresponding HomeServer. Only HomeServers that use this network as their primary network can be selected.<br/>\nAdding a secondary domain requires three steps:\n1. Add the domain using <ins>this</ins> function. Upon execution, the DNS info will be sent to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS).\n2. Using the DNS info from Step 1, update the DNS records at the domain name provider for the new domain.\n3. Add the domain to Mailu, in order to send/receive email on this domain. Using Mailu web interface: Sign in Admin -> Mail domains (left sidebar) -> New domain (top right corner).\n\n<hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter domain name",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9.-]*\\\\.[a-z]{2,}\$",
        "description": "Only lowercase, numbers, hyphens, periods"
      },
      "required": true,
      "param": "-adddomain=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select the internal mail subdomain",
      "required": true,
      "param": "-mailsubdomain=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select '(',ID,') ',MailHost from mailhosts order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeDomainFromRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

seldomain=\$(getArgumentValue seldomain "\$@")

dom_only="\$(echo \$seldomain | cut -d '(' -f1 | sed 's/ //g')"

set +e
echo "Removing \$dom_only..."
removeSecondaryDomainFromRelayServer "\$dom_only"
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeDomainFromRelayServer.json
{
  "name": "02 Remove Secondary Domain",
  "script_path": "conf/scripts/removeDomainFromRelayServer.sh",
  "description": "Removes a secondary domain from the RelayServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This will also remove any LetsEncrypt paths and exposed (sub)domains on this domain as well.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter domain name",
      "required": true,
      "param": "-seldomain=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select Domain,' (',MailHost,')' from mailhostmap join mailhosts on mailhostmap.MailHostID = mailhosts.ID where IsFirstDomain=false order by mailhostmap.MailHostID;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addLEDomainToRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

adddomain=\$(getArgumentValue adddomain "\$@")
basedom=\$(getArgumentValue basedom "\$@")

is_err=false
if [ -z "\$adddomain" ]; then
  add_domain="\$basedom"
else
  if ! [ \$(checkValidString "\$adddomain" "-") = "false" ]; then
    add_domain="\$adddomain.\$basedom"
  else
    echo "ERROR: Invalid subdomain name"
    is_err=true
  fi
fi
if [ "\$is_err" = "false" ]; then
  set +e
  echo "Adding LetsEncrypt subdomain..."
  addLECertPathsToRelayServer "\$add_domain" "\$basedom"
  retVal=\$?
else
  retVal=2
fi
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addLEDomainToRelayServer.json
{
  "name": "03 Add LE Subdomain",
  "script_path": "conf/scripts/addLEDomainToRelayServer.sh",
  "description": "Add subdomain to be managed by LetsEncrypt. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Due to certificate trust chain issues with certain apps, typically mobile apps, there are particular cases where a service needs to serve a certificate chain that is signed by a non-custom Root CA. This function will add the requisite forwarding path on the RelayServer for a LetsEncrypt http challenge and allow the internal certificate to be managed by LetsEncrypt. There are more manual steps on the HomeServer side to fully enable LE cert management for a particular service. This function merely adds the path on the RelayServer. The services that are known to (or potentially) have these issues are already implemented by default.<br/>\nSelect the base domain, then enter only the subdomain portion in the subsequent field, i.e. without the base domain.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the base domain",
      "required": true,
      "param": "-basedom=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select Domain from mailhostmap order by MailHostID asc, IsFirstDomain desc;\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the subdomain",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]*\$",
        "description": "Only lowercase, numbers, or hyphens"
      },
      "required": true,
      "param": "-adddomain=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeLEDomainFromRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

seldomain=\$(getArgumentValue seldomain "\$@")
set +e
echo "Removing LetsEncrypt subdomain..."
removeLECertPathsFromRelayServer "\$seldomain"
retVal=\$?
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeLEDomainFromRelayServer.json
{
  "name": "04 Remove LE Subdomain",
  "script_path": "conf/scripts/removeLEDomainFromRelayServer.sh",
  "description": "Removes path for LetsEncrypt from RelayServer. [Need Help?](https://forum.homeserverhq.com/) <br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the base domain",
      "required": true,
      "param": "-basedom=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select BaseDomain from lecertdomains group by BaseDomain;\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select the (sub)domain",
      "required": true,
      "param": "-seldomain=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select Domain from lecertdomains where BaseDomain='\${Select the base domain}';\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addExposeDomainToRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

adddomain=\$(getArgumentValue adddomain "\$@")
basedom=\$(getArgumentValue basedom "\$@")

is_err=false
if [ -z "\$adddomain" ]; then
  add_domain="\$basedom"
else
  if ! [ \$(checkValidString "\$adddomain" "-") = "false" ]; then
    add_domain="\$adddomain.\$basedom"
  else
    echo "ERROR: Invalid subdomain name"
    is_err=true
  fi
fi
if [ "\$is_err" = "false" ]; then
  set +e
  echo "Adding exposed domain..."
  addExposeDomainPathsToRelayServer "\$add_domain" "\$basedom"
  retVal=\$?
else
  retVal=2
fi
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addExposeDomainToRelayServer.json
{
  "name": "05 Add Exposed Subdomain",
  "script_path": "conf/scripts/addExposeDomainToRelayServer.sh",
  "description": "Adds an exposed (sub)domain to the RelayServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to expose a particular service on your HomeServer to the public internet. <ins>***Be very careful***</ins> with this capability as it will allow anyone on the internet to access the service that you expose. It will also automatically request (free)certificates for this (sub)domain from ZeroSSL on the RelayServer upon execution. Also note that for security reasons, some services are protected behind Authelia. So you can either expose Authelia to maintain that same security wall, or move the particular service into bypass mode in the Authelia configuration.<br/>\nSelect the base domain, then enter only the subdomain portion in the provided field below (all lowercase), i.e. www, filebrowser, etc. If the subdomain field is left blank, then the base domain will be added (you will need the base domain added if exposing Mastodon and/or Matrix (Synapse) for federation purposes).<br/>\nTo figure out what the subdomain is for a particular service, look in the address bar in your browser when accessing the service on your HomeServer. For example, if you wanted to expose Mealie, you should see https://mealie.$HOMESERVER_DOMAIN/ in the address bar, thus the subdomain is mealie.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the base domain",
      "required": true,
      "param": "-basedom=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select Domain from mailhostmap order by MailHostID asc, IsFirstDomain desc;\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter subdomain",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9-]*\$",
        "description": "Only lowercase, numbers, or hyphens"
      },
      "required": false,
      "param": "-adddomain=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeExposeDomainFromRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

seldomain=\$(getArgumentValue seldomain "\$@")
set +e
echo "Removing exposed domain..."
removeExposeDomainPathsFromRelayServer "\$seldomain"
retVal=\$?
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeExposeDomainFromRelayServer.json
{
  "name": "06 Remove Exposed Subdomain",
  "script_path": "conf/scripts/removeExposeDomainFromRelayServer.sh",
  "description": "Removes an exposed (sub)domain from RelayServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the base domain",
      "required": true,
      "param": "-basedom=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select BaseDomain from exposedomains group by BaseDomain;\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select the (sub)domain",
      "required": true,
      "param": "-seldomain=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select Domain from exposedomains where BaseDomain='\${Select the base domain}';\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/resetCaddyDNSRelayServer.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

set +e
echo "Resetting Caddy data on RelayServer..."
resetCaddyDataRelayServer false
set -e
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/resetCaddyDNSRelayServer.json
{
  "name": "07 Reset Caddy Data",
  "script_path": "conf/scripts/resetCaddyDNSRelayServer.sh",
  "description": "Reset Caddy data on RelayServer. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Clears out all data for the RelayServer Caddy instance and restarts the stack. This should only be used as a last resort if you encountering continual issues that do not resolve after restarting the stack. Note that this will delete all existing data and certificates in Caddy, which includes those obtained externally from ZeroSSL. Running this function too many times could result in a rate limit.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addPortForwardRule.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

pfName=\$(getArgumentValue pfName "\$@")
pfExtStart=\$(getArgumentValue pfExtStart "\$@")
pfExtEnd=\$(getArgumentValue pfExtEnd "\$@")
pfIntStart=\$(getArgumentValue pfIntStart "\$@")
pfIntEnd=\$(getArgumentValue pfIntEnd "\$@")
pfProtocol=\$(getArgumentValue pfProtocol "\$@")
pfInternalHost=\$(getArgumentValue pfInternalHost "\$@")
pfIPAddress=\$(getArgumentValue pfIPAddress "\$@")

set +e
echo "Adding port forwarding rule (\$pfName)..."
strRes=\$(addPortForwardingRule "\$pfName" \$pfExtStart \$pfExtEnd \$pfIntStart \$pfIntEnd \$pfProtocol "\$pfInternalHost" "\$pfIPAddress")
retVal=\$?
if [ \$retVal -ne 0 ]; then
  echo "ERROR: \$strRes"
fi
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addPortForwardRule.json
{
  "name": "08 Add Port Forwarding Rule",
  "script_path": "conf/scripts/addPortForwardRule.sh",
  "description": "Adds a port forwarding rule. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function adds a port forwarding rule to the RelayServer. This will forward any packets arriving at the RelayServer to the selected internal host on the selected port or range of ports.<br/><br/>If only a single port, then use the same value for Start and End. External is the value(s) which the RelayServer will listen on, and Internal is the mapped ports on the internal host. If a range of ports, then the SIZE of the range must be the same for both External and Internal (the start and end values between External and Internal CAN be diffferent).<br/><br/>For the destination IP, you can either select from the internal domain list (as a convenience) or manually enter the IP address. If there is a non-zero value for the IP address, then the selected internal domain will be entirely ignored. If manually entering the IP address, it must be inside your VPN subnet range.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter rule name",
      "regex": {
        "pattern": "^[a-zA-Z0-9][a-zA-Z0-9-]*\$",
        "description": "Only letters, numbers, or hyphens"
      },
      "required": true,
      "param": "-pfName=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select Protocol (tcp/udp/both)",
      "required": true,
      "param": "-pfProtocol=",
      "same_arg_param": true,
      "type": "list",
      "default": "both",
      "values": [
        "tcp",
        "udp",
        "both"
      ],
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter External Start Port",
      "required": true,
      "param": "-pfExtStart=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "",
      "min": "1",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter External End Port",
      "required": true,
      "param": "-pfExtEnd=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2
      },
      "default": "",
      "min": "1",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select the destination internal domain",
      "required": false,
      "param": "-pfInternalHost=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select ID,'-',DomainName from hsvpn_connections where IsPrimary=true;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter Internal Start Port",
      "required": true,
      "param": "-pfIntStart=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2
      },
      "default": "",
      "min": "1",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter Internal End Port",
      "required": true,
      "param": "-pfIntEnd=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "",
      "min": "1",
      "max": "65535",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter destination IP address",
      "required": false,
      "param": "-pfIPAddress=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "default": "0.0.0.0",
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removePortForwardRule.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

pfRemRule=\$(getArgumentValue pfRemRule "\$@")
pfRemID=\$(echo "\$pfRemRule" | cut -d"-" -f1)

set +e
echo "Removing port forwarding rule (\$pfRemRule)..."
strRes=\$(removePortForwardingRule \$pfRemID)

retVal=\$?
if [ \$retVal -ne 0 ]; then
  echo "ERROR: \$strRes"
fi
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removePortForwardRule.json
{
  "name": "09 Remove Port Forwarding Rule",
  "script_path": "conf/scripts/removePortForwardRule.sh",
  "description": "Removes a port forwarding rule. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function removes the selected port forwarding rule from the RelayServer.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the rule to remove",
      "required": false,
      "param": "-pfRemRule=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select ID,'-',Name,' (',ExtStart,'-',ExtEnd,'/',Protocol,')' from portforwarding where PFType='User' order by ID asc;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/displayAllPortforwards.sh
#!/bin/bash

source $HSHQ_LIB_SCRIPT lib

echo "  | ID | PFType | Name | ExtStart | ExtEnd | IntStart | IntEnd | Protocol | InternalHost | IPAddress | LastUpdated |"
echo "---------------------------------------------------------------------------------------"
sqlite3 -separator " | " \$HSHQ_DB "select ' ',ID,PFType,Name,ExtStart,ExtEnd,IntStart,IntEnd,Protocol,InternalHost,IPAddress,LastUpdated,' ' from portforwarding order by ID;"
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/displayAllPortforwards.json
{
  "name": "10 Display Port Forwarding Rules",
  "script_path": "conf/scripts/displayAllPortforwards.sh",
  "description": "Display all port forwarding rules. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function outputs all port forwarding rules and System Reserved ports on the RelayServer to the console.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver"
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/emailDNSRecords.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

dnsdomain=\$(getArgumentValue dnsdomain "\$@")
rs_external_ip=\$(getArgumentValue rs_external_ip "\$@")

# This is a bit hackish, we need to save the current
# RelayServer IP, and then restore it back. It is likely
# unneccesary, due to the life of the variable, but we'll
# do it anyways.
cur_RSIP=\$RELAYSERVER_SERVER_IP
RELAYSERVER_SERVER_IP=\$rs_external_ip
if [ -z "\$EXT_DOMAIN_PREFIX" ]; then
  EXT_DOMAIN_PREFIX=external
fi
if [ -z "\$RELAYSERVER_EXT_EMAIL_HOSTNAME" ]; then
  RELAYSERVER_EXT_EMAIL_HOSTNAME=\$SUB_POSTFIX.\$EXT_DOMAIN_PREFIX.\$HOMESERVER_DOMAIN
fi
sendDNSRecordsEmail \$dnsdomain
RELAYSERVER_SERVER_IP=\$cur_RSIP
performExitFunctions false

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/emailDNSRecords.json
{
  "name": "11 Email DNS Records",
  "script_path": "conf/scripts/emailDNSRecords.sh",
  "description": "Email DNS records to manager. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function will email the DNS records for the indicated domain and IP to the email manager's mailbox ($EMAIL_ADMIN_EMAIL_ADDRESS). It will also contain a DNS Zone file attachement, which is compatible with most DNS providers.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_relayserver",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter the domain name",
      "regex": {
        "pattern": "^[a-z0-9][a-z0-9.-]*\\\\.[a-z]{2,}\$",
        "description": "Only lowercase, numbers, hyphens, periods"
      },
      "required": true,
      "param": "-dnsdomain=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "$HOMESERVER_DOMAIN",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter the RelayServer IP",
      "required": true,
      "param": "-rs_external_ip=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  # 09 Home Network
  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/displayAllHomeServerHostInterfaces.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_LIB_SCRIPT lib

set +e
outputAllNetworkInterfaces
retVal=\$?
set -e
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/displayAllHomeServerHostInterfaces.json
{
  "name": "01 Display Host Interfaces",
  "script_path": "conf/scripts/displayAllHomeServerHostInterfaces.sh",
  "description": "Displays all network interface on host. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function displays all of the network interfaces on the host system. It will not show Docker network or HSHQ-based WireGuard interfaces, but will display everything else. You can use this function to obtain the exact name of an interface that you may want to add.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": []
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addHomeServerHostInterface.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

addinterface=\$(getArgumentValue addinterface "\$@")
createcaddy=\$(getArgumentValue createcaddy "\$@")
if [ "\$createcaddy" = "Yes" ]; then
  isCaddy=true
else
  isCaddy=false
fi
set +e
echo "Adding host interface \$addinterface..."
checkUpdateHostInterface add \$addinterface true false \$isCaddy
retVal=\$?
set -e
performExitFunctions false
sleep 3
if [ \$retVal -eq 0 ]; then
  sudo systemctl restart runScriptServer
fi

exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addHomeServerHostInterface.json
{
  "name": "02 Add Host Interface",
  "script_path": "conf/scripts/addHomeServerHostInterface.sh",
  "description": "Add network interface on host. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function adds a network interface on the host to be managed by the HSHQ firewall. It will also generate a (Caddy) reverse proxy instance (if selected) to serve its respective network specifically on this interface. The interface of the default route has already been added. This function is to add any additional adapters or connections.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter interface name",
      "max_length": "15",
      "regex": {
        "pattern": "^[a-zA-Z0-9][a-zA-Z0-9.-]{0,15}\$",
        "description": "Letters, numbers, and/or .-"
      },
      "required": true,
      "param": "-addinterface=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Create Caddy Instance?",
      "required": true,
      "param": "-createcaddy=",
      "same_arg_param": true,
      "type": "list",
      "default": "Yes",
      "values": [
        "Yes",
        "No"
      ],
      "ui": {
        "width_weight": 2
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/editHomeServerHostInterface.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selinterface=\$(getArgumentValue selinterface "\$@")
selinterface=\$(echo "\$selinterface" | cut -d" " -f1 | xargs)
selaction=\$(getArgumentValue selaction "\$@")

ipaddr=\$(getArgumentValue ipaddr "\$@")
cidrlen=\$(getArgumentValue cidrlen "\$@")
selgateway=\$(getArgumentValue selgateway "\$@")
selmethod=\$(getArgumentValue selmethod "\$@")
ssid=\$(getArgumentValue ssid "\$@")
wifipass=\$(getArgumentValue wifipass "\$@")

isReplace=false
if [ "\$selmethod" = "Replace Netplan Entry" ]; then
  isReplace=true
fi

set +e
retVal=0

case "\$selaction" in
  "Display Info")
      echo "Displaying info for \$selinterface..."
      echo -e "\$(outputInterfaceInfo \$selinterface)"
    ;;
  "Set As Primary Interface")
      echo "Setting \$selinterface as primary interface..."
      checkUpdateHostInterface setisprimary \$selinterface true true na
    ;;
  "Enable Expose To Network")
      echo "Enabling \$selinterface to be exposed to network..."
      checkUpdateHostInterface setisexpose \$selinterface true na true
    ;;
  "Disable Expose To Network")
      echo "DIsabling \$selinterface from being exposed to network..."
      checkUpdateHostInterface setisexpose \$selinterface true na false
    ;;
  "Display Netplan")
      sudo netplan get
      echo ""
    ;;
  "Set As Wired DHCP")
      echo "Setting \$selinterface as wired DHCP..."
      setAsWiredDHCP "\$selinterface" "\$isReplace"
    ;;
  "Set As Wired Static IP")
      echo "Setting \$selinterface as wired static IP..."
      setAsWiredStaticIP "\$selinterface" "\$isReplace" "\$ipaddr" "\$cidrlen" "\$selgateway"
    ;;
  "Set As Wireless DHCP")
      echo "Setting \$selinterface as wireless DHCP..."
      setAsWirelessDHCP "\$selinterface" "\$isReplace" "\$ssid" "\$wifipass"
    ;;
  "Set As Wireless Static IP")
      echo "Setting \$selinterface as wireless static IP..."
      setAsWirelessStaticIP "\$selinterface" "\$isReplace" "\$ipaddr" "\$cidrlen" "\$selgateway" "\$ssid" "\$wifipass"
    ;;
  "Remove From Netplan")
      echo "Removing \$selinterface from netplan..."
      removeFromNetplan "\$selinterface"
    ;;
  "Display Wifi Networks")
      echo "Displaying wifi networks for \${selinterface}..."
      displayWifiNetworks "\$selinterface"
    ;;
  "Add/Update Wifi Access Point")
      echo "Adding/Updating wifi access point on \${selinterface}..."
      addUpdateWifiAccessPoint "\$selinterface" "\$ssid" "\$wifipass"
    ;;
  "Remove Wifi Access Point")
      echo "Removing wifi access point from \${selinterface}..."
      removeWifiAccessPoint "\$selinterface" "\$ssid"
    ;;
  *)
      echo "Unknown: \$selaction"
    ;;
esac
retVal=\$?
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/editHomeServerHostInterface.json
{
  "name": "03 Edit Host Interface",
  "script_path": "conf/scripts/editHomeServerHostInterface.sh",
  "description": "Edit a HomeServer host interface. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to edit a particular host interface. There are numerous actions that can be performed on a particular interface, and some actions require parameters that are available below the selected action.<br/><br/>Setting an interface as primary will determine what IP address the DNS records point to, as well as the ip-based links on the home page.<br/><br/>Enabling/Disabling Expose to Network allows the selected ports to be accessible/inaccessible for the corresponding network. The use case for this is that your HomeServer might be on a hostile network locally, and you don't want to expose your services to that network. Be careful changing this setting, as it could disable your access to any and all services.<br/><br/>Setting an interface (wired or wireless) to a static IP requires an IP address, CIDR length, and gateway. When setting up a new wireless interface, you must also provide an initial network SSID (and password, if applicable).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the interface to edit",
      "required": true,
      "param": "-selinterface=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select InterfaceName,' (',ConnectionType,')' from connections where NetworkType='home_network';\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select Action",
      "required": false,
      "param": "-selaction=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": [ "Display Info", "Set As Primary Interface", "Enable Expose To Network", "Disable Expose To Network", "Display Netplan", "Set As Wired DHCP", "Set As Wired Static IP", "Set As Wireless DHCP", "Set As Wireless Static IP", "Remove From Netplan", "Display Wifi Networks", "Add/Update Wifi Access Point", "Remove Wifi Access Point" ],
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter an IP address",
      "required": false,
      "param": "-ipaddr=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": { 
        "script": "conf/scripts/getInterfaceIP.sh \"\${Select the interface to edit}\""
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "CIDR length",
      "required": false,
      "param": "-cidrlen=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2
      },
      "default": { 
        "script": "conf/scripts/getInterfaceCIDRLength.sh \"\${Select the interface to edit}\""
      },
      "min": "0",
      "max": "32",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter Gateway",
      "required": false,
      "param": "-selgateway=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": { 
        "script": "conf/scripts/getInterfaceGateway.sh \"\${Select the interface to edit}\""
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select Method",
      "required": false,
      "param": "-selmethod=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": [ "Edit Netplan Entry", "Replace Netplan Entry" ],
      "default": "Edit Netplan Entry",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "SSID Name",
      "required": false,
      "param": "-ssid=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Wireless Password",
      "required": false,
      "param": "-wifipass=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeHomeServerHostInterface.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

removeinterface=\$(getArgumentValue removeinterface "\$@")

removeinterface=\$(echo "\$removeinterface" | cut -d" " -f1 | xargs)

set +e
echo "Removing host interface (\$removeinterface)..."
checkUpdateHostInterface remove \$removeinterface true na na
retVal=\$?
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeHomeServerHostInterface.json
{
  "name": "04 Remove Host Interface",
  "script_path": "conf/scripts/removeHomeServerHostInterface.sh",
  "description": "Remove a HomeServer host interface. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function removes the selected interface from management by HSHQ processes. You cannot remove the primary interface.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the interface to remove",
      "required": false,
      "param": "-removeinterface=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select InterfaceName,' (',ConnectionType,')' from connections where NetworkType='home_network';\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/addCustomFirewallSubnet.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

ruleName=\$(getArgumentValue ruleName "\$@")
ipaddr=\$(getArgumentValue ipaddr "\$@")
cidrlen=\$(getArgumentValue cidrlen "\$@")

set +e
echo "Adding custom subnet \${ipaddr}/\${cidrlen} (\$ruleName)..."
addFirewallSubnet "\$ruleName" "\$ipaddr" "\$cidrlen"
retVal=\$?
set -e
performExitFunctions false
exit \$retVal
EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/addCustomFirewallSubnet.json
{
  "name": "05 Add Custom Subnet",
  "script_path": "conf/scripts/addCustomFirewallSubnet.sh",
  "description": "Adds a custom firewall subnet. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to add a custom subnet, which can then be selected in the 07 Edit Exposed Ports function. The use case for this is if you have any other VPN and/or networking interfaces that are not managed by HSHQ, but provide an easy means in which ports/services can be exposed to that corresponding network.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Enter rule name",
      "required": true,
      "param": "-ruleName=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Enter an IP address",
      "required": true,
      "param": "-ipaddr=",
      "same_arg_param": true,
      "type": "ip4",
      "ui": {
        "width_weight": 2
      },
      "default": "0.0.0.0",
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "CIDR length",
      "required": true,
      "param": "-cidrlen=",
      "same_arg_param": true,
      "type": "int",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": "32",
      "min": "0",
      "max": "32",
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/removeCustomFirewallSubnet.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

pfRemRule=\$(getArgumentValue pfRemRule "\$@")
pfRemID=\$(echo "\$pfRemRule" | cut -d" " -f1)

set +e
echo "Removing custom firewall subnet (\$pfRemRule)..."
removeFirewallSubnet "\$pfRemID"
retVal=\$?
if [ \$retVal -ne 0 ]; then
  echo "ERROR: \$strRes"
fi
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/removeCustomFirewallSubnet.json
{
  "name": "06 Remove Custom Subnet",
  "script_path": "conf/scripts/removeCustomFirewallSubnet.sh",
  "description": "Removes a custom firewall subnet. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>Removes a selected custom firewall subnet that was added via 05 Add Custom Subnet.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the rule to remove",
      "required": false,
      "param": "-pfRemRule=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": {
        "script": "sqlite3 $HSHQ_DB \"select ID,' (Custom) ',Name,' [',Subnet,']' from customfwsubnet;\" | sed 's/|//g'",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/editExposedPorts.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkDecrypt.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh
decryptConfigFileAndLoadEnvNoPrompts

selchain=\$(getArgumentValue selchain "\$@")
sellist=\$(getArgumentValue sellist "\$@")
selports=\$(getArgumentValue selports "\$@")

set +e
updateExposedPortsLists "\$selchain" "\$sellist" "\$selports"
retVal=\$?
set -e
performExitFunctions false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/editExposedPorts.json
{
  "name": "07 Edit Exposed Ports",
  "script_path": "conf/scripts/editExposedPorts.sh",
  "description": "Edit the exposed ports on the firewall. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to edit the exposed ports for a particular interface. The list of ports are the ones that are allowed by the firewall. If a port is added to any (non-DEFAULT) list, then it will be automatically dropped in all other cases. If a port is exposed via docker, then select the DOCKER-USER chain, otherwise select the INPUT chain. If you add your own custom docker-based service and expose a particular port not yet listed, then that port will be accessible on ALL interfaces. So specify at least one interface on which it should be exposed, thus causing it to be (safely) inaccessible on all other interfaces.<br/><br/>When specifying ports for the INPUT chain, you must also indicate the protocol(s), i.e. tcp, udp, or both. For example, if you wanted to add port 12345 for udp, then add 12345/udp to the list. All ports must be comma-separated with no spaces.<br/><br/>Ensure to refresh this page if performing multiple actions, to allow the auto-computing functions on the input fields to properly reflect the correct up-to-date info.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Enter config decrypt password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$config_stdin_prompt"
    },
    {
      "name": "Select the firewall chain",
      "required": true,
      "param": "-selchain=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "values": [ "INPUT", "DOCKER-USER" ],
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Select the list to edit",
      "required": true,
      "param": "-sellist=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "conf/scripts/getExposedPortsVariablesLists.sh \${Select the firewall chain}",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    },
    {
      "name": "Exposed Ports",
      "regex": {
        "pattern": "^[0-9]{1,5}(:[0-9]{1,5})?(/(tcp|udp|both))?(,[0-9]{1,5}(:[0-9]{1,5})?(/(tcp|udp|both))?)*\$",
        "description": "Only valid ports or port ranges with protocol"
      },
      "required": false,
      "param": "-selports=",
      "same_arg_param": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "default": {
        "script": "conf/scripts/getExposedPortsByVariableName.sh \"\${Select the firewall chain}\" \"\${Select the list to edit}\"",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/resetFirewall.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_LIB_SCRIPT lib
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

set +e
source <(sudo cat \$HSHQ_PLAINTEXT_ROOT_CONFIG)
tgLock="\$(tryGetLock hshqopen ResetFirewall)"
if ! [ "\$tgLock" = "true" ]; then
  checkRes="\$(getLockOpenMsg hshqopen)"
  echo "The HSHQ script is running in another instance (\$checkRes), returning..."
  return
fi
echo "Clearing iptables..."
performClearIPTables true
echo "Adding rules to iptables..."
checkUpdateAllIPTables resetFirewall
echo "Reset firewall complete!"
retVal=\$?
releaseLock hshqopen "resetFirewall" false
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/resetFirewall.json
{
  "name": "08 Reset Firewall",
  "script_path": "conf/scripts/resetFirewall.sh",
  "description": "Clears and restores firewall. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function flushes and restores certain parts of the firewall, i.e. iptables. It does not affect all of the chains/tables, only the raw table, and the INPUT and DOCKER-USER chains in the filter table.<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    }
  ]
}

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/scripts/setHostInternetWGInterface.sh
#!/bin/bash

source $HSHQ_STACKS_DIR/script-server/conf/scripts/argumentUtils.sh
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkPass.sh
source $HSHQ_LIB_SCRIPT lib
source $HSHQ_STACKS_DIR/script-server/conf/scripts/checkHSHQOpenStatus.sh

selinterface=\$(getArgumentValue selinterface "\$@")
set +e

echo "Setting host internet traffic interface to \${selinterface}..."
setHostInternetTrafficWGInterface "\$selinterface"
retVal=\$?
echo "Finished!"
exit \$retVal

EOFSC

  cat <<EOFSC > $HSHQ_STACKS_DIR/script-server/conf/runners/setHostInternetWGInterface.json
{
  "name": "09 Set Internet Traffic Interface",
  "script_path": "conf/scripts/setHostInternetWGInterface.sh",
  "description": "Sets the interface for internet-bound host traffic. [Need Help?](https://forum.homeserverhq.com/)<br/><br/>This function allows you to route internet-bound traffic on the HomeServer host via any WireGuard interfaces. When you set up your own RelayServer, a connection is set up for you by default. Select the WireGuard interface from the list below, or select default to use the normal default route(s).<br/><br/><hr width=\"100%\" size=\"3\" color=\"white\">",
  "group": "$group_id_homenetwork",
  "parameters": [
    {
      "name": "Enter sudo password",
      "max_length": "$password_max_len",
      "regex": {
        "pattern": "$password_regex",
        "description": "$password_text_description"
      },
      "required": true,
      "type": "text",
      "ui": {
        "width_weight": 2,
        "separator_before": {
          "type": "new_line"
        }
      },
      "secure": true,
      "pass_as": "stdin",
      "stdin_expected_text": "$sudo_stdin_prompt"
    },
    {
      "name": "Select the WireGuard interface",
      "required": false,
      "param": "-selinterface=",
      "same_arg_param": true,
      "type": "list",
      "ui": {
        "width_weight": 2
      },
      "values": {
        "script": "conf/scripts/getWGInternetTrafficInterfaces.sh",
        "shell": true
      },
      "secure": false,
      "pass_as": "argument"
    }
  ]
}

EOFSC

  # Also need to add transfer primary VPN function

  # Set permissions
  chmod 700 $HSHQ_STACKS_DIR/script-server/conf/scripts/*
  chmod 600 $HSHQ_STACKS_DIR/script-server/conf/runners/*
}

function moveScriptServerPerformUpdate
{
  if [ -f $HSHQ_STACKS_DIR/script-server/conf/scripts/performUpdateHSHQ-New.sh ]; then
    mv $HSHQ_STACKS_DIR/script-server/conf/scripts/performUpdateHSHQ-New.sh $HSHQ_STACKS_DIR/script-server/conf/scripts/performUpdateHSHQ.sh
  fi
}

function cleanupScriptServerLogs()
{
  # This cleans up any private info that is output during the Hosted VPN setup process
  rm -f $HSHQ_STACKS_DIR/script-server/logs/processes/14_Set_Up_Hosted_VPN*
}

function outputStackListsScriptServer()
{
  echo ${HSHQ_REQUIRED_STACKS},${HSHQ_OPTIONAL_STACKS} | sed "s|,|\n|g" > $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_FULL_STACKLIST_FILENAME
  sort -o $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_FULL_STACKLIST_FILENAME $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_FULL_STACKLIST_FILENAME
  echo ${HSHQ_OPTIONAL_STACKS} | sed "s|,|\n|g" > $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME
  sort -o $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_OPTIONAL_STACKLIST_FILENAME
  echo $(getStacksToUpdate) | sed "s|,|\n|g" > $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_UPDATE_STACKLIST_FILENAME
  sort -o $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_UPDATE_STACKLIST_FILENAME $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_UPDATE_STACKLIST_FILENAME

  redislist=($(find $HSHQ_NONBACKUP_DIR/ -maxdepth 2 -type d -name redis | sort))
  rm -f $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_REDIS_STACKLIST_FILENAME
  touch $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_REDIS_STACKLIST_FILENAME
  for curdir in "${redislist[@]}"
  do
    echo $(echo "$curdir" | rev | cut -d"/" -f2 | rev) >> $HSHQ_STACKS_DIR/script-server/conf/$SCRIPTSERVER_REDIS_STACKLIST_FILENAME
  done
}

# SQLPad
function installSQLPad()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory sqlpad "SQLPad"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $(getScriptImageByContainerName sqlpad)
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/sqlpad
  initServicesCredentials
  SQLPAD_PASSPHRASE=$(pwgen -c -n 64 1)
  generateCert sqlpad sqlpad
  outputConfigSQLPad
  installStack sqlpad sqlpad "Welcome to SQLPad" $HOME/sqlpad.env 5
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_SQLPAD.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://sqlpad:3000 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_SQLPAD $MANAGETLS_SQLPAD "$is_integrate_hshq" $NETDEFAULT_SQLPAD "$inner_block"
  if ! [ "$is_integrate_hshq" = "false" ]; then
    insertEnableSvcAll sqlpad "$FMLNAME_SQLPAD" $USERTYPE_SQLPAD "https://$SUB_SQLPAD.$HOMESERVER_DOMAIN" "sqlpad.png" "$(getHeimdallOrderFromSub $SUB_SQLPAD $USERTYPE_SQLPAD)"
    restartAllCaddyContainers
  fi
}

function outputConfigSQLPad()
{
  cat <<EOFSP > $HOME/sqlpad-compose.yml
$STACK_VERSION_PREFIX sqlpad $(getScriptStackVersion sqlpad)

services:
  sqlpad:
    image: $(getScriptImageByContainerName sqlpad)
    container_name: sqlpad
    hostname: sqlpad
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-dbs-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/sqlpad.crt:/certs/sqlpad.crt
      - \${HSHQ_SSL_DIR}/sqlpad.key:/certs/sqlpad.key
      - \${HSHQ_STACKS_DIR}/sqlpad:/var/lib/sqlpad

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-dbs-net:
    name: dock-dbs
    external: true
EOFSP

  cat <<EOFSP > $HOME/sqlpad.env
SQLPAD_ADMIN=$SQLPAD_ADMIN_USERNAME
SQLPAD_ADMIN_PASSWORD=$SQLPAD_ADMIN_PASSWORD
SQLPAD_APP_LOG_LEVEL=info
SQLPAD_WEB_LOG_LEVEL=info
SQLPAD_ALLOW_CSV_DOWNLOAD=true
SQLPAD_EDITOR_WORD_WRAP=false
SQLPAD_HTTPS_CERT_PATH=/certs/sqlpad.crt
SQLPAD_HTTPS_KEY_PATH=/certs/sqlpad.key
SQLPAD_PASSPHRASE=$SQLPAD_PASSPHRASE
SQLPAD_CONNECTIONS__aistack-mindsdb__name=MindsDB
SQLPAD_CONNECTIONS__aistack-mindsdb__driver=postgres
SQLPAD_CONNECTIONS__aistack-mindsdb__host=aistack-mindsdb-db
SQLPAD_CONNECTIONS__aistack-mindsdb__database=$AISTACK_MINDSDB_DATABASE_NAME
SQLPAD_CONNECTIONS__aistack-mindsdb__username=$AISTACK_MINDSDB_DATABASE_USER
SQLPAD_CONNECTIONS__aistack-mindsdb__password=$AISTACK_MINDSDB_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__aistack-mindsdb__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__aistack-mindsdb__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__aistack-langfuse__name=Langfuse
SQLPAD_CONNECTIONS__aistack-langfuse__driver=postgres
SQLPAD_CONNECTIONS__aistack-langfuse__host=aistack-mindsdb-db
SQLPAD_CONNECTIONS__aistack-langfuse__database=$AISTACK_LANGFUSE_DATABASE_NAME
SQLPAD_CONNECTIONS__aistack-langfuse__username=$AISTACK_MINDSDB_DATABASE_USER
SQLPAD_CONNECTIONS__aistack-langfuse__password=$AISTACK_MINDSDB_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__aistack-langfuse__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__aistack-langfuse__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__discourse__name=Discourse
SQLPAD_CONNECTIONS__discourse__driver=postgres
SQLPAD_CONNECTIONS__discourse__host=discourse-db
SQLPAD_CONNECTIONS__discourse__database=$DISCOURSE_DATABASE_NAME
SQLPAD_CONNECTIONS__discourse__username=$DISCOURSE_DATABASE_USER
SQLPAD_CONNECTIONS__discourse__password=$DISCOURSE_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__discourse__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__discourse__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__espocrm__name=EspoCRM
SQLPAD_CONNECTIONS__espocrm__driver=mysql
SQLPAD_CONNECTIONS__espocrm__host=espocrm-db
SQLPAD_CONNECTIONS__espocrm__database=$ESPOCRM_DATABASE_NAME
SQLPAD_CONNECTIONS__espocrm__username=$ESPOCRM_DATABASE_USER
SQLPAD_CONNECTIONS__espocrm__password=$ESPOCRM_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__espocrm__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__espocrm__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__firefly__name=Firefly
SQLPAD_CONNECTIONS__firefly__driver=postgres
SQLPAD_CONNECTIONS__firefly__host=firefly-db
SQLPAD_CONNECTIONS__firefly__database=$FIREFLY_DATABASE_NAME
SQLPAD_CONNECTIONS__firefly__username=$FIREFLY_DATABASE_USER
SQLPAD_CONNECTIONS__firefly__password=$FIREFLY_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__firefly__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__firefly__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__freshrss__name=FreshRSS
SQLPAD_CONNECTIONS__freshrss__driver=postgres
SQLPAD_CONNECTIONS__freshrss__host=freshrss-db
SQLPAD_CONNECTIONS__freshrss__database=$FRESHRSS_DATABASE_NAME
SQLPAD_CONNECTIONS__freshrss__username=$FRESHRSS_DATABASE_USER
SQLPAD_CONNECTIONS__freshrss__password=$FRESHRSS_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__freshrss__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__freshrss__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__ghost__name=Ghost
SQLPAD_CONNECTIONS__ghost__driver=mysql
SQLPAD_CONNECTIONS__ghost__host=ghost-db
SQLPAD_CONNECTIONS__ghost__database=$GHOST_DATABASE_NAME
SQLPAD_CONNECTIONS__ghost__username=$GHOST_DATABASE_USER
SQLPAD_CONNECTIONS__ghost__password=$GHOST_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__ghost__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__ghost__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__gitea__name=Gitea
SQLPAD_CONNECTIONS__gitea__driver=postgres
SQLPAD_CONNECTIONS__gitea__host=gitea-db
SQLPAD_CONNECTIONS__gitea__database=$GITEA_DATABASE_NAME
SQLPAD_CONNECTIONS__gitea__username=$GITEA_DATABASE_USER
SQLPAD_CONNECTIONS__gitea__password=$GITEA_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__gitea__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__gitea__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__gitlab__name=Gitlab
SQLPAD_CONNECTIONS__gitlab__driver=postgres
SQLPAD_CONNECTIONS__gitlab__host=gitlab-db
SQLPAD_CONNECTIONS__gitlab__database=$GITLAB_DATABASE_NAME
SQLPAD_CONNECTIONS__gitlab__username=$GITLAB_DATABASE_USER
SQLPAD_CONNECTIONS__gitlab__password=$GITLAB_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__gitlab__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__gitlab__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__guacamole__name=Guacamole
SQLPAD_CONNECTIONS__guacamole__driver=mysql
SQLPAD_CONNECTIONS__guacamole__host=guacamole-db
SQLPAD_CONNECTIONS__guacamole__database=$GUACAMOLE_DATABASE_NAME
SQLPAD_CONNECTIONS__guacamole__username=$GUACAMOLE_DATABASE_USER
SQLPAD_CONNECTIONS__guacamole__password=$GUACAMOLE_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__guacamole__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__guacamole__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__homeassistant__name=HomeAssistant
SQLPAD_CONNECTIONS__homeassistant__driver=postgres
SQLPAD_CONNECTIONS__homeassistant__host=homeassistant-db
SQLPAD_CONNECTIONS__homeassistant__database=$HOMEASSISTANT_DATABASE_NAME
SQLPAD_CONNECTIONS__homeassistant__username=$HOMEASSISTANT_DATABASE_USER
SQLPAD_CONNECTIONS__homeassistant__password=$HOMEASSISTANT_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__homeassistant__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__homeassistant__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__huginn__name=Huginn
SQLPAD_CONNECTIONS__huginn__driver=postgres
SQLPAD_CONNECTIONS__huginn__host=huginn-db
SQLPAD_CONNECTIONS__huginn__database=$HUGINN_DATABASE_NAME
SQLPAD_CONNECTIONS__huginn__username=$HUGINN_DATABASE_USER
SQLPAD_CONNECTIONS__huginn__password=$HUGINN_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__huginn__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__huginn__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__immich__name=Immich
SQLPAD_CONNECTIONS__immich__driver=postgres
SQLPAD_CONNECTIONS__immich__host=immich-db
SQLPAD_CONNECTIONS__immich__database=$IMMICH_DATABASE_NAME
SQLPAD_CONNECTIONS__immich__username=$IMMICH_DATABASE_USER
SQLPAD_CONNECTIONS__immich__password=$IMMICH_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__immich__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__immich__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__invidious__name=Invidious
SQLPAD_CONNECTIONS__invidious__driver=postgres
SQLPAD_CONNECTIONS__invidious__host=invidious-db
SQLPAD_CONNECTIONS__invidious__database=$INVIDIOUS_DATABASE_NAME
SQLPAD_CONNECTIONS__invidious__username=$INVIDIOUS_DATABASE_USER
SQLPAD_CONNECTIONS__invidious__password=$INVIDIOUS_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__invidious__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__invidious__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__keila__name=Keila
SQLPAD_CONNECTIONS__keila__driver=postgres
SQLPAD_CONNECTIONS__keila__host=keila-db
SQLPAD_CONNECTIONS__keila__database=$KEILA_DATABASE_NAME
SQLPAD_CONNECTIONS__keila__username=$KEILA_DATABASE_USER
SQLPAD_CONNECTIONS__keila__password=$KEILA_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__keila__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__keila__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__linkwarden__name=Linkwarden
SQLPAD_CONNECTIONS__linkwarden__driver=postgres
SQLPAD_CONNECTIONS__linkwarden__host=linkwarden-db
SQLPAD_CONNECTIONS__linkwarden__database=$LINKWARDEN_DATABASE_NAME
SQLPAD_CONNECTIONS__linkwarden__username=$LINKWARDEN_DATABASE_USER
SQLPAD_CONNECTIONS__linkwarden__password=$LINKWARDEN_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__linkwarden__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__linkwarden__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__mastodon__name=Mastodon
SQLPAD_CONNECTIONS__mastodon__driver=postgres
SQLPAD_CONNECTIONS__mastodon__host=mastodon-db
SQLPAD_CONNECTIONS__mastodon__database=$MASTODON_DATABASE_NAME
SQLPAD_CONNECTIONS__mastodon__username=$MASTODON_DATABASE_USER
SQLPAD_CONNECTIONS__mastodon__password=$MASTODON_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__mastodon__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__mastodon__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__matomo__name=Matomo
SQLPAD_CONNECTIONS__matomo__driver=mysql
SQLPAD_CONNECTIONS__matomo__host=matomo-db
SQLPAD_CONNECTIONS__matomo__database=$MATOMO_DATABASE_NAME
SQLPAD_CONNECTIONS__matomo__username=$MATOMO_DATABASE_USER
SQLPAD_CONNECTIONS__matomo__password=$MATOMO_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__matomo__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__matomo__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__matrix__name=Matrix
SQLPAD_CONNECTIONS__matrix__driver=postgres
SQLPAD_CONNECTIONS__matrix__host=matrix-db
SQLPAD_CONNECTIONS__matrix__database=$MATRIX_DATABASE_NAME
SQLPAD_CONNECTIONS__matrix__username=$MATRIX_DATABASE_USER
SQLPAD_CONNECTIONS__matrix__password=$MATRIX_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__matrix__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__matrix__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__mealie__name=Mealie
SQLPAD_CONNECTIONS__mealie__driver=postgres
SQLPAD_CONNECTIONS__mealie__host=mealie-db
SQLPAD_CONNECTIONS__mealie__database=$MEALIE_DATABASE_NAME
SQLPAD_CONNECTIONS__mealie__username=$MEALIE_DATABASE_USER
SQLPAD_CONNECTIONS__mealie__password=$MEALIE_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__mealie__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__mealie__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__nextcloud__name=Nextcloud
SQLPAD_CONNECTIONS__nextcloud__driver=postgres
SQLPAD_CONNECTIONS__nextcloud__host=nextcloud-db
SQLPAD_CONNECTIONS__nextcloud__database=$NEXTCLOUD_DATABASE_NAME
SQLPAD_CONNECTIONS__nextcloud__username=$NEXTCLOUD_DATABASE_USER
SQLPAD_CONNECTIONS__nextcloud__password=$NEXTCLOUD_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__nextcloud__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__nextcloud__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__paperless__name=Paperless
SQLPAD_CONNECTIONS__paperless__driver=postgres
SQLPAD_CONNECTIONS__paperless__host=paperless-db
SQLPAD_CONNECTIONS__paperless__database=$PAPERLESS_DATABASE_NAME
SQLPAD_CONNECTIONS__paperless__username=$PAPERLESS_DATABASE_USER
SQLPAD_CONNECTIONS__paperless__password=$PAPERLESS_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__paperless__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__paperless__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__pastefy__name=Pastefy
SQLPAD_CONNECTIONS__pastefy__driver=mysql
SQLPAD_CONNECTIONS__pastefy__host=pastefy-db
SQLPAD_CONNECTIONS__pastefy__database=$PASTEFY_DATABASE_NAME
SQLPAD_CONNECTIONS__pastefy__username=$PASTEFY_DATABASE_USER
SQLPAD_CONNECTIONS__pastefy__password=$PASTEFY_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__pastefy__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__pastefy__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__peertube__name=PeerTube
SQLPAD_CONNECTIONS__peertube__driver=postgres
SQLPAD_CONNECTIONS__peertube__host=peertube-db
SQLPAD_CONNECTIONS__peertube__database=$PEERTUBE_DATABASE_NAME
SQLPAD_CONNECTIONS__peertube__username=$PEERTUBE_DATABASE_USER
SQLPAD_CONNECTIONS__peertube__password=$PEERTUBE_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__peertube__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__peertube__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__penpot__name=Penpot
SQLPAD_CONNECTIONS__penpot__driver=postgres
SQLPAD_CONNECTIONS__penpot__host=penpot-db
SQLPAD_CONNECTIONS__penpot__database=$PENPOT_DATABASE_NAME
SQLPAD_CONNECTIONS__penpot__username=$PENPOT_DATABASE_USER
SQLPAD_CONNECTIONS__penpot__password=$PENPOT_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__penpot__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__penpot__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__photoprism__name=PhotoPrism
SQLPAD_CONNECTIONS__photoprism__driver=mysql
SQLPAD_CONNECTIONS__photoprism__host=photoprism-db
SQLPAD_CONNECTIONS__photoprism__database=$PHOTOPRISM_DATABASE_NAME
SQLPAD_CONNECTIONS__photoprism__username=$PHOTOPRISM_DATABASE_USER
SQLPAD_CONNECTIONS__photoprism__password=$PHOTOPRISM_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__photoprism__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__photoprism__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__piped__name=Piped
SQLPAD_CONNECTIONS__piped__driver=postgres
SQLPAD_CONNECTIONS__piped__host=piped-db
SQLPAD_CONNECTIONS__piped__database=$PIPED_DATABASE_NAME
SQLPAD_CONNECTIONS__piped__username=$PIPED_DATABASE_USER
SQLPAD_CONNECTIONS__piped__password=$PIPED_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__piped__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__piped__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__pixelfed__name=Pixelfed
SQLPAD_CONNECTIONS__pixelfed__driver=mysql
SQLPAD_CONNECTIONS__pixelfed__host=pixelfed-db
SQLPAD_CONNECTIONS__pixelfed__database=$PIXELFED_DATABASE_NAME
SQLPAD_CONNECTIONS__pixelfed__username=$PIXELFED_DATABASE_USER
SQLPAD_CONNECTIONS__pixelfed__password=$PIXELFED_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__pixelfed__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__pixelfed__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__shlink__name=Shlink
SQLPAD_CONNECTIONS__shlink__driver=postgres
SQLPAD_CONNECTIONS__shlink__host=shlink-db
SQLPAD_CONNECTIONS__shlink__database=$SHLINK_DATABASE_NAME
SQLPAD_CONNECTIONS__shlink__username=$SHLINK_DATABASE_USER
SQLPAD_CONNECTIONS__shlink__password=$SHLINK_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__shlink__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__shlink__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__speedtesttrackerlocal__name=$FMLNAME_SPEEDTEST_TRACKER_LOCAL
SQLPAD_CONNECTIONS__speedtesttrackerlocal__driver=postgres
SQLPAD_CONNECTIONS__speedtesttrackerlocal__host=speedtest-tracker-local-db
SQLPAD_CONNECTIONS__speedtesttrackerlocal__database=$SPEEDTEST_TRACKER_LOCAL_DATABASE_NAME
SQLPAD_CONNECTIONS__speedtesttrackerlocal__username=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER
SQLPAD_CONNECTIONS__speedtesttrackerlocal__password=$SPEEDTEST_TRACKER_LOCAL_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__speedtesttrackerlocal__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__speedtesttrackerlocal__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__speedtesttrackervpn__name=$FMLNAME_SPEEDTEST_TRACKER_VPN
SQLPAD_CONNECTIONS__speedtesttrackervpn__driver=postgres
SQLPAD_CONNECTIONS__speedtesttrackervpn__host=speedtest-tracker-vpn-db
SQLPAD_CONNECTIONS__speedtesttrackervpn__database=$SPEEDTEST_TRACKER_VPN_DATABASE_NAME
SQLPAD_CONNECTIONS__speedtesttrackervpn__username=$SPEEDTEST_TRACKER_VPN_DATABASE_USER
SQLPAD_CONNECTIONS__speedtesttrackervpn__password=$SPEEDTEST_TRACKER_VPN_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__speedtesttrackervpn__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__speedtesttrackervpn__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__vaultwarden__name=Vaultwarden
SQLPAD_CONNECTIONS__vaultwarden__driver=postgres
SQLPAD_CONNECTIONS__vaultwarden__host=vaultwarden-db
SQLPAD_CONNECTIONS__vaultwarden__database=$VAULTWARDEN_DATABASE_NAME
SQLPAD_CONNECTIONS__vaultwarden__username=$VAULTWARDEN_DATABASE_USER
SQLPAD_CONNECTIONS__vaultwarden__password=$VAULTWARDEN_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__vaultwarden__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__vaultwarden__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__wallabag__name=Wallabag
SQLPAD_CONNECTIONS__wallabag__driver=postgres
SQLPAD_CONNECTIONS__wallabag__host=wallabag-db
SQLPAD_CONNECTIONS__wallabag__database=$WALLABAG_DATABASE_NAME
SQLPAD_CONNECTIONS__wallabag__username=$WALLABAG_DATABASE_USER
SQLPAD_CONNECTIONS__wallabag__password=$WALLABAG_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__wallabag__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__wallabag__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__wikijs__name=Wikijs
SQLPAD_CONNECTIONS__wikijs__driver=postgres
SQLPAD_CONNECTIONS__wikijs__host=wikijs-db
SQLPAD_CONNECTIONS__wikijs__database=$WIKIJS_DATABASE_NAME
SQLPAD_CONNECTIONS__wikijs__username=$WIKIJS_DATABASE_USER
SQLPAD_CONNECTIONS__wikijs__password=$WIKIJS_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__wikijs__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__wikijs__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__wordpress__name=WordPress
SQLPAD_CONNECTIONS__wordpress__driver=mysql
SQLPAD_CONNECTIONS__wordpress__host=wordpress-db
SQLPAD_CONNECTIONS__wordpress__database=$WORDPRESS_DATABASE_NAME
SQLPAD_CONNECTIONS__wordpress__username=$WORDPRESS_DATABASE_USER
SQLPAD_CONNECTIONS__wordpress__password=$WORDPRESS_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__wordpress__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__wordpress__idleTimeoutSeconds=900
SQLPAD_CONNECTIONS__yamtrack__name=Yamtrack
SQLPAD_CONNECTIONS__yamtrack__driver=postgres
SQLPAD_CONNECTIONS__yamtrack__host=yamtrack-db
SQLPAD_CONNECTIONS__yamtrack__database=$YAMTRACK_DATABASE_NAME
SQLPAD_CONNECTIONS__yamtrack__username=$YAMTRACK_DATABASE_USER
SQLPAD_CONNECTIONS__yamtrack__password=$YAMTRACK_DATABASE_USER_PASSWORD
SQLPAD_CONNECTIONS__yamtrack__multiStatementTransactionEnabled='false'
SQLPAD_CONNECTIONS__yamtrack__idleTimeoutSeconds=900
EOFSP

}

function performUpdateSQLPad()
{
  perform_stack_name=sqlpad
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.1.2
      image_update_map[0]="sqlpad/sqlpad:7.1.2,sqlpad/sqlpad:7.5.3"
    ;;
    2)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.2.0
      image_update_map[0]="sqlpad/sqlpad:7.2.0,sqlpad/sqlpad:7.5.3"
    ;;
    3)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.3.1
      image_update_map[0]="sqlpad/sqlpad:7.3.1,sqlpad/sqlpad:7.5.3"
    ;;
    4)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.4.1
      image_update_map[0]="sqlpad/sqlpad:7.4.1,sqlpad/sqlpad:7.5.3"
    ;;
    5)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.4.4
      image_update_map[0]="sqlpad/sqlpad:7.4.4,sqlpad/sqlpad:7.5.3"
    ;;
    6)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.5.1
      image_update_map[0]="sqlpad/sqlpad:7.5.1,sqlpad/sqlpad:7.5.3"
    ;;
    7)
      newVer=v7
      curImageList=sqlpad/sqlpad:7.5.3
      image_update_map[0]="sqlpad/sqlpad:7.5.3,sqlpad/sqlpad:7.5.3"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function modFunUpdateSQLPad()
{
  grep "SQLPAD_CONNECTIONS__${sdb_name}__name" $HOME/${updateStackName}.env > /dev/null 2>&1
  if [ $? -eq 0 ]; then
    return 3
  fi
  echo "SQLPAD_CONNECTIONS__${sdb_name}__name=$sdb_formal" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__driver=$sdb_driver" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__host=$sdb_host" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__database=$sdb_database" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__username=$sdb_username" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__password=$sdb_password" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__multiStatementTransactionEnabled='false'" >> $HOME/${updateStackName}.env
  echo "SQLPAD_CONNECTIONS__${sdb_name}__idleTimeoutSeconds=900" >> $HOME/${updateStackName}.env
}

function checkAddDBConnection()
{
  isImportAIStack="$1"
  sdb_name="$2"
  sdb_formal="$3"
  sdb_driver="$4"
  sdb_host="$5"
  sdb_database="$6"
  sdb_username="$7"
  sdb_password="$8"
  set +e
  updateStackEnv sqlpad modFunUpdateSQLPad > /dev/null 2>&1
  usRetVal=$?
  if [ $usRetVal -eq 2 ]; then
    echo "WARNING: Could not find SQLPad stack, it may not be installed."
  elif [ $usRetVal -eq 3 ]; then
    echo "INFO: Already added to SQLPad - $sdb_formal"
  elif [ $usRetVal -ne 0 ]; then
    echo "ERROR: There was an unknown error with SQLPad"
  fi
  # See the importDBConnectionsAIStack() function for more details
  # This is dead code for now, but it may be revisited in some form or fashion later
  if false && [ "$isImportAIStack" = "true" ] && [ -d $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport ]; then
    rm -f $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME
    cat <<EOFAS > $HSHQ_STACKS_DIR/aistack/mindsdb/dbimport/$MINDSDB_IMPORT_FILENAME
"$sdb_formal" $sdb_driver $sdb_host $sdb_database $sdb_username $sdb_password
EOFAS
    importDBConnectionsAIStack
  fi
}

# Heimdall
function installHeimdall()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory heimdall "Heimdall"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Heimdall directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName heimdall)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Heimdall docker image"
    exit 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/heimdall
  mkdir $HSHQ_STACKS_DIR/heimdall/config
  mkdir $HSHQ_STACKS_DIR/heimdall/html

  initServicesCredentials
  if [ -z "$HEIMDALL_WINDOW_TITLE" ]; then
    HEIMDALL_WINDOW_TITLE="$HOMESERVER_NAME Home"
    updateConfigVar HEIMDALL_WINDOW_TITLE "$HEIMDALL_WINDOW_TITLE"
  fi
  HEIMDALL_APP_NAME="Heimdall"

  generateCert heimdall heimdall
  outputConfigHeimdall
  cd ~
  sudo docker compose -f $HOME/heimdall-compose-tmp.yml up -d

  stack_loaded_text="service 99-ci-service-check successfully started"
  search="$stack_loaded_text"
  isFound=false
  i=0
  set +e
  while [ $i -le 300 ]
  do
    findtext=$(docker logs heimdall 2>&1 | grep "$search")
    if ! [ -z "$findtext" ]; then
      isFound=true
      break
    fi
    echo "Container not ready, sleeping 3 seconds, total wait=$i seconds..."
    sleep 3
    i=$((i+3))
  done
  if ! [ "$isFound" = "true" ]; then
    echo "Heimdall did not start up correctly..."
    cd ~
    sudo docker compose -f $HOME/heimdall-compose-tmp.yml down -v
    exit 1
  fi
  sleep 3
  set -e
  cd ~
  sudo docker compose -f $HOME/heimdall-compose-tmp.yml down -v
  rm -f $HOME/heimdall-compose-tmp.yml

  sed -i "s|^APP_NAME=.*|APP_NAME=\"$HEIMDALL_WINDOW_TITLE\"|g" $HSHQ_STACKS_DIR/heimdall/config/www/.env
  sed -i "s|^MAIL_HOST=.*|MAIL_HOST=|g" $HSHQ_STACKS_DIR/heimdall/config/www/.env
  # https://github.com/linuxserver/Heimdall/issues/840
  sed -i "s|^SESSION_LIFETIME=.*|SESSION_LIFETIME=5256000|g" $HSHQ_STACKS_DIR/heimdall/config/www/.env
  echo "SESSION_SECURE_COOKIE=true" >> $HSHQ_STACKS_DIR/heimdall/config/www/.env
  # Fixes the annoying excess space at the bottom of Firefox browser windows
  sed -i '/\.sidenav ul {/{:a;N;/}/!ba;s/\.sidenav ul {.*}/\.sidenav ul {\n  list-style: none;\n  margin: 0;\n  padding: 20px;\n  overflow-y: auto;\n}/g}' $HSHQ_STACKS_DIR/heimdall/html/public/css/app.css

  admin_password_hash=$(htpasswd -nbBC 10 $HEIMDALL_ADMIN_USERNAME $HEIMDALL_ADMIN_PASSWORD | cut -d":" -f2-)
  user_password_hash=$(htpasswd -nbBC 10 $HEIMDALL_USER_USERNAME $HEIMDALL_USER_PASSWORD | cut -d":" -f2-)
  hs_password_hash=$(htpasswd -nbBC 10 $HEIMDALL_HOMESERVERS_USERNAME $HEIMDALL_HOMESERVERS_PASSWORD | cut -d":" -f2-)
  rs_password_hash=$(htpasswd -nbBC 10 $HEIMDALL_RELAYSERVER_USERNAME $HEIMDALL_RELAYSERVER_PASSWORD | cut -d":" -f2-)
  curdt=$(getCurrentDate)

  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "PRAGMA foreign_keys=ON;DELETE FROM users;"
  cp $HSHQ_ASSETS_DIR/images/admin.png $HSHQ_STACKS_DIR/heimdall/config/www/avatars/
  cp $HSHQ_ASSETS_DIR/images/users.png $HSHQ_STACKS_DIR/heimdall/config/www/avatars/
  cp $HSHQ_ASSETS_DIR/images/homeserver.png $HSHQ_STACKS_DIR/heimdall/config/www/avatars/
  cp $HSHQ_ASSETS_DIR/images/relayserver.png $HSHQ_STACKS_DIR/heimdall/config/www/avatars/
  cp $HSHQ_ASSETS_DIR/images/adminbackground.jpg $HSHQ_STACKS_DIR/heimdall/config/www/backgrounds/
  cp $HSHQ_ASSETS_DIR/images/userbackground.jpg $HSHQ_STACKS_DIR/heimdall/config/www/backgrounds/
  cp $HSHQ_ASSETS_DIR/images/wghomeserversbackground.jpg $HSHQ_STACKS_DIR/heimdall/config/www/backgrounds/
  cp $HSHQ_ASSETS_DIR/images/relayserverbackground.jpg $HSHQ_STACKS_DIR/heimdall/config/www/backgrounds/

  domain_noext=$(echo $HOMESERVER_DOMAIN | cut -d"." -f1)
  search_provider="\n${domain_noext}:\n   id: ${domain_noext}\n   url: https://$SUB_SEARXNG.$HOMESERVER_DOMAIN\n   name: \"$HOMESERVER_NAME\"\n   method: get\n   target: _blank\n   query: q"
  echo -e "$search_provider" >> $HSHQ_STACKS_DIR/heimdall/config/www/searchproviders.yaml

  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO users(id,username,email,avatar,password,autologin,public_front,remember_token,created_at,updated_at) VALUES(1,'$HEIMDALL_ADMIN_USERNAME','$EMAIL_ADMIN_EMAIL_ADDRESS','avatars/admin.png','$admin_password_hash',NULL,0,NULL,'$curdt','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO users(id,username,email,avatar,password,autologin,public_front,remember_token,created_at,updated_at) VALUES(2,'$HEIMDALL_USER_USERNAME','$EMAIL_ADMIN_EMAIL_ADDRESS','avatars/users.png','$user_password_hash',NULL,1,NULL,'$curdt','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO users(id,username,email,avatar,password,autologin,public_front,remember_token,created_at,updated_at) VALUES(3,'$HEIMDALL_HOMESERVERS_USERNAME','$EMAIL_ADMIN_EMAIL_ADDRESS','avatars/homeserver.png','$hs_password_hash',NULL,1,NULL,'$curdt','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO users(id,username,email,avatar,password,autologin,public_front,remember_token,created_at,updated_at) VALUES(4,'$HEIMDALL_RELAYSERVER_USERNAME','$EMAIL_ADMIN_EMAIL_ADDRESS','avatars/relayserver.png','$rs_password_hash',NULL,0,NULL,'$curdt','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(7,1,'_blank');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(7,2,'_blank');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(7,3,'_blank');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(7,4,'_blank');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(2,1,'backgrounds/adminbackground.jpg');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(2,2,'backgrounds/userbackground.jpg');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(2,3,'backgrounds/wghomeserversbackground.jpg');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(2,4,'backgrounds/relayserverbackground.jpg');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(4,1,'${domain_noext}');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(4,2,'${domain_noext}');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(4,3,'${domain_noext}');"
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(4,4,'${domain_noext}');"

  if ! [ "$(isServiceDisabled searxng)" = "true" ]; then
    set -e
    sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO setting_user(setting_id,user_id,uservalue) VALUES(3,2,1);"
  fi
  set -e
  insertServicesHeimdall
  installStack heimdall heimdall "$stack_loaded_text" $HOME/heimdall.env
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Heimdall"
    exit $retval
  fi

  inner_block=""
  inner_block=$inner_block">>https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy https://heimdall {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_HEIMDALL $MANAGETLS_HEIMDALL "$is_integrate_hshq" $NETDEFAULT_HEIMDALL "$inner_block"
}

function outputConfigHeimdall()
{
  outputHeimdallCompose

  cat <<EOFHC > $HOME/heimdall-compose-tmp.yml

services:
  heimdall:
    image: $(getScriptImageByContainerName heimdall)
    container_name: heimdall
    hostname: heimdall
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - $HSHQ_STACKS_DIR/heimdall/config:/config
      - $HSHQ_SSL_DIR/heimdall.crt:/config/keys/cert.crt
      - $HSHQ_SSL_DIR/heimdall.key:/config/keys/cert.key
      - v-heimdall:/var/www/localhost/heimdall
    environment:
      - PUID=$USERID
      - PGID=$GROUPID
      - APP_NAME=$HEIMDALL_APP_NAME

volumes:
  v-heimdall:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: $HSHQ_STACKS_DIR/heimdall/html

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFHC

  cat <<EOFHE > $HOME/heimdall.env
PUID=$USERID
PGID=$GROUPID
APP_NAME=$HEIMDALL_APP_NAME
EOFHE

  cat <<EOFHA > $HSHQ_STACKS_DIR/heimdall/app.php
<?php

return [

    /*
    |--------------------------------------------------------------------------
    | Application Name
    |--------------------------------------------------------------------------
    |
    | This value is the name of your application. This value is used when the
    | framework needs to place the application's name in a notification or
    | any other location as required by the application or its packages.
    |
    */

    'name' => env('APP_NAME', 'Heimdall'),
    'version' => '2.4.13',

    /*
    |--------------------------------------------------------------------------
    | Application Environment
    |--------------------------------------------------------------------------
    |
    | This value determines the "environment" your application is currently
    | running in. This may determine how you prefer to configure various
    | services your application utilizes. Set this in your ".env" file.
    |
    */

    'env' => env('APP_ENV', 'production'),

    /*
    |--------------------------------------------------------------------------
    | Application Debug Mode
    |--------------------------------------------------------------------------
    |
    | When your application is in debug mode, detailed error messages with
    | stack traces will be shown on every error that occurs within your
    | application. If disabled, a simple generic error page is shown.
    |
    */

    'debug' => (bool) env('APP_DEBUG', false),

    /*
    |--------------------------------------------------------------------------
    | Application URL
    |--------------------------------------------------------------------------
    |
    | This URL is used by the console to properly generate URLs when using
    | the Artisan command line tool. You should set this to the root of
    | your application so that it is used when running Artisan tasks.
    |
    */

    'url' => env('APP_URL', 'http://localhost'),

    'asset_url' => env('ASSET_URL', null),
    'appsource' => env('APP_SOURCE', 'https://localhost/'),

    /*
    |--------------------------------------------------------------------------
    | Application Timezone
    |--------------------------------------------------------------------------
    |
    | Here you may specify the default timezone for your application, which
    | will be used by the PHP date and date-time functions. We have gone
    | ahead and set this to a sensible default for you out of the box.
    |
    */

    'timezone' => 'UTC',

    /*
    |--------------------------------------------------------------------------
    | Application Locale Configuration
    |--------------------------------------------------------------------------
    |
    | The application locale determines the default locale that will be used
    | by the translation service provider. You are free to set this value
    | to any of the locales which will be supported by the application.
    |
    */

    'locale' => 'en',

    /*
    |--------------------------------------------------------------------------
    | Application Fallback Locale
    |--------------------------------------------------------------------------
    |
    | The fallback locale determines the locale to use when the current one
    | is not available. You may change the value to correspond to any of
    | the language folders that are provided through your application.
    |
    */

    'fallback_locale' => 'en',

    /*
    |--------------------------------------------------------------------------
    | Faker Locale
    |--------------------------------------------------------------------------
    |
    | This locale will be used by the Faker PHP library when generating fake
    | data for your database seeds. For example, this will be used to get
    | localized telephone numbers, street address information and more.
    |
    */

    'faker_locale' => 'en_US',

    /*
    |--------------------------------------------------------------------------
    | Encryption Key
    |--------------------------------------------------------------------------
    |
    | This key is used by the Illuminate encrypter service and should be set
    | to a random, 32 character string, otherwise these encrypted strings
    | will not be safe. Please do this before deploying an application!
    |
    */

    'key' => env('APP_KEY', 'base64:I206O8ibx+GQyRE7BeOxDobn04Mfmyyc5Ptzns/C0mY='),

    'cipher' => 'AES-256-CBC',

    /*
    |--------------------------------------------------------------------------
    | Autoloaded Service Providers
    |--------------------------------------------------------------------------
    |
    | The service providers listed here will be automatically loaded on the
    | request to your application. Feel free to add your own services to
    | this array to grant expanded functionality to your applications.
    |
    */

    'providers' => [

        /*
         * Laravel Framework Service Providers...
         */
        Illuminate\Auth\AuthServiceProvider::class,
        Illuminate\Broadcasting\BroadcastServiceProvider::class,
        Illuminate\Bus\BusServiceProvider::class,
        Illuminate\Cache\CacheServiceProvider::class,
        Illuminate\Foundation\Providers\ConsoleSupportServiceProvider::class,
        Illuminate\Cookie\CookieServiceProvider::class,
        Illuminate\Database\DatabaseServiceProvider::class,
        Illuminate\Encryption\EncryptionServiceProvider::class,
        Illuminate\Filesystem\FilesystemServiceProvider::class,
        Illuminate\Foundation\Providers\FoundationServiceProvider::class,
        Illuminate\Hashing\HashServiceProvider::class,
        Illuminate\Mail\MailServiceProvider::class,
        Illuminate\Notifications\NotificationServiceProvider::class,
        Illuminate\Pagination\PaginationServiceProvider::class,
        Illuminate\Pipeline\PipelineServiceProvider::class,
        Illuminate\Queue\QueueServiceProvider::class,
        Illuminate\Redis\RedisServiceProvider::class,
        Illuminate\Auth\Passwords\PasswordResetServiceProvider::class,
        Illuminate\Session\SessionServiceProvider::class,
        Illuminate\Translation\TranslationServiceProvider::class,
        Illuminate\Validation\ValidationServiceProvider::class,
        Illuminate\View\ViewServiceProvider::class,

        /*
         * Package Service Providers...
         */
        Collective\Html\HtmlServiceProvider::class,
        /*
         * Application Service Providers...
         */
        App\Providers\AppServiceProvider::class,
        App\Providers\AuthServiceProvider::class,
        // App\Providers\BroadcastServiceProvider::class,
        App\Providers\EventServiceProvider::class,
        App\Providers\RouteServiceProvider::class,

    ],

    /*
    |--------------------------------------------------------------------------
    | Class Aliases
    |--------------------------------------------------------------------------
    |
    | This array of class aliases will be registered when this application
    | is started. However, feel free to register as many as you wish as
    | the aliases are "lazy" loaded so they don't hinder performance.
    |
    */

    'aliases' => [

        'App' => Illuminate\Support\Facades\App::class,
        'Arr' => Illuminate\Support\Arr::class,
        'Artisan' => Illuminate\Support\Facades\Artisan::class,
        'Auth' => Illuminate\Support\Facades\Auth::class,
        'Blade' => Illuminate\Support\Facades\Blade::class,
        'Broadcast' => Illuminate\Support\Facades\Broadcast::class,
        'Bus' => Illuminate\Support\Facades\Bus::class,
        'Cache' => Illuminate\Support\Facades\Cache::class,
        'Config' => Illuminate\Support\Facades\Config::class,
        'Cookie' => Illuminate\Support\Facades\Cookie::class,
        'Crypt' => Illuminate\Support\Facades\Crypt::class,
        'DB' => Illuminate\Support\Facades\DB::class,
        'Eloquent' => Illuminate\Database\Eloquent\Model::class,
        'Event' => Illuminate\Support\Facades\Event::class,
        'File' => Illuminate\Support\Facades\File::class,
        'Form' => Collective\Html\FormFacade::class,
        'Gate' => Illuminate\Support\Facades\Gate::class,
        'Hash' => Illuminate\Support\Facades\Hash::class,
        'Html' => Collective\Html\HtmlFacade::class,
        'Http' => Illuminate\Support\Facades\Http::class,
        'Lang' => Illuminate\Support\Facades\Lang::class,
        'Log' => Illuminate\Support\Facades\Log::class,
        'Mail' => Illuminate\Support\Facades\Mail::class,
        'Notification' => Illuminate\Support\Facades\Notification::class,
        'Password' => Illuminate\Support\Facades\Password::class,
        'Queue' => Illuminate\Support\Facades\Queue::class,
        'Redirect' => Illuminate\Support\Facades\Redirect::class,
        'Redis' => Illuminate\Support\Facades\Redis::class,
        'Request' => Illuminate\Support\Facades\Request::class,
        'Response' => Illuminate\Support\Facades\Response::class,
        'Route' => Illuminate\Support\Facades\Route::class,
        'Schema' => Illuminate\Support\Facades\Schema::class,
        'Session' => Illuminate\Support\Facades\Session::class,
        'Storage' => Illuminate\Support\Facades\Storage::class,
        'Str' => Illuminate\Support\Str::class,
        'URL' => Illuminate\Support\Facades\URL::class,
        'Validator' => Illuminate\Support\Facades\Validator::class,
        'View' => Illuminate\Support\Facades\View::class,
        'Yaml' => Symfony\Component\Yaml\Yaml::class,

        'SupportedApps' => App\SupportedApps::class,
        'EnhancedApps' => App\EnhancedApps::class,

    ],

];
EOFHA

  cat <<EOFHL > $HSHQ_STACKS_DIR/heimdall/list.json
{
	"appcount": 0,
	"apps": []
}
EOFHL

}

function performUpdateHeimdall()
{
  perform_stack_name=heimdall
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v1
      curImageList=linuxserver/heimdall:2.4.13
      image_update_map[0]="linuxserver/heimdall:2.4.13,linuxserver/heimdall:2.4.13"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function outputHeimdallCompose()
{
  cat <<EOFHC > $HOME/heimdall-compose.yml
$STACK_VERSION_PREFIX heimdall $(getScriptStackVersion heimdall)

services:
  heimdall:
    image: $(getScriptImageByContainerName heimdall)
    container_name: heimdall
    hostname: heimdall
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/heimdall/config:/config
      - \${HSHQ_SSL_DIR}/heimdall.crt:/config/keys/cert.crt
      - \${HSHQ_SSL_DIR}/heimdall.key:/config/keys/cert.key
      - v-heimdall:/var/www/localhost/heimdall
      - \${HSHQ_STACKS_DIR}/heimdall/app.php:/var/www/localhost/heimdall/config/app.php
      - \${HSHQ_STACKS_DIR}/heimdall/list.json:/var/www/localhost/heimdall/public/list.json
      - \${HSHQ_STACKS_DIR}/heimdall/cleanupHeimdallSessions.sh:/cleanupHeimdallSessions.sh
    labels:
      - "ofelia.enabled=true"
      - "ofelia.job-exec.heimdall-sessions-cleanup.schedule=@every 4h"
      - "ofelia.job-exec.heimdall-sessions-cleanup.command=/cleanupHeimdallSessions.sh"
volumes:
  v-heimdall:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: \${HSHQ_STACKS_DIR}/heimdall/html

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
EOFHC

  rm -f $HSHQ_STACKS_DIR/heimdall/cleanupHeimdallSessions.sh
  cat <<EOFHC > $HSHQ_STACKS_DIR/heimdall/cleanupHeimdallSessions.sh
#!/bin/bash

find /var/www/localhost/heimdall/storage/framework/sessions/ -type f -delete
EOFHC
  chmod 555 $HSHQ_STACKS_DIR/heimdall/cleanupHeimdallSessions.sh
}

function insertEnableSvcAll()
{
  insertEnableSvcHeimdall "$1" "$2" "$3" "$4" "$5" true "$6"
  insertEnableSvcUptimeKuma "$1" "$2" "$3" "$4" true
}

function deleteSvcAll()
{
  user_type=$1
  svc_url=$2
  is_manage_container=$3
  deleteSvcHeimdall "$1" "$2" "$3"
  deleteSvcUptimeKuma "$2" "$3"
}

function getHeimdallUserIDFromType()
{
  user_type=$1
  if [ "$user_type" = "admin" ]; then
    user_id=1
  elif [ "$user_type" = "user" ]; then
    user_id=2
  elif [ "$user_type" = "homeservers" ]; then
    user_id=3
  elif [ "$user_type" = "relayserver" ]; then
    user_id=4
  else
    user_id=0
  fi
  echo $user_id
}

function checkInsertServiceHeimdall()
{
  svc_stack_name="$1"
  svc_proper_name="$2"
  user_type="$3"
  svc_url="$4"
  svc_img="$5"
  is_restart="$6"
  svc_is_active="$7"
  svc_order="$8"

  user_id=$(getHeimdallUserIDFromType $user_type)
  docker container stop heimdall > /dev/null 2>&1
  insert_id=$(sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "select id from items where user_id='$user_id' and url='$svc_url';")
  if [ -z "$insert_id" ]; then
    insertIntoHeimdallDB "$svc_proper_name" "$user_type" "$svc_url" "$svc_is_active" "$svc_img" "$svc_order"
  else
    sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set pinned=$svc_is_active where user_id='$user_id' and url='$svc_url';"
    sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "update items set deleted_at=NULL where user_id='$user_id' and url='$svc_url';"
  fi
  if [ "$is_restart" = "true" ]; then
    docker container start heimdall > /dev/null 2>&1
  fi
}

function insertEnableSvcHeimdall()
{
  checkInsertServiceHeimdall "$1" "$2" "$3" "$4" "$5" "$6" 1 "$7"
}

function deleteSvcHeimdall()
{
  user_type=$1
  svc_url=$2
  is_manage_container=$3
  user_id=$(getHeimdallUserIDFromType $user_type)
  if [ "$IS_INSTALLED" = "true" ] && [ -f $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite ]; then
    if [ "$is_manage_container" = "true" ]; then
      docker container stop heimdall >/dev/null
    fi
    sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "PRAGMA foreign_keys=ON;delete from items where url like '${svc_url}%';"
    if [ "$is_manage_container" = "true" ]; then
      docker container start heimdall >/dev/null
    fi
  fi
}

function insertIntoHeimdallDB()
{
  svc_proper_name="$1"
  user_type="$2"
  svc_url="$3"
  svc_is_active="$4"
  svc_img="$5"
  svc_order="$6"

  curdt=$(getCurrentDate)
  user_id=$(getHeimdallUserIDFromType $user_type)

  if [ "$user_type" = "admin" ]; then
    color_string=$ADMIN_COLOR_CODE
  elif [ "$user_type" = "user" ]; then
    color_string=$USERS_COLOR_CODE
  elif [ "$user_type" = "homeservers" ]; then
    color_string=$HOMESERVERS_COLOR_CODE
  elif [ "$user_type" = "relayserver" ]; then
    color_string=$RELAYSERVER_COLOR_CODE
  fi

  if [ -f $HSHQ_ASSETS_DIR/images/$svc_img ]; then
    cp -f $HSHQ_ASSETS_DIR/images/$svc_img $HSHQ_STACKS_DIR/heimdall/config/www/icons/
  else
    cp -f $HSHQ_ASSETS_DIR/images/heimdall.png $HSHQ_STACKS_DIR/heimdall/config/www/icons/$svc_img
  fi
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO items(id,title,colour,icon,url,description,pinned,\"order\",deleted_at,created_at,updated_at,type,user_id,class,appid,appdescription) VALUES(NULL,'$svc_proper_name','$color_string','icons/$svc_img','$svc_url',NULL,$svc_is_active,$svc_order,NULL,'$curdt','$curdt',0,$user_id,NULL,'null',NULL);"
  insert_id=$(sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "select id from items where user_id='$user_id' and url='$svc_url';")
  sqlite3 $HSHQ_STACKS_DIR/heimdall/config/www/app.sqlite "INSERT INTO item_tag(item_id,tag_id,created_at,updated_at) VALUES($insert_id,0,NULL,NULL);"
}

function bulkImportHomeServerLinksHeimdall()
{
  domainList=$1
  OLDIFS=$IFS
  IFS=$(echo -en "\n\b")
  lines=$(cat $domainList)
  for curLine in $lines
  do
    if [ -z "$curLine" ]; then
      continue
    fi
    curHSName=$(echo "$curLine" | cut -d "|" -f1)
    curDomain=$(echo "$curLine" | cut -d "|" -f2)
    if ! [ -z "$curDomain" ]; then
      insertEnableSvcHeimdall heimdall "$curHSName" homeservers "https://$SUB_HSHQHOME.${curDomain}" "hs2.png" false "$(getHeimdallOrderFromSub $SUB_HSHQHOME homeservers)"
    fi
  done
  IFS=$OLDIFS
  docker container start heimdall >/dev/null
}

# Caddy
function initCaddyCommon()
{
  mkdir $HSHQ_STACKS_DIR/caddy-common
  mkdir $HSHQ_STACKS_DIR/caddy-common/caddyfiles
  mkdir $HSHQ_STACKS_DIR/caddy-common/files
  mkdir $HSHQ_STACKS_DIR/caddy-common/lecerts
  mkdir $HSHQ_STACKS_DIR/caddy-common/primary-certs
  mkdir $HSHQ_STACKS_DIR/caddy-common/scripts
  mkdir $HSHQ_STACKS_DIR/caddy-common/snippets
  cp $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.crt $HSHQ_STACKS_DIR/caddy-common/files/${CERTS_ROOT_CA_NAME}.crt
  cp $HSHQ_SSL_DIR/${CERTS_ROOT_CA_NAME}.der $HSHQ_STACKS_DIR/caddy-common/files/${CERTS_ROOT_CA_NAME}.der
  cat <<EOFCF > $HSHQ_STACKS_DIR/caddy-common/snippets/head.snip
($CADDY_SNIPPET_SAFEHEADER) {
  header {
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

($CADDY_SNIPPET_SAFEHEADERALLOWFRAME) {
  header {
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

($CADDY_SNIPPET_SAFEHEADERALLOWCORS) {
  header {
    Access-Control-Allow-Origin *
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

($CADDY_SNIPPET_SAFEHEADERCORS) {
  @origin{args[0]} header Origin {args[0]}
  header @origin{args[0]} {
    Access-Control-Allow-Origin "{args[0]}"
    Referrer-Policy "same-origin"
    Strict-Transport-Security "max-age=31536000;"
    X-XSS-Protection "1; mode=block"
    X-Content-Type-Options "nosniff"
    X-Robots-Tag "noindex, nofollow"
    -Server
  }
}

($CADDY_SNIPPET_TRUSTEDPROXIES) {
  trusted_proxies $TRUSTED_PROXIES
}

($CADDY_SNIPPET_NOTHOMESUBNET) {
  not remote_ip {\$CADDY_HSHQ_PRIVATE_IPS}
}

($CADDY_SNIPPET_RIP) {
  @subnet remote_ip {\$CADDY_HSHQ_CA_SUBNET}
}

EOFCF

  cat <<EOFCF > $HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
# sn-base-domain BEGIN
(sn-base-domain) {
  https://$HOMESERVER_DOMAIN {
    import $CADDY_SNIPPET_TLS_HSHQ
    import safe-header
    header "/.well-known/matrix/*" {
      Content-Type application/json
    }
    route {
      respond "/.well-known/matrix/server" 200 {
        body "{ \"m.server\": \"$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN:443\" }"
        close
      }
      respond "/.well-known/matrix/client" 200 {
        body "{ \"m.homeserver\": {\"base_url\": \"https://$SUB_MATRIX_SYNAPSE.$HOMESERVER_DOMAIN/\" } }"
        close
      }
      redir /.well-known/webfinger https://$SUB_MASTODON.$HOMESERVER_DOMAIN{uri} permanent
      redir /.well-known/host-meta https://$SUB_MASTODON.$HOMESERVER_DOMAIN{uri} permanent
      redir / https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN
      respond 404
    }
  }
}
# sn-base-domain END

# sn-sub-home BEGIN
(sn-sub-home) {
  https://$SUB_HSHQHOME.$HOMESERVER_DOMAIN {
    import $CADDY_SNIPPET_TLS_HSHQ
    import $CADDY_SNIPPET_RIP
    import $CADDY_SNIPPET_FWDAUTH
    import $CADDY_SNIPPET_SAFEHEADER
    handle @subnet {
      redir https://$SUB_HEIMDALL.$HOMESERVER_DOMAIN
    }
    respond 404
  }
}
# sn-sub-home END

# sn-sub-${SUB_FILES} BEGIN
(sn-sub-${SUB_FILES}) {
  http://$SUB_FILES.$HOMESERVER_DOMAIN {
    root * /files
    file_server browse
    header Content-Type "application/octet-stream"
    header Content-Disposition "attachment"
    redir /ca.crt /${CERTS_ROOT_CA_NAME}.crt
    redir /ca.der /${CERTS_ROOT_CA_NAME}.der
  }
}
# sn-sub-${SUB_FILES} END

# sn-sub-${SUB_BIND_IP} BEGIN
(sn-sub-${SUB_BIND_IP}) {
  http://{\$CADDY_HSHQ_BIND_IP} {
    root * /files
    file_server browse
    header Content-Type "application/octet-stream"
    header Content-Disposition "attachment"
    redir /ca.crt /${CERTS_ROOT_CA_NAME}.crt
    redir /ca.der /${CERTS_ROOT_CA_NAME}.der
  }
}
# sn-sub-${SUB_BIND_IP} END

# sn-sub-${SUB_IMAGES} BEGIN
(sn-sub-${SUB_IMAGES}) {
  https://$SUB_IMAGES.$HOMESERVER_DOMAIN {
    import $CADDY_SNIPPET_TLS_HSHQ
    root * /images
    file_server
  }
}
# sn-sub-${SUB_IMAGES} END

# sn-sub-${SUB_HSHQSTATUS} BEGIN
(sn-sub-${SUB_HSHQSTATUS}) {
  https://$SUB_HSHQSTATUS.$HOMESERVER_DOMAIN {
    import $CADDY_SNIPPET_TLS_HSHQ
    respond "Good"
  }
}
# sn-sub-${SUB_HSHQSTATUS} END
EOFCF

  cat <<EOFCF > $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home
import /snippets/svcs.snip
import sn-base-domain
import sn-sub-home
import sn-sub-${SUB_FILES}
import sn-sub-${SUB_BIND_IP}
import sn-sub-${SUB_IMAGES}
import sn-sub-${SUB_HSHQSTATUS}
EOFCF

  cp $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary
  cp $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Other
  docker volume create --driver local -o device=$HSHQ_STACKS_DIR/caddy-common/primary-certs -o o=bind -o type=none caddy-primary-certs
}

function installCaddy()
{
  set +e
  net_name=$1
  net_type=$2
  ipVarName=$3
  bind_ip=$4
  ca_name=$5
  ca_url=$6
  ca_subdomain=$7
  ca_ip=$8
  priv_ip_net="$9"
  add_rip="${10}"

  caddy_net_name=caddy-$net_name
  checkDeleteStackAndDirectory $caddy_net_name "Caddy"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/$caddy_net_name
  mkdir $HSHQ_STACKS_DIR/$caddy_net_name/config
  mkdir $HSHQ_STACKS_DIR/$caddy_net_name/data
  outputConfigCaddy $net_name $caddy_net_name $net_type $ipVarName $bind_ip $ca_name $ca_url $ca_subdomain $ca_ip "$priv_ip_net" "$add_rip"
  installStack $caddy_net_name $caddy_net_name "serving initial configuration" $HOME/$caddy_net_name.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
}

function outputConfigCaddy()
{
  net_name=$1
  caddy_net_name=$2
  net_type=$3
  ipVarName=$4
  bind_ip=$5
  ca_name=$6
  ca_url=$7
  ca_subdomain=$8
  ca_ip=$9
  priv_ip_net="${10}"
  add_rip="${11}"

  case "$net_type" in
    home)
      cat <<EOFCF > $HOME/$caddy_net_name-compose.yml
$STACK_VERSION_PREFIX $caddy_net_name $(getScriptStackVersion $caddy_net_name)

services:
  $caddy_net_name:
    image: $IMG_CADDY
    container_name: $caddy_net_name
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "\${$ipVarName}:$CADDY_HTTP_PORT:$CADDY_HTTP_PORT"
      - "\${$ipVarName}:$CADDY_HTTPS_PORT:$CADDY_HTTPS_PORT"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/data/caddy/pki/authorities/$ca_name/root.crt:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.key:/data/caddy/pki/authorities/$ca_name/root.key:ro
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/Caddyfile:/etc/caddy/Caddyfile
      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles/CaddyfileBody-Home:/config/CaddyfileBody
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/data:/data
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/config:/config
      - \${HSHQ_STACKS_DIR}/caddy-common/scripts:/scripts:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/snippets:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/files:/files:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/lecerts:/lecerts:ro
      - \${HSHQ_ASSETS_DIR}/images:/images:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCF
      cat <<EOFCF > $HSHQ_STACKS_DIR/$caddy_net_name/Caddyfile
{
  email $EMAIL_ADMIN_EMAIL_ADDRESS
  renew_interval {\$CERT_RENEW_INTERVAL}
  pki {
    ca {\$CADDY_HSHQ_CA_NAME} {
      intermediate_cn "$CERTS_INTERNAL_INTERMEDIATE_CN"
      intermediate_lifetime {\$CERT_INTERMEDIATE_LIFETIME}
    }
  }
}

import /snippets/head.snip

($CADDY_SNIPPET_TLS_HSHQ) {
  tls {
    issuer internal {
      ca {\$CADDY_HSHQ_CA_NAME}
      lifetime {\$CERT_LEAF_LIFETIME}
    }
  }
}

($CADDY_SNIPPET_FWDAUTH) {
  # Uncomment the following block in order to employ Authelia on your home network
  #forward_auth https://authelia:9091 {
  #  uri /api/verify?rd=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
  #  copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
  #}
}

https://$SUB_CADDY.$HOMESERVER_DOMAIN {
  import $CADDY_SNIPPET_RIP
  import $CADDY_SNIPPET_TLS_HSHQ
  acme_server {
    ca {\$CADDY_HSHQ_CA_NAME}
    lifetime {\$CERT_LEAF_LIFETIME}
  }
}

import /config/CaddyfileBody

EOFCF
      cat <<EOFCE > $HOME/$caddy_net_name.env
CERT_RENEW_INTERVAL=$CADDY_CERT_RENEW_INTERVAL
CERT_INTERMEDIATE_LIFETIME=$CADDY_CERT_INTERMEDIATE_LIFETIME
CERT_LEAF_LIFETIME=$CADDY_CERT_LEAF_LIFETIME
CADDY_HSHQ_CA_NAME=$ca_name
CADDY_HSHQ_CA_SUBNET=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 $add_rip
CADDY_HSHQ_PRIVATE_IPS=\${$priv_ip_net} $(getPrivateIPRangesCaddy $bind_ip)
CADDY_HSHQ_CA_URL=$ca_url
CADDY_HSHQ_BIND_IP=\${$ipVarName}
EOFCE
      ;;
    primary)
      if [ "$PRIMARY_VPN_SETUP_TYPE" = "host" ]; then
        cat <<EOFCF > $HOME/$caddy_net_name-compose.yml
$STACK_VERSION_PREFIX $caddy_net_name $(getScriptStackVersion $caddy_net_name)

services:
  $caddy_net_name:
    image: $IMG_CADDY
    container_name: $caddy_net_name
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    extra_hosts:
      - host.docker.internal:host-gateway
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$bind_ip:80:80"
      - "$bind_ip:443:443"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/data/caddy/pki/authorities/$ca_name/root.crt:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.key:/data/caddy/pki/authorities/$ca_name/root.key:ro
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/Caddyfile:/etc/caddy/Caddyfile
      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles/CaddyfileBody-Primary:/config/CaddyfileBody
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/data:/data
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/config:/config
      - \${HSHQ_STACKS_DIR}/caddy-common/scripts:/scripts:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/snippets:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/files:/files:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/lecerts:/lecerts:ro
      - \${HSHQ_ASSETS_DIR}/images:/images:ro
      - caddy-primary-certs:/data/caddy/certificates

volumes:
  caddy-primary-certs:
    external: true

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCF
        cat <<EOFCF > $HSHQ_STACKS_DIR/$caddy_net_name/Caddyfile
{
  email $EMAIL_ADMIN_EMAIL_ADDRESS
  acme_ca https://acme-v02.api.letsencrypt.org/directory
  renew_interval {\$CERT_RENEW_INTERVAL}
  pki {
    ca {\$CADDY_HSHQ_CA_NAME} {
      intermediate_cn "$CERTS_INTERNAL_INTERMEDIATE_CN"
      intermediate_lifetime {\$CERT_INTERMEDIATE_LIFETIME}
    }
  }
}

import /snippets/head.snip

($CADDY_SNIPPET_TLS_HSHQ) {
  tls {
    issuer internal {
      ca {\$CADDY_HSHQ_CA_NAME}
      lifetime {\$CERT_LEAF_LIFETIME}
    }
  }
}

($CADDY_SNIPPET_FWDAUTH) {
  forward_auth https://authelia:9091 {
    uri /api/verify?rd=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
  }
}

https://$SUB_CADDY.$HOMESERVER_DOMAIN {
  import $CADDY_SNIPPET_RIP
  import $CADDY_SNIPPET_TLS_HSHQ
  acme_server {
    ca {\$CADDY_HSHQ_CA_NAME}
    lifetime {\$CERT_LEAF_LIFETIME}
  }
}

import /config/CaddyfileBody

EOFCF
      elif [ "$PRIMARY_VPN_SETUP_TYPE" = "join" ]; then
        cat <<EOFCF > $HOME/$caddy_net_name-compose.yml
$STACK_VERSION_PREFIX $caddy_net_name $(getScriptStackVersion $caddy_net_name)

services:
  $caddy_net_name:
    image: $IMG_CADDY
    container_name: $caddy_net_name
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$bind_ip:$CADDY_HTTP_PORT:$CADDY_HTTP_PORT"
      - "$bind_ip:$CADDY_HTTPS_PORT:$CADDY_HTTPS_PORT"
    extra_hosts:
      - host.docker.internal:host-gateway
      - "$ca_subdomain:$ca_ip"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.crt:/data/caddy/pki/authorities/$ca_name/root.crt:ro
      - \${HSHQ_SSL_DIR}/${CERTS_ROOT_CA_NAME}.key:/data/caddy/pki/authorities/$ca_name/root.key:ro
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/Caddyfile:/etc/caddy/Caddyfile
      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles/CaddyfileBody-Primary:/config/CaddyfileBody
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/data:/data
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/config:/config
      - \${HSHQ_STACKS_DIR}/caddy-common/scripts:/scripts:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/snippets:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/files:/files:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/lecerts:/lecerts:ro
      - \${HSHQ_ASSETS_DIR}/images:/images:ro
      - caddy-primary-certs:/data/caddy/certificates

volumes:
  caddy-primary-certs:
    external: true

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCF
        cat <<EOFCF > $HSHQ_STACKS_DIR/$caddy_net_name/Caddyfile
{
  email $EMAIL_ADMIN_EMAIL_ADDRESS
  acme_ca https://acme-v02.api.letsencrypt.org/directory
  renew_interval {\$CERT_RENEW_INTERVAL}
}

import /snippets/head.snip

($CADDY_SNIPPET_TLS_HSHQ) {
  tls {
    ca {\$CADDY_HSHQ_CA_URL}
  }
}

($CADDY_SNIPPET_FWDAUTH) {
  forward_auth https://authelia:9091 {
    uri /api/verify?rd=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
  }
}

import /config/CaddyfileBody

EOFCF
      else
        # This should never happen
        echo "Undefined error(1) in outputConfigCaddy, exiting..."
        exit 1
      fi
      cat <<EOFCE > $HOME/$caddy_net_name.env
CERT_RENEW_INTERVAL=$CADDY_CERT_RENEW_INTERVAL
CERT_INTERMEDIATE_LIFETIME=$CADDY_CERT_INTERMEDIATE_LIFETIME
CERT_LEAF_LIFETIME=$CADDY_CERT_LEAF_LIFETIME
CADDY_HSHQ_CA_NAME=$ca_name
CADDY_HSHQ_CA_SUBNET=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
CADDY_HSHQ_PRIVATE_IPS=
CADDY_HSHQ_CA_URL=$ca_url
CADDY_HSHQ_BIND_IP=$bind_ip
EOFCE
      ;;
    other)
      cat <<EOFCF > $HOME/$caddy_net_name-compose.yml
$STACK_VERSION_PREFIX $caddy_net_name $(getScriptStackVersion $caddy_net_name)

services:
  $caddy_net_name:
    image: $IMG_CADDY
    container_name: $caddy_net_name
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-proxy-net
      - dock-ext-net
    ports:
      - "$bind_ip:$CADDY_HTTP_PORT:$CADDY_HTTP_PORT"
      - "$bind_ip:$CADDY_HTTPS_PORT:$CADDY_HTTPS_PORT"
    extra_hosts:
      - "$ca_subdomain:$ca_ip"
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/Caddyfile:/etc/caddy/Caddyfile
      - \${HSHQ_STACKS_DIR}/caddy-common/caddyfiles/CaddyfileBody-$caddy_net_name:/config/CaddyfileBody
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/data:/data
      - \${HSHQ_STACKS_DIR}/$caddy_net_name/config:/config
      - \${HSHQ_STACKS_DIR}/caddy-common/snippets:/snippets:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/files:/files:ro
      - \${HSHQ_STACKS_DIR}/caddy-common/lecerts:/lecerts:ro
      - \${HSHQ_ASSETS_DIR}/images:/images:ro

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
EOFCF
      cp $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Other $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-$caddy_net_name
      cat <<EOFCF > $HSHQ_STACKS_DIR/$caddy_net_name/Caddyfile
{
  email $EMAIL_ADMIN_EMAIL_ADDRESS
  renew_interval {\$CERT_RENEW_INTERVAL}
}

import /snippets/head.snip

($CADDY_SNIPPET_TLS_HSHQ) {
  tls {
    ca {\$CADDY_HSHQ_CA_URL}
  }
}

($CADDY_SNIPPET_FWDAUTH) {
  forward_auth https://authelia:9091 {
    uri /api/verify?rd=https://$SUB_AUTHELIA.$HOMESERVER_DOMAIN
    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email
  }
}

import /config/CaddyfileBody

EOFCF
      cat <<EOFCE > $HOME/$caddy_net_name.env
CERT_RENEW_INTERVAL=$CADDY_CERT_RENEW_INTERVAL
CERT_INTERMEDIATE_LIFETIME=$CADDY_CERT_INTERMEDIATE_LIFETIME
CERT_LEAF_LIFETIME=$CADDY_CERT_LEAF_LIFETIME
CADDY_HSHQ_CA_NAME=$ca_name
CADDY_HSHQ_CA_SUBNET=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
CADDY_HSHQ_PRIVATE_IPS=
CADDY_HSHQ_CA_URL=$ca_url
CADDY_HSHQ_BIND_IP=$bind_ip
EOFCE
      ;;
    *)
      # This should never happen
      echo "Undefined error(2) in outputConfigCaddy, exiting..."
      exit 1
      ;;
  esac

}

function performUpdateCaddy()
{
  perform_stack_name=$2
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v4
      curImageList=caddy:2.7.4
      image_update_map[0]="caddy:2.7.4,caddy:2.9.1"
    ;;
    2)
      newVer=v4
      curImageList=caddy:2.7.6
      image_update_map[0]="caddy:2.7.6,caddy:2.9.1"
    ;;
    3)
      newVer=v4
      curImageList=caddy:2.8.4
      image_update_map[0]="caddy:2.8.4,caddy:2.9.1"
    ;;
    4)
      newVer=v4
      curImageList=caddy:2.9.1
      image_update_map[0]="caddy:2.9.1,caddy:2.9.1"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function updateCaddyBlocks()
{
  subdom=$1
  manage_tls=$2
  is_integrate_hshq=$3
  svc_nettype=$4
  inner_block="$5"
  if [ "$is_integrate_hshq" = "false" ]; then
    return
  fi
  case "$manage_tls" in
    hshq)
      tls_block="import $CADDY_SNIPPET_TLS_HSHQ" ;;
    le)
      tls_block="tls /lecerts/$subdom.${HOMESERVER_DOMAIN}.crt /lecerts/$subdom.${HOMESERVER_DOMAIN}.key"
      primary_block="$(echo $inner_block | sed 's|REPLACE-TLS-BLOCK||g' | sed 's|>| |g')"
      if ! [ -f $HSHQ_STACKS_DIR/caddy-common/lecerts/$subdom.${HOMESERVER_DOMAIN}.crt ]; then
        generateCert $subdom.${HOMESERVER_DOMAIN} $subdom.${HOMESERVER_DOMAIN} "" "2023-01-01 00:00:00 GMT"
        sudo mv -f $HSHQ_SSL_DIR/$subdom.${HOMESERVER_DOMAIN}.crt $HSHQ_STACKS_DIR/caddy-common/lecerts/
        sudo mv -f $HSHQ_SSL_DIR/$subdom.${HOMESERVER_DOMAIN}.key $HSHQ_STACKS_DIR/caddy-common/lecerts/
        sudo chmod 600 $HSHQ_STACKS_DIR/caddy-common/lecerts/$subdom.${HOMESERVER_DOMAIN}.*
        sudo chown root:root $HSHQ_STACKS_DIR/caddy-common/lecerts/$subdom.${HOMESERVER_DOMAIN}.*
      fi
      addLECertPathsToRelayServer $subdom.${HOMESERVER_DOMAIN} ${HOMESERVER_DOMAIN}
      ;;
    *)
      tls_block="import $CADDY_SNIPPET_TLS_HSHQ" ;;
  esac
  snippet_block_begin="# sn-sub-${subdom} BEGIN"
  snippet_block_end="# sn-sub-${subdom} END"
  inner_block_repl=$(echo $inner_block | sed "s|REPLACE-TLS-BLOCK|$tls_block|g")
  snippet_block="(sn-sub-${subdom}) {\n${inner_block_repl}\n}"
  addReplaceCaddySnippet "$snippet_block_begin" "$snippet_block_end" "$snippet_block"
  addCaddySnippetImport home sn-sub-${subdom} $svc_nettype
  addCaddySnippetImport other sn-sub-${subdom} $svc_nettype
  case "$manage_tls" in
    hshq)
      replaceTextBlockInFile "$snippet_block_begin" "$snippet_block_end" "" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary false
      addCaddySnippetImport primary sn-sub-${subdom} $svc_nettype
      ;;
    le)
      removeCaddySnippetImport primary sn-sub-${subdom}
      replaceOrAppendTextBlockInFile "$snippet_block_begin" "$snippet_block_end" "$primary_block" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary
      ;;
    *)
      addCaddySnippetImport primary sn-sub-${subdom} $svc_nettype
      ;;
  esac
}

function addReplaceCaddySnippet()
{
  begin_block=$1
  end_block=$2
  block_text="$3"
  snip_file=$HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
  replaceOrAppendTextBlockInFile "$begin_block" "$end_block" "$block_text" $snip_file ">"
}

function removeCaddySnippet()
{
  begin_block="$1"
  end_block="$2"
  snip_file=$HSHQ_STACKS_DIR/caddy-common/snippets/svcs.snip
  removeTextBlockInFile "$begin_block" "$end_block" $snip_file
}

function addCaddySnippetImport()
{
  net_type=$1
  svc_name=$2
  svc_nettype=$3
  case "$net_type" in
    home)
      checkAddLineToFile "import $svc_name" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home
    ;;
    primary)
      if [ "$svc_nettype" = "primary" ] || [ "$svc_nettype" = "other" ]; then
        checkAddLineToFile "import $svc_name" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary
      fi
    ;;
    other)
      if [ "$svc_nettype" = "other" ]; then
        checkAddLineToFile "import $svc_name" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Other
      fi
    ;;
  esac
}

function checkAddLineToFile()
{
  caltf_curE=${-//[^e]/}
  add_line=$1
  sn_file=$2
  set +e
  grep "$add_line" $sn_file > /dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo -e "$add_line" >> $sn_file
  fi
  if ! [ -z "$caltf_curE" ]; then
    set -e
  fi
}

function removeCaddySnippetImport()
{
  net_type=$1
  svc_name=$2
  case "$net_type" in
    home)
      sed -i "/import $svc_name/d" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Home ;;
    primary)
      sed -i "/import $svc_name/d" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Primary ;;
    other)
      sed -i "/import $svc_name/d" $HSHQ_STACKS_DIR/caddy-common/caddyfiles/CaddyfileBody-Other ;;
  esac
}

function restartAllCaddyContainers()
{
  caddy_arr=($(docker ps -a --filter name=caddy- --format "{{.Names}}"))
  for curcaddy in "${caddy_arr[@]}"
  do
    docker container restart $curcaddy
  done
  docker container restart ofelia
}

function installHostInterfaceCaddy()
{
  interface_name="$1"
  interface_ip="$2"
  installCaddy home-$interface_name home $(getHSHostIPVarName $interface_name) "$interface_ip" home na na na $(getHSHostSubnetVarName $interface_name) "$(getNonPrivateConnectingIP)"
}

# ClientDNS
function installClientDNS()
{
  set +e
  cdns_stack_name=$1
  cdns_ip_address=$2
  CUR_CLIENTDNS_ADMIN_USERNAME=$3
  CUR_CLIENTDNS_ADMIN_PASSWORD=$4
  checkDeleteStackAndDirectory clientdns-${cdns_stack_name} "ClientDNS-${cdns_stack_name}"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    return 1
  fi
  pullImage $IMG_WIREGUARD
  if [ $? -ne 0 ]; then
    return 1
  fi
  pullImage $IMG_DNSMASQ
  if [ $? -ne 0 ]; then
    return 1
  fi
  set -e

  mkdir -p $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}
  cdns_stack_name_upper=$(echo $cdns_stack_name | tr '[:lower:]' '[:upper:]')
  checkAddServiceToConfig "clientdns-${cdns_stack_name}" "CLIENTDNS_${cdns_stack_name_upper}_ADMIN_USERNAME=$CUR_CLIENTDNS_ADMIN_USERNAME,CLIENTDNS_${cdns_stack_name_upper}_ADMIN_PASSWORD=$CUR_CLIENTDNS_ADMIN_PASSWORD"
  docker network create --driver=bridge tmpnet >/dev/null
  clientdns_subnet=$(getDockerSubnet tmpnet)
  clientdns_subnet_prefix=$(echo $clientdns_subnet | rev | cut -d "." -f2- | rev)
  docker network rm tmpnet >/dev/null
  docker network create -o com.docker.network.bridge.name=brcd-${cdns_stack_name} --driver=bridge --subnet $clientdns_subnet cdns-${cdns_stack_name} > /dev/null
  outputConfigClientDNS $cdns_stack_name
  sudo mv $HSHQ_WIREGUARD_DIR/users/clientdns-${cdns_stack_name}.conf $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}/clientdns-${cdns_stack_name}.conf
  installStack clientdns-${cdns_stack_name} clientdns-${cdns_stack_name}-wireguard "\[ls.io-init\] done" $HOME/clientdns-${cdns_stack_name}.env
  retval=$?
  if [ $retval -ne 0 ]; then
    return $retval
  fi
  echo "ClientDNS-${cdns_stack_name} installed, sleeping 5 seconds..."
  sleep 5

  inner_block=""
  inner_block=$inner_block">>https://${SUB_CLIENTDNS}-${cdns_stack_name}.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://clientdns-${cdns_stack_name}-dnsmasq:8080 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks ${SUB_CLIENTDNS}-${cdns_stack_name} $MANAGETLS_CLIENTDNS "true" $NETDEFAULT_CLIENTDNS "$inner_block"
  insertEnableSvcHeimdall clientdns "${FMLNAME_CLIENTDNS}-${cdns_stack_name}" $USERTYPE_CLIENTDNS "https://${SUB_CLIENTDNS}-${cdns_stack_name}.$HOMESERVER_DOMAIN" "dnsmasq.png" true "$(getHeimdallOrderFromSub $SUB_CLIENTDNS $USERTYPE_CLIENTDNS)"
  restartAllCaddyContainers
}

function outputConfigClientDNS()
{
  cat <<EOFGL > $HOME/clientdns-${cdns_stack_name}-compose.yml
$STACK_VERSION_PREFIX clientdns-${cdns_stack_name} $(getScriptStackVersion clientdns-${cdns_stack_name})

services:
  clientdns-${cdns_stack_name}-dnsmasq:
    image: $IMG_DNSMASQ
    container_name: clientdns-${cdns_stack_name}-dnsmasq
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      dock-ext-net:
      dock-proxy-net:
      cdns-${cdns_stack_name}-net:
        ipv4_address: \${CLIENTDNS_SUBNET_PREFIX}.253
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/dnsmasq.conf:/etc/dnsmasq.conf
    environment:
      - HTTP_USER=$CUR_CLIENTDNS_ADMIN_USERNAME
      - HTTP_PASS=$CUR_CLIENTDNS_ADMIN_PASSWORD

  clientdns-${cdns_stack_name}-wireguard:
    image: $IMG_WIREGUARD
    container_name: clientdns-${cdns_stack_name}-wireguard
    hostname: clientdns-${cdns_stack_name}-wireguard
    restart: unless-stopped
    env_file: stack.env
    cap_add:
      - NET_ADMIN
    networks:
      - dock-ext-net
      - cdns-${cdns_stack_name}-net
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/Corefile:/config/coredns/Corefile:ro
      - \${HSHQ_STACKS_DIR}/clientdns-${cdns_stack_name}/clientdns-${cdns_stack_name}.conf:/config/wg0.conf

networks:
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-ext-net:
    name: dock-ext
    external: true
  cdns-${cdns_stack_name}-net:
    name: cdns-${cdns_stack_name}
    external: true

EOFGL

  cat <<EOFGL > $HOME/clientdns-${cdns_stack_name}.env
TZ=\${TZ}
PUID=$USERID
PGID=$GROUPID
CLIENTDNS_SUBNET_PREFIX=$clientdns_subnet_prefix
USE_COREDNS=true
EOFGL

  cat <<EOFCD > $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}/dnsmasq.conf
# IP Address of this DNS Server: $cdns_ip_address
#======================
no-resolv
no-hosts
domain-needed
bogus-priv
server=127.0.0.11
cache-size=0
#======================
# Add new entries here


EOFCD

  cat <<EOFCF > $HSHQ_STACKS_DIR/clientdns-${cdns_stack_name}/Corefile
. {
    loop
    reload 15s
    forward . ${clientdns_subnet_prefix}.253
}
EOFCF

}

function performUpdateClientDNS()
{
  perform_stack_name=$2
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v2
      curImageList=jpillora/dnsmasq:1.1,linuxserver/wireguard:1.0.20210914
      image_update_map[0]="jpillora/dnsmasq:1.1,jpillora/dnsmasq:1.1"
      image_update_map[1]="linuxserver/wireguard:1.0.20210914,linuxserver/wireguard:1.0.20210914-r4-ls72"
    ;;
    2)
      newVer=v2
      curImageList=jpillora/dnsmasq:1.1,linuxserver/wireguard:1.0.20210914-r4-ls72
      image_update_map[0]="jpillora/dnsmasq:1.1,jpillora/dnsmasq:1.1"
      image_update_map[1]="linuxserver/wireguard:1.0.20210914-r4-ls72,linuxserver/wireguard:1.0.20210914-r4-ls72"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

# UptimeKuma
function installUptimeKuma()
{
  set +e
  is_integrate_hshq=$1
  checkDeleteStackAndDirectory uptimekuma "Uptimekuma"
  cdRes=$?
  if [ $cdRes -ne 0 ]; then
    echo "ERROR: Uptimekuma directory exists"
    exit 1
  fi
  pullImage $(getScriptImageByContainerName uptimekuma)
  if [ $? -ne 0 ]; then
    echo "ERROR: Could not obtain Uptimekuma docker image"
    exit 1
  fi
  set -e

  mkdir $HSHQ_STACKS_DIR/uptimekuma
  mkdir $HSHQ_STACKS_DIR/uptimekuma/app

  initServicesCredentials
  UPTIMEKUMA_PASSWORD_HASH=$(htpasswd -bnBC 10 "" $UPTIMEKUMA_PASSWORD | tr -d ':\n' | sed 's/$2y/$2a/')
  outputConfigUptimeKuma
  installStack uptimekuma uptimekuma "Listening on 3001" $HOME/uptimekuma.env 3
  retval=$?
  if [ $retval -ne 0 ]; then
    echo "ERROR: There was a problem installing Uptimekuma"
    exit $retval
  fi
  startStopStack uptimekuma stop
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO user(id,username,password,active,timezone,twofa_secret,twofa_status,twofa_last_token) VALUES(1,'$UPTIMEKUMA_USERNAME','$UPTIMEKUMA_PASSWORD_HASH',1,'$TZ',NULL,0,NULL);"
  curdt=$(getCurrentDate)
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO tag(id,name,color,created_date) VALUES(1,'Admin','$ADMIN_COLOR_CODE','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO tag(id,name,color,created_date) VALUES(2,'User','$USERS_COLOR_CODE','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO tag(id,name,color,created_date) VALUES(3,'RelayServer','$RELAYSERVER_COLOR_CODE','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO tag(id,name,color,created_date) VALUES(4,'HomeServers','$HOMESERVERS_COLOR_CODE','$curdt');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO notification(id,name,active,user_id,is_default,config) VALUES(1,'Service Alerts',1,1,1,'{\"name\":\"Service Alerts\",\"type\":\"smtp\",\"isDefault\":true,\"smtpSecure\":false,\"smtpHost\":\"$SMTP_HOSTNAME\",\"smtpPort\":$SMTP_HOSTPORT,\"smtpFrom\":\"\\\"Uptime Kuma $(getAdminEmailName)\\\" <$EMAIL_ADMIN_EMAIL_ADDRESS>\",\"smtpTo\":\"$EMAIL_ADMIN_EMAIL_ADDRESS\",\"applyExisting\":true}');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "REPLACE INTO setting(key,value,type) VALUES('keepDataPeriodDays',30,'general');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "REPLACE INTO setting(key,value,type) VALUES('primaryBaseURL','https://$SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN','general');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "REPLACE INTO setting(key,value,type) VALUES('serverTimezone','\"$TZ\"','general');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "REPLACE INTO setting(key,value) VALUES('initServerTimezone','true');"
  insertServicesUptimeKuma
  startStopStack uptimekuma start

  inner_block=""
  inner_block=$inner_block">>https://$SUB_UPTIMEKUMA.$HOMESERVER_DOMAIN {\n"
  inner_block=$inner_block">>>>REPLACE-TLS-BLOCK\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_RIP\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_FWDAUTH\n"
  inner_block=$inner_block">>>>import $CADDY_SNIPPET_SAFEHEADER\n"
  inner_block=$inner_block">>>>handle @subnet {\n"
  inner_block=$inner_block">>>>>>reverse_proxy http://uptimekuma:3001 {\n"
  inner_block=$inner_block">>>>>>>>import $CADDY_SNIPPET_TRUSTEDPROXIES\n"
  inner_block=$inner_block">>>>>>}\n"
  inner_block=$inner_block">>>>}\n"
  inner_block=$inner_block">>>>respond 404\n"
  inner_block=$inner_block">>}"
  updateCaddyBlocks $SUB_UPTIMEKUMA $MANAGETLS_UPTIMEKUMA "$is_integrate_hshq" $NETDEFAULT_UPTIMEKUMA "$inner_block"
}

function outputConfigUptimeKuma()
{
  cat <<EOFUK > $HOME/uptimekuma-compose.yml
$STACK_VERSION_PREFIX uptimekuma $(getScriptStackVersion uptimekuma)

services:
  uptimekuma:
    image: $(getScriptImageByContainerName uptimekuma)
    container_name: uptimekuma
    hostname: uptimekuma
    restart: unless-stopped
    env_file: stack.env
    security_opt:
      - no-new-privileges:true
    networks:
      - dock-ext-net
      - dock-proxy-net
      - dock-internalmail-net
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /usr/share/ca-certificates:/usr/share/ca-certificates:ro
      - /usr/local/share/ca-certificates:/usr/local/share/ca-certificates:ro
      - \${HSHQ_STACKS_DIR}/uptimekuma/app:/app/data

networks:
  dock-ext-net:
    name: dock-ext
    external: true
  dock-proxy-net:
    name: dock-proxy
    external: true
  dock-internalmail-net:
    name: dock-internalmail
    external: true
EOFUK

  cat <<EOFUK > $HOME/uptimekuma.env
NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
PUID=$USERID
PGID=$GROUPID
EOFUK
}

function performUpdateUptimeKuma()
{
  perform_stack_name=uptimekuma
  prepPerformUpdate "$1"
  if [ $? -ne 0 ]; then return 1; fi
  # The current version is included as a placeholder for when the next version arrives.
  case "$perform_stack_ver" in
    1)
      newVer=v5
      curImageList=louislam/uptime-kuma:1.23.0-alpine
      image_update_map[0]="louislam/uptime-kuma:1.23.0-alpine,louislam/uptime-kuma:1.23.16-alpine"
    ;;
    2)
      newVer=v5
      curImageList=louislam/uptime-kuma:1.23.11-alpine
      image_update_map[0]="louislam/uptime-kuma:1.23.11-alpine,louislam/uptime-kuma:1.23.16-alpine"
    ;;
    3)
      newVer=v5
      curImageList=louislam/uptime-kuma:1.23.13-alpine
      image_update_map[0]="louislam/uptime-kuma:1.23.13-alpine,louislam/uptime-kuma:1.23.16-alpine"
    ;;
    4)
      newVer=v5
      curImageList=louislam/uptime-kuma:1.23.15-alpine
      image_update_map[0]="louislam/uptime-kuma:1.23.15-alpine,louislam/uptime-kuma:1.23.16-alpine"
    ;;
    5)
      newVer=v5
      curImageList=louislam/uptime-kuma:1.23.16-alpine
      image_update_map[0]="louislam/uptime-kuma:1.23.16-alpine,louislam/uptime-kuma:1.23.16-alpine"
    ;;
    *)
      is_upgrade_error=true
      perform_update_report="ERROR ($perform_stack_name): Unknown version (v$perform_stack_ver)"
      return
    ;;
  esac
  upgradeStack "$perform_stack_name" "$perform_stack_id" "$oldVer" "$newVer" "$curImageList" "$perform_compose" "$portainerToken" doNothing false
  perform_update_report="${perform_update_report}$stack_upgrade_report"
}

function insertServiceUptimeKuma()
{
  svc_proper_name=$1
  user_type=$2
  svc_url=$3
  svc_is_active=$4
  curdt=$(getCurrentDate)
  user_id=0
  if [ "$user_type" = "admin" ]; then
    user_id=1
  elif [ "$user_type" = "user" ]; then
    user_id=2
  elif [ "$user_type" = "relayserver" ]; then
    user_id=3
  elif [ "$user_type" = "homeservers" ]; then
    user_id=4
  else
    user_id=0
  fi
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO monitor(id,name,active,user_id,interval,url,type,weight,hostname,port,created_date,keyword,maxretries,ignore_tls,upside_down,maxredirects,accepted_statuscodes_json,dns_resolve_type,dns_resolve_server,dns_last_result,retry_interval,push_token,method,body,headers,basic_auth_user,basic_auth_pass,docker_host,docker_container,proxy_id,expiry_notification,mqtt_topic,mqtt_success_message,mqtt_username,mqtt_password,database_connection_string,database_query,auth_method,auth_domain,auth_workstation,grpc_url,grpc_protobuf,grpc_body,grpc_metadata,grpc_method,grpc_service_name,grpc_enable_tls,radius_username,radius_password,radius_called_station_id,radius_called_station_id,radius_secret,resend_interval,packet_size,game) VALUES(NULL,'$svc_proper_name',$svc_is_active,1,$UPTIMEKUMA_HEARTBEAT_INTERVAL,'$svc_url','http',2000,NULL,NULL,'$curdt',NULL,$UPTIMEKUMA_HEARTBEAT_RETRIES,0,0,10,'[\"200-299\"]','A','9.9.9.9',NULL,$UPTIMEKUMA_RETRY_INTERVAL,NULL,'GET',NULL,NULL,NULL,NULL,NULL,'',NULL,0,'','','','',NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,0,NULL,NULL,NULL,NULL,NULL,$UPTIMEKUMA_RESEND_NOTIFY,56,NULL);"
  svc_id=$(sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "Select id from monitor where url='$svc_url';")
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO monitor_tag(id,monitor_id,tag_id,value) VALUES(NULL,$svc_id,$user_id,'');"
  sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "INSERT INTO monitor_notification(id,monitor_id,notification_id) VALUES(NULL,$svc_id,1);"
}

function checkInsertServiceUptimeKuma()
{
  svc_stack_name=$1
  svc_proper_name=$2
  user_type=$3
  svc_url=$4
  is_restart=$5
  svc_is_active=$6

  set +e
  docker container stop uptimekuma > /dev/null 2>&1
  set -e
  svc_id=$(sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "Select id from monitor where url='$svc_url';")
  if [ -z "$svc_id" ]; then
    insertServiceUptimeKuma "$svc_proper_name" "$user_type" "$svc_url" "$svc_is_active"
  else
    sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "update monitor set active=$svc_is_active where url='$svc_url';"
  fi
  set +e
  if [ "$is_restart" = "true" ]; then
    docker container start uptimekuma > /dev/null 2>&1
  fi
  set -e
}

function insertEnableSvcUptimeKuma()
{
  checkInsertServiceUptimeKuma "$1" "$2" "$3" "$4" "$5" 1
}

function deleteSvcUptimeKuma()
{
  svc_url=$1
  is_manage_container=$2
  if [ "$IS_INSTALLED" = "true" ] && [ -f $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db ]; then
    if [ "$is_manage_container" = "true" ]; then
      docker container stop uptimekuma >/dev/null
    fi
    sqlite3 $HSHQ_STACKS_DIR/uptimekuma/app/kuma.db "PRAGMA foreign_keys=ON;delete from monitor where url like '${svc_url}%';"
    if [ "$is_manage_container" = "true" ]; then
      docker container start uptimekuma >/dev/null
    fi
  fi
}

# Purposely verbose, to list all of the current methods used to call this script.
# The -a option is deprecated, but will remain to provide backwards-compatibility
# with the prior version of the wrapper script, hshq.sh.
case "$1" in
  "lib")     init;;
  "run")     main "$@";;
  "install") main "$@";;
  "-a")      main "$@";;
  "")        main "$@";;
  *)         main "$@";;
esac
